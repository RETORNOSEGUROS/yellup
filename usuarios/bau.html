<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ba√∫ Di√°rio - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0e13;
      --bg-card: #131920;
      --bg-elevated: #1a2230;
      --accent-primary: #ff9f43;
      --accent-secondary: #ffc048;
      --accent-glow: rgba(255, 159, 67, 0.25);
      --live-red: #ff4757;
      --win-green: #2ed573;
      --text-primary: #f1f2f6;
      --text-secondary: #a4b0be;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse at top, rgba(255, 159, 67, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(26, 34, 48, 0.5) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* HEADER */
    .header {
      background: rgba(10, 14, 19, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 159, 67, 0.1);
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img { height: 36px; filter: drop-shadow(0 2px 8px rgba(255, 181, 71, 0.3)); }
    .btn-back {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e7eef7;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85em;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }

    /* CONTAINER */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* PAGE TITLE */
    .page-title {
      text-align: center;
      margin-bottom: 30px;
    }
    .page-title h1 {
      font-size: 1.6em;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .page-title p {
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    /* STREAK BAR */
    .streak-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(255, 159, 67, 0.1), rgba(255, 192, 72, 0.05));
      border: 1px solid rgba(255, 159, 67, 0.2);
      border-radius: 16px;
    }
    .streak-info { display: flex; align-items: center; gap: 12px; }
    .streak-fire { font-size: 2em; animation: fireGlow 1.5s ease-in-out infinite alternate; }
    @keyframes fireGlow {
      from { filter: brightness(1) drop-shadow(0 0 5px rgba(255, 159, 67, 0.3)); }
      to { filter: brightness(1.2) drop-shadow(0 0 15px rgba(255, 159, 67, 0.6)); }
    }
    .streak-count { font-size: 1.4em; font-weight: 800; color: var(--accent-secondary); }
    .streak-label { font-size: 0.75em; color: var(--text-secondary); }
    .streak-bonus {
      padding: 6px 14px;
      background: rgba(46, 213, 115, 0.15);
      border: 1px solid rgba(46, 213, 115, 0.3);
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      color: var(--win-green);
    }

    /* WEEK DOTS */
    .week-progress {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }
    .day-dot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .day-circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: var(--bg-card);
      transition: all 0.3s ease;
    }
    .day-circle.claimed {
      border-color: var(--win-green);
      background: rgba(46, 213, 115, 0.15);
    }
    .day-circle.today {
      border-color: var(--accent-primary);
      background: rgba(255, 159, 67, 0.15);
      animation: todayPulse 2s ease-in-out infinite;
      box-shadow: 0 0 15px var(--accent-glow);
    }
    .day-circle.locked {
      opacity: 0.4;
    }
    @keyframes todayPulse {
      0%, 100% { box-shadow: 0 0 10px var(--accent-glow); }
      50% { box-shadow: 0 0 25px var(--accent-glow); }
    }
    .day-label { font-size: 0.6em; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }

    /* CHEST */
    .chest-area {
      text-align: center;
      margin-bottom: 30px;
    }
    .chest-icon {
      font-size: 6em;
      display: inline-block;
      cursor: pointer;
      transition: all 0.3s ease;
      animation: chestFloat 3s ease-in-out infinite;
    }
    .chest-icon:hover { transform: scale(1.1); }
    .chest-icon.disabled { animation: none; opacity: 0.5; cursor: default; filter: grayscale(0.7); }
    @keyframes chestFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .chest-icon.opening {
      animation: chestOpen 0.8s ease-in-out;
    }
    @keyframes chestOpen {
      0% { transform: scale(1) rotate(0); }
      25% { transform: scale(1.15) rotate(-5deg); }
      50% { transform: scale(1.3) rotate(5deg); }
      75% { transform: scale(1.15) rotate(-3deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .chest-label {
      font-size: 1em;
      font-weight: 600;
      margin-top: 12px;
      color: var(--text-secondary);
    }
    .chest-label.available { color: var(--accent-secondary); }

    .btn-open-chest {
      margin-top: 16px;
      padding: 14px 40px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, #ff8c42 100%);
      border: none;
      border-radius: 14px;
      color: var(--bg-dark);
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-open-chest:hover { transform: translateY(-2px); box-shadow: 0 6px 30px var(--accent-glow); }
    .btn-open-chest:active { transform: scale(0.97); }
    .btn-open-chest:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      cursor: default;
      box-shadow: none;
    }
    .btn-open-chest:disabled:hover { transform: none; }

    /* REWARD REVEAL */
    .reward-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
    }
    .reward-overlay.active { display: flex; }
    .reward-card {
      background: linear-gradient(135deg, #1e2936 0%, #18222e 100%);
      border-radius: 24px;
      padding: 40px 30px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      border: 1px solid rgba(255, 181, 71, 0.3);
      animation: rewardPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 181, 71, 0.1);
    }
    @keyframes rewardPop {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }
    .reward-emoji { font-size: 4em; margin-bottom: 16px; animation: rewardBounce 1s ease-in-out; }
    @keyframes rewardBounce {
      0%, 100% { transform: translateY(0); }
      30% { transform: translateY(-20px); }
      60% { transform: translateY(-8px); }
    }
    .reward-title { font-size: 1.4em; font-weight: 800; margin-bottom: 8px; color: var(--accent-secondary); }
    .reward-desc { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 8px; }
    .reward-value {
      font-size: 2em;
      font-weight: 800;
      color: var(--win-green);
      margin: 16px 0;
    }
    .reward-streak-bonus {
      padding: 8px 16px;
      background: rgba(255, 159, 67, 0.15);
      border: 1px solid rgba(255, 159, 67, 0.3);
      border-radius: 12px;
      font-size: 0.8em;
      color: var(--accent-secondary);
      margin-bottom: 20px;
      display: inline-block;
    }
    .btn-collect {
      padding: 14px 40px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, #ff8c42 100%);
      border: none;
      border-radius: 14px;
      color: var(--bg-dark);
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-collect:hover { transform: translateY(-2px); }

    /* REWARDS TABLE */
    .rewards-table {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-elevated));
      border: 1px solid rgba(255, 159, 67, 0.15);
      border-radius: 20px;
      padding: 20px;
    }
    .rewards-title {
      font-size: 1em;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .reward-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .reward-row:last-child { border-bottom: none; }
    .reward-row-left { display: flex; align-items: center; gap: 10px; }
    .reward-row-day { font-weight: 600; font-size: 0.85em; }
    .reward-row-prize { display: flex; align-items: center; gap: 6px; font-size: 0.85em; color: var(--accent-secondary); font-weight: 600; }
    .reward-row.day7 .reward-row-prize { color: var(--win-green); font-size: 1em; }
    .reward-row.day7 { 
      background: rgba(46, 213, 115, 0.08); 
      border-radius: 10px; 
      padding: 12px;
      margin: 4px -8px;
    }

    /* CONFETTI PARTICLES */
    .confetti-container {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 2001;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -10px;
      animation: confettiFall 3s ease-in forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* BOTTOM NAV */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(14, 20, 27, 0.98);
      backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 99;
    }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      color: #a9b5c6; text-decoration: none; font-size: 0.75em;
      transition: all 0.3s ease; padding: 5px 10px;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9);
      color: white; padding: 15px 30px;
      border-radius: 50px; font-weight: 600;
      z-index: 2000; opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* RESPONSIVE */
    @media (max-width: 400px) {
      .day-circle { width: 36px; height: 36px; font-size: 0.85em; }
      .week-progress { gap: 6px; }
      .chest-icon { font-size: 4.5em; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'">
      </div>
      <a href="painel.html" class="btn-back">‚Üê Voltar</a>
    </div>
  </div>

  <!-- CONTAINER -->
  <div class="container">

    <!-- T√çTULO -->
    <div class="page-title">
      <h1>üéÅ Ba√∫ Di√°rio</h1>
      <p>Abra todo dia e ganhe recompensas!</p>
    </div>

    <!-- STREAK -->
    <div class="streak-bar">
      <div class="streak-info">
        <span class="streak-fire">üî•</span>
        <div>
          <div class="streak-count" id="streakCount">0 dias</div>
          <div class="streak-label">Sequ√™ncia atual</div>
        </div>
      </div>
      <div class="streak-bonus" id="streakBonus">+0% b√¥nus</div>
    </div>

    <!-- PROGRESSO DA SEMANA -->
    <div class="week-progress" id="weekDots"></div>

    <!-- BA√ö -->
    <div class="chest-area">
      <div class="chest-icon" id="chestIcon">üéÅ</div>
      <div class="chest-label" id="chestLabel">Carregando...</div>
      <button class="btn-open-chest" id="btnOpenChest" disabled>Abrir Ba√∫</button>
    </div>

    <!-- TABELA DE RECOMPENSAS -->
    <div class="rewards-table">
      <div class="rewards-title">üìã Recompensas da Semana</div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 1</span></div><div class="reward-row-prize">+2 cr√©ditos</div></div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 2</span></div><div class="reward-row-prize">+3 cr√©ditos</div></div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 3</span></div><div class="reward-row-prize">+5 cr√©ditos +10 XP</div></div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 4</span></div><div class="reward-row-prize">+5 cr√©ditos</div></div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 5</span></div><div class="reward-row-prize">+8 cr√©ditos +15 XP</div></div>
      <div class="reward-row"><div class="reward-row-left">üì¶ <span class="reward-row-day">Dia 6</span></div><div class="reward-row-prize">+10 cr√©ditos</div></div>
      <div class="reward-row day7"><div class="reward-row-left">üéÅ <span class="reward-row-day">Dia 7 ‚òÖ</span></div><div class="reward-row-prize">üéâ +20 cr√©ditos +50 XP</div></div>
    </div>
  </div>

  <!-- REWARD OVERLAY -->
  <div class="reward-overlay" id="rewardOverlay">
    <div class="reward-card">
      <div class="reward-emoji" id="rewardEmoji">üéâ</div>
      <div class="reward-title" id="rewardTitle">Recompensa!</div>
      <div class="reward-desc" id="rewardDesc"></div>
      <div class="reward-value" id="rewardValue">+5 cr√©ditos</div>
      <div class="reward-streak-bonus" id="rewardStreakBonus" style="display:none"></div>
      <button class="btn-collect" onclick="closeReward()">Coletar! ‚ú®</button>
    </div>
  </div>

  <!-- CONFETTI -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
      <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
    </div>
  </nav>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // RECOMPENSAS POR DIA (1-7)
    const REWARDS = [
      { creditos: 2, xp: 0, emoji: 'üí∞', desc: 'Cr√©ditos' },
      { creditos: 3, xp: 0, emoji: 'üí∞', desc: 'Cr√©ditos' },
      { creditos: 5, xp: 10, emoji: '‚≠ê', desc: 'Cr√©ditos + XP' },
      { creditos: 5, xp: 0, emoji: 'üí∞', desc: 'Cr√©ditos' },
      { creditos: 8, xp: 15, emoji: 'üåü', desc: 'Cr√©ditos + XP' },
      { creditos: 10, xp: 0, emoji: 'üíé', desc: 'Cr√©ditos' },
      { creditos: 20, xp: 50, emoji: 'üéâ', desc: 'SUPER RECOMPENSA' }
    ];

    const DAYS_LABEL = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];

    let currentUser = null;
    let bauData = null;

    // AUTH
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log('Persist√™ncia OK'))
      .catch(e => console.error('Persist√™ncia erro:', e));

    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      await loadBau();
    });

    // Helpers
    function getToday() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function getDayOfWeek() {
      const d = new Date().getDay();
      return d === 0 ? 6 : d - 1; // 0=Seg, 6=Dom
    }

    // LOAD BA√ö
    async function loadBau() {
      try {
        const ref = db.collection('usuarios').doc(currentUser.uid).collection('bau_diario').doc('estado');
        const doc = await ref.get();

        const hoje = getToday();

        if (doc.exists) {
          bauData = doc.data();

          // Verificar se quebrou a sequ√™ncia (n√£o abriu ontem)
          const ontem = new Date();
          ontem.setDate(ontem.getDate() - 1);
          const ontemStr = `${ontem.getFullYear()}-${String(ontem.getMonth()+1).padStart(2,'0')}-${String(ontem.getDate()).padStart(2,'0')}`;

          if (bauData.ultimaAbertura !== hoje && bauData.ultimaAbertura !== ontemStr) {
            // Quebrou sequ√™ncia - resetar
            bauData.streak = 0;
            bauData.diasSemana = [];
          }
        } else {
          bauData = { streak: 0, ultimaAbertura: null, diasSemana: [], totalAberturas: 0 };
        }

        const jaAbriuHoje = bauData.ultimaAbertura === hoje;
        renderUI(jaAbriuHoje);
      } catch (e) {
        console.error('Erro ao carregar ba√∫:', e);
        showToast('‚ùå Erro ao carregar ba√∫');
      }
    }

    // RENDER UI
    function renderUI(jaAbriuHoje) {
      const streak = bauData.streak || 0;
      const bonusPercent = Math.min(streak * 5, 50); // Max 50% b√¥nus

      // Streak
      document.getElementById('streakCount').textContent = `${streak} dia${streak !== 1 ? 's' : ''}`;
      document.getElementById('streakBonus').textContent = `+${bonusPercent}% b√¥nus`;

      // Week dots
      const dotsContainer = document.getElementById('weekDots');
      const diaAtual = getDayOfWeek();
      const diasAbertos = bauData.diasSemana || [];

      dotsContainer.innerHTML = DAYS_LABEL.map((label, i) => {
        const abriu = diasAbertos.includes(i);
        const isToday = i === diaAtual;
        const isFuture = i > diaAtual;
        let cls = '';
        if (abriu) cls = 'claimed';
        else if (isToday && !jaAbriuHoje) cls = 'today';
        else if (isToday && jaAbriuHoje) cls = 'claimed';
        else if (isFuture) cls = 'locked';

        const icon = abriu || (isToday && jaAbriuHoje) ? '‚úÖ' : isToday ? 'üéÅ' : isFuture ? 'üîí' : '‚ùå';

        return `<div class="day-dot">
          <div class="day-circle ${cls}">${icon}</div>
          <span class="day-label">${label}</span>
        </div>`;
      }).join('');

      // Chest
      const chestIcon = document.getElementById('chestIcon');
      const chestLabel = document.getElementById('chestLabel');
      const btnOpen = document.getElementById('btnOpenChest');

      if (jaAbriuHoje) {
        chestIcon.textContent = '‚úÖ';
        chestIcon.classList.add('disabled');
        chestLabel.textContent = 'J√° abriu hoje! Volte amanh√£';
        chestLabel.classList.remove('available');
        btnOpen.disabled = true;
        btnOpen.textContent = 'Volte amanh√£ ‚è∞';
      } else {
        chestIcon.textContent = 'üéÅ';
        chestIcon.classList.remove('disabled');
        chestLabel.textContent = 'Toque para abrir!';
        chestLabel.classList.add('available');
        btnOpen.disabled = false;
        btnOpen.textContent = 'Abrir Ba√∫ üéÅ';
      }
    }

    // OPEN CHEST
    document.getElementById('btnOpenChest').addEventListener('click', openChest);
    document.getElementById('chestIcon').addEventListener('click', () => {
      if (!document.getElementById('btnOpenChest').disabled) openChest();
    });

    async function openChest() {
      const btn = document.getElementById('btnOpenChest');
      if (btn.disabled) return;
      btn.disabled = true;

      const chestIcon = document.getElementById('chestIcon');
      chestIcon.classList.add('opening');

      // Calcular recompensa
      const streak = (bauData.streak || 0);
      const dayInCycle = streak % 7; // 0-6
      const reward = REWARDS[dayInCycle];
      const bonusPercent = Math.min(streak * 5, 50) / 100;
      const creditosBase = reward.creditos;
      const creditosBonus = Math.floor(creditosBase * bonusPercent);
      const creditosTotal = creditosBase + creditosBonus;
      const xpTotal = reward.xp;

      try {
        const hoje = getToday();
        const diaAtual = getDayOfWeek();
        const novosDias = [...(bauData.diasSemana || [])];
        if (!novosDias.includes(diaAtual)) novosDias.push(diaAtual);

        // Salvar no Firestore
        const batch = db.batch();

        // Atualizar estado do ba√∫
        const bauRef = db.collection('usuarios').doc(currentUser.uid).collection('bau_diario').doc('estado');
        batch.set(bauRef, {
          streak: streak + 1,
          ultimaAbertura: hoje,
          diasSemana: novosDias,
          totalAberturas: (bauData.totalAberturas || 0) + 1,
          ultimaRecompensa: { creditos: creditosTotal, xp: xpTotal, data: hoje }
        });

        // Creditar usu√°rio
        const userRef = db.collection('usuarios').doc(currentUser.uid);
        const updates = { creditos: firebase.firestore.FieldValue.increment(creditosTotal) };
        if (xpTotal > 0) {
          updates.xp = firebase.firestore.FieldValue.increment(xpTotal);
          updates.pontuacao = firebase.firestore.FieldValue.increment(xpTotal);
        }
        batch.update(userRef, updates);

        // Registrar no extrato
        const extratoRef = db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc();
        batch.set(extratoRef, {
          tipo: 'entrada',
          valor: creditosTotal,
          descricao: `Ba√∫ Di√°rio (dia ${dayInCycle + 1}/7)${creditosBonus > 0 ? ` +${creditosBonus} b√¥nus sequ√™ncia` : ''}`,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();

        // Atualizar dados locais
        bauData.streak = streak + 1;
        bauData.ultimaAbertura = hoje;
        bauData.diasSemana = novosDias;
        bauData.totalAberturas = (bauData.totalAberturas || 0) + 1;

        // Mostrar recompensa
        setTimeout(() => {
          chestIcon.classList.remove('opening');
          showReward(reward, creditosTotal, creditosBonus, xpTotal, dayInCycle + 1);
          renderUI(true);
          spawnConfetti();
        }, 800);

      } catch (e) {
        console.error('Erro ao abrir ba√∫:', e);
        showToast('‚ùå Erro ao abrir ba√∫');
        btn.disabled = false;
        chestIcon.classList.remove('opening');
      }
    }

    // SHOW REWARD
    function showReward(reward, creditosTotal, creditosBonus, xpTotal, dayNum) {
      document.getElementById('rewardEmoji').textContent = reward.emoji;
      document.getElementById('rewardTitle').textContent = dayNum === 7 ? 'üéâ SUPER RECOMPENSA!' : 'Recompensa do Dia!';
      document.getElementById('rewardDesc').textContent = `Dia ${dayNum} de 7`;

      let valueText = `+${creditosTotal} cr√©ditos`;
      if (xpTotal > 0) valueText += ` +${xpTotal} XP`;
      document.getElementById('rewardValue').textContent = valueText;

      const bonusEl = document.getElementById('rewardStreakBonus');
      if (creditosBonus > 0) {
        bonusEl.textContent = `üî• B√¥nus de sequ√™ncia: +${creditosBonus} cr√©ditos extras!`;
        bonusEl.style.display = 'inline-block';
      } else {
        bonusEl.style.display = 'none';
      }

      document.getElementById('rewardOverlay').classList.add('active');
    }

    function closeReward() {
      document.getElementById('rewardOverlay').classList.remove('active');
      showToast('‚úÖ Recompensa coletada!');
    }

    // CONFETTI
    function spawnConfetti() {
      const container = document.getElementById('confettiContainer');
      const colors = ['#ff9f43', '#ffc048', '#ff4757', '#2ed573', '#3b82f6', '#a855f7'];
      for (let i = 0; i < 50; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 1 + 's';
        c.style.animationDuration = (2 + Math.random() * 2) + 's';
        c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        c.style.width = (6 + Math.random() * 8) + 'px';
        c.style.height = (6 + Math.random() * 8) + 'px';
        container.appendChild(c);
        setTimeout(() => c.remove(), 4000);
      }
    }

    // TOAST
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
