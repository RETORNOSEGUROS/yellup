<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ba√∫ Di√°rio - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0e13;
      --bg-card: #131920;
      --bg-elevated: #1a2230;
      --accent-primary: #ff9f43;
      --accent-secondary: #ffc048;
      --accent-glow: rgba(255, 159, 67, 0.25);
      --live-red: #ff4757;
      --win-green: #2ed573;
      --text-primary: #f1f2f6;
      --text-secondary: #a4b0be;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse at top, rgba(255, 159, 67, 0.04) 0%, transparent 60%),
        radial-gradient(ellipse at bottom, rgba(26, 34, 48, 0.5) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    .header {
      background: rgba(10, 14, 19, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 159, 67, 0.1);
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img { height: 36px; filter: drop-shadow(0 2px 8px rgba(255, 181, 71, 0.3)); }
    .btn-back {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e7eef7;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85em;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }

    .container { max-width: 500px; margin: 0 auto; padding: 24px 20px; }

    .page-title { text-align: center; margin-bottom: 28px; }
    .page-title h1 { font-size: 1.5em; font-weight: 800; margin-bottom: 4px; }
    .page-title p { color: var(--text-secondary); font-size: 0.85em; }

    /* STREAK BAR */
    .streak-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(255, 159, 67, 0.08), rgba(255, 192, 72, 0.03));
      border: 1px solid rgba(255, 159, 67, 0.15);
      border-radius: 14px;
    }
    .streak-info { display: flex; align-items: center; gap: 10px; }
    .streak-fire { font-size: 1.6em; animation: fireGlow 1.5s ease-in-out infinite alternate; }
    @keyframes fireGlow {
      from { filter: brightness(1) drop-shadow(0 0 4px rgba(255, 159, 67, 0.3)); }
      to { filter: brightness(1.2) drop-shadow(0 0 12px rgba(255, 159, 67, 0.6)); }
    }
    .streak-count { font-size: 1.2em; font-weight: 800; color: var(--accent-secondary); }
    .streak-label { font-size: 0.7em; color: var(--text-secondary); }
    .streak-bonus {
      padding: 5px 12px;
      background: rgba(46, 213, 115, 0.12);
      border: 1px solid rgba(46, 213, 115, 0.25);
      border-radius: 20px;
      font-size: 0.72em;
      font-weight: 600;
      color: var(--win-green);
    }

    /* WEEK DOTS */
    .week-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 28px; }
    .day-dot { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .day-circle {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.9em; border: 2px solid rgba(255, 255, 255, 0.08);
      background: var(--bg-card); transition: all 0.3s ease;
    }
    .day-circle.claimed { border-color: var(--win-green); background: rgba(46, 213, 115, 0.12); }
    .day-circle.today { border-color: var(--accent-primary); background: rgba(255, 159, 67, 0.12); animation: todayPulse 2s ease-in-out infinite; }
    .day-circle.lost { border-color: rgba(255, 71, 87, 0.3); background: rgba(255, 71, 87, 0.08); }
    .day-circle.locked { opacity: 0.35; }
    @keyframes todayPulse {
      0%, 100% { box-shadow: 0 0 8px var(--accent-glow); }
      50% { box-shadow: 0 0 22px var(--accent-glow); }
    }
    .day-label { font-size: 0.58em; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }

    /* ============= CHEST SCENE ============= */
    .chest-scene {
      position: relative;
      width: 220px;
      height: 200px;
      margin: 0 auto 20px;
      cursor: pointer;
    }

    .chest-base {
      position: absolute;
      bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 150px; height: 90px;
      background: linear-gradient(180deg, #c8850a 0%, #a06800 40%, #7a4f00 100%);
      border-radius: 10px 10px 14px 14px;
      border: 3px solid #5a3800;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5), inset 0 -4px 10px rgba(0,0,0,0.3);
      z-index: 2;
    }
    .chest-base::before {
      content: '';
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 28px; height: 28px;
      background: radial-gradient(circle, #ffd700 30%, #b8860b 100%);
      border-radius: 50%;
      border: 2px solid #8b6914;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
    }
    .chest-base::after {
      content: '';
      position: absolute; top: 0; left: 8%; right: 8%; height: 5px;
      background: linear-gradient(90deg, transparent, rgba(255,215,0,0.3), transparent);
      border-radius: 0 0 4px 4px;
    }

    .chest-lid {
      position: absolute;
      bottom: 78px; left: 50%;
      transform: translateX(-50%);
      width: 158px; height: 65px;
      background: linear-gradient(180deg, #e0a020 0%, #c8850a 100%);
      border-radius: 18px 18px 4px 4px;
      border: 3px solid #5a3800;
      border-bottom: none;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
      transform-origin: bottom center;
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 3;
    }
    .chest-lid::before {
      content: '';
      position: absolute; bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 18px; height: 13px;
      background: #8b6914;
      border-radius: 4px 4px 0 0;
    }

    .chest-glow {
      position: absolute;
      bottom: 50px; left: 50%;
      transform: translateX(-50%);
      width: 120px; height: 80px;
      background: radial-gradient(ellipse, rgba(255, 215, 0, 0.6) 0%, rgba(255, 159, 67, 0.3) 40%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s;
      z-index: 1;
      filter: blur(10px);
    }

    /* Chest States */
    .chest-scene.idle .chest-base,
    .chest-scene.idle .chest-lid {
      animation: chestFloat 3s ease-in-out infinite;
    }
    @keyframes chestFloat {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-6px); }
    }

    .chest-scene.shaking .chest-base,
    .chest-scene.shaking .chest-lid {
      animation: chestShake 0.12s ease-in-out infinite alternate;
    }
    @keyframes chestShake {
      0% { transform: translateX(calc(-50% - 3px)) rotate(-2deg); }
      100% { transform: translateX(calc(-50% + 3px)) rotate(2deg); }
    }

    .chest-scene.opening .chest-lid {
      animation: none;
      transform: translateX(-50%) rotateX(-110deg) translateY(-15px);
    }
    .chest-scene.opening .chest-glow { opacity: 1; }
    .chest-scene.opening .chest-base { animation: none; transform: translateX(-50%); }

    .chest-scene.disabled {
      filter: grayscale(0.6) brightness(0.55);
      cursor: default;
    }
    .chest-scene.disabled .chest-base,
    .chest-scene.disabled .chest-lid { animation: none; }

    /* Floating rewards */
    .floating-reward {
      position: absolute;
      font-size: 1.8em;
      z-index: 10;
      pointer-events: none;
      animation: floatUp 1.5s ease-out forwards;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(0.5); }
      30% { opacity: 1; transform: translateY(-40px) scale(1.2); }
      100% { opacity: 0; transform: translateY(-120px) scale(0.8); }
    }

    /* CHEST ACTION */
    .chest-action { text-align: center; margin-bottom: 28px; }
    .chest-status {
      font-size: 0.92em; font-weight: 600;
      margin-bottom: 14px; color: var(--text-secondary); min-height: 28px;
    }
    .chest-status.available { color: var(--accent-secondary); }

    .btn-open {
      padding: 14px 44px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, #e88a30 100%);
      border: none; border-radius: 14px;
      color: #1a1200;
      font-family: 'Poppins', sans-serif;
      font-weight: 800; font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 25px var(--accent-glow);
    }
    .btn-open:hover { transform: translateY(-2px); box-shadow: 0 6px 35px var(--accent-glow); }
    .btn-open:active { transform: scale(0.97); }
    .btn-open:disabled {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-secondary);
      cursor: default; box-shadow: none; font-weight: 600;
    }
    .btn-open:disabled:hover { transform: none; }

    /* ============= RESULT OVERLAY ============= */
    .result-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.88);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }
    .result-overlay.active { display: flex; }

    .result-card {
      text-align: center;
      max-width: 340px; width: 90%;
      padding: 40px 28px;
      border-radius: 24px;
      animation: resultPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes resultPop {
      from { opacity: 0; transform: scale(0.4) rotate(-5deg); }
      to { opacity: 1; transform: scale(1) rotate(0); }
    }

    .result-card.win {
      background: linear-gradient(145deg, #1a2e1a 0%, #132213 100%);
      border: 2px solid rgba(46, 213, 115, 0.4);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(46, 213, 115, 0.1);
    }
    .result-card.lose {
      background: linear-gradient(145deg, #2a1a1a 0%, #1f1313 100%);
      border: 2px solid rgba(255, 71, 87, 0.3);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    .result-emoji { font-size: 4.5em; margin-bottom: 16px; display: inline-block; }
    .result-card.win .result-emoji { animation: winBounce 1s ease-in-out; }
    @keyframes winBounce {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-20px) rotate(-10deg); }
      50% { transform: translateY(-5px); }
      75% { transform: translateY(-12px) rotate(5deg); }
    }
    .result-card.lose .result-emoji { animation: loseSad 0.8s ease-in-out; }
    @keyframes loseSad {
      0%, 100% { transform: rotate(0); }
      30% { transform: rotate(-8deg); }
      60% { transform: rotate(8deg); }
    }

    .result-title { font-size: 1.5em; font-weight: 900; margin-bottom: 8px; }
    .result-card.win .result-title { color: var(--win-green); }
    .result-card.lose .result-title { color: var(--live-red); }

    .result-subtitle {
      font-size: 0.88em; color: var(--text-secondary);
      margin-bottom: 20px; line-height: 1.5;
    }
    .result-amount { font-size: 2.8em; font-weight: 900; margin-bottom: 20px; }
    .result-card.win .result-amount { color: var(--win-green); }
    .result-card.lose .result-amount { color: var(--text-secondary); font-size: 2em; }

    .result-streak-info {
      padding: 8px 16px;
      background: rgba(255, 159, 67, 0.1);
      border: 1px solid rgba(255, 159, 67, 0.2);
      border-radius: 10px;
      font-size: 0.78em; color: var(--accent-secondary);
      margin-bottom: 20px; display: inline-block;
    }
    .btn-close-result {
      padding: 14px 44px; border: none; border-radius: 14px;
      font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 1em;
      cursor: pointer; transition: all 0.3s;
    }
    .result-card.win .btn-close-result {
      background: linear-gradient(135deg, var(--win-green), #7bed9f);
      color: #0a1a0a;
      box-shadow: 0 4px 20px rgba(46, 213, 115, 0.3);
    }
    .result-card.lose .btn-close-result {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    .btn-close-result:hover { transform: translateY(-2px); }

    /* INFO BOX */
    .info-box {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
    }
    .info-box-title {
      font-size: 0.85em; font-weight: 700;
      margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }
    .info-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      font-size: 0.82em;
    }
    .info-row:last-child { border-bottom: none; }
    .info-row-label { color: var(--text-secondary); }
    .info-row-value { font-weight: 700; color: var(--accent-secondary); }
    .info-row-value.green { color: var(--win-green); }

    /* CONFETTI */
    .confetti-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 2001;
    }
    .confetti {
      position: absolute; width: 10px; height: 10px; top: -10px;
      animation: confettiFall 3s ease-in forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* BOTTOM NAV */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(14, 20, 27, 0.98);
      backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 99;
    }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      color: #a9b5c6; text-decoration: none; font-size: 0.75em;
      transition: all 0.3s ease; padding: 5px 10px;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }

    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9); color: white;
      padding: 15px 30px; border-radius: 50px;
      font-weight: 600; z-index: 3000; opacity: 0;
      transition: all 0.3s ease; font-size: 0.9em;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    @media (max-width: 400px) {
      .day-circle { width: 34px; height: 34px; font-size: 0.8em; }
      .week-progress { gap: 5px; }
      .chest-scene { width: 180px; height: 170px; }
      .chest-base { width: 120px; height: 72px; }
      .chest-lid { width: 128px; height: 52px; bottom: 62px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'">
      </div>
      <a href="painel.html" class="btn-back">‚Üê Voltar</a>
    </div>
  </div>

  <div class="container">

    <div class="page-title">
      <h1>üéÅ Ba√∫ Di√°rio</h1>
      <p>Teste sua sorte! De 0 a 5 cr√©ditos por dia</p>
    </div>

    <div class="streak-bar">
      <div class="streak-info">
        <span class="streak-fire">üî•</span>
        <div>
          <div class="streak-count" id="streakCount">0 dias</div>
          <div class="streak-label">Sequ√™ncia atual</div>
        </div>
      </div>
      <div class="streak-bonus" id="streakBonus">Sorte normal</div>
    </div>

    <div class="week-progress" id="weekDots"></div>

    <!-- CHEST -->
    <div class="chest-scene idle" id="chestScene">
      <div class="chest-glow" id="chestGlow"></div>
      <div class="chest-lid" id="chestLid"></div>
      <div class="chest-base" id="chestBase"></div>
    </div>

    <div class="chest-action">
      <div class="chest-status available" id="chestStatus">Toque para tentar a sorte!</div>
      <button class="btn-open" id="btnOpen" disabled>Carregando...</button>
    </div>

    <div class="info-box">
      <div class="info-box-title">üé≤ Como funciona</div>
      <div class="info-row">
        <span class="info-row-label">Cr√©ditos poss√≠veis</span>
        <span class="info-row-value">0 a 5</span>
      </div>
      <div class="info-row">
        <span class="info-row-label">Chance de ganhar</span>
        <span class="info-row-value green">70%</span>
      </div>
      <div class="info-row">
        <span class="info-row-label">B√¥nus de sequ√™ncia</span>
        <span class="info-row-value">+1 cr√©dito extra a cada 7 dias</span>
      </div>
    </div>

    <div class="info-box">
      <div class="info-box-title">üìä Seu hist√≥rico</div>
      <div class="info-row">
        <span class="info-row-label">Total de aberturas</span>
        <span class="info-row-value" id="totalAberturas">0</span>
      </div>
      <div class="info-row">
        <span class="info-row-label">Total ganho</span>
        <span class="info-row-value green" id="totalGanho">0 cr√©ditos</span>
      </div>
      <div class="info-row">
        <span class="info-row-label">Maior sequ√™ncia</span>
        <span class="info-row-value" id="maiorStreak">0 dias</span>
      </div>
    </div>

  </div>

  <!-- RESULT OVERLAY -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-emoji" id="resultEmoji">üí∞</div>
      <div class="result-title" id="resultTitle">Parab√©ns!</div>
      <div class="result-subtitle" id="resultSubtitle">Voc√™ encontrou cr√©ditos!</div>
      <div class="result-amount" id="resultAmount">+3</div>
      <div class="result-streak-info" id="resultStreakInfo" style="display:none"></div>
      <br>
      <button class="btn-close-result" onclick="closeResult()">Fechar</button>
    </div>
  </div>

  <div class="confetti-container" id="confettiContainer"></div>

  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
      <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
    </div>
  </nav>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const DAYS_LABEL = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
    let currentUser = null;
    let bauData = null;

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e => console.error(e));

    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      await loadBau();
    });

    function getToday() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function getDayOfWeek() {
      const d = new Date().getDay();
      return d === 0 ? 6 : d - 1;
    }

    // ============ RANDOM REWARD ============
    function calcularRecompensa(streak) {
      const rand = Math.random();
      let creditos = 0;

      if (rand < 0.30)      creditos = 0; // 30% nada
      else if (rand < 0.55) creditos = 1; // 25%
      else if (rand < 0.72) creditos = 2; // 17%
      else if (rand < 0.84) creditos = 3; // 12%
      else if (rand < 0.93) creditos = 4; // 9%
      else                  creditos = 5; // 7% jackpot

      // B√¥nus sequ√™ncia: +1 a cada 7 dias (max +3)
      const bonusStreak = Math.min(Math.floor(streak / 7), 3);
      if (bonusStreak > 0 && creditos > 0) creditos += bonusStreak;

      const xp = creditos > 0 ? 5 + (creditos * 2) : 3;
      return { creditos, xp, bonusStreak };
    }

    // ============ LOAD ============
    async function loadBau() {
      try {
        const ref = db.collection('usuarios').doc(currentUser.uid).collection('bau_diario').doc('estado');
        const doc = await ref.get();
        const hoje = getToday();

        if (doc.exists) {
          bauData = doc.data();
          const ontem = new Date();
          ontem.setDate(ontem.getDate() - 1);
          const ontemStr = `${ontem.getFullYear()}-${String(ontem.getMonth()+1).padStart(2,'0')}-${String(ontem.getDate()).padStart(2,'0')}`;

          if (bauData.ultimaAbertura !== hoje && bauData.ultimaAbertura !== ontemStr) {
            bauData.streak = 0;
            bauData.diasSemana = [];
            bauData.resultadosSemana = {};
          }

          // Reset semanal (segunda-feira)
          if (getDayOfWeek() === 0 && bauData.ultimaAbertura !== hoje) {
            bauData.diasSemana = [];
            bauData.resultadosSemana = {};
          }
        } else {
          bauData = { streak: 0, ultimaAbertura: null, diasSemana: [], resultadosSemana: {}, totalAberturas: 0, totalGanho: 0, maiorStreak: 0 };
        }

        renderUI(bauData.ultimaAbertura === hoje);
      } catch (e) {
        console.error('Erro ao carregar ba√∫:', e);
        showToast('‚ùå Erro ao carregar');
      }
    }

    // ============ RENDER ============
    function renderUI(jaAbriuHoje) {
      const streak = bauData.streak || 0;
      const bonusLevel = Math.min(Math.floor(streak / 7), 3);

      document.getElementById('streakCount').textContent = `${streak} dia${streak !== 1 ? 's' : ''}`;
      document.getElementById('streakBonus').textContent = bonusLevel > 0 ? `+${bonusLevel} b√¥nus` : 'Sorte normal';

      document.getElementById('totalAberturas').textContent = bauData.totalAberturas || 0;
      document.getElementById('totalGanho').textContent = `${bauData.totalGanho || 0} cr√©ditos`;
      document.getElementById('maiorStreak').textContent = `${bauData.maiorStreak || 0} dias`;

      // Week dots
      const dotsContainer = document.getElementById('weekDots');
      const diaAtual = getDayOfWeek();
      const diasAbertos = bauData.diasSemana || [];
      const resultados = bauData.resultadosSemana || {};

      dotsContainer.innerHTML = DAYS_LABEL.map((label, i) => {
        const abriu = diasAbertos.includes(i);
        const isToday = i === diaAtual;
        const isFuture = i > diaAtual;
        let cls = '', icon = '';

        if (abriu || (isToday && jaAbriuHoje)) {
          const ganhou = resultados[i] > 0;
          cls = ganhou ? 'claimed' : 'lost';
          icon = ganhou ? 'üí∞' : 'üò¢';
        } else if (isToday) {
          cls = 'today';
          icon = '‚ùì';
        } else if (isFuture) {
          cls = 'locked';
          icon = 'üîí';
        } else {
          icon = '¬∑';
        }

        return `<div class="day-dot">
          <div class="day-circle ${cls}">${icon}</div>
          <span class="day-label">${label}</span>
        </div>`;
      }).join('');

      // Chest state
      const scene = document.getElementById('chestScene');
      const statusEl = document.getElementById('chestStatus');
      const btnOpen = document.getElementById('btnOpen');

      if (jaAbriuHoje) {
        scene.className = 'chest-scene disabled';
        statusEl.textContent = 'J√° abriu hoje! Volte amanh√£ üïê';
        statusEl.className = 'chest-status';
        btnOpen.disabled = true;
        btnOpen.textContent = 'Volte amanh√£';
      } else {
        scene.className = 'chest-scene idle';
        statusEl.textContent = 'Toque para tentar a sorte!';
        statusEl.className = 'chest-status available';
        btnOpen.disabled = false;
        btnOpen.textContent = 'üé≤ Abrir Ba√∫';
      }
    }

    // ============ OPEN CHEST ============
    document.getElementById('btnOpen').addEventListener('click', openChest);
    document.getElementById('chestScene').addEventListener('click', () => {
      if (!document.getElementById('btnOpen').disabled) openChest();
    });

    let opening = false;
    async function openChest() {
      if (opening) return;
      const btn = document.getElementById('btnOpen');
      if (btn.disabled) return;
      opening = true;
      btn.disabled = true;

      const scene = document.getElementById('chestScene');
      const statusEl = document.getElementById('chestStatus');

      // Phase 1: Shake
      scene.className = 'chest-scene shaking';
      statusEl.textContent = 'üé≤ Sorteando...';
      statusEl.className = 'chest-status';
      await sleep(1800);

      // Phase 2: Open lid
      scene.className = 'chest-scene opening';
      const streak = bauData.streak || 0;
      const reward = calcularRecompensa(streak);

      // Floating emojis
      if (reward.creditos > 0) {
        for (let i = 0; i < Math.min(reward.creditos, 5); i++) {
          setTimeout(() => spawnFloatingReward(scene, 'üí∞'), i * 200);
        }
      } else {
        setTimeout(() => spawnFloatingReward(scene, 'üí®'), 300);
      }

      await sleep(1200);

      // Save
      try {
        const hoje = getToday();
        const diaAtual = getDayOfWeek();
        const novosDias = [...(bauData.diasSemana || [])];
        if (!novosDias.includes(diaAtual)) novosDias.push(diaAtual);

        const novosResultados = { ...(bauData.resultadosSemana || {}) };
        novosResultados[diaAtual] = reward.creditos;

        const novoStreak = streak + 1;
        const novoMaiorStreak = Math.max(bauData.maiorStreak || 0, novoStreak);

        const batch = db.batch();

        const bauRef = db.collection('usuarios').doc(currentUser.uid).collection('bau_diario').doc('estado');
        batch.set(bauRef, {
          streak: novoStreak,
          ultimaAbertura: hoje,
          diasSemana: novosDias,
          resultadosSemana: novosResultados,
          totalAberturas: (bauData.totalAberturas || 0) + 1,
          totalGanho: (bauData.totalGanho || 0) + reward.creditos,
          maiorStreak: novoMaiorStreak,
          ultimaRecompensa: { creditos: reward.creditos, xp: reward.xp, data: hoje }
        });

        const userRef = db.collection('usuarios').doc(currentUser.uid);
        const updates = {};
        if (reward.creditos > 0) updates.creditos = firebase.firestore.FieldValue.increment(reward.creditos);
        if (reward.xp > 0) {
          updates.xp = firebase.firestore.FieldValue.increment(reward.xp);
          updates.pontuacao = firebase.firestore.FieldValue.increment(reward.xp);
        }
        if (Object.keys(updates).length > 0) batch.update(userRef, updates);

        if (reward.creditos > 0) {
          const extratoRef = db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc();
          batch.set(extratoRef, {
            tipo: 'entrada',
            valor: reward.creditos,
            descricao: `Ba√∫ Di√°rio${reward.bonusStreak > 0 ? ` (+${reward.bonusStreak} b√¥nus sequ√™ncia)` : ''}`,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        await batch.commit();

        // Miss√£o
        try {
          const missaoRef = db.collection('usuarios').doc(currentUser.uid).collection('missoes').doc('abrir_bau');
          const missaoDoc = await missaoRef.get();
          if (missaoDoc.exists && !missaoDoc.data().concluido) {
            await missaoRef.update({ atual: 1, concluido: true });
          }
        } catch (me) { console.warn('Miss√£o:', me); }

        // Update local
        bauData.streak = novoStreak;
        bauData.ultimaAbertura = hoje;
        bauData.diasSemana = novosDias;
        bauData.resultadosSemana = novosResultados;
        bauData.totalAberturas = (bauData.totalAberturas || 0) + 1;
        bauData.totalGanho = (bauData.totalGanho || 0) + reward.creditos;
        bauData.maiorStreak = novoMaiorStreak;

        showResult(reward);
        renderUI(true);
        if (reward.creditos > 0) spawnConfetti();

      } catch (e) {
        console.error('Erro:', e);
        showToast('‚ùå Erro ao abrir ba√∫');
        btn.disabled = false;
        scene.className = 'chest-scene idle';
      }
      opening = false;
    }

    // ============ RESULT ============
    function showResult(reward) {
      const card = document.getElementById('resultCard');
      const emoji = document.getElementById('resultEmoji');
      const title = document.getElementById('resultTitle');
      const subtitle = document.getElementById('resultSubtitle');
      const amount = document.getElementById('resultAmount');
      const streakInfo = document.getElementById('resultStreakInfo');

      if (reward.creditos > 0) {
        card.className = 'result-card win';
        if (reward.creditos >= 5) {
          emoji.textContent = 'ü§ë'; title.textContent = 'JACKPOT!';
          subtitle.textContent = `Pr√™mio m√°ximo! (+${reward.xp} XP)`;
        } else if (reward.creditos >= 3) {
          emoji.textContent = 'üéâ'; title.textContent = 'Boa sorte!';
          subtitle.textContent = `√ìtima recompensa! (+${reward.xp} XP)`;
        } else {
          emoji.textContent = 'üí∞'; title.textContent = 'Ganhou!';
          subtitle.textContent = `Cr√©ditos na conta! (+${reward.xp} XP)`;
        }
        amount.textContent = `+${reward.creditos} cr√©ditos`;

        if (reward.bonusStreak > 0) {
          streakInfo.textContent = `üî• B√¥nus sequ√™ncia: +${reward.bonusStreak} extra!`;
          streakInfo.style.display = 'inline-block';
        } else {
          streakInfo.style.display = 'none';
        }
      } else {
        card.className = 'result-card lose';
        emoji.textContent = 'üòÖ';
        title.textContent = 'Sem sorte hoje!';
        subtitle.textContent = `Amanh√£ pode ser diferente! (+${reward.xp} XP de consolo)`;
        amount.textContent = '0 cr√©ditos';
        streakInfo.textContent = 'üî• Sua sequ√™ncia continua! Volte amanh√£';
        streakInfo.style.display = 'inline-block';
      }

      document.getElementById('resultOverlay').classList.add('active');
    }

    function closeResult() {
      document.getElementById('resultOverlay').classList.remove('active');
    }

    // ============ EFFECTS ============
    function spawnFloatingReward(container, emoji) {
      const el = document.createElement('div');
      el.className = 'floating-reward';
      el.textContent = emoji;
      el.style.left = (25 + Math.random() * 50) + '%';
      el.style.top = '20%';
      container.appendChild(el);
      setTimeout(() => el.remove(), 1500);
    }

    function spawnConfetti() {
      const container = document.getElementById('confettiContainer');
      const colors = ['#ff9f43', '#ffc048', '#ff4757', '#2ed573', '#3b82f6', '#a855f7', '#ffd700'];
      for (let i = 0; i < 60; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 1 + 's';
        c.style.animationDuration = (2 + Math.random() * 2) + 's';
        c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        c.style.width = (6 + Math.random() * 8) + 'px';
        c.style.height = (6 + Math.random() * 8) + 'px';
        container.appendChild(c);
        setTimeout(() => c.remove(), 4000);
      }
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
