<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resultado - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-credits {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 14px;
      background: rgba(255, 181, 71, 0.15);
      border-radius: 20px;
      font-weight: 700;
      color: #ffb547;
    }

    /* Container */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Winner Section */
    .winner-section {
      text-align: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, rgba(255, 181, 71, 0.15), rgba(255, 140, 66, 0.05));
      border: 2px solid rgba(255, 181, 71, 0.3);
      border-radius: 24px;
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
    }

    .winner-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 181, 71, 0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .winner-content {
      position: relative;
      z-index: 1;
    }

    .winner-badge {
      display: inline-block;
      padding: 8px 20px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border-radius: 20px;
      color: #0e141b;
      font-weight: 700;
      font-size: 0.85em;
      margin-bottom: 20px;
    }

    .winner-crown {
      font-size: 4em;
      margin-bottom: 15px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .winner-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      font-weight: 800;
      color: #0e141b;
      margin: 0 auto 15px;
      border: 4px solid rgba(255, 255, 255, 0.3);
    }

    .winner-name {
      font-size: 1.8em;
      font-weight: 800;
      margin-bottom: 5px;
    }

    .winner-points {
      font-size: 1.2em;
      color: #a9b5c6;
      margin-bottom: 20px;
    }

    .winner-prize {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 15px 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
    }

    .prize-icon {
      font-size: 1.5em;
    }

    .prize-value {
      font-size: 1.5em;
      font-weight: 800;
      color: #ffb547;
    }

    .prize-label {
      font-size: 0.85em;
      color: #a9b5c6;
    }

    /* Empate */
    .tie-section {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 20px;
      margin-bottom: 25px;
    }

    .tie-icon {
      font-size: 3em;
      margin-bottom: 15px;
    }

    .tie-title {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .tie-winners {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .tie-winner {
      text-align: center;
    }

    .tie-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: 700;
      color: #0e141b;
      margin: 0 auto 8px;
    }

    .tie-name {
      font-weight: 600;
    }

    /* Ranking Final */
    .ranking-card {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.95) 0%, rgba(24, 34, 46, 0.95) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ranking-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 14px;
      transition: all 0.3s ease;
    }

    .ranking-item.me {
      background: rgba(255, 181, 71, 0.1);
      border: 2px solid rgba(255, 181, 71, 0.3);
    }

    .ranking-item.first {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
      border: 2px solid rgba(255, 215, 0, 0.4);
    }

    .ranking-position {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.9em;
      flex-shrink: 0;
    }

    .ranking-position.gold {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #0e141b;
    }

    .ranking-position.silver {
      background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
      color: #0e141b;
    }

    .ranking-position.bronze {
      background: linear-gradient(135deg, #cd7f32, #a56527);
      color: #fff;
    }

    .ranking-position.normal {
      background: rgba(255, 255, 255, 0.1);
      color: #a9b5c6;
    }

    .ranking-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #0e141b;
      flex-shrink: 0;
    }

    .ranking-info {
      flex: 1;
    }

    .ranking-name {
      font-weight: 600;
      font-size: 1em;
      margin-bottom: 3px;
    }

    .ranking-stats {
      font-size: 0.8em;
      color: #a9b5c6;
    }

    .ranking-right {
      text-align: right;
    }

    .ranking-points {
      font-size: 1.2em;
      font-weight: 800;
      color: #ffb547;
    }

    .ranking-prize {
      font-size: 0.85em;
      color: #10b981;
      margin-top: 3px;
    }

    /* Minha Performance */
    .my-performance {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.95) 0%, rgba(24, 34, 46, 0.95) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .performance-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .performance-item {
      text-align: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }

    .performance-value {
      font-size: 1.8em;
      font-weight: 800;
    }

    .performance-value.gold { color: #ffb547; }
    .performance-value.green { color: #10b981; }
    .performance-value.red { color: #ef4444; }
    .performance-value.blue { color: #60a5fa; }

    .performance-label {
      font-size: 0.75em;
      color: #a9b5c6;
      margin-top: 5px;
      text-transform: uppercase;
    }

    /* Conquistas */
    .achievements-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .achievement-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .achievement-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }

    .achievement-icon {
      font-size: 2em;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-weight: 600;
    }

    .achievement-desc {
      font-size: 0.85em;
      color: #a9b5c6;
    }

    .achievement-new {
      padding: 4px 10px;
      background: #8b5cf6;
      border-radius: 20px;
      font-size: 0.7em;
      font-weight: 700;
      color: #fff;
    }

    /* Embate Info */
    .embate-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 14px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .embate-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .embate-info-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .embate-info-icon {
      font-size: 1.2em;
    }

    .embate-info-text {
      font-size: 0.9em;
    }

    .embate-info-label {
      color: #a9b5c6;
      font-size: 0.75em;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    .btn-action {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-action.primary {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }

    .btn-action.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 181, 71, 0.4);
    }

    .btn-action.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e7eef7;
    }

    .btn-action.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 28px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 12px;
      color: #fff;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Loading */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      min-height: 60vh;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #ffb547;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      color: #a9b5c6;
    }

    /* Confetti (simple CSS version) */
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #ffb547;
      animation: confetti-fall 3s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100%) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .performance-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .embate-info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='embates-pvp.html'">‚Üê Voltar</button>
      <div class="logo">YELLUP</div>
      <div class="header-credits">
        <span>üíé</span>
        <span id="userCredits">0</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="container">
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-text">Carregando resultado...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container" id="mainContent" style="display: none;">
    
    <!-- Winner Section (ou Tie Section) -->
    <div id="winnerSection"></div>

    <!-- Ranking Final -->
    <div class="ranking-card">
      <div class="card-title">
        <span>üèÜ</span> Ranking Final
      </div>
      <div class="ranking-list" id="rankingList">
        <!-- Preenchido via JS -->
      </div>
    </div>

    <!-- Minha Performance -->
    <div class="my-performance">
      <div class="card-title">
        <span>üìä</span> Minha Performance
      </div>
      <div class="performance-grid">
        <div class="performance-item">
          <div class="performance-value gold" id="perfPontos">0</div>
          <div class="performance-label">Pontos</div>
        </div>
        <div class="performance-item">
          <div class="performance-value green" id="perfAcertos">0</div>
          <div class="performance-label">Acertos</div>
        </div>
        <div class="performance-item">
          <div class="performance-value red" id="perfErros">0</div>
          <div class="performance-label">Erros</div>
        </div>
        <div class="performance-item">
          <div class="performance-value blue" id="perfTaxa">0%</div>
          <div class="performance-label">Taxa Acerto</div>
        </div>
        <div class="performance-item">
          <div class="performance-value gold" id="perfStreak">0</div>
          <div class="performance-label">Maior Streak</div>
        </div>
        <div class="performance-item">
          <div class="performance-value" id="perfPosicao">-</div>
          <div class="performance-label">Posi√ß√£o</div>
        </div>
      </div>
    </div>

    <!-- Conquistas Desbloqueadas -->
    <div class="achievements-card" id="achievementsCard" style="display: none;">
      <div class="card-title">
        <span>üéñÔ∏è</span> Conquistas Desbloqueadas!
      </div>
      <div class="achievement-list" id="achievementList">
        <!-- Preenchido via JS -->
      </div>
    </div>

    <!-- Info do Embate -->
    <div class="embate-info">
      <div class="embate-info-grid">
        <div class="embate-info-item">
          <span class="embate-info-icon">üéØ</span>
          <div>
            <div class="embate-info-text" id="infoTema">-</div>
            <div class="embate-info-label">Tema</div>
          </div>
        </div>
        <div class="embate-info-item">
          <span class="embate-info-icon">üéÆ</span>
          <div>
            <div class="embate-info-text" id="infoModo">-</div>
            <div class="embate-info-label">Modo</div>
          </div>
        </div>
        <div class="embate-info-item">
          <span class="embate-info-icon">‚è±Ô∏è</span>
          <div>
            <div class="embate-info-text" id="infoDuracao">-</div>
            <div class="embate-info-label">Dura√ß√£o</div>
          </div>
        </div>
        <div class="embate-info-item">
          <span class="embate-info-icon">üìÖ</span>
          <div>
            <div class="embate-info-text" id="infoData">-</div>
            <div class="embate-info-label">Data</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot√µes de A√ß√£o -->
    <div class="action-buttons">
      <button class="btn-action secondary" onclick="compartilharResultado()">
        üì§ Compartilhar
      </button>
      <button class="btn-action primary" onclick="window.location.href='embates-pvp.html'">
        ‚öîÔ∏è Novo Embate
      </button>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-init.js"></script>

  <script>
    // ===================================
    // üîß VARI√ÅVEIS GLOBAIS
    // ===================================
    let currentUserId = null;
    let currentUserData = null;
    let embateId = null;
    let embateData = null;
    let participacoes = [];
    let minhaParticipacao = null;

    // ===================================
    // üöÄ INICIALIZA√á√ÉO
    // ===================================
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      currentUserId = user.uid;
      
      try {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        currentUserData = userDoc.data();
        
        document.getElementById('userCredits').textContent = currentUserData.creditos || 0;
        
        // Pegar ID do embate da URL
        const params = new URLSearchParams(window.location.search);
        embateId = params.get('id');
        
        if (!embateId) {
          showToast('‚ùå Embate n√£o encontrado');
          setTimeout(() => window.location.href = 'embates-pvp.html', 2000);
          return;
        }
        
        // Carregar resultado
        await carregarResultado();
        
      } catch (error) {
        console.error("Erro ao inicializar:", error);
        showToast('‚ùå Erro ao carregar resultado');
      }
    });

    // ===================================
    // üìä CARREGAR RESULTADO
    // ===================================
    let fotoUsuarios = {}; // Cache de fotos
    
    async function carregarResultado() {
      try {
        // Carregar embate
        const embateDoc = await db.collection('embates').doc(embateId).get();
        
        if (!embateDoc.exists) {
          showToast('‚ùå Embate n√£o encontrado');
          setTimeout(() => window.location.href = 'embates-pvp.html', 2000);
          return;
        }
        
        embateData = { id: embateDoc.id, ...embateDoc.data() };
        
        // Carregar participa√ß√µes
        const partSnapshot = await db.collection('embates').doc(embateId)
          .collection('participacoes')
          .orderBy('pontos', 'desc')
          .get();
        
        participacoes = [];
        partSnapshot.forEach(doc => {
          const data = { odId: doc.id, ...doc.data() };
          participacoes.push(data);
          if (doc.id === currentUserId) {
            minhaParticipacao = data;
          }
        });
        
        // Carregar fotos dos participantes
        await carregarFotosParticipantes();
        
        // Renderizar
        renderizarResultado();
        
      } catch (error) {
        console.error("Erro ao carregar resultado:", error);
        showToast('‚ùå Erro ao carregar resultado');
      }
    }
    
    // ===================================
    // üì∏ CARREGAR FOTOS DOS PARTICIPANTES
    // ===================================
    async function carregarFotosParticipantes() {
      try {
        const ids = participacoes.map(p => p.odId);
        
        for (const odId of ids) {
          const userDoc = await db.collection('usuarios').doc(odId).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            fotoUsuarios[odId] = userData.fotoPerfil || userData.foto || null;
          }
        }
      } catch (error) {
        console.log("Erro ao carregar fotos:", error);
      }
    }
    
    // ===================================
    // üéÅ OBTER FOTO DO USU√ÅRIO
    // ===================================
    function obterFotoUsuario(odId, nome) {
      const foto = fotoUsuarios[odId];
      const letra = (nome || '?').charAt(0).toUpperCase();
      
      if (foto) {
        return `<div class="winner-avatar" style="background-image: url('${foto}'); background-size: cover; background-position: center;"></div>`;
      }
      return `<div class="winner-avatar">${letra}</div>`;
    }
    
    function obterFotoRanking(odId, nome) {
      const foto = fotoUsuarios[odId];
      const letra = (nome || '?').charAt(0).toUpperCase();
      
      if (foto) {
        return `<div class="ranking-avatar" style="background-image: url('${foto}'); background-size: cover; background-position: center;"></div>`;
      }
      return `<div class="ranking-avatar">${letra}</div>`;
    }

    // ===================================
    // üé® RENDERIZAR RESULTADO
    // ===================================
    function renderizarResultado() {
      // Esconder loading
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      const resultado = embateData.resultado || {};
      
      // Se n√£o tem resultado ainda, calcular baseado nas participa√ß√µes
      if (!resultado.vencedorId && !resultado.empate && participacoes.length > 0) {
        // Ordenar por pontos
        const ordenados = [...participacoes].sort((a, b) => (b.pontos || 0) - (a.pontos || 0));
        const maiorPontuacao = ordenados[0]?.pontos || 0;
        const vencedores = ordenados.filter(p => p.pontos === maiorPontuacao);
        
        if (vencedores.length > 1) {
          resultado.empate = true;
          resultado.vencedoresEmpate = vencedores.map(v => v.odId);
          resultado.pontuacaoVencedor = maiorPontuacao;
        } else {
          resultado.empate = false;
          resultado.vencedorId = vencedores[0]?.odId;
          resultado.vencedorNome = vencedores[0]?.odNome;
          resultado.pontuacaoVencedor = maiorPontuacao;
        }
        
        resultado.ranking = ordenados.map((p, i) => ({
          posicao: i + 1,
          odId: p.odId,
          odNome: p.odNome,
          pontos: p.pontos || 0,
          acertos: p.acertos || 0,
          erros: p.erros || 0
        }));
      }
      
      // Se√ß√£o do vencedor
      renderizarVencedor(resultado);
      
      // Ranking
      renderizarRanking(resultado);
      
      // Minha performance
      renderizarMinhaPerformance();
      
      // Info do embate
      renderizarInfoEmbate();
      
      // Verificar conquistas
      verificarConquistas();
      
      // Confetti se eu ganhei
      const euGanhei = resultado.vencedorId === currentUserId || 
                       resultado.vencedoresEmpate?.includes(currentUserId);
      if (euGanhei) {
        dispararConfetti();
      }
    }

    // ===================================
    // üëë RENDERIZAR VENCEDOR
    // ===================================
    function renderizarVencedor(resultado) {
      const container = document.getElementById('winnerSection');
      
      // Verificar se tem resultado v√°lido
      if (!resultado || (!resultado.vencedorId && !resultado.empate)) {
        container.innerHTML = `
          <div class="winner-section">
            <div class="winner-content">
              <div class="winner-badge">üèÅ FINALIZADO</div>
              <div class="winner-crown">‚è≥</div>
              <div class="winner-name">Resultado sendo calculado...</div>
            </div>
          </div>
        `;
        return;
      }
      
      if (resultado.empate) {
        // Empate
        const vencedores = participacoes.filter(p => 
          resultado.vencedoresEmpate?.includes(p.odId)
        );
        
        container.innerHTML = `
          <div class="tie-section">
            <div class="tie-icon">ü§ù</div>
            <div class="tie-title">Empate!</div>
            <p style="color: #a9b5c6;">${vencedores.length} jogadores empataram com ${resultado.pontuacaoVencedor} pontos</p>
            <div class="tie-winners">
              ${vencedores.map(v => {
                const foto = fotoUsuarios[v.odId];
                const letra = v.odNome?.charAt(0).toUpperCase() || '?';
                const avatarHtml = foto 
                  ? `<div class="tie-avatar" style="background-image: url('${foto}'); background-size: cover;"></div>`
                  : `<div class="tie-avatar">${letra}</div>`;
                return `
                  <div class="tie-winner">
                    ${avatarHtml}
                    <div class="tie-name">${v.odNome}</div>
                  </div>
                `;
              }).join('')}
            </div>
            <div style="margin-top: 20px;">
              <span class="prize-icon">üèÜ</span>
              <span class="prize-value">${Math.floor((embateData.prizePool || 0) / vencedores.length)} üíé</span>
              <span class="prize-label">cada</span>
            </div>
          </div>
        `;
      } else {
        // Vencedor √∫nico
        const vencedor = participacoes.find(p => p.odId === resultado.vencedorId);
        const foto = fotoUsuarios[resultado.vencedorId];
        const letra = vencedor?.odNome?.charAt(0).toUpperCase() || '?';
        const avatarHtml = foto 
          ? `<div class="winner-avatar" style="background-image: url('${foto}'); background-size: cover; background-position: center;"></div>`
          : `<div class="winner-avatar">${letra}</div>`;
        
        container.innerHTML = `
          <div class="winner-section">
            <div class="winner-content">
              <div class="winner-badge">üèÜ VENCEDOR</div>
              <div class="winner-crown">üëë</div>
              ${avatarHtml}
              <div class="winner-name">${vencedor?.odNome || 'An√¥nimo'}</div>
              <div class="winner-points">${resultado.pontuacaoVencedor} pontos</div>
              <div class="winner-prize">
                <span class="prize-icon">üèÜ</span>
                <div>
                  <div class="prize-value">${embateData.prizePool || 0} üíé</div>
                  <div class="prize-label">Prize Pool</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
    }

    // ===================================
    // üìä RENDERIZAR RANKING
    // ===================================
    function renderizarRanking(resultado) {
      const container = document.getElementById('rankingList');
      
      // Ordenar participa√ß√µes por pontos se n√£o tiver ranking
      const sortedParticipacoes = [...participacoes].sort((a, b) => (b.pontos || 0) - (a.pontos || 0));
      
      const ranking = resultado?.ranking || sortedParticipacoes.map((p, i) => ({
        ...p,
        posicao: i + 1,
        premio: 0
      }));
      
      container.innerHTML = ranking.map(p => {
        const isMe = p.odId === currentUserId;
        const isFirst = p.posicao === 1;
        const posClass = p.posicao === 1 ? 'gold' : p.posicao === 2 ? 'silver' : p.posicao === 3 ? 'bronze' : 'normal';
        const nome = p.odNome || p.nome || 'An√¥nimo';
        const foto = fotoUsuarios[p.odId];
        const letra = nome.charAt(0).toUpperCase();
        
        const avatarHtml = foto 
          ? `<div class="ranking-avatar" style="background-image: url('${foto}'); background-size: cover; background-position: center;"></div>`
          : `<div class="ranking-avatar">${letra}</div>`;
        
        return `
          <div class="ranking-item ${isMe ? 'me' : ''} ${isFirst ? 'first' : ''}">
            <div class="ranking-position ${posClass}">${p.posicao}</div>
            ${avatarHtml}
            <div class="ranking-info">
              <div class="ranking-name">${nome} ${isMe ? '(voc√™)' : ''}</div>
              <div class="ranking-stats">${p.acertos || 0} acertos ‚Ä¢ ${p.erros || 0} erros</div>
            </div>
            <div class="ranking-right">
              <div class="ranking-points">${p.pontos || 0}</div>
              ${p.premio > 0 ? `<div class="ranking-prize">+${p.premio} üíé</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // ===================================
    // üìà RENDERIZAR MINHA PERFORMANCE
    // ===================================
    function renderizarMinhaPerformance() {
      if (!minhaParticipacao) return;
      
      const total = (minhaParticipacao.acertos || 0) + (minhaParticipacao.erros || 0);
      const taxa = total > 0 ? Math.round((minhaParticipacao.acertos / total) * 100) : 0;
      
      // Encontrar minha posi√ß√£o
      const minhaPosicao = participacoes.findIndex(p => p.odId === currentUserId) + 1;
      
      document.getElementById('perfPontos').textContent = minhaParticipacao.pontos || 0;
      document.getElementById('perfAcertos').textContent = minhaParticipacao.acertos || 0;
      document.getElementById('perfErros').textContent = minhaParticipacao.erros || 0;
      document.getElementById('perfTaxa').textContent = `${taxa}%`;
      document.getElementById('perfStreak').textContent = minhaParticipacao.streakMaximo || 0;
      document.getElementById('perfPosicao').textContent = `${minhaPosicao}¬∫`;
    }

    // ===================================
    // üìã RENDERIZAR INFO EMBATE
    // ===================================
    function renderizarInfoEmbate() {
      document.getElementById('infoTema').textContent = embateData.tema?.nome || '-';
      
      const modos = { normal: 'Normal', hardcore: 'Hardcore', sobrevivencia: 'Sobreviv√™ncia' };
      document.getElementById('infoModo').textContent = modos[embateData.modo] || '-';
      
      document.getElementById('infoDuracao').textContent = `${embateData.duracao || 10} min`;
      
      if (embateData.dataInicio) {
        const data = embateData.dataInicio.toDate();
        document.getElementById('infoData').textContent = data.toLocaleDateString('pt-BR');
      }
    }

    // ===================================
    // üéñÔ∏è VERIFICAR CONQUISTAS
    // ===================================
    async function verificarConquistas() {
      if (!minhaParticipacao) return;
      
      const conquistasDesbloqueadas = [];
      const pvp = currentUserData.pvp || {};
      const conquistasAtuais = pvp.conquistasPvp || [];
      
      // Defini√ß√£o de conquistas
      const conquistas = [
        {
          id: 'primeira_vitoria',
          nome: 'Primeira Vit√≥ria',
          desc: 'Ven√ßa seu primeiro embate',
          icone: 'üèÜ',
          condicao: () => embateData.resultado?.vencedorId === currentUserId
        },
        {
          id: 'perfeccionista',
          nome: 'Perfeccionista',
          desc: '100% de acertos em um embate',
          icone: 'üíØ',
          condicao: () => minhaParticipacao.erros === 0 && minhaParticipacao.acertos >= 10
        },
        {
          id: 'speed_demon',
          nome: 'Velocista',
          desc: 'Tempo m√©dio de resposta menor que 3s',
          icone: '‚ö°',
          condicao: () => (minhaParticipacao.tempoMedioResposta || 10) < 3
        },
        {
          id: 'streak_master',
          nome: 'Mestre do Streak',
          desc: 'Alcance streak de 15 acertos',
          icone: 'üî•',
          condicao: () => (minhaParticipacao.streakMaximo || 0) >= 15
        },
        {
          id: 'sobrevivente',
          nome: 'Sobrevivente',
          desc: 'Ven√ßa no modo Sobreviv√™ncia',
          icone: '‚ù§Ô∏è',
          condicao: () => embateData.modo === 'sobrevivencia' && 
                         embateData.resultado?.vencedorId === currentUserId
        },
        {
          id: 'hardcore_vencedor',
          nome: 'Hardcore Vencedor',
          desc: 'Ven√ßa no modo Hardcore',
          icone: 'üíÄ',
          condicao: () => embateData.modo === 'hardcore' && 
                         embateData.resultado?.vencedorId === currentUserId
        }
      ];
      
      // Verificar cada conquista
      for (const c of conquistas) {
        if (!conquistasAtuais.includes(c.id) && c.condicao()) {
          conquistasDesbloqueadas.push(c);
        }
      }
      
      // Exibir conquistas desbloqueadas
      if (conquistasDesbloqueadas.length > 0) {
        const card = document.getElementById('achievementsCard');
        const list = document.getElementById('achievementList');
        
        card.style.display = 'block';
        
        list.innerHTML = conquistasDesbloqueadas.map(c => `
          <div class="achievement-item">
            <div class="achievement-icon">${c.icone}</div>
            <div class="achievement-info">
              <div class="achievement-name">${c.nome}</div>
              <div class="achievement-desc">${c.desc}</div>
            </div>
            <span class="achievement-new">NOVO!</span>
          </div>
        `).join('');
        
        // Salvar conquistas no perfil
        const novasConquistas = conquistasDesbloqueadas.map(c => c.id);
        await db.collection('usuarios').doc(currentUserId).update({
          'pvp.conquistasPvp': firebase.firestore.FieldValue.arrayUnion(...novasConquistas)
        });
      }
    }

    // ===================================
    // üéä CONFETTI
    // ===================================
    function dispararConfetti() {
      const container = document.getElementById('confettiContainer');
      const cores = ['#ffb547', '#ff8c42', '#10b981', '#60a5fa', '#8b5cf6', '#ec4899'];
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = cores[Math.floor(Math.random() * cores.length)];
          confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          container.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 4000);
        }, i * 50);
      }
    }

    // ===================================
    // üì§ COMPARTILHAR RESULTADO
    // ===================================
    function compartilharResultado() {
      const minhaPosicao = participacoes.findIndex(p => p.odId === currentUserId) + 1;
      const venceu = embateData.resultado?.vencedorId === currentUserId;
      
      let texto = `‚öîÔ∏è RESULTADO YELLUP ‚öîÔ∏è\n\n`;
      texto += `üéØ Tema: ${embateData.tema?.nome}\n`;
      texto += `üéÆ Modo: ${embateData.modo}\n\n`;
      
      if (venceu) {
        texto += `üèÜ EU VENCI! üèÜ\n`;
        texto += `üíé Ganhei ${embateData.prizePool} cr√©ditos!\n`;
      } else {
        texto += `üìä Fiquei em ${minhaPosicao}¬∫ lugar\n`;
      }
      
      texto += `\n‚ú® ${minhaParticipacao?.pontos || 0} pontos\n`;
      texto += `‚úÖ ${minhaParticipacao?.acertos || 0} acertos\n`;
      texto += `üî• Streak m√°ximo: ${minhaParticipacao?.streakMaximo || 0}\n\n`;
      texto += `Jogue voc√™ tamb√©m! üëâ yellup.com`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Resultado Yellup',
          text: texto
        });
      } else {
        navigator.clipboard.writeText(texto);
        showToast('üìã Texto copiado!');
      }
    }

    // ===================================
    // üçû TOAST
    // ===================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    console.log("‚úÖ Resultado Embate v1.0 carregado");
  </script>

</body>
</html>
