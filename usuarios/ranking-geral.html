<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rankings - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: #0a0f16;
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 90px;
    }

    /* â•â•â• HEADER â•â•â• */
    .header {
      background: rgba(10, 15, 22, 0.95);
      backdrop-filter: blur(20px);
      padding: 14px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .header-content {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-back {
      padding: 8px 16px;
      background: rgba(255,255,255,0.07);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85em;
      font-weight: 500;
      transition: background 0.2s;
    }
    .btn-back:hover { background: rgba(255,255,255,0.12); }
    .logo {
      font-size: 1.3em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* â•â•â• CONTAINER â•â•â• */
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* â•â•â• MEU CARD â•â•â• */
    .my-card {
      background: linear-gradient(135deg, rgba(255,181,71,0.12), rgba(255,140,66,0.06));
      border: 1.5px solid rgba(255,181,71,0.35);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 22px;
      display: none;
    }
    .my-card-top {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
    }
    .my-rank-circle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .my-rank-num {
      font-size: 1.4em;
      font-weight: 900;
      color: #0a0f16;
      line-height: 1;
    }
    .my-rank-suffix {
      font-size: 0.55em;
      font-weight: 700;
      color: #0a0f16;
    }
    .my-info { flex: 1; min-width: 0; }
    .my-name {
      font-weight: 700;
      font-size: 1.05em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .my-subtitle {
      font-size: 0.8em;
      color: #a9b5c6;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .my-level-badge {
      font-size: 0.75em;
      padding: 2px 8px;
      border-radius: 8px;
      font-weight: 600;
    }
    .my-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding-top: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .my-stat { text-align: center; }
    .my-stat-val {
      font-size: 1.15em;
      font-weight: 800;
      color: #ffb547;
      line-height: 1.2;
    }
    .my-stat-lbl {
      font-size: 0.65em;
      color: #7a8a9e;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    /* â•â•â• CATEGORY TABS (main) â•â•â• */
    .cat-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 4px;
    }
    .cat-tabs::-webkit-scrollbar { display: none; }
    .cat-tab {
      padding: 10px 16px;
      background: rgba(255,255,255,0.04);
      border: 1.5px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      color: #7a8a9e;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.82em;
      white-space: nowrap;
      transition: all 0.25s;
    }
    .cat-tab:hover { border-color: rgba(255,181,71,0.4); color: #ffb547; }
    .cat-tab.active {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border-color: transparent;
      color: #0a0f16;
    }

    /* â•â•â• PERIOD PILLS â•â•â• */
    .period-pills {
      display: flex;
      gap: 6px;
      margin-bottom: 18px;
      justify-content: center;
    }
    .period-pill {
      padding: 7px 16px;
      background: rgba(255,255,255,0.05);
      border: 1.5px solid rgba(255,255,255,0.08);
      border-radius: 50px;
      color: #7a8a9e;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.78em;
      transition: all 0.25s;
    }
    .period-pill:hover { border-color: rgba(255,181,71,0.4); color: #ffb547; }
    .period-pill.active {
      background: rgba(255,181,71,0.15);
      border-color: #ffb547;
      color: #ffb547;
    }

    /* â•â•â• SUBTITLE EXPLAINER â•â•â• */
    .rank-explainer {
      text-align: center;
      font-size: 0.82em;
      color: #5e6e82;
      margin-bottom: 18px;
      padding: 0 10px;
    }
    .rank-explainer strong { color: #a9b5c6; }

    /* â•â•â• PÃ“DIO â•â•â• */
    .podium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 8px;
      margin-bottom: 24px;
      padding: 10px 0 0;
    }
    .pod-item { text-align: center; flex: 1; max-width: 120px; }
    .pod-item:hover .pod-avatar { transform: translateY(-4px); }
    .pod-avatar {
      width: 52px; height: 52px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.1em;
      margin: 0 auto 6px;
      border: 3px solid;
      transition: transform 0.2s;
      overflow: hidden;
    }
    .pod-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pod-1 .pod-avatar {
      width: 66px; height: 66px;
      font-size: 1.3em;
      border-color: #FFD700;
      box-shadow: 0 0 24px rgba(255,215,0,0.35);
    }
    .pod-2 .pod-avatar { border-color: #C0C0C0; box-shadow: 0 0 12px rgba(192,192,192,0.2); }
    .pod-3 .pod-avatar { border-color: #CD7F32; box-shadow: 0 0 12px rgba(205,127,50,0.2); }
    .pod-name {
      font-weight: 600;
      font-size: 0.8em;
      margin-bottom: 2px;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-left: auto;
      margin-right: auto;
    }
    .pod-val {
      font-weight: 700;
      font-size: 0.85em;
      color: #ffb547;
    }
    .pod-base {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.2em;
      border-radius: 10px 10px 0 0;
      margin-top: 6px;
    }
    .pod-1 .pod-base { height: 80px; background: linear-gradient(180deg, #FFD700, #e6a800); color: #000; }
    .pod-2 .pod-base { height: 58px; background: linear-gradient(180deg, #C0C0C0, #a0a0a0); color: #000; }
    .pod-3 .pod-base { height: 40px; background: linear-gradient(180deg, #CD7F32, #a0612a); color: #fff; }

    /* â•â•â• RANKING LIST â•â•â• */
    .rank-card {
      background: rgba(18,25,35,0.9);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      overflow: hidden;
    }
    .rank-card-header {
      padding: 14px 18px;
      background: rgba(0,0,0,0.25);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .rank-card-title {
      font-weight: 700;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .rank-card-sub {
      font-size: 0.78em;
      color: #5e6e82;
    }
    .rank-list { list-style: none; }

    /* â•â•â• RANKING ITEM â•â•â• */
    .r-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      transition: background 0.2s;
    }
    .r-item:last-child { border-bottom: none; }
    .r-item:hover { background: rgba(255,255,255,0.02); }
    .r-item.me { background: rgba(255,181,71,0.08); }
    .r-item.top1 { background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }
    .r-item.top2 { background: linear-gradient(90deg, rgba(192,192,192,0.07), transparent); }
    .r-item.top3 { background: linear-gradient(90deg, rgba(205,127,50,0.07), transparent); }

    .r-pos {
      width: 34px; height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.85em;
      background: rgba(255,255,255,0.06);
      color: #7a8a9e;
      flex-shrink: 0;
    }
    .r-pos.gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
    .r-pos.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #000; }
    .r-pos.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }

    .r-avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.95em;
      flex-shrink: 0;
      overflow: hidden;
    }
    .r-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .r-info { flex: 1; min-width: 0; }
    .r-name {
      font-weight: 600;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .r-meta {
      font-size: 0.72em;
      color: #5e6e82;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .r-meta-tag {
      padding: 1px 6px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      font-size: 0.92em;
    }
    .r-value { text-align: right; min-width: 65px; flex-shrink: 0; }
    .r-val-num {
      font-weight: 800;
      font-size: 1em;
      color: #ffb547;
    }
    .r-val-lbl {
      font-size: 0.68em;
      color: #5e6e82;
    }

    /* â•â•â• TEAM ITEM â•â•â• */
    .t-badge {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      flex-shrink: 0;
    }
    .t-name { font-weight: 700; font-size: 0.95em; margin-bottom: 2px; }
    .t-stats {
      font-size: 0.75em;
      color: #5e6e82;
      display: flex;
      gap: 12px;
    }

    /* â•â•â• EMPTY / LOADING â•â•â• */
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: #5e6e82;
    }
    .empty-icon { font-size: 3em; margin-bottom: 12px; }
    .loading {
      text-align: center;
      padding: 40px;
      color: #5e6e82;
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(255,181,71,0.2);
      border-top-color: #ffb547;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â•â•â• LEVEL BADGES â•â•â• */
    .lv-bronze { background: rgba(205,127,50,0.2); color: #CD7F32; }
    .lv-prata { background: rgba(192,192,192,0.2); color: #C0C0C0; }
    .lv-ouro { background: rgba(255,215,0,0.2); color: #FFD700; }
    .lv-diamante { background: rgba(185,242,255,0.2); color: #B9F2FF; }
    .lv-mestre { background: rgba(155,89,182,0.2); color: #BB86FC; }

    /* â•â•â• BOTTOM NAV â•â•â• */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(10,15,22,0.98);
      backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-top: 1px solid rgba(255,255,255,0.06);
      z-index: 99;
    }
    .nav-content {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      color: #5e6e82;
      text-decoration: none;
      font-size: 0.7em;
      font-weight: 500;
      transition: color 0.2s;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }

    /* â•â•â• TOAST â•â•â• */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 12px 28px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9em;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* â•â•â• RESPONSIVE â•â•â• */
    @media (max-width: 480px) {
      .my-stats-row { grid-template-columns: repeat(2, 1fr); }
      .pod-1 .pod-avatar { width: 58px; height: 58px; }
      .pod-avatar { width: 46px; height: 46px; }
      .r-item { padding: 11px 14px; gap: 10px; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='painel.html'">â† Voltar</button>
      <div class="logo">ğŸ† Rankings</div>
      <div style="width:70px;"></div>
    </div>
  </header>

  <div class="container">

    <!-- â•â•â• MEU CARD â•â•â• -->
    <div class="my-card" id="myCard">
      <div class="my-card-top">
        <div class="my-rank-circle">
          <span>
            <span class="my-rank-num" id="myRank">-</span><span class="my-rank-suffix">Âº</span>
          </span>
        </div>
        <div class="my-info">
          <div class="my-name" id="myName">Carregando...</div>
          <div class="my-subtitle">
            <span id="myMainVal">0 XP</span>
            <span class="my-level-badge lv-bronze" id="myBadge">ğŸ¥‰ Bronze</span>
          </div>
        </div>
      </div>
      <div class="my-stats-row">
        <div class="my-stat">
          <div class="my-stat-val" id="ms1">0</div>
          <div class="my-stat-lbl" id="ml1">XP</div>
        </div>
        <div class="my-stat">
          <div class="my-stat-val" id="ms2">0</div>
          <div class="my-stat-lbl" id="ml2">CrÃ©ditos</div>
        </div>
        <div class="my-stat">
          <div class="my-stat-val" id="ms3">0</div>
          <div class="my-stat-lbl" id="ml3">Partidas</div>
        </div>
        <div class="my-stat">
          <div class="my-stat-val" id="ms4">0</div>
          <div class="my-stat-lbl" id="ml4">VitÃ³rias</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• TABS CATEGORIAS â•â•â• -->
    <div class="cat-tabs" id="catTabs">
      <button class="cat-tab active" data-cat="xp" onclick="setCat('xp')">â­ XP</button>
      <button class="cat-tab" data-cat="pvp" onclick="setCat('pvp')">âš”ï¸ PVP</button>
      <button class="cat-tab" data-cat="creditos" onclick="setCat('creditos')">ğŸ’ CrÃ©ditos</button>
      <button class="cat-tab" data-cat="times" onclick="setCat('times')">âš½ Times</button>
      <button class="cat-tab" data-cat="selecoes" onclick="setCat('selecoes')">ğŸ³ï¸ SeleÃ§Ãµes</button>
    </div>

    <!-- â•â•â• FILTROS DE PERÃODO â•â•â• -->
    <div class="period-pills" id="periodPills">
      <button class="period-pill" data-per="semana" onclick="setPeriod('semana')">ğŸ“… Semana</button>
      <button class="period-pill" data-per="mes" onclick="setPeriod('mes')">ğŸ“† MÃªs</button>
      <button class="period-pill" data-per="ano" onclick="setPeriod('ano')">ğŸ“Š Ano</button>
      <button class="period-pill active" data-per="geral" onclick="setPeriod('geral')">ğŸŒ Geral</button>
    </div>

    <!-- â•â•â• FILTROS DE TIMES â•â•â• -->
    <div class="period-pills" id="teamPills" style="display:none;">
      <button class="period-pill active" data-tf="torcedores" onclick="setTeamFilter('torcedores')">ğŸ‘¥ Torcedores</button>
      <button class="period-pill" data-tf="torcidas" onclick="setTeamFilter('torcidas')">ğŸ“£ Torcidas</button>
      <button class="period-pill" data-tf="xpTotal" onclick="setTeamFilter('xpTotal')">â­ XP Total</button>
      <button class="period-pill" data-tf="ativos" onclick="setTeamFilter('ativos')">ğŸ® Ativos</button>
    </div>
    <!-- PerÃ­odos para Times -->
    <div class="period-pills" id="teamPeriodPills" style="display:none;">
      <button class="period-pill" data-tp="semana" onclick="setTeamPeriod('semana')">ğŸ“… Semana</button>
      <button class="period-pill" data-tp="mes" onclick="setTeamPeriod('mes')">ğŸ“† MÃªs</button>
      <button class="period-pill" data-tp="ano" onclick="setTeamPeriod('ano')">ğŸ“Š Ano</button>
      <button class="period-pill active" data-tp="geral" onclick="setTeamPeriod('geral')">ğŸŒ Geral</button>
    </div>

    <!-- â•â•â• FILTROS DE SELEÃ‡Ã•ES â•â•â• -->
    <div class="period-pills" id="selPills" style="display:none;">
      <button class="period-pill active" data-sf="torcedores" onclick="setSelFilter('torcedores')">ğŸ‘¥ Torcedores</button>
      <button class="period-pill" data-sf="torcidas" onclick="setSelFilter('torcidas')">ğŸ“£ Torcidas</button>
      <button class="period-pill" data-sf="xpTotal" onclick="setSelFilter('xpTotal')">â­ XP Total</button>
    </div>
    <!-- PerÃ­odos para SeleÃ§Ãµes -->
    <div class="period-pills" id="selPeriodPills" style="display:none;">
      <button class="period-pill" data-sp="semana" onclick="setSelPeriod('semana')">ğŸ“… Semana</button>
      <button class="period-pill" data-sp="mes" onclick="setSelPeriod('mes')">ğŸ“† MÃªs</button>
      <button class="period-pill" data-sp="ano" onclick="setSelPeriod('ano')">ğŸ“Š Ano</button>
      <button class="period-pill active" data-sp="geral" onclick="setSelPeriod('geral')">ğŸŒ Geral</button>
    </div>

    <!-- â•â•â• EXPLICAÃ‡ÃƒO â•â•â• -->
    <div class="rank-explainer" id="explainer">
      <strong>â­ XP Geral</strong> â€” Quem mais evoluiu desde o inÃ­cio
    </div>

    <!-- â•â•â• PÃ“DIO â•â•â• -->
    <div class="podium" id="podium" style="display:none;">
      <div class="pod-item pod-2" id="pod2">
        <div class="pod-avatar" style="background:#C0C0C0; color:#000;">2</div>
        <div class="pod-name">-</div>
        <div class="pod-val">0</div>
        <div class="pod-base">ğŸ¥ˆ</div>
      </div>
      <div class="pod-item pod-1" id="pod1">
        <div class="pod-avatar" style="background:#FFD700; color:#000;">1</div>
        <div class="pod-name">-</div>
        <div class="pod-val">0</div>
        <div class="pod-base">ğŸ¥‡</div>
      </div>
      <div class="pod-item pod-3" id="pod3">
        <div class="pod-avatar" style="background:#CD7F32; color:#fff;">3</div>
        <div class="pod-name">-</div>
        <div class="pod-val">0</div>
        <div class="pod-base">ğŸ¥‰</div>
      </div>
    </div>

    <!-- â•â•â• RANKING LIST â•â•â• -->
    <div class="rank-card">
      <div class="rank-card-header">
        <div class="rank-card-title">
          <span>ğŸ“Š</span>
          <span id="listTitle">Top 100 â€” XP Geral</span>
        </div>
        <div class="rank-card-sub" id="listSub">Todos os tempos</div>
      </div>
      <ul class="rank-list" id="rankList">
        <div class="loading"><div class="spinner"></div><p>Carregando...</p></div>
      </ul>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>InÃ­cio</span></a>
      <a href="ranking-geral.html" class="nav-item active"><span class="nav-icon">ğŸ†</span><span>Ranking</span></a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">ğŸ”—</span><span>Indicar</span></a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span><span>Perfil</span></a>
    </div>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”¥ FIREBASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    firebase.initializeApp({
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    });
    const db = firebase.firestore();
    const auth = firebase.auth();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“¦ STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let uid = null;
    let me = null;
    let cat = 'xp';         // xp | pvp | creditos | times | selecoes
    let period = 'geral';   // semana | mes | ano | geral
    let teamFilter = 'torcedores'; // torcedores | torcidas | xpTotal | ativos
    let teamPeriod = 'geral';     // semana | mes | ano | geral
    let selFilter = 'torcedores'; // torcedores | torcidas | xpTotal
    let selPeriod = 'geral';      // semana | mes | ano | geral
    let usersCache = [];
    let teamsCache = {};
    let embatesCache = null; // cache dos embates para torcidas

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ–ï¸ NÃVEIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const LEVELS = [
      { name: 'Bronze', min: 0, cls: 'lv-bronze', e: 'ğŸ¥‰' },
      { name: 'Prata', min: 500, cls: 'lv-prata', e: 'ğŸ¥ˆ' },
      { name: 'Ouro', min: 2000, cls: 'lv-ouro', e: 'ğŸ¥‡' },
      { name: 'Diamante', min: 5000, cls: 'lv-diamante', e: 'ğŸ’' },
      { name: 'Mestre', min: 10000, cls: 'lv-mestre', e: 'ğŸ‘‘' }
    ];

    function getLevel(xp) {
      let lv = LEVELS[0];
      for (const l of LEVELS) if (xp >= l.min) lv = l;
      return lv;
    }

    function fmt(n) {
      if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if (n >= 10000) return (n/1000).toFixed(1) + 'K';
      if (n >= 1000) return (n/1000).toFixed(1) + 'K';
      return n.toString();
    }

    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'index.html';
      uid = user.uid;
      try {
        const doc = await db.collection('usuarios').doc(uid).get();
        if (doc.exists) me = doc.data();
        await loadTeams();
        await loadUsers();
        render();
      } catch(e) {
        console.error(e);
        toast('âŒ Erro ao carregar');
      }
    });

    async function loadTeams() {
      const snap = await db.collection('times').orderBy('nome').get();
      snap.forEach(d => { teamsCache[d.id] = d.data(); });
    }

    async function loadUsers() {
      const snap = await db.collection('usuarios').get();
      usersCache = [];
      snap.forEach(d => usersCache.push({ id: d.id, ...d.data() }));
      console.log(`âœ… ${usersCache.length} usuÃ¡rios em cache`);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”„ NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setCat(c) {
      cat = c;
      document.querySelectorAll('.cat-tab').forEach(t => t.classList.toggle('active', t.dataset.cat === c));
      
      const showPeriod = (c === 'xp' || c === 'pvp');
      document.getElementById('periodPills').style.display = showPeriod ? 'flex' : 'none';
      document.getElementById('teamPills').style.display = c === 'times' ? 'flex' : 'none';
      document.getElementById('teamPeriodPills').style.display = c === 'times' ? 'flex' : 'none';
      document.getElementById('selPills').style.display = c === 'selecoes' ? 'flex' : 'none';
      document.getElementById('selPeriodPills').style.display = c === 'selecoes' ? 'flex' : 'none';
      
      render();
    }

    function setPeriod(p) {
      period = p;
      document.querySelectorAll('#periodPills .period-pill').forEach(b => b.classList.toggle('active', b.dataset.per === p));
      render();
    }

    function setTeamFilter(f) {
      teamFilter = f;
      document.querySelectorAll('#teamPills .period-pill').forEach(b => b.classList.toggle('active', b.dataset.tf === f));
      render();
    }

    function setTeamPeriod(p) {
      teamPeriod = p;
      document.querySelectorAll('#teamPeriodPills .period-pill').forEach(b => b.classList.toggle('active', b.dataset.tp === p));
      render();
    }

    function setSelFilter(f) {
      selFilter = f;
      document.querySelectorAll('#selPills .period-pill').forEach(b => b.classList.toggle('active', b.dataset.sf === f));
      render();
    }

    function setSelPeriod(p) {
      selPeriod = p;
      document.querySelectorAll('#selPeriodPills .period-pill').forEach(b => b.classList.toggle('active', b.dataset.sp === p));
      render();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š MAIN RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function render() {
      if (cat === 'xp') renderXP();
      else if (cat === 'pvp') renderPVP();
      else if (cat === 'creditos') renderCredits();
      else if (cat === 'times') renderTeams();
      else if (cat === 'selecoes') renderSelecoes();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getDateRange(p) {
      const now = new Date();
      if (p === 'semana') {
        const start = new Date(now);
        start.setDate(now.getDate() - now.getDay());
        start.setHours(0,0,0,0);
        return { start, end: now };
      }
      if (p === 'mes') {
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return { start, end: now };
      }
      if (p === 'ano') {
        const start = new Date(now.getFullYear(), 0, 1);
        return { start, end: now };
      }
      return null; // geral = sem filtro
    }

    function getPeriodLabel(p) {
      if (p === 'semana') return 'Esta semana';
      if (p === 'mes') return 'Este mÃªs';
      if (p === 'ano') return 'Este ano';
      return 'Todos os tempos';
    }

    function getAvatar(user) {
      if (user.avatarUrl) return `<img src="${user.avatarUrl}">`;
      return (user.usuarioUnico || '?').charAt(0).toUpperCase();
    }

    function getAvatarBg(user) {
      const lv = getLevel(user.xp || 0);
      const colors = {
        'lv-bronze': 'linear-gradient(135deg,#CD7F32,#8B4513)',
        'lv-prata': 'linear-gradient(135deg,#C0C0C0,#A8A8A8)',
        'lv-ouro': 'linear-gradient(135deg,#FFD700,#FFA500)',
        'lv-diamante': 'linear-gradient(135deg,#B9F2FF,#87CEEB)',
        'lv-mestre': 'linear-gradient(135deg,#BB86FC,#8E44AD)'
      };
      return colors[lv.cls] || 'linear-gradient(135deg,#444,#333)';
    }

    function updateMyCard(rank, mainVal, mainLabel, s1, l1, s2, l2, s3, l3, s4, l4) {
      const card = document.getElementById('myCard');
      if (!me) { card.style.display = 'none'; return; }
      card.style.display = 'block';

      document.getElementById('myRank').textContent = rank || '-';
      document.getElementById('myName').textContent = me.usuarioUnico || 'VocÃª';
      document.getElementById('myMainVal').textContent = mainVal;

      const lv = getLevel(me.xp || 0);
      const badge = document.getElementById('myBadge');
      badge.className = `my-level-badge ${lv.cls}`;
      badge.textContent = `${lv.e} ${lv.name}`;

      document.getElementById('ms1').textContent = s1;
      document.getElementById('ml1').textContent = l1;
      document.getElementById('ms2').textContent = s2;
      document.getElementById('ml2').textContent = l2;
      document.getElementById('ms3').textContent = s3;
      document.getElementById('ml3').textContent = l3;
      document.getElementById('ms4').textContent = s4;
      document.getElementById('ml4').textContent = l4;
    }

    function updatePodium(top3, valFn, suffix) {
      const podium = document.getElementById('podium');
      if (top3.length < 3) { podium.style.display = 'none'; return; }
      podium.style.display = 'flex';

      [1, 2, 3].forEach(i => {
        const u = top3[i-1];
        const el = document.getElementById(`pod${i}`);
        const name = u.usuarioUnico || 'AnÃ´nimo';
        const av = el.querySelector('.pod-avatar');
        av.innerHTML = getAvatar(u);
        if (!u.avatarUrl) av.style.background = getAvatarBg(u);
        else av.style.background = '#333';
        el.querySelector('.pod-name').textContent = name;
        el.querySelector('.pod-val').textContent = `${fmt(valFn(u))} ${suffix}`;
      });
    }

    function renderList(users, valFn, valLabel, metaFn, startIdx) {
      const list = document.getElementById('rankList');
      if (users.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ†</div><p>Nenhum jogador encontrado</p></div>';
        return;
      }

      list.innerHTML = users.map((u, i) => {
        const pos = startIdx + i;
        const name = u.usuarioUnico || 'AnÃ´nimo';
        const lv = getLevel(u.xp || 0);
        const team = teamsCache[u.timeId];
        const isMe = u.id === uid;
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        const rowClass = pos <= 3 ? `top${pos}` : '';

        return `
          <li class="r-item ${rowClass} ${isMe ? 'me' : ''}">
            <div class="r-pos ${posClass}">${pos}</div>
            <div class="r-avatar" style="background:${u.avatarUrl ? '#333' : getAvatarBg(u)}">${getAvatar(u)}</div>
            <div class="r-info">
              <div class="r-name">${name} <span class="my-level-badge ${lv.cls}" style="font-size:0.7em;padding:1px 5px;">${lv.e}</span></div>
              <div class="r-meta">
                ${team ? `<span class="r-meta-tag">âš½ ${team.nome}</span>` : ''}
                ${metaFn(u)}
              </div>
            </div>
            <div class="r-value">
              <div class="r-val-num">${fmt(valFn(u))}</div>
              <div class="r-val-lbl">${valLabel}</div>
            </div>
          </li>
        `;
      }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â­ RANKING XP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderXP() {
      const exp = document.getElementById('explainer');
      const title = document.getElementById('listTitle');
      const sub = document.getElementById('listSub');

      if (period === 'geral') {
        exp.innerHTML = '<strong>â­ XP Geral</strong> â€” Quem mais evoluiu desde o inÃ­cio';
        title.textContent = 'Top 100 â€” XP Geral';
        sub.textContent = 'Todos os tempos';

        let ranked = [...usersCache]
          .sort((a, b) => (b.xp||0) - (a.xp||0))
          .slice(0, 100);

        const myIdx = ranked.findIndex(u => u.id === uid);
        const myRank = myIdx >= 0 ? myIdx + 1 : null;

        updateMyCard(
          myRank || '>100',
          `${fmt(me?.xp||0)} XP`,
          'XP',
          fmt(me?.xp||0), 'XP Total',
          fmt(me?.creditos||0), 'CrÃ©ditos',
          me?.totalPartidas||0, 'Partidas',
          me?.pvp?.vitorias||0, 'VitÃ³rias PVP'
        );

        updatePodium(ranked.slice(0,3), u => u.xp||0, 'XP');

        const listUsers = ranked.length > 3 ? ranked.slice(3) : ranked;
        const startIdx = ranked.length > 3 ? 4 : 1;
        renderList(listUsers, u => u.xp||0, 'XP', u => `<span>${u.totalPartidas||0} jogos</span>`, startIdx);

      } else {
        // Semana ou MÃªs â€” filtrar por dataCadastro de XP
        // Como XP nÃ£o tem timestamp individual, usamos dataCadastro como proxy
        // Ou mostramos os que tiveram atividade recente
        const periodLabel = period === 'semana' ? 'da Semana' : period === 'mes' ? 'do MÃªs' : 'do Ano';
        exp.innerHTML = `<strong>â­ XP ${periodLabel}</strong> â€” Melhores ${period === 'semana' ? 'desta semana' : period === 'mes' ? 'deste mÃªs' : 'deste ano'}`;
        title.textContent = `Top 100 â€” XP ${periodLabel}`;
        sub.textContent = getPeriodLabel(period);

        // Filtrar usuÃ¡rios com atividade recente (ultimoAcesso dentro do perÃ­odo)
        const range = getDateRange(period);
        let ranked = usersCache
          .filter(u => {
            if (!range) return true;
            const ultimo = u.ultimoAcesso?.toDate ? u.ultimoAcesso.toDate() : null;
            return ultimo && ultimo >= range.start;
          })
          .sort((a, b) => (b.xp||0) - (a.xp||0))
          .slice(0, 100);

        const myIdx = ranked.findIndex(u => u.id === uid);
        updateMyCard(
          myIdx >= 0 ? myIdx + 1 : '-',
          `${fmt(me?.xp||0)} XP`,
          'XP',
          fmt(me?.xp||0), 'XP Total',
          fmt(me?.creditos||0), 'CrÃ©ditos',
          me?.totalPartidas||0, 'Partidas',
          me?.pvp?.vitorias||0, 'VitÃ³rias PVP'
        );

        updatePodium(ranked.slice(0,3), u => u.xp||0, 'XP');
        const listUsers = ranked.length > 3 ? ranked.slice(3) : ranked;
        renderList(listUsers, u => u.xp||0, 'XP', u => `<span>${u.totalPartidas||0} jogos</span>`, ranked.length > 3 ? 4 : 1);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš”ï¸ RANKING PVP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderPVP() {
      const exp = document.getElementById('explainer');
      const title = document.getElementById('listTitle');
      const sub = document.getElementById('listSub');

      if (period === 'geral') {
        exp.innerHTML = '<strong>âš”ï¸ PVP Geral</strong> â€” Quem mais venceu em embates';
        title.textContent = 'Top 100 â€” VitÃ³rias PVP';
        sub.textContent = 'Todos os tempos';

        let ranked = usersCache
          .filter(u => (u.pvp?.vitorias||0) > 0 || (u.pvp?.totalEmbates||0) > 0)
          .sort((a, b) => {
            const diff = (b.pvp?.vitorias||0) - (a.pvp?.vitorias||0);
            if (diff !== 0) return diff;
            return (b.pvp?.creditosGanhos||0) - (a.pvp?.creditosGanhos||0);
          })
          .slice(0, 100);

        const myIdx = ranked.findIndex(u => u.id === uid);
        const myPvp = me?.pvp || {};

        updateMyCard(
          myIdx >= 0 ? myIdx + 1 : '-',
          `${myPvp.vitorias||0} vitÃ³rias`,
          'VitÃ³rias',
          myPvp.vitorias||0, 'VitÃ³rias',
          myPvp.totalEmbates||0, 'Embates',
          fmt(myPvp.creditosGanhos||0), 'Ganhos ğŸ’',
          myPvp.totalEmbates > 0 ? Math.round((myPvp.vitorias||0)/(myPvp.totalEmbates)*100)+'%' : '0%', 'Win Rate'
        );

        updatePodium(ranked.slice(0,3), u => u.pvp?.vitorias||0, 'ğŸ†');
        const listUsers = ranked.length > 3 ? ranked.slice(3) : ranked;
        renderList(
          listUsers,
          u => u.pvp?.vitorias||0, 'vitÃ³rias',
          u => {
            const total = u.pvp?.totalEmbates||0;
            const wins = u.pvp?.vitorias||0;
            const wr = total > 0 ? Math.round(wins/total*100) : 0;
            return `<span>âš”ï¸ ${total} embates</span><span>ğŸ“Š ${wr}% WR</span>`;
          },
          ranked.length > 3 ? 4 : 1
        );

      } else {
        // PVP por perÃ­odo â€” buscar embates recentes
        const periodLabel = period === 'semana' ? 'da Semana' : period === 'mes' ? 'do MÃªs' : 'do Ano';
        exp.innerHTML = `<strong>âš”ï¸ PVP ${periodLabel}</strong> â€” Melhores ${period === 'semana' ? 'desta semana' : period === 'mes' ? 'deste mÃªs' : 'deste ano'} em embates`;
        title.textContent = `Top 100 â€” PVP ${periodLabel}`;
        sub.textContent = getPeriodLabel(period);

        const range = getDateRange(period);
        document.getElementById('rankList').innerHTML = '<div class="loading"><div class="spinner"></div><p>Calculando PVP do perÃ­odo...</p></div>';
        document.getElementById('podium').style.display = 'none';

        loadPVPPeriod(range);
      }
    }

    async function loadPVPPeriod(range) {
      try {
        const snap = await db.collection('embates')
          .where('status', '==', 'finalizado')
          .get();

        const embatesNoPeriodo = snap.docs.filter(d => {
          const data = d.data();
          const dt = data.dataFinalizacao?.toDate ? data.dataFinalizacao.toDate() : null;
          return dt && range && dt >= range.start && dt <= range.end;
        });

        const stats = {}; // userId -> { vitorias, embates, pontos }

        for (const doc of embatesNoPeriodo) {
          const data = doc.data();
          
          // Buscar participaÃ§Ãµes
          const partSnap = await db.collection('embates').doc(doc.id)
            .collection('participacoes').get();
          
          partSnap.forEach(p => {
            const pid = p.id;
            if (!stats[pid]) stats[pid] = { vitorias: 0, embates: 0, pontos: 0 };
            stats[pid].embates++;
            stats[pid].pontos += p.data().pontos || 0;
          });

          if (data.resultado?.vencedorId && stats[data.resultado.vencedorId]) {
            stats[data.resultado.vencedorId].vitorias++;
          }
        }

        let ranked = Object.entries(stats)
          .map(([id, s]) => {
            const user = usersCache.find(u => u.id === id);
            return user ? { ...user, _v: s.vitorias, _e: s.embates, _p: s.pontos } : null;
          })
          .filter(Boolean)
          .sort((a, b) => (b._v - a._v) || (b._p - a._p))
          .slice(0, 100);

        const myIdx = ranked.findIndex(u => u.id === uid);
        const myData = ranked.find(u => u.id === uid);

        updateMyCard(
          myIdx >= 0 ? myIdx + 1 : '-',
          `${myData?._v||0} vitÃ³rias`,
          'VitÃ³rias',
          myData?._v||0, 'VitÃ³rias',
          myData?._e||0, 'Embates',
          fmt(myData?._p||0), 'Pontos',
          myData?._e > 0 ? Math.round((myData?._v||0)/(myData._e)*100)+'%' : '0%', 'Win Rate'
        );

        updatePodium(ranked.slice(0,3), u => u._v||0, 'ğŸ†');
        const list = ranked.length > 3 ? ranked.slice(3) : ranked;
        renderList(
          list,
          u => u._v||0, 'vitÃ³rias',
          u => `<span>âš”ï¸ ${u._e||0} embates</span><span>ğŸ“Š ${u._e > 0 ? Math.round((u._v||0)/u._e*100) : 0}% WR</span>`,
          ranked.length > 3 ? 4 : 1
        );

        if (ranked.length === 0) {
          document.getElementById('rankList').innerHTML = '<div class="empty-state"><div class="empty-icon">âš”ï¸</div><p>Nenhum embate finalizado neste perÃ­odo</p></div>';
        }

      } catch(e) {
        console.error(e);
        document.getElementById('rankList').innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><p>Erro ao carregar</p></div>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’ RANKING CRÃ‰DITOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderCredits() {
      const exp = document.getElementById('explainer');
      const title = document.getElementById('listTitle');
      const sub = document.getElementById('listSub');

      exp.innerHTML = '<strong>ğŸ’ CrÃ©ditos</strong> â€” Quem tem mais crÃ©ditos acumulados';
      title.textContent = 'Top 100 â€” Saldo de CrÃ©ditos';
      sub.textContent = 'Saldo atual';

      let ranked = [...usersCache]
        .sort((a, b) => (b.creditos||0) - (a.creditos||0))
        .filter(u => (u.creditos||0) > 0)
        .slice(0, 100);

      const myIdx = ranked.findIndex(u => u.id === uid);

      updateMyCard(
        myIdx >= 0 ? myIdx + 1 : '>100',
        `${fmt(me?.creditos||0)} ğŸ’`,
        'CrÃ©ditos',
        fmt(me?.creditos||0), 'Saldo',
        fmt(me?.pvp?.creditosGanhos||0), 'Ganhos PVP',
        me?.pvp?.vitorias||0, 'VitÃ³rias',
        fmt(me?.xp||0), 'XP'
      );

      updatePodium(ranked.slice(0,3), u => u.creditos||0, 'ğŸ’');
      const list = ranked.length > 3 ? ranked.slice(3) : ranked;
      renderList(
        list,
        u => u.creditos||0, 'ğŸ’ crÃ©ditos',
        u => `<span>â­ ${fmt(u.xp||0)} XP</span>`,
        ranked.length > 3 ? 4 : 1
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš½ RANKING DE TIMES (com perÃ­odos + torcidas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderTeams() {
      const exp = document.getElementById('explainer');
      const title = document.getElementById('listTitle');
      const sub = document.getElementById('listSub');
      const podium = document.getElementById('podium');
      const myCard = document.getElementById('myCard');

      podium.style.display = 'none';

      const labels = {
        torcedores: { exp: 'Clubes com mais torcedores cadastrados', title: 'Mais Torcedores', val: 'Torcedores', icon: 'ğŸ‘¥' },
        torcidas: { exp: 'Clubes com mais torcidas em jogos (participaÃ§Ãµes)', title: 'Mais Torcidas', val: 'Torcidas', icon: 'ğŸ“£' },
        xpTotal: { exp: 'Clubes com mais XP acumulado pela torcida', title: 'Mais XP Total', val: 'XP Total', icon: 'â­' },
        ativos: { exp: 'Clubes com mais jogadores ativos', title: 'Mais Ativos', val: 'Ativos', icon: 'ğŸ®' }
      };
      const lbl = labels[teamFilter];
      const perLabel = getPeriodLabel(teamPeriod);

      exp.innerHTML = `<strong>âš½ ${lbl.title}</strong> â€” ${lbl.exp}`;
      title.textContent = `Ranking de Times â€” ${lbl.title}`;
      sub.textContent = perLabel;

      // Se Ã© torcidas, precisa carregar embates
      if (teamFilter === 'torcidas') {
        document.getElementById('rankList').innerHTML = '<div class="loading"><div class="spinner"></div><p>Calculando torcidas...</p></div>';
        loadTorcidasTimes();
        return;
      }

      // Filtrar usuÃ¡rios por perÃ­odo
      const range = getDateRange(teamPeriod);
      let filteredUsers = usersCache;
      if (range) {
        filteredUsers = usersCache.filter(u => {
          const ultimo = u.ultimoAcesso?.toDate ? u.ultimoAcesso.toDate() : null;
          return ultimo && ultimo >= range.start;
        });
      }

      // Agregar dados por time
      const data = {};
      filteredUsers.forEach(u => {
        const tid = u.timeId;
        if (!tid || !teamsCache[tid]) return;
        if (!data[tid]) data[tid] = { id: tid, nome: teamsCache[tid].nome||'', torcedores: 0, xp: 0, ativos: 0, creditos: 0 };
        data[tid].torcedores++;
        data[tid].xp += u.xp || 0;
        data[tid].creditos += u.creditos || 0;
        if ((u.xp||0) > 0 || (u.totalPartidas||0) > 0) data[tid].ativos++;
      });

      let ranked = Object.values(data);
      if (teamFilter === 'torcedores') ranked.sort((a,b) => b.torcedores - a.torcedores);
      else if (teamFilter === 'xpTotal') ranked.sort((a,b) => b.xp - a.xp);
      else ranked.sort((a,b) => b.ativos - a.ativos);
      ranked = ranked.slice(0, 50);

      renderTeamList(ranked, teamFilter, lbl);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“£ CARREGAR TORCIDAS (TIMES)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadEmbatesCache() {
      if (embatesCache) return;
      const snap = await db.collection('embates').where('status', '==', 'finalizado').get();
      embatesCache = [];
      snap.forEach(d => embatesCache.push({ id: d.id, ...d.data() }));
      console.log(`âœ… ${embatesCache.length} embates em cache`);
    }

    function filterEmbatesByPeriod(per) {
      const range = getDateRange(per);
      if (!range) return embatesCache;
      return embatesCache.filter(e => {
        const dt = e.dataFinalizacao?.toDate ? e.dataFinalizacao.toDate() : null;
        return dt && dt >= range.start && dt <= range.end;
      });
    }

    async function loadTorcidasTimes() {
      try {
        await loadEmbatesCache();
        const embates = filterEmbatesByPeriod(teamPeriod);

        // Contar participaÃ§Ãµes por time
        const torcidas = {}; // timeId -> { torcidas, torcedores, xp, ativos }

        for (const embate of embates) {
          try {
            const partSnap = await db.collection('embates').doc(embate.id)
              .collection('participacoes').get();
            
            partSnap.forEach(p => {
              const user = usersCache.find(u => u.id === p.id);
              if (user?.timeId && teamsCache[user.timeId]) {
                const tid = user.timeId;
                if (!torcidas[tid]) torcidas[tid] = { id: tid, nome: teamsCache[tid].nome||'', torcidas: 0, torcedores: 0, xp: 0, ativos: 0 };
                torcidas[tid].torcidas++;
              }
            });
          } catch(e) {}
        }

        // Adicionar torcedores e XP base
        usersCache.forEach(u => {
          const tid = u.timeId;
          if (!tid) return;
          if (!torcidas[tid] && teamsCache[tid]) {
            torcidas[tid] = { id: tid, nome: teamsCache[tid].nome||'', torcidas: 0, torcedores: 0, xp: 0, ativos: 0 };
          }
          if (torcidas[tid]) {
            torcidas[tid].torcedores++;
            torcidas[tid].xp += u.xp || 0;
            if ((u.xp||0) > 0) torcidas[tid].ativos++;
          }
        });

        let ranked = Object.values(torcidas)
          .sort((a,b) => b.torcidas - a.torcidas)
          .slice(0, 50);

        const lbl = { title: 'Mais Torcidas', val: 'Torcidas', icon: 'ğŸ“£' };
        renderTeamList(ranked, 'torcidas', lbl);

      } catch(e) {
        console.error(e);
        document.getElementById('rankList').innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><p>Erro ao calcular torcidas</p></div>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¨ RENDER LISTA DE TIMES (compartilhado)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderTeamList(ranked, filter, lbl) {
      const myCard = document.getElementById('myCard');
      const list = document.getElementById('rankList');

      // Meu time
      const myTeam = me?.timeId ? ranked.find(t => t.id === me.timeId) : null;
      const myTeamIdx = myTeam ? ranked.indexOf(myTeam) + 1 : null;

      if (myTeam) {
        myCard.style.display = 'block';
        document.getElementById('myRank').textContent = myTeamIdx;
        document.getElementById('myName').textContent = `âš½ ${myTeam.nome}`;
        document.getElementById('myMainVal').textContent = `Seu time estÃ¡ em ${myTeamIdx}Âº`;
        const badge = document.getElementById('myBadge');
        badge.className = 'my-level-badge lv-ouro';
        badge.textContent = 'âš½ Time';

        document.getElementById('ms1').textContent = myTeam.torcedores || 0;
        document.getElementById('ml1').textContent = 'Torcedores';
        document.getElementById('ms2').textContent = fmt(myTeam.xp || 0);
        document.getElementById('ml2').textContent = 'XP Total';
        document.getElementById('ms3').textContent = myTeam.torcidas !== undefined ? (myTeam.torcidas || 0) : (myTeam.ativos || 0);
        document.getElementById('ml3').textContent = filter === 'torcidas' ? 'ğŸ“£ Torcidas' : 'ğŸ® Ativos';
        document.getElementById('ms4').textContent = fmt(myTeam.creditos || 0);
        document.getElementById('ml4').textContent = 'CrÃ©ditos';
      } else {
        myCard.style.display = 'none';
      }

      if (ranked.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">âš½</div><p>Nenhum time encontrado neste perÃ­odo</p></div>';
        return;
      }

      const valFn = filter === 'torcedores' ? t => t.torcedores
        : filter === 'torcidas' ? t => t.torcidas || 0
        : filter === 'xpTotal' ? t => t.xp
        : t => t.ativos;

      list.innerHTML = ranked.map((t, i) => {
        const pos = i + 1;
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        const rowClass = pos <= 3 ? `top${pos}` : '';
        const isMyTeam = t.id === me?.timeId;

        return `
          <li class="r-item ${rowClass} ${isMyTeam ? 'me' : ''}">
            <div class="r-pos ${posClass}">${pos}</div>
            <div class="t-badge">âš½</div>
            <div class="r-info">
              <div class="r-name" style="font-size:0.95em;">${t.nome}</div>
              <div class="r-meta">
                <span>ğŸ‘¥ ${t.torcedores || 0}</span>
                ${t.torcidas !== undefined ? `<span>ğŸ“£ ${t.torcidas} torcidas</span>` : ''}
                <span>â­ ${fmt(t.xp || 0)} XP</span>
                ${t.ativos !== undefined ? `<span>ğŸ® ${t.ativos}</span>` : ''}
              </div>
            </div>
            <div class="r-value">
              <div class="r-val-num">${fmt(valFn(t))}</div>
              <div class="r-val-lbl">${lbl.val}</div>
            </div>
          </li>
        `;
      }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ³ï¸ RANKING DE SELEÃ‡Ã•ES (PAÃSES)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const FLAGS = {
      'brasil': 'ğŸ‡§ğŸ‡·', 'brazil': 'ğŸ‡§ğŸ‡·', 'bra': 'ğŸ‡§ğŸ‡·',
      'argentina': 'ğŸ‡¦ğŸ‡·', 'arg': 'ğŸ‡¦ğŸ‡·',
      'portugal': 'ğŸ‡µğŸ‡¹', 'por': 'ğŸ‡µğŸ‡¹',
      'espanha': 'ğŸ‡ªğŸ‡¸', 'espana': 'ğŸ‡ªğŸ‡¸', 'esp': 'ğŸ‡ªğŸ‡¸', 'spain': 'ğŸ‡ªğŸ‡¸',
      'alemanha': 'ğŸ‡©ğŸ‡ª', 'germany': 'ğŸ‡©ğŸ‡ª', 'ger': 'ğŸ‡©ğŸ‡ª', 'ale': 'ğŸ‡©ğŸ‡ª',
      'franca': 'ğŸ‡«ğŸ‡·', 'france': 'ğŸ‡«ğŸ‡·', 'fra': 'ğŸ‡«ğŸ‡·',
      'inglaterra': 'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿', 'england': 'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿', 'ing': 'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿',
      'italia': 'ğŸ‡®ğŸ‡¹', 'italy': 'ğŸ‡®ğŸ‡¹', 'ita': 'ğŸ‡®ğŸ‡¹',
      'uruguai': 'ğŸ‡ºğŸ‡¾', 'uruguay': 'ğŸ‡ºğŸ‡¾', 'uru': 'ğŸ‡ºğŸ‡¾',
      'colombia': 'ğŸ‡¨ğŸ‡´', 'col': 'ğŸ‡¨ğŸ‡´',
      'chile': 'ğŸ‡¨ğŸ‡±', 'chi': 'ğŸ‡¨ğŸ‡±',
      'mexico': 'ğŸ‡²ğŸ‡½', 'mex': 'ğŸ‡²ğŸ‡½',
      'paraguai': 'ğŸ‡µğŸ‡¾', 'paraguay': 'ğŸ‡µğŸ‡¾', 'par': 'ğŸ‡µğŸ‡¾',
      'equador': 'ğŸ‡ªğŸ‡¨', 'ecuador': 'ğŸ‡ªğŸ‡¨', 'ecu': 'ğŸ‡ªğŸ‡¨',
      'peru': 'ğŸ‡µğŸ‡ª', 'per': 'ğŸ‡µğŸ‡ª',
      'bolivia': 'ğŸ‡§ğŸ‡´', 'bol': 'ğŸ‡§ğŸ‡´',
      'venezuela': 'ğŸ‡»ğŸ‡ª', 'ven': 'ğŸ‡»ğŸ‡ª',
      'estados unidos': 'ğŸ‡ºğŸ‡¸', 'usa': 'ğŸ‡ºğŸ‡¸', 'eua': 'ğŸ‡ºğŸ‡¸',
      'japao': 'ğŸ‡¯ğŸ‡µ', 'japan': 'ğŸ‡¯ğŸ‡µ', 'jap': 'ğŸ‡¯ğŸ‡µ',
      'coreia do sul': 'ğŸ‡°ğŸ‡·', 'south korea': 'ğŸ‡°ğŸ‡·',
      'holanda': 'ğŸ‡³ğŸ‡±', 'netherlands': 'ğŸ‡³ğŸ‡±', 'hol': 'ğŸ‡³ğŸ‡±',
      'belgica': 'ğŸ‡§ğŸ‡ª', 'belgium': 'ğŸ‡§ğŸ‡ª', 'bel': 'ğŸ‡§ğŸ‡ª',
      'croacia': 'ğŸ‡­ğŸ‡·', 'croatia': 'ğŸ‡­ğŸ‡·', 'cro': 'ğŸ‡­ğŸ‡·',
      'marrocos': 'ğŸ‡²ğŸ‡¦', 'morocco': 'ğŸ‡²ğŸ‡¦', 'mar': 'ğŸ‡²ğŸ‡¦',
      'senegal': 'ğŸ‡¸ğŸ‡³', 'sen': 'ğŸ‡¸ğŸ‡³',
      'nigeria': 'ğŸ‡³ğŸ‡¬', 'nig': 'ğŸ‡³ğŸ‡¬',
      'camaroes': 'ğŸ‡¨ğŸ‡²', 'cameroon': 'ğŸ‡¨ğŸ‡²',
      'gana': 'ğŸ‡¬ğŸ‡­', 'ghana': 'ğŸ‡¬ğŸ‡­',
      'australia': 'ğŸ‡¦ğŸ‡º', 'aus': 'ğŸ‡¦ğŸ‡º',
      'suica': 'ğŸ‡¨ğŸ‡­', 'switzerland': 'ğŸ‡¨ğŸ‡­', 'sui': 'ğŸ‡¨ğŸ‡­'
    };

    function normPais(pais) {
      if (!pais) return null;
      return pais.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function getFlag(pais) {
      if (!pais) return 'ğŸ³ï¸';
      const key = normPais(pais);
      return FLAGS[key] || 'ğŸ³ï¸';
    }

    function renderSelecoes() {
      const exp = document.getElementById('explainer');
      const title = document.getElementById('listTitle');
      const sub = document.getElementById('listSub');
      const podium = document.getElementById('podium');

      podium.style.display = 'none';

      const labels = {
        torcedores: { exp: 'SeleÃ§Ãµes com mais torcedores cadastrados', title: 'Mais Torcedores', val: 'Torcedores' },
        torcidas: { exp: 'SeleÃ§Ãµes com mais torcidas em jogos', title: 'Mais Torcidas', val: 'Torcidas' },
        xpTotal: { exp: 'SeleÃ§Ãµes com mais XP acumulado', title: 'Mais XP', val: 'XP Total' }
      };
      const lbl = labels[selFilter];
      const perLabel = getPeriodLabel(selPeriod);

      exp.innerHTML = `<strong>ğŸ³ï¸ ${lbl.title}</strong> â€” ${lbl.exp}`;
      title.textContent = `Ranking de SeleÃ§Ãµes â€” ${lbl.title}`;
      sub.textContent = perLabel;

      // Se Ã© torcidas, carregar embates
      if (selFilter === 'torcidas') {
        document.getElementById('rankList').innerHTML = '<div class="loading"><div class="spinner"></div><p>Calculando torcidas...</p></div>';
        loadTorcidasSelecoes(lbl);
        return;
      }

      // Filtrar usuÃ¡rios por perÃ­odo
      const range = getDateRange(selPeriod);
      let filteredUsers = usersCache;
      if (range) {
        filteredUsers = usersCache.filter(u => {
          const ultimo = u.ultimoAcesso?.toDate ? u.ultimoAcesso.toDate() : null;
          return ultimo && ultimo >= range.start;
        });
      }

      // Agregar por paÃ­s
      const data = {};
      filteredUsers.forEach(u => {
        const pais = u.pais || u.nacionalidade;
        if (!pais) return;
        const key = normPais(pais);
        if (!key) return;
        if (!data[key]) data[key] = { key, nome: pais, flag: getFlag(pais), torcedores: 0, xp: 0, torcidas: 0 };
        data[key].torcedores++;
        data[key].xp += u.xp || 0;
      });

      let ranked = Object.values(data);
      if (selFilter === 'torcedores') ranked.sort((a,b) => b.torcedores - a.torcedores);
      else ranked.sort((a,b) => b.xp - a.xp);
      ranked = ranked.slice(0, 50);

      renderSelList(ranked, selFilter, lbl);
    }

    async function loadTorcidasSelecoes(lbl) {
      try {
        await loadEmbatesCache();
        const embates = filterEmbatesByPeriod(selPeriod);

        const torcidas = {}; // paisKey -> { torcidas, torcedores, xp }

        for (const embate of embates) {
          try {
            const partSnap = await db.collection('embates').doc(embate.id)
              .collection('participacoes').get();
            
            partSnap.forEach(p => {
              const user = usersCache.find(u => u.id === p.id);
              const pais = user?.pais || user?.nacionalidade;
              if (!pais) return;
              const key = normPais(pais);
              if (!key) return;
              if (!torcidas[key]) torcidas[key] = { key, nome: pais, flag: getFlag(pais), torcidas: 0, torcedores: 0, xp: 0 };
              torcidas[key].torcidas++;
            });
          } catch(e) {}
        }

        // Adicionar torcedores base
        usersCache.forEach(u => {
          const pais = u.pais || u.nacionalidade;
          if (!pais) return;
          const key = normPais(pais);
          if (!key) return;
          if (!torcidas[key]) torcidas[key] = { key, nome: pais, flag: getFlag(pais), torcidas: 0, torcedores: 0, xp: 0 };
          torcidas[key].torcedores++;
          torcidas[key].xp += u.xp || 0;
        });

        let ranked = Object.values(torcidas)
          .sort((a,b) => b.torcidas - a.torcidas)
          .slice(0, 50);

        renderSelList(ranked, 'torcidas', lbl);

      } catch(e) {
        console.error(e);
        document.getElementById('rankList').innerHTML = '<div class="empty-state"><div class="empty-icon">âš ï¸</div><p>Erro ao calcular torcidas</p></div>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¨ RENDER LISTA DE SELEÃ‡Ã•ES (compartilhado)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderSelList(ranked, filter, lbl) {
      const myCard = document.getElementById('myCard');
      const list = document.getElementById('rankList');

      // Meu paÃ­s
      const myPais = me?.pais || me?.nacionalidade;
      const myKey = normPais(myPais);
      const mySel = myKey ? ranked.find(s => s.key === myKey) : null;
      const myIdx = mySel ? ranked.indexOf(mySel) + 1 : null;

      if (mySel) {
        myCard.style.display = 'block';
        document.getElementById('myRank').textContent = myIdx;
        document.getElementById('myName').textContent = `${mySel.flag} ${mySel.nome}`;
        document.getElementById('myMainVal').textContent = `Sua seleÃ§Ã£o estÃ¡ em ${myIdx}Âº`;
        const badge = document.getElementById('myBadge');
        badge.className = 'my-level-badge lv-ouro';
        badge.textContent = `${mySel.flag} SeleÃ§Ã£o`;

        document.getElementById('ms1').textContent = mySel.torcedores || 0;
        document.getElementById('ml1').textContent = 'Torcedores';
        document.getElementById('ms2').textContent = fmt(mySel.xp || 0);
        document.getElementById('ml2').textContent = 'XP Total';
        document.getElementById('ms3').textContent = mySel.torcidas || 0;
        document.getElementById('ml3').textContent = 'ğŸ“£ Torcidas';
        document.getElementById('ms4').textContent = '-';
        document.getElementById('ml4').textContent = '-';
      } else {
        myCard.style.display = 'none';
      }

      if (ranked.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ³ï¸</div><p>Nenhuma seleÃ§Ã£o encontrada neste perÃ­odo</p></div>';
        return;
      }

      const valFn = filter === 'torcedores' ? s => s.torcedores
        : filter === 'torcidas' ? s => s.torcidas || 0
        : s => s.xp;

      list.innerHTML = ranked.map((s, i) => {
        const pos = i + 1;
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        const rowClass = pos <= 3 ? `top${pos}` : '';
        const isMine = s.key === myKey;

        return `
          <li class="r-item ${rowClass} ${isMine ? 'me' : ''}">
            <div class="r-pos ${posClass}">${pos}</div>
            <div class="t-badge" style="font-size:1.6em;">${s.flag}</div>
            <div class="r-info">
              <div class="r-name" style="font-size:0.95em;">${s.nome}</div>
              <div class="r-meta">
                <span>ğŸ‘¥ ${s.torcedores || 0} torcedores</span>
                ${s.torcidas ? `<span>ğŸ“£ ${s.torcidas} torcidas</span>` : ''}
                <span>â­ ${fmt(s.xp || 0)} XP</span>
              </div>
            </div>
            <div class="r-value">
              <div class="r-val-num">${fmt(valFn(s))}</div>
              <div class="r-val-lbl">${lbl.val}</div>
            </div>
          </li>
        `;
      }).join('');
    }

    console.log("âœ… Rankings v5.0 â€” Times + SeleÃ§Ãµes + Torcidas + PerÃ­odos");
  </script>

</body>
</html>
