<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rankings - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%); color: #e7eef7; min-height: 100vh; padding-bottom: 100px; }
    .header { background: rgba(14, 20, 27, 0.95); backdrop-filter: blur(20px); padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .header-content { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .btn-back { padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s ease; }
    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }
    .logo { font-size: 1.5em; font-weight: 800; background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .page-title { text-align: center; margin-bottom: 25px; }
    .page-title h1 { font-size: 1.8em; margin-bottom: 5px; }
    .page-title p { color: #a9b5c6; }
    .category-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
    .category-tab { padding: 12px 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #a9b5c6; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 0.9em; white-space: nowrap; transition: all 0.3s ease; }
    .category-tab:hover { border-color: rgba(255, 181, 71, 0.5); color: #ffb547; }
    .category-tab.active { background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%); border-color: transparent; color: #0e141b; }
    .filters { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    .filter-btn { padding: 10px 18px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 50px; color: #a9b5c6; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 0.85em; transition: all 0.3s ease; }
    .filter-btn:hover { border-color: rgba(255, 181, 71, 0.5); color: #ffb547; }
    .filter-btn.active { background: rgba(255, 181, 71, 0.2); border-color: #ffb547; color: #ffb547; }
    .team-filter { width: 100%; margin-bottom: 20px; display: none; }
    .team-filter.active { display: block; }
    .team-select { width: 100%; padding: 14px 16px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #fff; font-size: 1em; font-family: 'Poppins', sans-serif; cursor: pointer; }
    .team-select:focus { outline: none; border-color: #ffb547; }
    .my-position-card { background: linear-gradient(135deg, rgba(255, 181, 71, 0.2) 0%, rgba(255, 140, 66, 0.1) 100%); border: 2px solid rgba(255, 181, 71, 0.5); border-radius: 16px; padding: 20px; margin-bottom: 25px; display: none; }
    .my-position-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .my-position-rank { font-size: 2.2em; font-weight: 800; color: #ffb547; min-width: 70px; text-align: center; }
    .my-position-info { flex: 1; }
    .my-position-name { font-weight: 700; font-size: 1.1em; margin-bottom: 3px; }
    .my-position-stats { display: flex; gap: 15px; color: #a9b5c6; font-size: 0.85em; flex-wrap: wrap; }
    .my-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .my-stat-item { text-align: center; }
    .my-stat-value { font-size: 1.3em; font-weight: 800; color: #ffb547; }
    .my-stat-label { font-size: 0.7em; color: #a9b5c6; text-transform: uppercase; }
    .ranking-card { background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; overflow: hidden; backdrop-filter: blur(10px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
    .ranking-header { padding: 15px 20px; background: rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .ranking-title { font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .ranking-period { font-size: 0.85em; color: #a9b5c6; }
    .ranking-list { list-style: none; }
    .ranking-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
    .ranking-item:last-child { border-bottom: none; }
    .ranking-item:hover { background: rgba(255, 255, 255, 0.03); }
    .ranking-item.highlight { background: rgba(255, 181, 71, 0.1); }
    .ranking-item.top-1 { background: linear-gradient(90deg, rgba(255, 215, 0, 0.15) 0%, transparent 100%); }
    .ranking-item.top-2 { background: linear-gradient(90deg, rgba(192, 192, 192, 0.1) 0%, transparent 100%); }
    .ranking-item.top-3 { background: linear-gradient(90deg, rgba(205, 127, 50, 0.1) 0%, transparent 100%); }
    .rank-position { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1em; background: rgba(255, 255, 255, 0.1); flex-shrink: 0; }
    .rank-position.gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
    .rank-position.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #000; }
    .rank-position.bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
    .rank-movement { font-size: 0.75em; font-weight: 700; min-width: 30px; text-align: center; }
    .rank-movement.up { color: #10b981; }
    .rank-movement.down { color: #ef4444; }
    .rank-movement.same { color: #6b7280; }
    .rank-movement.new { color: #3b82f6; }
    .rank-avatar { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1em; flex-shrink: 0; }
    .rank-info { flex: 1; min-width: 0; }
    .rank-name { font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; font-size: 0.95em; }
    .rank-team { font-size: 0.75em; color: #a9b5c6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .rank-details { font-size: 0.7em; color: #6b7280; display: flex; gap: 8px; }
    .rank-level { font-size: 0.7em; padding: 2px 6px; border-radius: 8px; font-weight: 600; }
    .level-bronze { background: rgba(205, 127, 50, 0.2); color: #CD7F32; }
    .level-prata { background: rgba(192, 192, 192, 0.2); color: #C0C0C0; }
    .level-ouro { background: rgba(255, 215, 0, 0.2); color: #FFD700; }
    .level-diamante { background: rgba(185, 242, 255, 0.2); color: #B9F2FF; }
    .level-mestre { background: rgba(138, 43, 226, 0.2); color: #9B59B6; }
    .rank-stats { text-align: right; min-width: 70px; }
    .rank-xp { font-weight: 700; font-size: 1em; color: #ffb547; }
    .rank-secondary { font-size: 0.7em; color: #a9b5c6; }
    .podium { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin-bottom: 30px; padding: 20px; }
    .podium-item { text-align: center; transition: transform 0.3s ease; }
    .podium-item:hover { transform: translateY(-5px); }
    .podium-avatar { width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2em; margin: 0 auto 8px; border: 3px solid; }
    .podium-1 .podium-avatar { width: 70px; height: 70px; font-size: 1.4em; border-color: #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    .podium-2 .podium-avatar { border-color: #C0C0C0; }
    .podium-3 .podium-avatar { border-color: #CD7F32; }
    .podium-name { font-weight: 600; font-size: 0.85em; margin-bottom: 3px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .podium-xp { color: #ffb547; font-weight: 700; font-size: 0.9em; }
    .podium-base { width: 70px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.3em; border-radius: 8px 8px 0 0; margin-top: 8px; }
    .podium-1 .podium-base { height: 90px; background: linear-gradient(180deg, #FFD700, #FFA500); color: #000; width: 85px; }
    .podium-2 .podium-base { height: 65px; background: linear-gradient(180deg, #C0C0C0, #A8A8A8); color: #000; }
    .podium-3 .podium-base { height: 45px; background: linear-gradient(180deg, #CD7F32, #8B4513); color: #fff; }
    .team-ranking-item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .team-ranking-item:last-child { border-bottom: none; }
    .team-badge { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; background: rgba(255, 255, 255, 0.1); }
    .team-info { flex: 1; }
    .team-name { font-weight: 700; font-size: 1em; margin-bottom: 3px; }
    .team-stats { font-size: 0.8em; color: #a9b5c6; }
    .team-xp { text-align: right; }
    .team-xp-value { font-weight: 800; font-size: 1.2em; color: #ffb547; }
    .team-xp-label { font-size: 0.7em; color: #6b7280; }
    .empty-state { text-align: center; padding: 60px 20px; color: #a9b5c6; }
    .empty-icon { font-size: 4em; margin-bottom: 20px; }
    .loading { text-align: center; padding: 40px; color: #a9b5c6; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255, 181, 71, 0.3); border-top-color: #ffb547; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(0, 0, 0, 0.9); color: white; padding: 15px 30px; border-radius: 50px; font-weight: 600; z-index: 2000; opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .info-banner { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 0.85em; }
    .info-banner-icon { font-size: 1.2em; }
    .info-banner-text { color: #a9b5c6; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(14, 20, 27, 0.98); backdrop-filter: blur(20px); padding: 10px 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 99; }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #a9b5c6; text-decoration: none; font-size: 0.75em; transition: all 0.3s ease; }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }
    @media (max-width: 600px) {
      .podium { gap: 5px; }
      .podium-base { width: 55px !important; }
      .podium-1 .podium-base { width: 65px !important; }
      .my-stats-grid { grid-template-columns: repeat(2, 1fr); }
      .category-tabs { justify-content: flex-start; }
      .rank-movement { display: none; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='painel.html'">‚Üê Voltar</button>
      <div class="logo">‚öΩ Yellup</div>
      <div style="width: 80px;"></div>
    </div>
  </header>

  <div class="container">
    <div class="page-title">
      <h1>üèÜ Rankings</h1>
      <p>Os melhores jogadores do Yellup</p>
    </div>

    <div class="category-tabs">
      <button class="category-tab active" data-category="xp" onclick="trocarCategoria('xp')">‚≠ê XP</button>
      <button class="category-tab" data-category="pvp" onclick="trocarCategoria('pvp')">‚öîÔ∏è Embates PVP</button>
      <button class="category-tab" data-category="torcidas" onclick="trocarCategoria('torcidas')">üèüÔ∏è Torcidas</button>
    </div>

    <div class="filters" id="periodFilters">
      <button class="filter-btn active" data-filter="geral" onclick="trocarFiltro('geral')">üåç Geral</button>
      <button class="filter-btn" data-filter="mensal" onclick="trocarFiltro('mensal')">üìÖ Mensal</button>
      <button class="filter-btn" data-filter="semanal" onclick="trocarFiltro('semanal')">üìÜ Semanal</button>
      <button class="filter-btn" data-filter="clube" onclick="trocarFiltro('clube')">‚öΩ Por Clube</button>
    </div>

    <div class="filters" id="pvpFilters" style="display: none;">
      <button class="filter-btn active" data-filter="vitorias" onclick="trocarFiltroPVP('vitorias')">üèÜ Vit√≥rias</button>
      <button class="filter-btn" data-filter="creditos" onclick="trocarFiltroPVP('creditos')">üíé Cr√©ditos</button>
      <button class="filter-btn" data-filter="winrate" onclick="trocarFiltroPVP('winrate')">üìä Win Rate</button>
    </div>

    <div class="team-filter" id="teamFilter">
      <select class="team-select" id="teamSelect" onchange="carregarRankingPorClube()">
        <option value="">Selecione um time...</option>
      </select>
    </div>

    <div class="info-banner" id="infoBanner" style="display: none;">
      <span class="info-banner-icon">‚ÑπÔ∏è</span>
      <span class="info-banner-text" id="infoBannerText"></span>
    </div>

    <div class="my-position-card" id="myPositionCard">
      <div class="my-position-header">
        <div class="my-position-rank" id="myRank">-</div>
        <div class="my-position-info">
          <div class="my-position-name" id="myName">Carregando...</div>
          <div class="my-position-stats">
            <span id="myMainStat">0 XP</span>
            <span>‚Ä¢</span>
            <span id="myLevelBadge" class="rank-level level-bronze">ü•â Bronze</span>
          </div>
        </div>
      </div>
      <div class="my-stats-grid">
        <div class="my-stat-item"><div class="my-stat-value" id="myStat1">0</div><div class="my-stat-label" id="myStat1Label">Partidas</div></div>
        <div class="my-stat-item"><div class="my-stat-value" id="myStat2">0%</div><div class="my-stat-label" id="myStat2Label">Acertos</div></div>
        <div class="my-stat-item"><div class="my-stat-value" id="myStat3">0</div><div class="my-stat-label" id="myStat3Label">Vit√≥rias</div></div>
        <div class="my-stat-item"><div class="my-stat-value" id="myStat4">0</div><div class="my-stat-label" id="myStat4Label">Streak</div></div>
      </div>
    </div>

    <div class="podium" id="podium" style="display: none;">
      <div class="podium-item podium-2" id="podium2">
        <div class="podium-avatar" style="background: #C0C0C0;">2</div>
        <div class="podium-name">-</div>
        <div class="podium-xp">0</div>
        <div class="podium-base">ü•à</div>
      </div>
      <div class="podium-item podium-1" id="podium1">
        <div class="podium-avatar" style="background: #FFD700;">1</div>
        <div class="podium-name">-</div>
        <div class="podium-xp">0</div>
        <div class="podium-base">ü•á</div>
      </div>
      <div class="podium-item podium-3" id="podium3">
        <div class="podium-avatar" style="background: #CD7F32;">3</div>
        <div class="podium-name">-</div>
        <div class="podium-xp">0</div>
        <div class="podium-base">ü•â</div>
      </div>
    </div>

    <div class="ranking-card">
      <div class="ranking-header">
        <div class="ranking-title"><span>üìä</span><span id="rankingTitleText">Top 50 - Geral</span></div>
        <div class="ranking-period" id="rankingPeriod">Todos os tempos</div>
      </div>
      <ul class="ranking-list" id="rankingList">
        <div class="loading"><div class="loading-spinner"></div><p>Carregando ranking...</p></div>
      </ul>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span><span>In√≠cio</span></a>
      <a href="ranking-geral.html" class="nav-item active"><span class="nav-icon">üèÜ</span><span>Ranking</span></a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span><span>Indicar</span></a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span><span>Perfil</span></a>
    </div>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserId = null, currentUserData = null;
    let categoriaAtual = 'xp', filtroAtual = 'geral', filtroPVPAtual = 'vitorias';
    let timesCache = {};

    const NIVEIS = [
      { nome: 'Bronze', minXP: 0, classe: 'level-bronze', emoji: 'ü•â' },
      { nome: 'Prata', minXP: 500, classe: 'level-prata', emoji: 'ü•à' },
      { nome: 'Ouro', minXP: 2000, classe: 'level-ouro', emoji: 'ü•á' },
      { nome: 'Diamante', minXP: 5000, classe: 'level-diamante', emoji: 'üíé' },
      { nome: 'Mestre', minXP: 10000, classe: 'level-mestre', emoji: 'üëë' }
    ];

    function calcularNivel(xp) {
      let nivel = NIVEIS[0];
      for (const n of NIVEIS) if (xp >= n.minXP) nivel = n;
      return nivel;
    }

    function formatarNumero(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUserId = user.uid;
      try {
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) currentUserData = userDoc.data();
        await carregarTimes();
        await carregarRanking();
      } catch (e) { console.error(e); showToast('‚ùå Erro ao carregar dados'); }
    });

    async function carregarTimes() {
      try {
        const snap = await db.collection('times').orderBy('nome').get();
        const sel = document.getElementById('teamSelect');
        snap.forEach(doc => {
          timesCache[doc.id] = doc.data();
          sel.innerHTML += '<option value="'+doc.id+'">'+doc.data().nome+'</option>';
        });
      } catch (e) { console.error(e); }
    }

    function trocarCategoria(cat) {
      categoriaAtual = cat;
      document.querySelectorAll('.category-tab').forEach(t => t.classList.toggle('active', t.dataset.category === cat));
      document.getElementById('periodFilters').style.display = cat === 'xp' ? 'flex' : 'none';
      document.getElementById('pvpFilters').style.display = cat === 'pvp' ? 'flex' : 'none';
      document.getElementById('teamFilter').classList.remove('active');
      document.getElementById('infoBanner').style.display = 'none';
      if (cat === 'xp') { filtroAtual = 'geral'; document.querySelectorAll('#periodFilters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'geral')); }
      else if (cat === 'pvp') { filtroPVPAtual = 'vitorias'; document.querySelectorAll('#pvpFilters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'vitorias')); }
      carregarRanking();
    }

    function trocarFiltro(f) {
      filtroAtual = f;
      document.querySelectorAll('#periodFilters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
      if (f === 'clube') document.getElementById('teamFilter').classList.add('active');
      else { document.getElementById('teamFilter').classList.remove('active'); carregarRanking(); }
    }

    function trocarFiltroPVP(f) {
      filtroPVPAtual = f;
      document.querySelectorAll('#pvpFilters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
      carregarRanking();
    }

    async function carregarRanking() {
      if (categoriaAtual === 'xp') await carregarRankingXP();
      else if (categoriaAtual === 'pvp') await carregarRankingPVP();
      else if (categoriaAtual === 'torcidas') await carregarRankingTorcidas();
    }

    async function carregarRankingXP() {
      const lista = document.getElementById('rankingList');
      const titleText = document.getElementById('rankingTitleText');
      const periodText = document.getElementById('rankingPeriod');
      const infoBanner = document.getElementById('infoBanner');
      lista.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>';

      try {
        let campo = 'xp';
        if (filtroAtual === 'mensal') { campo = 'xpMensal'; titleText.textContent = 'Top 50 - Mensal'; periodText.textContent = new Date().toLocaleDateString('pt-BR', {month:'long',year:'numeric'}); infoBanner.style.display = 'flex'; document.getElementById('infoBannerText').textContent = 'XP ganho este m√™s. Reseta dia 1¬∫.'; }
        else if (filtroAtual === 'semanal') { campo = 'xpSemanal'; titleText.textContent = 'Top 50 - Semanal'; periodText.textContent = 'Esta semana'; infoBanner.style.display = 'flex'; document.getElementById('infoBannerText').textContent = 'XP ganho esta semana. Reseta domingo.'; }
        else { titleText.textContent = 'Top 50 - Geral'; periodText.textContent = 'Todos os tempos'; infoBanner.style.display = 'none'; }

        const snap = await db.collection('usuarios').orderBy(campo, 'desc').limit(100).get();
        if (snap.empty) { lista.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><p>Nenhum jogador</p></div>'; return; }

        let users = [];
        snap.forEach(doc => { const d = doc.data(); const xpP = d[campo] || 0; if (filtroAtual === 'geral' || xpP > 0) users.push({id: doc.id, ...d, xpExibir: xpP}); });
        users.sort((a,b) => (b.xpExibir||0) - (a.xpExibir||0));
        users = users.slice(0, 50);
        renderizarRankingXP(users, campo);
      } catch (e) {
        console.error(e);
        if (filtroAtual !== 'geral') { filtroAtual = 'geral'; document.querySelectorAll('#periodFilters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'geral')); showToast('‚ö†Ô∏è Usando XP total'); carregarRankingXP(); return; }
        lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Erro</p></div>';
      }
    }

    async function carregarRankingPorClube() {
      const timeId = document.getElementById('teamSelect').value;
      if (!timeId) return;
      const lista = document.getElementById('rankingList');
      document.getElementById('rankingTitleText').textContent = 'Top 50 - ' + (timesCache[timeId]?.nome || 'Clube');
      document.getElementById('rankingPeriod').textContent = 'Torcedores deste time';
      lista.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>';

      try {
        const snap = await db.collection('usuarios').where('timeId', '==', timeId).orderBy('xp', 'desc').limit(50).get();
        if (snap.empty) { lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öΩ</div><p>Nenhum torcedor</p></div>'; document.getElementById('podium').style.display = 'none'; document.getElementById('myPositionCard').style.display = 'none'; return; }
        const users = [];
        snap.forEach(doc => users.push({id: doc.id, ...doc.data(), xpExibir: doc.data().xp || 0}));
        renderizarRankingXP(users, 'xp');
      } catch (e) { console.error(e); lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Erro</p></div>'; }
    }

    async function carregarRankingPVP() {
      const lista = document.getElementById('rankingList');
      document.getElementById('infoBanner').style.display = 'none';
      let campo = 'pvp.vitorias', titulo = 'Vit√≥rias', periodo = 'Total de vit√≥rias';
      if (filtroPVPAtual === 'creditos') { campo = 'pvp.creditosGanhos'; titulo = 'Cr√©ditos'; periodo = 'Cr√©ditos ganhos'; }
      else if (filtroPVPAtual === 'winrate') { titulo = 'Win Rate'; periodo = 'Taxa de vit√≥ria (m√≠n. 5 embates)'; }
      document.getElementById('rankingTitleText').textContent = 'Top 50 - ' + titulo;
      document.getElementById('rankingPeriod').textContent = periodo;
      lista.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Carregando PVP...</p></div>';

      try {
        let snap;
        if (filtroPVPAtual === 'winrate') snap = await db.collection('usuarios').where('pvp.totalEmbates', '>=', 5).limit(200).get();
        else snap = await db.collection('usuarios').orderBy(campo, 'desc').limit(50).get();
        if (snap.empty) { lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚öîÔ∏è</div><p>Nenhum embate ainda</p></div>'; document.getElementById('podium').style.display = 'none'; document.getElementById('myPositionCard').style.display = 'none'; return; }

        let users = [];
        snap.forEach(doc => {
          const d = doc.data(), pvp = d.pvp || {};
          let val = 0;
          if (filtroPVPAtual === 'vitorias') val = pvp.vitorias || 0;
          else if (filtroPVPAtual === 'creditos') val = pvp.creditosGanhos || 0;
          else { const t = pvp.totalEmbates || 0, v = pvp.vitorias || 0; val = t > 0 ? Math.round((v/t)*100) : 0; }
          if (val > 0 || filtroPVPAtual === 'winrate') users.push({id: doc.id, ...d, valorPVP: val});
        });
        users.sort((a,b) => (b.valorPVP||0) - (a.valorPVP||0));
        users = users.slice(0, 50);
        renderizarRankingPVP(users);
      } catch (e) { console.error(e); lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Erro PVP</p></div>'; }
    }

    async function carregarRankingTorcidas() {
      const lista = document.getElementById('rankingList');
      document.getElementById('rankingTitleText').textContent = 'Ranking de Torcidas';
      document.getElementById('rankingPeriod').textContent = 'XP total por time';
      document.getElementById('podium').style.display = 'none';
      document.getElementById('myPositionCard').style.display = 'none';
      document.getElementById('infoBanner').style.display = 'none';
      lista.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Calculando torcidas...</p></div>';

      try {
        const snap = await db.collection('usuarios').get();
        const torc = {};
        snap.forEach(doc => {
          const d = doc.data(), tid = d.timeId;
          if (!tid) return;
          if (!torc[tid]) torc[tid] = {timeId: tid, nome: timesCache[tid]?.nome || 'Desconhecido', totalTorcedores: 0, xpTotal: 0, vitoriasPVP: 0};
          torc[tid].totalTorcedores++;
          torc[tid].xpTotal += d.xp || 0;
          torc[tid].vitoriasPVP += d.pvp?.vitorias || 0;
        });
        let arr = Object.values(torc);
        arr.sort((a,b) => b.xpTotal - a.xpTotal);
        arr = arr.slice(0, 30);
        if (arr.length === 0) { lista.innerHTML = '<div class="empty-state"><div class="empty-icon">üèüÔ∏è</div><p>Nenhuma torcida</p></div>'; return; }
        renderizarRankingTorcidas(arr);
      } catch (e) { console.error(e); lista.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Erro torcidas</p></div>'; }
    }

    function renderizarRankingXP(users, campoXP) {
      const lista = document.getElementById('rankingList');
      const podium = document.getElementById('podium');
      const myCard = document.getElementById('myPositionCard');

      let minhaPos = users.findIndex(u => u.id === currentUserId) + 1;
      if (minhaPos === 0 && currentUserData) {
        const meuXP = currentUserData[campoXP] || currentUserData.xp || 0;
        const maiores = users.filter(u => (u.xpExibir||0) > meuXP).length;
        minhaPos = maiores + 1;
        if (minhaPos > 50) document.getElementById('myRank').textContent = '~' + minhaPos + '¬∫';
      }

      if (currentUserData) {
        myCard.style.display = 'block';
        if (minhaPos <= 50) document.getElementById('myRank').textContent = minhaPos + '¬∫';
        document.getElementById('myName').textContent = currentUserData.usuarioUnico || 'Voc√™';
        document.getElementById('myMainStat').textContent = formatarNumero(currentUserData[campoXP] || currentUserData.xp || 0) + ' XP';
        const niv = calcularNivel(currentUserData.xp || 0);
        const badge = document.getElementById('myLevelBadge');
        badge.className = 'rank-level ' + niv.classe;
        badge.textContent = niv.emoji + ' ' + niv.nome;
        document.getElementById('myStat1').textContent = currentUserData.totalPartidas || 0;
        document.getElementById('myStat1Label').textContent = 'Partidas';
        const taxa = currentUserData.taxaAcerto ? Math.round(currentUserData.taxaAcerto * 100) : 0;
        document.getElementById('myStat2').textContent = taxa + '%';
        document.getElementById('myStat2Label').textContent = 'Acertos';
        document.getElementById('myStat3').textContent = currentUserData.pvp?.vitorias || 0;
        document.getElementById('myStat3Label').textContent = 'Vit√≥rias PVP';
        document.getElementById('myStat4').textContent = currentUserData.pvp?.maiorStreak || 0;
        document.getElementById('myStat4Label').textContent = 'Maior Streak';
      } else { myCard.style.display = 'none'; }

      if (users.length >= 3) {
        podium.style.display = 'flex';
        for (let i = 1; i <= 3; i++) {
          const u = users[i-1], nome = u.usuarioUnico || 'An√¥nimo';
          const pi = document.getElementById('podium' + i);
          pi.querySelector('.podium-avatar').textContent = nome.charAt(0).toUpperCase();
          pi.querySelector('.podium-name').textContent = nome;
          pi.querySelector('.podium-xp').textContent = formatarNumero(u.xpExibir || 0) + ' XP';
        }
      } else { podium.style.display = 'none'; }

      const listaR = users.length >= 4 ? users.slice(3) : users;
      if (listaR.length === 0) { lista.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p>Nenhum jogador</p></div>'; return; }

      const cores = {'level-bronze':'linear-gradient(135deg,#CD7F32,#8B4513)','level-prata':'linear-gradient(135deg,#C0C0C0,#A8A8A8)','level-ouro':'linear-gradient(135deg,#FFD700,#FFA500)','level-diamante':'linear-gradient(135deg,#B9F2FF,#87CEEB)','level-mestre':'linear-gradient(135deg,#9B59B6,#8E44AD)'};

      lista.innerHTML = listaR.map((u, i) => {
        const pos = users.length >= 4 ? i + 4 : i + 1;
        const nome = u.usuarioUnico || 'An√¥nimo';
        const niv = calcularNivel(u.xp || 0);
        const time = timesCache[u.timeId];
        const isMe = u.id === currentUserId;
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        const rowClass = pos <= 3 ? 'top-' + pos : '';
        return '<li class="ranking-item ' + rowClass + (isMe ? ' highlight' : '') + '"><div class="rank-position ' + posClass + '">' + pos + '</div><span class="rank-movement same">‚Äî</span><div class="rank-avatar" style="background:' + (cores[niv.classe] || 'linear-gradient(135deg,#666,#444)') + '">' + nome.charAt(0).toUpperCase() + '</div><div class="rank-info"><div class="rank-name">' + nome + '<span class="rank-level ' + niv.classe + '">' + niv.emoji + '</span></div><div class="rank-team">' + (time?.nome || 'Sem time') + '</div><div class="rank-details"><span>üìä ' + (u.totalPartidas || 0) + ' jogos</span></div></div><div class="rank-stats"><div class="rank-xp">' + formatarNumero(u.xpExibir || 0) + '</div><div class="rank-secondary">XP</div></div></li>';
      }).join('');
    }

    function renderizarRankingPVP(users) {
      const lista = document.getElementById('rankingList');
      const podium = document.getElementById('podium');
      const myCard = document.getElementById('myPositionCard');

      const minhaPos = users.findIndex(u => u.id === currentUserId) + 1;
      if (minhaPos > 0 || currentUserData?.pvp) {
        myCard.style.display = 'block';
        document.getElementById('myRank').textContent = (minhaPos > 0 ? minhaPos : '>50') + '¬∫';
        document.getElementById('myName').textContent = currentUserData?.usuarioUnico || 'Voc√™';
        const pvp = currentUserData?.pvp || {};
        let mainStat = '';
        if (filtroPVPAtual === 'vitorias') mainStat = (pvp.vitorias || 0) + ' vit√≥rias';
        else if (filtroPVPAtual === 'creditos') mainStat = formatarNumero(pvp.creditosGanhos || 0) + ' üíé';
        else { const t = pvp.totalEmbates || 0, v = pvp.vitorias || 0; mainStat = (t > 0 ? Math.round((v/t)*100) : 0) + '% win rate'; }
        document.getElementById('myMainStat').textContent = mainStat;
        document.getElementById('myStat1').textContent = pvp.totalEmbates || 0;
        document.getElementById('myStat1Label').textContent = 'Embates';
        document.getElementById('myStat2').textContent = pvp.vitorias || 0;
        document.getElementById('myStat2Label').textContent = 'Vit√≥rias';
        document.getElementById('myStat3').textContent = pvp.derrotas || 0;
        document.getElementById('myStat3Label').textContent = 'Derrotas';
        document.getElementById('myStat4').textContent = formatarNumero(pvp.creditosGanhos || 0);
        document.getElementById('myStat4Label').textContent = 'Cr√©ditos';
        const niv = calcularNivel(currentUserData?.xp || 0);
        const badge = document.getElementById('myLevelBadge');
        badge.className = 'rank-level ' + niv.classe;
        badge.textContent = niv.emoji + ' ' + niv.nome;
      } else { myCard.style.display = 'none'; }

      if (users.length >= 3) {
        podium.style.display = 'flex';
        for (let i = 1; i <= 3; i++) {
          const u = users[i-1], nome = u.usuarioUnico || 'An√¥nimo';
          let val = '';
          if (filtroPVPAtual === 'vitorias') val = u.valorPVP + ' üèÜ';
          else if (filtroPVPAtual === 'creditos') val = formatarNumero(u.valorPVP) + ' üíé';
          else val = u.valorPVP + '%';
          const pi = document.getElementById('podium' + i);
          pi.querySelector('.podium-avatar').textContent = nome.charAt(0).toUpperCase();
          pi.querySelector('.podium-name').textContent = nome;
          pi.querySelector('.podium-xp').textContent = val;
        }
      } else { podium.style.display = 'none'; }

      const listaR = users.length >= 4 ? users.slice(3) : users;
      if (listaR.length === 0 && users.length <= 3) { lista.innerHTML = ''; return; }

      const cores = {'level-bronze':'linear-gradient(135deg,#CD7F32,#8B4513)','level-prata':'linear-gradient(135deg,#C0C0C0,#A8A8A8)','level-ouro':'linear-gradient(135deg,#FFD700,#FFA500)','level-diamante':'linear-gradient(135deg,#B9F2FF,#87CEEB)','level-mestre':'linear-gradient(135deg,#9B59B6,#8E44AD)'};

      lista.innerHTML = listaR.map((u, i) => {
        const pos = users.length >= 4 ? i + 4 : i + 1;
        const nome = u.usuarioUnico || 'An√¥nimo';
        const niv = calcularNivel(u.xp || 0);
        const time = timesCache[u.timeId];
        const isMe = u.id === currentUserId;
        const pvp = u.pvp || {};
        let val = '', lab = '';
        if (filtroPVPAtual === 'vitorias') { val = u.valorPVP; lab = 'vit√≥rias'; }
        else if (filtroPVPAtual === 'creditos') { val = formatarNumero(u.valorPVP); lab = 'üíé'; }
        else { val = u.valorPVP + '%'; lab = 'win rate'; }
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        return '<li class="ranking-item' + (isMe ? ' highlight' : '') + '"><div class="rank-position ' + posClass + '">' + pos + '</div><div class="rank-avatar" style="background:' + (cores[niv.classe] || 'linear-gradient(135deg,#666,#444)') + '">' + nome.charAt(0).toUpperCase() + '</div><div class="rank-info"><div class="rank-name">' + nome + '<span class="rank-level ' + niv.classe + '">' + niv.emoji + '</span></div><div class="rank-team">' + (time?.nome || 'Sem time') + '</div><div class="rank-details"><span>‚öîÔ∏è ' + (pvp.totalEmbates || 0) + ' embates</span><span>üìä ' + (pvp.vitorias || 0) + 'W / ' + (pvp.derrotas || 0) + 'L</span></div></div><div class="rank-stats"><div class="rank-xp">' + val + '</div><div class="rank-secondary">' + lab + '</div></div></li>';
      }).join('');
    }

    function renderizarRankingTorcidas(torc) {
      const lista = document.getElementById('rankingList');
      lista.innerHTML = torc.map((t, i) => {
        const pos = i + 1;
        const posClass = pos === 1 ? 'gold' : pos === 2 ? 'silver' : pos === 3 ? 'bronze' : '';
        const rowClass = pos <= 3 ? 'top-' + pos : '';
        return '<li class="team-ranking-item ' + rowClass + '"><div class="rank-position ' + posClass + '">' + pos + '</div><div class="team-badge">‚öΩ</div><div class="team-info"><div class="team-name">' + t.nome + '</div><div class="team-stats">üë• ' + formatarNumero(t.totalTorcedores) + ' torcedores ‚Ä¢ ‚öîÔ∏è ' + formatarNumero(t.vitoriasPVP) + ' vit√≥rias PVP</div></div><div class="team-xp"><div class="team-xp-value">' + formatarNumero(t.xpTotal) + '</div><div class="team-xp-label">XP Total</div></div></li>';
      }).join('');
    }

    console.log("‚úÖ Rankings v2.0 - Completo");
  </script>
</body>
</html>
