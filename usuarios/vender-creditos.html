<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vender YC - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-title {
      text-align: center;
      margin-bottom: 25px;
    }

    .page-title h1 {
      font-size: 1.8em;
      margin-bottom: 5px;
      color: #10b981;
    }

    .page-title p {
      color: #a9b5c6;
    }

    /* Alerta CPF/PIX */
    .alert-box {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: center;
    }

    .alert-box.warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
      border-color: rgba(245, 158, 11, 0.5);
    }

    .alert-box h3 {
      color: #ef4444;
      margin-bottom: 10px;
    }

    .alert-box.warning h3 {
      color: #f59e0b;
    }

    .alert-box p {
      color: #a9b5c6;
      margin-bottom: 15px;
      font-size: 0.9em;
    }

    .btn-alert {
      padding: 12px 25px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
      display: inline-block;
    }

    /* Card Saldo */
    .balance-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.1) 100%);
      border: 2px solid rgba(16, 185, 129, 0.5);
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      margin-bottom: 25px;
    }

    .balance-label {
      font-size: 0.9em;
      color: #a9b5c6;
      margin-bottom: 5px;
    }

    .balance-value {
      font-size: 3em;
      font-weight: 800;
      color: #10b981;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .balance-real {
      font-size: 1.2em;
      color: #a9b5c6;
      margin-top: 10px;
    }

    .balance-real span {
      color: #10b981;
      font-weight: 700;
    }

    /* Info */
    .info-box {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-row .label {
      color: #a9b5c6;
    }

    .info-row .value {
      font-weight: 600;
      color: #10b981;
    }

    /* Formul√°rio de venda */
    .sell-form {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .form-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #a9b5c6;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: rgba(16, 185, 129, 0.5);
    }

    .form-input:disabled {
      opacity: 0.5;
    }

    .input-group {
      display: flex;
      gap: 10px;
    }

    .input-group .form-input {
      flex: 1;
    }

    .btn-max {
      padding: 15px 20px;
      background: rgba(16, 185, 129, 0.2);
      border: 2px solid rgba(16, 185, 129, 0.5);
      border-radius: 12px;
      color: #10b981;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-max:hover {
      background: rgba(16, 185, 129, 0.3);
    }

    .preview-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .preview-label {
      color: #a9b5c6;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .preview-value {
      font-size: 2em;
      font-weight: 800;
      color: #10b981;
    }

    .btn-sell {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-sell:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .btn-sell:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Hist√≥rico */
    .history-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .history-item {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .history-credits {
      font-weight: 700;
      font-size: 1.1em;
    }

    .history-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .status-pendente {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .status-aprovado {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-rejeitado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .history-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.85em;
      color: #a9b5c6;
    }

    .history-value {
      color: #10b981;
      font-weight: 600;
    }

    .empty-history {
      text-align: center;
      padding: 40px;
      color: #a9b5c6;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #1e293b, #334155);
      color: #fff;
      padding: 15px 25px;
      border-radius: 12px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10000;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(14, 20, 27, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 0;
      z-index: 100;
    }

    .nav-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #a9b5c6;
      font-size: 0.75em;
      transition: all 0.3s ease;
    }

    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; margin-bottom: 4px; }

    /* Loading */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }

    .loading-overlay.active { display: flex; }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(16, 185, 129, 0.2);
      border-top-color: #10b981;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='loja-creditos.html'">‚Üê Voltar</button>
      <div class="logo">üí∞ Vender</div>
      <div style="width: 80px;"></div>
    </div>
  </header>

  <div class="container">
    
    <div class="page-title">
      <h1>üí∞ Vender YC</h1>
      <p>Transforme seus Yellow Coins em dinheiro real!</p>
    </div>

    <!-- Alerta CPF -->
    <div class="alert-box" id="cpfAlert" style="display: none;">
      <h3>‚ö†Ô∏è CPF Obrigat√≥rio</h3>
      <p>Para vender YC, voc√™ precisa cadastrar seu CPF no perfil.</p>
      <a href="editar-perfil.html" class="btn-alert">Cadastrar CPF</a>
    </div>

    <!-- Alerta Chave PIX -->
    <div class="alert-box warning" id="pixAlert" style="display: none;">
      <h3>‚ö†Ô∏è Chave PIX Obrigat√≥ria</h3>
      <p>Para receber o pagamento, cadastre sua chave PIX no perfil.</p>
      <a href="editar-perfil.html" class="btn-alert" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Cadastrar PIX</a>
    </div>

    <!-- Alerta M√≠nimo -->
    <div class="alert-box warning" id="minimoAlert" style="display: none;">
      <h3>‚ö†Ô∏è Saldo Insuficiente</h3>
      <p>Voc√™ precisa ter no m√≠nimo <strong>100 YC</strong> para solicitar uma venda.</p>
      <a href="painel.html" class="btn-alert" style="background: linear-gradient(135deg, #f59e0b, #d97706);">Jogar e Ganhar</a>
    </div>

    <!-- Saldo -->
    <div class="balance-card">
      <div class="balance-label">Seu saldo de YC dispon√≠vel</div>
      <div class="balance-value">
        <span>üí∞</span>
        <span id="currentBalance">0,00</span>
        <span style="font-size: 0.5em; color: #10b981;">YC</span>
      </div>
      <div class="balance-real">
        Equivalente a <span>R$ <span id="valorEquivalente">0,00</span></span>
      </div>
    </div>

    <!-- Info -->
    <div class="info-box">
      <div class="info-row">
        <span class="label">Valor por YC</span>
        <span class="value">R$ 0,15</span>
      </div>
      <div class="info-row">
        <span class="label">M√≠nimo para venda</span>
        <span class="value">100 YC</span>
      </div>
      <div class="info-row">
        <span class="label">Prazo de pagamento</span>
        <span class="value">At√© 48 horas</span>
      </div>
      <div class="info-row">
        <span class="label">Forma de pagamento</span>
        <span class="value">PIX</span>
      </div>
    </div>

    <!-- Formul√°rio -->
    <div class="sell-form" id="sellForm">
      <div class="form-title">üìù Solicitar Venda</div>

      <div class="form-group">
        <label class="form-label">Quantidade de YC para vender</label>
        <div class="input-group">
          <input type="number" class="form-input" id="inputCreditos" placeholder="M√≠nimo 100" min="100" step="0.01" oninput="calcularValor()">
          <button type="button" class="btn-max" onclick="colocarMaximo()">MAX</button>
        </div>
      </div>

      <div class="preview-box">
        <div class="preview-label">Voc√™ receber√°</div>
        <div class="preview-value">R$ <span id="previewValor">0,00</span></div>
      </div>

      <button class="btn-sell" id="btnVender" onclick="solicitarVenda()" disabled>
        üí∏ Solicitar Venda
      </button>
    </div>

    <!-- Hist√≥rico -->
    <div class="history-title">üìú Minhas Solicita√ß√µes</div>
    <div id="historyContainer">
      <div class="empty-history">
        <p>Voc√™ ainda n√£o solicitou nenhuma venda</p>
      </div>
    </div>

  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p>Processando solicita√ß√£o...</p>
  </div>

  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span>In√≠cio</span>
      </a>
      <a href="ranking-geral.html" class="nav-item">
        <span class="nav-icon">üèÜ</span>
        <span>Ranking</span>
      </a>
      <a href="indicacoes.html" class="nav-item">
        <span class="nav-icon">üîó</span>
        <span>Indicar</span>
      </a>
      <a href="editar-perfil.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        <span>Perfil</span>
      </a>
    </div>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const VALOR_POR_YC = 0.15;
    const MINIMO_VENDA = 100;  // M√≠nimo 100 YC = R$ 15,00

    let currentUserId = null;
    let currentUserData = null;
    let ycDisponivel = 0;

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      currentUserId = user.uid;

      try {
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) {
          currentUserData = userDoc.data();
          ycDisponivel = currentUserData.yc || 0;
          
          document.getElementById('currentBalance').textContent = ycDisponivel.toFixed(2).replace('.', ',');
          document.getElementById('valorEquivalente').textContent = (ycDisponivel * VALOR_POR_YC).toFixed(2).replace('.', ',');

          // Verificar CPF
          if (!currentUserData.cpf) {
            document.getElementById('cpfAlert').style.display = 'block';
            document.getElementById('sellForm').style.display = 'none';
          }
          // Verificar PIX
          else if (!currentUserData.chavePix) {
            document.getElementById('pixAlert').style.display = 'block';
            document.getElementById('sellForm').style.display = 'none';
          }
          // Verificar m√≠nimo
          else if (ycDisponivel < MINIMO_VENDA) {
            document.getElementById('minimoAlert').style.display = 'block';
            document.getElementById('sellForm').style.opacity = '0.5';
            document.getElementById('sellForm').style.pointerEvents = 'none';
          }

          // Verificar YC pendentes
          await verificarYCPendentes();
          
          carregarHistorico();
        }
      } catch (error) {
        console.error("Erro:", error);
      }
    });

    async function verificarYCPendentes() {
      try {
        const snapshot = await db.collection('vendas_creditos')
          .where('usuarioId', '==', currentUserId)
          .where('status', '==', 'pendente')
          .get();

        let creditosPendentes = 0;
        snapshot.forEach(doc => {
          creditosPendentes += doc.data().creditos;
        });

        if (creditosPendentes > 0) {
          creditosDisponiveis = creditosDisponiveis - creditosPendentes;
          document.getElementById('currentBalance').textContent = creditosDisponiveis.toLocaleString('pt-BR');
          document.getElementById('valorEquivalente').textContent = (creditosDisponiveis * VALOR_POR_CREDITO).toFixed(2).replace('.', ',');
          
          if (creditosDisponiveis < MINIMO_VENDA) {
            document.getElementById('minimoAlert').style.display = 'block';
            document.getElementById('sellForm').style.opacity = '0.5';
            document.getElementById('sellForm').style.pointerEvents = 'none';
          }
        }
      } catch (error) {
        console.error("Erro ao verificar pendentes:", error);
      }
    }

    function calcularValor() {
      const input = document.getElementById('inputCreditos');
      const yc = parseFloat(input.value) || 0;
      const valor = yc * VALOR_POR_YC;
      
      document.getElementById('previewValor').textContent = valor.toFixed(2).replace('.', ',');

      const btnVender = document.getElementById('btnVender');
      btnVender.disabled = yc < MINIMO_VENDA || yc > ycDisponivel;
    }

    function colocarMaximo() {
      document.getElementById('inputCreditos').value = ycDisponivel.toFixed(2);
      calcularValor();
    }

    async function solicitarVenda() {
      const yc = parseFloat(document.getElementById('inputCreditos').value) || 0;

      if (yc < MINIMO_VENDA) {
        showToast('‚ö†Ô∏è M√≠nimo de 100 YC');
        return;
      }

      if (yc > ycDisponivel) {
        showToast('‚ö†Ô∏è Saldo insuficiente');
        return;
      }

      const loading = document.getElementById('loadingOverlay');
      loading.classList.add('active');

      try {
        const valor = yc * VALOR_POR_YC;

        // Criar solicita√ß√£o de venda
        await db.collection('vendas_creditos').add({
          usuarioId: currentUserId,
          usuarioNome: currentUserData.nome || currentUserData.usuario || 'Usu√°rio',
          usuarioEmail: auth.currentUser?.email || '',
          cpf: currentUserData.cpf,
          chavePix: currentUserData.chavePix,
          yc: yc,
          valorTotal: valor,
          valorPorYC: VALOR_POR_YC,
          status: 'pendente',
          dataSolicitacao: firebase.firestore.FieldValue.serverTimestamp(),
          dataProcessamento: null,
          observacao: ''
        });

        // Bloquear os YC (remover do saldo dispon√≠vel)
        await db.collection('usuarios').doc(currentUserId).update({
          yc: firebase.firestore.FieldValue.increment(-yc),
          ycBloqueados: firebase.firestore.FieldValue.increment(yc)
        });

        loading.classList.remove('active');
        showToast('‚úÖ Solicita√ß√£o enviada com sucesso!');

        // Atualizar interface
        ycDisponivel -= yc;
        document.getElementById('currentBalance').textContent = ycDisponivel.toFixed(2).replace('.', ',');
        document.getElementById('valorEquivalente').textContent = (ycDisponivel * VALOR_POR_YC).toFixed(2).replace('.', ',');
        document.getElementById('inputCreditos').value = '';
        document.getElementById('previewValor').textContent = '0,00';
        document.getElementById('btnVender').disabled = true;

        carregarHistorico();

        if (ycDisponivel < MINIMO_VENDA) {
          document.getElementById('minimoAlert').style.display = 'block';
          document.getElementById('sellForm').style.opacity = '0.5';
          document.getElementById('sellForm').style.pointerEvents = 'none';
        }

      } catch (error) {
        console.error("Erro:", error);
        loading.classList.remove('active');
        showToast('‚ùå Erro ao processar. Tente novamente.');
      }
    }

    async function carregarHistorico() {
      try {
        const snapshot = await db.collection('vendas_creditos')
          .where('usuarioId', '==', currentUserId)
          .orderBy('dataSolicitacao', 'desc')
          .limit(10)
          .get();

        const container = document.getElementById('historyContainer');

        if (snapshot.empty) {
          container.innerHTML = `<div class="empty-history"><p>Voc√™ ainda n√£o solicitou nenhuma venda</p></div>`;
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const venda = doc.data();
          const data = venda.dataSolicitacao?.toDate ? 
            venda.dataSolicitacao.toDate().toLocaleDateString('pt-BR') : 'Processando...';
          
          let statusClass = 'status-pendente';
          let statusText = '‚è≥ Pendente';
          
          if (venda.status === 'aprovado') {
            statusClass = 'status-aprovado';
            statusText = '‚úÖ Pago';
          } else if (venda.status === 'rejeitado') {
            statusClass = 'status-rejeitado';
            statusText = '‚ùå Rejeitado';
          }

          html += `
            <div class="history-item">
              <div class="history-header">
                <span class="history-credits">üíé ${venda.creditos.toLocaleString('pt-BR')} cr√©ditos</span>
                <span class="history-status ${statusClass}">${statusText}</span>
              </div>
              <div class="history-details">
                <span>${data}</span>
                <span class="history-value">R$ ${venda.valorTotal.toFixed(2).replace('.', ',')}</span>
              </div>
              ${venda.observacao ? `<div style="font-size: 0.8em; color: #a9b5c6; margin-top: 8px;">üìù ${venda.observacao}</div>` : ''}
            </div>
          `;
        });

        container.innerHTML = html;

      } catch (error) {
        console.error("Erro ao carregar hist√≥rico:", error);
      }
    }

    console.log("‚úÖ Vender Cr√©ditos v1.0");
  </script>

</body>
</html>
