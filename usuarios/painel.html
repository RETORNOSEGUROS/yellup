
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel do Usuário</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      background: #f2f2f2;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #333;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #editarForm input, #editarForm select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }
    .sair {
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Bem-vindo ao Yellup!</h1>
    <p><strong>Usuário:</strong> <span id="nomeUsuario"></span></p>
    <p><strong>Time do Coração:</strong> <span id="timeNome"></span></p>
    <p><strong>Créditos:</strong> <span id="creditos"></span></p>
    <hr>
    <h2>Desempenho</h2>
    <p><strong>Pontuação Acumulada:</strong> <span id="pontuacao"></span></p>
    <div id="historico">
      <h3>Histórico de Partidas</h3>
      <ul id="listaPartidas" style="text-align:left;"></ul>
    </div>
    
    <hr>
    <h2>Troféus e Conquistas</h2>
    <div id="trofeus">
      <ul id="listaTrofeus" style="text-align:left;"></ul>
    </div>
    <hr>
    <h2>Editar Perfil</h2>
    
    <form id="editarForm">
      <input type="text" id="nome" placeholder="Nome completo" required/>
      <input type="text" id="celular" placeholder="Celular" />
      <input type="text" id="cidade" placeholder="Cidade" />
      <input type="text" id="estado" placeholder="Estado" />
      <input type="text" id="pais" placeholder="País" />
      <label for="timeId">Time do coração:</label>
      <select id="timeId"></select>
      <button type="submit">Salvar Alterações</button>
    </form>
    <button class="sair" onclick="logout()">Sair</button>
    <p id="status"></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let usuarioRef = null;

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "index.html";
      const uid = user.uid;
      usuarioRef = db.collection("usuarios").doc(uid);

      const doc = await usuarioRef.get();
      const dados = doc.data();
      document.getElementById("nomeUsuario").textContent = dados.nome;
      document.getElementById("creditos").textContent = dados.creditos ?? 0;

      // Popular formulário
      document.getElementById("nome").value = dados.nome || "";
      document.getElementById("celular").value = dados.celular || "";
      document.getElementById("cidade").value = dados.cidade || "";
      document.getElementById("estado").value = dados.estado || "";
      document.getElementById("pais").value = dados.pais || "";

      // Carregar times
      const timesSelect = document.getElementById("timeId");
      const snap = await db.collection("times").orderBy("nome").get();
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.data().nome;
        timesSelect.appendChild(opt);
      });
      document.getElementById("timeId").value = dados.timeId;
      const timeNomeSnap = await db.collection("times").doc(dados.timeId).get();
      document.getElementById("timeNome").textContent = timeNomeSnap.exists ? timeNomeSnap.data().nome : "Desconhecido";

      
    // Buscar conquistas (trofeus)
    const conquistasRef = await usuarioRef.collection("conquistas").get();
    const listaTrofeus = document.getElementById("listaTrofeus");
    if (!conquistasRef.empty) {
      conquistasRef.forEach(doc => {
        const li = document.createElement("li");
        const dados = doc.data();
        li.textContent = `${dados.nome} - ${new Date(dados.data?.toDate()).toLocaleDateString()}`;
        listaTrofeus.appendChild(li);
      });
    } else {
      listaTrofeus.innerHTML = "<li>Nenhum troféu ainda.</li>";
    }

    // Buscar pontuação e histórico
    
      const pontDoc = await usuarioRef.collection("desempenho").doc("dados").get();
      if (pontDoc.exists) {
        const d = pontDoc.data();
        document.getElementById("pontuacao").textContent = d.pontuacaoTotal ?? 0;
        const lista = document.getElementById("listaPartidas");
        if (d.partidas && d.partidas.length > 0) {
          d.partidas.slice().reverse().forEach(p => {
            const li = document.createElement("li");
            const data = p.data?.toDate ? p.data.toDate() : new Date();
            li.textContent = `Jogo: ${p.jogo} | Pontos: ${p.pontos} | Data: ${data.toLocaleDateString()}`;
            lista.appendChild(li);
          });
        } else {
          lista.innerHTML = "<li>Nenhuma partida registrada.</li>";
        }
      } else {
        document.getElementById("pontuacao").textContent = "0";
        document.getElementById("listaPartidas").innerHTML = "<li>Nenhuma partida registrada.</li>";
      }
    });

    function logout() {
      auth.signOut().then(() => window.location.href = "index.html");
    }

    document.getElementById("editarForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const celular = document.getElementById("celular").value;
      const cidade = document.getElementById("cidade").value;
      const estado = document.getElementById("estado").value;
      const pais = document.getElementById("pais").value;
      const timeId = document.getElementById("timeId").value;

      try {
        await usuarioRef.update({ nome, celular, cidade, estado, pais, timeId });
        document.getElementById("status").textContent = "Perfil atualizado com sucesso!";
        location.reload();
      } catch (err) {
        alert("Erro ao atualizar: " + err.message);
      }
    });
  </script>
</body>
</html>
