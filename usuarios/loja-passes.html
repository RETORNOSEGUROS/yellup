<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loja de Passes - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 100px;
    }
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .header-content {
      max-width: 600px; margin: 0 auto;
      display: flex; justify-content: space-between; align-items: center;
    }
    .btn-back {
      padding: 10px 20px; background: rgba(255,255,255,0.1); border: none;
      border-radius: 10px; color: #fff; cursor: pointer;
      font-family: 'Poppins', sans-serif; transition: all 0.3s ease;
    }
    .btn-back:hover { background: rgba(255,255,255,0.2); }
    .logo {
      font-size: 1.5em; font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .page-title { text-align: center; margin-bottom: 25px; }
    .page-title h1 { font-size: 1.8em; margin-bottom: 5px; }
    .page-title p { color: #a9b5c6; }

    .passe-status {
      border-radius: 20px; padding: 25px; text-align: center;
      margin-bottom: 25px; position: relative; overflow: hidden;
    }
    .passe-status.free {
      background: linear-gradient(135deg, rgba(107,114,128,0.2), rgba(75,85,99,0.1));
      border: 2px solid rgba(107,114,128,0.4);
    }
    .passe-status.semanal {
      background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1));
      border: 2px solid rgba(59,130,246,0.5);
    }
    .passe-status.mensal {
      background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(139,92,246,0.1));
      border: 2px solid rgba(168,85,247,0.5);
    }
    .passe-status.anual {
      background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.1));
      border: 2px solid rgba(245,158,11,0.5);
    }
    .passe-status-label { font-size: 0.85em; color: #a9b5c6; margin-bottom: 5px; }
    .passe-status-tipo { font-size: 1.8em; font-weight: 800; margin-bottom: 5px; }
    .passe-status.free .passe-status-tipo { color: #9ca3af; }
    .passe-status.semanal .passe-status-tipo { color: #60a5fa; }
    .passe-status.mensal .passe-status-tipo { color: #a78bfa; }
    .passe-status.anual .passe-status-tipo { color: #fbbf24; }
    .passe-expiracao { font-size: 0.85em; color: #a9b5c6; margin-top: 5px; }
    .passe-expiracao strong { color: #fbbf24; }

    .balance-row { display: flex; gap: 12px; margin-bottom: 25px; }
    .balance-mini {
      flex: 1; background: rgba(30,41,54,0.9);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
      padding: 15px; text-align: center;
    }
    .balance-mini-label { font-size: 0.75em; color: #a9b5c6; margin-bottom: 4px; }
    .balance-mini-value { font-size: 1.4em; font-weight: 700; color: #ffb547; }
    .balance-mini-value.green { color: #10b981; }

    .section-title {
      font-size: 1.2em; font-weight: 700; margin-bottom: 15px;
      display: flex; align-items: center; gap: 10px;
    }
    .passes-grid { display: grid; gap: 15px; margin-bottom: 30px; }

    .pass-card {
      background: linear-gradient(135deg, rgba(30,41,54,0.9), rgba(24,34,46,0.9));
      border-radius: 20px; padding: 25px; cursor: pointer;
      transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .pass-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .pass-card.semanal { border: 2px solid rgba(59,130,246,0.4); }
    .pass-card.semanal:hover { border-color: rgba(59,130,246,0.7); }
    .pass-card.mensal { border: 2px solid rgba(168,85,247,0.6); }
    .pass-card.mensal:hover { border-color: rgba(168,85,247,0.9); }
    .pass-card.anual { border: 2px solid rgba(245,158,11,0.6); }
    .pass-card.anual:hover { border-color: rgba(245,158,11,0.9); }

    .pass-card.mensal::before {
      content: '‚≠ê POPULAR'; position: absolute; top: 0; right: 0;
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: #fff; font-size: 0.65em; font-weight: 700;
      padding: 6px 14px; border-radius: 0 18px 0 12px;
    }
    .pass-card.anual::before {
      content: 'üëë MELHOR VALOR'; position: absolute; top: 0; right: 0;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #0e141b; font-size: 0.65em; font-weight: 700;
      padding: 6px 14px; border-radius: 0 18px 0 12px;
    }

    .pass-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .pass-nome { display: flex; align-items: center; gap: 10px; }
    .pass-icon {
      width: 50px; height: 50px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center; font-size: 1.5em;
    }
    .pass-card.semanal .pass-icon { background: rgba(59,130,246,0.2); }
    .pass-card.mensal .pass-icon { background: rgba(168,85,247,0.2); }
    .pass-card.anual .pass-icon { background: rgba(245,158,11,0.2); }
    .pass-titulo { font-size: 1.2em; font-weight: 700; }
    .pass-duracao { font-size: 0.8em; color: #a9b5c6; }
    .pass-preco { text-align: right; }
    .pass-valor { font-size: 1.6em; font-weight: 800; }
    .pass-card.semanal .pass-valor { color: #60a5fa; }
    .pass-card.mensal .pass-valor { color: #a78bfa; }
    .pass-card.anual .pass-valor { color: #fbbf24; }
    .pass-economia { font-size: 0.75em; color: #10b981; }
    .pass-pordia { font-size: 0.75em; color: #a9b5c6; }

    .pass-beneficios {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
      margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.08);
    }
    .beneficio { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
    .beneficio-check { color: #10b981; }

    .btn-comprar {
      width: 100%; padding: 14px; border: none; border-radius: 12px;
      font-family: 'Poppins', sans-serif; font-size: 1em; font-weight: 700;
      cursor: pointer; margin-top: 15px; transition: all 0.3s ease; color: #fff;
    }
    .btn-comprar:hover { transform: scale(1.02); }
    .pass-card.semanal .btn-comprar { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .pass-card.mensal .btn-comprar { background: linear-gradient(135deg, #a855f7, #7c3aed); }
    .pass-card.anual .btn-comprar { background: linear-gradient(135deg, #f59e0b, #d97706); color: #0e141b; }
    .btn-comprar:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    .compare-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 0.8em; }
    .compare-table th { padding: 12px 6px; text-align: center; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.1); }
    .compare-table th:first-child { text-align: left; }
    .compare-table td { padding: 10px 6px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .compare-table td:first-child { text-align: left; color: #a9b5c6; }
    .compare-table .col-free { color: #9ca3af; }
    .compare-table .col-semanal { color: #60a5fa; }
    .compare-table .col-mensal { color: #a78bfa; }
    .compare-table .col-anual { color: #fbbf24; font-weight: 600; }

    .info-card {
      background: linear-gradient(135deg, rgba(30,41,54,0.9), rgba(24,34,46,0.9));
      border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
      padding: 25px; margin-bottom: 20px;
    }
    .info-item {
      display: flex; gap: 15px; margin-bottom: 15px; padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .info-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .info-icon { font-size: 1.5em; width: 40px; text-align: center; }
    .info-text strong { display: block; margin-bottom: 3px; }
    .info-text span { font-size: 0.85em; color: #a9b5c6; }
    .payment-methods {
      display: flex; justify-content: center; gap: 20px;
      margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);
    }
    .payment-method {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85em;
    }
    .history-item {
      display: flex; justify-content: space-between; padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .history-item:last-child { border-bottom: none; }
    .status-approved { color: #10b981; }
    .status-pending { color: #f59e0b; }
    .status-expired { color: #ef4444; }

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999;
    }
    .loading-overlay.active { display: flex; }
    .loading-spinner {
      width: 50px; height: 50px;
      border: 4px solid rgba(255,181,71,0.2); border-top-color: #ffb547;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #1e293b, #334155);
      color: #fff; padding: 15px 25px; border-radius: 12px;
      font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      opacity: 0; transition: all 0.3s ease; z-index: 10000;
      border: 1px solid rgba(255,181,71,0.3); max-width: 90%; text-align: center;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(14,20,27,0.98); backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1); padding: 10px 0; z-index: 100;
    }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      text-decoration: none; color: #a9b5c6; font-size: 0.75em; transition: all 0.3s ease;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; margin-bottom: 4px; }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='painel.html'">‚Üê Voltar</button>
      <div class="logo">‚öΩ Yellup</div>
      <div style="width: 80px;"></div>
    </div>
  </header>

  <div class="container">
    <div class="page-title">
      <h1>üé´ Loja de Passes</h1>
      <p>Jogue sem limites!</p>
    </div>

    <div class="passe-status free" id="passeStatus">
      <div class="passe-status-label">Seu plano atual</div>
      <div class="passe-status-tipo" id="passeNome">‚öΩ Gratuito</div>
      <div class="passe-expiracao" id="passeExpiracao">2 partidas/dia ‚Ä¢ 1 PvP/dia</div>
    </div>

    <div class="balance-row">
      <div class="balance-mini">
        <div class="balance-mini-label">Cr√©ditos</div>
        <div class="balance-mini-value" id="currentBalance">0</div>
      </div>
      <div class="balance-mini">
        <div class="balance-mini-label">Partidas hoje</div>
        <div class="balance-mini-value green" id="partidasHoje">0/2</div>
      </div>
      <div class="balance-mini">
        <div class="balance-mini-label">PvP hoje</div>
        <div class="balance-mini-value green" id="pvpHoje">0/1</div>
      </div>
    </div>

    <div class="section-title">üé´ Escolha seu Passe</div>

    <div class="passes-grid">

      <div class="pass-card semanal" id="cardSemanal">
        <div class="pass-header">
          <div class="pass-nome">
            <div class="pass-icon">üåü</div>
            <div>
              <div class="pass-titulo">Passe Semanal</div>
              <div class="pass-duracao">V√°lido por 7 dias</div>
            </div>
          </div>
          <div class="pass-preco">
            <div class="pass-valor">R$ 9,90</div>
            <div class="pass-pordia">R$ 1,41/dia</div>
          </div>
        </div>
        <div class="pass-beneficios">
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Partidas ilimitadas</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> PvP ilimitado</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Timer 2min</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> 10 cr no ba√∫</div>
        </div>
        <button class="btn-comprar" id="btnSemanal" onclick="comprarPasse('semanal')">Comprar Passe Semanal</button>
      </div>

      <div class="pass-card mensal" id="cardMensal">
        <div class="pass-header">
          <div class="pass-nome">
            <div class="pass-icon">üíé</div>
            <div>
              <div class="pass-titulo">Passe Mensal</div>
              <div class="pass-duracao">V√°lido por 30 dias</div>
            </div>
          </div>
          <div class="pass-preco">
            <div class="pass-valor">R$ 19,90</div>
            <div class="pass-pordia">R$ 0,66/dia</div>
            <div class="pass-economia">Economize 53%</div>
          </div>
        </div>
        <div class="pass-beneficios">
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Partidas ilimitadas</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> PvP ilimitado</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Timer 2min</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> 15 cr no ba√∫</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Miss√µes √ó2</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Torneios Premium</div>
        </div>
        <button class="btn-comprar" id="btnMensal" onclick="comprarPasse('mensal')">Comprar Passe Mensal</button>
      </div>

      <div class="pass-card anual" id="cardAnual">
        <div class="pass-header">
          <div class="pass-nome">
            <div class="pass-icon">üëë</div>
            <div>
              <div class="pass-titulo">Passe Anual</div>
              <div class="pass-duracao">V√°lido por 365 dias</div>
            </div>
          </div>
          <div class="pass-preco">
            <div class="pass-valor">R$ 199,90</div>
            <div class="pass-pordia">R$ 0,55/dia</div>
            <div class="pass-economia">Economize 61% ‚Äî 2 meses gr√°tis!</div>
          </div>
        </div>
        <div class="pass-beneficios">
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Partidas ilimitadas</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> PvP ilimitado</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Timer 2min</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> 15 cr no ba√∫</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Miss√µes √ó2</div>
          <div class="beneficio"><span class="beneficio-check">‚úÖ</span> Torneios Premium</div>
        </div>
        <button class="btn-comprar" id="btnAnual" onclick="comprarPasse('anual')">Comprar Passe Anual</button>
      </div>

    </div>

    <div class="info-card">
      <div class="section-title">üìä Compara√ß√£o de Planos</div>
      <table class="compare-table">
        <thead>
          <tr>
            <th></th>
            <th class="col-free">Gr√°tis</th>
            <th class="col-semanal">Semanal</th>
            <th class="col-mensal">Mensal</th>
            <th class="col-anual">Anual</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Pre√ßo</td><td class="col-free">R$ 0</td><td class="col-semanal">R$ 9,90</td><td class="col-mensal">R$ 19,90</td><td class="col-anual">R$ 199,90</td></tr>
          <tr><td>Partidas/dia</td><td class="col-free">2</td><td class="col-semanal">‚àû</td><td class="col-mensal">‚àû</td><td class="col-anual">‚àû</td></tr>
          <tr><td>PvP/dia</td><td class="col-free">1</td><td class="col-semanal">‚àû</td><td class="col-mensal">‚àû</td><td class="col-anual">‚àû</td></tr>
          <tr><td>Timer</td><td class="col-free">5 min</td><td class="col-semanal">2 min</td><td class="col-mensal">2 min</td><td class="col-anual">2 min</td></tr>
          <tr><td>Ba√∫ di√°rio</td><td class="col-free">5 cr</td><td class="col-semanal">10 cr</td><td class="col-mensal">15 cr</td><td class="col-anual">15 cr</td></tr>
          <tr><td>Miss√µes/dia</td><td class="col-free">3</td><td class="col-semanal">5</td><td class="col-mensal">7</td><td class="col-anual">7</td></tr>
          <tr><td>Multi. miss√£o</td><td class="col-free">√ó1</td><td class="col-semanal">√ó1.5</td><td class="col-mensal">√ó2</td><td class="col-anual">√ó2</td></tr>
          <tr><td>Torneio Premium</td><td class="col-free">‚ùå</td><td class="col-semanal">‚ùå</td><td class="col-mensal">‚úÖ</td><td class="col-anual">‚úÖ</td></tr>
        </tbody>
      </table>
    </div>

    <div class="info-card">
      <div class="section-title">‚ùì Como funciona</div>
      <div class="info-item">
        <div class="info-icon">1Ô∏è‚É£</div>
        <div class="info-text"><strong>Escolha seu Passe</strong><span>Semanal para testar, Mensal para jogar s√©rio, Anual para o melhor custo!</span></div>
      </div>
      <div class="info-item">
        <div class="info-icon">2Ô∏è‚É£</div>
        <div class="info-text"><strong>Pague com seguran√ßa</strong><span>PIX instant√¢neo, cart√£o de cr√©dito ou boleto</span></div>
      </div>
      <div class="info-item">
        <div class="info-icon">3Ô∏è‚É£</div>
        <div class="info-text"><strong>Jogue sem limites</strong><span>Passe ativado na hora! Partidas e PvP ilimitados</span></div>
      </div>
      <div class="payment-methods">
        <div class="payment-method"><span>üè¶</span> PIX</div>
        <div class="payment-method"><span>üí≥</span> Cart√£o</div>
        <div class="payment-method"><span>üìÑ</span> Boleto</div>
      </div>
    </div>

    <div class="info-card">
      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
        <span>üìú Hist√≥rico de Passes</span>
        <button onclick="verificarPagamento()" style="background:linear-gradient(135deg,#3498db,#2980b9);border:none;color:white;padding:8px 16px;border-radius:8px;font-size:0.8em;cursor:pointer;font-family:Poppins;">üîÑ Verificar</button>
      </div>
      <div id="purchaseHistory"><p style="text-align:center;color:#a9b5c6;padding:20px;">Carregando...</p></div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><p>Preparando pagamento...</p></div>
  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span><span>In√≠cio</span></a>
      <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span><span>Ranking</span></a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span><span>Indicar</span></a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span><span>Perfil</span></a>
    </div>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    const PASSES = {
      semanal: { id: 'semanal', nome: 'Passe Semanal', preco: 9.90, duracao: '7 dias', emoji: 'üåü' },
      mensal: { id: 'mensal', nome: 'Passe Mensal', preco: 19.90, duracao: '30 dias', emoji: 'üíé' },
      anual: { id: 'anual', nome: 'Passe Anual', preco: 199.90, duracao: '365 dias', emoji: 'üëë' }
    };

    let currentUserId = null;
    let currentUserData = null;

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 4000);
    }
    function showLoading(show) {
      const el = document.getElementById('loadingOverlay');
      show ? el.classList.add('active') : el.classList.remove('active');
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUserId = user.uid;
      try {
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) { currentUserData = userDoc.data(); atualizarUI(); }
        await processarRetornoMP();
        await carregarHistorico();
      } catch (e) { console.error('Erro init:', e); }
    });

    function atualizarUI() {
      if (!currentUserData) return;
      document.getElementById('currentBalance').textContent = currentUserData.creditos || 0;

      const limites = currentUserData.limitesDiarios || {};
      const passe = currentUserData.passe || { tipo: 'free', ativo: false };
      const tipo = (passe.ativo && passe.tipo !== 'free') ? passe.tipo : 'free';
      const temPasse = tipo !== 'free';

      document.getElementById('partidasHoje').textContent = temPasse ? '‚àû' : `${limites.partidasHoje || 0}/2`;
      document.getElementById('pvpHoje').textContent = temPasse ? '‚àû' : `${limites.pvpHoje || 0}/1`;

      const statusEl = document.getElementById('passeStatus');
      const nomeEl = document.getElementById('passeNome');
      const expEl = document.getElementById('passeExpiracao');
      statusEl.className = 'passe-status ' + tipo;

      const nomeMap = { free: '‚öΩ Gratuito', semanal: 'üåü Passe Semanal', mensal: 'üíé Passe Mensal', anual: 'üëë Passe Anual' };
      nomeEl.textContent = nomeMap[tipo] || nomeMap.free;

      if (tipo === 'free') {
        expEl.textContent = '2 partidas/dia ‚Ä¢ 1 PvP/dia ‚Ä¢ Timer 5min';
      } else {
        const exp = passe.dataExpiracao?.toDate?.() || new Date(passe.dataExpiracao);
        expEl.innerHTML = `Ativo at√© <strong>${exp.toLocaleDateString('pt-BR')}</strong>`;
      }

      if (temPasse) {
        const btnMap = { semanal: 'btnSemanal', mensal: 'btnMensal', anual: 'btnAnual' };
        const btn = document.getElementById(btnMap[tipo]);
        if (btn) btn.textContent = 'üîÑ Estender Passe';
      }
    }

    async function comprarPasse(tipo) {
      const passe = PASSES[tipo];
      if (!passe) return;

      if (!currentUserData?.cpf) {
        showToast('‚ö†Ô∏è Cadastre seu CPF no perfil primeiro!');
        return;
      }

      showLoading(true);
      try {
        // Mesmo formato que loja-creditos (que funciona)
        const response = await fetch('/api/criar-pagamento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pacoteId: `passe_${tipo}`,
            creditos: 0,
            bonus: 0,
            preco: passe.preco,
            userId: currentUserId,
            userEmail: auth.currentUser?.email || '',
            userName: currentUserData?.nome || currentUserData?.usuarioUnico || 'An√¥nimo'
          })
        });
        const data = await response.json();
        console.log('üì° Resposta criar-pagamento:', data);
        if (data.success && data.initPoint) {
          // Salvar tipo do passe para usar no retorno
          localStorage.setItem('yellup_passe_tipo', tipo);
          window.location.href = data.initPoint;
        } else { throw new Error(data.error || 'Erro ao criar pagamento'); }
      } catch (e) {
        console.error('Erro:', e); showLoading(false);
        showToast('‚ùå Erro ao processar. Tente novamente.');
      }
    }

    async function processarRetornoMP() {
      const params = new URLSearchParams(window.location.search);
      const status = params.get('status');
      const paymentId = params.get('payment_id');
      const externalRef = params.get('external_reference') || params.get('ref');
      if (!status) return;
      window.history.replaceState({}, document.title, window.location.pathname);
      if (status === 'approved' || status === 'success') {
        await ativarPassePagamento(paymentId, externalRef);
      } else if (status === 'pending') {
        showToast('‚è≥ Pagamento pendente. Ap√≥s pagar, clique em "Verificar"');
      } else {
        showToast('‚ùå Pagamento n√£o aprovado. Tente novamente.');
      }
    }

    async function ativarPassePagamento(paymentId, externalRef) {
      try {
        let tipoPasse = 'semanal'; // default
        // Tentar extrair do externalRef (formato: passe_semanal_userId_timestamp)
        if (externalRef) {
          const parts = externalRef.split('_');
          if (parts.length >= 2 && ['semanal', 'mensal', 'anual'].includes(parts[1])) {
            tipoPasse = parts[1];
          }
        }
        // Fallback: localStorage (salvo antes do redirect)
        const savedTipo = localStorage.getItem('yellup_passe_tipo');
        if (savedTipo && ['semanal', 'mensal', 'anual'].includes(savedTipo)) {
          tipoPasse = savedTipo;
          localStorage.removeItem('yellup_passe_tipo');
        }
        const ativarPasseFn = functions.httpsCallable('ativarPasse');
        const res = await ativarPasseFn({ paymentId: paymentId || 'pix_' + Date.now(), tipoPasse });
        if (res.data.jaProcessado) { showToast('‚úÖ Este passe j√° foi ativado!'); }
        else { showToast(`üéâ ${PASSES[tipoPasse]?.nome || 'Passe'} ativado com sucesso!`); }
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) { currentUserData = userDoc.data(); atualizarUI(); }
      } catch (e) {
        console.error('Erro ativar:', e);
        showToast('‚ùå Erro ao ativar passe. Clique em Verificar.');
      }
    }

    async function verificarPagamento() {
      showToast('üîç Verificando pagamentos...');
      try {
        const resp = await fetch(`/api/verificar-pagamento?userId=${currentUserId}`);
        const data = await resp.json();
        if (data.approved && data.paymentId) {
          try {
            const ja = await db.collection('pagamentos_passe').doc(String(data.paymentId)).get();
            if (ja.exists) { showToast('‚úÖ Todos j√° foram ativados!'); return; }
          } catch (e) { /* permission issue, try to activate anyway */ }
          await ativarPassePagamento(data.paymentId, data.externalReference);
          await carregarHistorico();
        } else { showToast('‚è≥ Nenhum pagamento novo.'); }
      } catch (e) { console.error('Erro:', e); showToast('‚ùå Erro ao verificar.'); }
    }

    async function carregarHistorico() {
      try {
        let snap;
        const container = document.getElementById('purchaseHistory');
        try {
          snap = await db.collection('pagamentos_passe')
            .where('usuarioId', '==', currentUserId).limit(20).get();
        } catch (permErr) {
          // Fallback: tentar com uid
          try {
            snap = await db.collection('pagamentos_passe')
              .where('uid', '==', currentUserId).limit(20).get();
          } catch (e2) {
            console.log('Hist√≥rico: sem permiss√£o na collection pagamentos_passe');
            container.innerHTML = '<p style="text-align:center;color:#a9b5c6;padding:20px;">Hist√≥rico indispon√≠vel</p>';
            return;
          }
        }
        if (snap.empty) {
          container.innerHTML = '<p style="text-align:center;color:#a9b5c6;padding:20px;">Nenhum passe comprado ainda</p>';
          return;
        }
        let passes = [];
        snap.forEach(doc => passes.push({ id: doc.id, ...doc.data() }));
        passes.sort((a, b) => {
          const dA = a.dataAtivacao?.toDate ? a.dataAtivacao.toDate().getTime() : 0;
          const dB = b.dataAtivacao?.toDate ? b.dataAtivacao.toDate().getTime() : 0;
          return dB - dA;
        });
        const nomeMap = { semanal: 'üåü Semanal', mensal: 'üíé Mensal', anual: 'üëë Anual', diario: 'üìÖ Di√°rio' };
        const agora = new Date();
        let html = '';
        passes.forEach(p => {
          const dataStr = p.dataAtivacao?.toDate ? p.dataAtivacao.toDate().toLocaleDateString('pt-BR') : '...';
          const expStr = p.dataExpiracao?.toDate ? p.dataExpiracao.toDate().toLocaleDateString('pt-BR') : '...';
          const expirou = p.dataExpiracao?.toDate ? p.dataExpiracao.toDate() < agora : false;
          const nome = nomeMap[p.tipoPasse] || 'üé´ Passe';
          html += `<div class="history-item"><div><div style="font-weight:600;">${nome}</div><div style="font-size:0.8em;color:#a9b5c6;">${dataStr} ‚Üí ${expStr}</div></div><div style="text-align:right;"><div style="color:#ffb547;">R$ ${(p.valor||0).toFixed(2).replace('.',',')}</div><div class="${expirou?'status-expired':'status-approved'}" style="font-size:0.75em;">${expirou?'‚è∞ Expirado':'‚úÖ Ativo'}</div></div></div>`;
        });
        container.innerHTML = html;
      } catch (e) {
        console.error('Erro hist√≥rico:', e);
        document.getElementById('purchaseHistory').innerHTML = '<p style="text-align:center;color:#a9b5c6;padding:20px;">Erro ao carregar</p>';
      }
    }

    console.log('‚úÖ Loja de Passes v2.0 ‚Äî Semanal/Mensal/Anual');
  </script>
</body>
</html>
