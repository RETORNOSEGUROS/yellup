<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Desafio de P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e13">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- OG TAGS para preview bonito no WhatsApp/Facebook -->
  <meta property="og:title" content="‚öΩ Desafio de P√™naltis - Yellup">
  <meta property="og:description" content="Voc√™ foi desafiado para uma disputa de p√™naltis! Aceite e jogue agora.">
  <meta property="og:image" content="/icons/og-penaltis.png">
  <meta property="og:type" content="website">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0a0e13;--bg-card:#131920;--accent-primary:#ff9f43;--accent-secondary:#ffc048;--accent-glow:rgba(255,159,67,0.25);--win-green:#2ed573;--live-red:#ff4757;--text-primary:#f1f2f6;--text-secondary:#a4b0be}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;
      background-image:radial-gradient(ellipse at top,rgba(46,213,115,0.06) 0%,transparent 50%),radial-gradient(ellipse at bottom,rgba(26,34,48,0.5) 0%,transparent 50%);background-attachment:fixed}

    .logo{text-align:center;margin-bottom:24px}
    .logo img{height:42px;filter:drop-shadow(0 2px 8px rgba(255,181,71,.3))}

    .invite-card{max-width:420px;width:100%;background:linear-gradient(145deg,#1e2936,#18222e);border-radius:24px;padding:32px 28px;border:1px solid rgba(46,213,115,0.3);box-shadow:0 20px 60px rgba(0,0,0,0.5);animation:cardIn .5s cubic-bezier(.34,1.56,.64,1)}
    @keyframes cardIn{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}

    .invite-emoji{font-size:4em;text-align:center;margin-bottom:8px}
    .invite-title{font-size:1.4em;font-weight:800;text-align:center;margin-bottom:4px}
    .invite-subtitle{font-size:.85em;color:var(--text-secondary);text-align:center;margin-bottom:24px}

    .challenger-box{display:flex;align-items:center;gap:14px;padding:16px;background:rgba(0,0,0,.3);border-radius:16px;margin-bottom:18px;border:1px solid rgba(255,255,255,.06)}
    .challenger-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#ffb547,#ff8c42);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1em;color:var(--bg-dark);overflow:hidden;flex-shrink:0}
    .challenger-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .challenger-info{flex:1}
    .challenger-name{font-weight:700;font-size:1em}
    .challenger-team{font-size:.78em;color:var(--text-secondary);margin-top:2px;display:flex;align-items:center;gap:6px}
    .challenger-team svg{width:20px;height:24px}

    .bet-display{text-align:center;padding:20px;margin-bottom:18px;background:linear-gradient(135deg,rgba(255,159,67,.1),rgba(255,192,72,.05));border:1px solid rgba(255,159,67,.25);border-radius:16px}
    .bet-amount{font-size:2.2em;font-weight:900;color:var(--accent-secondary)}
    .bet-label{font-size:.8em;color:var(--text-secondary);margin-top:2px}
    .bet-prize{font-size:.85em;color:var(--win-green);font-weight:700;margin-top:6px}

    .timer-display{text-align:center;margin-bottom:20px}
    .timer-text{font-size:1.1em;font-weight:700;color:var(--accent-primary)}
    .timer-bar{height:4px;background:rgba(255,255,255,.08);border-radius:2px;margin-top:8px;overflow:hidden}
    .timer-bar-fill{height:100%;background:linear-gradient(90deg,var(--win-green),var(--accent-primary));border-radius:2px;transition:width 1s linear}

    /* TEAM PICKER */
    .team-section{margin-bottom:18px}
    .team-section-title{font-size:.82em;color:var(--text-secondary);margin-bottom:8px;text-align:center}
    .team-search{width:100%;padding:10px 14px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:.82em;outline:none;margin-bottom:8px}
    .team-search:focus{border-color:var(--accent-primary)}
    .team-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:200px;overflow-y:auto;padding:2px}
    .team-pick{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;border-radius:12px;border:2px solid transparent;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.03)}
    .team-pick:hover{background:rgba(255,255,255,.06)}
    .team-pick.selected{border-color:var(--accent-primary);background:rgba(255,159,67,.12)}
    .team-pick-shield{width:32px;height:38px;overflow:hidden}
    .team-pick-name{font-size:.58em;font-weight:600;color:var(--text-secondary);text-align:center;max-width:65px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .team-pick.selected .team-pick-name{color:var(--accent-primary)}

    .btn-accept-invite{width:100%;padding:16px;background:linear-gradient(135deg,var(--win-green),#7bed9f);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:800;font-size:1em;cursor:pointer;transition:all .3s;box-shadow:0 4px 20px rgba(46,213,115,.3);display:flex;align-items:center;justify-content:center;gap:10px}
    .btn-accept-invite:hover{transform:translateY(-2px)}.btn-accept-invite:active{transform:scale(.97)}
    .btn-accept-invite:disabled{opacity:.5;cursor:not-allowed;transform:none}

    .btn-login{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent-primary),#ff8c42);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:800;font-size:1em;cursor:pointer;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:8px}

    .error-state{text-align:center;padding:40px 20px}
    .error-icon{font-size:3.5em;margin-bottom:12px}
    .error-title{font-size:1.2em;font-weight:700;margin-bottom:6px}
    .error-text{font-size:.85em;color:var(--text-secondary);margin-bottom:20px}

    .credits-info{text-align:center;font-size:.8em;color:var(--text-secondary);margin-bottom:14px}
    .credits-info strong{color:var(--accent-secondary)}

    .loading-state{text-align:center;padding:60px 20px}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:3px solid rgba(255,159,67,.2);border-top-color:var(--accent-primary);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,.9);color:white;padding:15px 30px;border-radius:50px;font-weight:600;z-index:3000;opacity:0;transition:all .3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  </style>
</head>
<body>

  <div class="logo">
    <img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.6em;font-weight:800;color:#ffb547\'>YELLUP</span>'">
  </div>

  <div class="invite-card" id="inviteCard">
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
      <p>Carregando desafio...</p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // ===== CAMISETA SVG =====
    function gerarCamisetaSVG(c1,c2,c3){
      c1=c1||'#28a745';c2=c2||'#fff';c3=c3||c1;
      const u=Math.random().toString(36).substr(2,6);
      return `<svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="sh_${u}" x1=".2" y1="0" x2=".8" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,.28)"/><stop offset="45%" stop-color="rgba(255,255,255,.03)"/><stop offset="100%" stop-color="rgba(0,0,0,.08)"/></linearGradient><linearGradient id="sl_${u}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="100%" stop-color="${c3}"/></linearGradient></defs><g><path d="M28,32 Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 Q72,28 72,32 L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" fill="${c1}"/><path d="M28,32 L10,46 Q6,49 7,54 L10,68 Q11,72 15,70 L26,58 Z" fill="url(#sl_${u})"/><path d="M72,32 L90,46 Q94,49 93,54 L90,68 Q89,72 85,70 L74,58 Z" fill="url(#sl_${u})"/><path d="M26,40 L28,105" stroke="${c2}" stroke-width="3" opacity=".5" stroke-linecap="round"/><path d="M74,40 L72,105" stroke="${c2}" stroke-width="3" opacity=".5" stroke-linecap="round"/><path d="M28,32 Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 Q72,28 72,32 L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" fill="url(#sh_${u})"/><path d="M43,26 L50,32 L57,26" fill="none" stroke="${c2}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></g></svg>`;
    }

    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));

    const urlParams=new URLSearchParams(window.location.search);
    const matchId=urlParams.get('id');

    let matchData=null;
    let currentUser=null,currentUserData=null;
    let allTimes=[],selectedTimeId=null,selectedTimeData=null;
    let timerInterval=null;
    let accepting=false;

    if(!matchId){
      showError('üîó','Link Inv√°lido','Este link n√£o cont√©m um desafio v√°lido.');
    }

    auth.onAuthStateChanged(async user=>{
      currentUser=user;
      if(user){
        try{
          const doc=await db.collection('usuarios').doc(user.uid).get();
          if(doc.exists) currentUserData=doc.data();
        }catch(e){console.error(e)}
        // Logado ‚Üí carregar desafio
        if(matchId) carregarDesafio();
      }else{
        // N√ÉO logado ‚Üí mostrar tela de login direto (sem tentar ler Firestore)
        if(matchId) mostrarTelaLogin();
      }
    });

    function mostrarTelaLogin(){
      const card=document.getElementById('inviteCard');
      card.innerHTML=`
        <div class="invite-emoji">‚öΩ</div>
        <div class="invite-title">Desafio de P√™naltis!</div>
        <div class="invite-subtitle">Algu√©m te desafiou para uma disputa de p√™naltis na Yellup!</div>
        <div style="padding:20px;background:rgba(0,0,0,.3);border-radius:16px;margin:18px 0;text-align:center">
          <div style="font-size:2em;margin-bottom:8px">üèÜ</div>
          <div style="font-size:.9em;color:var(--text-secondary)">Entre ou crie sua conta para aceitar o desafio e disputar cr√©ditos!</div>
        </div>
        <button class="btn-accept-invite" onclick="window.location.href='index.html'" style="background:linear-gradient(135deg,var(--accent-primary),#ff8c42)">
          üöÄ Entrar / Criar Conta
        </button>
        <div style="text-align:center;margin-top:12px;font-size:.75em;color:var(--text-secondary)">√â gr√°tis e leva menos de 1 minuto</div>`;
    }

    async function carregarDesafio(){
      try{
        const doc=await db.collection('penaltis').doc(matchId).get();
        if(!doc.exists){showError('‚ùå','Desafio n√£o encontrado','Este desafio n√£o existe ou foi removido.');return}

        matchData={id:doc.id,...doc.data()};

        // Verificar status
        if(matchData.status==='em_andamento'){
          showError('‚ö°','Disputa em andamento','Algu√©m j√° aceitou este desafio!');return;
        }
        if(matchData.status==='finalizado'||matchData.status==='cancelado'){
          showError('‚è∞','Desafio encerrado','Este desafio j√° foi finalizado ou cancelado.');return;
        }

        // Verificar expira√ß√£o
        if(matchData.expiraEm){
          const expMs=(matchData.expiraEm.toDate?matchData.expiraEm.toDate():new Date(matchData.expiraEm)).getTime();
          if(Date.now()>expMs){
            showError('‚è∞','Tempo esgotado','Este desafio expirou. Pe√ßa ao jogador para criar um novo.');return;
          }
        }

        // Verificar se √© o pr√≥prio criador
        if(currentUser&&matchData.jogador1?.uid===currentUser.uid){
          showError('‚öΩ','Este √© seu desafio!','Compartilhe o link para algu√©m aceitar.\n\nVolte √† p√°gina de P√™naltis para gerenciar.', true);return;
        }

        // Tudo OK - mostrar convite
        await carregarTimes();
        renderConvite();

      }catch(e){
        console.error(e);
        // Se erro de permiss√£o e n√£o logado ‚Üí pedir login
        if(!currentUser && (e.code==='permission-denied'||e.message?.includes('permission'))){
          const card=document.getElementById('inviteCard');
          card.innerHTML=`
            <div class="invite-emoji">‚öΩ</div>
            <div class="invite-title">Desafio de P√™naltis!</div>
            <div class="invite-subtitle">Entre na Yellup para ver e aceitar este desafio</div>
            <div style="text-align:center;margin:20px 0">
              <div style="font-size:.85em;color:var(--text-secondary);margin-bottom:16px">Crie sua conta gr√°tis ou fa√ßa login para jogar!</div>
              <button class="btn-accept-invite" onclick="window.location.href='index.html'" style="background:linear-gradient(135deg,var(--accent-primary),#ff8c42)">
                üöÄ Entrar / Criar Conta
              </button>
            </div>`;
        }else{
          showError('‚ùå','Erro','N√£o foi poss√≠vel carregar o desafio.');
        }
      }
    }

    async function carregarTimes(){
      try{
        const snap=await db.collection('times').orderBy('nome').get();
        allTimes=[];
        snap.forEach(doc=>{
          const d=doc.data();
          allTimes.push({id:doc.id,nome:d.nome||'Time',abreviacao:d.abreviacao||d.nome?.substring(0,3).toUpperCase()||'???',primaria:d.primaria||'#333',secundaria:d.secundaria||'#fff',terciaria:d.terciaria||'#333'});
        });
        // Pre-select favorite
        if(currentUserData?.timeId){
          const fav=allTimes.find(t=>t.id===currentUserData.timeId);
          if(fav){selectedTimeId=fav.id;selectedTimeData=fav}
        }
      }catch(e){console.error('Times:',e)}
    }

    function renderConvite(){
      const j1=matchData.jogador1;
      const valor=matchData.valorAposta;
      const card=document.getElementById('inviteCard');

      // Challenger info
      const avatarHtml=j1.avatarUrl
        ?`<img src="${j1.avatarUrl}">`
        :`${(j1.nome||'J').charAt(0).toUpperCase()}`;

      let teamHtml='';
      if(j1.time){
        const jersey=gerarCamisetaSVG(j1.time.primaria,j1.time.secundaria,j1.time.terciaria);
        teamHtml=`<div class="challenger-team">${jersey} ${j1.time.nome}</div>`;
      }

      // Timer
      let timerHtml='';
      if(matchData.expiraEm){
        const expMs=(matchData.expiraEm.toDate?matchData.expiraEm.toDate():new Date(matchData.expiraEm)).getTime();
        const restante=Math.max(0,Math.floor((expMs-Date.now())/1000));
        const min=Math.floor(restante/60),seg=restante%60;
        timerHtml=`
          <div class="timer-display">
            <div class="timer-text" id="timerText">‚è∞ ${min}:${String(seg).padStart(2,'0')}</div>
            <div class="timer-bar"><div class="timer-bar-fill" id="timerBar" style="width:${(restante/300)*100}%"></div></div>
          </div>`;
      }

      // Credits info + buttons
      let actionHtml='';
      if(!currentUser){
        actionHtml=`
          <div style="text-align:center;font-size:.85em;color:var(--text-secondary);margin-bottom:12px">
            Entre na Yellup para aceitar o desafio!
          </div>
          <button class="btn-login" onclick="window.location.href='index.html?redirect=convite-penalti.html?id=${matchId}'">
            üöÄ Entrar / Criar Conta
          </button>`;
      }else{
        const meusCred=currentUserData?.creditos||0;
        const temCreditos=meusCred>=valor;
        actionHtml=`
          <div class="credits-info">Seus cr√©ditos: <strong>üí∞ ${meusCred.toLocaleString()}</strong></div>
          <div class="team-section">
            <div class="team-section-title">üéΩ Escolha seu time (opcional)</div>
            <input type="text" class="team-search" id="teamSearch" placeholder="üîç Buscar time..." oninput="filtrarTimes()">
            <div class="team-grid" id="teamGrid"></div>
          </div>
          <button class="btn-accept-invite" id="btnAceitar" onclick="aceitarDesafio()" ${temCreditos?'':'disabled'}>
            ${temCreditos?`‚öΩ Aceitar Desafio! (${valor} cr√©ditos)`:'‚ùå Cr√©ditos insuficientes'}
          </button>
          ${!temCreditos?'<div style="text-align:center;margin-top:10px"><a href="loja-creditos.html" style="color:var(--accent-primary);font-size:.85em;font-weight:600">üí∞ Comprar cr√©ditos ‚Üí</a></div>':''}`;
      }

      card.innerHTML=`
        <div class="invite-emoji">‚öΩ</div>
        <div class="invite-title">Desafio de P√™naltis!</div>
        <div class="invite-subtitle">Voc√™ foi desafiado para uma disputa</div>

        <div class="challenger-box">
          <div class="challenger-avatar" ${j1.time?`style="background:linear-gradient(135deg,${j1.time.primaria},${j1.time.secundaria})"`:''}>
            ${avatarHtml}
          </div>
          <div class="challenger-info">
            <div class="challenger-name">${j1.nome||'Jogador'}</div>
            ${teamHtml}
          </div>
        </div>

        <div class="bet-display">
          <div class="bet-amount">üí∞ ${valor}</div>
          <div class="bet-label">cr√©ditos cada jogador</div>
          <div class="bet-prize">üèÜ Pr√™mio: ${valor*2} cr√©ditos</div>
        </div>

        ${timerHtml}
        ${actionHtml}
      `;

      // Render team grid
      if(currentUser) renderTeamGrid();

      // Start countdown
      if(matchData.expiraEm) iniciarContagem();
    }

    function renderTeamGrid(filter=''){
      const c=document.getElementById('teamGrid');
      if(!c) return;
      const list=filter?allTimes.filter(t=>t.nome.toLowerCase().includes(filter.toLowerCase())):allTimes;
      if(!list.length){c.innerHTML='<div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:.75em;padding:12px">'+(filter?'Nenhum encontrado':'Sem times')+'</div>';return}
      c.innerHTML=list.map(t=>{
        const sel=selectedTimeId===t.id?'selected':'';
        const jersey=gerarCamisetaSVG(t.primaria,t.secundaria,t.terciaria);
        return `<div class="team-pick ${sel}" onclick="selectTeam('${t.id}')"><div class="team-pick-shield">${jersey}</div><div class="team-pick-name">${t.nome}</div></div>`;
      }).join('');
    }

    function selectTeam(id){
      const t=allTimes.find(x=>x.id===id);
      if(selectedTimeId===id){selectedTimeId=null;selectedTimeData=null}
      else{selectedTimeId=id;selectedTimeData=t}
      renderTeamGrid(document.getElementById('teamSearch')?.value||'');
    }
    function filtrarTimes(){renderTeamGrid(document.getElementById('teamSearch')?.value||'')}

    function iniciarContagem(){
      const expMs=(matchData.expiraEm.toDate?matchData.expiraEm.toDate():new Date(matchData.expiraEm)).getTime();
      clearInterval(timerInterval);
      timerInterval=setInterval(()=>{
        const restante=Math.max(0,Math.floor((expMs-Date.now())/1000));
        const min=Math.floor(restante/60),seg=restante%60;
        const timerText=document.getElementById('timerText');
        const timerBar=document.getElementById('timerBar');
        if(timerText) timerText.textContent=`‚è∞ ${min}:${String(seg).padStart(2,'0')}`;
        if(timerBar) timerBar.style.width=`${(restante/300)*100}%`;
        if(restante<=0){
          clearInterval(timerInterval);
          showError('‚è∞','Tempo esgotado','Este desafio expirou.');
        }
      },1000);
    }

    // ===== ACEITAR - FIRST COME FIRST SERVED =====
    async function aceitarDesafio(){
      if(accepting) return;
      accepting=true;
      const btn=document.getElementById('btnAceitar');
      if(btn){btn.disabled=true;btn.textContent='‚è≥ Aceitando...';}

      try{
        // Re-read match to ensure it's still available (race condition protection)
        const freshDoc=await db.collection('penaltis').doc(matchId).get();
        if(!freshDoc.exists){showToast('‚ùå Desafio n√£o encontrado');accepting=false;return}
        const fresh=freshDoc.data();

        if(fresh.status!=='aguardando'){
          showError('‚ö°','Desafio j√° aceito','Algu√©m foi mais r√°pido!');return;
        }

        // Check expiration
        if(fresh.expiraEm){
          const expMs=(fresh.expiraEm.toDate?fresh.expiraEm.toDate():new Date(fresh.expiraEm)).getTime();
          if(Date.now()>expMs){showError('‚è∞','Tempo esgotado','Este desafio expirou.');return}
        }

        const valor=fresh.valorAposta;
        const meusCred=currentUserData?.creditos||0;
        if(meusCred<valor){showToast('‚ùå Cr√©ditos insuficientes');accepting=false;if(btn){btn.disabled=false;btn.textContent=`‚öΩ Aceitar Desafio! (${valor} cr√©ditos)`}return}

        // Deduct credits
        const nome=currentUserData.usuarioUnico||currentUserData.usuario||currentUserData.nome||'Jogador';
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(-valor)});

        // Build player data
        const j2={uid:currentUser.uid,nome,avatarUrl:currentUserData.avatarUrl||null};
        if(selectedTimeData) j2.time={id:selectedTimeData.id,nome:selectedTimeData.nome,primaria:selectedTimeData.primaria,secundaria:selectedTimeData.secundaria,terciaria:selectedTimeData.terciaria,abreviacao:selectedTimeData.abreviacao};

        // Update match - FIRST to write wins
        await db.collection('penaltis').doc(matchId).update({
          jogador2:j2,
          status:'em_andamento'
        });

        // Extrato
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({
          tipo:'saida',valor,descricao:`P√™naltis: aposta de ${valor} cr√©ditos`,
          data:firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('‚úÖ Aceito! Entrando na arena...');
        clearInterval(timerInterval);
        setTimeout(()=>window.location.href=`arena-penalti.html?id=${matchId}`,800);

      }catch(e){
        console.error('Aceitar:',e);
        // If update fails (someone else accepted first), the match status changed
        if(e.code==='not-found'||e.code==='permission-denied'){
          showError('‚ö°','Desafio j√° aceito','Algu√©m foi mais r√°pido!');
        }else{
          showToast('‚ùå Erro ao aceitar');
          accepting=false;
          if(btn){btn.disabled=false;btn.textContent=`‚öΩ Aceitar Desafio!`}
        }
      }
    }

    function showError(icon, title, text, showPenaltisLink=false){
      clearInterval(timerInterval);
      const card=document.getElementById('inviteCard');
      card.innerHTML=`
        <div class="error-state">
          <div class="error-icon">${icon}</div>
          <div class="error-title">${title}</div>
          <div class="error-text">${text.replace(/\n/g,'<br>')}</div>
          <button class="btn-login" onclick="window.location.href='penaltis.html'" style="background:linear-gradient(135deg,var(--win-green),#7bed9f)">
            ‚öΩ Ir para P√™naltis
          </button>
          ${showPenaltisLink?'':'<button class="btn-login" onclick="window.location.href=\'painel.html\'" style="background:rgba(255,255,255,.08);color:var(--text-secondary);border:1px solid rgba(255,255,255,.1);margin-top:8px">üè† P√°gina Inicial</button>'}
        </div>`;
    }

    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
