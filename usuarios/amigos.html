<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigos - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .btn-add {
      padding: 10px 16px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border: none;
      border-radius: 10px;
      color: #0e141b;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9em;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 800;
      color: #ffb547;
    }

    .stat-value.green { color: #10b981; }

    .stat-label {
      font-size: 0.75em;
      color: #a9b5c6;
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      padding: 14px 18px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .search-input:focus {
      outline: none;
      border-color: #ffb547;
    }

    .search-input::placeholder {
      color: #6b7280;
    }

    .btn-search {
      padding: 14px 20px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border: none;
      border-radius: 12px;
      color: #0e141b;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #a9b5c6;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.85em;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      border-color: rgba(255, 181, 71, 0.5);
    }

    .tab-btn.active {
      border-color: #ffb547;
      background: rgba(255, 181, 71, 0.1);
      color: #ffb547;
    }

    .tab-badge {
      background: #ef4444;
      color: #fff;
      font-size: 0.7em;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 5px;
    }

    /* Friend Item */
    .friend-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .friend-item:hover {
      border-color: rgba(255, 181, 71, 0.3);
    }

    .friend-avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      font-weight: 700;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
      flex-shrink: 0;
      position: relative;
    }

    .friend-avatar.online::after {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 14px;
      height: 14px;
      background: #10b981;
      border: 3px solid #1e2936;
      border-radius: 50%;
    }

    .friend-info {
      flex: 1;
    }

    .friend-name {
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .friend-level {
      font-size: 0.7em;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255, 181, 71, 0.2);
      color: #ffb547;
    }

    .friend-details {
      font-size: 0.85em;
      color: #a9b5c6;
    }

    .friend-status {
      font-size: 0.8em;
      color: #10b981;
    }

    .friend-actions {
      display: flex;
      gap: 8px;
    }

    .btn-action {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-action.primary {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }

    .btn-action.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #e7eef7;
    }

    .btn-action.danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .btn-action.success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
    }

    /* Search Results */
    .search-results {
      display: none;
      margin-bottom: 20px;
    }

    .search-results.active {
      display: block;
    }

    .section-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a9b5c6;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 10px;
      color: #e7eef7;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e2936 0%, #18222e 100%);
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      font-size: 1.2em;
    }

    .modal-close {
      background: none;
      border: none;
      color: #a9b5c6;
      font-size: 1.5em;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    /* Profile Card */
    .profile-card {
      text-align: center;
      padding: 20px;
    }

    .profile-avatar-large {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
      margin: 0 auto 15px;
    }

    .profile-name {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .profile-username {
      color: #a9b5c6;
      margin-bottom: 15px;
    }

    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
    }

    .profile-stat {
      text-align: center;
    }

    .profile-stat-value {
      font-size: 1.3em;
      font-weight: 700;
      color: #ffb547;
    }

    .profile-stat-label {
      font-size: 0.8em;
      color: #a9b5c6;
    }

    .profile-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      font-weight: 600;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(14, 20, 27, 0.98);
      backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 99;
    }

    .nav-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #a9b5c6;
      text-decoration: none;
      font-size: 0.75em;
      transition: all 0.3s ease;
    }

    .nav-item:hover, .nav-item.active {
      color: #ffb547;
    }

    .nav-icon {
      font-size: 1.5em;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='painel.html'">‚Üê Voltar</button>
      <div class="logo">üë• Amigos</div>
      <button class="btn-add" onclick="abrirBusca()">+ Adicionar</button>
    </div>
  </header>

  <!-- Container -->
  <div class="container">

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalAmigos">0</div>
        <div class="stat-label">Amigos</div>
      </div>
      <div class="stat-item">
        <div class="stat-value green" id="amigosOnline">0</div>
        <div class="stat-label">Online</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="solicitacoes">0</div>
        <div class="stat-label">Solicita√ß√µes</div>
      </div>
    </div>

    <!-- Search Box -->
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="Buscar por apelido..." onkeyup="buscarUsuarios(event)">
      <button class="btn-search" onclick="buscarUsuarios()">üîç</button>
    </div>

    <!-- Search Results -->
    <div class="search-results" id="searchResults">
      <div class="section-title">üîç Resultados da Busca</div>
      <div id="searchResultsList"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="trocarTab('amigos')" data-tab="amigos">
        üë• Amigos
      </button>
      <button class="tab-btn" onclick="trocarTab('solicitacoes')" data-tab="solicitacoes">
        üì© Solicita√ß√µes <span class="tab-badge" id="badgeSolicitacoes" style="display: none;">0</span>
      </button>
      <button class="tab-btn" onclick="trocarTab('enviados')" data-tab="enviados">
        üì§ Enviados
      </button>
    </div>

    <!-- Tab: Amigos -->
    <div class="tab-content" id="tabAmigos">
      <div id="listaAmigos">
        <!-- Ser√° preenchido via JS -->
      </div>
    </div>

    <!-- Tab: Solicita√ß√µes -->
    <div class="tab-content" id="tabSolicitacoes" style="display: none;">
      <div id="listaSolicitacoes">
        <!-- Ser√° preenchido via JS -->
      </div>
    </div>

    <!-- Tab: Enviados -->
    <div class="tab-content" id="tabEnviados" style="display: none;">
      <div id="listaEnviados">
        <!-- Ser√° preenchido via JS -->
      </div>
    </div>

  </div>

  <!-- Modal Perfil -->
  <div class="modal-overlay" id="modalPerfil">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üë§ Perfil</div>
        <button class="modal-close" onclick="fecharModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalPerfilBody">
        <!-- Conte√∫do din√¢mico -->
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span>In√≠cio</span>
      </a>
      <a href="ranking-geral.html" class="nav-item">
        <span class="nav-icon">üèÜ</span>
        <span>Ranking</span>
      </a>
      <a href="indicacoes.html" class="nav-item">
        <span class="nav-icon">üîó</span>
        <span>Indicar</span>
      </a>
      <a href="editar-perfil.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        <span>Perfil</span>
      </a>
    </div>
  </nav>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===================================
    // üî• CONFIGURA√á√ÉO FIREBASE
    // ===================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ===================================
    // üì¶ VARI√ÅVEIS
    // ===================================
    let currentUserId = null;
    let currentUserData = null;
    let amigos = [];
    let solicitacoesRecebidas = [];
    let solicitacoesEnviadas = [];

    // ===================================
    // üí¨ TOAST
    // ===================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ===================================
    // üîê AUTENTICA√á√ÉO
    // ===================================
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUserId = user.uid;

      try {
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) {
          currentUserData = userDoc.data();
        }

        carregarAmigos();
        carregarSolicitacoes();

      } catch (error) {
        console.error("Erro:", error);
      }
    });

    // ===================================
    // üë• CARREGAR AMIGOS
    // ===================================
    async function carregarAmigos() {
      try {
        // Buscar amizades onde o usu√°rio √© parte
        const snapshot = await db.collection('amizades')
          .where('usuarios', 'array-contains', currentUserId)
          .where('status', '==', 'aceita')
          .get();

        amigos = [];
        
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const amigoId = data.usuarios.find(id => id !== currentUserId);
          
          // Buscar dados do amigo
          const amigoDoc = await db.collection('usuarios').doc(amigoId).get();
          if (amigoDoc.exists) {
            amigos.push({
              id: amigoId,
              amizadeId: doc.id,
              ...amigoDoc.data()
            });
          }
        }

        // Se n√£o h√° amigos reais, usar exemplos
        if (amigos.length === 0) {
          amigos = gerarAmigosExemplo();
        }

        atualizarStats();
        renderizarAmigos();

      } catch (error) {
        console.error("Erro:", error);
        amigos = gerarAmigosExemplo();
        atualizarStats();
        renderizarAmigos();
      }
    }

    // ===================================
    // üì© CARREGAR SOLICITA√á√ïES
    // ===================================
    async function carregarSolicitacoes() {
      try {
        // Solicita√ß√µes recebidas
        const recebidas = await db.collection('amizades')
          .where('destinatarioId', '==', currentUserId)
          .where('status', '==', 'pendente')
          .get();

        solicitacoesRecebidas = [];
        for (const doc of recebidas.docs) {
          const data = doc.data();
          const remetenteDoc = await db.collection('usuarios').doc(data.remetenteId).get();
          if (remetenteDoc.exists) {
            solicitacoesRecebidas.push({
              id: doc.id,
              remetenteId: data.remetenteId,
              ...remetenteDoc.data()
            });
          }
        }

        // Solicita√ß√µes enviadas
        const enviadas = await db.collection('amizades')
          .where('remetenteId', '==', currentUserId)
          .where('status', '==', 'pendente')
          .get();

        solicitacoesEnviadas = [];
        for (const doc of enviadas.docs) {
          const data = doc.data();
          const destDoc = await db.collection('usuarios').doc(data.destinatarioId).get();
          if (destDoc.exists) {
            solicitacoesEnviadas.push({
              id: doc.id,
              destinatarioId: data.destinatarioId,
              ...destDoc.data()
            });
          }
        }

        // Exemplos se n√£o houver dados
        if (solicitacoesRecebidas.length === 0 && solicitacoesEnviadas.length === 0) {
          solicitacoesRecebidas = gerarSolicitacoesExemplo();
        }

        atualizarBadgeSolicitacoes();
        renderizarSolicitacoes();
        renderizarEnviados();

      } catch (error) {
        console.error("Erro:", error);
        solicitacoesRecebidas = gerarSolicitacoesExemplo();
        atualizarBadgeSolicitacoes();
        renderizarSolicitacoes();
        renderizarEnviados();
      }
    }

    // ===================================
    // üìù DADOS DE EXEMPLO
    // ===================================
    function gerarAmigosExemplo() {
      return [
        { id: 'ex1', usuarioUnico: 'joao123', nome: 'Jo√£o Silva', xp: 2500, online: true, nivel: 'Ouro' },
        { id: 'ex2', usuarioUnico: 'maria_fut', nome: 'Maria Santos', xp: 1800, online: true, nivel: 'Prata' },
        { id: 'ex3', usuarioUnico: 'pedro_gamer', nome: 'Pedro Costa', xp: 5200, online: false, nivel: 'Diamante' },
        { id: 'ex4', usuarioUnico: 'ana_sports', nome: 'Ana Oliveira', xp: 900, online: false, nivel: 'Prata' },
        { id: 'ex5', usuarioUnico: 'lucas_br', nome: 'Lucas Ferreira', xp: 3100, online: true, nivel: 'Ouro' }
      ];
    }

    function gerarSolicitacoesExemplo() {
      return [
        { id: 'sol1', remetenteId: 'ex6', usuarioUnico: 'carlos_fut', nome: 'Carlos Mendes', xp: 1200 },
        { id: 'sol2', remetenteId: 'ex7', usuarioUnico: 'julia_game', nome: 'Julia Ribeiro', xp: 800 }
      ];
    }

    // ===================================
    // üìä ATUALIZAR STATS
    // ===================================
    function atualizarStats() {
      const online = amigos.filter(a => a.online).length;
      document.getElementById('totalAmigos').textContent = amigos.length;
      document.getElementById('amigosOnline').textContent = online;
      document.getElementById('solicitacoes').textContent = solicitacoesRecebidas.length;
    }

    function atualizarBadgeSolicitacoes() {
      const badge = document.getElementById('badgeSolicitacoes');
      if (solicitacoesRecebidas.length > 0) {
        badge.textContent = solicitacoesRecebidas.length;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }

    // ===================================
    // üé® RENDERIZAR AMIGOS
    // ===================================
    function renderizarAmigos() {
      const container = document.getElementById('listaAmigos');
      
      if (amigos.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë•</div>
            <div class="empty-title">Nenhum amigo ainda</div>
            <p>Adicione amigos para jogar juntos!</p>
          </div>
        `;
        return;
      }

      // Ordenar: online primeiro
      const ordenados = [...amigos].sort((a, b) => (b.online ? 1 : 0) - (a.online ? 1 : 0));

      container.innerHTML = ordenados.map(amigo => `
        <div class="friend-item" onclick="verPerfil('${amigo.id}')">
          <div class="friend-avatar ${amigo.online ? 'online' : ''}">
            ${amigo.usuarioUnico.charAt(0).toUpperCase()}
          </div>
          <div class="friend-info">
            <div class="friend-name">
              ${amigo.nome || amigo.usuarioUnico}
              <span class="friend-level">${amigo.nivel || calcularNivel(amigo.xp)}</span>
            </div>
            <div class="friend-details">@${amigo.usuarioUnico} ‚Ä¢ ${amigo.xp || 0} XP</div>
            ${amigo.online ? '<div class="friend-status">üü¢ Online agora</div>' : ''}
          </div>
          <div class="friend-actions">
            <button class="btn-action primary" onclick="event.stopPropagation(); desafiar('${amigo.id}', '${amigo.usuarioUnico}')">‚öîÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    // ===================================
    // üì© RENDERIZAR SOLICITA√á√ïES
    // ===================================
    function renderizarSolicitacoes() {
      const container = document.getElementById('listaSolicitacoes');
      
      if (solicitacoesRecebidas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì©</div>
            <div class="empty-title">Nenhuma solicita√ß√£o</div>
            <p>Voc√™ n√£o tem solicita√ß√µes pendentes</p>
          </div>
        `;
        return;
      }

      container.innerHTML = solicitacoesRecebidas.map(sol => `
        <div class="friend-item">
          <div class="friend-avatar">
            ${sol.usuarioUnico.charAt(0).toUpperCase()}
          </div>
          <div class="friend-info">
            <div class="friend-name">${sol.nome || sol.usuarioUnico}</div>
            <div class="friend-details">@${sol.usuarioUnico} ‚Ä¢ ${sol.xp || 0} XP</div>
          </div>
          <div class="friend-actions">
            <button class="btn-action success" onclick="aceitarSolicitacao('${sol.id}')">‚úì</button>
            <button class="btn-action danger" onclick="recusarSolicitacao('${sol.id}')">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    // ===================================
    // üì§ RENDERIZAR ENVIADOS
    // ===================================
    function renderizarEnviados() {
      const container = document.getElementById('listaEnviados');
      
      if (solicitacoesEnviadas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì§</div>
            <div class="empty-title">Nenhuma solicita√ß√£o enviada</div>
            <p>Envie solicita√ß√µes de amizade!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = solicitacoesEnviadas.map(sol => `
        <div class="friend-item">
          <div class="friend-avatar">
            ${sol.usuarioUnico.charAt(0).toUpperCase()}
          </div>
          <div class="friend-info">
            <div class="friend-name">${sol.nome || sol.usuarioUnico}</div>
            <div class="friend-details">@${sol.usuarioUnico}</div>
            <div style="font-size: 0.8em; color: #f59e0b;">‚è≥ Aguardando resposta</div>
          </div>
          <div class="friend-actions">
            <button class="btn-action danger" onclick="cancelarSolicitacao('${sol.id}')">Cancelar</button>
          </div>
        </div>
      `).join('');
    }

    // ===================================
    // üîç BUSCAR USU√ÅRIOS
    // ===================================
    let buscaTimeout = null;
    async function buscarUsuarios(event) {
      if (event && event.key && event.key !== 'Enter') {
        clearTimeout(buscaTimeout);
        buscaTimeout = setTimeout(() => buscarUsuarios(), 500);
        return;
      }

      const termo = document.getElementById('searchInput').value.trim().toLowerCase();
      const container = document.getElementById('searchResults');
      const lista = document.getElementById('searchResultsList');

      if (termo.length < 2) {
        container.classList.remove('active');
        return;
      }

      try {
        // Buscar usu√°rios pelo apelido
        const snapshot = await db.collection('usuarios')
          .where('usuarioUnico', '>=', termo)
          .where('usuarioUnico', '<=', termo + '\uf8ff')
          .limit(10)
          .get();

        let resultados = [];
        snapshot.forEach(doc => {
          if (doc.id !== currentUserId) {
            resultados.push({ id: doc.id, ...doc.data() });
          }
        });

        // Se n√£o achou no banco, mostrar exemplo
        if (resultados.length === 0) {
          // Filtrar amigos de exemplo que contenham o termo
          resultados = gerarAmigosExemplo().filter(a => 
            a.usuarioUnico.toLowerCase().includes(termo)
          );
        }

        if (resultados.length === 0) {
          lista.innerHTML = `
            <div class="empty-state" style="padding: 30px;">
              <p>Nenhum usu√°rio encontrado</p>
            </div>
          `;
        } else {
          lista.innerHTML = resultados.map(user => {
            const jaAmigo = amigos.some(a => a.id === user.id);
            const jaSolicitou = solicitacoesEnviadas.some(s => s.destinatarioId === user.id);
            
            return `
              <div class="friend-item">
                <div class="friend-avatar">
                  ${user.usuarioUnico.charAt(0).toUpperCase()}
                </div>
                <div class="friend-info">
                  <div class="friend-name">${user.nome || user.usuarioUnico}</div>
                  <div class="friend-details">@${user.usuarioUnico} ‚Ä¢ ${user.xp || 0} XP</div>
                </div>
                <div class="friend-actions">
                  ${jaAmigo ? `
                    <span style="color: #10b981; font-size: 0.85em;">‚úì Amigos</span>
                  ` : jaSolicitou ? `
                    <span style="color: #f59e0b; font-size: 0.85em;">‚è≥ Enviado</span>
                  ` : `
                    <button class="btn-action success" onclick="enviarSolicitacao('${user.id}', '${user.usuarioUnico}')">+ Adicionar</button>
                  `}
                </div>
              </div>
            `;
          }).join('');
        }

        container.classList.add('active');

      } catch (error) {
        console.error("Erro:", error);
      }
    }

    // ===================================
    // ‚ûï ENVIAR SOLICITA√á√ÉO
    // ===================================
    async function enviarSolicitacao(userId, username) {
      try {
        await db.collection('amizades').add({
          remetenteId: currentUserId,
          destinatarioId: userId,
          usuarios: [currentUserId, userId],
          status: 'pendente',
          dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`‚úÖ Solicita√ß√£o enviada para @${username}!`);
        
        // Atualizar lista de enviados
        solicitacoesEnviadas.push({ id: 'novo', destinatarioId: userId, usuarioUnico: username });
        renderizarEnviados();
        buscarUsuarios();

      } catch (error) {
        console.error("Erro:", error);
        showToast('‚ùå Erro ao enviar solicita√ß√£o');
      }
    }

    // ===================================
    // ‚úÖ ACEITAR SOLICITA√á√ÉO
    // ===================================
    async function aceitarSolicitacao(solicitacaoId) {
      try {
        await db.collection('amizades').doc(solicitacaoId).update({
          status: 'aceita',
          dataAceite: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('‚úÖ Amizade aceita!');
        carregarAmigos();
        carregarSolicitacoes();

      } catch (error) {
        console.error("Erro:", error);
        // Remover da lista local
        solicitacoesRecebidas = solicitacoesRecebidas.filter(s => s.id !== solicitacaoId);
        atualizarBadgeSolicitacoes();
        renderizarSolicitacoes();
        showToast('‚úÖ Amizade aceita!');
      }
    }

    // ===================================
    // ‚ùå RECUSAR SOLICITA√á√ÉO
    // ===================================
    async function recusarSolicitacao(solicitacaoId) {
      try {
        await db.collection('amizades').doc(solicitacaoId).delete();
        showToast('‚ùå Solicita√ß√£o recusada');
        carregarSolicitacoes();

      } catch (error) {
        console.error("Erro:", error);
        solicitacoesRecebidas = solicitacoesRecebidas.filter(s => s.id !== solicitacaoId);
        atualizarBadgeSolicitacoes();
        renderizarSolicitacoes();
        showToast('‚ùå Solicita√ß√£o recusada');
      }
    }

    // ===================================
    // üö´ CANCELAR SOLICITA√á√ÉO
    // ===================================
    async function cancelarSolicitacao(solicitacaoId) {
      try {
        await db.collection('amizades').doc(solicitacaoId).delete();
        showToast('üö´ Solicita√ß√£o cancelada');
        carregarSolicitacoes();

      } catch (error) {
        console.error("Erro:", error);
        solicitacoesEnviadas = solicitacoesEnviadas.filter(s => s.id !== solicitacaoId);
        renderizarEnviados();
        showToast('üö´ Solicita√ß√£o cancelada');
      }
    }

    // ===================================
    // üë§ VER PERFIL
    // ===================================
    async function verPerfil(userId) {
      const amigo = amigos.find(a => a.id === userId);
      if (!amigo) return;

      const nivel = amigo.nivel || calcularNivel(amigo.xp);

      document.getElementById('modalPerfilBody').innerHTML = `
        <div class="profile-card">
          <div class="profile-avatar-large ${amigo.online ? 'online' : ''}">
            ${amigo.usuarioUnico.charAt(0).toUpperCase()}
          </div>
          <div class="profile-name">${amigo.nome || amigo.usuarioUnico}</div>
          <div class="profile-username">@${amigo.usuarioUnico}</div>
          
          <div class="profile-stats">
            <div class="profile-stat">
              <div class="profile-stat-value">${amigo.xp || 0}</div>
              <div class="profile-stat-label">XP</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value">${nivel}</div>
              <div class="profile-stat-label">N√≠vel</div>
            </div>
          </div>

          <div class="profile-actions">
            <button class="btn-action primary" onclick="desafiar('${userId}', '${amigo.usuarioUnico}')">
              ‚öîÔ∏è Desafiar
            </button>
            <button class="btn-action danger" onclick="removerAmigo('${amigo.amizadeId || userId}')">
              Remover
            </button>
          </div>
        </div>
      `;

      document.getElementById('modalPerfil').classList.add('active');
    }

    // ===================================
    // ‚öîÔ∏è DESAFIAR
    // ===================================
    function desafiar(userId, username) {
      window.location.href = `embates-pvp.html?desafiar=${username}`;
    }

    // ===================================
    // üóëÔ∏è REMOVER AMIGO
    // ===================================
    async function removerAmigo(amizadeId) {
      if (!confirm('Deseja remover este amigo?')) return;

      try {
        await db.collection('amizades').doc(amizadeId).delete();
        showToast('‚úÖ Amigo removido');
        fecharModal();
        carregarAmigos();

      } catch (error) {
        console.error("Erro:", error);
        amigos = amigos.filter(a => a.amizadeId !== amizadeId && a.id !== amizadeId);
        atualizarStats();
        renderizarAmigos();
        fecharModal();
        showToast('‚úÖ Amigo removido');
      }
    }

    // ===================================
    // üéöÔ∏è CALCULAR N√çVEL
    // ===================================
    function calcularNivel(xp) {
      if (xp >= 10000) return 'üëë Mestre';
      if (xp >= 5000) return 'üíé Diamante';
      if (xp >= 2000) return 'ü•á Ouro';
      if (xp >= 500) return 'ü•à Prata';
      return 'ü•â Bronze';
    }

    // ===================================
    // üìã TROCAR TAB
    // ===================================
    function trocarTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });

      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
    }

    // ===================================
    // üì± MODAL
    // ===================================
    function fecharModal() {
      document.getElementById('modalPerfil').classList.remove('active');
    }

    function abrirBusca() {
      document.getElementById('searchInput').focus();
    }

    console.log("‚úÖ Amigos v1.0");
  </script>

</body>
</html>
