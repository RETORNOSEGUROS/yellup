<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jogo ao Vivo - Yellup</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --cor-timeA: #28a745;
      --cor-timeB: #dc3545;
      --bg-primary: #0a0e27;
      --bg-secondary: #1a1f3a;
      --bg-card: #252b48;
      --text-primary: #ffffff;
      --text-secondary: #a8b3cf;
      --accent: #ffb547;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Anima√ß√£o de fundo */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(40, 167, 69, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(220, 53, 69, 0.1) 0%, transparent 50%);
      animation: rotateBg 20s linear infinite;
      z-index: 0;
    }

    @keyframes rotateBg {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn-back {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-5px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
    }

    /* Match Header */
    .match-header {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .match-title {
      text-align: center;
      font-size: 2em;
      font-weight: 800;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #fff, var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .match-info {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      color: var(--text-secondary);
      font-size: 0.95em;
    }

    .match-info span {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timer {
      color: var(--accent);
      font-weight: 700;
    }

    /* Teams Section */
    .teams-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .team-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 25px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .team-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .team-card:hover::before {
      opacity: 1;
    }

    .team-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    .team-name {
      font-size: 1.5em;
      font-weight: 800;
      text-align: center;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }

    .team-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: 800;
      display: block;
    }

    .stat-label {
      font-size: 0.85em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Progress Bars */
    .progress-container {
      margin-bottom: 30px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .progress-bar-container {
      height: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      overflow: hidden;
      display: flex;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .progress-bar {
      height: 100%;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      to { left: 100%; }
    }

    /* Question Section */
    .question-section {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .free-plays {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(255, 181, 71, 0.2), rgba(255, 140, 66, 0.2));
      border-radius: 12px;
      border: 2px solid rgba(255, 181, 71, 0.3);
    }

    .free-plays-count {
      font-size: 1.3em;
      font-weight: 800;
      color: var(--accent);
    }

    .btn-answer {
      padding: 15px 40px;
      background: linear-gradient(135deg, var(--success), #059669);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .btn-answer:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-answer:active {
      transform: translateY(0);
    }

    .question-text {
      font-size: 1.3em;
      font-weight: 600;
      margin: 25px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .option-btn {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-size: 1.05em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }

    .option-btn:hover:not(.correct):not(.wrong):not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateX(5px);
    }

    .option-btn.correct {
      background: linear-gradient(135deg, var(--success), #059669);
      border-color: var(--success);
      animation: pulse 0.6s ease-out;
    }

    .option-btn.wrong {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      border-color: var(--danger);
      animation: shake 0.5s ease-out;
    }

    .option-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .result-message {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.2em;
      text-align: center;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-message.success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      border: 2px solid var(--success);
      color: var(--success);
    }

    .result-message.error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
      border: 2px solid var(--danger);
      color: var(--danger);
    }

    /* Chat Section */
    .chat-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chat-box-wrapper {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .chat-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .chat-messages {
      height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 10px;
    }

    .chat-message {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      animation: messageIn 0.3s ease-out;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-content {
      flex: 1;
    }

    .chat-author {
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 3px;
    }

    .chat-text {
      color: var(--text-secondary);
      word-wrap: break-word;
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.08);
    }

    .btn-send {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 181, 71, 0.4);
    }

    /* Ranking */
    .ranking-section {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .ranking-title {
      font-size: 1.5em;
      font-weight: 800;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ranking-list {
      list-style: none;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .ranking-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(5px);
    }

    .ranking-position {
      font-size: 1.2em;
      font-weight: 800;
      min-width: 40px;
    }

    .ranking-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .ranking-name {
      flex: 1;
      font-weight: 600;
    }

    .ranking-points {
      font-size: 1.1em;
      font-weight: 800;
      color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .match-title {
        font-size: 1.5em;
      }

      .teams-section {
        grid-template-columns: 1fr;
      }

      .options-grid {
        grid-template-columns: 1fr;
      }

      .chat-container {
        grid-template-columns: 1fr;
      }
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <a href="painel.html" class="btn-back">‚Üê Voltar</a>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div id="userInfo">Carregando...</div>
      </div>
    </div>

    <!-- Match Header -->
    <div class="match-header">
      <h1 class="match-title" id="matchTitle">‚öΩ Jogo ao Vivo</h1>
      <div class="match-info">
        <span>üìÖ In√≠cio: <span id="matchStart">--:--</span></span>
        <span>‚è±Ô∏è Fim: <span id="matchEnd">--:--</span></span>
        <span class="timer">‚è≥ Restam: <span id="matchTimer">--:--</span></span>
      </div>
    </div>

    <!-- Teams Section -->
    <div class="teams-section">
      <div class="team-card">
        <div class="team-name" id="teamAName" style="background: linear-gradient(135deg, var(--cor-timeA), #1e7e34);">Time A</div>
        <div class="team-stats">
          <div class="stat">
            <span class="stat-value" id="teamAFans">0</span>
            <span class="stat-label">Torcedores</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="teamAPoints">0</span>
            <span class="stat-label">Pontos</span>
          </div>
        </div>
      </div>
      
      <div class="team-card">
        <div class="team-name" id="teamBName" style="background: linear-gradient(135deg, var(--cor-timeB), #bd2130);">Time B</div>
        <div class="team-stats">
          <div class="stat">
            <span class="stat-value" id="teamBFans">0</span>
            <span class="stat-label">Torcedores</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="teamBPoints">0</span>
            <span class="stat-label">Pontos</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Bars -->
    <div class="progress-container">
      <div class="progress-label">
        <span>Torcida</span>
        <span><span id="teamAFansPercent">50</span>% vs <span id="teamBFansPercent">50</span>%</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="teamAFansBar" style="width: 50%; background: linear-gradient(90deg, var(--cor-timeA), #1e7e34);"></div>
        <div class="progress-bar" id="teamBFansBar" style="width: 50%; background: linear-gradient(90deg, var(--cor-timeB), #bd2130);"></div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-label">
        <span>Pontua√ß√£o</span>
        <span><span id="teamAPointsPercent">50</span>% vs <span id="teamBPointsPercent">50</span>%</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="teamAPointsBar" style="width: 50%; background: linear-gradient(90deg, var(--cor-timeA), #1e7e34);"></div>
        <div class="progress-bar" id="teamBPointsBar" style="width: 50%; background: linear-gradient(90deg, var(--cor-timeB), #bd2130);"></div>
      </div>
    </div>

    <!-- Question Section -->
    <div class="question-section">
      <div class="question-header">
        <div class="free-plays">
          <span style="font-size: 1.5em;">üéÅ</span>
          <span>Jogadas Gr√°tis: <span class="free-plays-count" id="freePlays">5</span>/5</span>
        </div>
        <button class="btn-answer" id="btnAnswer" onclick="requestQuestion()">üéØ Responder Pergunta</button>
      </div>

      <div id="questionContainer" style="display: none;">
        <div class="question-text" id="questionText">Aguardando pergunta...</div>
        <div class="options-grid" id="optionsContainer"></div>
        <div id="resultMessage" class="result-message" style="display: none;"></div>
      </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-container">
      <div class="chat-box-wrapper">
        <h3 class="chat-title">üí¨ Chat da Torcida</h3>
        <div class="chat-messages" id="teamChat"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="teamChatInput" placeholder="Digite sua mensagem...">
          <button class="btn-send" onclick="sendMessage('team')">Enviar</button>
        </div>
      </div>
      
      <div class="chat-box-wrapper">
        <h3 class="chat-title">üåê Chat Geral</h3>
        <div class="chat-messages" id="generalChat"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="generalChatInput" placeholder="Digite sua mensagem...">
          <button class="btn-send" onclick="sendMessage('general')">Enviar</button>
        </div>
      </div>
    </div>

    <!-- Ranking -->
    <div class="ranking-section">
      <h3 class="ranking-title">üèÜ Ranking da Sua Torcida</h3>
      <ul class="ranking-list" id="rankingList">
        <li style="text-align: center; color: var(--text-secondary); padding: 40px;">
          <div class="loading" style="margin: 0 auto 15px;"></div>
          <div>Carregando ranking...</div>
        </li>
      </ul>
    </div>

  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="js/firebase-init.js"></script>

  <script>
    // Vari√°veis globais
    const urlParams = new URLSearchParams(window.location.search);
    const jogoId = urlParams.get("id");
    let uid = null;
    let timeTorcida = null;
    let currentQuestion = null;
    let gameData = null;
    let perguntasRespondidas = []; // Armazena IDs das perguntas j√° respondidas

    if (!jogoId) {
      alert("ID do jogo n√£o encontrado!");
      window.location.href = "painel.html";
    }

    // Inicializa√ß√£o
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      uid = user.uid;
      await initializeGame();
    });

    async function initializeGame() {
      try {
        // Carregar dados do usu√°rio
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const userData = userDoc.data() || {};
        
        const nome = userData.nome || userData.usuario || "Usu√°rio";
        const creditos = userData.creditos || 0;
        timeTorcida = userData.torcidas?.[jogoId];

        if (!timeTorcida) {
          alert("Voc√™ precisa escolher um time antes de jogar!");
          window.location.href = "painel.html";
          return;
        }

        // Carregar hist√≥rico de perguntas respondidas
        perguntasRespondidas = userData[`perguntasRespondidas_${jogoId}`] || [];

        // Atualizar UI do usu√°rio
        document.getElementById("userAvatar").textContent = nome.charAt(0).toUpperCase();
        document.getElementById("userInfo").innerHTML = `
          <div style="font-weight: 700;">${nome}</div>
          <div style="font-size: 0.9em; color: var(--text-secondary);">üí≥ ${creditos} cr√©ditos</div>
        `;

        // Carregar dados do jogo
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        gameData = { id: jogoId, ...jogoDoc.data() };

        // Carregar times - CORRIGIDO: usar timeCasaId e timeForaId
        const timeCasaId = gameData.timeCasaId || gameData.timeCasa;
        const timeForaId = gameData.timeForaId || gameData.timeFora;

        const [teamADoc, teamBDoc] = await Promise.all([
          db.collection("times").doc(timeCasaId).get(),
          db.collection("times").doc(timeForaId).get()
        ]);

        const teamA = teamADoc.exists ? teamADoc.data() : { nome: "Time A" };
        const teamB = teamBDoc.exists ? teamBDoc.data() : { nome: "Time B" };

        // Atualizar UI do jogo
        document.getElementById("matchTitle").textContent = `${teamA.nome} ‚öîÔ∏è ${teamB.nome}`;
        document.getElementById("teamAName").textContent = teamA.nome;
        document.getElementById("teamBName").textContent = teamB.nome;

        // Aplicar cores dos times
        const corA = teamA.primaria || teamA.corPrimaria || "#28a745";
        const corB = teamB.primaria || teamB.corPrimaria || "#dc3545";
        document.documentElement.style.setProperty("--cor-timeA", corA);
        document.documentElement.style.setProperty("--cor-timeB", corB);

        // Datas
        const inicio = gameData.dataInicio.toDate();
        const fim = gameData.dataFim.toDate();
        document.getElementById("matchStart").textContent = inicio.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        document.getElementById("matchEnd").textContent = fim.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });

        // Iniciar atualiza√ß√µes
        updateTimer();
        setInterval(updateTimer, 1000);
        
        await updateStats();
        await updateFreePlays();
        
        initChat();
        loadRanking();

        // Atualizar stats a cada 10 segundos
        setInterval(updateStats, 10000);

        console.log("‚úÖ Jogo inicializado com sucesso!");
        console.log("Time da torcida:", timeTorcida);
        console.log("Perguntas j√° respondidas:", perguntasRespondidas.length);

      } catch (error) {
        console.error("Erro ao inicializar jogo:", error);
        alert("Erro ao carregar jogo. Tente novamente!");
      }
    }

    function updateTimer() {
      if (!gameData) return;
      const fim = gameData.dataFim.toDate();
      const agora = new Date();
      const diff = Math.max(0, fim - agora);
      const min = Math.floor(diff / 60000);
      const sec = Math.floor((diff % 60000) / 1000);
      document.getElementById("matchTimer").textContent = `${min}m ${sec}s`;
    }

    async function updateStats() {
      try {
        const usuarios = await db.collection("usuarios").get();
        let fansA = 0, fansB = 0, pointsA = 0, pointsB = 0;

        usuarios.forEach(doc => {
          const user = doc.data();
          const timeUser = user.torcidas?.[jogoId];
          const pontos = user.pontuacoes?.[jogoId] || 0;

          if (timeUser === gameData.timeCasaId) {
            fansA++;
            pointsA += pontos;
          } else if (timeUser === gameData.timeForaId) {
            fansB++;
            pointsB += pontos;
          }
        });

        // Atualizar torcedores
        document.getElementById("teamAFans").textContent = fansA;
        document.getElementById("teamBFans").textContent = fansB;
        const totalFans = fansA + fansB || 1;
        const fansAPercent = Math.round((fansA / totalFans) * 100);
        const fansBPercent = 100 - fansAPercent;
        document.getElementById("teamAFansPercent").textContent = fansAPercent;
        document.getElementById("teamBFansPercent").textContent = fansBPercent;
        document.getElementById("teamAFansBar").style.width = fansAPercent + "%";
        document.getElementById("teamBFansBar").style.width = fansBPercent + "%";

        // Atualizar pontos
        document.getElementById("teamAPoints").textContent = pointsA;
        document.getElementById("teamBPoints").textContent = pointsB;
        const totalPoints = pointsA + pointsB || 1;
        const pointsAPercent = Math.round((pointsA / totalPoints) * 100);
        const pointsBPercent = 100 - pointsAPercent;
        document.getElementById("teamAPointsPercent").textContent = pointsAPercent;
        document.getElementById("teamBPointsPercent").textContent = pointsBPercent;
        document.getElementById("teamAPointsBar").style.width = pointsAPercent + "%";
        document.getElementById("teamBPointsBar").style.width = pointsBPercent + "%";

      } catch (error) {
        console.error("Erro ao atualizar stats:", error);
      }
    }

    async function updateFreePlays() {
      try {
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const userData = userDoc.data() || {};
        
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        
        const ultimoReset = userData.jogadasGratis?.ultimoReset?.toDate();
        let jogadasUsadas = userData.jogadasGratis?.usadas || 0;

        // Reset di√°rio
        if (!ultimoReset || ultimoReset < hoje) {
          jogadasUsadas = 0;
          await db.collection("usuarios").doc(uid).update({
            'jogadasGratis.usadas': 0,
            'jogadasGratis.ultimoReset': hoje
          });
        }

        const restantes = Math.max(0, 5 - jogadasUsadas);
        document.getElementById("freePlays").textContent = restantes;

      } catch (error) {
        console.error("Erro ao atualizar jogadas gr√°tis:", error);
      }
    }

    async function requestQuestion() {
      try {
        const btn = document.getElementById("btnAnswer");
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Carregando...';

        // Verificar jogadas gr√°tis
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const userData = userDoc.data() || {};
        const jogadasUsadas = userData.jogadasGratis?.usadas || 0;
        const temGratis = jogadasUsadas < 5;
        const creditos = userData.creditos || 0;

        if (!temGratis && creditos < 1) {
          alert("Voc√™ n√£o tem cr√©ditos suficientes! Compre mais cr√©ditos ou aguarde o reset di√°rio.");
          btn.disabled = false;
          btn.textContent = "üéØ Responder Pergunta";
          return;
        }

        console.log("Buscando perguntas para o time:", timeTorcida);

        // ‚úÖ CORRE√á√ÉO: Buscar perguntas por timeId ao inv√©s de jogoId
        const perguntasSnap = await db.collection("perguntas")
          .where("timeId", "==", timeTorcida)
          .get();
        
        if (perguntasSnap.empty) {
          alert(`Nenhuma pergunta cadastrada para o seu time ainda. Aguarde o administrador adicionar perguntas!`);
          btn.disabled = false;
          btn.textContent = "üéØ Responder Pergunta";
          return;
        }

        console.log(`Encontradas ${perguntasSnap.size} perguntas no total`);

        // Filtrar perguntas n√£o respondidas
        const perguntasDisponiveis = [];
        perguntasSnap.forEach(doc => {
          if (!perguntasRespondidas.includes(doc.id)) {
            perguntasDisponiveis.push({ id: doc.id, ...doc.data() });
          }
        });

        console.log(`Perguntas dispon√≠veis (n√£o respondidas): ${perguntasDisponiveis.length}`);

        if (perguntasDisponiveis.length === 0) {
          alert("Parab√©ns! Voc√™ j√° respondeu todas as perguntas do seu time! üéâ");
          btn.disabled = false;
          btn.textContent = "üéØ Responder Pergunta";
          return;
        }

        // Pegar uma pergunta aleat√≥ria das dispon√≠veis
        const randomIndex = Math.floor(Math.random() * perguntasDisponiveis.length);
        currentQuestion = perguntasDisponiveis[randomIndex];

        console.log("Pergunta selecionada:", currentQuestion.pergunta);

        // Mostrar pergunta
        showQuestion(currentQuestion);

      } catch (error) {
        console.error("Erro ao buscar pergunta:", error);
        alert("Erro ao carregar pergunta. Tente novamente!");
        document.getElementById("btnAnswer").disabled = false;
        document.getElementById("btnAnswer").textContent = "üéØ Responder Pergunta";
      }
    }

    function showQuestion(question) {
      document.getElementById("questionContainer").style.display = "block";
      document.getElementById("questionText").textContent = question.pergunta || "Pergunta n√£o encontrada";
      document.getElementById("resultMessage").style.display = "none";
      
      const optionsContainer = document.getElementById("optionsContainer");
      optionsContainer.innerHTML = "";

      // Verificar se tem alternativas (formato antigo) ou opcoes (formato novo)
      const alternativas = question.alternativas || {};
      const letras = ["A", "B", "C", "D"];

      if (Object.keys(alternativas).length === 0) {
        alert("Pergunta sem op√ß√µes dispon√≠veis.");
        return;
      }

      letras.forEach((letra) => {
        if (alternativas[letra]) {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = `${letra}) ${alternativas[letra]}`;
          btn.onclick = () => answerQuestion(letra);
          optionsContainer.appendChild(btn);
        }
      });
    }

    async function answerQuestion(selectedLetter) {
      try {
        // Desabilitar todas as op√ß√µes
        const options = document.querySelectorAll(".option-btn");
        options.forEach(opt => opt.disabled = true);

        const correct = currentQuestion.correta;
        const pontos = currentQuestion.pontuacao || currentQuestion.pontos || 10;
        const acertou = selectedLetter === correct;

        console.log("Resposta selecionada:", selectedLetter);
        console.log("Resposta correta:", correct);
        console.log("Acertou?", acertou);

        // Marcar resposta visualmente
        options.forEach((opt, index) => {
          const letras = ["A", "B", "C", "D"];
          const letraAtual = letras[index];
          
          if (letraAtual === selectedLetter) {
            opt.classList.add(acertou ? "correct" : "wrong");
          }
          if (letraAtual === correct && !acertou) {
            opt.classList.add("correct");
          }
        });

        // Mostrar resultado
        const resultMessage = document.getElementById("resultMessage");
        resultMessage.style.display = "block";
        resultMessage.className = `result-message ${acertou ? "success" : "error"}`;
        
        const alternativas = currentQuestion.alternativas || {};
        resultMessage.textContent = acertou 
          ? `üéâ Correto! +${pontos} pontos` 
          : `‚ùå Errado! A resposta correta era: ${correct}) ${alternativas[correct]}`;

        // Adicionar pergunta ao hist√≥rico de respondidas
        perguntasRespondidas.push(currentQuestion.id);

        // Atualizar banco de dados
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const userData = userDoc.data() || {};
        const jogadasUsadas = userData.jogadasGratis?.usadas || 0;
        const temGratis = jogadasUsadas < 5;

        const updates = {
          [`perguntasRespondidas_${jogoId}`]: firebase.firestore.FieldValue.arrayUnion(currentQuestion.id)
        };

        if (temGratis) {
          updates['jogadasGratis.usadas'] = firebase.firestore.FieldValue.increment(1);
          await updateFreePlays();
        } else {
          updates.creditos = firebase.firestore.FieldValue.increment(-1);
        }

        if (acertou) {
          updates[`pontuacoes.${jogoId}`] = firebase.firestore.FieldValue.increment(pontos);
          updates.xp = firebase.firestore.FieldValue.increment(pontos);
        }

        await db.collection("usuarios").doc(uid).update(updates);

        // Atualizar estat√≠sticas
        await updateStats();
        await loadRanking();

        // Reabilitar bot√£o ap√≥s 3 segundos
        setTimeout(() => {
          document.getElementById("btnAnswer").disabled = false;
          document.getElementById("btnAnswer").textContent = "üéØ Responder Pergunta";
          document.getElementById("questionContainer").style.display = "none";
        }, 3000);

      } catch (error) {
        console.error("Erro ao processar resposta:", error);
        alert("Erro ao salvar resposta. Tente novamente!");
      }
    }

    // Chat functions
    function initChat() {
      // Chat da torcida
      db.collection("chats")
        .where("jogoId", "==", jogoId)
        .where("timeId", "==", timeTorcida)
        .orderBy("timestamp", "desc")
        .limit(50)
        .onSnapshot(snap => {
          const container = document.getElementById("teamChat");
          container.innerHTML = "";
          const msgs = [];
          snap.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
          msgs.reverse().forEach(msg => renderMessage(msg, container));
          container.scrollTop = container.scrollHeight;
        });

      // Chat geral
      db.collection("chats")
        .where("jogoId", "==", jogoId)
        .where("timeId", "==", null)
        .orderBy("timestamp", "desc")
        .limit(50)
        .onSnapshot(snap => {
          const container = document.getElementById("generalChat");
          container.innerHTML = "";
          const msgs = [];
          snap.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
          msgs.reverse().forEach(msg => renderMessage(msg, container));
          container.scrollTop = container.scrollHeight;
        });

      // Enter para enviar
      document.getElementById("teamChatInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage("team");
      });
      document.getElementById("generalChatInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage("general");
      });
    }

    function renderMessage(msg, container) {
      const div = document.createElement("div");
      div.className = "chat-message";
      const avatar = msg.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.nome || 'U')}&background=random`;
      div.innerHTML = `
        <img src="${avatar}" alt="${msg.nome}" class="chat-avatar">
        <div class="chat-content">
          <div class="chat-author">${msg.nome}</div>
          <div class="chat-text">${msg.mensagem}</div>
        </div>
      `;
      container.appendChild(div);
    }

    async function sendMessage(type) {
      const inputId = type === "team" ? "teamChatInput" : "generalChatInput";
      const input = document.getElementById(inputId);
      const mensagem = input.value.trim();
      if (!mensagem) return;

      try {
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const user = userDoc.data() || {};
        const nome = user.nome || user.usuario || "An√¥nimo";
        const avatar = user.avatar || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(nome)}&background=random`;

        await db.collection("chats").add({
          jogoId,
          timeId: type === "team" ? timeTorcida : null,
          userId: uid,
          nome,
          avatar,
          mensagem,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        input.value = "";

      } catch (error) {
        console.error("Erro ao enviar mensagem:", error);
      }
    }

    async function loadRanking() {
      try {
        const usuarios = await db.collection("usuarios").get();
        const ranking = [];

        usuarios.forEach(doc => {
          const user = doc.data();
          const timeUser = user.torcidas?.[jogoId];
          if (timeUser !== timeTorcida) return;

          const pontos = user.pontuacoes?.[jogoId] || 0;
          if (pontos > 0) {
            ranking.push({
              nome: user.nome || user.usuario || "An√¥nimo",
              pontos: pontos,
              avatar: user.avatar || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.usuario || 'U')}&background=random`
            });
          }
        });

        ranking.sort((a, b) => b.pontos - a.pontos);

        const rankingList = document.getElementById("rankingList");
        rankingList.innerHTML = "";

        if (ranking.length === 0) {
          rankingList.innerHTML = '<li style="text-align: center; color: var(--text-secondary); padding: 40px;">Nenhuma pontua√ß√£o ainda. Seja o primeiro!</li>';
          return;
        }

        ranking.slice(0, 10).forEach((user, index) => {
          const li = document.createElement("li");
          li.className = "ranking-item";
          
          const posicao = index + 1;
          const medalha = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : posicao === 3 ? 'ü•â' : `${posicao}¬∫`;
          
          li.innerHTML = `
            <span class="ranking-position">${medalha}</span>
            <img src="${user.avatar}" alt="${user.nome}" class="ranking-avatar">
            <span class="ranking-name">${user.nome}</span>
            <span class="ranking-points">${user.pontos} pts</span>
          `;
          
          rankingList.appendChild(li);
        });

      } catch (error) {
        console.error("Erro ao carregar ranking:", error);
      }
    }

    console.log("‚úÖ Yellup Game v3.1 - Fixed Question System!");
  </script>

</body>
</html>
