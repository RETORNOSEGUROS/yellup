<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jogo ao Vivo - Yellup</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --cor-timeA: #28a745;
      --cor-timeB: #dc3545;
      --bg-primary: #0a0e27;
      --bg-secondary: #1a1f3a;
      --bg-card: #252b48;
      --text-primary: #ffffff;
      --text-secondary: #a8b3cf;
      --accent: #ffb547;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      /* ‚úÖ NOVAS VARI√ÅVEIS */
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --shadow-color: rgba(0, 0, 0, 0.3);
      --card-radius: 16px;
      --btn-radius: 12px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0d1230 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      /* ‚úÖ Safe area para notch/ilha din√¢mica */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      position: relative;
    }
    
    /* Imagem de campo de futebol em CSS puro */
    body::after {
      content: '';
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 55%;
      background: 
        /* Linhas do campo */
        linear-gradient(0deg, transparent 49.5%, rgba(255,255,255,0.03) 49.5%, rgba(255,255,255,0.03) 50.5%, transparent 50.5%),
        /* C√≠rculo central */
        radial-gradient(circle at 50% 50%, transparent 8%, rgba(255,255,255,0.025) 8%, rgba(255,255,255,0.025) 8.5%, transparent 8.5%),
        /* Gramado sutil */
        linear-gradient(180deg, 
          transparent 0%, 
          rgba(34, 139, 34, 0.04) 20%,
          rgba(34, 139, 34, 0.06) 50%,
          rgba(34, 139, 34, 0.04) 80%,
          transparent 100%
        ),
        /* Listras do gramado */
        repeating-linear-gradient(
          90deg,
          rgba(34, 139, 34, 0.02) 0px,
          rgba(34, 139, 34, 0.02) 40px,
          rgba(34, 139, 34, 0.04) 40px,
          rgba(34, 139, 34, 0.04) 80px
        );
      opacity: 1;
      z-index: 0;
      pointer-events: none;
      mask-image: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 90%);
      -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 90%);
    }

    /* Anima√ß√£o de fundo - mais vibrante */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(40, 167, 69, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(220, 53, 69, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 50% 20%, rgba(255, 181, 71, 0.08) 0%, transparent 40%);
      animation: rotateBg 20s linear infinite;
      z-index: 0;
    }

    @keyframes rotateBg {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding-top: env(safe-area-inset-top);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 181, 71, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 1.2em;
      color: var(--text-secondary);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 15px;
      position: relative;
      z-index: 1;
      display: none;
    }

    .container.loaded {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* ‚úÖ Anima√ß√µes Toast */
    @keyframes toastSlideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    @keyframes toastSlideDown {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn-back {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-5px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
    }

    /* ==================== CAMISETA SVG ==================== */
    .team-jersey {
      width: 45px;
      height: 52px;
      margin: 0 auto 8px;
    }

    .team-jersey-small {
      width: 25px;
      height: 30px;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* Match Header - S√ì INFO (compacto) */
    .match-header {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.95) 100%);
      border-radius: var(--card-radius);
      padding: 14px 15px;
      margin-bottom: 15px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 181, 71, 0.15);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255,255,255,0.05);
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .match-title {
      text-align: center;
      font-size: 1.3em;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #fff, var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .match-info {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      color: var(--text-secondary);
      font-size: 0.8em;
    }
    
    .match-info span {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .match-info .timer {
      color: var(--accent);
      font-weight: 700;
    }

    /* Teams Section - TOPO */
    .teams-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
      animation: slideDown 0.5s ease-out;
    }

    .team-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.9) 100%);
      border-radius: var(--card-radius);
      padding: 12px;
      text-align: center;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    /* Efeito de brilho no hover */
    .team-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
      transform: rotate(45deg);
      transition: all 0.5s;
    }
    
    .team-card:hover::before {
      left: 100%;
    }

    .team-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-color);
    }

    .team-card.my-team {
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 181, 71, 0.25);
    }
    
    .team-card.my-team::after {
      content: 'üéØ Voc√™';
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent);
      color: var(--bg-primary);
      font-size: 0.65em;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
    }
    
    /* Camisa do time - mais compacta */
    .team-jersey {
      width: 40px;
      height: 45px;
      margin: 0 auto 8px;
      position: relative;
    }

    .team-name {
      font-size: 0.85em;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-stats {
      display: flex;
      justify-content: space-around;
      gap: 5px;
    }

    .stat {
      text-align: center;
      flex: 1;
    }

    .stat-value {
      display: block;
      font-size: 1.4em;
      font-weight: 800;
      color: var(--accent);
      line-height: 1.2;
    }

    .stat-label {
      font-size: 0.7em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ==================== BARRAS DE FOR√áA ==================== */
    .force-bars-container {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .force-bar-section {
      margin-bottom: 20px;
    }

    .force-bar-section:last-child {
      margin-bottom: 0;
    }

    .force-bar-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.9em;
    }

    .force-bar-title .team-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .force-bar-wrapper {
      height: 30px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      overflow: hidden;
      display: flex;
      position: relative;
    }

    .force-bar {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85em;
      transition: width 0.5s ease;
      min-width: 50px;
    }

    .force-bar.team-a {
      background: linear-gradient(90deg, var(--cor-timeA), var(--cor-timeA-dark, var(--cor-timeA)));
    }

    .force-bar.team-b {
      background: linear-gradient(90deg, var(--cor-timeB-dark, var(--cor-timeB)), var(--cor-timeB));
    }

    /* Progress Container (barras antigas - mantido para compatibilidade) */
    .progress-container {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: none; /* Substitu√≠do pelas novas barras */
    }

    /* Answer Section */
    .answer-section {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .credits-display {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .credit-badge {
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95em;
    }

    .credit-badge.free {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .credit-badge.paid {
      background: linear-gradient(135deg, rgba(255, 181, 71, 0.2), rgba(255, 181, 71, 0.1));
      border: 1px solid rgba(255, 181, 71, 0.3);
    }

    /* ‚ú® Bot√£o Como Ganhar XP */
    .btn-xp-info {
      background: transparent;
      border: 1px solid rgba(167, 139, 250, 0.3);
      color: #a78bfa;
      font-size: 0.75em;
      font-family: 'Poppins', sans-serif;
      padding: 5px 14px;
      border-radius: 20px;
      cursor: pointer;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    .btn-xp-info:hover {
      background: rgba(167, 139, 250, 0.1);
      border-color: rgba(167, 139, 250, 0.5);
    }

    /* Modal XP Info */
    .xp-info-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }
    .xp-info-card {
      background: linear-gradient(145deg, #1a2332, #0e141b);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 20px;
      padding: 24px;
      max-width: 380px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
    }
    .xp-info-card h3 {
      text-align: center;
      margin-bottom: 16px;
      color: #a78bfa;
      font-size: 1.2em;
    }
    .xp-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 6px;
      font-size: 0.85em;
    }
    .xp-info-item .xp-val {
      color: #a78bfa;
      font-weight: 700;
      white-space: nowrap;
      margin-left: 8px;
    }
    .xp-info-close {
      width: 100%;
      padding: 12px;
      background: rgba(167, 139, 250, 0.15);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 12px;
      color: #a78bfa;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }
    .xp-info-close:hover {
      background: rgba(167, 139, 250, 0.25);
    }

    .btn-answer {
      width: 100%;
      padding: 18px;
      font-size: 1.2em;
      font-weight: 700;
      border: none;
      border-radius: var(--btn-radius);
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      color: var(--bg-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 10px 30px rgba(255, 181, 71, 0.3);
    }

    .btn-answer:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255, 181, 71, 0.4);
    }

    .btn-answer:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ‚úÖ BOT√ÉO FLUTUANTE (FAB) - INSTIGANTE COM PULSA√á√ÉO */
    .fab-container {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      padding-bottom: env(safe-area-inset-bottom);
      pointer-events: none;
    }
    
    .fab-btn {
      width: auto;
      height: auto;
      padding: 14px 28px;
      font-size: 1em;
      font-weight: 700;
      border: none;
      border-radius: 50px;
      background: linear-gradient(135deg, #ff8c42, var(--accent), #ffcf33);
      background-size: 200% 200%;
      color: var(--bg-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 4px 20px rgba(255, 181, 71, 0.6), 0 0 40px rgba(255, 140, 66, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      animation: fabPulse 2s ease-in-out infinite, fabGradient 3s ease infinite;
      pointer-events: all;
      white-space: nowrap;
    }
    
    @keyframes fabPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 181, 71, 0.6), 0 0 40px rgba(255, 140, 66, 0.3); }
      50% { transform: scale(1.05); box-shadow: 0 6px 30px rgba(255, 181, 71, 0.8), 0 0 60px rgba(255, 140, 66, 0.5); }
    }
    
    @keyframes fabGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .fab-btn:hover:not(:disabled) {
      transform: scale(1.08);
      box-shadow: 0 6px 25px rgba(255, 181, 71, 0.7), 0 0 50px rgba(255, 140, 66, 0.4);
    }
    
    .fab-btn:active:not(:disabled) {
      transform: scale(0.97);
      animation: none;
    }
    
    .fab-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      animation: none;
      box-shadow: none;
    }
    
    .fab-btn .fab-icon {
      font-size: 1.3em;
    }
    
    .fab-btn .fab-text {
      font-size: 0.9em;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    
    /* Badge de cr√©ditos removido */
    .fab-credits {
      display: none;
    }
    
    /* Esconder bot√£o original no mobile */
    @media (max-width: 768px) {
      .answer-section .btn-answer {
        display: none;
      }
      
      .fab-container {
        display: block;
      }
    }
    
    @media (min-width: 769px) {
      .fab-container {
        display: none;
      }
    }

    /* ==================== TIMER DA PERGUNTA ==================== */
    .question-timer {
      text-align: center;
      margin-bottom: 20px;
    }

    .timer-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      position: relative;
      border: 4px solid var(--accent);
    }

    .timer-circle.warning {
      border-color: var(--warning);
      animation: pulse 0.5s infinite;
    }

    .timer-circle.danger {
      border-color: var(--danger);
      animation: pulse 0.3s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .timer-value {
      font-size: 2em;
      font-weight: 800;
      color: var(--accent);
    }

    .timer-circle.warning .timer-value {
      color: var(--warning);
    }

    .timer-circle.danger .timer-value {
      color: var(--danger);
    }

    .timer-label {
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    /* ==================== MODAL FULLSCREEN DA PERGUNTA ==================== */
    .question-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 9998;
      align-items: center;
      justify-content: center;
      padding: 15px;
      padding-top: calc(15px + env(safe-area-inset-top));
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
    }

    .question-modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .question-modal {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
      border-radius: 20px;
      padding: 20px;
      width: 100%;
      max-width: 450px;
      max-height: 85vh;
      overflow-y: auto;
      border: 2px solid rgba(255, 181, 71, 0.3);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
      animation: modalSlideUp 0.4s ease;
    }

    @keyframes modalSlideUp {
      from { opacity: 0; transform: translateY(50px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .question-modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
    }

    .question-modal-close:hover {
      background: rgba(239, 68, 68, 0.5);
    }

    /* Question Container (dentro do modal) */
    .question-container {
      display: block;
      position: relative;
    }

    .question-text {
      font-size: 1.1em;
      font-weight: 600;
      text-align: center;
      padding: 18px 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      margin-bottom: 20px;
      line-height: 1.5;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-points {
      text-align: center;
      margin-bottom: 15px;
      color: var(--accent);
      font-weight: 700;
      font-size: 1em;
    }

    .options-container {
      display: grid;
      gap: 10px;
    }

    .option-btn {
      padding: 14px 16px;
      font-size: 0.95em;
      font-weight: 500;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-family: 'Poppins', sans-serif;
      min-height: 50px;
    }

    .option-btn:hover:not(:disabled) {
      border-color: var(--accent);
      background: rgba(255, 181, 71, 0.1);
      transform: translateX(3px);
    }
    
    .option-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .option-btn:disabled {
      cursor: not-allowed;
    }

    .option-btn.correct {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1));
      border-color: var(--success);
      animation: correctPulse 0.5s ease;
    }

    .option-btn.wrong {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1));
      border-color: var(--danger);
      animation: wrongShake 0.5s ease;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    /* ‚úÖ MODAL RESPONSIVO MOBILE */
    @media (max-width: 500px) {
      .question-modal-overlay {
        padding: 10px;
        padding-top: calc(10px + env(safe-area-inset-top));
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
      
      .question-modal {
        padding: 15px;
        border-radius: 16px;
        max-height: 90vh;
      }
      
      .question-text {
        font-size: 1em;
        padding: 15px 12px;
        margin-bottom: 15px;
      }
      
      .question-points {
        font-size: 0.9em;
        margin-bottom: 12px;
      }
      
      .options-container {
        gap: 8px;
      }
      
      .option-btn {
        padding: 12px 14px;
        font-size: 0.9em;
        min-height: 44px;
      }
      
      .timer-circle {
        width: 60px;
        height: 60px;
      }
      
      .timer-value {
        font-size: 1.5em;
      }
      
      .timer-label {
        font-size: 0.8em;
      }
    }

    /* üî• STREAK E GAMIFICA√á√ÉO */
    .streak-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .streak-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(255, 100, 50, 0.2), rgba(255, 50, 50, 0.1));
      border: 2px solid rgba(255, 100, 50, 0.5);
      border-radius: 50px;
      transition: all 0.3s ease;
    }

    .streak-badge.active {
      animation: streakPulse 1s ease infinite;
      box-shadow: 0 0 20px rgba(255, 100, 50, 0.5);
    }

    @keyframes streakPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .streak-icon {
      font-size: 1.5em;
    }

    .streak-count {
      font-size: 1.8em;
      font-weight: 800;
      color: #ff6432;
    }

    .streak-label {
      color: #a8b3cf;
      font-size: 0.85em;
    }

    .multiplier-badge {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(79, 70, 229, 0.2));
      border: 2px solid rgba(147, 51, 234, 0.6);
      border-radius: 50px;
      font-weight: 800;
      font-size: 1.2em;
      color: #a78bfa;
      animation: multiplierGlow 2s ease infinite;
    }

    @keyframes multiplierGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(147, 51, 234, 0.3); }
      50% { box-shadow: 0 0 25px rgba(147, 51, 234, 0.6); }
    }

    /* üèÖ CONQUISTA POPUP */
    .achievement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #1a1f3a, #252b48);
      border: 3px solid #ffb547;
      border-radius: 20px;
      padding: 30px 50px;
      text-align: center;
      z-index: 10000;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      animation: achievementPop 0.5s ease forwards;
    }

    @keyframes achievementPop {
      0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); }
      50% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0); }
    }

    .achievement-popup .emoji {
      font-size: 4em;
      margin-bottom: 10px;
      animation: bounce 0.5s ease infinite alternate;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }

    .achievement-popup .title {
      font-size: 1.5em;
      font-weight: 800;
      color: #ffb547;
      margin-bottom: 5px;
    }

    .achievement-popup .description {
      color: #a8b3cf;
      margin-bottom: 10px;
    }

    .achievement-popup .bonus {
      color: #10b981;
      font-weight: 700;
    }

    .achievement-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
    }

    /* üí∞ PATROCINADOR POPUP */
    .sponsor-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1a1f3a, #252b48);
      border: 2px solid rgba(255, 181, 71, 0.5);
      border-radius: 20px;
      padding: 25px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      z-index: 10000;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      display: none;
    }

    .sponsor-popup.active {
      display: block;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .sponsor-header {
      font-size: 0.9em;
      color: #ffb547;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .sponsor-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .sponsor-logo-img {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      border-radius: 20px;
      object-fit: cover;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .sponsor-name {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff, #a8b3cf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sponsor-desc {
      font-size: 0.9em;
      color: #a8b3cf;
      margin-bottom: 15px;
    }

    .sponsor-reward {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.5);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      color: #10b981;
      font-size: 1em;
    }
    
    .sponsor-reward strong {
      font-size: 1.3em;
      color: #2ecc71;
    }

    .sponsor-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .sponsor-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .sponsor-skip {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: #a8b3cf;
      cursor: pointer;
      font-size: 0.9em;
      font-family: 'Poppins', sans-serif;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .sponsor-skip:hover {
      color: #fff;
      border-color: rgba(255,255,255,0.4);
    }
    
    .sponsor-timer {
      margin-top: 12px;
      font-size: 0.8em;
      color: #666;
    }
    
    .sponsor-timer span {
      color: #f39c12;
      font-weight: 600;
    }

    /* üí∞ MINI-BANNER PATROCINADOR (cooldown) */
    .sponsor-mini-banner {
      display: none;
      margin-top: 10px;
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255,181,71,0.08), rgba(255,181,71,0.03));
      border: 1px solid rgba(255,181,71,0.15);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s ease;
      animation: fadeIn 0.4s ease;
    }
    .sponsor-mini-banner.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sponsor-mini-banner:hover {
      background: rgba(255,181,71,0.12);
      border-color: rgba(255,181,71,0.3);
      transform: translateY(-1px);
    }
    .sponsor-mini-logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      flex-shrink: 0;
    }
    .sponsor-mini-logo img {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: cover;
    }
    .sponsor-mini-info {
      flex: 1;
      min-width: 0;
    }
    .sponsor-mini-tag {
      font-size: 0.6em;
      color: #ffb547;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }
    .sponsor-mini-name {
      font-size: 0.85em;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sponsor-mini-cta {
      font-size: 0.7em;
      color: #10b981;
      font-weight: 600;
    }
    .sponsor-mini-reward {
      background: rgba(16,185,129,0.15);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 0.7em;
      color: #10b981;
      font-weight: 700;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .result-message {
      display: none;
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      font-weight: 600;
      font-size: 1.1em;
    }

    .result-message.success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .result-message.error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }

    .result-message.timeout {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }
    
    /* ‚úÖ ANIMA√á√ÉO DE XP FLUTUANTE */
    .xp-flutuante {
      position: absolute;
      top: 50%;
      font-size: 2em;
      font-weight: 800;
      color: #2ecc71;
      text-shadow: 0 0 20px rgba(46, 204, 113, 0.8), 0 2px 10px rgba(0,0,0,0.5);
      animation: xpFloat 2s ease-out forwards;
      pointer-events: none;
      z-index: 100;
    }
    
    .xp-flutuante.bonus {
      font-size: 2.5em;
      color: #a78bfa;
      text-shadow: 0 0 30px rgba(167, 139, 250, 0.9), 0 2px 15px rgba(0,0,0,0.5);
    }
    
    @keyframes xpFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(0.5);
      }
      20% {
        transform: translateY(-20px) scale(1.2);
      }
      100% {
        opacity: 0;
        transform: translateY(-100px) scale(0.8);
      }
    }

    /* ========== ENQUETES AO VIVO ========== */

    .enquete-section {
      display: none;
      margin-bottom: 20px;
      animation: fadeIn 0.4s ease;
    }
    .enquete-section.active {
      display: block;
    }
    .enquete-card {
      background: linear-gradient(145deg, #1a2332 0%, #0e141b 100%);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 18px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .enquete-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, #a78bfa, #ff8c42, #a78bfa);
      background-size: 200% 100%;
      animation: shimmerBar 2s linear infinite;
    }
    @keyframes shimmerBar {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .enquete-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .enquete-tag {
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #a78bfa;
    }
    .enquete-xp {
      font-size: 0.7em;
      color: #a78bfa;
      background: rgba(167, 139, 250, 0.15);
      padding: 3px 8px;
      border-radius: 10px;
    }
    .enquete-pergunta {
      font-size: 1.05em;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-primary);
    }
    .enquete-opcoes {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .enquete-opcao {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .enquete-opcao:hover {
      background: rgba(167, 139, 250, 0.1);
      border-color: rgba(167, 139, 250, 0.3);
    }
    .enquete-opcao.voted {
      cursor: default;
    }
    .enquete-opcao.voted.selected {
      border-color: rgba(167, 139, 250, 0.5);
      background: rgba(167, 139, 250, 0.12);
    }
    .enquete-opcao .opcao-bar {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      background: rgba(167, 139, 250, 0.12);
      border-radius: 12px;
      transition: width 0.6s ease;
      width: 0%;
    }
    .enquete-opcao .opcao-content {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    .enquete-opcao .opcao-text {
      font-size: 0.9em;
    }
    .enquete-opcao .opcao-perc {
      font-size: 0.8em;
      font-weight: 700;
      color: #a78bfa;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .enquete-opcao.voted .opcao-perc {
      opacity: 1;
    }
    .enquete-opcoes-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .enquete-opcoes-row .enquete-opcao {
      flex: 1;
      min-width: 60px;
      justify-content: center;
      text-align: center;
      padding: 10px 8px;
    }
    .enquete-opcoes-row .enquete-opcao .opcao-content {
      justify-content: center;
      flex-direction: column;
      gap: 2px;
    }
    .enquete-total-votos {
      text-align: center;
      font-size: 0.75em;
      color: var(--text-secondary);
      margin-top: 10px;
    }
    .enquete-resultado-msg {
      text-align: center;
      font-size: 0.8em;
      color: #a78bfa;
      margin-top: 8px;
      font-weight: 600;
      animation: fadeIn 0.5s ease;
    }

    /* ========== FIM ENQUETES AO VIVO ========== */

    /* ========== PROVOCA√á√ïES ENTRE TORCIDAS ========== */

    .provocar-btn {
      background: linear-gradient(135deg, rgba(231,76,60,0.2), rgba(231,76,60,0.1));
      border: 1px solid rgba(231,76,60,0.3);
      color: #e74c3c;
      font-size: 0.75em;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      padding: 5px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .provocar-btn:hover {
      background: rgba(231,76,60,0.25);
      transform: scale(1.05);
    }
    .provocar-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    .provocar-panel {
      display: none;
      padding: 10px;
      background: rgba(231,76,60,0.05);
      border: 1px solid rgba(231,76,60,0.15);
      border-radius: 12px;
      margin: 8px 0;
      animation: fadeIn 0.2s ease;
    }
    .provocar-panel.active {
      display: block;
    }
    .provocar-panel-title {
      font-size: 0.75em;
      color: #e74c3c;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
    }
    .provocar-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .provocar-opcao {
      padding: 8px 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .provocar-opcao:hover {
      background: rgba(231,76,60,0.15);
      border-color: rgba(231,76,60,0.3);
      transform: scale(1.03);
    }
    .provocar-cooldown {
      font-size: 0.7em;
      color: #7f8c8d;
      text-align: center;
      margin-top: 6px;
    }

    /* Mensagem de provoca√ß√£o no chat */
    .chat-message.provocacao {
      background: linear-gradient(135deg, rgba(231,76,60,0.12), rgba(231,76,60,0.05));
      border: 1px solid rgba(231,76,60,0.2);
      border-radius: 12px;
    }
    .chat-message.provocacao .chat-author {
      color: #e74c3c;
    }
    .chat-message.provocacao .chat-text {
      font-weight: 700;
      font-size: 1em;
    }
    .chat-message.provocacao .provocacao-tag {
      font-size: 0.65em;
      color: #e74c3c;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ========== FIM PROVOCA√á√ïES ========== */

    /* ========== INDICADORES AO VIVO ========== */

    /* Badge AO VIVO pulsante */
    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .live-badge.ao-vivo {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.4);
      color: #ef4444;
    }
    .live-badge.ao-vivo .live-dot {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: livePulse 1.5s ease infinite;
    }
    .live-badge.pre-jogo {
      background: rgba(245,158,11,0.15);
      border: 1px solid rgba(245,158,11,0.4);
      color: #f59e0b;
    }
    .live-badge.finalizado {
      background: rgba(127,140,141,0.15);
      border: 1px solid rgba(127,140,141,0.3);
      color: #7f8c8d;
    }
    @keyframes livePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(1.3); }
    }

    /* Contador online */
    .online-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 3px 0;
      font-size: 0.75em;
      color: var(--text-secondary);
    }
    .online-counter .online-dot {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: livePulse 2s ease infinite;
    }
    .online-counter strong {
      color: #10b981;
    }

    /* Mini stats pessoal */
    .my-stats-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(255,181,71,0.08), rgba(255,181,71,0.03));
      border: 1px solid rgba(255,181,71,0.12);
      border-radius: 12px;
      margin-bottom: 12px;
      font-size: 0.8em;
      flex-wrap: wrap;
    }
    .my-stats-bar .my-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .my-stats-bar .my-stat-val {
      font-weight: 700;
      color: var(--accent);
    }
    .my-stats-bar .my-stat-label {
      color: var(--text-secondary);
    }
    .my-stats-bar .my-stat-sep {
      color: rgba(255,255,255,0.15);
    }

    /* Chat badge (mensagens n√£o lidas) */
    .chat-tab {
      position: relative;
    }
    .chat-badge {
      position: absolute;
      top: 4px;
      right: 8px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: #ef4444;
      color: white;
      font-size: 0.65em;
      font-weight: 700;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: badgePop 0.3s ease;
    }
    @keyframes badgePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Counter animation (numbers pulse when changed) */
    .stat-value.changed {
      animation: numberPop 0.4s ease;
    }
    @keyframes numberPop {
      0% { transform: scale(1); }
      30% { transform: scale(1.3); color: #10b981; }
      100% { transform: scale(1); }
    }

    /* ========== FIM INDICADORES AO VIVO ========== */

    /* ========== FEEDBACK EMOCIONAL ‚Äî FLASH + STREAK BREAK + RANKING TOAST ========== */

    /* Flash verde (acerto) ou vermelho (erro) na tela toda */
    .feedback-flash {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 20000;
      opacity: 0;
    }
    .feedback-flash.acerto {
      background: radial-gradient(ellipse at center, rgba(46,204,113,0.4) 0%, rgba(46,204,113,0) 70%);
      animation: flashPulse 0.5s ease-out forwards;
    }
    .feedback-flash.erro {
      background: radial-gradient(ellipse at center, rgba(231,76,60,0.4) 0%, rgba(231,76,60,0) 70%);
      animation: flashPulse 0.5s ease-out forwards;
    }
    @keyframes flashPulse {
      0% { opacity: 0; }
      15% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Shake na tela quando perde streak grande */
    .feedback-shake {
      animation: screenShake 0.4s ease-out;
    }
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-6px) rotate(-0.5deg); }
      30% { transform: translateX(5px) rotate(0.5deg); }
      45% { transform: translateX(-4px); }
      60% { transform: translateX(3px); }
      75% { transform: translateX(-2px); }
    }

    /* Streak Break ‚Äî overlay na pergunta */
    .streak-break-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 110;
      animation: streakBreakFade 2s ease-out forwards;
    }
    .streak-break-overlay .streak-break-icon {
      font-size: 3em;
      animation: streakBreakBounce 0.6s ease-out;
    }
    .streak-break-overlay .streak-break-text {
      font-size: 1.1em;
      font-weight: 700;
      color: #e74c3c;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
      margin-top: 4px;
    }
    @keyframes streakBreakFade {
      0% { opacity: 1; }
      60% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes streakBreakBounce {
      0% { transform: scale(0.3) rotate(-15deg); opacity: 0; }
      40% { transform: scale(1.3) rotate(5deg); opacity: 1; }
      70% { transform: scale(0.9) rotate(-2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* Glow nas bordas do modal quando streak alto */
    .question-modal.streak-glow {
      box-shadow: 0 0 30px rgba(255, 140, 0, 0.4), 0 0 60px rgba(255, 100, 0, 0.2);
      border-color: rgba(255, 140, 0, 0.5);
    }
    .question-modal.streak-glow-high {
      box-shadow: 0 0 40px rgba(255, 60, 0, 0.5), 0 0 80px rgba(255, 60, 0, 0.3), inset 0 0 30px rgba(255, 60, 0, 0.1);
      border-color: rgba(255, 60, 0, 0.6);
      animation: streakGlowPulse 1.5s ease infinite;
    }
    @keyframes streakGlowPulse {
      0%, 100% { box-shadow: 0 0 40px rgba(255, 60, 0, 0.5), 0 0 80px rgba(255, 60, 0, 0.2); }
      50% { box-shadow: 0 0 50px rgba(255, 60, 0, 0.7), 0 0 100px rgba(255, 60, 0, 0.35); }
    }

    /* Ranking Position Toast */
    .ranking-toast {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 0.9em;
      z-index: 20001;
      opacity: 0;
      pointer-events: none;
      white-space: nowrap;
      animation: rankingToastAnim 3s ease forwards;
      backdrop-filter: blur(10px);
    }
    .ranking-toast.subiu {
      background: linear-gradient(135deg, rgba(46,204,113,0.9), rgba(39,174,96,0.9));
      color: white;
      box-shadow: 0 4px 20px rgba(46,204,113,0.5);
    }
    .ranking-toast.caiu {
      background: linear-gradient(135deg, rgba(231,76,60,0.9), rgba(192,57,43,0.9));
      color: white;
      box-shadow: 0 4px 20px rgba(231,76,60,0.5);
    }
    .ranking-toast.lidera {
      background: linear-gradient(135deg, rgba(255,215,0,0.95), rgba(255,165,0,0.95));
      color: #1a1a2e;
      box-shadow: 0 4px 25px rgba(255,215,0,0.6);
    }
    .ranking-toast.manteve {
      background: linear-gradient(135deg, rgba(100,120,140,0.85), rgba(80,100,120,0.85));
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    @keyframes rankingToastAnim {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.8); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.05); }
      20% { transform: translateX(-50%) translateY(0) scale(1); }
      75% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* ========== FIM FEEDBACK EMOCIONAL ========== */

    /* Chat and Ranking Grid */
    .chat-ranking-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (min-width: 992px) {
      .chat-ranking-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* ‚úÖ CHAT SECTION COM FULLSCREEN */
    .chat-section {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: var(--card-radius);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--glass-border);
    }
    
    .chat-header-title {
      font-size: 1em;
      font-weight: 600;
      color: var(--accent);
    }
    
    .chat-fullscreen-btn {
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .chat-fullscreen-btn:hover {
      background: rgba(255,255,255,0.15);
      color: white;
    }
    
    .chat-body {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    /* Chat Fullscreen Mode */
    .chat-section.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9500;
      border-radius: 0;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      flex-direction: column;
    }
    
    .chat-section.fullscreen .chat-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-section.fullscreen .chat-content.active {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    
    .chat-section.fullscreen .chat-messages {
      flex: 1;
      height: auto;
      max-height: none;
      border-radius: 8px;
      overflow-y: auto;
      min-height: 0;
    }
    
    .chat-section.fullscreen .chat-input-container {
      flex-shrink: 0;
      padding-top: 10px;
    }
    
    .chat-section.fullscreen .chat-input {
      padding: 10px 12px;
      font-size: 0.9em;
    }
    
    .chat-section.fullscreen .chat-send-btn {
      padding: 10px 16px;
      font-size: 0.85em;
    }
    
    .chat-section.fullscreen .chat-tabs {
      flex-shrink: 0;
    }

    .chat-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .chat-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      font-size: 0.85em;
    }

    .chat-tab:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .chat-tab.active {
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      color: var(--bg-primary);
    }

    .chat-content {
      display: none;
    }

    .chat-content.active {
      display: block;
    }

    .chat-messages {
      height: 280px;
      overflow-y: auto;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      margin-bottom: 12px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }

    .chat-message {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      animation: fadeIn 0.3s ease;
    }

    .chat-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-content-msg {
      flex: 1;
    }

    .chat-author {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.9em;
      margin-bottom: 4px;
    }

    .chat-text {
      color: var(--text-primary);
      font-size: 0.95em;
      line-height: 1.4;
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .chat-input-container .chat-reply-bar {
      width: 100%;
    }

    .chat-input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      color: white;
      font-size: 0.95em;
      font-family: 'Poppins', sans-serif;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* ========== @MEN√á√ÉO E RESPOSTA ========== */

    /* Container do input com autocomplete */
    .chat-input-wrapper {
      position: relative;
      flex: 1;
    }
    .chat-input-wrapper .chat-input {
      width: 100%;
      box-sizing: border-box;
    }

    /* Autocomplete dropdown */
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: #1a2332;
      border: 1px solid rgba(167, 139, 250, 0.4);
      border-radius: 10px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 500;
      margin-bottom: 4px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      display: none;
    }
    .mention-dropdown.active {
      display: block;
      animation: fadeIn 0.15s ease;
    }
    .mention-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.85em;
      transition: background 0.15s;
    }
    .mention-item:hover, .mention-item.selected {
      background: rgba(167, 139, 250, 0.15);
    }
    .mention-item img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* @men√ß√£o no texto do chat */
    .chat-mention {
      color: #a78bfa;
      font-weight: 600;
      cursor: pointer;
    }
    .chat-mention.is-me {
      background: rgba(167, 139, 250, 0.2);
      padding: 1px 4px;
      border-radius: 4px;
    }

    /* Reply quote */
    .chat-reply-quote {
      font-size: 0.75em;
      color: #7f8c8d;
      padding: 4px 8px;
      border-left: 2px solid rgba(167, 139, 250, 0.5);
      margin-bottom: 4px;
      background: rgba(255,255,255,0.03);
      border-radius: 0 6px 6px 0;
      max-height: 32px;
      overflow: hidden;
    }
    .chat-reply-quote strong {
      color: #a78bfa;
    }

    /* Reply preview bar (above input) */
    .chat-reply-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(167, 139, 250, 0.1);
      border: 1px solid rgba(167, 139, 250, 0.2);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 0.8em;
    }
    .chat-reply-bar.active {
      display: flex;
    }
    .chat-reply-bar .reply-text {
      flex: 1;
      color: #a78bfa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-reply-bar .reply-close {
      background: none;
      border: none;
      color: #7f8c8d;
      font-size: 1.1em;
      cursor: pointer;
      padding: 0 4px;
    }

    /* Bot√£o responder no hover da mensagem */
    .chat-message {
      position: relative;
    }
    .chat-msg-actions {
      position: absolute;
      top: 6px;
      right: 6px;
      display: none;
    }
    .chat-message:hover .chat-msg-actions {
      display: flex;
    }
    .btn-reply {
      background: rgba(167, 139, 250, 0.2);
      border: none;
      color: #a78bfa;
      font-size: 0.7em;
      padding: 3px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-reply:hover {
      background: rgba(167, 139, 250, 0.35);
    }

    /* ========== FIM @MEN√á√ÉO E RESPOSTA ========== */

    .chat-send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      border: none;
      border-radius: 10px;
      color: var(--bg-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
    }

    /* Ranking Section - COLAPS√ÅVEL */
    .ranking-section {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: var(--card-radius);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      overflow: hidden;
      overflow-x: hidden;
    }
    
    .ranking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
      transition: background 0.3s;
    }
    
    .ranking-header:hover {
      background: rgba(255,255,255,0.06);
    }

    .ranking-title {
      font-size: 1.1em;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }
    
    .ranking-toggle {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2em;
      cursor: pointer;
      transition: transform 0.3s;
      padding: 5px;
    }
    
    .ranking-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .ranking-body {
      padding: 0 20px 20px;
      max-height: 500px;
      overflow: hidden;
      overflow-x: hidden;
      transition: max-height 0.4s ease, padding 0.4s ease;
    }
    
    .ranking-body.collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .ranking-list {
      list-style: none;
      max-height: 350px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .ranking-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(5px);
    }

    .ranking-item:first-child {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
      border: 1px solid rgba(255, 215, 0, 0.2);
    }
    
    .ranking-item.is-me {
      background: linear-gradient(135deg, rgba(255, 181, 71, 0.2), rgba(255, 140, 66, 0.1));
      border: 1px solid rgba(255, 181, 71, 0.3);
    }

    .ranking-position {
      font-size: 1.1em;
      font-weight: 800;
      min-width: 30px;
      text-align: center;
    }
    
    /* ‚úÖ CHAT FULLSCREEN */
    .chat-section {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(37, 43, 72, 0.8) 100%);
      border-radius: var(--card-radius);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      position: relative;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--glass-border);
    }
    
    .chat-header-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--accent);
    }
    
    .chat-fullscreen-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }
    
    .chat-fullscreen-btn:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .chat-section.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9000;
      border-radius: 0;
      display: flex;
      flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    .chat-section.fullscreen .chat-messages {
      flex: 1;
      height: auto;
      max-height: none;
      border-radius: 0;
      overflow-y: auto;
      min-height: 0;
    }
    
    .chat-section.fullscreen .chat-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px 15px;
      overflow: hidden;
    }
    
    .chat-section.fullscreen .chat-content.active {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    
    .chat-section.fullscreen .chat-input-container {
      flex-shrink: 0;
      padding-top: 8px;
    }
    
    .chat-body {
      padding: 15px 20px 20px;
    }

    .ranking-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .ranking-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ranking-name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .ranking-jersey {
      display: inline-flex;
      flex-shrink: 0;
    }

    .ranking-jersey svg {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }
    
    .ranking-time {
      font-size: 0.75em;
      color: var(--text-secondary);
    }
    
    .ranking-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .ranking-points {
      font-weight: 700;
      color: var(--accent);
    }
    
    .ranking-credits {
      font-size: 0.85em;
      color: #2ecc71;
      font-weight: 600;
    }
    
    /* Premia√ß√£o Info */
    .premiacao-info {
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
    }
    
    .premiacao-aviso {
      background: rgba(241, 196, 15, 0.15);
      border: 1px solid rgba(241, 196, 15, 0.3);
      padding: 12px;
      border-radius: 10px;
      color: #f1c40f;
    }
    
    .premiacao-aviso small {
      opacity: 0.7;
    }
    
    .premiacao-ativa {
      background: rgba(46, 204, 113, 0.15);
      border: 1px solid rgba(46, 204, 113, 0.3);
      padding: 12px;
      border-radius: 10px;
      color: #2ecc71;
      text-align: center;
      font-size: 1.1em;
    }
    
    .premiacao-breakdown {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 8px;
      font-size: 0.85em;
      flex-wrap: wrap;
    }
    
    .premiacao-breakdown span {
      background: rgba(0,0,0,0.2);
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    /* ========== BARRA DE COMPARTILHAMENTO ========== */
    .share-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      z-index: 1000;
    }

    .share-bar-text {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85em;
      margin-right: 5px;
    }

    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 0.85em;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .share-btn-whatsapp {
      background: linear-gradient(135deg, #25D366, #128C7E);
      color: white;
    }

    .share-btn-whatsapp:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(37, 211, 102, 0.4);
    }

    .share-btn-instagram {
      background: linear-gradient(135deg, #833AB4, #FD1D1D, #F77737);
      color: white;
    }

    .share-btn-instagram:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(131, 58, 180, 0.4);
    }

    .share-btn-icon {
      font-size: 1.2em;
    }

    @media (max-width: 500px) {
      .share-bar {
        padding: 10px 15px;
        gap: 10px;
      }
      
      .share-bar-text {
        display: none;
      }
      
      .share-btn {
        padding: 8px 12px;
        font-size: 0.8em;
      }
    }
    
    /* Espa√ßo extra no container para n√£o sobrepor a barra e o FAB */
    .container {
      padding-bottom: 140px;
    }
    
    /* Modal de Premia√ß√£o */
    .premiacao-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .premiacao-modal {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 25px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid var(--accent);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    .premiacao-modal h2 {
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #ffd700, #ffb347);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .premiacao-total {
      text-align: center;
      padding: 15px;
      background: rgba(255,181,71,0.1);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .premiacao-total small {
      opacity: 0.7;
    }
    
    .premiacao-secao {
      margin-bottom: 20px;
    }
    
    .premiacao-secao h3 {
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    .premiacao-lista {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .premiacao-lista li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 6px;
    }
    
    .premiacao-lista li:first-child {
      background: rgba(255,215,0,0.15);
      border: 1px solid rgba(255,215,0,0.3);
    }
    
    .btn-fechar-premiacao {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn-fechar-premiacao:hover {
      transform: scale(1.02);
    }
    
    /* ========== ANIMA√á√ÉO DE PREMIA√á√ÉO PESSOAL ========== */
    .vitoria-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      animation: fadeIn 0.5s ease;
    }

    .vitoria-modal {
      text-align: center;
      padding: 40px 30px;
      max-width: 400px;
      animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.95); }
      100% { transform: scale(1); opacity: 1; }
    }

    .vitoria-medalha {
      font-size: 80px;
      animation: spin3d 2s ease infinite;
      margin-bottom: 20px;
    }

    @keyframes spin3d {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }

    .vitoria-posicao {
      font-size: 3em;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd700, #ffb347, #ff8c42);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(255,215,0,0.5);
    }

    .vitoria-texto {
      font-size: 1.3em;
      color: #fff;
      margin-bottom: 25px;
    }

    .vitoria-premio {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      background: linear-gradient(135deg, rgba(46,204,113,0.3), rgba(39,174,96,0.2));
      border: 2px solid #2ecc71;
      border-radius: 20px;
      padding: 20px 30px;
      margin-bottom: 30px;
      animation: pulseGlow 2s ease infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(46,204,113,0.3); }
      50% { box-shadow: 0 0 40px rgba(46,204,113,0.6); }
    }

    .vitoria-premio-valor {
      font-size: 2.5em;
      font-weight: 800;
      color: #2ecc71;
    }

    .vitoria-premio-tipo {
      font-size: 0.9em;
      color: rgba(255,255,255,0.7);
    }

    .vitoria-btn {
      padding: 15px 40px;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      border: none;
      border-radius: 30px;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .vitoria-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(255,181,71,0.4);
    }

    /* Confetes - CORRIGIDO */
    .confete {
      position: fixed;
      top: 0;
      width: 10px;
      height: 10px;
      z-index: 19999;
      pointer-events: none;
    }

    @keyframes confeteFall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    
    /* ========== TELA DE ENCERRAMENTO PARA TODOS ========== */
    .encerramento-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 18000;
      animation: fadeIn 0.5s ease;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    .encerramento-modal {
      text-align: center;
      padding: 30px 20px;
      max-width: 420px;
      width: 90%;
      background: linear-gradient(135deg, #1a1f3a 0%, #252b48 100%);
      border-radius: 24px;
      border: 2px solid rgba(255, 181, 71, 0.3);
      animation: bounceIn 0.6s ease;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .encerramento-titulo {
      font-size: 3em;
      margin-bottom: 5px;
    }
    
    .encerramento-subtitulo {
      font-size: 1.6em;
      font-weight: 700;
      background: linear-gradient(135deg, #ffd700, #ffb347);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
    }
    
    .encerramento-resumo {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .resumo-item {
      background: rgba(255,255,255,0.05);
      padding: 15px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .resumo-valor {
      font-size: 1.8em;
      font-weight: 800;
      color: var(--accent);
    }
    
    .resumo-label {
      font-size: 0.75em;
      color: var(--text-secondary);
      margin-top: 3px;
    }
    
    .encerramento-posicao {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.1));
      border: 2px solid #2ecc71;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .posicao-numero {
      font-size: 2.5em;
      font-weight: 900;
    }
    
    .posicao-texto {
      font-size: 0.9em;
      color: rgba(255,255,255,0.7);
    }
    
    .encerramento-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--accent), #ff8c42);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.2s;
      font-family: 'Poppins', sans-serif;
    }
    
    .encerramento-btn:hover {
      transform: scale(1.02);
    }
    
    .encerramento-btn.secundario {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .encerramento-premio {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.1));
      border: 2px solid #ffd700;
      border-radius: 16px;
      padding: 15px;
      margin: 15px 0;
      animation: pulseGlow 2s ease infinite;
    }
    
    .premio-titulo {
      font-size: 1.1em;
      color: #ffd700;
      margin-bottom: 5px;
    }
    
    .premio-valor {
      font-size: 2em;
      font-weight: 800;
      color: #2ecc71;
    }
    
    @media (max-width: 500px) {
      .premiacao-sorteios {
        grid-template-columns: 1fr;
      }
      
      .vitoria-medalha {
        font-size: 60px;
      }
      
      .vitoria-posicao {
        font-size: 2em;
      }
      
      .vitoria-premio-valor {
        font-size: 2em;
      }
    }

    /* ‚úÖ RESPONSIVE MOBILE - OTIMIZADO */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        padding-bottom: 160px; /* Espa√ßo para o FAB + share bar */
      }
      
      .header {
        margin-bottom: 15px;
        gap: 10px;
      }
      
      .btn-back {
        padding: 10px 16px;
        font-size: 0.9em;
      }
      
      .user-info {
        gap: 10px;
      }
      
      .user-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.9em;
      }
      
      .match-header {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: var(--card-radius);
      }
      
      .match-title {
        font-size: 1.1em;
        margin-bottom: 10px;
      }
      
      .match-info {
        font-size: 0.8em;
        gap: 12px;
      }

      .teams-section {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .team-card {
        padding: 10px 8px;
      }
      
      .team-card.my-team::after {
        font-size: 0.55em;
        padding: 2px 6px;
        top: 5px;
        right: 5px;
      }

      .team-jersey {
        width: 32px;
        height: 36px;
        margin-bottom: 5px;
      }

      .team-name {
        font-size: 0.75em;
        padding: 5px 6px;
      }

      .team-stats {
        gap: 5px;
      }

      .stat-value {
        font-size: 1.2em;
      }

      .stat-label {
        font-size: 0.6em;
      }
      
      /* Barras de for√ßa compactas */
      .force-bars-container {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: var(--card-radius);
      }
      
      .force-bar-section {
        margin-bottom: 12px;
      }
      
      .force-bar-title {
        font-size: 0.75em;
      }
      
      .force-bar-wrapper {
        height: 24px;
      }
      
      .force-bar {
        font-size: 0.7em;
        min-width: 40px;
      }
      
      /* Se√ß√£o de resposta compacta */
      .answer-section {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: var(--card-radius);
      }
      
      .credits-display {
        gap: 10px;
        margin-bottom: 15px;
      }
      
      .credit-badge {
        padding: 8px 12px;
        font-size: 0.8em;
      }
      
      .streak-container {
        gap: 8px;
        margin-bottom: 15px;
      }
      
      .streak-badge {
        padding: 6px 10px;
        font-size: 0.75em;
      }

      .chat-ranking-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .chat-section, .ranking-section {
        border-radius: var(--card-radius);
      }
      
      .chat-messages {
        height: 250px;
      }
      
      .ranking-header {
        padding: 12px 15px;
      }
      
      .ranking-title {
        font-size: 1em;
      }
      
      .ranking-body {
        padding: 0 15px 15px;
      }
      
      .ranking-item {
        padding: 8px 10px;
        gap: 10px;
      }
      
      .ranking-position {
        font-size: 1em;
        min-width: 25px;
      }
    }

    @media (max-width: 400px) {
      .team-jersey {
        width: 28px;
        height: 32px;
      }

      .team-name {
        font-size: 0.7em;
        padding: 4px 5px;
      }

      .stat-value {
        font-size: 1.1em;
      }
      
      .stat-label {
        font-size: 0.55em;
      }
      
      .match-title {
        font-size: 1em;
      }
      
      .credit-badge {
        padding: 6px 10px;
        font-size: 0.75em;
      }
    }
    
    /* ‚úÖ MODO PAISAGEM */
    @media (max-height: 500px) and (orientation: landscape) {
      .container {
        padding: 10px;
        padding-bottom: 80px;
      }
      
      .match-header {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .teams-section {
        margin-bottom: 10px;
      }
      
      .team-card {
        padding: 8px;
      }
      
      .force-bars-container {
        display: none; /* Esconder em paisagem para economizar espa√ßo */
      }
      
      .answer-section {
        padding: 10px;
      }
      
      .chat-messages {
        height: 150px;
      }
    }

      .stat-value {
        font-size: 1em;
      }
    }

    /* ========== OVERLAY SEM CR√âDITOS ========== */
    .sem-creditos-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .sem-creditos-card {
      background: linear-gradient(145deg, #1a2332 0%, #0e141b 100%);
      border: 2px solid rgba(255, 170, 50, 0.4);
      border-radius: 24px;
      padding: 32px 28px;
      max-width: 360px;
      width: 90%;
      text-align: center;
      animation: bounceIn 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    .sem-creditos-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(255, 170, 50, 0.1), transparent, rgba(76, 175, 80, 0.1), transparent);
      animation: spin 6s linear infinite;
    }

    .sem-creditos-card > * {
      position: relative;
      z-index: 1;
    }

    .sem-creditos-emoji {
      font-size: 3em;
      animation: bounce 1s ease infinite alternate;
      margin-bottom: 8px;
    }

    .sem-creditos-titulo {
      font-size: 1.4em;
      font-weight: 700;
      color: #ffaa32;
      margin-bottom: 6px;
    }

    .sem-creditos-msg {
      font-size: 0.9em;
      color: #a4b0be;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .sem-creditos-timer {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 20px;
    }

    .sem-creditos-timer-label {
      font-size: 0.75em;
      color: #4caf50;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .sem-creditos-timer-valor {
      font-size: 1.8em;
      font-weight: 800;
      color: #4caf50;
      font-variant-numeric: tabular-nums;
    }

    .sem-creditos-timer-hint {
      font-size: 0.7em;
      color: #7f8c8d;
      margin-top: 2px;
    }

    .btn-comprar-creditos {
      display: block;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      font-size: 1.05em;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
      color: white;
      cursor: pointer;
      background: linear-gradient(135deg, #ff6b35, #ffaa32);
      box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
      transition: all 0.3s ease;
      animation: pulseBtn 2s ease infinite;
      margin-bottom: 10px;
    }

    .btn-comprar-creditos:hover {
      transform: scale(1.03);
      box-shadow: 0 6px 28px rgba(255, 107, 53, 0.6);
    }

    @keyframes pulseBtn {
      0%, 100% { box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(255, 107, 53, 0.7); }
    }

    .btn-fechar-overlay {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      color: #7f8c8d;
      padding: 10px;
      border-radius: 10px;
      font-size: 0.85em;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }

    .btn-fechar-overlay:hover {
      border-color: rgba(255,255,255,0.3);
      color: #bbb;
    }

    /* Toast de cr√©dito b√¥nus */
    .bonus-toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      padding: 14px 24px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 0.95em;
      z-index: 10001;
      animation: bonusToastAnim 4s ease forwards;
      box-shadow: 0 8px 30px rgba(46, 204, 113, 0.5);
      text-align: center;
    }

    .bonus-toast small {
      display: block;
      font-weight: 400;
      font-size: 0.8em;
      opacity: 0.9;
      margin-top: 2px;
    }

    @keyframes bonusToastAnim {
      0% { opacity: 0; transform: translateX(-50%) translateY(-30px) scale(0.8); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.05); }
      15% { transform: translateX(-50%) translateY(0) scale(1); }
      80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }

    /* Cooldown timer entre ciclos de perguntas */
    .drip-mini-timer {
      display: none;
      text-align: center;
      padding: 8px 12px;
      margin: 8px 0;
      background: rgba(255, 159, 67, 0.15);
      border-radius: 10px;
      font-size: 0.85em;
      color: var(--accent);
      animation: pulse 2s infinite;
    }

    .drip-mini-timer.visible {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-adiantar {
      background: linear-gradient(135deg, #a78bfa, #7c3aed);
      color: white;
      border: none;
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn-adiantar:hover { transform: scale(1.05); }
    .btn-adiantar:active { transform: scale(0.95); }
    .btn-adiantar:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Badge de cr√©ditos clic√°vel */
    .credit-badge.paid {
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .credit-badge.paid:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 170, 50, 0.3);
    }

    .credit-badge.paid:active {
      transform: scale(0.97);
    }

    /* ========== MINI LOJA REMOVIDA ‚Äî Redirecionada para loja-passes ========== */

    /* ========== üî• SISTEMA VICIANTE ‚Äî NOVAS FEATURES ========== */

    /* Competitive Progress Bar */
    .competitive-bar {
      display: none;
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255,181,71,0.08), rgba(255,140,66,0.04));
      border: 1px solid rgba(255,181,71,0.15);
      border-radius: 12px;
      margin-bottom: 12px;
      animation: fadeIn 0.4s ease;
    }
    .competitive-bar.active { display: block; }
    .competitive-bar-text {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-align: center;
    }
    .competitive-bar-text strong {
      color: var(--accent);
    }
    .competitive-bar-track {
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .competitive-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #ff8c42);
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .competitive-bar-fill::after {
      content: '';
      position: absolute;
      right: 0; top: 0; bottom: 0;
      width: 20px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
      animation: shimmer 1.5s ease infinite;
    }
    @keyframes shimmer {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    /* Streak Progress (faltam X pra multiplicador) */
    .streak-progress {
      display: none;
      text-align: center;
      margin-bottom: 8px;
      animation: fadeIn 0.3s ease;
    }
    .streak-progress.active { display: block; }
    .streak-progress-text {
      font-size: 0.75em;
      color: #ff6432;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .streak-progress-dots {
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    .streak-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
      background: rgba(255,100,50,0.15);
      border: 2px solid rgba(255,100,50,0.3);
      transition: all 0.3s ease;
    }
    .streak-dot.filled {
      background: #ff6432;
      border-color: #ff6432;
      box-shadow: 0 0 8px rgba(255,100,50,0.6);
    }
    .streak-dot.next {
      border-color: #ff6432;
      animation: pulse 1s ease infinite;
    }

    /* Micro-Meta (desafio rotativo) */
    .micro-meta {
      display: none;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(79,70,229,0.05));
      border: 1px solid rgba(147,51,234,0.2);
      border-radius: 12px;
      margin-bottom: 12px;
      animation: fadeIn 0.4s ease;
    }
    .micro-meta.active { display: block; }
    .micro-meta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .micro-meta-title {
      font-size: 0.8em;
      font-weight: 700;
      color: #a78bfa;
    }
    .micro-meta-reward {
      font-size: 0.7em;
      background: rgba(167,139,250,0.2);
      padding: 3px 8px;
      border-radius: 8px;
      color: #a78bfa;
      font-weight: 600;
    }
    .micro-meta-desc {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .micro-meta-progress {
      height: 6px;
      background: rgba(255,255,255,0.08);
      border-radius: 3px;
      overflow: hidden;
    }
    .micro-meta-fill {
      height: 100%;
      background: linear-gradient(90deg, #a78bfa, #8b5cf6);
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .micro-meta-count {
      font-size: 0.7em;
      color: #a78bfa;
      text-align: right;
      margin-top: 4px;
    }

    /* Confetti Canvas */
    #confettiCanvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 20000;
    }

    /* Big Celebration Overlay */
    .celebration-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 15000;
      pointer-events: none;
      animation: fadeIn 0.2s ease;
    }
    .celebration-text {
      font-size: 2.5em;
      font-weight: 900;
      text-align: center;
      text-shadow: 0 0 40px rgba(0,0,0,0.8), 0 4px 20px rgba(0,0,0,0.5);
      animation: celebrationPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes celebrationPop {
      0% { opacity: 0; transform: scale(0.3) rotate(-10deg); }
      50% { opacity: 1; transform: scale(1.15) rotate(3deg); }
      100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    @keyframes celebrationOut {
      to { opacity: 0; transform: scale(1.5) translateY(-50px); }
    }

    /* Ranking Overtake Flash */
    .overtake-toast {
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 14px 28px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 1em;
      z-index: 15000;
      box-shadow: 0 10px 40px rgba(16,185,129,0.5);
      animation: toastSlideUp 0.4s ease, celebrationOut 0.5s ease 2s forwards;
      text-align: center;
    }

    /* Answer section state management */
    .answer-section .cooldown-only {
      display: none;
    }
    .answer-section.in-cooldown .cooldown-only {
      display: block;
    }
    .answer-section.in-cooldown .hide-on-cooldown {
      display: none;
    }

    /* Streak milestone names */
    .streak-milestone-name {
      font-size: 0.65em;
      color: #ff6432;
      text-align: center;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 2px;
      animation: fadeIn 0.3s ease;
    }

    /* ========== FIM SISTEMA VICIANTE ========== */
  
    /* ‚ö° MOMENTUM v3 ‚Äî PHASE INDICATOR */
    .momentum-phase-bar {
      margin: 8px 0; padding: 10px 14px; border-radius: 12px;
      display: flex; align-items: center; justify-content: space-between;
      font-size: 0.82em; font-weight: 600; transition: all 0.4s ease;
      position: relative; overflow: hidden;
    }
    .momentum-phase-bar .phase-label { display:flex; align-items:center; gap:6px; z-index:1; }
    .momentum-phase-bar .phase-info { z-index:1; font-size:0.9em; opacity:0.9; }
    .momentum-phase-bar .phase-fill {
      position:absolute; left:0; top:0; bottom:0;
      transition: width 0.5s ease; border-radius:12px;
    }
    .momentum-phase-bar.fase-1 { background:rgba(52,211,153,0.15); border:1px solid rgba(52,211,153,0.3); color:#34d399; }
    .momentum-phase-bar.fase-1 .phase-fill { background:rgba(52,211,153,0.2); }
    .momentum-phase-bar.fase-2 {
      background:rgba(167,139,250,0.15); border:1px solid rgba(167,139,250,0.4); color:#c4b5fd;
      animation: momentumPulse 2s ease-in-out infinite;
    }
    .momentum-phase-bar.fase-2 .phase-fill { background:linear-gradient(90deg,rgba(167,139,250,0.25),rgba(129,140,248,0.25)); }
    @keyframes momentumPulse {
      0%,100% { box-shadow:0 0 10px rgba(167,139,250,0.2); }
      50% { box-shadow:0 0 20px rgba(167,139,250,0.4),0 0 40px rgba(167,139,250,0.1); }
    }
    .momentum-phase-bar.fase-3 { background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.3); color:#fca5a5; }
    .momentum-phase-bar.fase-3 .phase-fill { background:linear-gradient(90deg,rgba(239,68,68,0.2),rgba(249,115,22,0.2)); }
    .momentum-phase-bar .btn-skip-inline {
      background:linear-gradient(135deg,#8b5cf6,#6d28d9); border:none; color:white;
      padding:4px 10px; border-radius:8px; font-size:0.78em; font-weight:600; cursor:pointer; z-index:1;
    }

    /* üì° LIVE FEED ‚Äî floating overlay, 3 msgs, subtle */
    .live-feed-float {
      position: fixed; bottom: 90px; left: 12px; right: 12px;
      z-index: 100; pointer-events: none;
      opacity: 0.35; transition: opacity 0.4s ease;
    }
    .live-feed-float:hover, .live-feed-float.active {
      opacity: 0.9; pointer-events: auto;
    }
    .live-feed-float .lf-msg {
      font-size: 0.7em; padding: 4px 10px; margin-bottom: 3px;
      background: rgba(10,14,39,0.7); backdrop-filter: blur(6px);
      border-radius: 8px; color: rgba(255,255,255,0.85);
      animation: lfSlide 0.3s ease; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .live-feed-float .lf-msg.fading { opacity:0; transition:opacity 0.5s; }
    .live-feed-float .lf-tap {
      font-size: 0.6em; text-align: center; opacity: 0.4;
      padding: 2px 0; cursor: pointer; pointer-events: auto;
    }
    @keyframes lfSlide { from { transform:translateY(8px); opacity:0; } to { transform:translateY(0); opacity:1; } }

    /* üó≥Ô∏è ENQUETE FIXA */
    .enquete-fixa {
      margin:8px 0; padding:8px 12px; border-radius:10px;
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
    }
    .enquete-fixa-titulo { font-size:0.75em; font-weight:600; margin-bottom:6px; color:var(--text-secondary); }
    .enquete-fixa-opcoes { display:flex; gap:5px; flex-wrap:wrap; }
    .enquete-fixa-btn {
      flex:1; min-width:60px; padding:6px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05);
      color:var(--text-primary); font-size:0.7em; font-weight:500;
      cursor:pointer; text-align:center; transition:all 0.2s; position:relative; overflow:hidden;
    }
    .enquete-fixa-btn:hover { background:rgba(255,255,255,0.1); }
    .enquete-fixa-btn.voted { border-color:rgba(167,139,250,0.5); background:rgba(167,139,250,0.15); }
    .enquete-fixa-btn .ef-bar { position:absolute; left:0; top:0; bottom:0; background:rgba(167,139,250,0.15); transition:width 0.5s; border-radius:8px; }
    .enquete-fixa-btn .ef-label { position:relative; z-index:1; }
    .enquete-fixa-trocar { font-size:0.65em; color:var(--text-secondary); text-align:center; margin-top:4px; cursor:pointer; opacity:0.6; }

    /* üèÜ ALERTAS COMPETITIVOS */
    .alerta-competitivo {
      position:fixed; top:60px; left:50%; transform:translateX(-50%) translateY(-100%);
      background:rgba(20,25,50,0.92); backdrop-filter:blur(12px);
      border:1px solid rgba(167,139,250,0.3); border-radius:14px;
      padding:12px 20px; font-size:0.82em; font-weight:600; color:var(--text-primary);
      z-index:8000; max-width:88vw; text-align:center; box-shadow:0 8px 30px rgba(0,0,0,0.4);
      transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); pointer-events:none;
    }
    .alerta-competitivo.show { transform:translateX(-50%) translateY(0); }

    /* ‚ö° MOMENTUM OVERLAY */
    .momentum-overlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      display:flex; align-items:center; justify-content:center;
      z-index:9500; pointer-events:none; opacity:0; transition:opacity 0.3s;
    }
    .momentum-overlay.active { opacity:1; }
    .momentum-overlay-content {
      font-size:2em; font-weight:800; text-align:center; text-shadow:0 0 30px currentColor;
      animation: moPop 0.6s ease;
    }
    .momentum-overlay-content.unlock { color:#a78bfa; }
    .momentum-overlay-content.break { color:#ef4444; }
    .momentum-overlay-content.phase-up { color:#34d399; }
    @keyframes moPop { 0%{transform:scale(0.5);opacity:0} 50%{transform:scale(1.2)} 100%{transform:scale(1);opacity:1} }

  
    /* ‚ö° FORCE BARS ‚Äî alive animations */
    .force-bar-wrapper { position: relative; }
    .force-bar { transition: width 0.8s cubic-bezier(0.25,0.46,0.45,0.94) !important; }
    .force-bar.just-changed { animation: barBounce 0.6s ease; }
    @keyframes barBounce { 0%,100%{transform:scaleY(1)} 40%{transform:scaleY(1.15)} 70%{transform:scaleY(0.95)} }
    .force-bar-section.tight-race .force-bar-wrapper {
      box-shadow: 0 0 12px rgba(255,181,71,0.3);
      animation: tightPulse 2s ease-in-out infinite;
    }
    @keyframes tightPulse { 0%,100%{box-shadow:0 0 8px rgba(255,181,71,0.2)} 50%{box-shadow:0 0 16px rgba(255,181,71,0.4)} }

    /* üî¥ Force bar lead change alert */
    .force-lead-alert {
      position: fixed; top: 0; left: 0; right: 0;
      padding: 10px 16px; text-align: center;
      font-size: 0.85em; font-weight: 700; z-index: 8500;
      transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
      backdrop-filter: blur(10px);
    }
    .force-lead-alert.show { transform: translateY(0); }
    .force-lead-alert.team-a { background: linear-gradient(90deg, var(--cor-timeA), rgba(10,14,39,0.9)); }
    .force-lead-alert.team-b { background: linear-gradient(90deg, rgba(10,14,39,0.9), var(--cor-timeB)); }

    /* ‚è±Ô∏è Timer PANIC ‚Äî last 3 seconds */
    .question-modal.timer-panic {
      animation: modalShake 0.15s infinite alternate !important;
    }
    .question-modal.timer-panic .timer-circle {
      animation: panicPulse 0.25s infinite !important;
      box-shadow: 0 0 20px rgba(239,68,68,0.6) !important;
    }
    @keyframes modalShake { 0%{transform:translateX(-2px)} 100%{transform:translateX(2px)} }
    @keyframes panicPulse { 0%{transform:scale(1);border-color:#ef4444} 50%{transform:scale(1.15);border-color:#ff0000} 100%{transform:scale(1)} }

    /* üìä Post-answer stat */
    .post-answer-stat {
      font-size: 0.78em; color: var(--text-secondary); margin-top: 6px;
      animation: fadeSlideUp 0.5s ease;
    }
    @keyframes fadeSlideUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

    /* üèÜ Prize count-up */
    .prize-reveal { animation: prizeReveal 0.8s cubic-bezier(0.34,1.56,0.64,1); }
    @keyframes prizeReveal { 0%{transform:scale(0.3);opacity:0} 60%{transform:scale(1.1)} 100%{transform:scale(1);opacity:1} }
    .prize-consolation {
      background: linear-gradient(135deg, rgba(167,139,250,0.15), rgba(59,130,246,0.15));
      border-radius: 12px; padding: 12px 16px; margin: 10px 0; text-align: center;
    }

  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p class="loading-text">Carregando jogo...</p>
  </div>

  <div class="container" id="mainContainer">
    
    <!-- Header -->
    <div class="header">
      <button class="btn-back" onclick="voltarPainel()">
        ‚Üê Voltar
      </button>
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div>
          <strong id="userName">Usu√°rio</strong>
          <div style="font-size: 0.85em; color: var(--text-secondary);" id="userLevel">Level 1</div>
        </div>
      </div>
    </div>

    <!-- Teams (TOPO) -->
    <div class="teams-section">
      <div class="team-card" id="teamACard">
        <div id="jerseyA" class="team-jersey"></div>
        <div class="team-name" id="teamAName">
          Time A
        </div>
        <div class="team-stats">
          <div class="stat">
            <span class="stat-value" id="teamATorcida">0</span>
            <span class="stat-label">Torcedores</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="teamAPontos">0</span>
            <span class="stat-label">Pontos</span>
          </div>
        </div>
      </div>

      <div class="team-card" id="teamBCard">
        <div id="jerseyB" class="team-jersey"></div>
        <div class="team-name" id="teamBName">
          Time B
        </div>
        <div class="team-stats">
          <div class="stat">
            <span class="stat-value" id="teamBTorcida">0</span>
            <span class="stat-label">Torcedores</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="teamBPontos">0</span>
            <span class="stat-label">Pontos</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Match Info (sem nomes dos times) -->
    <div class="match-header">
      <div class="match-info">
        <span id="liveBadge" class="live-badge ao-vivo">
          <span class="live-dot"></span> AO VIVO
        </span>
        <span>üèÜ <span id="matchLeague">Liga</span></span>
        <span>üìÖ <span id="matchDate">Data</span></span>
        <span>‚è≥ Restante: <span class="timer" id="timer">--:--</span></span>
      </div>
      <div class="online-counter" id="onlineCounter">
        <span class="online-dot"></span>
        <span><strong id="onlineCount">0</strong> torcedores ao vivo</span>
      </div>
    </div>
    
    <!-- matchTitle oculto para manter compatibilidade JS -->
    <h1 id="matchTitle" style="display:none;">Time A vs Time B</h1>

    <!-- Barras de For√ßa -->
    <div class="force-bars-container">
      <!-- Barra de Torcida -->
      <div class="force-bar-section">
        <div class="force-bar-title">
          <div class="team-label">
            <span id="forceTeamAName">Time A</span>
          </div>
          <span>üë• FOR√áA DA TORCIDA</span>
          <div class="team-label">
            <span id="forceTeamBName">Time B</span>
          </div>
        </div>
        <div class="force-bar-wrapper">
          <div class="force-bar team-a" id="forceTorcidaA" style="width: 50%;">
            <span id="forceTorcidaAPerc">50%</span>
          </div>
          <div class="force-bar team-b" id="forceTorcidaB" style="width: 50%;">
            <span id="forceTorcidaBPerc">50%</span>
          </div>
        </div>
      </div>

      <!-- Barra de Pontua√ß√£o -->
      <div class="force-bar-section">
        <div class="force-bar-title">
          <div class="team-label">
            <span id="pointsTeamAValue">0 pts</span>
          </div>
          <span>üèÜ PONTUA√á√ÉO</span>
          <div class="team-label">
            <span id="pointsTeamBValue">0 pts</span>
          </div>
        </div>
        <div class="force-bar-wrapper">
          <div class="force-bar team-a" id="forcePontosA" style="width: 50%;">
            <span id="forcePontosAPerc">50%</span>
          </div>
          <div class="force-bar team-b" id="forcePontosB" style="width: 50%;">
            <span id="forcePontosBPerc">50%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- üìä MINI STATS PESSOAL -->
    <div class="my-stats-bar" id="myStatsBar">
      <div class="my-stat">
        <span>üèÜ</span>
        <span class="my-stat-val" id="myRankPos">--</span>
        <span class="my-stat-label">¬∫ lugar</span>
      </div>
      <span class="my-stat-sep">|</span>
      <div class="my-stat">
        <span class="my-stat-val" id="myPontos">0</span>
        <span class="my-stat-label">pts</span>
      </div>
      <span class="my-stat-sep">|</span>
      <div class="my-stat">
        <span>‚úÖ</span>
        <span class="my-stat-val" id="myAcertos">0</span>
        <span class="my-stat-label">/</span>
        <span>‚ùå</span>
        <span class="my-stat-val" id="myErros">0</span>
      </div>
      <span class="my-stat-sep">|</span>
      <div class="my-stat">
        <span>üî•</span>
        <span class="my-stat-val" id="myStreakMax">0</span>
        <span class="my-stat-label">max</span>
      </div>
    </div>

    <!-- Answer Section -->
    
    <!-- üì° LIVE FEED floating -->
    <div class="live-feed-float" id="liveFeedFloat" onclick="this.classList.toggle('active')">
      <div id="liveFeedMessages"></div>
      <div class="lf-tap" onclick="event.stopPropagation();toggleChatFullscreen()">üí¨ Abrir chat</div>
    </div>
    <!-- ‚ö° MOMENTUM OVERLAY -->
    <div class="momentum-overlay" id="momentumOverlay">
      <div class="momentum-overlay-content" id="momentumOverlayContent"></div>
    </div>
    <!-- üèÜ ALERTA COMPETITIVO -->
    <div class="alerta-competitivo" id="alertaCompetitivo"></div>
    <div class="force-lead-alert" id="forceLeadAlert"></div>

    <div class="answer-section" id="answerSection">
      <!-- ROW 1: Phase + Streak compact -->
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <div class="momentum-phase-bar fase-1" id="momentumPhaseBar" style="flex:1;margin:0;">
          <div class="phase-label"><span class="phase-icon">üéØ</span><span class="phase-text" id="phaseText">AQUECIMENTO</span></div>
          <div class="phase-info" id="phaseInfo">0/5</div>
          <div class="phase-fill" id="phaseFill" style="width:0%"></div>
        </div>
        <div class="streak-badge" id="streakBadge" style="margin:0;padding:6px 10px;">
          <span class="streak-icon">üî•</span>
          <span class="streak-count" id="streakCount">0</span>
        </div>
        <div class="multiplier-badge" id="multiplierBadge" style="display:none;margin:0;padding:6px 10px;">
          <span>‚ö°x<span id="multiplierValue">1</span></span>
        </div>
      </div>

      <!-- ROW 2: BOT√ÉO PRINCIPAL (pra cima!) -->
      <button class="btn-answer" id="btnAnswer" onclick="getQuestion()" style="margin-bottom:10px;">
        üéØ Responder Pergunta
      </button>

      <!-- ROW 3: Credits + Competitive bar compact -->
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <div class="credit-badge free" style="flex:0 0 auto;padding:4px 10px;font-size:0.78em;">
          <span>üéØ</span><strong id="perguntasDisponiveis" style="margin-left:4px;">5</strong>
        </div>
        <div class="credit-badge paid" id="creditsBadge" onclick="window.location.href='loja-passes.html'" style="flex:0 0 auto;padding:4px 10px;font-size:0.78em;" title="Ver Passes">
          <span>üíé</span><strong id="paidCredits" style="margin-left:4px;">0</strong>
        </div>
        <div class="competitive-bar" id="competitiveBar" style="flex:1;margin:0;">
          <div class="competitive-bar-text" id="competitiveText" style="font-size:0.72em;">
            Faltam <strong>3 pts</strong> para <strong>#3</strong>
          </div>
          <div class="competitive-bar-track" style="height:4px;">
            <div class="competitive-bar-fill" id="competitiveFill" style="width:0%"></div>
          </div>
        </div>
      </div>

      <!-- ROW 4: Micro-meta compact (1 line) -->
      <div class="micro-meta" id="microMeta" style="padding:6px 12px;margin-bottom:6px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <span class="micro-meta-title" id="microMetaTitle" style="font-size:0.72em;">üéØ DESAFIO</span>
          <span class="micro-meta-desc" id="microMetaDesc" style="font-size:0.7em;flex:1;">Acerte 3 em sequ√™ncia</span>
          <span class="micro-meta-count" id="microMetaCount" style="font-size:0.72em;font-weight:700;">0/3</span>
          <span class="micro-meta-reward" id="microMetaReward" style="font-size:0.68em;color:#a78bfa;">+25 XP</span>
        </div>
        <div class="micro-meta-progress" style="height:3px;margin-top:4px;">
          <div class="micro-meta-fill" id="microMetaFill" style="width:0%"></div>
        </div>
      </div>

      <!-- Timer de cooldown -->
      <div class="drip-mini-timer" id="cooldownTimer" style="display:none;">
        <span id="cooldownTexto">‚è≥ +<span id="cooldownQtd">1</span> pergunta em <span id="cooldownContagem">--:--</span></span>
        <button id="btnAdiantar" class="btn-adiantar" onclick="adiantarPerguntas()" style="display:none;">üíé Skip (1 cr)</button>
      </div>

      <!-- Patrocinador (cooldown) -->
      <div class="sponsor-mini-banner" id="sponsorMiniBanner" onclick="clicarMiniBanner()">
        <div class="sponsor-mini-logo" id="sponsorMiniLogo">üéÅ</div>
        <div class="sponsor-mini-info">
          <div class="sponsor-mini-tag">üì¢ Patrocinador</div>
          <div class="sponsor-mini-name" id="sponsorMiniName">--</div>
          <div class="sponsor-mini-cta" id="sponsorMiniCta">Toque para visitar ‚Üí</div>
        </div>
        <div class="sponsor-mini-reward" id="sponsorMiniReward">+10 pts</div>
      </div>

      <!-- Enquete fixa (cooldown) -->
      <div class="enquete-fixa" id="enqueteFixa" style="display:none;">
        <div class="enquete-fixa-titulo" id="enqueteFixaTitulo">üó≥Ô∏è Como t√° seu clima?</div>
        <div class="enquete-fixa-opcoes" id="enqueteFixaOpcoes"></div>
        <div class="enquete-fixa-trocar" id="enqueteFixaTrocar" onclick="trocarEnqueteFixa()">Trocar enquete</div>
      </div>

      <!-- Hidden elements kept for JS compatibility -->
      <div id="streakContainer" style="display:none;"></div>
      <div id="streakProgress" style="display:none;">
        <div id="streakProgressText"></div><div id="streakProgressDots"></div>
      </div>
      <div id="respostasBadge" style="display:none;"><span id="respostasCount">0</span></div>
    </div>
    
    <!-- ‚úÖ BOT√ÉO FLUTUANTE (FAB) - Instigante com texto -->
    <div class="fab-container" id="fabContainer">
      <button class="fab-btn" id="fabBtn" onclick="getQuestion()" title="Responder Pergunta">
        <span class="fab-icon">üéØ</span>
        <span class="fab-text">Pr√≥xima Pergunta!</span>
      </button>
    </div>

    <!-- üéØ MODAL FULLSCREEN DA PERGUNTA -->
    <div class="question-modal-overlay" id="questionModalOverlay">
      <div class="question-modal">
        <div class="question-container" id="questionContainer">
          <!-- Timer da Pergunta -->
          <div class="question-timer">
            <div class="timer-circle" id="questionTimerCircle">
              <span class="timer-value" id="questionTimerValue">10</span>
            </div>
            <p class="timer-label">segundos para responder</p>
          </div>

          <div class="question-points" id="questionPoints">Vale 10 pontos</div>
          <div class="question-text" id="questionText"></div>
          <div class="options-container" id="optionsContainer"></div>
          <div class="result-message" id="resultMessage"></div>
        </div>
      </div>
    </div>

    <!-- üìä ENQUETE AO VIVO -->
    <div class="enquete-section" id="enqueteSection">
      <div class="enquete-card" id="enqueteCard">
        <!-- Renderizado dinamicamente -->
      </div>
    </div>

    <!-- Chat and Ranking -->
    <div class="chat-ranking-grid">
      
      <!-- ‚úÖ CHAT COM FULLSCREEN -->
      <div class="chat-section" id="chatSection">
        <div class="chat-header">
          <span class="chat-header-title">üí¨ Chat ao Vivo</span>
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="provocar-btn" id="provocarBtn" onclick="toggleProvocarPanel()">üó£Ô∏è Provocar!</button>
            <button class="chat-fullscreen-btn" onclick="toggleChatFullscreen()">
              <span id="chatFullscreenIcon">‚õ∂</span> Expandir
            </button>
          </div>
        </div>
        
        <div class="chat-body">
          <div class="chat-tabs">
            <div class="chat-tab active" onclick="switchChat('team')">
              üíö Torcida
              <span class="chat-badge" id="teamChatBadge" style="display:none;">0</span>
            </div>
            <div class="chat-tab" onclick="switchChat('general')">
              üí¨ Geral
              <span class="chat-badge" id="generalChatBadge" style="display:none;">0</span>
            </div>
          </div>

          <!-- üó£Ô∏è PAINEL DE PROVOCA√á√ïES -->
          <div class="provocar-panel" id="provocarPanel">
            <div class="provocar-panel-title">üó£Ô∏è Manda uma provoca√ß√£o pra torcida advers√°ria!</div>
            <div class="provocar-grid" id="provocarGrid">
              <!-- Renderizado via JS -->
            </div>
            <div class="provocar-cooldown" id="provocarCooldown"></div>
          </div>

          <div class="chat-content active" id="teamChatContent">
            <div class="chat-messages" id="teamChat">
              <!-- Mensagens da torcida -->
            </div>
            <div class="chat-input-container">
              <div class="chat-reply-bar" id="teamReplyBar">
                <span class="reply-text" id="teamReplyText">Respondendo...</span>
                <button class="reply-close" onclick="cancelReply('team')">‚úï</button>
              </div>
              <div class="chat-input-wrapper">
                <div class="mention-dropdown" id="teamMentionDropdown"></div>
                <input 
                  type="text" 
                  class="chat-input" 
                  id="teamChatInput" 
                  placeholder="Mensagem para sua torcida..."
                  maxlength="200"
                  oninput="handleMentionInput(this, 'team')"
                />
              </div>
              <button class="chat-send-btn" onclick="sendMessage('team')">
                Enviar
              </button>
            </div>
          </div>

          <div class="chat-content" id="generalChatContent">
            <div class="chat-messages" id="generalChat">
              <!-- Mensagens gerais -->
            </div>
            <div class="chat-input-container">
              <div class="chat-reply-bar" id="generalReplyBar">
                <span class="reply-text" id="generalReplyText">Respondendo...</span>
                <button class="reply-close" onclick="cancelReply('general')">‚úï</button>
              </div>
              <div class="chat-input-wrapper">
                <div class="mention-dropdown" id="generalMentionDropdown"></div>
                <input 
                  type="text" 
                  class="chat-input" 
                  id="generalChatInput" 
                  placeholder="Mensagem para todos..."
                  maxlength="200"
                  oninput="handleMentionInput(this, 'general')"
                />
              </div>
              <button class="chat-send-btn" onclick="sendMessage('general')">
                Enviar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ RANKING COLAPS√ÅVEL -->
      <div class="ranking-section" id="rankingSection">
        <div class="ranking-header" onclick="toggleRanking()">
          <h3 class="ranking-title">üèÜ Ranking da Partida</h3>
          <button class="ranking-toggle" id="rankingToggle">‚ñº</button>
        </div>
        
        <div class="ranking-body" id="rankingBody">
          <!-- Info de Premia√ß√£o -->
          <div class="premiacao-info" id="premiacaoInfo">
            <div class="premiacao-ativa">
              üèÜ Carregando premia√ß√£o...
            </div>
          </div>
          
          <ul class="ranking-list" id="rankingList">
            <!-- Ranking ser√° inserido aqui -->
          </ul>
        </div>
      </div>

    </div>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>
  <script src="missoes-helper.js"></script>
  
  <!-- Utilit√°rio de Bandeiras -->
  <script src="js/bandeiras-utils.js"></script>
  
  <script>
    // ===================================
    // üî• CONFIGURA√á√ÉO FIREBASE
    // ===================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    // ===================================
    // üì¶ VARI√ÅVEIS GLOBAIS
    // ===================================
    let uid = null;
    let jogoId = null;
    let timeTorcida = null;          // ID do time que o usu√°rio est√° torcendo
    let timeCasaId = null;           // ID do time da casa
    let timeForaId = null;           // ID do time visitante
    let timeCasaData = null;         // Dados do time da casa
    let timeForaData = null;         // Dados do time visitante
    let currentQuestion = null;
    let perguntasSessao = new Set(); // Tracking para filtro (pode ser parcialmente resetado)
    let perguntasEsteJogo = new Set(); // ‚úÖ PERMANENTE: perguntas mostradas NESTE JOGO (nunca limpa)
    let perguntasCache = null;       // ‚úÖ CACHE: perguntas carregadas do Firestore (evita re-fetch)
    let buscandoPergunta = false;    // ‚úÖ Mutex: impede chamadas concorrentes
    let todasPerguntasRespondidas = false;
    let questionTimer = null;        // Timer da pergunta
    let questionTimeLeft = 10;       // 10 segundos por pergunta
    let questionStartTime = null;    // ‚úÖ NOVO: Momento que a pergunta apareceu
    let jogoStatus = null;           // Status calculado (agendado, ao_vivo, finalizado)
    let jogoDataInicio = null;       // ‚úÖ NOVO: Data/hora de in√≠cio do jogo
    let jogoDataFim = null;          // ‚úÖ NOVO: Data/hora de fim do jogo
    let jogoCreditosIniciais = 0;    // ‚úÖ NOVO: Cr√©ditos iniciais do admin
    let statusCheckInterval = null;  // ‚úÖ NOVO: Intervalo para checar status
    let premiacaoExecutada = false;  // ‚úÖ NOVO: Flag para evitar premiar m√∫ltiplas vezes

    // üéÆ GAMIFICA√á√ÉO
    let streak = 0;                  // Sequ√™ncia de acertos
    let maxStreak = 0;               // Maior sequ√™ncia
    let multiplicador = 1;           // Multiplicador de pontos
    let totalAcertos = 0;            // Total de acertos no jogo
    let totalErros = 0;              // Total de erros no jogo
    let minhaPosicaoAtual = null;    // Posi√ß√£o atual no ranking (para toast)
    let chatXpGanho = 0;             // XP ganho por chat neste jogo (max 10)
    let cicloInicialCompleto = false; // Se j√° completou as 5 perguntas iniciais

    // ‚è≥ COOLDOWN DO QUIZ
    let cooldownState = {
      entradaEm: null,               // Timestamp de quando entrou na partida
      cooldownSeg: 300,              // Cooldown em segundos (300=free/5min, 180=passe/3min)
      totalRespondidas: 0,           // Quantas j√° respondeu nesta partida
      totalDisponivel: 5,            // Quantas pode responder at√© agora
      skipsUsados: 0,                // Quantas vezes usou cr√©dito para adiantar
      tipoPasse: 'free',             // Tipo de passe
      perguntasRestantes: 5          // Quantas pode responder AGORA
    };
    let cooldownInterval = null;     // Intervalo do timer visual
    // ‚ö° MOMENTUM v3 STATE
    let momentumState = {
      fase: 1,
      momentumBonus: 0,
      totalRespondidas: 0,
      totalDisponivel: 5,
      timerSegundos: 120,
      timerAcertosConsecutivos: 0,
      tipoPasse: 'free',
      fase1Acertos: 0,
      perguntasRestantesFase: 5,
      timerInterval: null,
      liveFeedListener: null,
      alertaInterval: null,
      enqueteFixaInterval: null,
      enqueteFixaAtual: null,
      enqueteFixaVoto: null,
      // ‚úÖ TIMESTAMP protection: updateFreePlays won't read Firestore within 8s of server response
      lastServerUpdate: 0,
    };

    // üî¥ Force bars state (for lead change detection)
    let forceState = {
      prevTorcidaCasa: 50, prevTorcidaFora: 50,
      prevPontosCasa: 50, prevPontosFora: 50,
      liderTorcida: null, liderPontos: null,
    };


    // üèÖ CONQUISTAS DO JOGO
    const CONQUISTAS = {
      primeiroAcerto: { id: 'primeiroAcerto', nome: 'Primeiro Gol', emoji: '‚öΩ', descricao: 'Acertou a primeira pergunta', xpBonus: 5 },
      streak3: { id: 'streak3', nome: 'Hat-trick', emoji: 'üé©', descricao: '3 acertos seguidos', xpBonus: 15 },
      streak5: { id: 'streak5', nome: 'M√£o Quente', emoji: 'üî•', descricao: '5 acertos seguidos', xpBonus: 30 },
      streak10: { id: 'streak10', nome: 'Impar√°vel', emoji: 'üöÄ', descricao: '10 acertos seguidos', xpBonus: 50 },
      rapido: { id: 'rapido', nome: 'Velocista', emoji: '‚ö°', descricao: 'Respondeu em menos de 3 segundos', xpBonus: 10 },
      perfeito: { id: 'perfeito', nome: 'Perfeito', emoji: 'üíØ', descricao: '10 acertos sem errar', xpBonus: 100 }
    };
    let conquistasDesbloqueadas = [];

    // ===================================
    // üëï FUN√á√ÉO PARA GERAR CAMISETA SVG
    // ===================================
    function gerarCamisetaSVG(corPrimaria, corSecundaria, corTerciaria) {
      // CAMADA √öNICA ‚Äî todas as cores em um s√≥ gradiente composto
      // Prim√°ria: base (corpo todo)
      // Secund√°ria: faixa vertical centro, degrad√™ horizontal (forte no meio, some nas bordas)
      // Terci√°ria: mangas + base inferior, degrad√™ radial
      const bp = '/icons/camiseta-base.png';
      const t = corTerciaria || corPrimaria;
      const s = corSecundaria || corPrimaria;
      const mask = `mask-image:url(${bp});-webkit-mask-image:url(${bp});mask-size:contain;-webkit-mask-size:contain;mask-repeat:no-repeat;-webkit-mask-repeat:no-repeat;mask-position:center;-webkit-mask-position:center;`;
      return `
        <div style="position:relative;display:inline-block;width:100%;height:100%;">
          <img src="${bp}" style="width:100%;height:100%;display:block;object-fit:contain;" />
          <!-- Camada √öNICA: todas as cores combinadas em um gradiente composto -->
          <div style="position:absolute;top:0;left:0;right:0;bottom:0;
            background:
              radial-gradient(ellipse at 6% 26%, ${t}88 0%, transparent 18%),
              radial-gradient(ellipse at 94% 26%, ${t}88 0%, transparent 18%),
              linear-gradient(0deg, ${t}44 0%, transparent 8%),
              linear-gradient(180deg, ${t}33 0%, transparent 6%),
              linear-gradient(90deg, transparent 40%, ${s}33 46%, ${s}55 49%, ${s}55 51%, ${s}33 54%, transparent 60%),
              ${corPrimaria};
            mix-blend-mode:multiply;${mask}"></div>
          <!-- Shine -->
          <div style="position:absolute;top:0;left:0;right:0;bottom:0;
            background:linear-gradient(135deg, rgba(255,255,255,0.18), transparent 55%);
            ${mask}pointer-events:none;"></div>
        </div>`;
    }

    // ===================================
    // üîê VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
    // ===================================
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log("‚úÖ Persist√™ncia configurada"))
      .catch((error) => console.error("‚ùå Erro persist√™ncia:", error));

    auth.onAuthStateChanged(async (user) => {
      console.log("üîç Verificando autentica√ß√£o...", "perguntasSessao.size=", perguntasSessao.size);
      
      if (!user) {
        console.log("‚ùå Usu√°rio n√£o autenticado");
        setTimeout(() => window.location.href = "index.html", 500);
        return;
      }
      
      console.log("‚úÖ Usu√°rio autenticado:", user.uid);
      uid = user.uid;
      
      const params = new URLSearchParams(window.location.search);
      jogoId = params.get("jogoId");
      
      if (!jogoId) {
        alert("ID do jogo n√£o encontrado!");
        window.location.href = "painel.html";
        return;
      }

      console.log("üéÆ Carregando jogo:", jogoId);

      try {
        await loadGameData();      // Primeiro carrega dados do jogo (times)
        await loadUserData();      // Depois carrega dados do usu√°rio
        await updateStats();       // Atualiza estat√≠sticas
        initChat();                // Inicia chat
        await initEnquetes();      // üìä Carrega votos do usu√°rio
        initOnlineCounter();       // üë• Contador online ao vivo
        await loadRanking();       // Carrega ranking
        await carregarPatrocinadores(); // ‚úÖ NOVO: Carrega patrocinadores da partida
        initVicianteSystems();          // üî• Sistema viciante (sons, confetti, metas)
        startGameTimer();          // Inicia timer do jogo
        iniciarAtualizacaoAutomatica(); // ‚úÖ NOVO: Atualiza ranking/stats em tempo real
        
        document.getElementById("loadingScreen").style.display = "none";
        document.getElementById("mainContainer").classList.add("loaded");
        
        console.log("‚úÖ Jogo carregado com sucesso!");
        
      } catch (error) {
        console.error("‚ùå Erro ao carregar jogo:", error);
        alert("Erro ao carregar o jogo. Tente novamente.");
        window.location.href = "painel.html";
      }
    });

    // ===================================
    // üéÆ CARREGAR DADOS DO JOGO
    // ===================================
    async function loadGameData() {
      try {
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        if (!jogoDoc.exists) {
          throw new Error("Jogo n√£o encontrado!");
        }

        const jogo = jogoDoc.data();
        timeCasaId = jogo.timeCasaId;
        timeForaId = jogo.timeForaId;
        
        // ‚úÖ NOVO: Salvar status do jogo
        jogoStatus = jogo.status || 'agendado';
        console.log("üìä Status do jogo:", jogoStatus);
        
        // Carregar dados dos times
        const [timeCasaDoc, timeForaDoc] = await Promise.all([
          db.collection("times").doc(timeCasaId).get(),
          db.collection("times").doc(timeForaId).get()
        ]);

        timeCasaData = timeCasaDoc.exists ? { ...timeCasaDoc.data(), id: timeCasaDoc.id } : { nome: "Time Casa", primaria: "#28a745", secundaria: "#ffffff", terciaria: "#28a745", codigoPais: "BR" };
        timeForaData = timeForaDoc.exists ? { ...timeForaDoc.data(), id: timeForaDoc.id } : { nome: "Time Fora", primaria: "#dc3545", secundaria: "#ffffff", terciaria: "#dc3545", codigoPais: "BR" };

        // Obter bandeiras
        const bandeiraA = getBandeira(timeCasaData.codigoPais);
        const bandeiraB = getBandeira(timeForaData.codigoPais);

        // Atualizar cores CSS
        document.documentElement.style.setProperty('--cor-timeA', timeCasaData.primaria || '#28a745');
        document.documentElement.style.setProperty('--cor-timeB', timeForaData.primaria || '#dc3545');

        // Atualizar t√≠tulo com bandeiras
        document.getElementById("matchTitle").textContent = `${bandeiraA} ${timeCasaData.nome} vs ${timeForaData.nome} ${bandeiraB}`;
        
        // Atualizar nomes dos times com bandeiras
        document.getElementById("teamAName").textContent = `${bandeiraA} ${timeCasaData.nome}`;
        document.getElementById("teamBName").textContent = `${timeForaData.nome} ${bandeiraB}`;
        document.getElementById("forceTeamAName").textContent = `${bandeiraA} ${timeCasaData.nome}`;
        document.getElementById("forceTeamBName").textContent = `${timeForaData.nome} ${bandeiraB}`;

        // Gerar camisetas
        document.getElementById("jerseyA").innerHTML = gerarCamisetaSVG(
          timeCasaData.primaria || '#28a745',
          timeCasaData.secundaria || '#ffffff',
          timeCasaData.terciaria || '#28a745'
        );
        document.getElementById("jerseyB").innerHTML = gerarCamisetaSVG(
          timeForaData.primaria || '#dc3545',
          timeForaData.secundaria || '#ffffff',
          timeForaData.terciaria || '#dc3545'
        );

        // Aplicar estilos aos nomes
        document.getElementById("teamAName").style.background = `linear-gradient(135deg, ${timeCasaData.primaria}99, ${timeCasaData.primaria}44)`;
        document.getElementById("teamBName").style.background = `linear-gradient(135deg, ${timeForaData.primaria}99, ${timeForaData.primaria}44)`;

        // ‚úÖ NOVO: Salvar datas de in√≠cio e fim para controle de status
        if (jogo.dataInicio) {
          jogoDataInicio = jogo.dataInicio.toDate ? jogo.dataInicio.toDate() : new Date(jogo.dataInicio);
          document.getElementById("matchDate").textContent = jogoDataInicio.toLocaleDateString('pt-BR', {
            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
          });
        }
        
        if (jogo.dataFim) {
          jogoDataFim = jogo.dataFim.toDate ? jogo.dataFim.toDate() : new Date(jogo.dataFim);
        }
        
        console.log("üìÖ Hor√°rio in√≠cio:", jogoDataInicio);
        console.log("üìÖ Hor√°rio fim:", jogoDataFim);

        // ‚úÖ NOVO: Salvar cr√©ditos iniciais do admin
        jogoCreditosIniciais = jogo.creditosIniciais || 0;
        console.log("üí∞ Cr√©ditos iniciais do admin:", jogoCreditosIniciais);

        document.getElementById("matchLeague").textContent = jogo.liga || jogo.campeonato || "Partida";
        
        // ‚úÖ NOVO: Verificar se j√° foi premiado
        if (jogo.premiado && jogo.premiacaoDetalhes) {
          console.log("üèÜ Jogo j√° foi premiado!");
          premiacaoExecutada = true;
          // Mostrar resultado ap√≥s carregar tudo
          setTimeout(() => {
            mostrarResultadoPremiacao(jogo.premiacaoDetalhes);
          }, 2000);
        }
        
        // ‚úÖ NOVO: Calcular status baseado no hor√°rio e iniciar verifica√ß√£o cont√≠nua
        calcularStatusDoJogo();
        iniciarVerificacaoDeStatus();

      } catch (error) {
        console.error("‚ùå Erro ao carregar jogo:", error);
        throw error;
      }
    }
    
    // ‚úÖ NOVA FUN√á√ÉO: Calcular status baseado em dataInicio e dataFim
    function calcularStatusDoJogo() {
      const agora = new Date();
      const statusAnterior = jogoStatus;
      
      if (!jogoDataInicio || !jogoDataFim) {
        // Se n√£o tiver datas, considera ao vivo (fallback)
        jogoStatus = 'ao_vivo';
        console.log("‚ö†Ô∏è Datas n√£o definidas, considerando ao vivo");
      } else if (agora < jogoDataInicio) {
        jogoStatus = 'agendado';
        console.log("‚è≥ Jogo agendado - ainda n√£o come√ßou");
      } else if (agora >= jogoDataInicio && agora <= jogoDataFim) {
        jogoStatus = 'ao_vivo';
        console.log("üî¥ Jogo AO VIVO!");
      } else {
        jogoStatus = 'finalizado';
        console.log("üèÅ Jogo finalizado");
        
        // ‚úÖ BLOQUEAR CHAT QUANDO TERMINA
        bloquearChat();
        
        // ‚úÖ NOVO: Se acabou de finalizar, executar premia√ß√£o
        if (statusAnterior !== 'finalizado' && !premiacaoExecutada) {
          setTimeout(() => {
            executarPremiacao();
          }, 2000);
        }
      }
      
      atualizarBotaoBaseadoNoStatus();
      atualizarLiveBadge();
    }
    
    // ‚úÖ BLOQUEAR CHAT AP√ìS T√âRMINO
    function bloquearChat() {
      const teamInput = document.getElementById("teamChatInput");
      const generalInput = document.getElementById("generalChatInput");
      
      if (teamInput) {
        teamInput.disabled = true;
        teamInput.placeholder = "üèÅ Chat encerrado";
      }
      
      if (generalInput) {
        generalInput.disabled = true;
        generalInput.placeholder = "üèÅ Chat encerrado";
      }
      
      // Desabilitar bot√µes de envio
      const sendBtns = document.querySelectorAll(".chat-send-btn");
      sendBtns.forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";
      });
    }
    
    // ‚úÖ NOVA FUN√á√ÉO: Verificar status a cada 10 segundos
    function iniciarVerificacaoDeStatus() {
      // Limpar intervalo anterior se existir
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
      }
      
      // Verificar a cada 10 segundos
      statusCheckInterval = setInterval(() => {
        const statusAnterior = jogoStatus;
        calcularStatusDoJogo();
        
        // Se mudou de status, mostrar mensagem
        if (statusAnterior !== jogoStatus) {
          if (jogoStatus === 'ao_vivo') {
            showToast("üî¥ O jogo come√ßou! Responda as perguntas!");
          } else if (jogoStatus === 'finalizado') {
            showToast("üèÅ O jogo terminou! Calculando premia√ß√£o...");
            // ‚úÖ NOVO: Executar premia√ß√£o autom√°tica
            setTimeout(() => {
              executarPremiacao();
            }, 3000); // Esperar 3 segundos antes de premiar
          }
        }
      }, 10000); // 10 segundos
    }
    
    // ===================================
    // üîÑ ATUALIZA√á√ÉO AUTOM√ÅTICA EM TEMPO REAL
    // ===================================
    let rankingUpdateInterval = null;
    let statsUpdateInterval = null;
    
    function iniciarAtualizacaoAutomatica() {
      // Limpar intervalos anteriores se existirem
      if (rankingUpdateInterval) clearInterval(rankingUpdateInterval);
      if (statsUpdateInterval) clearInterval(statsUpdateInterval);
      
      console.log("üîÑ Iniciando atualiza√ß√£o autom√°tica...");
      
      // ‚úÖ ATUALIZAR RANKING A CADA 30 SEGUNDOS
      rankingUpdateInterval = setInterval(async () => {
        if (jogoStatus === 'ao_vivo') {
          console.log("üèÜ Atualizando ranking automaticamente...");
          await loadRanking();
        }
      }, 30000); // 30 segundos
      
      // ‚úÖ ATUALIZAR FOR√áA DA TORCIDA E PONTUA√á√ÉO A CADA 30 SEGUNDOS
      statsUpdateInterval = setInterval(async () => {
        if (jogoStatus === 'ao_vivo') {
          console.log("üìä Atualizando estat√≠sticas automaticamente...");
          await atualizarForcaTorcida();
        }
      }, 30000); // 30 segundos

      // ‚úÖ ATUALIZAR COOLDOWN/PERGUNTAS A CADA 15 SEGUNDOS
      setInterval(async () => {
        if (jogoStatus === 'ao_vivo' || jogoStatus === 'pre_jogo') {
          await updateFreePlays();
        }
      }, 15000);

      // ‚úÖ LISTENER DE VISIBILIDADE ‚Äî quando app volta do background
      document.addEventListener('visibilitychange', async () => {
        if (!document.hidden && uid && jogoId) {
          console.log("üëÅÔ∏è P√°gina voltou ao foco ‚Äî atualizando tudo...");
          
          // Recalcular status do jogo (pode ter mudado)
          calcularStatusDoJogo();
          
          // Atualizar perguntas dispon√≠veis (cooldown pode ter avan√ßado)
          await updateFreePlays();
          
          // Atualizar ranking e stats
          if (jogoStatus === 'ao_vivo') {
            await loadRanking();
            await atualizarForcaTorcida();
          }
          
          // Se jogo terminou enquanto estava fora
          if (jogoStatus === 'finalizado') {
            executarPremiacao();
          }
        }
      });
    }
    
    // ‚úÖ FUN√á√ÉO PARA ATUALIZAR FOR√áA DA TORCIDA EM TEMPO REAL
    async function atualizarForcaTorcida() {
      try {
        // Buscar dados atualizados do jogo
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        if (!jogoDoc.exists) return;
        
        const jogo = jogoDoc.data();
        
        // Atualizar contadores de torcedores
        const torcidaCasa = jogo.torcidaCasaCount || 0;
        const torcidaFora = jogo.torcidaForaCount || 0;
        const totalTorcedores = torcidaCasa + torcidaFora;
        
        // Calcular percentuais da torcida
        let percentTorcidaCasa = 50, percentTorcidaFora = 50;
        if (totalTorcedores > 0) {
          percentTorcidaCasa = Math.round((torcidaCasa / totalTorcedores) * 100);
          percentTorcidaFora = 100 - percentTorcidaCasa;
        }
        
        // ‚úÖ Atualizar contadores de torcedores nos cards
        const teamATorcidaEl = document.getElementById("teamATorcida");
        const teamBTorcidaEl = document.getElementById("teamBTorcida");
        
        if (teamATorcidaEl) animateValue(teamATorcidaEl, torcidaCasa);
        if (teamBTorcidaEl) animateValue(teamBTorcidaEl, torcidaFora);
        
        // ‚úÖ Atualizar barras de for√ßa da torcida
        const forceTorcidaAEl = document.getElementById("forceTorcidaA");
        const forceTorcidaBEl = document.getElementById("forceTorcidaB");
        const forceTorcidaAPercEl = document.getElementById("forceTorcidaAPerc");
        const forceTorcidaBPercEl = document.getElementById("forceTorcidaBPerc");
        
        if (forceTorcidaAEl) forceTorcidaAEl.style.width = `${percentTorcidaCasa}%`;
        if (forceTorcidaBEl) forceTorcidaBEl.style.width = `${percentTorcidaFora}%`;
        if (forceTorcidaAPercEl) forceTorcidaAPercEl.textContent = `${percentTorcidaCasa}%`;
        if (forceTorcidaBPercEl) forceTorcidaBPercEl.textContent = `${percentTorcidaFora}%`;
        
        // ‚úÖ BUSCAR PONTUA√á√ÉO ATUALIZADA DOS TIMES (da subcole√ß√£o participantes)
        const participantesSnap = await db.collection("jogos").doc(jogoId)
          .collection("participantes").get();
        
        let pontosCasa = 0, pontosFora = 0;
        
        participantesSnap.forEach(doc => {
          const p = doc.data();
          if (p.timeId === timeCasaId) {
            pontosCasa += p.pontos || 0;
          } else if (p.timeId === timeForaId) {
            pontosFora += p.pontos || 0;
          }
        });
        
        // ‚úÖ Atualizar pontua√ß√£o nos cards
        const teamAPontosEl = document.getElementById("teamAPontos");
        const teamBPontosEl = document.getElementById("teamBPontos");
        
        if (teamAPontosEl) animateValue(teamAPontosEl, pontosCasa);
        if (teamBPontosEl) animateValue(teamBPontosEl, pontosFora);
        
        // ‚úÖ Atualizar barras de pontua√ß√£o
        const totalPontos = pontosCasa + pontosFora;
        let percentPontosCasa = 50, percentPontosFora = 50;
        
        if (totalPontos > 0) {
          percentPontosCasa = Math.round((pontosCasa / totalPontos) * 100);
          percentPontosFora = 100 - percentPontosCasa;
        }
        
        const forcePontosAEl = document.getElementById("forcePontosA");
        const forcePontosBEl = document.getElementById("forcePontosB");
        const forcePontosAPercEl = document.getElementById("forcePontosAPerc");
        const forcePontosBPercEl = document.getElementById("forcePontosBPerc");
        
        if (forcePontosAEl) forcePontosAEl.style.width = `${percentPontosCasa}%`;
        if (forcePontosBEl) forcePontosBEl.style.width = `${percentPontosFora}%`;
        if (forcePontosAPercEl) forcePontosAPercEl.textContent = `${percentPontosCasa}%`;
        if (forcePontosBPercEl) forcePontosBPercEl.textContent = `${percentPontosFora}%`;

        // ‚ö° FORCE BARS ALIVE ‚Äî detect changes and animate
        // Bounce animation on change
        if (Math.abs(percentPontosCasa - forceState.prevPontosCasa) >= 2) {
          if (forcePontosAEl) forcePontosAEl.classList.add('just-changed');
          if (forcePontosBEl) forcePontosBEl.classList.add('just-changed');
          setTimeout(() => { forcePontosAEl?.classList.remove('just-changed'); forcePontosBEl?.classList.remove('just-changed'); }, 600);
        }
        if (Math.abs(percentTorcidaCasa - forceState.prevTorcidaCasa) >= 2) {
          if (forceTorcidaAEl) forceTorcidaAEl.classList.add('just-changed');
          if (forceTorcidaBEl) forceTorcidaBEl.classList.add('just-changed');
          setTimeout(() => { forceTorcidaAEl?.classList.remove('just-changed'); forceTorcidaBEl?.classList.remove('just-changed'); }, 600);
        }

        // Tight race glow (< 5% difference)
        const torcidaSection = document.querySelector('.force-bar-section:first-child');
        const pontosSection = document.querySelector('.force-bar-section:last-child');
        if (torcidaSection) torcidaSection.classList.toggle('tight-race', Math.abs(percentTorcidaCasa - 50) < 5);
        if (pontosSection) pontosSection.classList.toggle('tight-race', Math.abs(percentPontosCasa - 50) < 5);

        // üî¥ LEAD CHANGE ALERT
        const novoLiderPontos = percentPontosCasa > 55 ? 'casa' : percentPontosFora > 55 ? 'fora' : null;
        if (novoLiderPontos && forceState.liderPontos && novoLiderPontos !== forceState.liderPontos) {
          const nomeVencedor = novoLiderPontos === 'casa' ? (timeCasaData?.nome || 'Time A') : (timeForaData?.nome || 'Time B');
          mostrarForceLeadAlert(`üîÑ VIRADA! ${nomeVencedor} lidera na pontua√ß√£o!`, novoLiderPontos === 'casa' ? 'team-a' : 'team-b');
          // Provoca√ß√£o ao time perdedor via alerta competitivo
          if ((novoLiderPontos === 'casa' && timeTorcida === timeForaId) || (novoLiderPontos === 'fora' && timeTorcida === timeCasaId)) {
            setTimeout(() => mostrarAlertaComp(`üò§ Seu time perdeu a lideran√ßa! Responda para virar!`), 3000);
          } else {
            setTimeout(() => mostrarAlertaComp(`üî• Seu time virou! Continue respondendo pra manter!`), 3000);
          }
          adicionarLiveFeed('üîÑ', `VIRADA na pontua√ß√£o! ${nomeVencedor} lidera!`);
        }
        forceState.liderPontos = novoLiderPontos;

        // Time perdedor: provoca√ß√£o peri√≥dica no alerta
        const meuTimePerdendo = (timeTorcida === timeCasaId && percentPontosFora > percentPontosCasa + 3)
          || (timeTorcida === timeForaId && percentPontosCasa > percentPontosFora + 3);
        if (meuTimePerdendo && Math.random() < 0.3) {
          const diff = Math.abs(pontosCasa - pontosFora);
          setTimeout(() => mostrarAlertaComp(`üò§ Seu time est√° ${diff} pts atr√°s! Responda pra empurrar a barra!`), 5000);
        }

        forceState.prevTorcidaCasa = percentTorcidaCasa;
        forceState.prevTorcidaFora = percentTorcidaFora;
        forceState.prevPontosCasa = percentPontosCasa;
        forceState.prevPontosFora = percentPontosFora;
        
      } catch (error) {
        console.error("‚ùå Erro ao atualizar for√ßa da torcida:", error);
      }
    }
    
    // ‚úÖ FUN√á√ÉO ATUALIZADA: Atualizar bot√£o baseado no status calculado
    function atualizarBotaoBaseadoNoStatus() {
      const btnAnswer = document.getElementById("btnAnswer");
      if (!btnAnswer) return;
      
      if (jogoStatus === 'agendado') {
        btnAnswer.disabled = true;
        // Mostrar quanto tempo falta
        const agora = new Date();
        const diffMs = jogoDataInicio - agora;
        const diffMin = Math.ceil(diffMs / 60000);
        
        if (diffMin > 60) {
          const diffHoras = Math.floor(diffMin / 60);
          btnAnswer.textContent = `‚è≥ Come√ßa em ${diffHoras}h ${diffMin % 60}min`;
        } else if (diffMin > 0) {
          btnAnswer.textContent = `‚è≥ Come√ßa em ${diffMin} minutos`;
        } else {
          btnAnswer.textContent = "‚è≥ Come√ßando em breve...";
        }
        btnAnswer.style.background = "rgba(241, 196, 15, 0.5)";
        
      } else if (jogoStatus === 'finalizado') {
        btnAnswer.disabled = true;
        btnAnswer.textContent = "üèÅ Jogo finalizado";
        btnAnswer.style.background = "rgba(149, 165, 166, 0.5)";
        
      } else {
        // ao_vivo - permitir responder
        btnAnswer.disabled = false;
        btnAnswer.textContent = "üéØ Responder Pergunta";
        btnAnswer.style.background = "linear-gradient(135deg, var(--accent), #ff8c42)";
      }
    }

    // ===================================
    // üë§ CARREGAR DADOS DO USU√ÅRIO
    // ===================================
    async function loadUserData() {
      try {
        const userDoc = await db.collection("usuarios").doc(uid).get();
        if (!userDoc.exists) {
          throw new Error("Usu√°rio n√£o encontrado!");
        }

        const user = userDoc.data();
        
        // ‚úÖ CACHEAR DADOS DO USU√ÅRIO PARA USO EM OUTRAS FUN√á√ïES
        cachedUserData = user;
        
        const displayName = user.usuarioUnico || user.usuario || user.nome || "Usu√°rio";
        document.getElementById("userName").textContent = displayName;
        
        // Avatar - mostrar foto se existir
        const avatarEl = document.getElementById("userAvatar");
        if (user.avatarUrl) {
          avatarEl.innerHTML = `<img src="${user.avatarUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        } else {
          avatarEl.textContent = displayName.charAt(0).toUpperCase();
        }
        
        // Mostrar tipo do passe em vez de Level
        const passeUser = user.passe || {};
        let passeLabel = '‚öΩ Free';
        let passeCor = '#a9b5c6';
        if ((passeUser.ativo || passeUser.temPasse) && passeUser.tipo && passeUser.tipo !== 'free') {
          // Verificar se n√£o expirou
          let expirado = false;
          if (passeUser.dataExpiracao) {
            const dataExp = passeUser.dataExpiracao.toDate ? passeUser.dataExpiracao.toDate() : new Date(passeUser.dataExpiracao);
            expirado = new Date() > dataExp;
          }
          if (!expirado) {
            const passeLabels = { semanal: 'üåü Semanal', mensal: 'üíé Mensal', anual: 'üëë Anual' };
            passeLabel = passeLabels[passeUser.tipo] || 'üé´ ' + passeUser.tipo;
            passeCor = '#10b981';
          } else {
            passeLabel = '‚ö†Ô∏è Expirado';
            passeCor = '#ef4444';
          }
        }
        document.getElementById("userLevel").innerHTML = `<span style="color:${passeCor}">${passeLabel}</span>`;

        // Verificar se tem time escolhido para este jogo
        timeTorcida = user.torcidas?.[jogoId];
        if (!timeTorcida) {
          alert("Voc√™ precisa escolher um time primeiro!");
          window.location.href = "painel.html";
          return;
        }

        // Destacar card do time que est√° torcendo
        if (timeTorcida === timeCasaId) {
          document.getElementById("teamACard").classList.add("my-team");
        } else if (timeTorcida === timeForaId) {
          document.getElementById("teamBCard").classList.add("my-team");
        }

        // ‚úÖ GLOBAL: Carregar perguntas j√° respondidas DESTE TIME (n√£o do jogo)
        // Assim a pessoa nunca mais v√™ a mesma pergunta, mesmo em jogos diferentes
        const jaRespondidas = user[`perguntasRespondidas_${timeTorcida}`] || [];
        jaRespondidas.forEach(id => perguntasSessao.add(id));
        console.log("üìù Perguntas j√° respondidas deste time (GLOBAL):", perguntasSessao.size);
        console.log("üîç DEBUG loadUserData - Set ap√≥s init:", [...perguntasSessao]);

        // ‚úÖ NOVO: Carregar acertos/erros e conquistas do jogo atual
        // Para n√£o mostrar "Primeiro Gol" toda vez que atualiza
        const participanteDoc = await db.collection("jogos").doc(jogoId)
          .collection("participantes").doc(uid).get();
        
        // ‚úÖ V2: Garantir que participante tem entradaEm (cooldown)
        // Usu√°rios que entraram antes do v2 n√£o t√™m esse campo
        const precisaInicializar = !participanteDoc.exists || !participanteDoc.data()?.entradaEm;
        
        if (precisaInicializar) {
          console.log("‚ö° Inicializando participante via entrarPartidaV2...");
          try {
            const entrarFn = functions.httpsCallable('entrarPartidaV2');
            const entradaResult = await entrarFn({ jogoId: jogoId, timeId: timeTorcida });
            const er = entradaResult.data;
            console.log(`‚úÖ entrarPartidaV2: ${er.perguntasDisponiveis} dispon√≠veis, cooldown ${er.cooldownSegundos}s`);
            
            cooldownState = {
              entradaEm: Date.now(),
              cooldownSeg: er.cooldownSegundos || 300,
              totalRespondidas: er.totalRespondidas || 0,
              totalDisponivel: er.totalDisponivel || 5,
              skipsUsados: er.skipsUsados || 0,
              tipoPasse: er.tipoPasse || 'free',
              perguntasRestantes: er.perguntasDisponiveis || 5
            };

            // ‚úÖ Override local: garantir cooldown correto pelo passe do usu√°rio
            const passeLocal = user.passe || {};
            let temPasseLocal = (passeLocal.ativo || passeLocal.temPasse) && passeLocal.tipo && passeLocal.tipo !== 'free';
            if (temPasseLocal && passeLocal.dataExpiracao) {
              const dExp = passeLocal.dataExpiracao.toDate ? passeLocal.dataExpiracao.toDate() : new Date(passeLocal.dataExpiracao);
              if (new Date() > dExp) temPasseLocal = false;
            }
            cooldownState.cooldownSeg = temPasseLocal ? 180 : 300;
            cooldownState.tipoPasse = temPasseLocal ? passeLocal.tipo : 'free';
            console.log(`üé´ Override local: passe=${cooldownState.tipoPasse}, cooldown=${cooldownState.cooldownSeg}s`);

            // Carregar acertos/erros do participante recarregado
            const pDocReload = await db.collection("jogos").doc(jogoId)
              .collection("participantes").doc(uid).get();
            if (pDocReload.exists) {
              totalAcertos = pDocReload.data().acertos || 0;
              totalErros = pDocReload.data().erros || 0;
            }
          } catch (entradaErr) {
            console.error("‚ùå Erro ao inicializar participante:", entradaErr);
            // Se for limite di√°rio, mostrar overlay
            if (entradaErr?.code === 'resource-exhausted') {
              mostrarOverlayLimiteAtingido();
              return;
            }
          }
        } else if (participanteDoc.exists) {
          const participante = participanteDoc.data();
          totalAcertos = participante.acertos || 0;
          totalErros = participante.erros || 0;
          console.log(`üìä Acertos/Erros carregados: ${totalAcertos}/${totalErros}`);

          // ‚úÖ COOLDOWN: Inicializar estado a partir do participante
          if (participante.entradaEm) {
            const passe = user.passe || { tipo: 'free', ativo: false };
            // Verificar passe com checagem de expira√ß√£o
            let temPasse = (passe.ativo || passe.temPasse) && passe.tipo && passe.tipo !== 'free';
            console.log(`üé´ DEBUG passe:`, JSON.stringify(passe));
            if (temPasse && passe.dataExpiracao) {
              const dataExp = passe.dataExpiracao.toDate ? passe.dataExpiracao.toDate() : new Date(passe.dataExpiracao);
              if (new Date() > dataExp) temPasse = false; // Expirou
            }
            const cooldown = temPasse ? 180 : 300; // 3min passe, 5min free
            console.log(`üé´ Passe: ${temPasse ? passe.tipo : 'free'}, Cooldown: ${cooldown}s`);
            const entradaEm = participante.entradaEm.toDate().getTime();
            const elapsed = (Date.now() - entradaEm) / 1000;
            const ciclosPassados = Math.floor(elapsed / cooldown);
            const skipsUsados = participante.skipsUsados || 0;
            const totalRespondidas = participante.totalRespondidas || 0;
            const perguntasPorCiclo = 2; // Sempre +2 por ciclo
            const totalDisponivel = 5 + (ciclosPassados * perguntasPorCiclo) + (skipsUsados * 2);

            cooldownState = {
              entradaEm: entradaEm,
              cooldownSeg: cooldown,
              totalRespondidas: totalRespondidas,
              totalDisponivel: totalDisponivel,
              skipsUsados: skipsUsados,
              tipoPasse: temPasse ? passe.tipo : 'free',
              perguntasRestantes: Math.max(0, totalDisponivel - totalRespondidas)
            };
            console.log(`‚è≥ Cooldown: ${cooldownState.perguntasRestantes} dispon√≠veis, cooldown ${cooldown}s, ${totalRespondidas} respondidas`);
          }
        }
        
        // Carregar conquistas j√° desbloqueadas neste jogo
        conquistasDesbloqueadas = user[`conquistas_${jogoId}`] || [];
        console.log(`üèÖ Conquistas j√° desbloqueadas: ${conquistasDesbloqueadas.length}`);

        await updateFreePlays();

      } catch (error) {
        console.error("‚ùå Erro ao carregar usu√°rio:", error);
        throw error;
      }
    }

    // ===================================
    // üé´ ATUALIZAR STATUS PASSE/LIMITES (V2)
    // ===================================
    async function updateFreePlays() {
      try {
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const user = userDoc.data() || {};
        document.getElementById("paidCredits").textContent = user.creditos || 0;

        const participanteRef = db.collection("jogos").doc(jogoId).collection("participantes").doc(uid);
        const participanteDoc = await participanteRef.get();

        if (participanteDoc.exists && participanteDoc.data().entradaEm) {
          const p = participanteDoc.data();

          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // ‚úÖ PROTE√á√ÉO POR TIMESTAMP (8 segundos)
          // Se o server respondeu recentemente, N√ÉO ler Firestore
          // porque o Firestore pode ter dado stale/desatualizado
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          const msSinceServer = Date.now() - momentumState.lastServerUpdate;
          const serverRecente = msSinceServer < 8000;

          if (!serverRecente) {
            if (p.modeloV3 || p.faseAtual) {
              momentumState.fase = p.faseAtual || 1;
              momentumState.momentumBonus = p.momentumBonus || 0;
              momentumState.totalRespondidas = p.totalRespondidas || 0;
              momentumState.timerAcertosConsecutivos = p.timerAcertosConsecutivos || 0;
              momentumState.tipoPasse = cooldownState.tipoPasse || 'free';

              if (momentumState.fase === 1) {
                momentumState.perguntasRestantesFase = Math.max(0, 5 - momentumState.totalRespondidas);
              } else if (momentumState.fase === 2) {
                // ‚úÖ FIX: null-safe (0 √© valor v√°lido, || tratava como falsy)
                const r2 = p.perguntasRestantesFase2;
                momentumState.perguntasRestantesFase = (r2 != null) ? r2 : 0;
              } else if (momentumState.fase === 3) {
                const f3 = p.fase3InicioEm?.toDate?.()?.getTime() || 0;
                const timer = calcularTimerMomentum();
                momentumState.perguntasRestantesFase = ((Date.now()-f3)/1000 >= timer) ? 1 : 0;
                momentumState.timerSegundos = timer;
              }
              cooldownState.totalRespondidas = momentumState.totalRespondidas;
              cooldownState.perguntasRestantes = momentumState.perguntasRestantesFase;
            } else {
              // V2 fallback
              const agora = Date.now();
              const entradaEm = p.entradaEm.toDate().getTime();
              const elapsed = (agora - entradaEm) / 1000;
              const cd = cooldownState.cooldownSeg;
              const ciclos = Math.floor(elapsed / cd);
              const skips = p.skipsUsados || 0;
              const resp = p.totalRespondidas || 0;
              const disp = 5 + (ciclos*2) + (skips*2);
              cooldownState.entradaEm = entradaEm;
              cooldownState.totalRespondidas = resp;
              cooldownState.totalDisponivel = disp;
              cooldownState.skipsUsados = skips;
              cooldownState.perguntasRestantes = Math.max(0, disp - resp);
              momentumState.perguntasRestantesFase = cooldownState.perguntasRestantes;
            }
          }

          // Atualizar UI
          atualizarMomentumBotao();

        } else {
          document.getElementById("perguntasDisponiveis").textContent = '5';
        }
      } catch(error) { console.error("‚ùå Erro updateFreePlays:", error); }
    }

    // ‚úÖ NOVO: Fun√ß√£o dedicada p/ atualizar bot√£o baseado no momentumState
    function atualizarMomentumBotao() {
      const rest = momentumState.perguntasRestantesFase;
      const el = document.getElementById("perguntasDisponiveis");
      
      console.log(`üîÑ atualizarMomentumBotao: fase=${momentumState.fase} rest=${rest} bonus=${momentumState.momentumBonus} currentQ=${!!currentQuestion}`);
      
      // Na Fase 2, mostrar o bonus acumulado (que SOBE) em vez do saldo est√°tico
      if (momentumState.fase === 2) {
        if (el) { el.textContent = rest; el.style.color = rest > 0 ? '#a78bfa' : '#e74c3c'; }
      } else {
        if (el) { el.textContent = rest; el.style.color = rest > 0 ? '#4caf50' : '#e74c3c'; }
      }
      atualizarFaseIndicador();

      const btn = document.getElementById("btnAnswer");
      const fab = document.getElementById("fabBtn");
      if (!btn) return;

      if (rest <= 0 && !currentQuestion) {
        btn.disabled = true;
        if (momentumState.fase === 3) {
          btn.textContent = '‚è≥ +1 pergunta em breve';
        } else {
          btn.textContent = '‚è≥ Aguarde...';
        }
        btn.style.background = "rgba(149,165,166,0.5)";
        if (fab) { fab.disabled = true; fab.innerHTML = '<span class="fab-icon">‚è≥</span><span class="fab-text">Timer...</span>'; }
        tentarMostrarEnquete();
        mostrarMiniBanner();
      } else if (!currentQuestion) {
        btn.disabled = false;
        if (momentumState.fase === 2) {
          // Fase 2: mostrar CADEIA (sobe!) no bot√£o ‚Äî √© mais excitante
          const cadeia = momentumState.momentumBonus || rest;
          btn.textContent = `‚ö° Cadeia de ${cadeia}! Responder`;
          btn.style.background = "linear-gradient(135deg,#a78bfa,#8b5cf6)";
          if (fab) { fab.disabled = false; fab.innerHTML = `<span class="fab-icon">‚ö°</span><span class="fab-text">Cadeia ${cadeia}!</span>`; }
        } else {
          const label = 'üéØ';
          btn.textContent = `${label} Responder Pergunta (${rest})`;
          btn.style.background = "linear-gradient(135deg,var(--accent),#ff8c42)";
          if (fab) { fab.disabled = false; fab.innerHTML = `<span class="fab-icon">${label}</span><span class="fab-text">${rest} dispon√≠veis</span>`; }
        }
        esconderMiniBanner();
      }
    }

    // Timer visual do cooldown
    function atualizarCooldownTimer(entradaEm, cooldown, perguntasRestantes, creditos) {
      const timerEl = document.getElementById("cooldownTimer");
      const btnAdiantar = document.getElementById("btnAdiantar");
      
      if (perguntasRestantes > 0) {
        // Tem perguntas ‚Äî esconder timer
        timerEl.classList.remove('visible');
        timerEl.style.display = 'none';
        if (cooldownInterval) { clearInterval(cooldownInterval); cooldownInterval = null; }
        return;
      }

      // Sem perguntas ‚Äî mostrar timer
      timerEl.classList.add('visible');
      timerEl.style.display = '';
      
      // Atualizar quantidade din√¢mica (+2 ou +3)
      const qtdEl = document.getElementById("cooldownQtd");
      
      
      // Bot√£o de adiantar
      if (creditos >= 1) {
        btnAdiantar.style.display = 'inline-block';
        btnAdiantar.disabled = false;
        btnAdiantar.textContent = 'üíé Skip (1 cr)';
      } else {
        btnAdiantar.style.display = 'none';
      }

      // Atualizar contagem
      if (cooldownInterval) clearInterval(cooldownInterval);
      cooldownInterval = setInterval(() => {
        const agora = Date.now();
        const elapsed = (agora - entradaEm) / 1000;
        const ciclosPassados = Math.floor(elapsed / cooldown);
        const proximoCicloEm = entradaEm + ((ciclosPassados + 1) * cooldown * 1000);
        const segFaltam = Math.max(0, Math.ceil((proximoCicloEm - agora) / 1000));

        if (segFaltam <= 0) {
          // Ciclo completou! Parar timer e aguardar 1.5s para garantir que o ciclo virou
          clearInterval(cooldownInterval);
          cooldownInterval = null;
          
          setTimeout(async () => {
            const agoraMs = Date.now();
            const elapsedSeg = (agoraMs - cooldownState.entradaEm) / 1000;
            const novoCiclos = Math.floor(elapsedSeg / cooldownState.cooldownSeg);
            const novoDisponivel = 5 + (novoCiclos * 2) + (cooldownState.skipsUsados * 2);
            let novoRestantes = Math.max(0, novoDisponivel - cooldownState.totalRespondidas);
            
            // Garantia: se o timer chegou a 0, pelo menos 2 perguntas devem liberar
            if (novoRestantes < 2) {
              console.log(`‚ö†Ô∏è Timer zerou mas novoRestantes=${novoRestantes}, for√ßando 2`);
              novoRestantes = 2;
              cooldownState.totalDisponivel = cooldownState.totalRespondidas + 2;
            } else {
              cooldownState.totalDisponivel = novoDisponivel;
            }
            cooldownState.perguntasRestantes = novoRestantes;
            
            console.log(`‚úÖ Timer expirou! Ciclos: ${novoCiclos}, Dispon√≠vel: ${cooldownState.totalDisponivel}, Restantes: ${novoRestantes}`);
            
            // Atualizar UI diretamente
            const el = document.getElementById("perguntasDisponiveis");
            if (el) { el.textContent = novoRestantes; el.style.color = novoRestantes > 0 ? '#4caf50' : '#e74c3c'; }
            
            const btnAnswer = document.getElementById("btnAnswer");
            const fabBtn = document.getElementById("fabBtn");
            if (novoRestantes > 0 && !currentQuestion) {
              btnAnswer.disabled = false;
              btnAnswer.textContent = `üéØ Responder Pergunta (${novoRestantes})`;
              btnAnswer.style.background = "linear-gradient(135deg, var(--accent), #ff8c42)";
              timerEl.classList.remove('visible');
              timerEl.style.display = 'none';
              if (fabBtn) { fabBtn.disabled = false; fabBtn.innerHTML = `<span class="fab-icon">üéØ</span><span class="fab-text">${novoRestantes} dispon√≠veis</span>`; }
              showToast(`üéØ +2 perguntas liberadas! (${novoRestantes} dispon√≠veis)`);
            } else {
              // Fallback: atualizar tudo via Firestore
              await updateFreePlays();
            }
          }, 1500);
          return;
        }

        const min = Math.floor(segFaltam / 60);
        const seg = segFaltam % 60;
        const tempoStr = `${min}:${String(seg).padStart(2, '0')}`;
        document.getElementById("cooldownContagem").textContent = tempoStr;
        
        // Atualizar bot√£o principal tamb√©m
        const btnAnswer = document.getElementById("btnAnswer");
        if (btnAnswer && !currentQuestion) {
          btnAnswer.textContent = `‚è≥ +2 perguntas em ${tempoStr}`;
        }
        // Atualizar FAB (mobile)
        const fabBtn = document.getElementById("fabBtn");
        if (fabBtn && !currentQuestion) {
          fabBtn.disabled = true;
          fabBtn.innerHTML = `<span class="fab-icon">‚è≥</span><span class="fab-text">${tempoStr}</span>`;
        }
      }, 1000);
    }

    // 1 cr√©dito = 1 pergunta (Momentum v3)
    async function adiantarPerguntas() {
      try {
        const ba = document.getElementById("btnAdiantar");
        if(ba){ba.disabled=true;ba.textContent='‚è≥...';}
        let r;
        try { r=(await functions.httpsCallable('adiantarPerguntasMomentumV3')({jogoId})).data; }
        catch(e){ if(e?.code==='resource-exhausted')throw e; r=(await functions.httpsCallable('adiantarPerguntasV2')({jogoId})).data; }
        showToast(`üéØ +1 pergunta! (${r.creditosRestantes} cr restantes)`);
        momentumState.perguntasRestantesFase = (momentumState.perguntasRestantesFase||0)+1;
        momentumState.lastServerUpdate = Date.now();
        cooldownState.skipsUsados = r.skipsUsados||(cooldownState.skipsUsados+1);
        if(momentumState.timerInterval){clearInterval(momentumState.timerInterval);momentumState.timerInterval=null;}
        atualizarMomentumBotao();
      } catch(error) {
        console.error("‚ùå Erro adiantar:", error);
        showToast("‚ùå "+(error?.message||"Erro"));
        const ba=document.getElementById("btnAdiantar");
        if(ba){ba.disabled=false;ba.textContent='üíé Skip (1 cr)';}
      }
    }

    // ===================================
    // üìä ATUALIZAR ESTAT√çSTICAS
    // ===================================
    async function updateStats() {
      try {
        const usuarios = await db.collection("usuarios").get();
        
        let torcidaA = 0, torcidaB = 0;
        let pontosA = 0, pontosB = 0;

        usuarios.forEach(doc => {
          const user = doc.data();
          const timeUser = user.torcidas?.[jogoId];
          const pontos = user.pontuacoes?.[jogoId] || 0;

          // Comparar com IDs reais dos times
          if (timeUser === timeCasaId) {
            torcidaA++;
            pontosA += pontos;
          } else if (timeUser === timeForaId) {
            torcidaB++;
            pontosB += pontos;
          }
        });

        // Atualizar cards dos times
        document.getElementById("teamATorcida").textContent = torcidaA;
        document.getElementById("teamBTorcida").textContent = torcidaB;
        document.getElementById("teamAPontos").textContent = pontosA.toLocaleString('pt-BR');
        document.getElementById("teamBPontos").textContent = pontosB.toLocaleString('pt-BR');

        // Calcular percentuais
        const totalTorcida = torcidaA + torcidaB || 1;
        const percTorcidaA = Math.round((torcidaA / totalTorcida) * 100);
        const percTorcidaB = 100 - percTorcidaA;

        const totalPontos = pontosA + pontosB || 1;
        const percPontosA = Math.round((pontosA / totalPontos) * 100);
        const percPontosB = 100 - percPontosA;

        // Atualizar barras de torcida
        document.getElementById("forceTorcidaA").style.width = percTorcidaA + "%";
        document.getElementById("forceTorcidaB").style.width = percTorcidaB + "%";
        document.getElementById("forceTorcidaAPerc").textContent = percTorcidaA + "%";
        document.getElementById("forceTorcidaBPerc").textContent = percTorcidaB + "%";

        // Atualizar barras de pontua√ß√£o
        document.getElementById("forcePontosA").style.width = percPontosA + "%";
        document.getElementById("forcePontosB").style.width = percPontosB + "%";
        document.getElementById("forcePontosAPerc").textContent = percPontosA + "%";
        document.getElementById("forcePontosBPerc").textContent = percPontosB + "%";
        document.getElementById("pointsTeamAValue").textContent = pontosA + " pts";
        document.getElementById("pointsTeamBValue").textContent = pontosB + " pts";

      } catch (error) {
        console.error("‚ùå Erro ao atualizar estat√≠sticas:", error);
      }
    }

    // ===================================
    // ‚è±Ô∏è TIMER DO JOGO
    // ===================================
    let gameTimerInterval;
    function startGameTimer() {
      // ‚úÖ CORRIGIDO: Mostrar tempo RESTANTE at√© o fim da partida
      
      function atualizarTimer() {
        const agora = new Date();
        const timerEl = document.getElementById("timer");
        const timerContainer = timerEl?.parentElement;
        
        if (!timerEl) return;
        
        // Se n√£o tem data de fim, n√£o mostrar nada
        if (!jogoDataFim) {
          timerEl.textContent = "--:--";
          return;
        }
        
        // Se o jogo ainda n√£o come√ßou - mostrar quanto falta para come√ßar
        if (jogoDataInicio && agora < jogoDataInicio) {
          const diff = jogoDataInicio - agora;
          const horas = Math.floor(diff / 3600000);
          const mins = Math.floor((diff % 3600000) / 60000);
          const secs = Math.floor((diff % 60000) / 1000);
          
          if (timerContainer) {
            timerContainer.innerHTML = `‚è≥ Come√ßa em: <span class="timer" id="timer" style="color: #f39c12;"></span>`;
            document.getElementById("timer").textContent = horas > 0 
              ? `${horas}h ${String(mins).padStart(2, '0')}m`
              : `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
          }
          return;
        }
        
        // Se o jogo j√° terminou
        if (agora > jogoDataFim) {
          if (timerContainer) {
            timerContainer.innerHTML = `<span class="timer" id="timer" style="color: #95a5a6;">üèÅ Encerrado</span>`;
          }
          clearInterval(gameTimerInterval);
          return;
        }
        
        // Jogo em andamento - mostrar tempo restante
        const diff = jogoDataFim - agora;
        const horas = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        
        if (timerContainer) {
          timerContainer.innerHTML = `‚è≥ Restante: <span class="timer" id="timer"></span>`;
          const newTimerEl = document.getElementById("timer");
          
          if (horas > 0) {
            newTimerEl.textContent = `${horas}h ${String(mins).padStart(2, '0')}m`;
          } else {
            newTimerEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
          }
          
          // Mudar cor conforme tempo restante
          if (mins < 5 && horas === 0) {
            newTimerEl.style.color = "#e74c3c"; // Vermelho - acabando
          } else if (mins < 15 && horas === 0) {
            newTimerEl.style.color = "#f39c12"; // Amarelo - aten√ß√£o
          } else {
            newTimerEl.style.color = "#2ecc71"; // Verde - tranquilo
          }
        }
      }
      
      // Atualizar imediatamente
      atualizarTimer();
      
      // Atualizar a cada segundo
      gameTimerInterval = setInterval(atualizarTimer, 1000);
    }

    // ===================================
    // ‚ùì BUSCAR PERGUNTA (CORRIGIDO!)
    // ===================================
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    async function getQuestion() {
      try {
        // ‚úÖ MUTEX: impedir chamadas concorrentes
        if (buscandoPergunta) {
          console.log("‚ö†Ô∏è getQuestion j√° em execu√ß√£o, ignorando chamada dupla");
          return;
        }
        buscandoPergunta = true;
        
        const btnAnswer = document.getElementById("btnAnswer");
        const fabBtn = document.getElementById("fabBtn");
        
        // üìä Esconder enquete se vis√≠vel
        esconderEnquete();
        // üí∞ Esconder mini-banner
        esconderMiniBanner();
        
        // ‚ö° Sem perguntas? Bloquear
        if (momentumState.perguntasRestantesFase <= 0 && momentumState.totalRespondidas > 0) {
          const faseMsg = momentumState.fase === 3 ? '‚è≥ Aguarde o timer ou use üíé 1 cr√©dito!' : '‚è≥ Aguarde...';
          showToast(faseMsg);
          buscandoPergunta = false;
          return;
        }
        
        // ‚úÖ VERIFICAR STATUS DO JOGO (da mem√≥ria, sem re-ler Firestore)
        if (jogoStatus !== 'ao_vivo') {
          if (jogoStatus === 'agendado') {
            alert("‚è≥ O jogo ainda n√£o come√ßou!");
          } else if (jogoStatus === 'finalizado') {
            alert("üèÅ Este jogo j√° foi finalizado!");
            atualizarBotaoBaseadoNoStatus();
            await loadRanking();
          }
          atualizarBotaoBaseadoNoStatus();
          buscandoPergunta = false;
          return;
        }
        
        btnAnswer.disabled = true;
        if (fabBtn) fabBtn.disabled = true;
        btnAnswer.textContent = "üîç Buscando pergunta...";

        // ‚úÖ CACHE: s√≥ busca perguntas do Firestore na PRIMEIRA vez
        if (!perguntasCache) {
          console.log("üîç Buscando perguntas para o time:", timeTorcida);
          const perguntasSnap = await db.collection("perguntas")
            .where("timeId", "==", timeTorcida)
            .get();

          console.log("üìö Perguntas encontradas:", perguntasSnap.size);

          if (perguntasSnap.empty) {
            alert("Nenhuma pergunta dispon√≠vel para este time!\n\nO administrador precisa cadastrar perguntas.");
            btnAnswer.disabled = false;
            btnAnswer.textContent = "üéØ Responder Pergunta";
            if (fabBtn) fabBtn.disabled = false;
            buscandoPergunta = false;
            return;
          }

          perguntasCache = [];
          perguntasSnap.forEach(doc => {
            const dados = doc.data();
            perguntasCache.push({
              id: doc.id,
              pergunta: dados.pergunta,
              alternativas: dados.alternativas,
              pontuacao: dados.pontuacao || dados.pontos || 10,
              timeId: dados.timeId
            });
          });
          console.log(`‚úÖ Cache: ${perguntasCache.length} perguntas carregadas`);
        }

        // Filtrar: remover perguntas j√° respondidas
        const perguntasDisponiveis = perguntasCache.filter(p => !perguntasSessao.has(p.id));

        console.log(`üìù Perguntas: ${perguntasCache.length} total | ${perguntasSessao.size} filtradas | ${perguntasEsteJogo.size} neste jogo | ${perguntasDisponiveis.length} dispon√≠veis`);

        // Se acabaram as perguntas dispon√≠veis
        if (perguntasDisponiveis.length === 0) {
          
          // PASSO 1: Tentar liberar perguntas de JOGOS ANTERIORES (que n√£o apareceram neste jogo)
          const naoVistasNesteJogo = perguntasCache.filter(p => !perguntasEsteJogo.has(p.id));
          
          if (naoVistasNesteJogo.length > 0) {
            console.log(`üîÑ Liberando ${naoVistasNesteJogo.length} perguntas de jogos anteriores (nunca vistas neste jogo)`);
            // Resetar Firestore + Set de filtro mantendo apenas as deste jogo
            await db.collection("usuarios").doc(uid).update({
              [`perguntasRespondidas_${timeTorcida}`]: []
            });
            perguntasSessao = new Set(perguntasEsteJogo); // manter s√≥ as deste jogo
            
            const perguntaAleatoria = naoVistasNesteJogo[Math.floor(Math.random() * naoVistasNesteJogo.length)];
            currentQuestion = perguntaAleatoria;
            perguntasSessao.add(currentQuestion.id);
            perguntasEsteJogo.add(currentQuestion.id);
            console.log("üìù Pergunta selecionada (liberada de jogo anterior):", currentQuestion.id, currentQuestion.pergunta);
            displayQuestion();
            buscandoPergunta = false;
            return;
          }
          
          // PASSO 2: TODAS as perguntas j√° foram vistas neste jogo ‚Äî reciclar tudo
          console.log(`üîÑ Ciclo completo! Todas as ${perguntasCache.length} perguntas respondidas NESTE JOGO. Reciclando...`);
          showToast(`üîÑ Todas as ${perguntasCache.length} perguntas respondidas! Reiniciando ciclo...`);
          
          await db.collection("usuarios").doc(uid).update({
            [`perguntasRespondidas_${timeTorcida}`]: []
          });
          perguntasSessao.clear();
          perguntasEsteJogo.clear();
          
          const perguntaAleatoria = perguntasCache[Math.floor(Math.random() * perguntasCache.length)];
          currentQuestion = perguntaAleatoria;
          perguntasSessao.add(currentQuestion.id);
          perguntasEsteJogo.add(currentQuestion.id);
          console.log("üìù Pergunta selecionada (ciclo novo):", currentQuestion.id, currentQuestion.pergunta);
          displayQuestion();
          buscandoPergunta = false;
          return;
        }

        // Escolher pergunta aleat√≥ria
        const perguntaAleatoria = perguntasDisponiveis[Math.floor(Math.random() * perguntasDisponiveis.length)];
        currentQuestion = perguntaAleatoria;
        
        // ‚úÖ Marcar como vista IMEDIATAMENTE (antes do display, antes do backend)
        perguntasSessao.add(currentQuestion.id);
        perguntasEsteJogo.add(currentQuestion.id);

        console.log("üìù Pergunta selecionada:", currentQuestion.id, currentQuestion.pergunta);
        console.log(`üîç Set filtro (${perguntasSessao.size}) | Neste jogo (${perguntasEsteJogo.size})`);

        displayQuestion();
        buscandoPergunta = false; // ‚úÖ Liberar mutex ap√≥s sele√ß√£o

      } catch (error) {
        console.error("‚ùå Erro ao buscar pergunta:", error);
        buscandoPergunta = false;
        const fabBtn = document.getElementById("fabBtn");
        if (fabBtn) fabBtn.disabled = false;
        alert("Erro ao buscar pergunta. Tente novamente!");
        document.getElementById("btnAnswer").disabled = false;
        document.getElementById("btnAnswer").textContent = "üéØ Responder Pergunta";
      }
    }

    // ===================================
    // üìù EXIBIR PERGUNTA COM TIMER (MODAL FULLSCREEN)
    // ===================================
    function displayQuestion() {
      const modalOverlay = document.getElementById("questionModalOverlay");
      const questionContainer = document.getElementById("questionContainer");
      const questionText = document.getElementById("questionText");
      const optionsContainer = document.getElementById("optionsContainer");
      const resultMessage = document.getElementById("resultMessage");
      const questionPoints = document.getElementById("questionPoints");

      // ‚úÖ ABRIR MODAL FULLSCREEN
      modalOverlay.classList.add("active");
      
      // Resetar
      questionText.textContent = currentQuestion.pergunta;
      optionsContainer.innerHTML = "";
      resultMessage.style.display = "none";

      // Mostrar pontua√ß√£o
      const pontos = currentQuestion.pontuacao || currentQuestion.pontos || 10;
      questionPoints.textContent = `Vale ${pontos} pontos`;

      // Verificar estrutura das alternativas
      const alternativas = currentQuestion.alternativas || {};
      
      // Verificar se usa letras mai√∫sculas ou min√∫sculas
      let letras = ['a', 'b', 'c', 'd'];
      if (alternativas['A'] && !alternativas['a']) {
        letras = ['A', 'B', 'C', 'D'];
      }

      if (!letras.some(letra => alternativas[letra])) {
        alert("Erro: Pergunta sem alternativas v√°lidas!");
        document.getElementById("btnAnswer").disabled = false;
        document.getElementById("btnAnswer").textContent = "üéØ Responder Pergunta";
        questionContainer.style.display = "none";
        return;
      }

      // Criar array com as op√ß√µes e embaralhar
      const opcoes = letras
        .filter(letra => alternativas[letra])
        .map(letra => ({
          letra: letra,
          texto: alternativas[letra]
        }));

      const opcoesEmbaralhadas = shuffleArray(opcoes);

      // Criar bot√µes das op√ß√µes
      opcoesEmbaralhadas.forEach((opcao) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opcao.texto;
        btn.onclick = () => answerQuestion(opcao.letra);
        optionsContainer.appendChild(btn);
      });

      // ‚úÖ INICIAR TIMER DE 10 SEGUNDOS
      startQuestionTimer();
      
      // üéØ Glow nas bordas se streak ativo
      atualizarStreakGlow();
    }

    // ===================================
    // ‚è±Ô∏è TIMER DA PERGUNTA (10 SEGUNDOS)
    // ===================================
    function startQuestionTimer() {
      questionTimeLeft = 10;
      questionStartTime = Date.now();  // ‚úÖ NOVO: Registrar in√≠cio
      updateTimerDisplay();

      questionTimer = setInterval(() => {
        questionTimeLeft--;
        updateTimerDisplay();

        if (questionTimeLeft <= 0) {
          clearInterval(questionTimer);
          timeoutQuestion();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerValue = document.getElementById("questionTimerValue");
      const timerCircle = document.getElementById("questionTimerCircle");
      
      timerValue.textContent = questionTimeLeft;

      // üîä Som de tick nos √∫ltimos 3 segundos
      onTimerTick(questionTimeLeft);

      // Mudar cor + P√ÇNICO nos √∫ltimos 3s
      timerCircle.classList.remove("warning", "danger");
      const modal = document.querySelector('.question-modal');
      if (questionTimeLeft <= 3) {
        timerCircle.classList.add("danger");
        if (modal) modal.classList.add("timer-panic");
      } else if (questionTimeLeft <= 5) {
        timerCircle.classList.add("warning");
        if (modal) modal.classList.remove("timer-panic");
      } else {
        if (modal) modal.classList.remove("timer-panic");
      }
    }

    function stopQuestionTimer() {
      if (questionTimer) { clearInterval(questionTimer); questionTimer = null; }
      const modal = document.querySelector('.question-modal');
      if (modal) modal.classList.remove('timer-panic');
    }

    // ===================================
    // ‚è∞ TEMPO ESGOTADO
    // ===================================
    async function timeoutQuestion() {
      try {
        // Desabilitar todas as op√ß√µes
        const options = document.querySelectorAll(".option-btn");
        options.forEach(opt => opt.disabled = true);

        const resultMessage = document.getElementById("resultMessage");
        resultMessage.style.display = "block";
        resultMessage.className = "result-message timeout";
        resultMessage.textContent = "‚è∞ Tempo esgotado! Verificando...";

        // ‚úÖ SEGURAN√áA: Enviar timeout ao servidor (resposta "__TIMEOUT__" = sempre errado)
        const responderFn = functions.httpsCallable('responderPerguntaV2');
        const resultado = await responderFn({
          jogoId: jogoId,
          perguntaId: currentQuestion.id,
          resposta: "__TIMEOUT__",
          tempoResposta: 10
        });

        const r = resultado.data;
        const correct = r.respostaCorreta;
        const alternativas = currentQuestion.alternativas || {};

        // ‚úÖ Atualizar estado do cooldown
        if (r.perguntasRestantes != null) {
          cooldownState.perguntasRestantes = r.perguntasRestantes;
          cooldownState.totalRespondidas = r.totalRespondidas;
          cooldownState.totalDisponivel = r.totalDisponivel;
        }

        // Mostrar resposta correta visualmente
        options.forEach((opt) => {
          const textoOpcao = opt.textContent;
          for (let letra in alternativas) {
            if (alternativas[letra] === textoOpcao && letra.toLowerCase() === correct.toLowerCase()) {
              opt.classList.add("correct");
              break;
            }
          }
        });

        resultMessage.textContent = `‚è∞ Tempo esgotado! Era: ${r.respostaTexto || alternativas[correct] || correct}`;

        // üéØ FEEDBACK EMOCIONAL
        mostrarFlashFeedback(false);
        const streakAnteriorTimeout = streak;
        
        // Atualizar streak local
        streak = 0;
        atualizarStreakDisplay();
        atualizarStreakGlow();
        
        // üéØ STREAK BREAK no timeout
        if (streakAnteriorTimeout >= 3) {
          mostrarStreakBreak(streakAnteriorTimeout);
        }
        
        // üî• SISTEMA VICIANTE ‚Äî som de erro no timeout
        onRespostaViciante(false, 0, 10);

        // (tracking j√° feito no momento da sele√ß√£o)

        await updateFreePlays();

        // ‚úÖ FECHAR MODAL ap√≥s 3 segundos
        setTimeout(async () => {
          currentQuestion = null;
          document.getElementById("questionModalOverlay").classList.remove("active");
          await updateFreePlays();
        }, 3000);

      } catch (error) {
        console.error("‚ùå Erro no timeout:", error);
        const code = error?.code || '';
        if (code === 'resource-exhausted') {
          try {
            const info = JSON.parse(error?.message || '');
            if (info.tipo === 'cooldown') {
              cooldownState.perguntasRestantes = 0;
              await updateFreePlays();
            }
          } catch(e) { mostrarOverlayLimiteAtingido(); }
        }
        // Fallback: fechar modal sem atualizar
        setTimeout(() => {
          currentQuestion = null;
          document.getElementById("btnAnswer").disabled = false;
          document.getElementById("btnAnswer").textContent = "üéØ Responder Pergunta";
          const fab = document.getElementById("fabBtn"); if (fab) fab.disabled = false;
          document.getElementById("questionModalOverlay").classList.remove("active");
        }, 2000);
      }
    }

    // ===================================
    // ‚úÖ RESPONDER PERGUNTA
    // ===================================
    async function answerQuestion(selectedLetter) {
      try {
        stopQuestionTimer();
        const tempoResposta = questionStartTime ? (Date.now() - questionStartTime) / 1000 : 10;

        const options = document.querySelectorAll(".option-btn");
        options.forEach(opt => opt.disabled = true);

        const resultMessage = document.getElementById("resultMessage");
        resultMessage.style.display = "block";
        resultMessage.className = "result-message";
        resultMessage.textContent = "‚è≥ Verificando resposta...";

        // ‚ö° Chamar server
        let r, usouV3 = false;
        try {
          const fn = functions.httpsCallable('responderPerguntaMomentumV3');
          r = (await fn({ jogoId, perguntaId: currentQuestion.id, resposta: selectedLetter, tempoResposta, usandoCredito: false })).data;
          usouV3 = true;
        } catch (e) {
          if (e?.code === 'resource-exhausted' || e?.code === 'already-exists') throw e;
          console.warn('‚ö†Ô∏è V3 indispon√≠vel, fallback V2');
          const fn = functions.httpsCallable('responderPerguntaV2');
          r = (await fn({ jogoId, perguntaId: currentQuestion.id, resposta: selectedLetter, tempoResposta })).data;
        }

        const acertou = r.acertou;
        const correct = r.respostaCorreta;
        const pontosFinais = r.pontosGanhos;
        const serverMult = r.multiplicador || 1;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚úÖ SERVER √â AUTORIDADE ABSOLUTA
        // Salvar timestamp ‚Äî updateFreePlays n√£o l√™ Firestore por 8s
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        momentumState.lastServerUpdate = Date.now();

        if (usouV3 && r.fase != null) {
          const faseAnt = momentumState.fase;
          momentumState.fase = r.fase;
          momentumState.momentumBonus = r.momentumBonus || 0;
          momentumState.totalRespondidas = r.totalRespondidas || (momentumState.totalRespondidas + 1);
          momentumState.timerAcertosConsecutivos = r.timerAcertosConsecutivos || 0;
          momentumState.perguntasRestantesFase = r.perguntasRestantes; // EXATO do server
          if (r.timerSegundos != null) momentumState.timerSegundos = r.timerSegundos;
          if (r.fase1Acertos != null) momentumState.fase1Acertos = r.fase1Acertos;

          console.log(`‚ö° SERVER: fase=${r.fase} restantes=${r.perguntasRestantes} bonus=${r.momentumBonus}`);

          // Feedbacks visuais
          if (r.momentumGanhou) { 
            mostrarMomentumFeedback('unlock','‚ö° +1 DESBLOQUEADA!'); SoundFX.momentumPlus(); adicionarLiveFeed('‚ö°','desbloqueou +1!');
            // Flash no bot√£o e phase bar pra mostrar que mudou
            const phaseBar = document.getElementById('momentumPhaseBar');
            if (phaseBar) { phaseBar.style.transition='transform 0.2s'; phaseBar.style.transform='scale(1.05)'; setTimeout(()=>phaseBar.style.transform='',300); }
          }
          if (r.momentumQuebrou) { mostrarMomentumFeedback('break','üíî MOMENTUM QUEBROU'); SoundFX.momentumBreak(); adicionarLiveFeed('üíî','Momentum quebrou!'); }
          if (faseAnt === 1 && r.fase === 2) {
            mostrarMomentumFeedback('phase-up', `‚ö° MOMENTUM! ${r.fase1Acertos||0}/5 = ${r.momentumBonus} b√¥nus!`);
            SoundFX.momentumUp();
            showToast(`‚ö° Fase Momentum! ${r.momentumBonus} perguntas b√¥nus!`, 4000);
          }
          if (r.timerEncurtou) showToast(`‚è±Ô∏è Timer encurtou! Pr√≥xima em ${r.timerSegundos}s`);
        } else {
          // Fallback V2
          momentumState.totalRespondidas++;
          if (r.totalRespondidas != null) {
            cooldownState.totalRespondidas = r.totalRespondidas;
            if (cooldownState.entradaEm) {
              const el = (Date.now() - cooldownState.entradaEm) / 1000;
              const c = Math.floor(el / cooldownState.cooldownSeg);
              cooldownState.totalDisponivel = 5 + (c*2) + (cooldownState.skipsUsados*2);
            }
            cooldownState.perguntasRestantes = Math.max(0, cooldownState.totalDisponivel - cooldownState.totalRespondidas);
            momentumState.perguntasRestantesFase = cooldownState.perguntasRestantes;
          }
        }

        // Visual
        const alt = currentQuestion.alternativas || {};
        options.forEach(opt => {
          let l=null; for(let k in alt){if(alt[k]===opt.textContent){l=k;break;}}
          if(l&&l.toLowerCase()===selectedLetter.toLowerCase()) opt.classList.add(acertou?"correct":"wrong");
          if(l&&l.toLowerCase()===correct.toLowerCase()&&!acertou) opt.classList.add("correct");
        });

        resultMessage.className = `result-message ${acertou?"success":"error"}`;
        mostrarFlashFeedback(acertou);

        const streakAnt = streak;
        if(acertou){totalAcertos++;}else{totalErros++;}
        streak = r.streak||0; maxStreak = r.maxStreak||maxStreak; multiplicador = serverMult;
        atualizarStreakDisplay(); atualizarStreakGlow();
        if(!acertou && streakAnt>=3) mostrarStreakBreak(streakAnt);
        onRespostaViciante(acertou, r.pontos||10, tempoResposta);
        if(acertou) verificarConquistas(tempoResposta);
        if(acertou && tempoResposta<3){db.collection('usuarios').doc(uid).update({xp:firebase.firestore.FieldValue.increment(2)}).catch(e=>{});showToast(`‚ö° R√°pido! +2 XP`);}
        if(!cicloInicialCompleto && (totalAcertos+totalErros)>=5){cicloInicialCompleto=true;db.collection('usuarios').doc(uid).update({xp:firebase.firestore.FieldValue.increment(5)}).catch(e=>{});}

        if(acertou && serverMult>1){resultMessage.innerHTML=`üéâ Correto! +${pontosFinais} pts <span style="color:#a78bfa;">(x${serverMult})</span>`;mostrarXPFlutuante(pontosFinais,true);}
        else if(acertou){resultMessage.textContent=`üéâ Correto! +${pontosFinais} pontos`;mostrarXPFlutuante(pontosFinais,false);}
        else{resultMessage.textContent=`‚ùå Errado! Era: ${r.respostaTexto||alt[correct]||correct}`;}

        // üìä Post-answer stat: "X% acertaram essa!"
        try {
          const pergDoc = await db.collection('perguntas').doc(currentQuestion.id).get();
          if (pergDoc.exists) {
            const pd = pergDoc.data();
            const totalR = (pd.totalAcertos || 0) + (pd.totalErros || 0);
            if (totalR > 5) {
              const percAcerto = Math.round(((pd.totalAcertos || 0) / totalR) * 100);
              const statEl = document.createElement('div');
              statEl.className = 'post-answer-stat';
              if (percAcerto < 30) {
                statEl.textContent = `üß† S√≥ ${percAcerto}% acertam essa! ${acertou ? 'Voc√™ √© craque!' : ''}`;
              } else if (percAcerto > 80) {
                statEl.textContent = `üìä ${percAcerto}% acertaram essa ${!acertou ? '‚Äî na pr√≥xima voc√™ pega!' : ''}`;
              } else {
                statEl.textContent = `üìä ${percAcerto}% dos jogadores acertaram essa`;
              }
              resultMessage.parentNode.insertBefore(statEl, resultMessage.nextSibling);
              setTimeout(() => statEl.remove(), 4000);
            }
          }
        } catch(e) { /* n√£o cr√≠tico */ }

        MissoesHelper.registrar(uid,'responder_3');
        const posAntes = minhaPosicaoAtual;

        atualizarFaseIndicador();
        atualizarMomentumBotao();
        await updateStats();
        await loadRanking();
        mostrarRankingToast(posAntes, minhaPosicaoAtual);
        verificarPatrocinador();

        setTimeout(async()=>{
          currentQuestion=null;
          document.getElementById("questionModalOverlay").classList.remove("active");
          // Atualizar UI com dados do server (ainda protegido por timestamp 8s)
          atualizarMomentumBotao();
          atualizarFaseIndicador();
          if(momentumState.fase===3 && momentumState.perguntasRestantesFase<=0) iniciarTimerMomentum();
          if(Math.random()<0.3) tentarMostrarEnquete();
        }, 3000);

      } catch(error) {
        console.error("‚ùå Erro:", error);
        const code=error?.code||error?.details?.code||'';
        const msg=error?.message||error?.details||"";
        if(code==='resource-exhausted'){
          try{const ci=JSON.parse(msg);if(ci.tipo==='cooldown'){momentumState.perguntasRestantesFase=0;if(ci.fase)momentumState.fase=ci.fase;showToast(`‚è≥ ${ci.mensagem}`);atualizarMomentumBotao();document.getElementById("questionModalOverlay").classList.remove("active");return;}}catch(e){}
          mostrarOverlayLimiteAtingido();
        }else{showToast("‚ùå "+msg);}
        document.getElementById("btnAnswer").disabled=false;
        document.getElementById("btnAnswer").textContent="üéØ Responder Pergunta";
        const f=document.getElementById("fabBtn");if(f)f.disabled=false;
        document.getElementById("questionModalOverlay").classList.remove("active");
      }
    }

    // ===================================
    // üìä ATUALIZAR PARTICIPANTE NA SUBCOLE√á√ÉO
    // ===================================
    async function atualizarParticipante(acertou, pontosGanhos, tempoResposta) {
      try {
        const participanteRef = db.collection("jogos").doc(jogoId)
          .collection("participantes").doc(uid);
        
        const participanteDoc = await participanteRef.get();
        
        if (participanteDoc.exists) {
          // Atualizar participante existente
          const updates = {
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          if (acertou) {
            updates.pontos = firebase.firestore.FieldValue.increment(pontosGanhos);
            updates.acertos = firebase.firestore.FieldValue.increment(1);
            updates.tempoSoma = firebase.firestore.FieldValue.increment(tempoResposta);
            updates.tempoQuantidade = firebase.firestore.FieldValue.increment(1);
          } else {
            updates.erros = firebase.firestore.FieldValue.increment(1);
          }
          
          await participanteRef.update(updates);
          
        } else {
          // Criar novo participante
          const userDoc = await db.collection("usuarios").doc(uid).get();
          const userData = userDoc.data() || {};
          const nomeUsuario = userData.usuarioUnico || userData.usuario || userData.nome || "An√¥nimo";
          
          // Determinar nome do time
          let timeNome = "Time";
          if (timeTorcida === timeCasaId && timeCasaData) {
            timeNome = timeCasaData.nome || "Time Casa";
          } else if (timeTorcida === timeForaId && timeForaData) {
            timeNome = timeForaData.nome || "Time Fora";
          }
          
          await participanteRef.set({
            odId: uid,
            nome: nomeUsuario,
            pontos: acertou ? pontosGanhos : 0,
            tempoSoma: acertou ? tempoResposta : 0,
            tempoQuantidade: acertou ? 1 : 0,
            tempoMedio: acertou ? tempoResposta : 0,
            timeId: timeTorcida,
            timeNome: timeNome,
            acertos: acertou ? 1 : 0,
            erros: acertou ? 0 : 1,
            criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        console.log("‚úÖ Participante atualizado na subcole√ß√£o");
        
      } catch (error) {
        console.error("‚ùå Erro ao atualizar participante:", error);
        // N√£o bloquear o jogo se falhar - √© apenas para premia√ß√£o
      }
    }

    // ===================================
    // ‚úÖ ANIMA√á√ÉO DE XP FLUTUANTE
    // ===================================
    function mostrarXPFlutuante(xp, bonus) {
      const container = document.getElementById('questionContainer');
      if (!container) return;
      
      const xpElement = document.createElement('div');
      xpElement.className = 'xp-flutuante' + (bonus ? ' bonus' : '');
      xpElement.innerHTML = `+${xp} XP${bonus ? ' üî•' : ''}`;
      
      // Posicionar aleatoriamente
      xpElement.style.left = `${30 + Math.random() * 40}%`;
      
      container.appendChild(xpElement);
      
      // Remover ap√≥s anima√ß√£o
      setTimeout(() => xpElement.remove(), 2000);
      
      // Vibra√ß√£o haptic (se dispon√≠vel)
      if (navigator.vibrate) {
        navigator.vibrate(bonus ? [50, 50, 50] : 50);
      }
    }

    // ===================================
    // üéØ FEEDBACK EMOCIONAL ‚Äî FLASH + STREAK BREAK + RANKING TOAST
    // ===================================
    
    // Flash verde (acerto) ou vermelho (erro) na tela toda
    function mostrarFlashFeedback(acertou) {
      const flash = document.createElement('div');
      flash.className = `feedback-flash ${acertou ? 'acerto' : 'erro'}`;
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 600);
      
      // Vibra√ß√£o diferenciada
      if (navigator.vibrate) {
        if (acertou) {
          navigator.vibrate(40);
        } else {
          navigator.vibrate([60, 30, 80]); // Mais forte no erro
        }
      }
    }

    // Streak break ‚Äî anima√ß√£o quando perde streak ‚â• 3
    function mostrarStreakBreak(streakPerdido) {
      if (streakPerdido < 3) return;
      
      const container = document.getElementById('questionContainer');
      if (!container) return;

      // Shake na tela
      const modal = document.querySelector('.question-modal');
      if (modal) {
        modal.classList.add('feedback-shake');
        setTimeout(() => modal.classList.remove('feedback-shake'), 500);
      }

      // Overlay de streak quebrado
      const overlay = document.createElement('div');
      overlay.className = 'streak-break-overlay';
      overlay.innerHTML = `
        <div class="streak-break-icon">üíîüî•</div>
        <div class="streak-break-text">Streak de ${streakPerdido} perdido!</div>
      `;
      container.appendChild(overlay);
      setTimeout(() => overlay.remove(), 2200);
    }

    // Glow nas bordas do modal baseado no streak atual
    function atualizarStreakGlow() {
      const modal = document.querySelector('.question-modal');
      if (!modal) return;

      modal.classList.remove('streak-glow', 'streak-glow-high');
      if (streak >= 5) {
        modal.classList.add('streak-glow-high');
      } else if (streak >= 3) {
        modal.classList.add('streak-glow');
      }
    }

    // Ranking Position Toast ‚Äî mostra mudan√ßa de posi√ß√£o
    function mostrarRankingToast(posAnterior, posNova) {
      // Primeira resposta ou sem dados ainda
      if (posAnterior == null || posNova == null) return;
      
      // Remover toast anterior se existir
      const existente = document.querySelector('.ranking-toast');
      if (existente) existente.remove();

      let texto = '';
      let classe = '';

      if (posNova === 1 && posAnterior !== 1) {
        texto = 'üëë Voc√™ lidera a partida!';
        classe = 'lidera';
      } else if (posNova === 1 && posAnterior === 1) {
        texto = 'üëë Continua l√≠der!';
        classe = 'lidera';
      } else if (posNova < posAnterior) {
        texto = `üìà Subiu para #${posNova}!`;
        classe = 'subiu';
      } else if (posNova > posAnterior) {
        texto = `üìâ Caiu para #${posNova}`;
        classe = 'caiu';
      } else {
        // Manteve posi√ß√£o ‚Äî mostrar s√≥ ocasionalmente
        if (Math.random() > 0.5) return;
        texto = `üìä Manteve #${posNova}`;
        classe = 'manteve';
      }

      const toast = document.createElement('div');
      toast.className = `ranking-toast ${classe}`;
      toast.textContent = texto;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    // ===================================
    // ‚ú® COMO GANHAR XP ‚Äî MODAL INFORMATIVO
    // ===================================
    function mostrarInfoXP() {
      const existente = document.getElementById('xpInfoOverlay');
      if (existente) { existente.remove(); return; }

      const overlay = document.createElement('div');
      overlay.className = 'xp-info-overlay';
      overlay.id = 'xpInfoOverlay';
      overlay.innerHTML = `
        <div class="xp-info-card">
          <h3>‚ú® Como Ganhar XP</h3>
          
          <div class="xp-info-item">
            <span>üéØ Acertar pergunta</span>
            <span class="xp-val">+10 XP</span>
          </div>
          <div class="xp-info-item">
            <span>‚ö° Resposta r√°pida (&lt;3s)</span>
            <span class="xp-val">+2 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üî• Streak x1.5 (3+ seguidos)</span>
            <span class="xp-val">+15 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üî• Streak x2 (5+ seguidos)</span>
            <span class="xp-val">+20 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üî• Streak x3 (10+ seguidos)</span>
            <span class="xp-val">+30 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üìù Ciclo de 5 perguntas</span>
            <span class="xp-val">+5 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üí¨ Mensagem no chat</span>
            <span class="xp-val">+2 XP (max 10)</span>
          </div>
          
          <div style="margin: 14px 0 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08);">
            <div style="font-size: 0.8em; color: #a78bfa; margin-bottom: 8px; font-weight: 600;">üèÖ Conquistas (b√¥nus √∫nico)</div>
          </div>
          <div class="xp-info-item">
            <span>‚öΩ Primeiro Gol ‚Äî 1¬∫ acerto</span>
            <span class="xp-val">+5 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üé© Hat-trick ‚Äî 3 seguidos</span>
            <span class="xp-val">+15 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üî• M√£o Quente ‚Äî 5 seguidos</span>
            <span class="xp-val">+30 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üöÄ Impar√°vel ‚Äî 10 seguidos</span>
            <span class="xp-val">+50 XP</span>
          </div>
          <div class="xp-info-item">
            <span>‚ö° Velocista ‚Äî acerto em &lt;3s</span>
            <span class="xp-val">+10 XP</span>
          </div>
          <div class="xp-info-item">
            <span>üíØ Perfeito ‚Äî 10 sem errar</span>
            <span class="xp-val">+100 XP</span>
          </div>
          
          <button class="xp-info-close" onclick="document.getElementById('xpInfoOverlay').remove()">
            Entendi! üí™
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
      
      // Fechar ao clicar fora
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.remove();
      });
    }

    // ===================================
    // üìä ENQUETES AO VIVO
    // ===================================

    const ENQUETES_TEMPLATES = [
      // TIPO 1 ‚Äî Opini√£o sobre o jogo (repet√≠veis: marcados com repete: true)
      { id: 'nota_time', tipo: 'opiniao', pergunta: 'Que nota voc√™ d√° pro seu time at√© agora?', 
        opcoes: ['‚≠ê 1', '‚≠ê‚≠ê 2', '‚≠ê‚≠ê‚≠ê 3', '‚≠ê‚≠ê‚≠ê‚≠ê 4', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5'], layout: 'row', repete: true },
      { id: 'tatica', tipo: 'opiniao', pergunta: 'Se voc√™ fosse o t√©cnico, o que faria agora?', 
        opcoes: ['üîÑ Substituir', '‚öîÔ∏è Atacar mais', 'üõ°Ô∏è Defender', '‚úã Manter'], layout: 'col', repete: true },
      { id: 'palpite_final', tipo: 'opiniao', pergunta: 'Como vai terminar o jogo?', 
        opcoes: ['üè† Vit√≥ria Casa', 'ü§ù Empate', '‚úàÔ∏è Vit√≥ria Fora'], layout: 'col', repete: false },
      { id: 'juiz', tipo: 'opiniao', pergunta: 'O juiz est√° apitando bem?', 
        opcoes: ['‚úÖ Sim', 'üòê Mais ou menos', '‚ùå P√©ssimo'], layout: 'col', repete: false },
      { id: 'confianca', tipo: 'opiniao', pergunta: 'N√≠vel de confian√ßa no seu time', 
        opcoes: ['üî• 100%', 'üí™ 75%', 'üò¨ 50%', 'üò∞ 25%', 'üíÄ 0%'], layout: 'row', repete: true },
      { id: 'melhor_time', tipo: 'opiniao', pergunta: 'Quem est√° jogando melhor no jogo?', 
        opcoes: ['üè† Time Casa', '‚úàÔ∏è Time Fora', 'ü§∑ Nenhum'], layout: 'col', repete: true },
      { id: 'faltando', tipo: 'opiniao', pergunta: 'O que t√° faltando pro seu time?', 
        opcoes: ['‚ö° Velocidade', 'üéØ Finaliza√ß√£o', 'üõ°Ô∏è Defesa', 'üß† Criatividade'], layout: 'col', repete: false },
      { id: 'sentimento', tipo: 'opiniao', pergunta: 'Como voc√™ t√° se sentindo agora?', 
        opcoes: ['üî• Confiante', 'üò§ Nervoso', 'üò¥ Entediado', 'ü§© Empolgado', 'üò≠ Sofrendo'], layout: 'row', repete: true },
      { id: 'segundo_tempo', tipo: 'opiniao', pergunta: 'O segundo tempo vai ser...', 
        opcoes: ['üî• Melhor', 'üòê Igual', 'üìâ Pior'], layout: 'col', repete: false },
      { id: 'nota_partida', tipo: 'opiniao', pergunta: 'Essa partida merece...', 
        opcoes: ['‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Cl√°ssico', '‚≠ê‚≠ê‚≠ê Normal', '‚≠ê Fraca'], layout: 'col', repete: false },

      // TIPO 2 ‚Äî Rea√ß√µes r√°pidas
      { id: 'reacao_momento', tipo: 'reacao', pergunta: 'Rea√ß√£o ao momento!', 
        opcoes: ['üî•', 'üò°', 'üòÇ', 'ü§Ø', 'üò¥', 'ü•≥'], layout: 'row', repete: true },
      { id: 'energia', tipo: 'reacao', pergunta: 'Manda a energia!', 
        opcoes: ['üí™', 'üôè', 'üçÄ', '‚ö°'], layout: 'row', repete: true },

      // TIPO 3 ‚Äî Palpites
      { id: 'gol_10min', tipo: 'palpite', pergunta: 'Vai ter gol nos pr√≥ximos 10 minutos?', 
        opcoes: ['‚öΩ Sim!', '‚ùå N√£o', 'ü§û Tomara'], layout: 'col', repete: false },
      { id: 'cartao_vermelho', tipo: 'palpite', pergunta: 'Vai ter cart√£o vermelho nesse jogo?', 
        opcoes: ['üü• Sim', '‚ùå N√£o'], layout: 'col', repete: false },
      { id: 'gols_1tempo', tipo: 'palpite', pergunta: 'Quantos gols v√£o sair no 1¬∫ tempo?', 
        opcoes: ['0Ô∏è‚É£ Nenhum', '1Ô∏è‚É£ Um', '2Ô∏è‚É£ Dois', '3Ô∏è‚É£ Tr√™s+'], layout: 'row', repete: false },

      // TIPO 4 ‚Äî Pessoal/Social
      { id: 'assistindo_de', tipo: 'social', pergunta: 'De onde voc√™ t√° assistindo?', 
        opcoes: ['üè† Casa', 'üèüÔ∏è Est√°dio', 'üç∫ Bar', 'üì± Rua'], layout: 'row', repete: false },
      { id: 'assistindo_com', tipo: 'social', pergunta: 'Com quem t√° assistindo?', 
        opcoes: ['üë§ Sozinho', 'üë• Amigos', 'üë®‚Äçüë©‚Äçüëß Fam√≠lia', 'üèüÔ∏è Torcida'], layout: 'row', repete: false },
      { id: 'torcedor_desde', tipo: 'social', pergunta: 'Torcedor desde quando?', 
        opcoes: ['üë∂ Nascen√ßa', 'üßí Inf√¢ncia', 'üßë Adolesc√™ncia', 'üÜï S√≥ hoje'], layout: 'row', repete: false },
    ];

    // Estado das enquetes
    const enqueteState = {
      exibidasNeste: [],       // IDs j√° exibidas neste jogo
      votosDoUsuario: {},      // { enqueteId: opcaoIndex }
      enqueteAtual: null,      // Template atual sendo exibida
      enqueteKey: null,        // Key no Firestore (jogoId + enqueteId + rodada)
      rodadas: {},             // { enqueteId: quantas vezes exibida }
      ultimaExibicao: 0,       // Timestamp da √∫ltima exibi√ß√£o
      listener: null,          // Firestore listener ativo
      intervaloMin: 120000,    // M√≠nimo 2 min entre enquetes (ms)
    };

    // Inicializar enquetes ‚Äî carregar votos do usu√°rio
    async function initEnquetes() {
      try {
        const doc = await db.collection('jogos').doc(jogoId).collection('enqueteVotos').doc(uid).get();
        if (doc.exists) {
          enqueteState.votosDoUsuario = doc.data().votos || {};
        }
      } catch (e) {
        console.error('Erro ao carregar votos:', e);
      }
    }

    // Selecionar pr√≥xima enquete (aleat√≥ria, respeitando regras)
    function selecionarEnquete() {
      const agora = Date.now();
      if (agora - enqueteState.ultimaExibicao < enqueteState.intervaloMin) return null;

      // Filtrar dispon√≠veis
      const disponiveis = ENQUETES_TEMPLATES.filter(e => {
        // J√° votou e n√£o repete?
        if (enqueteState.votosDoUsuario[e.id] != null && !e.repete) return false;
        // Se repete, verificar se j√° mostrou nesta rodada (max 3 repeti√ß√µes)
        if (e.repete) {
          const rodadas = enqueteState.rodadas[e.id] || 0;
          if (rodadas >= 3) return false;
          // Se votou nesta rodada, pular
          const keyAtual = `${e.id}_r${rodadas}`;
          if (enqueteState.votosDoUsuario[keyAtual] != null) return false;
        }
        return true;
      });

      if (disponiveis.length === 0) return null;

      // Aleat√≥rio com peso: rea√ß√µes e opini√£o repet√≠vel tem mais chance no cooldown
      const idx = Math.floor(Math.random() * disponiveis.length);
      return disponiveis[idx];
    }

    // Mostrar enquete
    function mostrarEnquete(forcar) {
      if (jogoStatus === 'finalizado') return;
      
      const template = forcar || selecionarEnquete();
      if (!template) return;

      enqueteState.enqueteAtual = template;
      enqueteState.ultimaExibicao = Date.now();
      
      const rodada = enqueteState.rodadas[template.id] || 0;
      enqueteState.enqueteKey = template.repete ? `${template.id}_r${rodada}` : template.id;

      const section = document.getElementById('enqueteSection');
      const card = document.getElementById('enqueteCard');

      // Verificar se j√° votou nesta inst√¢ncia
      const jaVotou = enqueteState.votosDoUsuario[enqueteState.enqueteKey] != null;

      const tipoLabels = { opiniao: 'üìä ENQUETE AO VIVO', reacao: '‚ö° REA√á√ÉO R√ÅPIDA', palpite: 'üéØ PALPITE', social: 'üë• SOBRE VOC√ä' };
      
      const opcLayout = template.layout === 'row' ? 'enquete-opcoes-row' : 'enquete-opcoes';

      card.innerHTML = `
        <div class="enquete-header">
          <span class="enquete-tag">${tipoLabels[template.tipo] || 'üìä ENQUETE'}</span>
          <span class="enquete-xp">+2 XP</span>
        </div>
        <div class="enquete-pergunta">${template.pergunta}</div>
        <div class="${opcLayout}" id="enqueteOpcoes">
          ${template.opcoes.map((op, i) => `
            <div class="enquete-opcao ${jaVotou ? 'voted' : ''} ${jaVotou && enqueteState.votosDoUsuario[enqueteState.enqueteKey] === i ? 'selected' : ''}" 
                 onclick="votarEnquete(${i})" data-idx="${i}">
              <div class="opcao-bar" id="enqueteBar_${i}"></div>
              <div class="opcao-content">
                <span class="opcao-text">${op}</span>
                <span class="opcao-perc" id="enquetePerc_${i}"></span>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="enquete-total-votos" id="enqueteTotalVotos"></div>
      `;

      section.classList.add('active');

      // Iniciar listener de votos em tempo real
      escutarVotosEnquete();

      // Se j√° votou, carregar resultados
      if (jaVotou) {
        carregarResultadosEnquete();
      }
    }

    // Votar
    async function votarEnquete(opcaoIdx) {
      const key = enqueteState.enqueteKey;
      if (!key || enqueteState.votosDoUsuario[key] != null) return;

      enqueteState.votosDoUsuario[key] = opcaoIdx;
      
      // Marcar visualmente
      const opcoes = document.querySelectorAll('#enqueteOpcoes .enquete-opcao');
      opcoes.forEach((el, i) => {
        el.classList.add('voted');
        if (i === opcaoIdx) el.classList.add('selected');
        el.onclick = null; // Desabilitar clique
      });

      // Salvar voto no Firestore
      try {
        // Incrementar contador da op√ß√£o
        const enqueteRef = db.collection('jogos').doc(jogoId).collection('enquetes').doc(key);
        await db.runTransaction(async (t) => {
          const doc = await t.get(enqueteRef);
          if (doc.exists) {
            const votos = doc.data().votos || [];
            votos[opcaoIdx] = (votos[opcaoIdx] || 0) + 1;
            t.update(enqueteRef, { votos, totalVotos: firebase.firestore.FieldValue.increment(1) });
          } else {
            const votos = new Array(enqueteState.enqueteAtual.opcoes.length).fill(0);
            votos[opcaoIdx] = 1;
            t.set(enqueteRef, { 
              enqueteId: enqueteState.enqueteAtual.id,
              pergunta: enqueteState.enqueteAtual.pergunta,
              votos, 
              totalVotos: 1,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        });

        // Salvar voto do usu√°rio
        await db.collection('jogos').doc(jogoId).collection('enqueteVotos').doc(uid).set({
          votos: enqueteState.votosDoUsuario
        }, { merge: true });

        // XP b√¥nus
        await db.collection('usuarios').doc(uid).update({
          xp: firebase.firestore.FieldValue.increment(2)
        });
        showToast('üìä Voto registrado! +2 XP');

        // Atualizar rodada se repet√≠vel
        if (enqueteState.enqueteAtual.repete) {
          enqueteState.rodadas[enqueteState.enqueteAtual.id] = (enqueteState.rodadas[enqueteState.enqueteAtual.id] || 0) + 1;
        }

      } catch (e) {
        console.error('Erro ao votar:', e);
        showToast('‚ùå Erro ao votar. Tente novamente.');
        delete enqueteState.votosDoUsuario[key];
      }
    }

    // Escutar votos em tempo real
    function escutarVotosEnquete() {
      // Cancelar listener anterior
      if (enqueteState.listener) enqueteState.listener();

      const key = enqueteState.enqueteKey;
      if (!key) return;

      enqueteState.listener = db.collection('jogos').doc(jogoId).collection('enquetes').doc(key)
        .onSnapshot(doc => {
          if (!doc.exists) return;
          const data = doc.data();
          atualizarBarrasEnquete(data.votos || [], data.totalVotos || 0);
        });
    }

    // Atualizar barras visuais
    function atualizarBarrasEnquete(votos, total) {
      if (!enqueteState.enqueteAtual || total === 0) return;

      enqueteState.enqueteAtual.opcoes.forEach((_, i) => {
        const count = votos[i] || 0;
        const perc = Math.round((count / total) * 100);
        
        const bar = document.getElementById(`enqueteBar_${i}`);
        const percEl = document.getElementById(`enquetePerc_${i}`);
        
        if (bar) bar.style.width = `${perc}%`;
        if (percEl) percEl.textContent = `${perc}%`;
      });

      const totalEl = document.getElementById('enqueteTotalVotos');
      if (totalEl) totalEl.textContent = `${total} voto${total !== 1 ? 's' : ''}`;

      // Mensagem de destaque se muitos votaram
      if (total >= 5) {
        const maxIdx = votos.indexOf(Math.max(...votos));
        const maxPerc = Math.round((votos[maxIdx] / total) * 100);
        let msgEl = document.getElementById('enqueteResultMsg');
        if (!msgEl) {
          msgEl = document.createElement('div');
          msgEl.className = 'enquete-resultado-msg';
          msgEl.id = 'enqueteResultMsg';
          document.getElementById('enqueteCard').appendChild(msgEl);
        }
        if (maxPerc >= 70) {
          msgEl.textContent = `üî• ${maxPerc}% concordam: ${enqueteState.enqueteAtual.opcoes[maxIdx]}`;
        } else {
          msgEl.textContent = `‚öîÔ∏è Opini√µes divididas!`;
        }
      }
    }

    // Carregar resultados se j√° votou
    async function carregarResultadosEnquete() {
      try {
        const doc = await db.collection('jogos').doc(jogoId).collection('enquetes').doc(enqueteState.enqueteKey).get();
        if (doc.exists) {
          const data = doc.data();
          atualizarBarrasEnquete(data.votos || [], data.totalVotos || 0);
        }
      } catch (e) {
        console.error('Erro ao carregar resultados:', e);
      }
    }

    // Esconder enquete
    function esconderEnquete() {
      document.getElementById('enqueteSection').classList.remove('active');
      if (enqueteState.listener) {
        enqueteState.listener();
        enqueteState.listener = null;
      }
    }

    // Tentar mostrar enquete (chamada no cooldown e entre perguntas)
    function tentarMostrarEnquete() {
      if (enqueteState.enqueteAtual && document.getElementById('enqueteSection').classList.contains('active')) return;
      mostrarEnquete();
    }

    // ===================================
    // üó£Ô∏è PROVOCA√á√ïES ENTRE TORCIDAS
    // ===================================

    const PROVOCACOES = [
      { id: 0, texto: 'üî• T√° f√°cil demais!', emoji: 'üî•' },
      { id: 1, texto: 'üò¥ Acordem a√≠!', emoji: 'üò¥' },
      { id: 2, texto: 'üëë Somos maiores!', emoji: 'üëë' },
      { id: 3, texto: 'ü§° Cad√™ o time?', emoji: 'ü§°' },
      { id: 4, texto: 'üí™ Vem que vem!', emoji: 'üí™' },
      { id: 5, texto: '‚öΩ Gooool nosso!', emoji: '‚öΩ' },
      { id: 6, texto: 'üèÜ O caneco √© nosso!', emoji: 'üèÜ' },
      { id: 7, texto: 'üòÇ T√¥ rindo aqui!', emoji: 'üòÇ' },
    ];

    let provocacaoCooldown = 0; // timestamp at√© quando est√° em cooldown
    let provocacaoPanel = false;

    function toggleProvocarPanel() {
      provocacaoPanel = !provocacaoPanel;
      const panel = document.getElementById('provocarPanel');
      
      if (provocacaoPanel) {
        renderProvocarGrid();
        panel.classList.add('active');
      } else {
        panel.classList.remove('active');
      }
    }

    function renderProvocarGrid() {
      const grid = document.getElementById('provocarGrid');
      const agora = Date.now();
      const emCooldown = agora < provocacaoCooldown;

      grid.innerHTML = PROVOCACOES.map(p => `
        <div class="provocar-opcao ${emCooldown ? 'disabled' : ''}" 
             onclick="${emCooldown ? '' : `enviarProvocacao(${p.id})`}"
             style="${emCooldown ? 'opacity:0.4;cursor:not-allowed;' : ''}">
          ${p.texto}
        </div>
      `).join('');

      const cdEl = document.getElementById('provocarCooldown');
      if (emCooldown) {
        const segRestam = Math.ceil((provocacaoCooldown - agora) / 1000);
        cdEl.textContent = `‚è≥ Pr√≥xima provoca√ß√£o em ${segRestam}s`;
      } else {
        cdEl.textContent = 'Escolha uma provoca√ß√£o! Aparece no chat geral üòà';
      }
    }

    async function enviarProvocacao(id) {
      const agora = Date.now();
      if (agora < provocacaoCooldown) {
        showToast('‚è≥ Espere o cooldown pra provocar de novo!');
        return;
      }

      const prov = PROVOCACOES.find(p => p.id === id);
      if (!prov) return;

      // Cooldown: 60 segundos entre provoca√ß√µes
      provocacaoCooldown = agora + 60000;

      // Fechar painel
      provocacaoPanel = false;
      document.getElementById('provocarPanel').classList.remove('active');

      try {
        if (!cachedUserData) {
          const userDoc = await db.collection("usuarios").doc(uid).get();
          cachedUserData = userDoc.data() || {};
        }
        const user = cachedUserData;
        const displayName = user.usuarioUnico || user.usuario || user.nome || "An√¥nimo";
        const avatar = user.avatarUrl || user.avatar || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random`;

        // Determinar nome do time do provocador
        const meuTime = timeTorcida === timeCasaId ? timeCasaData : timeForaData;
        const meuTimeNome = meuTime?.nome || 'Torcida';

        // Enviar pro chat GERAL com flag de provoca√ß√£o
        await db.collection("chats").add({
          jogoId,
          timeId: null,
          tipo: "geral",
          userId: uid,
          usuario: user.usuario || null,
          usuarioUnico: user.usuarioUnico || null,
          nome: displayName,
          avatar,
          mensagem: prov.texto,
          provocacao: true,
          provocacaoTimeNome: meuTimeNome,
          provocacaoTimeId: timeTorcida,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`üó£Ô∏è Provoca√ß√£o enviada! "${prov.texto}"`);

        // Atualizar bot√£o com cooldown visual
        atualizarBtnProvocar();

      } catch (e) {
        console.error('Erro ao enviar provoca√ß√£o:', e);
        showToast('‚ùå Erro ao enviar provoca√ß√£o.');
        provocacaoCooldown = 0; // Reset cooldown on error
      }
    }

    function atualizarBtnProvocar() {
      const btn = document.getElementById('provocarBtn');
      if (!btn) return;
      
      const agora = Date.now();
      if (agora < provocacaoCooldown) {
        const seg = Math.ceil((provocacaoCooldown - agora) / 1000);
        btn.disabled = true;
        btn.textContent = `üó£Ô∏è ${seg}s`;
        
        // Atualizar a cada segundo
        setTimeout(atualizarBtnProvocar, 1000);
      } else {
        btn.disabled = false;
        btn.textContent = 'üó£Ô∏è Provocar!';
      }
    }

    // ===================================
    // ‚úÖ TOGGLE RANKING (COLAPS√ÅVEL)
    // ===================================
    let rankingCollapsed = false;
    
    function toggleRanking() {
      const body = document.getElementById('rankingBody');
      const toggle = document.getElementById('rankingToggle');
      
      rankingCollapsed = !rankingCollapsed;
      
      if (rankingCollapsed) {
        body.classList.add('collapsed');
        toggle.classList.add('collapsed');
        toggle.textContent = '‚ñ∂';
      } else {
        body.classList.remove('collapsed');
        toggle.classList.remove('collapsed');
        toggle.textContent = '‚ñº';
      }
    }
    
    // ===================================
    // ‚úÖ CHAT FULLSCREEN
    // ===================================
    let chatFullscreen = false;
    
    function toggleChatFullscreen() {
      const chatSection = document.getElementById('chatSection');
      const btn = document.querySelector('.chat-fullscreen-btn');
      const icon = document.getElementById('chatFullscreenIcon');
      
      chatFullscreen = !chatFullscreen;
      
      if (chatFullscreen) {
        chatSection.classList.add('fullscreen');
        btn.innerHTML = '<span id="chatFullscreenIcon">‚úï</span> Fechar';
        document.body.style.overflow = 'hidden';
      } else {
        chatSection.classList.remove('fullscreen');
        btn.innerHTML = '<span id="chatFullscreenIcon">‚õ∂</span> Expandir';
        document.body.style.overflow = '';
      }
    }
    
    // ===================================
    // ‚úÖ ATUALIZAR FAB (BOT√ÉO FLUTUANTE)
    // ===================================
    function updateFab(disabled, icon) {
      const fabBtn = document.getElementById('fabBtn');
      const fabCredits = document.getElementById('fabCredits');
      
      if (fabBtn) {
        fabBtn.disabled = disabled;
        fabBtn.innerHTML = `<span class="fab-icon">${icon || 'üéØ'}</span>`;
      }
    }

    // ===================================
    // üí¨ SISTEMA DE CHAT (CORRIGIDO!)
    // ===================================
    function switchChat(type) {
      const tabs = document.querySelectorAll(".chat-tab");
      const contents = document.querySelectorAll(".chat-content");

      tabs.forEach(tab => tab.classList.remove("active"));
      contents.forEach(content => content.classList.remove("active"));

      chatActiveTab = type;

      if (type === "team") {
        tabs[0].classList.add("active");
        document.getElementById("teamChatContent").classList.add("active");
        limparBadge('team');
      } else {
        tabs[1].classList.add("active");
        document.getElementById("generalChatContent").classList.add("active");
        limparBadge('general');
      }
    }

    // ‚úÖ VARI√ÅVEIS PARA LISTENERS DO CHAT
    let chatListener = null;

    function initChat() {
      console.log("üí¨ Iniciando chat em tempo real...");
      
      // Cancelar listener anterior se existir
      if (chatListener) {
        chatListener();
        chatListener = null;
      }
      
      // ‚úÖ LISTENER √öNICO E SIMPLES - Sem orderBy (n√£o precisa de √≠ndice!)
      chatListener = db.collection("chats")
        .where("jogoId", "==", jogoId)
        .limit(200)  // Limitar para melhor performance
        .onSnapshot({ includeMetadataChanges: false }, snapshot => {
          console.log("üì© Chat atualizado! Total:", snapshot.size);
          
          const msgsTorcida = [];
          const msgsGeral = [];
          
          snapshot.forEach(doc => {
            const data = doc.data();
            
            // Separar mensagens por tipo
            if (data.timeId === timeTorcida) {
              msgsTorcida.push(data);
            }
            if (!data.timeId || data.tipo === "geral") {
              msgsGeral.push(data);
            }
          });
          
          // Ordenar por timestamp no cliente
          const ordenarPorTempo = (a, b) => {
            const getTime = (msg) => {
              if (!msg.timestamp) return Date.now(); // Mensagens novas sem timestamp v√£o pro final
              if (msg.timestamp.toMillis) return msg.timestamp.toMillis();
              if (msg.timestamp.seconds) return msg.timestamp.seconds * 1000;
              return 0;
            };
            return getTime(a) - getTime(b);
          };
          
          msgsTorcida.sort(ordenarPorTempo);
          msgsGeral.sort(ordenarPorTempo);
          
          // Pegar apenas as √∫ltimas 50 mensagens de cada
          const ultimasTorcida = msgsTorcida.slice(-50);
          const ultimasGeral = msgsGeral.slice(-50);
          
          // Renderizar chat da torcida
          const containerTorcida = document.getElementById("teamChat");
          if (containerTorcida) {
            containerTorcida.innerHTML = "";
            ultimasTorcida.forEach(msg => renderMessage(msg, containerTorcida));
            containerTorcida.scrollTop = containerTorcida.scrollHeight;
          }
          
          // Renderizar chat geral
          const containerGeral = document.getElementById("generalChat");
          if (containerGeral) {
            containerGeral.innerHTML = "";
            ultimasGeral.forEach(msg => renderMessage(msg, containerGeral));
            containerGeral.scrollTop = containerGeral.scrollHeight;
          }
          
          // üí¨ Atualizar badges de mensagens n√£o lidas
          atualizarChatBadge('team', ultimasTorcida.length);
          atualizarChatBadge('general', ultimasGeral.length);
          
        }, error => {
          console.error("‚ùå Erro no chat:", error);
          showToast("‚ö†Ô∏è Erro ao carregar chat. Recarregue a p√°gina.");
        });

      // Enter para enviar
      const teamInput = document.getElementById("teamChatInput");
      const generalInput = document.getElementById("generalChatInput");
      
      if (teamInput) {
        teamInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('teamMentionDropdown').classList.remove('active');
            sendMessage("team");
          }
        });
        teamInput.addEventListener("blur", () => {
          setTimeout(() => document.getElementById('teamMentionDropdown').classList.remove('active'), 200);
        });
      }
      if (generalInput) {
        generalInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('generalMentionDropdown').classList.remove('active');
            sendMessage("general");
          }
        });
        generalInput.addEventListener("blur", () => {
          setTimeout(() => document.getElementById('generalMentionDropdown').classList.remove('active'), 200);
        });
      }
    }

    function renderMessage(msg, container) {
      const div = document.createElement("div");
      div.className = "chat-message";
      
      const displayName = msg.usuarioUnico || msg.usuario || msg.nome || "An√¥nimo";
      const avatar = msg.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random`;
      
      // üó£Ô∏è PROVOCA√á√ÉO ‚Äî render especial
      if (msg.provocacao) {
        div.classList.add('provocacao');
        const timeNome = escapeHtml(msg.provocacaoTimeNome || 'Torcida');
        const isMyTeam = msg.provocacaoTimeId === timeTorcida;
        
        div.innerHTML = `
          <img src="${avatar}" alt="${escapeHtml(displayName)}" class="chat-avatar">
          <div class="chat-content-msg">
            <div class="provocacao-tag">üó£Ô∏è PROVOCA√á√ÉO ‚Ä¢ Torcida do ${timeNome}</div>
            <div class="chat-author">${escapeHtml(displayName)}</div>
            <div class="chat-text">${escapeHtml(msg.mensagem)}</div>
          </div>
        `;
        container.appendChild(div);
        return;
      }
      
      // Rastrear usu√°rio ativo
      if (msg.userId && msg.userId !== uid) {
        chatUsuariosAtivos.set(msg.userId, { nome: displayName, avatar: avatar });
      }
      
      // Processar @men√ß√µes no texto
      const textoProcessado = processarMencoes(escapeHtml(msg.mensagem));
      
      // Reply quote (se mensagem √© resposta a outra)
      let replyHtml = '';
      if (msg.replyTo) {
        const replyNome = escapeHtml(msg.replyTo.nome || '');
        const replyTexto = escapeHtml((msg.replyTo.texto || '').substring(0, 60));
        const replyEllipsis = (msg.replyTo.texto?.length > 60) ? '...' : '';
        replyHtml = `<div class="chat-reply-quote"><strong>@${replyNome}</strong> ${replyTexto}${replyEllipsis}</div>`;
      }
      
      // Detectar qual chat est√° ativo
      const chatType = container.id === 'teamChat' ? 'team' : 'general';
      
      // Escapar para atributos HTML (prevenir XSS com aspas)
      const safeName = displayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const safeMsg = (msg.mensagem || '').substring(0, 80).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
      
      div.innerHTML = `
        <img src="${avatar}" alt="${escapeHtml(displayName)}" class="chat-avatar">
        <div class="chat-content-msg">
          <div class="chat-author" onclick="inserirMencao('${safeName}', '${chatType}')" title="Clique para @mencionar">${escapeHtml(displayName)}</div>
          ${replyHtml}
          <div class="chat-text">${textoProcessado}</div>
        </div>
        <div class="chat-msg-actions">
          <button class="btn-reply" onclick="iniciarReply('${chatType}', '${safeName}', '${safeMsg}')">‚Ü©</button>
        </div>
      `;
      container.appendChild(div);
    }

    // Fun√ß√£o para escapar HTML e prevenir XSS
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===================================
    // üí¨ @MEN√á√ÉO ‚Äî AUTOCOMPLETE + HIGHLIGHT
    // ===================================
    
    // Mapa de usu√°rios ativos no chat
    const chatUsuariosAtivos = new Map();
    
    // Estado do reply
    let activeReply = { team: null, general: null };

    // Processar @men√ß√µes no texto ‚Äî highlight
    function processarMencoes(texto) {
      return texto.replace(/@(\w[\w.]{0,30})/g, (match, nome) => {
        // Verificar se √© men√ß√£o do usu√°rio atual
        const meuNome = cachedUserData?.usuarioUnico || cachedUserData?.usuario || cachedUserData?.nome || '';
        const isMe = nome.toLowerCase() === meuNome.toLowerCase();
        return `<span class="chat-mention${isMe ? ' is-me' : ''}">${match}</span>`;
      });
    }

    // Handle input pra detectar @
    function handleMentionInput(input, chatType) {
      const dropdown = document.getElementById(`${chatType}MentionDropdown`);
      const val = input.value;
      const cursorPos = input.selectionStart;
      
      // Encontrar @ antes do cursor
      const textBeforeCursor = val.substring(0, cursorPos);
      const atMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (!atMatch) {
        dropdown.classList.remove('active');
        return;
      }
      
      const filtro = atMatch[1].toLowerCase();
      
      // Filtrar usu√°rios
      const usuarios = [];
      chatUsuariosAtivos.forEach((data, odId) => {
        if (data.nome.toLowerCase().includes(filtro) || filtro === '') {
          usuarios.push(data);
        }
      });
      
      if (usuarios.length === 0) {
        dropdown.classList.remove('active');
        return;
      }
      
      // Renderizar dropdown (max 6)
      dropdown.innerHTML = usuarios.slice(0, 6).map(u => {
        const safeNome = u.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `
        <div class="mention-item" onclick="selecionarMencao('${safeNome}', '${chatType}')">
          <img src="${u.avatar}" alt="${escapeHtml(u.nome)}">
          <span>${escapeHtml(u.nome)}</span>
        </div>`;
      }).join('');
      dropdown.classList.add('active');
    }

    // Selecionar men√ß√£o do dropdown
    function selecionarMencao(nome, chatType) {
      const input = document.getElementById(`${chatType}ChatInput`);
      const dropdown = document.getElementById(`${chatType}MentionDropdown`);
      const val = input.value;
      const cursorPos = input.selectionStart;
      
      // Encontrar posi√ß√£o do @ 
      const textBefore = val.substring(0, cursorPos);
      const atIndex = textBefore.lastIndexOf('@');
      
      if (atIndex >= 0) {
        const antes = val.substring(0, atIndex);
        const depois = val.substring(cursorPos);
        input.value = `${antes}@${nome} ${depois}`;
        const newPos = atIndex + nome.length + 2; // +2 for @ and space
        input.setSelectionRange(newPos, newPos);
      }
      
      dropdown.classList.remove('active');
      input.focus();
    }

    // Clicar no nome do autor pra @mencionar
    function inserirMencao(nome, chatType) {
      const input = document.getElementById(`${chatType}ChatInput`);
      const current = input.value;
      if (current && !current.endsWith(' ')) {
        input.value = current + ' @' + nome + ' ';
      } else {
        input.value = current + '@' + nome + ' ';
      }
      input.focus();
    }

    // ===================================
    // üí¨ REPLY ‚Äî RESPONDER MENSAGEM
    // ===================================
    
    function iniciarReply(chatType, nome, texto) {
      activeReply[chatType] = { nome, texto };
      const bar = document.getElementById(`${chatType}ReplyBar`);
      const replyText = document.getElementById(`${chatType}ReplyText`);
      replyText.innerHTML = `‚Ü© <strong>@${nome}</strong>: ${texto.substring(0, 50)}${texto.length > 50 ? '...' : ''}`;
      bar.classList.add('active');
      document.getElementById(`${chatType}ChatInput`).focus();
    }

    function cancelReply(chatType) {
      activeReply[chatType] = null;
      document.getElementById(`${chatType}ReplyBar`).classList.remove('active');
    }

    // ‚úÖ Cache dos dados do usu√°rio para n√£o buscar toda vez
    let cachedUserData = null;
    
    async function sendMessage(type) {
      // ‚úÖ BLOQUEAR CHAT SE JOGO J√Å TERMINOU
      if (jogoStatus === 'finalizado') {
        showToast("üèÅ Chat encerrado! O jogo j√° terminou.");
        return;
      }
      
      const inputId = type === "team" ? "teamChatInput" : "generalChatInput";
      const input = document.getElementById(inputId);
      const mensagem = input.value.trim();
      
      if (!mensagem) return;
      
      // ‚úÖ Limpar input IMEDIATAMENTE (feedback instant√¢neo)
      input.value = "";
      input.disabled = true;
      input.placeholder = "Enviando...";

      try {
        // ‚úÖ Usar cache se dispon√≠vel
        if (!cachedUserData) {
          const userDoc = await db.collection("usuarios").doc(uid).get();
          cachedUserData = userDoc.data() || {};
        }
        
        const user = cachedUserData;
        const displayName = user.usuarioUnico || user.usuario || user.nome || "An√¥nimo";
        const avatar = user.avatarUrl || user.avatar || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random`;

        // ‚úÖ Enviar para o Firestore
        const chatData = {
          jogoId,
          timeId: type === "team" ? timeTorcida : null,
          tipo: type === "team" ? "torcida" : "geral",
          userId: uid,
          usuario: user.usuario || null,
          usuarioUnico: user.usuarioUnico || null,
          nome: displayName,
          avatar,
          mensagem,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // ‚úÖ Incluir reply se estiver respondendo
        if (activeReply[type]) {
          chatData.replyTo = {
            nome: activeReply[type].nome,
            texto: activeReply[type].texto
          };
          cancelReply(type);
        }
        
        await db.collection("chats").add(chatData);
        
        console.log("‚úÖ Mensagem enviada:", mensagem);
        
        // ‚ú® XP B√îNUS ‚Äî Chat participativo (+2 XP por mensagem, max 10 XP/jogo)
        if (chatXpGanho < 10) {
          const xpChat = 2;
          chatXpGanho += xpChat;
          db.collection('usuarios').doc(uid).update({
            xp: firebase.firestore.FieldValue.increment(xpChat)
          }).catch(e => console.error('Erro XP chat:', e));
          if (chatXpGanho <= 10) {
            showToast(`üí¨ +${xpChat} XP por mensagem! (${chatXpGanho}/10)`);
          }
        }

      } catch (error) {
        console.error("‚ùå Erro ao enviar mensagem:", error);
        // Restaurar mensagem se deu erro
        input.value = mensagem;
        showToast("‚ùå Erro ao enviar. Tente novamente!");
      } finally {
        // ‚úÖ Reativar input
        input.disabled = false;
        input.placeholder = type === "team" ? "Digite sua mensagem..." : "Mensagem para todos...";
        input.focus();
      }
    }

    // ===================================
    // üèÜ RANKING COM CR√âDITOS ESTIMADOS
    // ===================================
    
    // Pesos para distribui√ß√£o do ranking
    const PESOS_RANKING = [10, 7, 5, 4, 3, 2, 1.5, 1, 0.75, 0.5];
    const SOMA_PESOS = PESOS_RANKING.reduce((a, b) => a + b, 0); // 34.75
    
    // Vari√°veis globais para estat√≠sticas do jogo
    let totalCreditosPagosJogo = 0;  // Pool total de cr√©ditos
    let estatisticasTimes = { casa: { pontos: 0, torcedores: 0 }, fora: { pontos: 0, torcedores: 0 } };
    
    async function loadRanking() {
      try {
        // ‚úÖ BUSCAR POOL DE CR√âDITOS DO DOCUMENTO DO JOGO
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        const jogoData = jogoDoc.data() || {};
        
        // Tentar ler poolCreditos, se n√£o existir, usar poolCreditosPagos como fallback
        totalCreditosPagosJogo = jogoData.poolCreditos || 0;
        if (totalCreditosPagosJogo === 0 && jogoData.poolCreditosPagos) {
          totalCreditosPagosJogo = jogoData.poolCreditosPagos;
          console.log(`üì¢ Ranking usando fallback poolCreditosPagos: ${totalCreditosPagosJogo}`);
        }
        
        console.log(`üí∞ Pool de cr√©ditos: ${totalCreditosPagosJogo}`);
        
        const usuarios = await db.collection("usuarios").get();
        const ranking = [];
        
        // Reset estat√≠sticas
        estatisticasTimes = { 
          casa: { pontos: 0, torcedores: 0, nome: timeCasaData?.nome || 'Time A' }, 
          fora: { pontos: 0, torcedores: 0, nome: timeForaData?.nome || 'Time B' } 
        };

        usuarios.forEach(doc => {
          const user = doc.data();
          const odId = doc.id;
          const timeUser = user.torcidas?.[jogoId];
          
          // S√≥ usu√°rios deste jogo
          if (timeUser !== timeCasaId && timeUser !== timeForaId) return;
          
          // Contar torcedores
          if (timeUser === timeCasaId) {
            estatisticasTimes.casa.torcedores++;
          } else {
            estatisticasTimes.fora.torcedores++;
          }

          const pontos = user.pontuacoes?.[jogoId] || 0;
          
          // Somar pontos por time
          if (timeUser === timeCasaId) {
            estatisticasTimes.casa.pontos += pontos;
          } else {
            estatisticasTimes.fora.pontos += pontos;
          }
          
          if (pontos > 0) {
            const displayName = user.usuarioUnico || user.usuario || user.nome || "An√¥nimo";
            
            // Calcular tempo m√©dio de resposta
            const tempoData = user.tempoRespostas?.[jogoId];
            let tempoMedio = 10; // Default 10s se n√£o tiver dados
            if (tempoData && tempoData.quantidade > 0) {
              tempoMedio = tempoData.soma / tempoData.quantidade;
            }
            
            ranking.push({
              odId,
              nome: displayName,
              pontos,
              tempoMedio,
              timeId: timeUser,
              avatar: user.avatarUrl || user.avatar || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random`
            });
          }
        });

        // ‚úÖ ORDENAR: Por pontos (desc), desempate por tempo m√©dio (asc = mais r√°pido)
        ranking.sort((a, b) => {
          if (b.pontos !== a.pontos) return b.pontos - a.pontos;
          return a.tempoMedio - b.tempoMedio; // Menor tempo = melhor
        });

        // üéØ Atualizar posi√ß√£o do usu√°rio no ranking
        const meuIndex = ranking.findIndex(u => u.odId === uid);
        minhaPosicaoAtual = meuIndex >= 0 ? meuIndex + 1 : null;

        // Calcular cr√©ditos estimados
        const creditosEstimados = calcularCreditosEstimados(ranking.length);

        const rankingList = document.getElementById("rankingList");
        rankingList.innerHTML = "";

        if (ranking.length === 0) {
          rankingList.innerHTML = '<li style="text-align: center; color: var(--text-secondary); padding: 40px;">Nenhuma pontua√ß√£o ainda. Seja o primeiro!</li>';
          atualizarInfoPremiacao(0, 0, jogoCreditosIniciais);
          return;
        }

        ranking.slice(0, 10).forEach((user, index) => {
          const li = document.createElement("li");
          li.className = "ranking-item";
          
          const posicao = index + 1;
          const medalha = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : posicao === 3 ? 'ü•â' : `${posicao}¬∫`;
          
          // Cor do time
          const corTime = user.timeId === timeCasaId ? 'var(--cor-timeA)' : 'var(--cor-timeB)';
          
          // Mini camiseta do time
          const timeData = user.timeId === timeCasaId ? timeCasaData : timeForaData;
          const timeNome = timeData?.nome || '?';
          const miniJersey = `<span style="display:inline-block;width:18px;height:22px;vertical-align:middle;">${gerarCamisetaSVG(
            timeData?.primaria || '#666', 
            timeData?.secundaria || '#fff', 
            timeData?.terciaria || timeData?.primaria || '#666'
          )}</span>`;
          
          // Cr√©ditos estimados para esta posi√ß√£o
          const creditos = creditosEstimados[index] || 0;
          const creditosDisplay = creditos > 0 ? `<span class="ranking-credits">+${creditos} üíé</span>` : '';
          
          // √â o usu√°rio atual?
          if (user.odId === uid) li.classList.add('is-me');
          
          li.innerHTML = `
            <span class="ranking-position">${medalha}</span>
            <img src="${user.avatar}" alt="${user.nome}" class="ranking-avatar">
            <div class="ranking-info">
              <span class="ranking-name" style="color: ${corTime}">
                <span class="ranking-jersey" title="${timeNome}">${miniJersey}</span>
                ${user.nome}
              </span>
              <span class="ranking-time">${user.tempoMedio.toFixed(1)}s avg</span>
            </div>
            <div class="ranking-stats">
              <span class="ranking-points">${user.pontos} pts</span>
              ${creditosDisplay}
            </div>
          `;
          
          rankingList.appendChild(li);
        });
        
        // Atualizar info de premia√ß√£o (inclui cr√©ditos do admin)
        atualizarInfoPremiacao(totalCreditosPagosJogo, ranking.length, jogoCreditosIniciais);

        // üìä Atualizar mini stats pessoal
        atualizarMyStats();
        atualizarCompetitiveBar();
        atualizarStreakProgress();

      } catch (error) {
        console.error("‚ùå Erro ao carregar ranking:", error);
      }
    }
    
    // Tabela de premia√ß√£o fixa (espelha backend CONFIG_PARTIDA)
    const PREMIACAO_FAIXAS = [
      {
        min: 0, max: 9,
        top: [10, 7, 5], faixas: []
      },
      {
        min: 10, max: 100,
        top: [18, 16, 14, 12, 10],
        faixas: [
          { de: 6, ate: 15, valor: 9 },
          { de: 16, ate: 25, valor: 7 },
          { de: 26, ate: 35, valor: 5 },
          { de: 36, ate: 45, valor: 4 },
          { de: 46, ate: 50, valor: 3 }
        ]
      },
      {
        min: 101, max: 500,
        top: [30, 25, 22, 20, 18],
        faixas: [
          { de: 6, ate: 15, valor: 16 },
          { de: 16, ate: 25, valor: 14 },
          { de: 26, ate: 35, valor: 12 },
          { de: 36, ate: 45, valor: 10 },
          { de: 46, ate: 50, valor: 5 }
        ]
      },
      {
        min: 501, max: Infinity,
        top: [50, 45, 40, 35, 30],
        faixas: [
          { de: 6, ate: 15, valor: 25 },
          { de: 16, ate: 25, valor: 20 },
          { de: 26, ate: 35, valor: 18 },
          { de: 36, ate: 45, valor: 15 },
          { de: 46, ate: 50, valor: 10 }
        ]
      }
    ];
    
    function calcularCreditosEstimados(totalParticipantes) {
      if (totalParticipantes <= 0) return [];
      
      const faixa = PREMIACAO_FAIXAS.find(f => totalParticipantes >= f.min && totalParticipantes <= f.max) || PREMIACAO_FAIXAS[0];
      const maxPremiados = Math.min(50, totalParticipantes);
      const creditos = [];
      
      for (let i = 0; i < Math.min(maxPremiados, faixa.top.length); i++) {
        creditos.push(faixa.top[i]);
      }
      
      for (const fx of faixa.faixas) {
        for (let pos = fx.de; pos <= fx.ate && pos <= maxPremiados; pos++) {
          creditos.push(fx.valor);
        }
      }
      
      return creditos;
    }
    
    // Calcular total M√ÅXIMO da faixa (para mostrar "cr√©ditos em disputa")
    function calcularTotalFaixa(totalParticipantes) {
      const faixa = PREMIACAO_FAIXAS.find(f => totalParticipantes >= f.min && totalParticipantes <= f.max) || PREMIACAO_FAIXAS[0];
      // Calcular total se TODOS os slots fossem preenchidos
      let total = faixa.top.reduce((a, b) => a + b, 0);
      for (const fx of faixa.faixas) {
        for (let pos = fx.de; pos <= fx.ate; pos++) total += fx.valor;
      }
      return { total, premiados: faixa.top.length + faixa.faixas.reduce((s, f) => s + (f.ate - f.de + 1), 0) };
    }
    
    // Atualizar info de premia√ß√£o na interface
    function atualizarInfoPremiacao(totalCreditos, totalParticipantes, creditosAdmin = 0) {
      const infoEl = document.getElementById("premiacaoInfo");
      if (!infoEl) return;
      
      if (totalParticipantes > 0) {
        const { total, premiados } = calcularTotalFaixa(totalParticipantes);
        infoEl.innerHTML = `
          <div class="premiacao-ativa">
            üèÜ <strong>${total}</strong> cr√©ditos em disputa! <small style="color: #aaa;">(top ${premiados})</small>
          </div>
        `;
      } else {
        infoEl.innerHTML = `
          <div class="premiacao-ativa">
            üèÜ Premia√ß√£o ser√° definida ao iniciar
          </div>
        `;
      }
    }
    
    // ===================================
    // üèÜ PREMIA√á√ÉO AUTOM√ÅTICA
    // ===================================
    
    async function executarPremiacao() {
      // Evitar executar m√∫ltiplas vezes
      if (premiacaoExecutada) {
        console.log("‚ö†Ô∏è Premia√ß√£o j√° foi executada");
        return;
      }
      
      console.log("üèÜ Iniciando premia√ß√£o autom√°tica...");
      showToast("üèÅ Calculando premia√ß√£o...");
      
      try {
        // Verificar se o jogo j√° foi premiado
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        const jogoData = jogoDoc.data();
        
        if (jogoData.premiado && jogoData.premiacaoDetalhes) {
          console.log("‚úÖ Jogo j√° foi premiado anteriormente!");
          premiacaoExecutada = true;
          mostrarResultadoPremiacao(jogoData.premiacaoDetalhes);
          return;
        }
        
        // ‚úÖ V2: Cloud Function com valores fixos por posi√ß√£o
        const premiarJogoFn = functions.httpsCallable('premiarJogoV2');
        const resultadoPremio = await premiarJogoFn({ jogoId: jogoId });
        
        if (resultadoPremio.data.semParticipantes) {
          console.log("‚ö†Ô∏è Sem participantes");
          premiacaoExecutada = true;
          mostrarAguardandoPremiacao();
          return;
        }
        
        const premiacaoDetalhes = resultadoPremio.data.detalhes;
        
        console.log("üèÜ PREMIA√á√ÉO PROCESSADA COM SUCESSO!");
        premiacaoExecutada = true;
        
        // üìà Bolsa: pre√ßos atualizados automaticamente pela Cloud Function
        
        // Mostrar resultado
        mostrarResultadoPremiacao(premiacaoDetalhes);
        
      } catch (error) {
        console.error("‚ùå Erro na premia√ß√£o:", error);
        showToast("‚ùå Erro ao processar premia√ß√£o");
        // Marcar como verificado para n√£o ficar tentando
        premiacaoExecutada = true;
        mostrarAguardandoPremiacao();
      }
    }
    
    // Mostrar mensagem de aguardando premia√ß√£o
    function mostrarAguardandoPremiacao() {
      const btnAnswer = document.getElementById("btnAnswer");
      if (btnAnswer) {
        btnAnswer.innerHTML = `<span style="display: flex; align-items: center; gap: 8px;">
          üèÅ Jogo Encerrado
        </span>`;
        btnAnswer.disabled = true;
        btnAnswer.style.background = "linear-gradient(135deg, #95a5a6, #7f8c8d)";
      }
    }
    
    
    // ‚úÖ NOVA VERS√ÉO: Mostrar resultado da premia√ß√£o - PARA TODOS!
    function mostrarResultadoPremiacao(detalhes) {
      // ‚úÖ SEMPRE criar confetes quando o jogo termina - PARA TODOS!
      criarConfetes();
      
      // Verificar se usu√°rio ganhou algo
      const premio = verificarPremioUsuario(detalhes);
      
      // ‚úÖ SEMPRE mostrar tela de encerramento
      mostrarTelaEncerramento(detalhes, premio);
    }
    
    // ‚úÖ NOVA FUN√á√ÉO: Tela de encerramento para TODOS
    async function mostrarTelaEncerramento(detalhes, premio) {
      // Buscar dados do usu√°rio para mostrar resumo pessoal
      let meusPontos = 0;
      let minhaPosicao = '-';
      let meusAcertos = totalAcertos || 0;
      let meusErros = totalErros || 0;
      
      // Encontrar posi√ß√£o do usu√°rio no ranking
      if (detalhes && detalhes.ranking) {
        const meuRanking = detalhes.ranking.find(p => p.odId === uid);
        if (meuRanking) {
          meusPontos = meuRanking.pontos || 0;
          minhaPosicao = meuRanking.posicao;
        }
      }
      
      // Tentar buscar da subcole√ß√£o de participantes
      try {
        const participanteDoc = await db.collection("jogos").doc(jogoId)
          .collection("participantes").doc(uid).get();
        if (participanteDoc.exists) {
          const p = participanteDoc.data();
          meusPontos = p.pontos || meusPontos;
          meusAcertos = p.acertos || meusAcertos;
          meusErros = p.erros || meusErros;
        }
        
        // Se n√£o achou posi√ß√£o no ranking premiado, calcular da cole√ß√£o
        if (minhaPosicao === '-') {
          const todosSnap = await db.collection("jogos").doc(jogoId)
            .collection("participantes").orderBy("pontos", "desc").get();
          let pos = 1;
          todosSnap.forEach(doc => {
            if (doc.id === uid) minhaPosicao = pos;
            pos++;
          });
        }
      } catch (e) {
        console.log("N√£o foi poss√≠vel buscar dados do participante");
      }
      
      // Determinar emoji da posi√ß√£o
      let posicaoEmoji = 'üìä';
      if (minhaPosicao === 1) posicaoEmoji = 'ü•á';
      else if (minhaPosicao === 2) posicaoEmoji = 'ü•à';
      else if (minhaPosicao === 3) posicaoEmoji = 'ü•â';
      else if (minhaPosicao <= 10) posicaoEmoji = 'üèÖ';
      else if (minhaPosicao !== '-') posicaoEmoji = 'üéñÔ∏è';
      
      // Calcular aproveitamento
      const totalRespostas = meusAcertos + meusErros;
      const aproveitamento = totalRespostas > 0 ? Math.round((meusAcertos / totalRespostas) * 100) : 0;
      
      // Se√ß√£o de pr√™mio (se ganhou algo)
      let secaoPremio = '';
      if (premio.premioTotal > 0) {
        let textoTipo = 'Voc√™ foi premiado!';
        if (premio.tipoPremiacao === 'ranking') {
          textoTipo = `${premio.posicaoRanking}¬∫ lugar no ranking!`;
        }
        
        secaoPremio = `
          <div class="encerramento-premio">
            <div class="premio-titulo">üéâ ${textoTipo}</div>
            <div class="premio-valor">+${premio.premioTotal} üíé</div>
          </div>
        `;
      }
      
      const overlay = document.createElement('div');
      overlay.className = 'encerramento-overlay';
      overlay.id = 'encerramentoOverlay';
      overlay.innerHTML = `
        <div class="encerramento-modal">
          <div class="encerramento-titulo">üèÅ</div>
          <div class="encerramento-subtitulo">JOGO ENCERRADO!</div>
          
          <div class="encerramento-posicao prize-reveal">
            <div class="posicao-numero" style="font-size:2.5em;">${posicaoEmoji} ${minhaPosicao}¬∫</div>
            <div class="posicao-texto">Sua posi√ß√£o no ranking</div>
          </div>
          
          ${secaoPremio}
          
          <div class="encerramento-resumo">
            <div class="resumo-item">
              <div class="resumo-valor" data-countup="${meusPontos}">0</div>
              <div class="resumo-label">Pontos</div>
            </div>
            <div class="resumo-item">
              <div class="resumo-valor" style="color: #2ecc71;" data-countup="${meusAcertos}">0</div>
              <div class="resumo-label">Acertos</div>
            </div>
            <div class="resumo-item">
              <div class="resumo-valor" style="color: #e74c3c;" data-countup="${meusErros}">0</div>
              <div class="resumo-label">Erros</div>
            </div>
            <div class="resumo-item">
              <div class="resumo-valor" data-countup="${aproveitamento}">0</div>
              <div class="resumo-label">Aproveitamento</div>
            </div>
          </div>
          ${!premio.premioTotal ? `
            <div class="prize-consolation">
              <div style="font-size:1.1em;margin-bottom:4px;">üí™ Boa partida!</div>
              <div style="font-size:0.85em;opacity:0.8;">Voc√™ respondeu ${totalRespostas} perguntas com ${aproveitamento}% de aproveitamento.</div>
              <div style="font-size:0.85em;opacity:0.8;margin-top:4px;">Continue jogando para entrar no Top 10! üèÜ</div>
            </div>
          ` : ''}
          
          <button class="encerramento-btn" onclick="verPremiacaoCompleta()">
            üèÜ Ver Premia√ß√£o Completa
          </button>
          <button class="encerramento-btn secundario" onclick="document.getElementById('encerramentoOverlay').remove(); window.location.href='painel.html';">
            üè† Voltar ao Painel
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Guardar detalhes para uso posterior
      window.ultimosPremiacaoDetalhes = detalhes;

      // ‚ö° Count-up animation
      setTimeout(() => {
        overlay.querySelectorAll('[data-countup]').forEach(el => {
          const target = parseInt(el.dataset.countup) || 0;
          let current = 0;
          const step = Math.max(1, Math.ceil(target / 40));
          const interval = setInterval(() => {
            current = Math.min(current + step, target);
            el.textContent = current + (el.closest('.resumo-item')?.querySelector('.resumo-label')?.textContent === 'Aproveitamento' ? '%' : '');
            if (current >= target) clearInterval(interval);
          }, 30);
        });
      }, 500);
      
      // Se ganhou pr√™mio, mostrar anima√ß√£o especial depois de 2 segundos
      if (premio.premioTotal > 0) {
        setTimeout(() => {
          criarConfetes(); // Mais confetes!
        }, 2000);
      }
    }
    
    // Fun√ß√£o para ver premia√ß√£o completa
    function verPremiacaoCompleta() {
      const overlay = document.getElementById('encerramentoOverlay');
      if (overlay) overlay.remove();
      
      if (window.ultimosPremiacaoDetalhes) {
        mostrarModalPremiacaoDetalhada(window.ultimosPremiacaoDetalhes);
      }
    }
    
    // Modal de premia√ß√£o detalhada (lista completa)
    function mostrarModalPremiacaoDetalhada(detalhes) {
      if (!detalhes) return;
      
      // ‚úÖ V2: 100% ranking por m√©rito, valores fixos
      // Calcular total estimado da faixa se o backend retornou 0 (jogo antigo)
      const totalReal = detalhes.totalPremio || detalhes.totalPool || detalhes.totalPago || 0;
      const totalPremiados = detalhes.totalPremiados || (detalhes.ranking || []).length || 0;
      
      // Se n√£o tem ranking do backend, tentar estimar do ranking da partida
      let rankingList = (detalhes.ranking || []).filter(p => p.creditos > 0);
      
      // Criar modal de resultado
      const modal = document.createElement("div");
      modal.className = "premiacao-modal-overlay";
      
      let rankingHTML = '';
      if (rankingList.length > 0) {
        rankingHTML = `
          <div class="premiacao-secao">
            <h3>üèÖ Ranking (${totalReal} cr)</h3>
            <ul class="premiacao-lista">
              ${rankingList.map(p => `
                <li>
                  <span>${p.posicao === 1 ? 'ü•á' : p.posicao === 2 ? 'ü•à' : p.posicao === 3 ? 'ü•â' : p.posicao + '¬∫'} ${p.nome}</span>
                  <span>+${p.creditos} üíé</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      } else {
        rankingHTML = `
          <div class="premiacao-secao">
            <h3>üèÖ Ranking</h3>
            <p style="text-align:center; opacity:0.6; padding: 10px;">Premia√ß√£o ainda sendo processada ou jogo antigo (pr√©-v2)</p>
          </div>
        `;
      }
      
      modal.innerHTML = `
        <div class="premiacao-modal">
          <h2>üèÜ RESULTADO DA PREMIA√á√ÉO</h2>
          
          <div class="premiacao-total">
            üí∞ Total distribu√≠do: <strong>${totalReal}</strong> cr√©ditos
            <br><small>100% distribu√≠do por ranking (m√©rito)</small>
          </div>
          
          ${rankingHTML}
          
          <button class="btn-fechar-premiacao" onclick="this.closest('.premiacao-modal-overlay').remove()">
            Fechar
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Verificar se o usu√°rio atual ganhou algo
      verificarPremioUsuario(detalhes);
    }
    
    // Criar confetes - MELHORADO
    function criarConfetes(quantidade = 150) {
      const cores = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ff8c42', '#a78bfa', '#2ecc71', '#e74c3c', '#9b59b6'];
      
      // Remover container anterior se existir
      const containerExistente = document.getElementById('confeteContainer');
      if (containerExistente) containerExistente.remove();
      
      const confeteContainer = document.createElement('div');
      confeteContainer.id = 'confeteContainer';
      confeteContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 19999; overflow: hidden;';
      document.body.appendChild(confeteContainer);
      
      for (let i = 0; i < quantidade; i++) {
        setTimeout(() => {
          const confete = document.createElement('div');
          confete.className = 'confete';
          
          // Variedade de formas
          const formas = ['50%', '0', '3px'];
          const forma = formas[Math.floor(Math.random() * formas.length)];
          
          confete.style.cssText = `
            position: absolute;
            top: -20px;
            left: ${Math.random() * 100}vw;
            background: ${cores[Math.floor(Math.random() * cores.length)]};
            width: ${Math.random() * 12 + 6}px;
            height: ${Math.random() * 12 + 6}px;
            border-radius: ${forma};
            animation: confeteFall ${Math.random() * 2 + 2.5}s linear forwards;
            transform: rotate(${Math.random() * 360}deg);
            opacity: ${Math.random() * 0.5 + 0.5};
          `;
          confeteContainer.appendChild(confete);
          
          // Remover ap√≥s anima√ß√£o
          setTimeout(() => confete.remove(), 5000);
        }, i * 20);
      }
      
      // Limpar container ap√≥s 6s
      setTimeout(() => {
        if (confeteContainer.parentNode) {
          confeteContainer.remove();
        }
      }, 6000);
    }
    
    // Mostrar anima√ß√£o de vit√≥ria
    function mostrarAnimacaoVitoria(posicao, creditos, tipo) {
      // Criar confetes primeiro
      criarConfetes();
      
      // Determinar medalha baseada na posi√ß√£o
      let medalha = 'üéñÔ∏è';
      let textoTipo = 'Premia√ß√£o';
      
      if (tipo === 'ranking') {
        if (posicao === 1) medalha = 'ü•á';
        else if (posicao === 2) medalha = 'ü•à';
        else if (posicao === 3) medalha = 'ü•â';
        else if (posicao <= 10) medalha = 'üèÖ';
        else medalha = 'üéñÔ∏è';
        textoTipo = `${posicao}¬∫ Lugar no Ranking!`;
      }
      
      const overlay = document.createElement('div');
      overlay.className = 'vitoria-overlay';
      overlay.innerHTML = `
        <div class="vitoria-modal">
          <div class="vitoria-medalha">${medalha}</div>
          <div class="vitoria-posicao">${textoTipo}</div>
          <div class="vitoria-texto">Parab√©ns! Voc√™ foi premiado!</div>
          <div class="vitoria-premio">
            <div>
              <div class="vitoria-premio-valor">+${creditos}</div>
              <div class="vitoria-premio-tipo">cr√©ditos</div>
            </div>
          </div>
          <button class="vitoria-btn" onclick="this.closest('.vitoria-overlay').remove()">
            üéâ Celebrar!
          </button>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Som de vit√≥ria (opcional - descomente se quiser)
      // new Audio('som-vitoria.mp3').play().catch(e => {});
    }
    
    // Verificar se o usu√°rio atual ganhou - CORRIGIDO
    function verificarPremioUsuario(detalhes) {
      // ‚úÖ CORRE√á√ÉO: Validar detalhes antes de usar
      if (!detalhes) {
        console.log("‚ö†Ô∏è Detalhes da premia√ß√£o n√£o dispon√≠veis");
        return { premioTotal: 0, posicaoRanking: null, tipoPremiacao: null };
      }
      
      let premioTotal = 0;
      let posicaoRanking = null;
      let tipoPremiacao = null;
      
      // ‚úÖ V2: S√≥ ranking (100% m√©rito)
      const premioRanking = (detalhes.ranking || []).find(p => p.odId === uid);
      if (premioRanking) {
        premioTotal += premioRanking.creditos || 0;
        posicaoRanking = premioRanking.posicao;
        tipoPremiacao = 'ranking';
      }
      
      return { premioTotal, posicaoRanking, tipoPremiacao };
    }

    // ===================================
    // üîô VOLTAR AO PAINEL
    // ===================================
    function voltarPainel() {
      stopQuestionTimer();
      if (confirm("Deseja realmente sair do jogo?")) {
        window.location.href = "painel.html";
      }
    }

    // ===================================
    // üî• ATUALIZAR STREAK
    // ===================================
    function atualizarStreak(acertou) {
      if (acertou) {
        streak++;
        totalAcertos++;
        if (streak > maxStreak) maxStreak = streak;
        
        // Calcular multiplicador
        if (streak >= 10) multiplicador = 3;
        else if (streak >= 5) multiplicador = 2;
        else if (streak >= 3) multiplicador = 1.5;
        else multiplicador = 1;
        
        // Verificar conquistas
        verificarConquistas();
        
      } else {
        streak = 0;
        totalErros++;
        multiplicador = 1;
      }

      atualizarStreakDisplay();
    }

    // ‚úÖ Atualiza apenas o visual do streak (sem recalcular - usado quando server envia valores)
    function atualizarStreakDisplay() {
      const streakBadge = document.getElementById('streakBadge');
      const streakCount = document.getElementById('streakCount');
      const multiplierBadge = document.getElementById('multiplierBadge');
      const multiplierValue = document.getElementById('multiplierValue');

      streakCount.textContent = streak;
      
      if (streak >= 3) {
        streakBadge.classList.add('active');
        multiplierBadge.style.display = 'flex';
        multiplierValue.textContent = multiplicador;
      } else {
        streakBadge.classList.remove('active');
        multiplierBadge.style.display = 'none';
      }
    }

    // ===================================
    // üèÖ VERIFICAR CONQUISTAS
    // ===================================
    function verificarConquistas(tempoResposta) {
      // Primeiro acerto
      if (totalAcertos === 1 && !conquistasDesbloqueadas.includes('primeiroAcerto')) {
        mostrarConquista(CONQUISTAS.primeiroAcerto);
        conquistasDesbloqueadas.push('primeiroAcerto');
        salvarConquistas();
      }

      // Streak 3
      if (streak >= 3 && !conquistasDesbloqueadas.includes('streak3')) {
        mostrarConquista(CONQUISTAS.streak3);
        conquistasDesbloqueadas.push('streak3');
        salvarConquistas();
      }

      // Streak 5
      if (streak >= 5 && !conquistasDesbloqueadas.includes('streak5')) {
        mostrarConquista(CONQUISTAS.streak5);
        conquistasDesbloqueadas.push('streak5');
        salvarConquistas();
      }

      // Streak 10
      if (streak >= 10 && !conquistasDesbloqueadas.includes('streak10')) {
        mostrarConquista(CONQUISTAS.streak10);
        conquistasDesbloqueadas.push('streak10');
        salvarConquistas();
      }

      // ‚úÖ Velocista ‚Äî resposta correta em menos de 3 segundos
      if (tempoResposta && tempoResposta < 3 && !conquistasDesbloqueadas.includes('rapido')) {
        mostrarConquista(CONQUISTAS.rapido);
        conquistasDesbloqueadas.push('rapido');
        salvarConquistas();
      }

      // 10 acertos sem errar
      if (totalAcertos >= 10 && totalErros === 0 && !conquistasDesbloqueadas.includes('perfeito')) {
        mostrarConquista(CONQUISTAS.perfeito);
        conquistasDesbloqueadas.push('perfeito');
        salvarConquistas();
      }
    }
    
    // ‚úÖ NOVO: Salvar conquistas no Firebase
    function salvarConquistas() {
      db.collection("usuarios").doc(uid).update({
        [`conquistas_${jogoId}`]: conquistasDesbloqueadas
      }).catch(e => console.error("Erro ao salvar conquistas:", e));
    }

    // ===================================
    // üèÖ MOSTRAR CONQUISTA
    // ===================================
    async function mostrarConquista(conquista) {
      // Criar overlay
      const overlay = document.createElement('div');
      overlay.className = 'achievement-overlay';
      document.body.appendChild(overlay);

      // Sponsor contextual na conquista
      let sponsorBranding = '';
      if (patrocinadoresJogo.length > 0) {
        const s = patrocinadoresJogo[Math.floor(Math.random() * patrocinadoresJogo.length)];
        sponsorBranding = `<div style="font-size:0.7em;color:#ffb547;margin-top:8px;opacity:0.7;">üì¢ Conquista patrocinada por ${s.nome}</div>`;
      }

      // Criar popup
      const popup = document.createElement('div');
      popup.className = 'achievement-popup';
      popup.innerHTML = `
        <div class="emoji">${conquista.emoji}</div>
        <div class="title">üèÖ ${conquista.nome}</div>
        <div class="description">${conquista.descricao}</div>
        <div class="bonus">+${conquista.xpBonus} XP B√¥nus!</div>
        ${sponsorBranding}
      `;
      document.body.appendChild(popup);

      // Dar XP b√¥nus
      try {
        await db.collection('usuarios').doc(uid).update({
          xp: firebase.firestore.FieldValue.increment(conquista.xpBonus),
          [`conquistas.${conquista.id}`]: {
            data: new Date().toISOString(),
            jogoId: jogoId
          }
        });
      } catch (e) {
        console.error("Erro ao salvar conquista:", e);
      }

      // Remover ap√≥s 2.5 segundos
      setTimeout(() => {
        popup.remove();
        overlay.remove();
      }, 2500);
    }

    // ===================================
    // üí∞ SISTEMA DE PATROCINADORES (CONTEXTUAL ROTATIVO)
    // ===================================
    let sponsorTimeout = null;
    let patrocinadoresJogo = [];        // Lista de patrocinadores da partida
    let patrocinadorAtualIndex = 0;     // √çndice do pr√≥ximo patrocinador
    let contadorRespostas = 0;          // Contador de respostas para mostrar a cada 8
    let patrocinadorPendente = null;    // Patrocinador atual sendo mostrado
    let sponsorBannerIndex = 0;         // √çndice rotativo do mini-banner
    let sponsorBannerInterval = null;   // Intervalo de rota√ß√£o do banner
    let sponsorImpressoes = {};         // { sponsorNome: count }
    let sponsorsResgatados = new Set(); // Sponsors j√° resgatados NESTE jogo (anti-spam)

    // Mensagens contextuais por momento
    const SPONSOR_CONTEXTOS = [
      'Enquanto espera, conhe√ßa ‚Üí',
      'Toque para visitar ‚Üí',
      'Apoie quem apoia o jogo ‚Üí',
      'Parceiro oficial ‚Üí',
      'Visite e ganhe pontos ‚Üí',
    ];
    
    // Carregar patrocinadores da partida
    async function carregarPatrocinadores() {
      try {
        const jogoDoc = await db.collection("jogos").doc(jogoId).get();
        const jogo = jogoDoc.data();
        
        console.log("üì¢ Dados do jogo:", jogo);
        console.log("üì¢ Patrocinadores no jogo:", jogo.patrocinadores);
        
        if (jogo.patrocinadores && jogo.patrocinadores.length > 0) {
          patrocinadoresJogo = jogo.patrocinadores;
          console.log(`üì¢ ${patrocinadoresJogo.length} patrocinadores carregados:`, patrocinadoresJogo.map(p => p.nome));
        } else {
          console.log("üì¢ Nenhum patrocinador cadastrado para esta partida");
          patrocinadoresJogo = [];
        }
        
        // Carregar √≠ndice do usu√°rio (para continuar de onde parou)
        const userDoc = await db.collection("usuarios").doc(uid).get();
        const userData = userDoc.data() || {};
        patrocinadorAtualIndex = userData.patrocinadorIndex?.[jogoId] || 0;
        contadorRespostas = userData.contadorRespostas?.[jogoId] || 0;
        
        // ‚úÖ Carregar sponsors j√° resgatados (anti-spam)
        const resgatados = userData.patrocinadoresResgatados?.[jogoId] || [];
        resgatados.forEach(r => sponsorsResgatados.add(r.nome));
        
        // ‚úÖ Atualizar contador na interface
        const respostasEl = document.getElementById('respostasCount');
        if (respostasEl) respostasEl.textContent = contadorRespostas;
        
        console.log(`üì¢ √çndice atual: ${patrocinadorAtualIndex}, Contador respostas: ${contadorRespostas}`);
        
      } catch (error) {
        console.error("‚ùå Erro ao carregar patrocinadores:", error);
        patrocinadoresJogo = [];
      }
    }
    
    // ====== MINI-BANNER ROTATIVO (cooldown) ======
    
    function mostrarMiniBanner() {
      if (patrocinadoresJogo.length === 0) return;
      
      const banner = document.getElementById('sponsorMiniBanner');
      if (!banner) return;
      
      atualizarMiniBanner();
      banner.classList.add('active');
      
      // Rotacionar a cada 15 segundos se houver mais de 1 sponsor
      if (patrocinadoresJogo.length > 1 && !sponsorBannerInterval) {
        sponsorBannerInterval = setInterval(() => {
          sponsorBannerIndex = (sponsorBannerIndex + 1) % patrocinadoresJogo.length;
          atualizarMiniBanner();
        }, 15000);
      }
    }
    
    function atualizarMiniBanner() {
      const sponsor = patrocinadoresJogo[sponsorBannerIndex % patrocinadoresJogo.length];
      if (!sponsor) return;
      
      const logoEl = document.getElementById('sponsorMiniLogo');
      const nameEl = document.getElementById('sponsorMiniName');
      const ctaEl = document.getElementById('sponsorMiniCta');
      const rewardEl = document.getElementById('sponsorMiniReward');
      
      // Logo
      if (sponsor.logoUrl) {
        logoEl.innerHTML = `<img src="${sponsor.logoUrl}" alt="${sponsor.nome}">`;
      } else {
        logoEl.textContent = sponsor.logo || 'üéÅ';
      }
      
      // Info
      nameEl.textContent = sponsor.nome;
      const pontos = sponsor.pontos || sponsor.creditos || 10;
      const jaResgatou = sponsorsResgatados.has(sponsor.nome);
      if (jaResgatou) {
        ctaEl.textContent = '‚úÖ Pontos j√° resgatados ‚Ä¢ Toque para visitar';
        ctaEl.style.color = '#7f8c8d';
        rewardEl.textContent = '‚úÖ';
        rewardEl.style.background = 'rgba(127,140,141,0.15)';
        rewardEl.style.borderColor = 'rgba(127,140,141,0.3)';
        rewardEl.style.color = '#7f8c8d';
      } else {
        const ctxMsg = SPONSOR_CONTEXTOS[Math.floor(Math.random() * SPONSOR_CONTEXTOS.length)];
        ctaEl.textContent = ctxMsg;
        ctaEl.style.color = '#10b981';
        rewardEl.textContent = `+${pontos} pts`;
        rewardEl.style.background = 'rgba(16,185,129,0.15)';
        rewardEl.style.borderColor = 'rgba(16,185,129,0.3)';
        rewardEl.style.color = '#10b981';
      }
      
      // Registrar impress√£o
      sponsorImpressoes[sponsor.nome] = (sponsorImpressoes[sponsor.nome] || 0) + 1;
    }
    
    function esconderMiniBanner() {
      const banner = document.getElementById('sponsorMiniBanner');
      if (banner) banner.classList.remove('active');
      if (sponsorBannerInterval) {
        clearInterval(sponsorBannerInterval);
        sponsorBannerInterval = null;
      }
    }
    
    function clicarMiniBanner() {
      const sponsor = patrocinadoresJogo[sponsorBannerIndex % patrocinadoresJogo.length];
      if (!sponsor) return;
      
      // Mostrar popup completo desse sponsor
      mostrarPatrocinadorEspecifico(sponsor);
    }

    // ====== POPUP DE PATROCINADOR ======
    
    // Verificar se deve mostrar patrocinador (a cada 8 respostas)
    function verificarPatrocinador() {
      contadorRespostas++;
      
      // ‚úÖ Atualizar contador na interface
      const respostasEl = document.getElementById('respostasCount');
      if (respostasEl) respostasEl.textContent = contadorRespostas;
      
      // Salvar contador no usu√°rio
      db.collection("usuarios").doc(uid).update({
        [`contadorRespostas.${jogoId}`]: contadorRespostas
      }).catch(e => console.error("Erro ao salvar contador:", e));
      
      // A cada 8 respostas, mostrar patrocinador
      if (contadorRespostas % 8 === 0 && patrocinadoresJogo.length > 0) {
        setTimeout(() => mostrarPatrocinador(), 1500);
      }
    }
    
    // Mostrar patrocinador atual (popup c√≠clico)
    function mostrarPatrocinador() {
      if (patrocinadoresJogo.length === 0) return;
      const indexReal = patrocinadorAtualIndex % patrocinadoresJogo.length;
      const sponsor = patrocinadoresJogo[indexReal];
      mostrarPatrocinadorEspecifico(sponsor);
    }
    
    // Mostrar popup de um sponsor espec√≠fico
    function mostrarPatrocinadorEspecifico(sponsor) {
      if (!sponsor) return;
      patrocinadorPendente = sponsor;
      
      console.log(`üì¢ Mostrando patrocinador: ${sponsor.nome}`);
      
      // Remover popup anterior se existir
      const existingPopup = document.getElementById('sponsorPopup');
      if (existingPopup) existingPopup.remove();
      
      // Criar popup
      const popup = document.createElement('div');
      popup.className = 'sponsor-popup active';
      popup.id = 'sponsorPopup';
      
      // Logo pode ser emoji ou URL de imagem
      const logoDisplay = sponsor.logoUrl 
        ? `<img src="${sponsor.logoUrl}" alt="${sponsor.nome}" class="sponsor-logo-img">`
        : `<div class="sponsor-logo">${sponsor.logo || 'üéÅ'}</div>`;
      
      // Usar campo 'pontos' se existir, sen√£o usa 'creditos' como fallback
      const pontosPatrocinador = sponsor.pontos || sponsor.creditos || 10;
      const jaResgatou = sponsorsResgatados.has(sponsor.nome);
      
      const rewardHtml = jaResgatou
        ? `<div class="sponsor-reward" style="background:rgba(127,140,141,0.1);border-color:rgba(127,140,141,0.3);color:#7f8c8d;">
            ‚úÖ Pontos j√° resgatados nesta partida
          </div>`
        : `<div class="sponsor-reward">
            üèÜ Visite o site e ganhe <strong>+${pontosPatrocinador}</strong> ponto${pontosPatrocinador > 1 ? 's' : ''} na partida!
          </div>`;
      
      const btnHtml = jaResgatou
        ? `<button class="sponsor-btn" onclick="resgatarPatrocinador()">
            üåê Visitar Novamente
          </button>`
        : `<button class="sponsor-btn" onclick="resgatarPatrocinador()">
            üåê Visitar e Ganhar Pontos
          </button>`;
      
      popup.innerHTML = `
        <div class="sponsor-header">üì¢ Patrocinador da Partida</div>
        ${logoDisplay}
        <div class="sponsor-name">${sponsor.nome}</div>
        ${sponsor.descricao ? `<div class="sponsor-desc">${sponsor.descricao}</div>` : ''}
        ${rewardHtml}
        ${btnHtml}
        <button class="sponsor-skip" onclick="fecharPatrocinador()">
          Fechar
        </button>
        <div class="sponsor-timer">
          <span id="sponsorCountdown">15</span>s para fechar automaticamente
        </div>
      `;
      document.body.appendChild(popup);
      
      // Countdown visual
      let countdown = 15;
      const countdownEl = document.getElementById('sponsorCountdown');
      const countdownInterval = setInterval(() => {
        countdown--;
        if (countdownEl) countdownEl.textContent = countdown;
        if (countdown <= 0) clearInterval(countdownInterval);
      }, 1000);

      // Auto-fechar ap√≥s 15 segundos
      sponsorTimeout = setTimeout(() => {
        fecharPatrocinador();
        clearInterval(countdownInterval);
      }, 15000);
    }
    
    // Resgatar patrocinador (abre site + d√° PONTOS na partida)
    async function resgatarPatrocinador() {
      if (!patrocinadorPendente) return;
      
      const sponsor = patrocinadorPendente;
      const pontosGanhos = sponsor.pontos || sponsor.creditos || 10;
      
      // ‚úÖ ANTI-SPAM: Verificar se j√° resgatou este sponsor neste jogo
      if (sponsorsResgatados.has(sponsor.nome)) {
        // Abrir site mas N√ÉO dar pontos novamente
        if (sponsor.url) window.open(sponsor.url, '_blank');
        showToast(`üåê Visitando ${sponsor.nome} (pontos j√° resgatados)`);
        fecharPatrocinador(true);
        return;
      }
      
      try {
        // Abrir site do patrocinador em nova aba
        if (sponsor.url) {
          window.open(sponsor.url, '_blank');
        }
        
        // ‚úÖ Marcar como resgatado ANTES de dar pontos
        sponsorsResgatados.add(sponsor.nome);
        
        // ‚úÖ DAR PONTOS NA PARTIDA (n√£o cr√©ditos)
        await db.collection('usuarios').doc(uid).update({
          // Pontos na partida
          [`pontuacoes.${jogoId}`]: firebase.firestore.FieldValue.increment(pontosGanhos),
          // XP global
          xp: firebase.firestore.FieldValue.increment(pontosGanhos),
          // Salvar hist√≥rico de patrocinadores resgatados
          [`patrocinadoresResgatados.${jogoId}`]: firebase.firestore.FieldValue.arrayUnion({
            nome: sponsor.nome,
            pontos: pontosGanhos,
            timestamp: new Date().toISOString()
          }),
          // Avan√ßar para pr√≥ximo patrocinador
          [`patrocinadorIndex.${jogoId}`]: (patrocinadorAtualIndex + 1) % patrocinadoresJogo.length
        });
        
        // ‚úÖ ATUALIZAR SUBCOLE√á√ÉO DE PARTICIPANTES
        const participanteRef = db.collection("jogos").doc(jogoId)
          .collection("participantes").doc(uid);
        
        const participanteDoc = await participanteRef.get();
        if (participanteDoc.exists) {
          await participanteRef.update({
            pontos: firebase.firestore.FieldValue.increment(pontosGanhos),
            atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        // Avan√ßar √≠ndice local
        patrocinadorAtualIndex = (patrocinadorAtualIndex + 1) % patrocinadoresJogo.length;
        
        showToast(`üèÜ +${pontosGanhos} ponto${pontosGanhos > 1 ? 's' : ''} de ${sponsor.nome}!`);
        fecharPatrocinador(true); // true = j√° incrementou, n√£o incrementar novamente
        
        // ‚úÖ ATUALIZAR RANKING E STATS
        await updateStats();
        await loadRanking();
        
      } catch (e) {
        console.error("Erro ao resgatar patrocinador:", e);
        showToast("‚ùå Erro ao resgatar. Tente novamente!");
      }
    }

    function fecharPatrocinador(jaIncrementou = false) {
      if (sponsorTimeout) {
        clearTimeout(sponsorTimeout);
        sponsorTimeout = null;
      }
      const popup = document.getElementById('sponsorPopup');
      if (popup) popup.remove();
      patrocinadorPendente = null;
      
      // S√≥ avan√ßa se N√ÉO foi incrementado antes (ex: ao pular ou timeout)
      if (!jaIncrementou) {
        const antigoIndex = patrocinadorAtualIndex;
        patrocinadorAtualIndex = (patrocinadorAtualIndex + 1) % Math.max(1, patrocinadoresJogo.length);
        
        console.log(`üì¢ fecharPatrocinador() - √çndice: ${antigoIndex} ‚Üí ${patrocinadorAtualIndex} (total: ${patrocinadoresJogo.length})`);
        
        // Salvar √≠ndice
        db.collection("usuarios").doc(uid).update({
          [`patrocinadorIndex.${jogoId}`]: patrocinadorAtualIndex
        }).catch(e => console.error("Erro ao salvar √≠ndice:", e));
      } else {
        console.log(`üì¢ fecharPatrocinador() - √çndice j√° foi incrementado, n√£o incrementa novamente`);
      }
    }
    
    // ===================================
    // üî¢ COUNTER ANIMATION (n√∫meros animados)
    // ===================================
    function animateValue(el, newVal) {
      if (!el) return;
      const oldVal = parseInt(el.textContent) || 0;
      const numNew = parseInt(newVal) || 0;
      if (oldVal === numNew) return;
      
      // Adicionar classe de pop
      el.classList.remove('changed');
      void el.offsetWidth; // Force reflow
      el.classList.add('changed');
      
      // Animar contagem
      const duration = 400;
      const start = performance.now();
      const diff = numNew - oldVal;
      
      function tick(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        // Ease out
        const eased = 1 - Math.pow(1 - progress, 3);
        el.textContent = Math.round(oldVal + diff * eased);
        if (progress < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    // ===================================
    // üî¥ LIVE BADGE (status do jogo)
    // ===================================
    function atualizarLiveBadge() {
      const badge = document.getElementById('liveBadge');
      if (!badge) return;
      
      badge.className = 'live-badge';
      if (jogoStatus === 'ao_vivo') {
        badge.classList.add('ao-vivo');
        badge.innerHTML = '<span class="live-dot"></span> AO VIVO';
      } else if (jogoStatus === 'pre_jogo' || jogoStatus === 'agendado') {
        badge.classList.add('pre-jogo');
        badge.innerHTML = '‚è≥ PR√â-JOGO';
      } else if (jogoStatus === 'finalizado') {
        badge.classList.add('finalizado');
        badge.innerHTML = 'üèÅ ENCERRADO';
      }
    }

    // ===================================
    // üë• ONLINE COUNTER (torcedores ao vivo)
    // ===================================
    let onlineListener = null;
    
    function initOnlineCounter() {
      if (onlineListener) onlineListener();
      
      onlineListener = db.collection('jogos').doc(jogoId)
        .collection('participantes')
        .onSnapshot(snapshot => {
          const total = snapshot.size;
          const el = document.getElementById('onlineCount');
          if (el) animateValue(el, total);
        }, err => {
          console.error('Erro online counter:', err);
        });
    }

    // ===================================
    // üìä MINI STATS PESSOAL
    // ===================================
    let myStreakMaxVal = 0;
    
    function atualizarMyStats() {
      // Posi√ß√£o no ranking
      const rankItems = document.querySelectorAll('.ranking-item');
      let myPos = '--';
      rankItems.forEach((item, idx) => {
        if (item.classList.contains('is-me')) {
          myPos = idx + 1;
        }
      });
      
      const posEl = document.getElementById('myRankPos');
      if (posEl) posEl.textContent = myPos;
      
      // Pontos
      const pontosEl = document.getElementById('myPontos');
      if (pontosEl) {
        const userPontos = document.querySelector('.ranking-item.is-me .ranking-points');
        if (userPontos) {
          animateValue(pontosEl, parseInt(userPontos.textContent) || 0);
        }
      }
      
      // Acertos/Erros
      const acertosEl = document.getElementById('myAcertos');
      const errosEl = document.getElementById('myErros');
      if (acertosEl) acertosEl.textContent = totalAcertos || 0;
      if (errosEl) errosEl.textContent = totalErros || 0;
      
      // Streak m√°ximo
      const currentStreak = parseInt(document.getElementById('streakCount')?.textContent) || 0;
      if (currentStreak > myStreakMaxVal) myStreakMaxVal = currentStreak;
      const streakEl = document.getElementById('myStreakMax');
      if (streakEl) streakEl.textContent = myStreakMaxVal;
      
      // Share contextual
      atualizarShareContextual(myPos);
    }

    // ===================================
    // üí¨ CHAT BADGES (mensagens n√£o lidas)
    // ===================================
    let chatActiveTab = 'team';
    let teamMsgCount = 0;
    let generalMsgCount = 0;
    let teamUnread = 0;
    let generalUnread = 0;
    
    function atualizarChatBadge(type, newCount) {
      if (type === 'team') {
        const diff = newCount - teamMsgCount;
        teamMsgCount = newCount;
        if (chatActiveTab !== 'team' && diff > 0) {
          teamUnread += diff;
          mostrarBadge('teamChatBadge', teamUnread);
        }
      } else {
        const diff = newCount - generalMsgCount;
        generalMsgCount = newCount;
        if (chatActiveTab !== 'general' && diff > 0) {
          generalUnread += diff;
          mostrarBadge('generalChatBadge', generalUnread);
        }
      }
    }
    
    function mostrarBadge(id, count) {
      const el = document.getElementById(id);
      if (!el) return;
      if (count > 0) {
        el.textContent = count > 99 ? '99+' : count;
        el.style.display = 'flex';
      } else {
        el.style.display = 'none';
      }
    }
    
    function limparBadge(type) {
      if (type === 'team') {
        teamUnread = 0;
        mostrarBadge('teamChatBadge', 0);
      } else {
        generalUnread = 0;
        mostrarBadge('generalChatBadge', 0);
      }
    }

    // ===================================
    // üì£ SHARE CONTEXTUAL
    // ===================================
    function atualizarShareContextual(posicao) {
      const shareText = document.getElementById('shareBarText');
      if (!shareText) return;
      
      const teamAName = document.getElementById('teamAName')?.textContent?.trim() || 'Time A';
      const teamBName = document.getElementById('teamBName')?.textContent?.trim() || 'Time B';
      
      if (posicao && posicao !== '--' && posicao <= 3) {
        shareText.textContent = `üèÜ Estou em ${posicao}¬∫ em ${teamAName} √ó ${teamBName}!`;
      } else if (posicao && posicao !== '--') {
        shareText.textContent = `‚öΩ Jogando ${teamAName} √ó ${teamBName}! Entra a√≠:`;
      } else {
        shareText.textContent = 'üì£ Convide amigos:';
      }
    }

    // ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    // ‚ïë  üî• SISTEMA VICIANTE ‚Äî SONS + CELEBRA√á√ïES   ‚ïë
    // ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    // ===================================
    // üîä SOUND SYSTEM (Web Audio API ‚Äî sem arquivos)
    // ===================================
    const SoundFX = {
      ctx: null,
      enabled: true,
      
      _getCtx() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
        return this.ctx;
      },
      
      // Ding suave ‚Äî acerto
      acerto() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.1);
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.3);
        } catch(e) {}
      },
      
      // Buzzer suave ‚Äî erro
      erro() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(220, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(120, ctx.currentTime + 0.25);
          gain.gain.setValueAtTime(0.08, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.3);
        } catch(e) {}
      },
      
      // Streak ding (mais agudo)
      streak() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          [0, 0.08, 0.16].forEach((delay, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880 + i * 220, ctx.currentTime + delay);
            gain.gain.setValueAtTime(0.12, ctx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + 0.15);
            osc.start(ctx.currentTime + delay);
            osc.stop(ctx.currentTime + delay + 0.15);
          });
        } catch(e) {}
      },
      
      // Crowd roar ‚Äî streak 5+
      crowd() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          // White noise burst = crowd
          const bufferSize = ctx.sampleRate * 0.8;
          const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
          const data = buffer.getChannelData(0);
          for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
          }
          const noise = ctx.createBufferSource();
          noise.buffer = buffer;
          const bandpass = ctx.createBiquadFilter();
          bandpass.type = 'bandpass';
          bandpass.frequency.value = 800;
          bandpass.Q.value = 0.5;
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
          noise.connect(bandpass); bandpass.connect(gain); gain.connect(ctx.destination);
          noise.start(ctx.currentTime);
          // Plus ascending chord
          [523, 659, 784, 1047].forEach((freq, i) => {
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            g.gain.setValueAtTime(0, ctx.currentTime + i * 0.06);
            g.gain.linearRampToValueAtTime(0.08, ctx.currentTime + i * 0.06 + 0.05);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
            osc.start(ctx.currentTime + i * 0.06);
            osc.stop(ctx.currentTime + 0.6);
          });
        } catch(e) {}
      },
      
      // Whoosh ‚Äî subiu no ranking
      whoosh() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(300, ctx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.2);
          gain.gain.setValueAtTime(0.1, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.25);
        } catch(e) {}
      },
      

      momentumUp() {
        if (!this.enabled) return;
        try { const ctx=this._getCtx(); [440,554,659,880,1108].forEach((f,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);
          o.type='sine';o.frequency.setValueAtTime(f,ctx.currentTime+i*0.08);
          g.gain.setValueAtTime(0.12,ctx.currentTime+i*0.08);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.08+0.2);
          o.start(ctx.currentTime+i*0.08);o.stop(ctx.currentTime+i*0.08+0.2);
        }); } catch(e){}
      },
      momentumPlus() {
        if (!this.enabled) return;
        try { const ctx=this._getCtx(),o=ctx.createOscillator(),g=ctx.createGain();
          o.connect(g);g.connect(ctx.destination);o.type='sine';
          o.frequency.setValueAtTime(1200,ctx.currentTime);o.frequency.exponentialRampToValueAtTime(1800,ctx.currentTime+0.1);
          g.gain.setValueAtTime(0.1,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.2);
          o.start(ctx.currentTime);o.stop(ctx.currentTime+0.2);
        } catch(e){}
      },
      momentumBreak() {
        if (!this.enabled) return;
        try { const ctx=this._getCtx(); [660,440,330,220].forEach((f,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();o.connect(g);g.connect(ctx.destination);
          o.type='sawtooth';o.frequency.setValueAtTime(f,ctx.currentTime+i*0.12);
          g.gain.setValueAtTime(0.06,ctx.currentTime+i*0.12);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+i*0.12+0.2);
          o.start(ctx.currentTime+i*0.12);o.stop(ctx.currentTime+i*0.12+0.2);
        }); if(navigator.vibrate)navigator.vibrate([100,50,100]); } catch(e){}
      },
      // Tick ‚Äî timer countdown
      tick() {
        if (!this.enabled) return;
        try {
          const ctx = this._getCtx();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.value = 1000;
          gain.gain.setValueAtTime(0.05, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.05);
        } catch(e) {}
      }
    };

    // ===================================
    // üéâ CONFETTI SYSTEM
    // ===================================
    const Confetti = {
      canvas: null,
      ctx: null,
      particles: [],
      running: false,
      
      init() {
        this.canvas = document.getElementById('confettiCanvas');
        if (!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
      },
      
      resize() {
        if (!this.canvas) return;
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      },
      
      launch(count = 60, duration = 2500) {
        if (!this.canvas) this.init();
        if (!this.ctx) return;
        
        const colors = ['#ff6432', '#ffb547', '#10b981', '#a78bfa', '#ef4444', '#3b82f6', '#ffd700'];
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: Math.random() * this.canvas.width,
            y: -20 - Math.random() * 100,
            w: 6 + Math.random() * 6,
            h: 4 + Math.random() * 4,
            color: colors[Math.floor(Math.random() * colors.length)],
            vx: (Math.random() - 0.5) * 4,
            vy: 2 + Math.random() * 4,
            rot: Math.random() * 360,
            rotSpeed: (Math.random() - 0.5) * 10,
            life: duration
          });
        }
        
        if (!this.running) {
          this.running = true;
          this._animate();
        }
      },
      
      _animate() {
        if (this.particles.length === 0) {
          this.running = false;
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          return;
        }
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.particles = this.particles.filter(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.1;
          p.rot += p.rotSpeed;
          p.life -= 16;
          
          const alpha = Math.max(0, p.life / 2500);
          
          this.ctx.save();
          this.ctx.translate(p.x, p.y);
          this.ctx.rotate(p.rot * Math.PI / 180);
          this.ctx.globalAlpha = alpha;
          this.ctx.fillStyle = p.color;
          this.ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          this.ctx.restore();
          
          return p.life > 0 && p.y < this.canvas.height + 50;
        });
        
        requestAnimationFrame(() => this._animate());
      }
    };

    // ===================================
    // üéä CELEBRATION SYSTEM
    // ===================================
    const Celebrations = {
      // Mostrar texto grande animado + confetti
      show(text, color = '#ffb547', confettiCount = 60) {
        const overlay = document.createElement('div');
        overlay.className = 'celebration-overlay';
        overlay.innerHTML = `<div class="celebration-text" style="color:${color}">${text}</div>`;
        document.body.appendChild(overlay);
        
        Confetti.launch(confettiCount);
        
        setTimeout(() => {
          overlay.querySelector('.celebration-text').style.animation = 'celebrationOut 0.5s ease forwards';
          setTimeout(() => overlay.remove(), 500);
        }, 2000);
      },
      
      // Acerto normal ‚Äî moedas voando
      acertoNormal(pontos) {
        SoundFX.acerto();
      },
      
      // Streak 3 ‚Äî TRINCA!
      streak3() {
        SoundFX.streak();
        this.show('üî• TRINCA!', '#ff6432', 30);
      },
      
      // Streak 5 ‚Äî IMPAR√ÅVEL!
      streak5() {
        SoundFX.crowd();
        this.show('üî•üî•üî• IMPAR√ÅVEL!', '#ff4500', 80);
      },
      
      // Streak 7 ‚Äî LEND√ÅRIO!
      streak7() {
        SoundFX.crowd();
        this.show('‚≠ê LEND√ÅRIO! ‚≠ê', '#ffd700', 120);
      },
      
      // Streak 10 ‚Äî DIVINO!
      streak10() {
        SoundFX.crowd();
        this.show('üëë DIVINO! üëë', '#ffd700', 150);
      },
      
      // Ultrapassou algu√©m no ranking
      overtake(nome, newPos) {
        SoundFX.whoosh();
        const toast = document.createElement('div');
        toast.className = 'overtake-toast';
        toast.innerHTML = `üöÄ Voc√™ passou <strong>${nome}</strong>! Agora √© <strong>#${newPos}</strong>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      },
      
      // Erro
      erroFeedback() {
        SoundFX.erro();
      }
    };

    // ===================================
    // üéØ MICRO-METAS (desafios rotativos)
    // ===================================
    const MICRO_METAS = [
      { id: 'streak3', titulo: 'üî• TRINCA', desc: 'Acerte 3 em sequ√™ncia', alvo: 3, tipo: 'streak', xp: 25 },
      { id: 'streak5', titulo: 'üî• PENTA', desc: 'Acerte 5 em sequ√™ncia', alvo: 5, tipo: 'streak', xp: 50 },
      { id: 'rapido2', titulo: '‚ö° REL√ÇMPAGO', desc: 'Responda 2 em menos de 3s', alvo: 2, tipo: 'rapido', xp: 30 },
      { id: 'sem_erro3', titulo: 'üéØ PRECISO', desc: 'Acerte 3 seguidas sem errar', alvo: 3, tipo: 'sem_erro', xp: 20 },
      { id: 'total5', titulo: 'üí™ GUERREIRO', desc: 'Responda 5 perguntas', alvo: 5, tipo: 'total', xp: 15 },
      { id: 'total10', titulo: 'üèÜ MARATONISTA', desc: 'Responda 10 perguntas', alvo: 10, tipo: 'total', xp: 30 },
    ];

    let microMetaAtual = null;
    let microMetaProgresso = 0;
    let microMetasCompletadas = new Set();
    let rapidasConsecutivas = 0;

    function selecionarMicroMeta() {
      const disponiveis = MICRO_METAS.filter(m => !microMetasCompletadas.has(m.id));
      if (disponiveis.length === 0) {
        microMetasCompletadas.clear(); // Reset e recome√ßa
        return selecionarMicroMeta();
      }
      microMetaAtual = disponiveis[Math.floor(Math.random() * disponiveis.length)];
      microMetaProgresso = 0;
      renderMicroMeta();
    }

    function renderMicroMeta() {
      const el = document.getElementById('microMeta');
      if (!el || !microMetaAtual) return;
      
      el.classList.add('active');
      document.getElementById('microMetaTitle').textContent = microMetaAtual.titulo;
      document.getElementById('microMetaReward').textContent = `+${microMetaAtual.xp} XP`;
      document.getElementById('microMetaDesc').textContent = microMetaAtual.desc;
      
      const pct = Math.min(100, (microMetaProgresso / microMetaAtual.alvo) * 100);
      document.getElementById('microMetaFill').style.width = pct + '%';
      document.getElementById('microMetaCount').textContent = `${microMetaProgresso}/${microMetaAtual.alvo}`;
    }

    function atualizarMicroMeta(acertou, tempoResposta) {
      if (!microMetaAtual) {
        selecionarMicroMeta();
        return;
      }
      
      const meta = microMetaAtual;
      
      switch (meta.tipo) {
        case 'streak':
          microMetaProgresso = parseInt(document.getElementById('streakCount')?.textContent) || 0;
          break;
        case 'rapido':
          if (acertou && tempoResposta && tempoResposta < 3) {
            rapidasConsecutivas++;
            microMetaProgresso = rapidasConsecutivas;
          } else {
            rapidasConsecutivas = 0;
            microMetaProgresso = 0;
          }
          break;
        case 'sem_erro':
          if (acertou) {
            microMetaProgresso++;
          } else {
            microMetaProgresso = 0;
          }
          break;
        case 'total':
          microMetaProgresso = (totalAcertos || 0) + (totalErros || 0);
          break;
      }
      
      renderMicroMeta();
      
      // Completou?
      if (microMetaProgresso >= meta.alvo) {
        completarMicroMeta();
      }
    }

    function completarMicroMeta() {
      if (!microMetaAtual) return;
      
      const meta = microMetaAtual;
      microMetasCompletadas.add(meta.id);
      
      // Dar XP
      try {
        db.collection('usuarios').doc(uid).update({
          xp: firebase.firestore.FieldValue.increment(meta.xp)
        });
      } catch(e) {}
      
      showToast(`üéØ DESAFIO COMPLETO: ${meta.titulo}! +${meta.xp} XP`);
      SoundFX.streak();
      
      // Selecionar pr√≥xima meta ap√≥s delay
      setTimeout(() => selecionarMicroMeta(), 3000);
    }

    // ===================================
    // üìä COMPETITIVE PROGRESS BAR
    // ===================================
    let prevRankPosition = null;
    
    function atualizarCompetitiveBar() {
      const bar = document.getElementById('competitiveBar');
      if (!bar) return;
      
      const rankItems = document.querySelectorAll('.ranking-item');
      let myIdx = -1;
      let myPts = 0;
      
      rankItems.forEach((item, idx) => {
        if (item.classList.contains('is-me')) {
          myIdx = idx;
          myPts = parseInt(item.querySelector('.ranking-points')?.textContent) || 0;
        }
      });
      
      if (myIdx <= 0) {
        // J√° √© #1 ou n√£o encontrou
        if (myIdx === 0) {
          document.getElementById('competitiveText').innerHTML = 'üëë Voc√™ <strong>lidera</strong> a partida!';
          document.getElementById('competitiveFill').style.width = '100%';
          bar.classList.add('active');
        } else {
          bar.classList.remove('active');
        }
        return;
      }
      
      // Pegar quem est√° acima
      const acima = rankItems[myIdx - 1];
      const acimaPts = parseInt(acima?.querySelector('.ranking-points')?.textContent) || 0;
      const acimaNome = acima?.querySelector('.ranking-name')?.textContent?.trim() || `#${myIdx}`;
      const diff = acimaPts - myPts;
      
      if (diff <= 0) {
        document.getElementById('competitiveText').innerHTML = `üî• Empatado com <strong>${acimaNome}</strong>! Pr√≥xima resposta decide!`;
        document.getElementById('competitiveFill').style.width = '95%';
      } else {
        document.getElementById('competitiveText').innerHTML = `Faltam <strong>${diff} pt${diff > 1 ? 's' : ''}</strong> para ultrapassar <strong>#${myIdx} ${acimaNome}</strong>!`;
        // Quanto mais perto, mais cheia
        const pct = Math.max(10, Math.min(95, 100 - (diff / Math.max(1, acimaPts)) * 100));
        document.getElementById('competitiveFill').style.width = pct + '%';
      }
      
      bar.classList.add('active');
      
      // Detectar ultrapassagem
      const newPos = myIdx + 1;
      if (prevRankPosition && newPos < prevRankPosition) {
        // Ultrapassou algu√©m!
        const ultrapassado = rankItems[myIdx + 1];
        const ultrapassadoNome = ultrapassado?.querySelector('.ranking-name')?.textContent?.trim() || '';
        if (ultrapassadoNome) {
          Celebrations.overtake(ultrapassadoNome, newPos);
        }
      }
      prevRankPosition = newPos;
    }

    // ===================================
    // üî• STREAK PROGRESS DOTS
    // ===================================
    const STREAK_MILESTONES = [
      { at: 3, nome: 'TRINCA', multi: 2 },
      { at: 5, nome: 'PENTA', multi: 3 },
      { at: 7, nome: 'MONSTRO', multi: 4 },
      { at: 10, nome: 'DIVINO', multi: 5 },
    ];
    
    function atualizarStreakProgress() {
      const container = document.getElementById('streakProgress');
      const dotsEl = document.getElementById('streakProgressDots');
      const textEl = document.getElementById('streakProgressText');
      if (!container || !dotsEl || !textEl) return;
      
      const currentStreak = parseInt(document.getElementById('streakCount')?.textContent) || 0;
      
      // Encontrar pr√≥ximo milestone
      let nextMilestone = STREAK_MILESTONES.find(m => currentStreak < m.at);
      
      if (!nextMilestone) {
        container.classList.add('active');
        textEl.textContent = 'üëë MODO DIVINO ATIVO!';
        dotsEl.innerHTML = '';
        return;
      }
      
      // Encontrar milestone anterior (ponto de partida)
      const prevMilestones = STREAK_MILESTONES.filter(m => m.at <= currentStreak);
      const startFrom = prevMilestones.length > 0 ? prevMilestones[prevMilestones.length - 1].at : 0;
      
      const total = nextMilestone.at - startFrom;
      const progress = currentStreak - startFrom;
      const faltam = nextMilestone.at - currentStreak;
      
      if (currentStreak === 0) {
        container.classList.remove('active');
        return;
      }
      
      container.classList.add('active');
      textEl.textContent = `Mais ${faltam} pra üî• ${nextMilestone.nome} (x${nextMilestone.multi})!`;
      
      let dotsHtml = '';
      for (let i = 0; i < total; i++) {
        const filled = i < progress;
        const isNext = i === progress;
        dotsHtml += `<div class="streak-dot ${filled ? 'filled' : ''} ${isNext ? 'next' : ''}"></div>`;
      }
      dotsEl.innerHTML = dotsHtml;
    }

    // ===================================
    // üé¨ INTEGRA√á√ÉO: Hook nas respostas
    // ===================================
    function onRespostaViciante(acertou, pontos, tempoResposta) {
      const currentStreak = parseInt(document.getElementById('streakCount')?.textContent) || 0;
      
      if (acertou) {
        Celebrations.acertoNormal(pontos);
        
        // Streak celebrations
        if (currentStreak === 3) Celebrations.streak3();
        else if (currentStreak === 5) Celebrations.streak5();
        else if (currentStreak === 7) Celebrations.streak7();
        else if (currentStreak >= 10 && currentStreak % 5 === 0) Celebrations.streak10();
      } else {
        Celebrations.erroFeedback();
      }
      
      // Atualizar streak progress dots
      atualizarStreakProgress();
      
      // Atualizar micro-meta
      atualizarMicroMeta(acertou, tempoResposta);
    }

    // Timer countdown sound (√∫ltimos 3 segundos)
    function onTimerTick(secondsLeft) {
      if (secondsLeft <= 3 && secondsLeft > 0) {
        SoundFX.tick();
      }
    }


    // ===================================
    // ‚ö° MOMENTUM v3 FUN√á√ïES
    // ===================================
    function calcularTimerMomentum() {
      const free = momentumState.tipoPasse === 'free';
      return Math.max(free?45:30, (free?120:60) - momentumState.timerAcertosConsecutivos*15);
    }

    function atualizarFaseIndicador() {
      const bar=document.getElementById('momentumPhaseBar');
      if(!bar) return;
      const text=document.getElementById('phaseText'), info=document.getElementById('phaseInfo'), fill=document.getElementById('phaseFill');
      bar.className='momentum-phase-bar';
      const icon = bar.querySelector('.phase-icon');

      if (momentumState.fase === 1) {
        bar.classList.add('fase-1');
        const r=Math.min(momentumState.totalRespondidas,5);
        if(icon)icon.textContent='üéØ'; text.textContent='AQUECIMENTO'; info.textContent=`${r}/5`;
        fill.style.width=`${(r/5)*100}%`;
        const s=bar.querySelector('.btn-skip-inline'); if(s)s.remove();
      } else if (momentumState.fase === 2) {
        bar.classList.add('fase-2');
        if(icon)icon.textContent='‚ö°'; text.textContent='MOMENTUM';
        // Mostrar cadeia (que SOBE) como info principal, saldo como secund√°rio
        const cadeia = momentumState.momentumBonus || 0;
        const disp = momentumState.perguntasRestantesFase;
        info.textContent=`üîó ${cadeia} na cadeia | ${disp} disp.`;
        fill.style.width=disp>0?'100%':'0%';
        const s=bar.querySelector('.btn-skip-inline'); if(s)s.remove();
      } else if (momentumState.fase === 3) {
        bar.classList.add('fase-3');
        if(icon)icon.textContent='‚è≥'; text.textContent='TIMER';
        const red=momentumState.timerAcertosConsecutivos*15;
        info.innerHTML=`${red>0?'-'+red+'s | ':''}<span id="phaseTimerCountdown">--:--</span>`;
        fill.style.width='0%';
        if(!bar.querySelector('.btn-skip-inline')){
          const b=document.createElement('button');b.className='btn-skip-inline';b.textContent='üíé Skip';b.onclick=adiantarPerguntas;bar.appendChild(b);
        }
      }
    }

    function mostrarMomentumFeedback(tipo, texto) {
      const o=document.getElementById('momentumOverlay'),c=document.getElementById('momentumOverlayContent');
      if(!o||!c)return;
      c.className='momentum-overlay-content '+tipo; c.textContent=texto; o.classList.add('active');
      setTimeout(()=>o.classList.remove('active'),1800);
    }

    function iniciarTimerMomentum() {
      if(momentumState.timerInterval){clearInterval(momentumState.timerInterval);momentumState.timerInterval=null;}
      const total=calcularTimerMomentum();
      let seg=total;
      const te=document.getElementById("cooldownTimer");
      if(te){te.classList.add('visible');te.style.display='';}
      const ba=document.getElementById("btnAdiantar");
      const cr=parseInt(document.getElementById("paidCredits")?.textContent)||0;
      if(ba&&cr>=1){ba.style.display='inline-block';ba.disabled=false;ba.textContent='üíé Skip (1 cr)';}

      momentumState.timerInterval=setInterval(()=>{
        seg--;
        const m=Math.floor(seg/60),s=seg%60,t=`${m}:${String(s).padStart(2,'0')}`;
        const ce=document.getElementById("cooldownContagem"); if(ce)ce.textContent=t;
        const pc=document.getElementById("phaseTimerCountdown"); if(pc)pc.textContent=t;
        const btn=document.getElementById("btnAnswer"); if(btn&&!currentQuestion)btn.textContent=`‚è≥ +1 em ${t}`;
        const fab=document.getElementById("fabBtn"); if(fab&&!currentQuestion)fab.innerHTML=`<span class="fab-icon">‚è≥</span><span class="fab-text">${t}</span>`;
        const fl=document.getElementById('phaseFill'); if(fl)fl.style.width=`${((total-seg)/total)*100}%`;
        if(seg<=3&&seg>0)SoundFX.tick();
        if(seg<=0){
          clearInterval(momentumState.timerInterval);momentumState.timerInterval=null;
          momentumState.perguntasRestantesFase=1;momentumState.lastServerUpdate=Date.now();
          if(te){te.classList.remove('visible');te.style.display='none';}
          atualizarMomentumBotao();
          showToast('üéØ +1 pergunta liberada!');
        }
      },1000);
    }

    // üì° LIVE FEED ‚Äî floating, 3 msgs, subtle
    function iniciarLiveFeed() {
      try {
        momentumState.liveFeedListener = db.collection('chats')
          .where('jogoId','==',jogoId).orderBy('timestamp','desc').limit(3)
          .onSnapshot(snap=>{
            snap.docChanges().forEach(ch=>{
              if(ch.type==='added'){
                const d=ch.doc.data(); if(d.uid===uid)return;
                adicionarLiveFeed('üí¨',(d.usuario||d.nome||'?')+': '+(d.texto||d.mensagem||''));
              }
            });
          });
      } catch(e){console.warn('Live feed error:',e);}
    }

    function adicionarLiveFeed(icon, texto) {
      const c=document.getElementById('liveFeedMessages'); if(!c)return;
      const m=document.createElement('div'); m.className='lf-msg'; m.textContent=`${icon} ${texto}`;
      c.insertBefore(m,c.firstChild);
      while(c.children.length>3)c.removeChild(c.lastChild);
      setTimeout(()=>{m.classList.add('fading');setTimeout(()=>{if(m.parentNode)m.remove();},500);},8000);
    }

    // üó≥Ô∏è ENQUETE FIXA
    const ENQUETES_FIXA_TEMPLATES=[
      {id:'clima',pergunta:'üó≥Ô∏è Como t√° seu clima?',opcoes:['üòé De boa','üò∞ Tenso','üî• Focado']},
      {id:'confianca_f',pergunta:'üó≥Ô∏è Confian√ßa no time?',opcoes:['üí™ Alta','üòê M√©dia','üò∞ Baixa']},
      {id:'gol',pergunta:'üó≥Ô∏è Vai ter gol?',opcoes:['‚öΩ Sim!','‚ùå N√£o','ü§û Tomara']},
      {id:'nota',pergunta:'üó≥Ô∏è Nota pro jogo?',opcoes:['‚≠ê 1-2','‚≠ê‚≠ê 3-4','‚≠ê‚≠ê‚≠ê 5']},
      {id:'momento',pergunta:'üó≥Ô∏è Rea√ß√£o agora?',opcoes:['üî•','üò°','üòÇ','ü§Ø']},
      {id:'tecnico',pergunta:'üó≥Ô∏è Substitui√ß√£o?',opcoes:['üîÑ Sim','‚úã N√£o']},
    ];
    function iniciarEnqueteFixa(){trocarEnqueteFixa();momentumState.enqueteFixaInterval=setInterval(trocarEnqueteFixa,180000);}
    function trocarEnqueteFixa(){
      const c=document.getElementById('enqueteFixa');if(!c)return;c.style.display='';
      const e=ENQUETES_FIXA_TEMPLATES[Math.floor(Math.random()*ENQUETES_FIXA_TEMPLATES.length)];
      momentumState.enqueteFixaAtual=e;momentumState.enqueteFixaVoto=null;
      document.getElementById('enqueteFixaTitulo').textContent=e.pergunta;
      document.getElementById('enqueteFixaOpcoes').innerHTML=e.opcoes.map((o,i)=>`
        <button class="enquete-fixa-btn" onclick="votarEnqueteFixa(${i})" data-idx="${i}">
          <div class="ef-bar" id="efBar_${i}" style="width:0%"></div><span class="ef-label">${o}</span>
        </button>`).join('');
      carregarVotosEnqueteFixa(e.id);
    }
    async function votarEnqueteFixa(idx){
      const e=momentumState.enqueteFixaAtual;if(!e)return;
      momentumState.enqueteFixaVoto=idx;
      document.querySelectorAll('.enquete-fixa-btn').forEach(b=>b.classList.remove('voted'));
      const b=document.querySelector(`.enquete-fixa-btn[data-idx="${idx}"]`);if(b)b.classList.add('voted');
      try{
        const ref=db.collection('jogos').doc(jogoId).collection('enqueteFixaVotos').doc(e.id);
        await db.runTransaction(async t=>{
          const d=await t.get(ref);const data=d.exists?d.data():{votos:new Array(e.opcoes.length).fill(0),votantes:{}};
          if(data.votantes&&data.votantes[uid]!=null)data.votos[data.votantes[uid]]=Math.max(0,(data.votos[data.votantes[uid]]||0)-1);
          data.votos[idx]=(data.votos[idx]||0)+1;data.votantes=data.votantes||{};data.votantes[uid]=idx;
          t.set(ref,data);
        });
        carregarVotosEnqueteFixa(e.id);
      }catch(err){console.error('Erro voto:',err);}
    }
    async function carregarVotosEnqueteFixa(eid){
      try{
        const d=await db.collection('jogos').doc(jogoId).collection('enqueteFixaVotos').doc(eid).get();
        if(!d.exists)return;const data=d.data();const v=data.votos||[];const tot=v.reduce((a,b)=>a+b,0)||1;
        v.forEach((val,i)=>{
          const p=Math.round((val/tot)*100);
          const bar=document.getElementById(`efBar_${i}`);if(bar)bar.style.width=`${p}%`;
          const lb=document.querySelector(`.enquete-fixa-btn[data-idx="${i}"] .ef-label`);
          if(lb){const e=momentumState.enqueteFixaAtual;lb.textContent=`${e?.opcoes?.[i]||''} ${p}%`;}
        });
        if(data.votantes&&data.votantes[uid]!=null){
          momentumState.enqueteFixaVoto=data.votantes[uid];
          document.querySelectorAll('.enquete-fixa-btn').forEach(b=>b.classList.remove('voted'));
          const b=document.querySelector(`.enquete-fixa-btn[data-idx="${data.votantes[uid]}"]`);if(b)b.classList.add('voted');
        }
      }catch(e){console.error('Erro carregar votos:',e);}
    }

    // üèÜ ALERTAS COMPETITIVOS
    function iniciarAlertasCompetitivos(){
      function f(){if(currentQuestion)return;const m=gerarMsgComp();if(m)mostrarAlertaComp(m);momentumState.alertaInterval=setTimeout(f,25000+Math.random()*10000);}
      momentumState.alertaInterval=setTimeout(f,30000);
    }
    function gerarMsgComp(){
      const p=minhaPosicaoAtual,cr=parseInt(document.getElementById("paidCredits")?.textContent)||0,ms=[];
      if(p&&p<=5)ms.push(`üèÜ Voc√™ est√° em #${p}!`);
      if(p&&p>1&&p<=10)ms.push(`‚¨ÜÔ∏è Falta pouco pro top 3!`);
      if(streak>=5)ms.push(`üî• Streak de ${streak}!`);
      if(momentumState.fase===2)ms.push(`‚ö° Momentum ativo!`);
      if(momentumState.fase===3&&momentumState.perguntasRestantesFase<=0){
        ms.push(`üìä Outros est√£o respondendo!`);
        if(cr>0)ms.push(`üíé ${cr} cr√©ditos! 1 cr = 1 pergunta`);
      }
      // Rivalidade dos times nas barras de for√ßa
      const meuTimePerdeCmp = (timeTorcida===timeCasaId && forceState.prevPontosFora>forceState.prevPontosCasa+3)
        ||(timeTorcida===timeForaId && forceState.prevPontosCasa>forceState.prevPontosFora+3);
      if(meuTimePerdeCmp) ms.push(`üò§ Seu time est√° atr√°s na pontua√ß√£o! Empurre a barra!`);
      const meuTimeGanhaCmp = (timeTorcida===timeCasaId && forceState.prevPontosCasa>forceState.prevPontosFora+3)
        ||(timeTorcida===timeForaId && forceState.prevPontosFora>forceState.prevPontosCasa+3);
      if(meuTimeGanhaCmp) ms.push(`üî• Seu time lidera! N√£o deixe virar!`);
      ms.push(`üéØ Cada acerto conta!`);
      return ms[Math.floor(Math.random()*ms.length)];
    }
    function mostrarAlertaComp(msg){
      const e=document.getElementById('alertaCompetitivo');
      if(!e||e.classList.contains('show')||currentQuestion)return;
      e.textContent=msg;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),4000);
    }

    function mostrarForceLeadAlert(msg, teamClass) {
      const el = document.getElementById('forceLeadAlert');
      if (!el) return;
      el.className = 'force-lead-alert ' + teamClass;
      el.textContent = msg;
      el.classList.add('show');
      SoundFX.whoosh();
      setTimeout(() => el.classList.remove('show'), 4000);
    }

    function atualizarMomentumUI(){
      atualizarFaseIndicador();
      const r=document.getElementById('respostasCount');if(r)r.textContent=momentumState.totalRespondidas;
    }

    // Init viciante systems
    function initVicianteSystems() {
      Confetti.init(); selecionarMicroMeta();
      iniciarLiveFeed(); iniciarEnqueteFixa(); iniciarAlertasCompetitivos(); atualizarFaseIndicador();
      console.log('üî• Momentum v3 inicializado');
    }

    // ‚úÖ FUN√á√ÉO TOAST - Mensagens tempor√°rias
    function showToast(message, duration = 3000) {
      // Remover toast anterior se existir
      const existingToast = document.getElementById('toastNotification');
      if (existingToast) existingToast.remove();
      
      const toast = document.createElement('div');
      toast.id = 'toastNotification';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
        color: var(--text-primary);
        padding: 15px 25px;
        border-radius: 12px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,181,71,0.3);
        animation: toastSlideUp 0.3s ease;
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'toastSlideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ‚úÖ FUN√á√ÉO COMPARTILHAR WHATSAPP COM C√ìDIGO DE INDICA√á√ÉO
    function compartilharWhatsApp() {
      const jogoInfo = document.getElementById('matchTitle')?.textContent || 'uma partida incr√≠vel';
      const urlJogo = window.location.href;
      
      // Pegar apelido do usu√°rio para link de indica√ß√£o
      let linkIndicacao = '';
      if (cachedUserData) {
        const meuApelido = cachedUserData.usuarioUnico || cachedUserData.usuario;
        if (meuApelido) {
          linkIndicacao = `${window.location.origin}/usuarios/cadastro.html?ref=${meuApelido}`;
          console.log("üîó Link de indica√ß√£o:", linkIndicacao);
        }
      }
      
      let texto;
      if (linkIndicacao) {
        texto = `üéÆ Vem jogar comigo no Yellup!\n\n‚öΩ ${jogoInfo}\n\nüÜï Ainda n√£o tem conta? Cadastre-se e ganhe 20 cr√©ditos:\nüëâ ${linkIndicacao}\n\n‚úÖ J√° tem conta? Entre direto no jogo:\nüëâ ${urlJogo}`;
      } else {
        texto = `üéÆ Vem jogar comigo no Yellup!\n\n‚öΩ ${jogoInfo}\n\nResponda perguntas sobre futebol e ganhe pr√™mios!\n\nüëâ ${urlJogo}`;
      }
      
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(texto)}`;
      window.open(whatsappUrl, '_blank');
    }

    // ========== OVERLAY LIMITE DI√ÅRIO (para free sem partidas) ==========

    function mostrarOverlayLimiteAtingido() {
      const existente = document.getElementById('semCreditosOverlay');
      if (existente) existente.remove();

      const overlay = document.createElement('div');
      overlay.className = 'sem-creditos-overlay';
      overlay.id = 'semCreditosOverlay';
      overlay.innerHTML = `
        <div class="sem-creditos-card">
          <div class="sem-creditos-emoji">üé´</div>
          <div class="sem-creditos-titulo">Limite Di√°rio Atingido!</div>
          <div class="sem-creditos-msg">
            Voc√™ usou suas 2 partidas gratuitas de hoje.<br>
            Com um Passe, jogue <strong>ilimitado</strong> todos os dias!
          </div>
          <div class="sem-creditos-timer">
            <div class="sem-creditos-timer-label">Planos a partir de</div>
            <div class="sem-creditos-timer-valor" style="color: #a78bfa;">R$ 9,90/semana</div>
            <div class="sem-creditos-timer-hint">Partidas e PvP ilimitados + Timer reduzido + Mais cr√©ditos</div>
          </div>
          <button class="btn-comprar-creditos" onclick="window.location.href='loja-passes.html'">
            üé´ Ver Passes
          </button>
          <button class="btn-fechar-overlay" onclick="document.getElementById('semCreditosOverlay').remove()">
            Voltar ao jogo
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    // ========== DRIP TIMER (removido - substitu√≠do pelo sistema de cooldown) ==========
    // O cooldown √© gerenciado por updateFreePlays() e atualizarCooldownTimer()

    // ========== TOAST DE CR√âDITO B√îNUS ==========
    function mostrarBonusToast(creditosGanhos = 1) {
      const toast = document.createElement('div');
      toast.className = 'bonus-toast';
      toast.innerHTML = `üéÅ +${creditosGanhos} Cr√©dito B√¥nus!<small>Continue jogando e disputando pr√™mios!</small>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4500);
      updateFreePlays();
    }

    // ========== LOJA REDIRECIONADA PARA PASSES ==========
    function abrirMiniLoja() {
      window.location.href = 'loja-passes.html';
    }

    console.log("‚úÖ Yellup Game v10.1 - Passes Only + Adiantar 5cr!");

  </script>

  <!-- üéâ CONFETTI CANVAS -->
  <canvas id="confettiCanvas"></canvas>

  <!-- Barra de Compartilhamento -->
  <div class="share-bar">
    <span class="share-bar-text" id="shareBarText">üì£ Convide amigos:</span>
    <a href="#" class="share-btn share-btn-whatsapp" onclick="compartilharWhatsApp()" title="Convidar pelo WhatsApp">
      <span class="share-btn-icon">üì±</span>
      <span>WhatsApp</span>
    </a>
    <a href="https://instagram.com/yellup.app" target="_blank" class="share-btn share-btn-instagram" title="Seguir no Instagram">
      <span class="share-btn-icon">üì∏</span>
      <span>@yellup.app</span>
    </a>
  </div>

</body>
</html>
