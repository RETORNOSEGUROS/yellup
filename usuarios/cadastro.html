<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cadastro - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Yellup">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container { width: 100%; max-width: 500px; }
    .logo { text-align: center; margin-bottom: 10px; }
    .logo img {
      max-width: 220px; height: auto; display: inline-block;
      filter: drop-shadow(0 4px 15px rgba(255,181,71,0.3));
    }
    .subtitle { text-align: center; color: #a9b5c6; margin-bottom: 30px; }

    /* Badge indica√ß√£o */
    .referral-badge {
      background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(39,174,96,0.1));
      border: 2px solid #2ecc71; border-radius: 15px;
      padding: 15px 20px; margin-bottom: 25px; text-align: center;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(46,204,113,0.4); }
      50% { box-shadow: 0 0 0 10px rgba(46,204,113,0); }
    }
    .referral-badge .icon { font-size: 1.5em; margin-bottom: 5px; }
    .referral-badge .text { color: #2ecc71; font-weight: 600; }
    .referral-badge .name { color: #fff; font-weight: 700; font-size: 1.1em; }

    .card {
      background: linear-gradient(135deg, rgba(30,41,54,0.95), rgba(24,34,46,0.95));
      border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
      padding: 35px; backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .card-title { font-size: 1.4em; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .bonus-info {
      text-align: center; background: rgba(255,181,71,0.1);
      border: 1px solid rgba(255,181,71,0.3); border-radius: 10px;
      padding: 10px; margin-bottom: 25px; font-size: 0.95em;
    }

    /* Steps */
    .steps { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; align-items: center; }
    .step-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: rgba(255,255,255,0.15); transition: all 0.4s ease;
    }
    .step-dot.active {
      background: #ffb547; box-shadow: 0 0 10px rgba(255,181,71,0.4);
      width: 30px; border-radius: 5px;
    }
    .step-label { font-size: 0.75em; color: #6b7a8f; text-align: center; margin-bottom: 20px; }
    .step-label strong { color: #a9b5c6; }

    /* Google button */
    .btn-google {
      width: 100%; padding: 14px 20px; background: #fff;
      border: 2px solid rgba(255,255,255,0.2); border-radius: 12px;
      color: #333; font-size: 1em; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; font-family: 'Poppins', sans-serif;
      display: flex; align-items: center; justify-content: center; gap: 12px;
    }
    .btn-google:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,255,255,0.15); }
    .btn-google:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-google svg { width: 20px; height: 20px; flex-shrink: 0; }

    /* Divider */
    .divider { display: flex; align-items: center; margin: 22px 0; }
    .divider-line { flex: 1; height: 1px; background: rgba(255,255,255,0.1); }
    .divider-text { padding: 0 15px; color: #6b7a8f; font-size: 0.85em; }

    /* Form */
    .form-group { margin-bottom: 18px; }
    .form-label { display: block; font-size: 0.9em; color: #a9b5c6; margin-bottom: 8px; font-weight: 500; }
    .form-control {
      width: 100%; padding: 14px 16px; background: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
      color: #fff; font-size: 1em; font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }
    .form-control:focus { outline: none; border-color: #ffb547; background: rgba(0,0,0,0.4); }
    .form-control::placeholder { color: #6b7a8f; }
    select.form-control { cursor: pointer; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .form-row-telefone { display: flex; gap: 10px; }
    .form-row-telefone .codigo-pais { width: 110px; flex-shrink: 0; }

    /* Terms */
    .terms-group {
      display: flex; align-items: flex-start; gap: 10px; margin: 20px 0; padding: 14px;
      background: rgba(255,181,71,0.05); border: 1px solid rgba(255,181,71,0.15);
      border-radius: 12px; transition: border-color 0.3s;
    }
    .terms-group input[type="checkbox"] {
      width: 20px; height: 20px; margin-top: 2px; flex-shrink: 0;
      accent-color: #ffb547; cursor: pointer;
    }
    .terms-group label { font-size: 0.85em; color: #a9b5c6; cursor: pointer; line-height: 1.5; }
    .terms-group label a { color: #ffb547; text-decoration: underline; }

    /* Buttons */
    .btn-primary {
      width: 100%; padding: 16px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border: none; border-radius: 12px; color: #0e141b;
      font-size: 1.1em; font-weight: 700; cursor: pointer;
      transition: all 0.3s ease; font-family: 'Poppins', sans-serif;
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(255,181,71,0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-secondary {
      width: 100%; padding: 14px; background: transparent;
      border: 2px solid rgba(255,255,255,0.15); border-radius: 12px;
      color: #a9b5c6; font-size: 0.95em; font-weight: 600; cursor: pointer;
      transition: all 0.3s ease; font-family: 'Poppins', sans-serif; margin-top: 10px;
    }
    .btn-secondary:hover { border-color: rgba(255,255,255,0.3); color: #fff; }

    /* Messages */
    .error-message {
      background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.3);
      color: #e74c3c; padding: 12px; border-radius: 10px;
      margin-top: 15px; text-align: center; display: none;
    }
    .success-message {
      background: rgba(46,204,113,0.1); border: 1px solid rgba(46,204,113,0.3);
      color: #2ecc71; padding: 12px; border-radius: 10px;
      margin-top: 15px; text-align: center; display: none;
    }
    .info-message {
      background: rgba(52,152,219,0.1); border: 1px solid rgba(52,152,219,0.3);
      color: #3498db; padding: 16px; border-radius: 12px;
      margin-top: 15px; text-align: center; display: none; line-height: 1.6;
    }
    .info-message .email-icon { font-size: 2em; display: block; margin-bottom: 8px; }
    .login-link { text-align: center; margin-top: 20px; color: #a9b5c6; }
    .login-link a { color: #ffb547; text-decoration: none; font-weight: 600; }

    /* Steps transitions */
    .step-content { display: none; animation: fadeIn 0.4s ease; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Autocomplete */
    .autocomplete-container { position: relative; }
    .autocomplete-input {
      width: 100%; padding: 14px 16px 14px 40px; background: rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.1); border-radius: 12px;
      color: #fff; font-size: 1em; font-family: 'Poppins', sans-serif; transition: all 0.3s ease;
    }
    .autocomplete-input:focus { outline: none; border-color: #ffb547; background: rgba(0,0,0,0.4); }
    .autocomplete-input::placeholder { color: #6b7a8f; }
    .autocomplete-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 1.1em; pointer-events: none; }
    .autocomplete-results {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1e2936; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; max-height: 250px; overflow-y: auto; z-index: 100;
      display: none; margin-top: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .autocomplete-results.active { display: block; }
    .autocomplete-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
    .autocomplete-item:hover, .autocomplete-item.selected { background: rgba(255,181,71,0.1); }
    .autocomplete-item mark { background: rgba(255,181,71,0.3); color: inherit; border-radius: 2px; padding: 0 2px; }
    .autocomplete-empty { padding: 16px; text-align: center; color: #6b7a8f; }
    .selected-team {
      display: flex; align-items: center; gap: 12px; padding: 14px 16px;
      background: rgba(46,204,113,0.1); border: 2px solid rgba(46,204,113,0.3); border-radius: 12px;
    }
    .selected-team .team-info { flex: 1; }
    .selected-team .name { font-weight: 600; }
    .selected-team .btn-clear { background: none; border: none; color: #e74c3c; font-size: 1.2em; cursor: pointer; padding: 4px 8px; }

    /* Welcome card */
    .welcome-card { text-align: center; padding: 10px 0 20px; }
    .welcome-card .avatar { width: 64px; height: 64px; border-radius: 50%; margin: 0 auto 12px; border: 3px solid #ffb547; }
    .welcome-card .welcome-name { font-size: 1.1em; font-weight: 600; color: #fff; }
    .welcome-card .welcome-email { font-size: 0.85em; color: #6b7a8f; }

    input[type="hidden"] { display: none; }
    @media (max-width: 500px) { .form-row { gap: 10px; } .card { padding: 25px 20px; } }
    @media (max-width: 400px) { .form-row-telefone { flex-direction: column; gap: 10px; } .form-row-telefone .codigo-pais { width: 100%; } }
  </style>
</head>
<body>

  <div class="container">
    <div class="logo"><img src="/icons/logo-yellup.png" alt="Yellup" onerror="this.outerHTML='<div style=\'text-align:center;font-size:2.5em;font-weight:800;background:linear-gradient(135deg,#ffb547,#ff8c42);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px\'>‚öΩ Yellup</div>'"></div>
    <p class="subtitle">Crie sua conta e comece a jogar!</p>

    <div class="referral-badge" id="referralBadge" style="display: none;">
      <div class="icon">üéÅ</div>
      <div class="text">Voc√™ foi convidado por</div>
      <div class="name" id="referrerName">...</div>
    </div>

    <div class="card">
      <div class="steps">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
      </div>

      <!-- ========== STEP 1: AUTH ========== -->
      <div class="step-content active" id="step1">
        <h2 class="card-title">üìù Criar Conta</h2>
        <div class="bonus-info">üéÅ Ganhe <strong>20 cr√©ditos</strong> ao se cadastrar!</div>

        <button type="button" class="btn-google" id="btnGoogle" onclick="loginComGoogle()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continuar com Google
        </button>

        <div class="divider" id="divider1">
          <div class="divider-line"></div>
          <span class="divider-text">ou com e-mail</span>
          <div class="divider-line"></div>
        </div>

        <form id="formStep1" onsubmit="return false;">
          <div class="form-group">
            <label class="form-label">E-mail</label>
            <input type="email" class="form-control" id="email" placeholder="seu@email.com" required>
          </div>
          <div class="form-group">
            <label class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" placeholder="M√≠nimo 6 caracteres" required minlength="6">
          </div>

          <div class="terms-group" id="termsGroup1">
            <input type="checkbox" id="termos1" />
            <label for="termos1">Li e aceito os <a href="termos.html" target="_blank">Termos de Uso e Pol√≠tica de Privacidade</a>. Declaro ter 13 anos ou mais.</label>
          </div>

          <button type="submit" class="btn-primary" id="btnCadastrarEmail" onclick="cadastrarComEmail()">
            ‚úâÔ∏è Criar Conta com E-mail
          </button>
        </form>

        <div class="info-message" id="emailVerifMsg">
          <span class="email-icon">üì¨</span>
          <strong>Verifique seu e-mail!</strong><br>
          Enviamos um link de confirma√ß√£o para <strong id="emailEnviado"></strong>.<br>
          Clique no link e depois <a href="index.html" style="color:#ffb547;">fa√ßa login</a>.
        </div>

        <div class="error-message" id="errorStep1"></div>
        <div class="success-message" id="successStep1"></div>

        <div class="login-link">J√° tem conta? <a href="index.html">Fa√ßa login</a></div>
      </div>

      <!-- ========== STEP 2: PERFIL ========== -->
      <div class="step-content" id="step2">
        <h2 class="card-title">‚öΩ Complete seu Perfil</h2>

        <div class="welcome-card" id="welcomeCard" style="display:none;">
          <img class="avatar" id="welcomeAvatar" src="" alt="">
          <div class="welcome-name" id="welcomeName"></div>
          <div class="welcome-email" id="welcomeEmail"></div>
        </div>

        <div class="step-label"><strong>Etapa 2 de 2</strong> ‚Äî falta pouco!</div>

        <form id="formStep2" onsubmit="return false;">
          <div class="form-group">
            <label class="form-label">Nome Completo</label>
            <input type="text" class="form-control" id="nome" placeholder="Seu nome completo" required>
          </div>
          <div class="form-group">
            <label class="form-label">Nome de Usu√°rio (apelido)</label>
            <input type="text" class="form-control" id="usuario" placeholder="@seu_apelido" required>
          </div>
          <div class="form-group">
            <label class="form-label">Celular</label>
            <div class="form-row-telefone">
              <select class="form-control codigo-pais" id="codigoPais">
                <option value="+55">üáßüá∑ +55</option>
                <option value="+351">üáµüáπ +351</option>
                <option value="+54">üá¶üá∑ +54</option>
                <option value="+1">üá∫üá∏ +1</option>
                <option value="+34">üá™üá∏ +34</option>
                <option value="+39">üáÆüáπ +39</option>
                <option value="+33">üá´üá∑ +33</option>
                <option value="+44">üá¨üáß +44</option>
                <option value="+49">üá©üá™ +49</option>
                <option value="+81">üáØüáµ +81</option>
              </select>
              <input type="tel" class="form-control numero-tel" id="celular" placeholder="(00) 00000-0000" required maxlength="15" oninput="mascaraTelefone(this)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Data de Nascimento</label>
              <input type="date" class="form-control" id="dataNascimento" required>
            </div>
            <div class="form-group">
              <label class="form-label">Cidade</label>
              <input type="text" class="form-control" id="cidade" placeholder="Sua cidade" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Estado</label>
              <input type="text" class="form-control" id="estado" placeholder="UF" required maxlength="2">
            </div>
            <div class="form-group">
              <label class="form-label">Pa√≠s</label>
              <select class="form-control" id="pais" required>
                <option value="">Carregando pa√≠ses...</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">‚ù§Ô∏è Time do Cora√ß√£o</label>
            <div class="autocomplete-container">
              <input type="text" class="autocomplete-input" id="timeSearch" placeholder="Digite o nome do time..." autocomplete="off">
              <span class="autocomplete-icon">üîç</span>
              <div class="autocomplete-results" id="timeResults"></div>
            </div>
            <div class="selected-team" id="selectedTeam" style="display: none;">
              <span style="font-size: 1.5em;">‚öΩ</span>
              <div class="team-info"><div class="name" id="selectedTeamName"></div></div>
              <button type="button" class="btn-clear" onclick="limparTime()">‚úï</button>
            </div>
            <input type="hidden" id="timeId" required>
          </div>

          <div class="terms-group" id="termsGroup2" style="display:none;">
            <input type="checkbox" id="termos2" />
            <label for="termos2">Li e aceito os <a href="termos.html" target="_blank">Termos de Uso e Pol√≠tica de Privacidade</a>. Declaro ter 13 anos ou mais.</label>
          </div>

          <button type="submit" class="btn-primary" id="btnCompletarPerfil" onclick="completarPerfil()">
            üöÄ Come√ßar a Jogar!
          </button>
          <button type="button" class="btn-secondary" id="btnVoltar" onclick="voltarStep1()">‚Üê Voltar</button>
        </form>

        <div class="error-message" id="errorStep2"></div>
        <div class="success-message" id="successStep2"></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <script src="js/bandeiras-utils.js"></script>

  <script>
    // ===================================
    // üî• FIREBASE CONFIG
    // ===================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    // ===================================
    // üì¶ VARI√ÅVEIS
    // ===================================
    const urlParams = new URLSearchParams(window.location.search);
    const indicadorId = urlParams.get('ref') || urlParams.get('indicador') || null;
    let indicadorNome = null;
    let indicadorUid = null;
    let authMethod = null; // 'google' ou 'email'

    // ===================================
    // üîê PERSIST√äNCIA + AUTO-DETECT
    // ===================================
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      try {
        const doc = await db.collection("usuarios").doc(user.uid).get();
        if (doc.exists && doc.data().usuarioUnico) {
          // Perfil completo ‚Üí painel
          window.location.href = "painel.html";
        } else {
          // Perfil incompleto ‚Üí step 2
          const isGoogle = user.providerData.some(p => p.providerId === 'google.com');
          if (isGoogle) {
            authMethod = 'google';
            irParaStep2(user);
          }
        }
      } catch(e) { console.error(e); }
    });

    // ===================================
    // GOOGLE SVG (reusable)
    // ===================================
    const GOOGLE_SVG = '<svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>';

    // ===================================
    // ‚úÖ NAVEGA√á√ÉO STEPS
    // ===================================
    function irParaStep2(user) {
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
      document.getElementById('dot1').classList.remove('active');
      document.getElementById('dot2').classList.add('active');

      if (user && authMethod === 'google') {
        const wc = document.getElementById('welcomeCard');
        wc.style.display = 'block';
        if (user.photoURL) {
          document.getElementById('welcomeAvatar').src = user.photoURL;
        } else {
          document.getElementById('welcomeAvatar').style.display = 'none';
        }
        document.getElementById('welcomeName').textContent = user.displayName || '';
        document.getElementById('welcomeEmail').textContent = user.email || '';
        if (user.displayName) document.getElementById('nome').value = user.displayName;
        // Google users see terms in step 2
        document.getElementById('termsGroup2').style.display = 'flex';
        // Hide back button for Google (already authenticated)
        document.getElementById('btnVoltar').style.display = 'none';
      }
    }

    function voltarStep1() {
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
      document.getElementById('dot2').classList.remove('active');
      document.getElementById('dot1').classList.add('active');
    }

    // ===================================
    // üîµ LOGIN COM GOOGLE
    // ===================================
    async function loginComGoogle() {
      const btn = document.getElementById('btnGoogle');
      const errorDiv = document.getElementById('errorStep1');
      errorDiv.style.display = 'none';
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Conectando com Google...';

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        console.log("‚úÖ Google Auth:", user.email);

        // Check if profile already complete
        const doc = await db.collection("usuarios").doc(user.uid).get();
        if (doc.exists && doc.data().usuarioUnico) {
          window.location.href = "painel.html";
          return;
        }

        // New user ‚Üí step 2
        authMethod = 'google';
        irParaStep2(user);

      } catch (error) {
        console.error("Erro Google:", error);
        if (error.code === 'auth/popup-closed-by-user') {
          btn.disabled = false;
          btn.innerHTML = GOOGLE_SVG + ' Continuar com Google';
          return;
        }
        let msg = '‚ùå Erro ao conectar com Google. ';
        if (error.code === 'auth/account-exists-with-different-credential') {
          msg = '‚ùå Este e-mail j√° est√° cadastrado com senha. Fa√ßa login com e-mail.';
        } else { msg += 'Tente novamente.'; }
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = GOOGLE_SVG + ' Continuar com Google';
      }
    }

    // ===================================
    // ‚úâÔ∏è CADASTRAR COM EMAIL
    // ===================================
    async function cadastrarComEmail() {
      const btn = document.getElementById('btnCadastrarEmail');
      const errorDiv = document.getElementById('errorStep1');
      const email = document.getElementById('email').value.trim().toLowerCase();
      const senha = document.getElementById('senha').value;
      const termosOk = document.getElementById('termos1').checked;
      errorDiv.style.display = 'none';

      if (!email || !senha) {
        errorDiv.textContent = '‚ùå Preencha e-mail e senha!';
        errorDiv.style.display = 'block'; return;
      }
      if (senha.length < 6) {
        errorDiv.textContent = '‚ùå A senha deve ter pelo menos 6 caracteres!';
        errorDiv.style.display = 'block'; return;
      }
      if (!termosOk) {
        errorDiv.textContent = '‚ùå Voc√™ precisa aceitar os Termos de Uso para continuar.';
        errorDiv.style.display = 'block';
        document.getElementById('termsGroup1').style.borderColor = '#e74c3c';
        setTimeout(() => { document.getElementById('termsGroup1').style.borderColor = ''; }, 3000);
        return;
      }

      btn.disabled = true;
      btn.textContent = '‚è≥ Criando conta...';

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, senha);
        console.log("‚úÖ Auth criado:", cred.user.uid);

        // Send verification email
        await cred.user.sendEmailVerification();
        console.log("‚úÖ Email verifica√ß√£o enviado");

        // Save terms acceptance locally
        localStorage.setItem('yellup_termos_aceitos', 'true');
        localStorage.setItem('yellup_termos_data', new Date().toISOString());

        // Sign out ‚Äî user must verify email first
        await auth.signOut();

        // Show verification message
        document.getElementById('formStep1').style.display = 'none';
        document.getElementById('btnGoogle').style.display = 'none';
        document.getElementById('divider1').style.display = 'none';
        document.getElementById('emailEnviado').textContent = email;
        document.getElementById('emailVerifMsg').style.display = 'block';

      } catch (error) {
        console.error("Erro cadastro:", error);
        let msg = '‚ùå Erro ao criar conta. ';
        if (error.code === 'auth/email-already-in-use') msg = '‚ùå Este e-mail j√° est√° cadastrado! <a href="index.html" style="color:#ffb547">Fa√ßa login</a>.';
        else if (error.code === 'auth/weak-password') msg = '‚ùå Senha muito fraca!';
        else if (error.code === 'auth/invalid-email') msg = '‚ùå E-mail inv√°lido!';
        else msg += error.message;
        errorDiv.innerHTML = msg;
        errorDiv.style.display = 'block';
        btn.disabled = false;
        btn.textContent = '‚úâÔ∏è Criar Conta com E-mail';
      }
    }

    // ===================================
    // üöÄ COMPLETAR PERFIL (STEP 2)
    // ===================================
    async function completarPerfil() {
      const btn = document.getElementById('btnCompletarPerfil');
      const errorDiv = document.getElementById('errorStep2');
      const successDiv = document.getElementById('successStep2');
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';

      const user = auth.currentUser;
      if (!user) {
        errorDiv.textContent = '‚ùå Sess√£o expirada. Fa√ßa login novamente.';
        errorDiv.style.display = 'block'; return;
      }

      const nome = document.getElementById('nome').value.trim();
      const usuario = document.getElementById('usuario').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');
      const codigoPais = document.getElementById('codigoPais').value;
      const celularInput = document.getElementById('celular').value.trim();
      const celular = codigoPais + ' ' + celularInput;
      const celularLimpo = (codigoPais + celularInput).replace(/\D/g, '');
      const cidade = document.getElementById('cidade').value.trim();
      const estado = document.getElementById('estado').value.trim().toUpperCase();
      const pais = document.getElementById('pais').value;
      const dataNascimento = document.getElementById('dataNascimento').value;
      const timeId = document.getElementById('timeId').value;

      // Validations
      if (!nome || !usuario || !celularInput || !cidade || !estado || !pais || !dataNascimento) {
        errorDiv.textContent = '‚ùå Preencha todos os campos!';
        errorDiv.style.display = 'block'; return;
      }
      if (!timeId) {
        errorDiv.textContent = '‚ùå Selecione seu time do cora√ß√£o!';
        errorDiv.style.display = 'block';
        document.getElementById('timeSearch').focus(); return;
      }
      if (usuario.length < 3) {
        errorDiv.textContent = '‚ùå O apelido deve ter pelo menos 3 caracteres!';
        errorDiv.style.display = 'block'; return;
      }
      const celularNumeros = celularInput.replace(/\D/g, '');
      if (celularNumeros.length < 10 || celularNumeros.length > 11) {
        errorDiv.textContent = '‚ùå Celular inv√°lido! Use (XX) XXXXX-XXXX';
        errorDiv.style.display = 'block'; return;
      }

      // Terms check (Google users)
      if (authMethod === 'google') {
        if (!document.getElementById('termos2').checked) {
          errorDiv.textContent = '‚ùå Voc√™ precisa aceitar os Termos de Uso para continuar.';
          errorDiv.style.display = 'block';
          document.getElementById('termsGroup2').style.borderColor = '#e74c3c';
          setTimeout(() => { document.getElementById('termsGroup2').style.borderColor = ''; }, 3000);
          return;
        }
      }

      btn.disabled = true;
      btn.textContent = '‚è≥ Verificando dados...';

      try {
        // Check unique username
        const existeUser = await db.collection("usuarios").where("usuarioUnico", "==", usuario).get();
        if (!existeUser.empty) {
          errorDiv.textContent = '‚ùå Este apelido j√° est√° em uso!';
          errorDiv.style.display = 'block';
          btn.disabled = false; btn.textContent = 'üöÄ Come√ßar a Jogar!'; return;
        }

        // Check unique phone
        btn.textContent = '‚è≥ Verificando celular...';
        const existeCel = await db.collection("usuarios").where("celularLimpo", "==", celularLimpo).get();
        if (!existeCel.empty) {
          errorDiv.textContent = '‚ùå Este celular j√° est√° cadastrado!';
          errorDiv.style.display = 'block';
          btn.disabled = false; btn.textContent = 'üöÄ Come√ßar a Jogar!'; return;
        }

        btn.textContent = '‚è≥ Salvando perfil...';

        await db.collection("usuarios").doc(user.uid).set({
          nome, email: user.email,
          celular, celularLimpo, cidade, estado, pais, dataNascimento,
          timeId, usuario, usuarioUnico: usuario,
          authProvider: authMethod || 'email',
          indicadoPor: indicadorUid || "-",
          indicadorNome: indicadorNome || "-",
          status: "ativo",
          avatarUrl: (authMethod === 'google' && user.photoURL) ? user.photoURL : "",
          creditos: 20, creditosBonus: 20, creditosPagos: 0,
          yc: 0, xp: 0,
          jogadasGratis: { usadas: 0, ultimoReset: new Date() },
          termosAceitos: true,
          termosAceitosEm: firebase.firestore.FieldValue.serverTimestamp(),
          termosVersao: "2026-02",
          dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
          primeiroLogin: true
        });

        console.log("‚úÖ Perfil criado!");

        if (indicadorUid) {
          try {
            const fn = functions.httpsCallable('creditarIndicacao');
            await fn({ indicadorId: indicadorUid });
          } catch(e) { console.error("Erro indicador:", e); }
        }

        successDiv.textContent = '‚úÖ Perfil completo! Redirecionando...';
        successDiv.style.display = 'block';
        setTimeout(() => { window.location.href = "painel.html"; }, 1500);

      } catch (error) {
        console.error("Erro perfil:", error);
        errorDiv.textContent = '‚ùå Erro ao salvar: ' + error.message;
        errorDiv.style.display = 'block';
        btn.disabled = false; btn.textContent = 'üöÄ Come√ßar a Jogar!';
      }
    }

    // ===================================
    // üéÅ INDICADOR
    // ===================================
    async function verificarIndicador() {
      if (!indicadorId) return;
      try {
        const snap = await db.collection("usuarios").where("usuarioUnico", "==", indicadorId.toLowerCase()).limit(1).get();
        if (!snap.empty) {
          const doc = snap.docs[0];
          indicadorUid = doc.id;
          indicadorNome = doc.data().usuarioUnico || doc.data().nome;
          document.getElementById('referralBadge').style.display = 'block';
          document.getElementById('referrerName').textContent = indicadorNome;
        }
      } catch(e) { console.error(e); }
    }

    // ===================================
    // üìã PA√çSES
    // ===================================
    async function carregarPaises() {
      const sel = document.getElementById("pais");
      sel.innerHTML = '<option value="">Carregando...</option>';
      const fallback = ["Brasil","Portugal","Argentina","Uruguai","Paraguai","Chile","Col√¥mbia","M√©xico","Estados Unidos","Espanha","It√°lia","Fran√ßa","Alemanha","Inglaterra","Jap√£o","Outros"];
      try {
        const snap = await db.collection("paises").get();
        if (snap.empty) { sel.innerHTML = '<option value="">Selecione</option>'; fallback.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`); return; }
        let arr = [];
        snap.forEach(d => { const x = d.data(); arr.push({ nome: x.nome||d.id, bandeira: x.bandeira||x.flag||'', ordem: x.ordem||999 }); });
        arr.sort((a,b) => { if(a.nome.toLowerCase()==='brasil') return -1; if(b.nome.toLowerCase()==='brasil') return 1; return a.ordem-b.ordem || a.nome.localeCompare(b.nome,'pt-BR'); });
        sel.innerHTML = '<option value="">Selecione o pa√≠s</option>';
        arr.forEach(p => sel.innerHTML += `<option value="${p.nome}">${p.bandeira?p.bandeira+' ':''}${p.nome}</option>`);
      } catch(e) { sel.innerHTML = '<option value="">Selecione</option>'; fallback.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`); }
    }

    // ===================================
    // üì± M√ÅSCARA TEL
    // ===================================
    function mascaraTelefone(input) {
      let v = input.value.replace(/\D/g, '');
      if (v.length > 11) v = v.slice(0,11);
      if (v.length <= 2) v = v.length ? `(${v}` : '';
      else if (v.length <= 7) v = `(${v.slice(0,2)}) ${v.slice(2)}`;
      else v = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7)}`;
      input.value = v;
    }

    // ===================================
    // ‚öΩ AUTOCOMPLETE TIMES
    // ===================================
    let todosOsTimes = [];
    let timeSelectedIndex = -1;

    async function carregarTimes() {
      try {
        const snap = await db.collection("times").orderBy("nome").get();
        todosOsTimes = [];
        snap.forEach(d => todosOsTimes.push({ id: d.id, nome: d.data().nome||d.id, codigoPais: d.data().codigoPais||'BR', tipo: d.data().tipo||'clube' }));
        console.log(`‚úÖ ${todosOsTimes.length} times`);
        setupAutocomplete();
      } catch(e) { console.error(e); }
    }

    function setupAutocomplete() {
      const input = document.getElementById('timeSearch');
      const results = document.getElementById('timeResults');

      input.addEventListener('input', function() {
        const q = this.value.trim().toLowerCase();
        timeSelectedIndex = -1;
        if (q.length < 2) { results.classList.remove('active'); return; }
        const f = todosOsTimes.filter(t => removerAcentos(t.nome.toLowerCase()).includes(removerAcentos(q)) || t.nome.toLowerCase().includes(q)).slice(0,15);
        if (!f.length) { results.innerHTML = '<div class="autocomplete-empty">Nenhum time encontrado üòî</div>'; results.classList.add('active'); return; }
        results.innerHTML = f.map((t,i) => `<div class="autocomplete-item" data-id="${t.id}" data-nome="${t.nome}" data-index="${i}"><span>${getBandeira(t.codigoPais)}</span><span class="team-name">${highlightMatch(t.nome,q)}</span></div>`).join('');
        results.classList.add('active');
        results.querySelectorAll('.autocomplete-item').forEach(el => el.addEventListener('click', function() { selecionarTime(this.dataset.id, this.dataset.nome); }));
      });

      input.addEventListener('keydown', function(e) {
        const items = results.querySelectorAll('.autocomplete-item');
        if (e.key==='ArrowDown') { e.preventDefault(); timeSelectedIndex = Math.min(timeSelectedIndex+1, items.length-1); updateSel(items); }
        else if (e.key==='ArrowUp') { e.preventDefault(); timeSelectedIndex = Math.max(timeSelectedIndex-1, 0); updateSel(items); }
        else if (e.key==='Enter') { e.preventDefault(); if (timeSelectedIndex>=0 && items[timeSelectedIndex]) selecionarTime(items[timeSelectedIndex].dataset.id, items[timeSelectedIndex].dataset.nome); }
        else if (e.key==='Escape') results.classList.remove('active');
      });

      document.addEventListener('click', e => { if (!e.target.closest('.autocomplete-container')) results.classList.remove('active'); });
      input.addEventListener('focus', function() { if (this.value.length >= 2) this.dispatchEvent(new Event('input')); });
    }

    function updateSel(items) {
      items.forEach((el,i) => el.classList.toggle('selected', i===timeSelectedIndex));
      if (items[timeSelectedIndex]) items[timeSelectedIndex].scrollIntoView({block:'nearest'});
    }

    function selecionarTime(id, nome) {
      document.getElementById('timeId').value = id;
      document.getElementById('timeSearch').value = '';
      document.getElementById('timeResults').classList.remove('active');
      const t = todosOsTimes.find(x => x.id === id);
      document.getElementById('selectedTeamName').textContent = `${t?getBandeira(t.codigoPais):'‚öΩ'} ${nome}`;
      document.getElementById('selectedTeam').style.display = 'flex';
      document.querySelector('.autocomplete-container').style.display = 'none';
    }

    function limparTime() {
      document.getElementById('timeId').value = '';
      document.getElementById('selectedTeam').style.display = 'none';
      document.querySelector('.autocomplete-container').style.display = 'block';
      document.getElementById('timeSearch').value = '';
      document.getElementById('timeSearch').focus();
    }

    function removerAcentos(s) { return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    function highlightMatch(t,q) { return t.replace(new RegExp(`(${escapeRegex(q)})`,'gi'), '<mark>$1</mark>'); }
    function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    // ===================================
    // üöÄ INIT
    // ===================================
    window.onload = async () => {
      await verificarIndicador();
      await carregarPaises();
      await carregarTimes();
    };

    document.getElementById('senha').addEventListener('keypress', e => { if (e.key==='Enter') cadastrarComEmail(); });

    console.log("‚úÖ Yellup Cadastro v3.0 ‚Äî Google + Email + Termos");
  </script>
</body>
</html>
