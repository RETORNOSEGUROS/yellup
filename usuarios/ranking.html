<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0e141b;
      --bg-secondary: #1a2332;
      --bg-card: #232d3f;
      --text-primary: #e7eef7;
      --text-secondary: #a9b5c6;
      --accent: #ffb547;
      --accent-dark: #ff8c42;
      --success: #10b981;
      --danger: #ef4444;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-family: 'Orbitron', monospace;
      font-weight: 800;
      font-size: 1.2em;
      color: var(--accent);
    }
    .btn-back {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.85em;
      cursor: pointer;
      text-decoration: none;
    }

    .container { max-width: 600px; margin: 0 auto; padding: 20px 16px; }

    /* T√çTULO */
    .page-title {
      text-align: center;
      margin-bottom: 24px;
    }
    .page-title h1 {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .page-title p {
      font-size: 0.85em;
      color: var(--text-secondary);
    }

    /* FILTROS */
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .filter-btn {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 20px;
      font-family: inherit;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: 0.2s;
    }
    .filter-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #000;
      border-color: transparent;
    }

    /* MEU CARD */
    .my-rank-card {
      background: linear-gradient(135deg, rgba(255,181,71,0.1), rgba(255,140,66,0.05));
      border: 1px solid rgba(255,181,71,0.25);
      border-radius: 16px;
      padding: 16px 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .my-rank-pos {
      font-family: 'Orbitron', monospace;
      font-weight: 800;
      font-size: 1.3em;
      color: var(--accent);
      min-width: 44px;
      text-align: center;
    }
    .my-rank-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      object-fit: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      overflow: hidden;
    }
    .my-rank-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .my-rank-info { flex: 1; }
    .my-rank-name { font-weight: 700; font-size: 0.95em; }
    .my-rank-faixa { font-size: 0.75em; color: var(--text-secondary); }
    .my-rank-rating {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 1.1em;
      color: var(--accent);
    }
    .my-rank-var {
      font-size: 0.75em;
      font-weight: 600;
    }
    .var-up { color: var(--success); }
    .var-down { color: var(--danger); }

    /* LISTA RANKING */
    .ranking-list { display: flex; flex-direction: column; gap: 4px; }

    .rank-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border-radius: 12px;
      transition: 0.2s;
    }
    .rank-item:hover { background: var(--bg-card); }
    .rank-item.is-me {
      background: rgba(255,181,71,0.08);
      border: 1px solid rgba(255,181,71,0.2);
    }

    /* TOP 3 */
    .rank-item.top1 { background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,215,0,0.03)); border: 1px solid rgba(255,215,0,0.2); }
    .rank-item.top2 { background: linear-gradient(135deg, rgba(192,192,192,0.1), rgba(192,192,192,0.03)); border: 1px solid rgba(192,192,192,0.15); }
    .rank-item.top3 { background: linear-gradient(135deg, rgba(205,127,50,0.1), rgba(205,127,50,0.03)); border: 1px solid rgba(205,127,50,0.15); }

    .rank-pos {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 1em;
      min-width: 36px;
      text-align: center;
      color: var(--text-secondary);
    }
    .top1 .rank-pos { color: var(--gold); font-size: 1.15em; }
    .top2 .rank-pos { color: var(--silver); }
    .top3 .rank-pos { color: var(--bronze); }

    .rank-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid rgba(255,255,255,0.1);
      object-fit: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1em;
      overflow: hidden;
      flex-shrink: 0;
    }
    .rank-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .top1 .rank-avatar { border-color: var(--gold); }
    .top2 .rank-avatar { border-color: var(--silver); }
    .top3 .rank-avatar { border-color: var(--bronze); }

    .rank-info { flex: 1; min-width: 0; }
    .rank-name {
      font-weight: 600;
      font-size: 0.9em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rank-faixa {
      font-size: 0.7em;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .faixa-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .rank-right { text-align: right; flex-shrink: 0; }
    .rank-rating {
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      font-size: 0.95em;
    }
    .rank-variacao { font-size: 0.7em; font-weight: 600; }

    /* LOADING */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,181,71,0.2);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* EMPTY */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state .icon { font-size: 3em; margin-bottom: 12px; }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.85em;
      opacity: 0;
      transition: all 0.3s;
      z-index: 999;
      white-space: nowrap;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* TOTAL */
    .total-bar {
      text-align: center;
      padding: 14px;
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 16px;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <a href="rating.html" class="btn-back">&larr; Rating</a>
      <div class="logo">YELLUP</div>
    </div>
  </div>

  <div class="container">
    <div class="page-title">
      <h1>üèÜ Ranking Global</h1>
      <p>Os melhores superf√£s da plataforma</p>
    </div>

    <!-- MEU CARD (posi√ß√£o r√°pida) -->
    <div id="myRankCard" class="my-rank-card" style="display:none;">
      <div class="my-rank-pos" id="myPos">#-</div>
      <div class="my-rank-avatar" id="myAvatar">‚öΩ</div>
      <div class="my-rank-info">
        <div class="my-rank-name" id="myName">-</div>
        <div class="my-rank-faixa" id="myFaixa">-</div>
      </div>
      <div style="text-align:right;">
        <div class="my-rank-rating" id="myRating">0</div>
        <div class="my-rank-var" id="myVar"></div>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <button class="filter-btn active" onclick="filtrar('todos')">Todos</button>
      <button class="filter-btn" onclick="filtrar('imortal')">üèÜ Imortal</button>
      <button class="filter-btn" onclick="filtrar('lenda')">üî¥ Lenda</button>
      <button class="filter-btn" onclick="filtrar('fenomeno')">üü† Fen√¥meno</button>
      <button class="filter-btn" onclick="filtrar('craque')">üü° Craque</button>
      <button class="filter-btn" onclick="filtrar('titular')">üü¢ Titular</button>
    </div>

    <!-- LOADING -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>Carregando ranking...</div>
    </div>

    <!-- LISTA -->
    <div id="rankingList" class="ranking-list" style="display:none;"></div>

    <!-- VAZIO -->
    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="icon">üìä</div>
      <div>Nenhum jogador nesta faixa ainda</div>
    </div>

    <div id="totalBar" class="total-bar" style="display:none;"></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const FAIXAS = [
      { nome: 'Imortal',   icon: 'üèÜ', min: 850, max: 1000, color: '#dc2626' },
      { nome: 'Lenda',     icon: 'üî¥', min: 650, max: 849,  color: '#ea580c' },
      { nome: 'Fen√¥meno',  icon: 'üü†', min: 450, max: 649,  color: '#eab308' },
      { nome: 'Craque',    icon: 'üü°', min: 250, max: 449,  color: '#3b82f6' },
      { nome: 'Titular',   icon: 'üü¢', min: 100, max: 249,  color: '#10b981' },
      { nome: 'Reserva',   icon: '‚öΩ', min: 0,   max: 99,   color: '#6b7280' },
    ];

    function getFaixa(rating) {
      return FAIXAS.find(f => rating >= f.min && rating <= f.max) || FAIXAS[FAIXAS.length - 1];
    }

    let currentUser = null;
    let allPlayers = [];
    let filtroAtual = 'todos';

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await carregarRanking();
      } else {
        window.location.href = 'index.html';
      }
    });

    async function carregarRanking() {
      try {
        // Buscar todos os usu√°rios com rating > 0
        const snap = await db.collection('usuarios')
          .where('rating', '>', 0)
          .orderBy('rating', 'desc')
          .limit(200)
          .get();

        allPlayers = [];
        snap.forEach(doc => {
          const d = doc.data();
          allPlayers.push({
            uid: doc.id,
            nome: d.usuarioUnico || d.usuario || d.nome || 'An√¥nimo',
            avatarUrl: d.avatarUrl || '',
            rating: d.rating || 0,
            faixa: d.ratingFaixa || getFaixa(d.rating || 0).nome,
            variacao: d.ratingVariacao || 0,
            timeId: d.timeId || ''
          });
        });

        // Ordenar por rating descendente (j√° vem assim, mas garante)
        allPlayers.sort((a, b) => b.rating - a.rating);

        // Atribuir posi√ß√µes
        allPlayers.forEach((p, i) => p.posicao = i + 1);

        // Mostrar meu card
        mostrarMeuCard();

        // Renderizar lista
        renderizar();

        document.getElementById('loading').style.display = 'none';

      } catch (e) {
        console.error('Erro ao carregar ranking:', e);
        document.getElementById('loading').innerHTML = `
          <div class="icon" style="font-size:3em;margin-bottom:12px;">üìä</div>
          <div>Ranking ainda n√£o dispon√≠vel</div>
          <div style="font-size:0.8em;margin-top:8px;color:var(--text-secondary);">O rating √© calculado diariamente √† meia-noite</div>
        `;
      }
    }

    function mostrarMeuCard() {
      const eu = allPlayers.find(p => p.uid === currentUser.uid);
      if (!eu) return;

      const card = document.getElementById('myRankCard');
      const faixa = getFaixa(eu.rating);

      document.getElementById('myPos').textContent = '#' + eu.posicao;
      document.getElementById('myName').textContent = eu.nome;
      document.getElementById('myFaixa').textContent = faixa.icon + ' ' + faixa.nome;
      document.getElementById('myRating').textContent = Math.round(eu.rating);

      const avatarEl = document.getElementById('myAvatar');
      if (eu.avatarUrl) {
        avatarEl.innerHTML = '<img src="' + eu.avatarUrl + '" alt="">';
      }

      const varEl = document.getElementById('myVar');
      if (eu.variacao > 0) {
        varEl.className = 'my-rank-var var-up';
        varEl.textContent = 'üìà +' + Math.round(eu.variacao);
      } else if (eu.variacao < 0) {
        varEl.className = 'my-rank-var var-down';
        varEl.textContent = 'üìâ ' + Math.round(eu.variacao);
      }

      card.style.display = 'flex';
    }

    function filtrar(faixa) {
      filtroAtual = faixa;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderizar();
    }

    function renderizar() {
      let lista = allPlayers;

      if (filtroAtual !== 'todos') {
        const faixaMap = {
          'imortal': 'Imortal', 'lenda': 'Lenda', 'fenomeno': 'Fen√¥meno',
          'craque': 'Craque', 'titular': 'Titular', 'reserva': 'Reserva'
        };
        const nomeFaixa = faixaMap[filtroAtual];
        lista = allPlayers.filter(p => getFaixa(p.rating).nome === nomeFaixa);
      }

      const container = document.getElementById('rankingList');
      const empty = document.getElementById('emptyState');
      const total = document.getElementById('totalBar');

      if (lista.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        total.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      container.style.display = 'flex';
      total.style.display = 'block';

      let html = '';
      lista.forEach((p, idx) => {
        const faixa = getFaixa(p.rating);
        const pos = p.posicao;
        const isMe = p.uid === currentUser?.uid;
        const topClass = pos === 1 ? 'top1' : pos === 2 ? 'top2' : pos === 3 ? 'top3' : '';
        const meClass = isMe ? 'is-me' : '';
        const medal = pos === 1 ? 'ü•á' : pos === 2 ? 'ü•à' : pos === 3 ? 'ü•â' : '';

        let varHtml = '';
        if (p.variacao > 0) {
          varHtml = '<div class="rank-variacao var-up">+' + Math.round(p.variacao) + '</div>';
        } else if (p.variacao < 0) {
          varHtml = '<div class="rank-variacao var-down">' + Math.round(p.variacao) + '</div>';
        }

        const avatarInner = p.avatarUrl
          ? '<img src="' + p.avatarUrl + '" alt="">'
          : faixa.icon;

        html += '<div class="rank-item ' + topClass + ' ' + meClass + '">' +
          '<div class="rank-pos">' + (medal || '#' + pos) + '</div>' +
          '<div class="rank-avatar">' + avatarInner + '</div>' +
          '<div class="rank-info">' +
            '<div class="rank-name">' + (isMe ? 'üë§ ' : '') + escapeHtml(p.nome) + '</div>' +
            '<div class="rank-faixa"><span class="faixa-dot" style="background:' + faixa.color + '"></span> ' + faixa.nome + '</div>' +
          '</div>' +
          '<div class="rank-right">' +
            '<div class="rank-rating">' + Math.round(p.rating) + '</div>' +
            varHtml +
          '</div>' +
        '</div>';
      });

      container.innerHTML = html;
      total.textContent = lista.length + ' jogadores' + (filtroAtual !== 'todos' ? ' nesta faixa' : ' no ranking');
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
