<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miss√µes Di√°rias - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0a0e13;--bg-card:#131920;--bg-elevated:#1a2230;--accent-primary:#ff9f43;--accent-secondary:#ffc048;--accent-glow:rgba(255,159,67,.25);--live-red:#ff4757;--win-green:#2ed573;--text-primary:#f1f2f6;--text-secondary:#a4b0be}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);background-image:radial-gradient(ellipse at top,rgba(255,159,67,.03) 0%,transparent 50%),radial-gradient(ellipse at bottom,rgba(26,34,48,.5) 0%,transparent 50%);background-attachment:fixed;color:var(--text-primary);min-height:100vh;padding-bottom:100px}
    .header{background:rgba(10,14,19,.95);backdrop-filter:blur(20px);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,159,67,.1)}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo img{height:36px;filter:drop-shadow(0 2px 8px rgba(255,181,71,.3))}
    .btn-back{padding:8px 16px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:#e7eef7;cursor:pointer;font-family:'Poppins',sans-serif;font-size:.85em;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all .3s}
    .btn-back:hover{background:rgba(255,255,255,.2)}
    .container{max-width:600px;margin:0 auto;padding:24px 20px}
    .page-header{text-align:center;margin-bottom:20px}
    .page-header h1{font-size:1.5em;font-weight:800;margin-bottom:4px}
    .page-header p{color:var(--text-secondary);font-size:.85em}
    .summary-card{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;margin-bottom:10px;background:linear-gradient(135deg,rgba(255,159,67,.08),rgba(255,192,72,.03));border:1px solid rgba(255,159,67,.15);border-radius:14px}
    .summary-left{display:flex;align-items:center;gap:12px}
    .summary-progress-ring{position:relative;width:52px;height:52px}
    .summary-progress-ring svg{transform:rotate(-90deg);width:52px;height:52px}
    .summary-progress-ring .bg{stroke:rgba(255,255,255,.06)}
    .summary-progress-ring .fill{stroke:var(--accent-primary);transition:stroke-dashoffset .8s ease}
    .summary-progress-ring .text-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.85em;font-weight:800;color:var(--accent-secondary)}
    .summary-info .summary-label{font-size:.78em;color:var(--text-secondary)}
    .summary-info .summary-value{font-size:1.1em;font-weight:700;color:var(--accent-secondary)}
    .summary-right{text-align:right}
    .summary-timer-label{font-size:.72em;color:var(--text-secondary)}
    .summary-timer{font-size:1.05em;font-weight:700;color:var(--accent-primary)}
    .total-rewards{display:flex;justify-content:center;gap:16px;margin-bottom:22px;padding:12px;background:var(--bg-card);border-radius:12px;border:1px solid rgba(255,255,255,.04)}
    .total-reward-item{display:flex;align-items:center;gap:6px;font-size:.8em;color:var(--text-secondary)}
    .total-reward-item strong{color:var(--accent-secondary);font-weight:700}
    .total-reward-item.xp strong{color:#60a5fa}
    .missions-list{display:flex;flex-direction:column;gap:12px}
    .mission-card{background:linear-gradient(145deg,var(--bg-card),var(--bg-elevated));border:1px solid rgba(255,255,255,.05);border-radius:16px;padding:18px;transition:all .3s;position:relative;overflow:hidden}
    .mission-card:hover{border-color:rgba(255,159,67,.15)}
    .mission-card.completed{border-color:rgba(46,213,115,.3)}
    .mission-card.completed::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--win-green)}
    .mission-card.claimed{opacity:.5}
    .mission-card.bonus{border-color:rgba(168,85,247,.25);background:linear-gradient(145deg,rgba(168,85,247,.05),var(--bg-card))}
    .mission-card.bonus .mission-tag{background:rgba(168,85,247,.2);color:#c084fc}
    .mission-header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    .mission-icon-wrap{width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);border-radius:12px;font-size:1.6em;flex-shrink:0}
    .mission-title-area{flex:1}
    .mission-title-row{display:flex;align-items:center;gap:8px;margin-bottom:2px}
    .mission-title{font-weight:700;font-size:.92em}
    .mission-tag{padding:2px 8px;background:rgba(255,159,67,.15);border-radius:6px;font-size:.6em;font-weight:700;color:var(--accent-secondary);text-transform:uppercase;letter-spacing:.5px}
    .mission-reward-desc{font-size:.78em;color:var(--win-green);font-weight:600;display:flex;align-items:center;gap:4px}
    .mission-reward-desc .separator{color:var(--text-secondary);margin:0 2px}
    .mission-reward-desc .xp-part{color:#60a5fa}
    .mission-how{font-size:.78em;color:var(--text-secondary);margin-bottom:12px;line-height:1.4;padding:8px 12px;background:rgba(0,0,0,.15);border-radius:8px;border-left:3px solid rgba(255,159,67,.3)}
    .mission-progress-area{display:flex;align-items:center;gap:12px}
    .mission-bar-wrap{flex:1}
    .mission-bar-outer{width:100%;height:8px;background:rgba(0,0,0,.35);border-radius:4px;overflow:hidden}
    .mission-bar-inner{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));transition:width .8s cubic-bezier(.25,.46,.45,.94)}
    .mission-card.completed .mission-bar-inner{background:linear-gradient(90deg,var(--win-green),#7bed9f)}
    .mission-progress-text{font-size:.75em;font-weight:700;color:var(--accent-secondary);white-space:nowrap;min-width:40px;text-align:right}
    .mission-card.completed .mission-progress-text{color:var(--win-green)}
    .mission-action{margin-top:12px;text-align:right}
    .btn-claim{padding:10px 22px;background:linear-gradient(135deg,var(--win-green),#7bed9f);border:none;border-radius:10px;color:#0a1a0a;font-family:'Poppins',sans-serif;font-weight:700;font-size:.82em;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(46,213,115,.3);animation:claimPulse 2s ease-in-out infinite}
    @keyframes claimPulse{0%,100%{box-shadow:0 4px 15px rgba(46,213,115,.3)}50%{box-shadow:0 4px 25px rgba(46,213,115,.5)}}
    .btn-claim:hover{transform:translateY(-2px)}
    .btn-claim:active{transform:scale(.97)}
    .btn-pending{padding:8px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:var(--text-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:.78em;cursor:default}
    .btn-claimed-badge{padding:8px 16px;background:rgba(46,213,115,.08);border:1px solid rgba(46,213,115,.2);border-radius:10px;color:var(--win-green);font-family:'Poppins',sans-serif;font-weight:600;font-size:.78em;cursor:default}
    .loading-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
    .loading-spinner{display:inline-block;width:40px;height:40px;border:3px solid rgba(255,159,67,.2);border-top-color:var(--accent-primary);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,.9);color:#fff;padding:15px 30px;border-radius:50px;font-weight:600;z-index:2000;opacity:0;transition:all .3s;font-size:.9em}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(14,20,27,.98);backdrop-filter:blur(20px);padding:10px 20px;border-top:1px solid rgba(255,255,255,.1);z-index:99}
    .nav-content{max-width:600px;margin:0 auto;display:flex;justify-content:space-around}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#a9b5c6;text-decoration:none;font-size:.75em;transition:all .3s;padding:5px 10px}
    .nav-item:hover,.nav-item.active{color:#ffb547}
    .nav-icon{font-size:1.5em}
    @media(max-width:400px){.mission-header{gap:10px}.mission-icon-wrap{width:42px;height:42px;font-size:1.4em}}
  </style>
</head>
<body>
  <div class="header"><div class="header-content"><div class="logo"><img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'"></div><a href="painel.html" class="btn-back">‚Üê Voltar</a></div></div>
  <div class="container">
    <div class="page-header"><h1>üéØ Miss√µes Di√°rias</h1><p>Complete tarefas simples e ganhe cr√©ditos + XP</p></div>
    <div class="summary-card">
      <div class="summary-left">
        <div class="summary-progress-ring">
          <svg viewBox="0 0 52 52"><circle class="bg" cx="26" cy="26" r="22" fill="none" stroke-width="4"/><circle class="fill" id="progressCircle" cx="26" cy="26" r="22" fill="none" stroke-width="4" stroke-dasharray="138.23" stroke-dashoffset="138.23" stroke-linecap="round"/></svg>
          <div class="text-center" id="progressText">0/0</div>
        </div>
        <div class="summary-info"><div class="summary-label">Miss√µes completas</div><div class="summary-value" id="summaryStatus">Carregando...</div></div>
      </div>
      <div class="summary-right"><div class="summary-timer-label">Renova em</div><div class="summary-timer" id="resetTimer">--:--:--</div></div>
    </div>
    <div class="total-rewards"><div class="total-reward-item">üí∞ Total dispon√≠vel: <strong id="totalCreditos">0</strong> cr√©ditos</div><div class="total-reward-item xp">‚≠ê <strong id="totalXP">0</strong> XP</div></div>
    <div class="missions-list" id="missionsList"><div class="loading-state"><div class="loading-spinner"></div><div>Carregando miss√µes...</div></div></div>
  </div>
  <div class="toast" id="toast"></div>
  <nav class="bottom-nav"><div class="nav-content"><a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a><a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a><a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a><a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a></div></nav>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth(),functions=firebase.functions();

    const MISSOES_PADRAO=[
      {id:"responder_3",titulo:"Responda 3 perguntas",como:"Entre em qualquer jogo ao vivo e responda 3 perguntas (contam as extras al√©m das gr√°tis)",total:3,recompensa:{xp:10,creditos:2},icone:"‚ùì",tipo:"diaria"},
      {id:"torcer_1",titulo:"Tor√ßa para 1 time",como:"Acesse um jogo ao vivo e escolha um time para torcer",total:1,recompensa:{xp:5,creditos:2},icone:"üì£",tipo:"diaria"},
      {id:"convidar_1",titulo:"Convide 1 amigo",como:"V√° em Indica√ß√µes e compartilhe seu link com algu√©m",total:1,recompensa:{xp:10,creditos:1},icone:"üîó",tipo:"diaria"},
      {id:"abrir_bau",titulo:"Abra o Ba√∫ Di√°rio",como:"V√° no Ba√∫ Di√°rio e abra para tentar ganhar cr√©ditos",total:1,recompensa:{xp:5,creditos:1},icone:"üéÅ",tipo:"diaria"},
      {id:"completar_todas",titulo:"Complete todas as miss√µes!",como:"B√¥nus especial por completar as 4 miss√µes acima no mesmo dia",total:4,recompensa:{xp:25,creditos:5},icone:"‚≠ê",tipo:"bonus"}
    ];

    let currentUser=null,missoesData={};
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));
    auth.onAuthStateChanged(async user=>{if(!user){window.location.href='index.html';return}currentUser=user;await carregarMissoes();startResetTimer()});

    async function carregarMissoes(){
      try{
        const hoje=new Date();hoje.setHours(0,0,0,0);
        const snap=await db.collection('usuarios').doc(currentUser.uid).collection('missoes').get();
        const jaTem={};snap.forEach(doc=>jaTem[doc.id]=doc.data());
        for(const m of MISSOES_PADRAO){
          const ma=jaTem[m.id];
          const precisaCriar=!ma||(ma.data&&ma.data.toDate&&ma.data.toDate()<hoje);
          if(precisaCriar){
            await db.collection('usuarios').doc(currentUser.uid).collection('missoes').doc(m.id).set({id:m.id,titulo:m.titulo,descricao:m.como||'',total:m.total,icone:m.icone||'üéØ',tipo:m.tipo||'diaria',recompensa_creditos:m.recompensa.creditos||0,recompensa_xp:m.recompensa.xp||0,atual:0,concluido:false,creditada:false,data:firebase.firestore.Timestamp.now()});
            missoesData[m.id]={...m,atual:0,concluido:false,creditada:false};
          }else{missoesData[m.id]=ma}
        }
        renderMissoes();
      }catch(e){console.error('Erro:',e);document.getElementById('missionsList').innerHTML='<div class="loading-state">‚ùå Erro ao carregar</div>'}
    }

    function renderMissoes(){
      const container=document.getElementById('missionsList');
      const diarias=MISSOES_PADRAO.filter(m=>m.tipo==='diaria');
      const completasDiarias=diarias.filter(m=>{const d=missoesData[m.id];return d&&d.concluido}).length;
      const bonusMissao=missoesData['completar_todas'];
      if(bonusMissao&&!bonusMissao.concluido){
        bonusMissao.atual=completasDiarias;
        if(completasDiarias>=diarias.length){bonusMissao.concluido=true;db.collection('usuarios').doc(currentUser.uid).collection('missoes').doc('completar_todas').update({atual:completasDiarias,concluido:true}).catch(e=>console.error(e))}
      }
      const totalMissoes=MISSOES_PADRAO.length;
      const totalCompletas=MISSOES_PADRAO.filter(m=>missoesData[m.id]?.concluido).length;
      document.getElementById('progressText').textContent=`${totalCompletas}/${totalMissoes}`;
      const pct=totalMissoes>0?totalCompletas/totalMissoes:0;
      document.getElementById('progressCircle').style.strokeDashoffset=138.23*(1-pct);
      document.getElementById('summaryStatus').textContent=totalCompletas===totalMissoes?'Tudo completo! üéâ':`Faltam ${totalMissoes-totalCompletas}`;
      let tC=0,tX=0;MISSOES_PADRAO.forEach(m=>{tC+=m.recompensa.creditos;tX+=m.recompensa.xp});
      document.getElementById('totalCreditos').textContent=tC;
      document.getElementById('totalXP').textContent=tX;

      container.innerHTML=MISSOES_PADRAO.map(m=>{
        const data=missoesData[m.id]||{atual:0,concluido:false,creditada:false};
        const atual=data.atual||0,total=m.total,concluido=data.concluido||false,creditada=data.creditada||false;
        const barPct=Math.min(100,Math.round((atual/total)*100));
        let cc='mission-card';if(m.tipo==='bonus')cc+=' bonus';if(concluido&&creditada)cc+=' claimed';else if(concluido)cc+=' completed';
        const credPart=m.recompensa.creditos>0?`üí∞ +${m.recompensa.creditos} cr√©ditos`:'';
        const xpPart=m.recompensa.xp>0?`‚≠ê +${m.recompensa.xp} XP`:'';
        const sep=credPart&&xpPart?'<span class="separator">+</span>':'';
        let actionHTML;
        if(creditada)actionHTML='<span class="btn-claimed-badge">‚úÖ Coletado</span>';
        else if(concluido)actionHTML=`<button class="btn-claim" onclick="claimReward('${m.id}')">Coletar ${credPart} üéâ</button>`;
        else actionHTML='<span class="btn-pending">Em andamento</span>';
        const tagText=m.tipo==='bonus'?'B√îNUS':'DI√ÅRIA';
        return`<div class="${cc}"><div class="mission-header"><div class="mission-icon-wrap">${m.icone}</div><div class="mission-title-area"><div class="mission-title-row"><span class="mission-title">${m.titulo}</span><span class="mission-tag">${tagText}</span></div><div class="mission-reward-desc">${credPart}${sep}<span class="xp-part">${xpPart}</span></div></div></div><div class="mission-how">üìå ${m.como}</div><div class="mission-progress-area"><div class="mission-bar-wrap"><div class="mission-bar-outer"><div class="mission-bar-inner" style="width:${barPct}%"></div></div></div><div class="mission-progress-text">${atual}/${total}</div></div><div class="mission-action">${actionHTML}</div></div>`;
      }).join('');
    }

    async function claimReward(missaoId){
      const data=missoesData[missaoId];if(!data||!data.concluido||data.creditada)return;
      const mc=MISSOES_PADRAO.find(m=>m.id===missaoId);if(!mc)return;
      try{
        const r=await functions.httpsCallable('completarMissao')({missaoId});
        if(r.data.jaCreditada){showToast('‚ö†Ô∏è J√° coletado')}else{
          if(mc.recompensa.xp>0)await db.collection('usuarios').doc(currentUser.uid).update({xp:firebase.firestore.FieldValue.increment(mc.recompensa.xp),pontuacao:firebase.firestore.FieldValue.increment(mc.recompensa.xp)});
          let msg='‚úÖ ';if(mc.recompensa.creditos>0)msg+=`+${mc.recompensa.creditos} cr√©ditos `;if(mc.recompensa.xp>0)msg+=`+${mc.recompensa.xp} XP`;showToast(msg);
        }
        missoesData[missaoId].creditada=true;renderMissoes();
      }catch(e){
        console.error('Erro:',e);
        try{
          const batch=db.batch();const uRef=db.collection('usuarios').doc(currentUser.uid);const mRef=uRef.collection('missoes').doc(missaoId);
          const up={};if(mc.recompensa.creditos>0)up.creditos=firebase.firestore.FieldValue.increment(mc.recompensa.creditos);
          if(mc.recompensa.xp>0){up.xp=firebase.firestore.FieldValue.increment(mc.recompensa.xp);up.pontuacao=firebase.firestore.FieldValue.increment(mc.recompensa.xp)}
          if(Object.keys(up).length>0)batch.update(uRef,up);batch.update(mRef,{creditada:true});
          batch.set(uRef.collection('extrato').doc(),{tipo:'entrada',valor:mc.recompensa.creditos||0,descricao:`Miss√£o: ${mc.titulo}`,data:firebase.firestore.FieldValue.serverTimestamp()});
          await batch.commit();missoesData[missaoId].creditada=true;renderMissoes();
          let msg='‚úÖ ';if(mc.recompensa.creditos>0)msg+=`+${mc.recompensa.creditos} cr√©ditos `;if(mc.recompensa.xp>0)msg+=`+${mc.recompensa.xp} XP`;showToast(msg);
        }catch(fe){console.error('Fallback:',fe);showToast('‚ùå Erro. Tente novamente.')}
      }
    }

    function startResetTimer(){function u(){const a=new Date(),mn=new Date(a);mn.setDate(mn.getDate()+1);mn.setHours(0,0,0,0);const d=mn-a;const h=Math.floor(d/36e5),m=Math.floor((d%36e5)/6e4),s=Math.floor((d%6e4)/1e3);document.getElementById('resetTimer').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`}u();setInterval(u,1000)}

    window.atualizarMissao=async function(userId,idMissao){
      try{
        const ref=db.collection('usuarios').doc(userId).collection('missoes').doc(idMissao);
        const doc=await ref.get();
        if(!doc.exists)return;
        const dados=doc.data();
        const hoje=new Date();hoje.setHours(0,0,0,0);
        const dataM=dados.data&&dados.data.toDate?dados.data.toDate():null;

        // Se a miss√£o √© de outro dia, resetar antes de incrementar
        if(dataM&&dataM<hoje){
          await ref.update({atual:1,concluido:1>=(dados.total||1),creditada:false,data:firebase.firestore.Timestamp.now()});
          if(1>=(dados.total||1)){try{await firebase.functions().httpsCallable('completarMissao')({missaoId:idMissao})}catch(e){console.error(e)}}
          return;
        }

        // Miss√£o de hoje - incrementar normalmente
        if(dados.concluido)return;
        const novo=(dados.atual||0)+1;
        const concluido=novo>=(dados.total||1);
        await ref.update({atual:novo,concluido});
        if(concluido){try{await firebase.functions().httpsCallable('completarMissao')({missaoId:idMissao})}catch(e){console.error(e)}}
      }catch(e){console.error('atualizarMissao erro:',e)}
    };

    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
