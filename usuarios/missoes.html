<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miss√µes Di√°rias - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0e13;
      --bg-card: #131920;
      --bg-elevated: #1a2230;
      --accent-primary: #ff9f43;
      --accent-secondary: #ffc048;
      --accent-glow: rgba(255, 159, 67, 0.25);
      --live-red: #ff4757;
      --win-green: #2ed573;
      --text-primary: #f1f2f6;
      --text-secondary: #a4b0be;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse at top, rgba(255, 159, 67, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(26, 34, 48, 0.5) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: rgba(10, 14, 19, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(255, 159, 67, 0.1);
    }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo img { height: 36px; filter: drop-shadow(0 2px 8px rgba(255, 181, 71, 0.3)); }
    .btn-back {
      padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px; color: #e7eef7; cursor: pointer; font-family: 'Poppins', sans-serif;
      font-size: 0.85em; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: all 0.3s;
    }
    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }

    .container { max-width: 600px; margin: 0 auto; padding: 30px 20px; }

    /* PAGE HEADER */
    .page-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .page-header h1 { font-size: 1.6em; font-weight: 800; margin-bottom: 6px; }
    .page-header p { color: var(--text-secondary); font-size: 0.9em; }

    /* RESUMO */
    .summary-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; margin-bottom: 24px;
      background: linear-gradient(135deg, rgba(255, 159, 67, 0.1), rgba(255, 192, 72, 0.05));
      border: 1px solid rgba(255, 159, 67, 0.2);
      border-radius: 16px;
    }
    .summary-left { display: flex; align-items: center; gap: 12px; }
    .summary-icon { font-size: 2em; }
    .summary-text .summary-count { font-size: 1.3em; font-weight: 800; color: var(--accent-secondary); }
    .summary-text .summary-label { font-size: 0.75em; color: var(--text-secondary); }
    .summary-right {
      text-align: right;
    }
    .summary-timer { font-size: 0.8em; color: var(--text-secondary); }
    .summary-timer-value { font-size: 1.1em; font-weight: 700; color: var(--accent-primary); }

    /* MISSION CARD */
    .missions-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }

    .mission-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-elevated));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 18px;
      padding: 20px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .mission-card:hover {
      border-color: rgba(255, 159, 67, 0.2);
      transform: translateY(-1px);
    }
    .mission-card.completed {
      border-color: rgba(46, 213, 115, 0.3);
      background: linear-gradient(145deg, rgba(46, 213, 115, 0.05), var(--bg-card));
    }
    .mission-card.completed::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: var(--win-green);
    }
    .mission-card.claimed {
      opacity: 0.55;
      border-color: rgba(255, 255, 255, 0.05);
    }

    .mission-top {
      display: flex; align-items: flex-start; gap: 14px; margin-bottom: 14px;
    }
    .mission-icon {
      font-size: 2em; flex-shrink: 0;
      width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.3); border-radius: 14px;
    }
    .mission-info { flex: 1; }
    .mission-title { font-weight: 700; font-size: 0.95em; margin-bottom: 4px; }
    .mission-desc { font-size: 0.8em; color: var(--text-secondary); line-height: 1.4; }

    /* PROGRESS BAR */
    .mission-progress { margin-bottom: 14px; }
    .mission-progress-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 6px;
    }
    .mission-progress-text { font-size: 0.75em; color: var(--text-secondary); }
    .mission-progress-numbers { font-size: 0.8em; font-weight: 700; color: var(--accent-secondary); }
    .mission-bar-outer {
      width: 100%; height: 10px; background: rgba(0,0,0,0.4);
      border-radius: 6px; overflow: hidden;
    }
    .mission-bar-inner {
      height: 100%; border-radius: 6px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .mission-card.completed .mission-bar-inner {
      background: linear-gradient(90deg, var(--win-green), #7bed9f);
    }

    /* REWARD + BUTTON */
    .mission-bottom {
      display: flex; justify-content: space-between; align-items: center;
    }
    .mission-reward {
      display: flex; align-items: center; gap: 12px;
    }
    .reward-badge {
      display: flex; align-items: center; gap: 4px;
      padding: 5px 10px;
      background: rgba(255, 159, 67, 0.1);
      border: 1px solid rgba(255, 159, 67, 0.2);
      border-radius: 8px;
      font-size: 0.75em; font-weight: 600; color: var(--accent-secondary);
    }
    .reward-badge.xp {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
    }

    .btn-claim {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--win-green), #7bed9f);
      border: none; border-radius: 10px;
      color: var(--bg-dark); font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 0.8em;
      cursor: pointer; transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(46, 213, 115, 0.3);
    }
    .btn-claim:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 213, 115, 0.4); }
    .btn-claim:active { transform: scale(0.97); }
    .btn-claim:disabled {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-secondary);
      cursor: default; box-shadow: none;
    }
    .btn-claim:disabled:hover { transform: none; }

    .btn-claimed {
      padding: 10px 20px;
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.3);
      border-radius: 10px;
      color: var(--win-green); font-family: 'Poppins', sans-serif;
      font-weight: 600; font-size: 0.8em;
      cursor: default;
    }

    /* BONUS MISSION */
    .mission-card.bonus {
      border-color: rgba(168, 85, 247, 0.3);
      background: linear-gradient(145deg, rgba(168, 85, 247, 0.06), var(--bg-card));
    }
    .mission-card.bonus::after {
      content: '‚òÖ B√îNUS';
      position: absolute; top: 12px; right: 12px;
      padding: 3px 10px; background: rgba(168, 85, 247, 0.3);
      border-radius: 8px; font-size: 0.6em; font-weight: 700;
      color: #c084fc; letter-spacing: 0.5px;
    }

    /* DAILY RESET TIMER */
    .reset-info {
      text-align: center; margin-bottom: 24px;
      padding: 14px; background: var(--bg-card);
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
    }
    .reset-label { font-size: 0.8em; color: var(--text-secondary); }
    .reset-timer { font-size: 1.2em; font-weight: 700; color: var(--accent-primary); margin-top: 4px; }

    /* LOADING */
    .loading-state {
      text-align: center; padding: 60px 20px; color: var(--text-secondary);
    }
    .loading-spinner {
      display: inline-block; width: 40px; height: 40px;
      border: 3px solid rgba(255,159,67,0.2);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* TOAST */
    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9); color: white;
      padding: 15px 30px; border-radius: 50px;
      font-weight: 600; z-index: 2000; opacity: 0;
      transition: all 0.3s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* BOTTOM NAV */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(14, 20, 27, 0.98); backdrop-filter: blur(20px);
      padding: 10px 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); z-index: 99;
    }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      color: #a9b5c6; text-decoration: none; font-size: 0.75em;
      transition: all 0.3s; padding: 5px 10px;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }

    @media (max-width: 400px) {
      .mission-top { gap: 10px; }
      .mission-icon { width: 42px; height: 42px; font-size: 1.6em; }
      .mission-reward { gap: 6px; }
      .reward-badge { padding: 4px 8px; font-size: 0.7em; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'">
      </div>
      <a href="painel.html" class="btn-back">‚Üê Voltar</a>
    </div>
  </div>

  <div class="container">

    <div class="page-header">
      <h1>üéØ Miss√µes Di√°rias</h1>
      <p>Complete tarefas e ganhe recompensas!</p>
    </div>

    <!-- RESUMO -->
    <div class="summary-bar">
      <div class="summary-left">
        <div class="summary-icon">üìã</div>
        <div class="summary-text">
          <div class="summary-count" id="completedCount">0/0</div>
          <div class="summary-label">Miss√µes completas</div>
        </div>
      </div>
      <div class="summary-right">
        <div class="summary-timer">Renova em</div>
        <div class="summary-timer-value" id="resetTimer">--:--:--</div>
      </div>
    </div>

    <!-- LISTA DE MISS√ïES -->
    <div class="missions-list" id="missionsList">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div>Carregando miss√µes...</div>
      </div>
    </div>

  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
      <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
    </div>
  </nav>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBMmvxHCzgFkTEOSrvrCFRijKmhMhtOIQ4",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "116878613498",
      appId: "1:116878613498:web:b16a17f52cb521ffa0c22f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    // ==========================================
    // MISS√ïES PADR√ÉO
    // ==========================================
    const MISSOES_PADRAO = [
      {
        id: "responder_3",
        titulo: "Responda 3 perguntas",
        descricao: "Participe de um jogo e responda pelo menos 3 perguntas",
        total: 3,
        recompensa: { xp: 10, creditos: 5 },
        icone: "‚ùì",
        tipo: "diaria"
      },
      {
        id: "torcer_1",
        titulo: "Tor√ßa para 1 time",
        descricao: "Escolha um time em qualquer jogo ao vivo",
        total: 1,
        recompensa: { xp: 5, creditos: 2 },
        icone: "üì£",
        tipo: "diaria"
      },
      {
        id: "convidar_1",
        titulo: "Convide 1 amigo",
        descricao: "Compartilhe seu c√≥digo de indica√ß√£o com um amigo",
        total: 1,
        recompensa: { xp: 15, creditos: 10 },
        icone: "üîó",
        tipo: "diaria"
      },
      {
        id: "abrir_bau",
        titulo: "Abra o Ba√∫ Di√°rio",
        descricao: "Colete sua recompensa di√°ria no Ba√∫",
        total: 1,
        recompensa: { xp: 5, creditos: 0 },
        icone: "üéÅ",
        tipo: "diaria"
      },
      {
        id: "completar_todas",
        titulo: "Complete todas as miss√µes",
        descricao: "B√¥nus especial por completar todas as miss√µes do dia!",
        total: 4,
        recompensa: { xp: 25, creditos: 15 },
        icone: "‚≠ê",
        tipo: "bonus"
      }
    ];

    let currentUser = null;
    let missoesData = {};

    // AUTH
    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;
      await carregarMissoes();
      startResetTimer();
    });

    // ==========================================
    // CARREGAR MISS√ïES
    // ==========================================
    async function carregarMissoes() {
      try {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        const snap = await db.collection('usuarios').doc(currentUser.uid)
          .collection('missoes').get();

        const jaTem = {};
        snap.forEach(doc => jaTem[doc.id] = doc.data());

        // Criar/resetar miss√µes que n√£o existem ou s√£o de ontem
        for (const m of MISSOES_PADRAO) {
          const missaoAtual = jaTem[m.id];
          const precisaCriar = !missaoAtual || 
            (missaoAtual.data && missaoAtual.data.toDate && missaoAtual.data.toDate() < hoje);

          if (precisaCriar) {
            await db.collection('usuarios').doc(currentUser.uid)
              .collection('missoes').doc(m.id).set({
                ...m,
                atual: 0,
                concluido: false,
                creditada: false,
                data: firebase.firestore.Timestamp.now()
              });
            missoesData[m.id] = { ...m, atual: 0, concluido: false, creditada: false };
          } else {
            missoesData[m.id] = missaoAtual;
          }
        }

        renderMissoes();
      } catch (e) {
        console.error('Erro ao carregar miss√µes:', e);
        document.getElementById('missionsList').innerHTML = `
          <div class="loading-state">‚ùå Erro ao carregar miss√µes</div>
        `;
      }
    }

    // ==========================================
    // RENDER
    // ==========================================
    function renderMissoes() {
      const container = document.getElementById('missionsList');

      // Contar completas (excluindo b√¥nus)
      const diarias = MISSOES_PADRAO.filter(m => m.tipo === 'diaria');
      const completasDiarias = diarias.filter(m => {
        const d = missoesData[m.id];
        return d && d.concluido;
      }).length;

      // Atualizar miss√£o b√¥nus (completar_todas)
      const bonusMissao = missoesData['completar_todas'];
      if (bonusMissao && !bonusMissao.concluido) {
        bonusMissao.atual = completasDiarias;
        if (completasDiarias >= diarias.length) {
          bonusMissao.concluido = true;
          // Atualizar no Firestore
          db.collection('usuarios').doc(currentUser.uid)
            .collection('missoes').doc('completar_todas')
            .update({ atual: completasDiarias, concluido: true })
            .catch(e => console.error('Erro atualizando b√¥nus:', e));
        }
      }

      const totalMissoes = MISSOES_PADRAO.length;
      const totalCompletas = MISSOES_PADRAO.filter(m => missoesData[m.id]?.concluido).length;
      document.getElementById('completedCount').textContent = `${totalCompletas}/${totalMissoes}`;

      container.innerHTML = MISSOES_PADRAO.map(m => {
        const data = missoesData[m.id] || { atual: 0, concluido: false, creditada: false };
        const atual = data.atual || 0;
        const total = m.total;
        const concluido = data.concluido || false;
        const creditada = data.creditada || false;
        const percent = Math.min(100, Math.round((atual / total) * 100));

        let cardClass = 'mission-card';
        if (m.tipo === 'bonus') cardClass += ' bonus';
        if (concluido && creditada) cardClass += ' claimed';
        else if (concluido) cardClass += ' completed';

        let buttonHTML;
        if (creditada) {
          buttonHTML = `<div class="btn-claimed">‚úÖ Coletado</div>`;
        } else if (concluido) {
          buttonHTML = `<button class="btn-claim" onclick="claimReward('${m.id}')">Coletar üéâ</button>`;
        } else {
          buttonHTML = `<button class="btn-claim" disabled>${atual}/${total}</button>`;
        }

        let rewardsHTML = '';
        if (m.recompensa.creditos > 0) {
          rewardsHTML += `<div class="reward-badge">üí∞ +${m.recompensa.creditos}</div>`;
        }
        if (m.recompensa.xp > 0) {
          rewardsHTML += `<div class="reward-badge xp">‚≠ê +${m.recompensa.xp} XP</div>`;
        }

        return `
          <div class="${cardClass}">
            <div class="mission-top">
              <div class="mission-icon">${m.icone}</div>
              <div class="mission-info">
                <div class="mission-title">${m.titulo}</div>
                <div class="mission-desc">${m.descricao}</div>
              </div>
            </div>
            <div class="mission-progress">
              <div class="mission-progress-header">
                <span class="mission-progress-text">Progresso</span>
                <span class="mission-progress-numbers">${atual}/${total}</span>
              </div>
              <div class="mission-bar-outer">
                <div class="mission-bar-inner" style="width:${percent}%"></div>
              </div>
            </div>
            <div class="mission-bottom">
              <div class="mission-reward">${rewardsHTML}</div>
              ${buttonHTML}
            </div>
          </div>
        `;
      }).join('');
    }

    // ==========================================
    // COLETAR RECOMPENSA
    // ==========================================
    async function claimReward(missaoId) {
      const data = missoesData[missaoId];
      if (!data || !data.concluido || data.creditada) return;

      const missaoConfig = MISSOES_PADRAO.find(m => m.id === missaoId);
      if (!missaoConfig) return;

      try {
        // Usar Cloud Function para creditar com seguran√ßa
        const completarMissaoFn = functions.httpsCallable('completarMissao');
        const result = await completarMissaoFn({ missaoId });

        if (result.data.jaCreditada) {
          showToast('‚ö†Ô∏è Recompensa j√° coletada');
        } else {
          // Atualizar XP localmente (Cloud Function credita os cr√©ditos)
          if (missaoConfig.recompensa.xp > 0) {
            await db.collection('usuarios').doc(currentUser.uid).update({
              xp: firebase.firestore.FieldValue.increment(missaoConfig.recompensa.xp),
              pontuacao: firebase.firestore.FieldValue.increment(missaoConfig.recompensa.xp)
            });
          }

          let msg = '‚úÖ ';
          if (missaoConfig.recompensa.creditos > 0) msg += `+${missaoConfig.recompensa.creditos} cr√©ditos `;
          if (missaoConfig.recompensa.xp > 0) msg += `+${missaoConfig.recompensa.xp} XP`;
          showToast(msg);
        }

        // Atualizar local
        missoesData[missaoId].creditada = true;
        renderMissoes();

      } catch (e) {
        console.error('Erro ao coletar recompensa:', e);

        // Fallback: creditar manualmente se Cloud Function falhar
        try {
          const batch = db.batch();
          const userRef = db.collection('usuarios').doc(currentUser.uid);
          const missaoRef = userRef.collection('missoes').doc(missaoId);

          const updates = {};
          if (missaoConfig.recompensa.creditos > 0) {
            updates.creditos = firebase.firestore.FieldValue.increment(missaoConfig.recompensa.creditos);
          }
          if (missaoConfig.recompensa.xp > 0) {
            updates.xp = firebase.firestore.FieldValue.increment(missaoConfig.recompensa.xp);
            updates.pontuacao = firebase.firestore.FieldValue.increment(missaoConfig.recompensa.xp);
          }

          if (Object.keys(updates).length > 0) batch.update(userRef, updates);
          batch.update(missaoRef, { creditada: true });

          const extratoRef = userRef.collection('extrato').doc();
          batch.set(extratoRef, {
            tipo: 'entrada',
            valor: missaoConfig.recompensa.creditos || 0,
            descricao: `Miss√£o: ${missaoConfig.titulo}`,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });

          await batch.commit();

          missoesData[missaoId].creditada = true;
          renderMissoes();

          let msg = '‚úÖ ';
          if (missaoConfig.recompensa.creditos > 0) msg += `+${missaoConfig.recompensa.creditos} cr√©ditos `;
          if (missaoConfig.recompensa.xp > 0) msg += `+${missaoConfig.recompensa.xp} XP`;
          showToast(msg);
        } catch (fallbackErr) {
          console.error('Erro fallback:', fallbackErr);
          showToast('‚ùå Erro ao coletar. Tente novamente.');
        }
      }
    }

    // ==========================================
    // TIMER DE RESET (meia-noite)
    // ==========================================
    function startResetTimer() {
      function update() {
        const agora = new Date();
        const meiaNoite = new Date(agora);
        meiaNoite.setDate(meiaNoite.getDate() + 1);
        meiaNoite.setHours(0, 0, 0, 0);

        const diff = meiaNoite - agora;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        document.getElementById('resetTimer').textContent = 
          `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }
      update();
      setInterval(update, 1000);
    }

    // ==========================================
    // HELPER: Atualizar miss√£o (chamado por outras p√°ginas)
    // ==========================================
    // Exemplo: ao responder pergunta, chamar:
    // atualizarMissao(userId, 'responder_3')
    window.atualizarMissao = async function(userId, idMissao) {
      const ref = db.collection('usuarios').doc(userId).collection('missoes').doc(idMissao);
      const doc = await ref.get();
      if (!doc.exists) return;

      const dados = doc.data();
      if (dados.concluido) return;

      const novo = (dados.atual || 0) + 1;
      const concluido = novo >= dados.total;
      await ref.update({ atual: novo, concluido });

      if (concluido) {
        try {
          const completarMissaoFn = firebase.functions().httpsCallable('completarMissao');
          await completarMissaoFn({ missaoId: idMissao });
        } catch (e) {
          console.error('Erro ao creditar miss√£o:', e);
        }
      }
    };

    // TOAST
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
