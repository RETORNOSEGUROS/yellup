<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Embates PvP - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Container */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 25px;
    }

    .page-title h1 {
      font-size: 1.8em;
      margin-bottom: 5px;
    }

    .page-title p {
      color: #a9b5c6;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 25px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 800;
      color: #ffb547;
    }

    .stat-value.green { color: #10b981; }
    .stat-value.red { color: #ef4444; }

    .stat-label {
      font-size: 0.75em;
      color: #a9b5c6;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 14px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #a9b5c6;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      border-color: rgba(255, 181, 71, 0.5);
    }

    .tab-btn.active {
      border-color: #ffb547;
      background: rgba(255, 181, 71, 0.1);
      color: #ffb547;
    }

    /* Section Title */
    .section-title {
      font-size: 1.1em;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Card */
    .card {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    /* Criar Desafio */
    .create-challenge {
      text-align: center;
      padding: 30px 20px;
    }

    .create-icon {
      font-size: 4em;
      margin-bottom: 15px;
    }

    .create-title {
      font-size: 1.3em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .create-desc {
      color: #a9b5c6;
      margin-bottom: 20px;
    }

    .btn-create {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      border: none;
      border-radius: 12px;
      color: #0e141b;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }

    .btn-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 181, 71, 0.4);
    }

    .cost-info {
      font-size: 0.85em;
      color: #a9b5c6;
    }

    /* Desafios List */
    .challenge-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    .challenge-item:hover {
      background: rgba(255, 181, 71, 0.1);
    }

    .challenge-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3em;
      font-weight: 700;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
      flex-shrink: 0;
    }

    .challenge-info {
      flex: 1;
    }

    .challenge-opponent {
      font-weight: 600;
      margin-bottom: 3px;
    }

    .challenge-details {
      font-size: 0.8em;
      color: #a9b5c6;
    }

    .challenge-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .status-ready {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-won {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-lost {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .challenge-actions {
      display: flex;
      gap: 8px;
    }

    .btn-accept {
      padding: 8px 16px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    .btn-decline {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.2);
      border: none;
      border-radius: 8px;
      color: #ef4444;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    .btn-play {
      padding: 8px 16px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border: none;
      border-radius: 8px;
      color: #0e141b;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #a9b5c6;
    }

    .empty-icon {
      font-size: 3em;
      margin-bottom: 15px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e2936 0%, #18222e 100%);
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-weight: 700;
      font-size: 1.2em;
    }

    .modal-close {
      background: none;
      border: none;
      color: #a9b5c6;
      font-size: 1.5em;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.9em;
      color: #a9b5c6;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .form-input:focus {
      outline: none;
      border-color: #ffb547;
    }

    .bet-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .bet-option {
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bet-option:hover {
      border-color: rgba(255, 181, 71, 0.5);
    }

    .bet-option.selected {
      border-color: #ffb547;
      background: rgba(255, 181, 71, 0.1);
    }

    .bet-value {
      font-size: 1.3em;
      font-weight: 700;
      color: #ffb547;
    }

    .bet-label {
      font-size: 0.75em;
      color: #a9b5c6;
    }

    .user-found {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      margin-top: 10px;
    }

    .user-not-found {
      padding: 15px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      margin-top: 10px;
      text-align: center;
      color: #ef4444;
    }

    .btn-send-challenge {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      border: none;
      border-radius: 12px;
      color: #0e141b;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      margin-top: 10px;
    }

    .btn-send-challenge:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Link de Compartilhamento */
    .share-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .share-title {
      font-size: 0.9em;
      color: #a9b5c6;
      margin-bottom: 10px;
      text-align: center;
    }

    .share-link {
      display: flex;
      gap: 10px;
    }

    .share-input {
      flex: 1;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-size: 0.85em;
    }

    .btn-copy {
      padding: 12px 20px;
      background: rgba(255, 181, 71, 0.2);
      border: none;
      border-radius: 10px;
      color: #ffb547;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
    }

    .share-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .share-btn.whatsapp {
      background: #25D366;
      color: #fff;
    }

    .share-btn.telegram {
      background: #0088cc;
      color: #fff;
    }

    /* VS Screen */
    .vs-screen {
      display: none;
      text-align: center;
      padding: 30px;
    }

    .vs-screen.active {
      display: block;
    }

    .vs-players {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
    }

    .vs-player {
      text-align: center;
    }

    .vs-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      font-weight: 700;
      margin: 0 auto 10px;
    }

    .vs-avatar.you {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }

    .vs-avatar.opponent {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
    }

    .vs-name {
      font-weight: 700;
    }

    .vs-text {
      font-size: 3em;
      font-weight: 900;
      color: #ffb547;
      text-shadow: 0 0 30px rgba(255, 181, 71, 0.5);
    }

    .vs-bet {
      background: rgba(255, 181, 71, 0.1);
      border: 1px solid rgba(255, 181, 71, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .vs-bet-label {
      font-size: 0.9em;
      color: #a9b5c6;
    }

    .vs-bet-value {
      font-size: 1.5em;
      font-weight: 800;
      color: #ffb547;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      font-weight: 600;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(14, 20, 27, 0.98);
      backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 99;
    }

    .nav-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-around;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      color: #a9b5c6;
      text-decoration: none;
      font-size: 0.75em;
      transition: all 0.3s ease;
    }

    .nav-item:hover, .nav-item.active {
      color: #ffb547;
    }

    .nav-icon {
      font-size: 1.5em;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='painel.html'">‚Üê Voltar</button>
      <div class="logo">‚öΩ Yellup</div>
      <div style="width: 80px;"></div>
    </div>
  </header>

  <!-- Container -->
  <div class="container">
    
    <div class="page-title">
      <h1>‚öîÔ∏è Embates PvP</h1>
      <p>Desafie seus amigos e ganhe cr√©ditos!</p>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="totalBattles">0</div>
        <div class="stat-label">Batalhas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value green" id="totalWins">0</div>
        <div class="stat-label">Vit√≥rias</div>
      </div>
      <div class="stat-item">
        <div class="stat-value red" id="totalLosses">0</div>
        <div class="stat-label">Derrotas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalEarned">0</div>
        <div class="stat-label">üíé Ganhos</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="trocarTab('criar')">‚ûï Criar</button>
      <button class="tab-btn" onclick="trocarTab('recebidos')">üì• Recebidos <span id="badgeRecebidos"></span></button>
      <button class="tab-btn" onclick="trocarTab('historico')">üìú Hist√≥rico</button>
    </div>

    <!-- Tab: Criar Desafio -->
    <div class="tab-content" id="tabCriar">
      <div class="card create-challenge">
        <div class="create-icon">‚öîÔ∏è</div>
        <div class="create-title">Criar Novo Desafio</div>
        <div class="create-desc">
          Desafie um amigo para um duelo de perguntas!<br>
          Quem acertar mais, leva os cr√©ditos apostados.
        </div>
        <button class="btn-create" onclick="abrirModalCriar()">
          ‚öîÔ∏è Criar Desafio
        </button>
        <div class="cost-info">
          O desafiante aposta cr√©ditos. O vencedor leva tudo!
        </div>
      </div>

      <!-- Desafios Enviados Pendentes -->
      <div class="section-title">üì§ Desafios Enviados</div>
      <div id="desafiosEnviados">
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <p>Nenhum desafio enviado</p>
        </div>
      </div>
    </div>

    <!-- Tab: Recebidos -->
    <div class="tab-content" id="tabRecebidos" style="display: none;">
      <div class="section-title">üì• Desafios Recebidos</div>
      <div id="desafiosRecebidos">
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <p>Nenhum desafio recebido</p>
        </div>
      </div>
    </div>

    <!-- Tab: Hist√≥rico -->
    <div class="tab-content" id="tabHistorico" style="display: none;">
      <div class="section-title">üìú Hist√≥rico de Batalhas</div>
      <div id="historicoList">
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <p>Nenhuma batalha realizada ainda</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal Criar Desafio -->
  <div class="modal-overlay" id="modalCriar">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚öîÔ∏è Criar Desafio</div>
        <button class="modal-close" onclick="fecharModal('modalCriar')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Apelido do Oponente</label>
          <input type="text" class="form-input" id="inputOponente" placeholder="Digite o apelido..." oninput="buscarUsuario()">
          <div id="usuarioEncontrado"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Valor da Aposta (cada um aposta)</label>
          <div class="bet-options">
            <div class="bet-option selected" onclick="selecionarAposta(5)" data-bet="5">
              <div class="bet-value">5</div>
              <div class="bet-label">cr√©ditos</div>
            </div>
            <div class="bet-option" onclick="selecionarAposta(10)" data-bet="10">
              <div class="bet-value">10</div>
              <div class="bet-label">cr√©ditos</div>
            </div>
            <div class="bet-option" onclick="selecionarAposta(20)" data-bet="20">
              <div class="bet-value">20</div>
              <div class="bet-label">cr√©ditos</div>
            </div>
          </div>
        </div>

        <div style="background: rgba(255, 181, 71, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
          <div style="font-size: 0.9em; color: #a9b5c6;">Pr√™mio do vencedor:</div>
          <div style="font-size: 1.5em; font-weight: 800; color: #ffb547;" id="premioTotal">üíé 10 cr√©ditos</div>
        </div>

        <button class="btn-send-challenge" id="btnEnviarDesafio" onclick="enviarDesafio()" disabled>
          ‚öîÔ∏è Enviar Desafio
        </button>

        <!-- Compartilhar Link -->
        <div class="share-section">
          <div class="share-title">Ou compartilhe o link do desafio:</div>
          <div class="share-link">
            <input type="text" class="share-input" id="shareLink" readonly value="Crie o desafio para gerar o link">
            <button class="btn-copy" onclick="copiarLink()">üìã Copiar</button>
          </div>
          <div class="share-buttons">
            <button class="share-btn whatsapp" onclick="compartilharWhatsApp()">
              üì± WhatsApp
            </button>
            <button class="share-btn telegram" onclick="compartilharTelegram()">
              ‚úàÔ∏è Telegram
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span>In√≠cio</span>
      </a>
      <a href="ranking-geral.html" class="nav-item">
        <span class="nav-icon">üèÜ</span>
        <span>Ranking</span>
      </a>
      <a href="indicacoes.html" class="nav-item">
        <span class="nav-icon">üîó</span>
        <span>Indicar</span>
      </a>
      <a href="editar-perfil.html" class="nav-item">
        <span class="nav-icon">üë§</span>
        <span>Perfil</span>
      </a>
    </div>
  </nav>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ===================================
    // üî• CONFIGURA√á√ÉO FIREBASE
    // ===================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ===================================
    // üì¶ VARI√ÅVEIS
    // ===================================
    let currentUserId = null;
    let currentUserData = null;
    let oponenteEncontrado = null;
    let apostaAtual = 5;
    let desafioAtualId = null;

    // ===================================
    // üí¨ TOAST
    // ===================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ===================================
    // üîê AUTENTICA√á√ÉO
    // ===================================
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      currentUserId = user.uid;

      try {
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        if (userDoc.exists) {
          currentUserData = userDoc.data();
        }

        carregarEstatisticas();
        carregarDesafios();

      } catch (error) {
        console.error("Erro:", error);
      }
    });

    // ===================================
    // üìä CARREGAR ESTAT√çSTICAS
    // ===================================
    async function carregarEstatisticas() {
      try {
        const pvp = currentUserData.pvp || {};
        
        document.getElementById('totalBattles').textContent = pvp.total || 0;
        document.getElementById('totalWins').textContent = pvp.vitorias || 0;
        document.getElementById('totalLosses').textContent = pvp.derrotas || 0;
        document.getElementById('totalEarned').textContent = pvp.creditosGanhos || 0;

      } catch (error) {
        console.error("Erro:", error);
      }
    }

    // ===================================
    // üìã TROCAR TAB
    // ===================================
    function trocarTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

      event.target.classList.add('active');
      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
    }

    // ===================================
    // üì• CARREGAR DESAFIOS
    // ===================================
    async function carregarDesafios() {
      try {
        // Desafios enviados
        const enviados = await db.collection('desafios')
          .where('desafianteId', '==', currentUserId)
          .where('status', '==', 'pendente')
          .get();

        const containerEnviados = document.getElementById('desafiosEnviados');
        if (enviados.empty) {
          containerEnviados.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p>Nenhum desafio enviado</p>
            </div>
          `;
        } else {
          let html = '';
          enviados.forEach(doc => {
            const d = doc.data();
            html += `
              <div class="challenge-item">
                <div class="challenge-avatar">${d.oponenteNome.charAt(0).toUpperCase()}</div>
                <div class="challenge-info">
                  <div class="challenge-opponent">${d.oponenteNome}</div>
                  <div class="challenge-details">Aposta: ${d.aposta} üíé ‚Ä¢ Aguardando resposta</div>
                </div>
                <span class="challenge-status status-pending">Pendente</span>
              </div>
            `;
          });
          containerEnviados.innerHTML = html;
        }

        // Desafios recebidos
        const recebidos = await db.collection('desafios')
          .where('oponenteId', '==', currentUserId)
          .where('status', '==', 'pendente')
          .get();

        const containerRecebidos = document.getElementById('desafiosRecebidos');
        const badge = document.getElementById('badgeRecebidos');
        
        if (recebidos.empty) {
          containerRecebidos.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p>Nenhum desafio recebido</p>
            </div>
          `;
          badge.textContent = '';
        } else {
          badge.textContent = `(${recebidos.size})`;
          badge.style.color = '#10b981';
          
          let html = '';
          recebidos.forEach(doc => {
            const d = doc.data();
            html += `
              <div class="challenge-item">
                <div class="challenge-avatar">${d.desafianteNome.charAt(0).toUpperCase()}</div>
                <div class="challenge-info">
                  <div class="challenge-opponent">${d.desafianteNome}</div>
                  <div class="challenge-details">Aposta: ${d.aposta} üíé ‚Ä¢ Pr√™mio: ${d.aposta * 2} üíé</div>
                </div>
                <div class="challenge-actions">
                  <button class="btn-accept" onclick="aceitarDesafio('${doc.id}')">‚úÖ Aceitar</button>
                  <button class="btn-decline" onclick="recusarDesafio('${doc.id}')">‚ùå</button>
                </div>
              </div>
            `;
          });
          containerRecebidos.innerHTML = html;
        }

        // Hist√≥rico
        carregarHistorico();

      } catch (error) {
        console.error("Erro:", error);
      }
    }

    // ===================================
    // üìú CARREGAR HIST√ìRICO
    // ===================================
    async function carregarHistorico() {
      try {
        const historico = await db.collection('desafios')
          .where('participantes', 'array-contains', currentUserId)
          .where('status', '==', 'finalizado')
          .orderBy('dataFim', 'desc')
          .limit(20)
          .get();

        const container = document.getElementById('historicoList');
        
        if (historico.empty) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìã</div>
              <p>Nenhuma batalha realizada ainda</p>
            </div>
          `;
          return;
        }

        let html = '';
        historico.forEach(doc => {
          const d = doc.data();
          const venci = d.vencedorId === currentUserId;
          const oponenteNome = d.desafianteId === currentUserId ? d.oponenteNome : d.desafianteNome;
          
          html += `
            <div class="challenge-item">
              <div class="challenge-avatar" style="background: ${venci ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; color: #fff;">
                ${venci ? 'üèÜ' : 'üò¢'}
              </div>
              <div class="challenge-info">
                <div class="challenge-opponent">vs ${oponenteNome}</div>
                <div class="challenge-details">
                  ${venci ? `Voc√™ ganhou ${d.aposta * 2} üíé` : `Voc√™ perdeu ${d.aposta} üíé`}
                </div>
              </div>
              <span class="challenge-status ${venci ? 'status-won' : 'status-lost'}">
                ${venci ? 'Vit√≥ria' : 'Derrota'}
              </span>
            </div>
          `;
        });

        container.innerHTML = html;

      } catch (error) {
        console.error("Erro ao carregar hist√≥rico:", error);
      }
    }

    // ===================================
    // üì± MODAL
    // ===================================
    function abrirModalCriar() {
      document.getElementById('modalCriar').classList.add('active');
      document.getElementById('inputOponente').value = '';
      document.getElementById('usuarioEncontrado').innerHTML = '';
      oponenteEncontrado = null;
      atualizarBotaoEnviar();
    }

    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ===================================
    // üîç BUSCAR USU√ÅRIO
    // ===================================
    let buscaTimeout = null;
    async function buscarUsuario() {
      const apelido = document.getElementById('inputOponente').value.trim().toLowerCase();
      const container = document.getElementById('usuarioEncontrado');
      
      clearTimeout(buscaTimeout);
      
      if (apelido.length < 3) {
        container.innerHTML = '';
        oponenteEncontrado = null;
        atualizarBotaoEnviar();
        return;
      }

      buscaTimeout = setTimeout(async () => {
        try {
          const snapshot = await db.collection('usuarios')
            .where('usuarioUnico', '==', apelido)
            .limit(1)
            .get();

          if (snapshot.empty) {
            container.innerHTML = `
              <div class="user-not-found">
                ‚ùå Usu√°rio n√£o encontrado
              </div>
            `;
            oponenteEncontrado = null;
          } else {
            const doc = snapshot.docs[0];
            const user = doc.data();
            
            if (doc.id === currentUserId) {
              container.innerHTML = `
                <div class="user-not-found">
                  ‚ùå Voc√™ n√£o pode desafiar a si mesmo!
                </div>
              `;
              oponenteEncontrado = null;
            } else {
              oponenteEncontrado = { id: doc.id, ...user };
              container.innerHTML = `
                <div class="user-found">
                  <div class="challenge-avatar" style="width: 40px; height: 40px; font-size: 1em;">
                    ${user.usuarioUnico.charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div style="font-weight: 600;">${user.usuarioUnico}</div>
                    <div style="font-size: 0.8em; color: #a9b5c6;">${user.xp || 0} XP</div>
                  </div>
                  <span style="color: #10b981; margin-left: auto;">‚úÖ</span>
                </div>
              `;
            }
          }

          atualizarBotaoEnviar();

        } catch (error) {
          console.error("Erro ao buscar:", error);
        }
      }, 500);
    }

    // ===================================
    // üí∞ SELECIONAR APOSTA
    // ===================================
    function selecionarAposta(valor) {
      apostaAtual = valor;
      
      document.querySelectorAll('.bet-option').forEach(opt => {
        opt.classList.remove('selected');
        if (parseInt(opt.dataset.bet) === valor) {
          opt.classList.add('selected');
        }
      });

      document.getElementById('premioTotal').textContent = `üíé ${valor * 2} cr√©ditos`;
    }

    // ===================================
    // üîÑ ATUALIZAR BOT√ÉO ENVIAR
    // ===================================
    function atualizarBotaoEnviar() {
      const btn = document.getElementById('btnEnviarDesafio');
      const temCreditos = (currentUserData?.creditos || 0) >= apostaAtual;
      
      btn.disabled = !oponenteEncontrado || !temCreditos;
      
      if (!temCreditos) {
        btn.textContent = '‚ùå Cr√©ditos insuficientes';
      } else if (!oponenteEncontrado) {
        btn.textContent = '‚öîÔ∏è Encontre um oponente';
      } else {
        btn.textContent = `‚öîÔ∏è Desafiar ${oponenteEncontrado.usuarioUnico}`;
      }
    }

    // ===================================
    // ‚öîÔ∏è ENVIAR DESAFIO
    // ===================================
    async function enviarDesafio() {
      if (!oponenteEncontrado) return;

      const creditos = currentUserData?.creditos || 0;
      if (creditos < apostaAtual) {
        showToast('‚ùå Cr√©ditos insuficientes!');
        return;
      }

      try {
        // Criar desafio
        const desafioRef = await db.collection('desafios').add({
          desafianteId: currentUserId,
          desafianteNome: currentUserData.usuarioUnico || 'An√¥nimo',
          oponenteId: oponenteEncontrado.id,
          oponenteNome: oponenteEncontrado.usuarioUnico,
          aposta: apostaAtual,
          status: 'pendente',
          participantes: [currentUserId, oponenteEncontrado.id],
          dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Descontar cr√©ditos do desafiante
        await db.collection('usuarios').doc(currentUserId).update({
          creditos: firebase.firestore.FieldValue.increment(-apostaAtual)
        });

        currentUserData.creditos -= apostaAtual;
        desafioAtualId = desafioRef.id;

        // Atualizar link de compartilhamento
        const baseUrl = window.location.origin + window.location.pathname.replace('embates-pvp.html', '');
        document.getElementById('shareLink').value = `${baseUrl}embates-pvp.html?desafio=${desafioRef.id}`;

        showToast('‚úÖ Desafio enviado!');
        fecharModal('modalCriar');
        carregarDesafios();

      } catch (error) {
        console.error("Erro:", error);
        showToast('‚ùå Erro ao enviar desafio');
      }
    }

    // ===================================
    // ‚úÖ ACEITAR DESAFIO
    // ===================================
    async function aceitarDesafio(desafioId) {
      try {
        const desafioDoc = await db.collection('desafios').doc(desafioId).get();
        const desafio = desafioDoc.data();

        // Verificar cr√©ditos
        if ((currentUserData?.creditos || 0) < desafio.aposta) {
          showToast('‚ùå Cr√©ditos insuficientes!');
          return;
        }

        // Descontar cr√©ditos do oponente
        await db.collection('usuarios').doc(currentUserId).update({
          creditos: firebase.firestore.FieldValue.increment(-desafio.aposta)
        });

        // Atualizar status do desafio
        await db.collection('desafios').doc(desafioId).update({
          status: 'aceito',
          dataAceite: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('‚úÖ Desafio aceito! Preparando batalha...');
        
        // Aqui redirecionaria para a tela de batalha
        // Por enquanto, simula resultado
        setTimeout(() => simularBatalha(desafioId, desafio), 1500);

      } catch (error) {
        console.error("Erro:", error);
        showToast('‚ùå Erro ao aceitar desafio');
      }
    }

    // ===================================
    // ‚ùå RECUSAR DESAFIO
    // ===================================
    async function recusarDesafio(desafioId) {
      if (!confirm('Tem certeza que deseja recusar este desafio?')) return;

      try {
        const desafioDoc = await db.collection('desafios').doc(desafioId).get();
        const desafio = desafioDoc.data();

        // Devolver cr√©ditos ao desafiante
        await db.collection('usuarios').doc(desafio.desafianteId).update({
          creditos: firebase.firestore.FieldValue.increment(desafio.aposta)
        });

        // Deletar desafio
        await db.collection('desafios').doc(desafioId).delete();

        showToast('‚ùå Desafio recusado');
        carregarDesafios();

      } catch (error) {
        console.error("Erro:", error);
        showToast('‚ùå Erro ao recusar desafio');
      }
    }

    // ===================================
    // üéÆ SIMULAR BATALHA (Tempor√°rio)
    // ===================================
    async function simularBatalha(desafioId, desafio) {
      // Simula um vencedor aleat√≥rio (depois voc√™ implementa o quiz real)
      const vencedorId = Math.random() > 0.5 ? currentUserId : desafio.desafianteId;
      const perdedorId = vencedorId === currentUserId ? desafio.desafianteId : currentUserId;
      const premio = desafio.aposta * 2;

      try {
        // Dar pr√™mio ao vencedor
        await db.collection('usuarios').doc(vencedorId).update({
          creditos: firebase.firestore.FieldValue.increment(premio),
          'pvp.total': firebase.firestore.FieldValue.increment(1),
          'pvp.vitorias': firebase.firestore.FieldValue.increment(1),
          'pvp.creditosGanhos': firebase.firestore.FieldValue.increment(premio)
        });

        // Atualizar estat√≠sticas do perdedor
        await db.collection('usuarios').doc(perdedorId).update({
          'pvp.total': firebase.firestore.FieldValue.increment(1),
          'pvp.derrotas': firebase.firestore.FieldValue.increment(1)
        });

        // Finalizar desafio
        await db.collection('desafios').doc(desafioId).update({
          status: 'finalizado',
          vencedorId: vencedorId,
          dataFim: firebase.firestore.FieldValue.serverTimestamp()
        });

        if (vencedorId === currentUserId) {
          showToast(`üèÜ Voc√™ venceu! +${premio} cr√©ditos!`);
        } else {
          showToast(`üò¢ Voc√™ perdeu! -${desafio.aposta} cr√©ditos`);
        }

        // Recarregar dados
        const userDoc = await db.collection('usuarios').doc(currentUserId).get();
        currentUserData = userDoc.data();
        carregarEstatisticas();
        carregarDesafios();

      } catch (error) {
        console.error("Erro:", error);
      }
    }

    // ===================================
    // üìã COPIAR LINK
    // ===================================
    function copiarLink() {
      const input = document.getElementById('shareLink');
      input.select();
      document.execCommand('copy');
      showToast('üìã Link copiado!');
    }

    // ===================================
    // üì± COMPARTILHAR
    // ===================================
    function compartilharWhatsApp() {
      const link = document.getElementById('shareLink').value;
      const texto = encodeURIComponent(`‚öîÔ∏è Te desafio para um duelo no Yellup! Aceita?\n\n${link}`);
      window.open(`https://wa.me/?text=${texto}`, '_blank');
    }

    function compartilharTelegram() {
      const link = document.getElementById('shareLink').value;
      const texto = encodeURIComponent(`‚öîÔ∏è Te desafio para um duelo no Yellup!`);
      window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${texto}`, '_blank');
    }

    // ===================================
    // üîó VERIFICAR LINK DE DESAFIO
    // ===================================
    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      const desafioId = params.get('desafio');
      
      if (desafioId) {
        // Carregar desafio espec√≠fico
        trocarTab('recebidos');
      }
    });

    console.log("‚úÖ Embates PvP v1.0");
  </script>

</body>
</html>
