<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e13">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#070b10;--card:#0f1419;--card2:#151d28;--accent:#ff9f43;--accent2:#ffc048;--green:#2ed573;--red:#ff4757;--blue:#3b82f6;--purple:#a855f7;--txt:#f1f2f6;--txt2:#8899aa;--border:rgba(255,255,255,0.06)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;padding-bottom:100px}

    .header{background:rgba(7,11,16,0.96);backdrop-filter:blur(20px);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid var(--border)}
    .header-inner{max-width:700px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.3em;font-weight:800;color:var(--accent)}
    .btn-back{padding:8px 16px;background:rgba(255,255,255,0.08);border:none;border-radius:8px;color:var(--txt);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.85em;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all 0.3s}
    .btn-back:hover{background:rgba(255,255,255,0.15)}

    .container{max-width:700px;margin:0 auto;padding:20px 16px}

    .page-hero{text-align:center;padding:24px 20px;margin-bottom:24px;background:linear-gradient(145deg,rgba(255,159,67,0.08),rgba(168,85,247,0.05));border:1px solid rgba(255,159,67,0.15);border-radius:20px}
    .page-hero h1{font-size:1.5em;font-weight:800;margin-bottom:4px}
    .page-hero p{color:var(--txt2);font-size:0.85em}

    /* My Stats Card */
    .my-stats{background:linear-gradient(145deg,var(--card),var(--card2));border:1px solid rgba(255,159,67,0.2);border-radius:18px;padding:20px;margin-bottom:24px}
    .my-stats-header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
    .my-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ff8c42);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1em;color:var(--bg)}
    .my-info h3{font-size:1.05em;font-weight:700}.my-info p{font-size:0.75em;color:var(--txt2)}
    .my-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .my-stat{background:rgba(0,0,0,0.3);border-radius:12px;padding:10px 6px;text-align:center}
    .my-stat .val{font-size:1.15em;font-weight:800}.my-stat .lbl{font-size:0.6em;color:var(--txt2);margin-top:2px}
    .my-stat .val.grn{color:var(--green)}.my-stat .val.red{color:var(--red)}.my-stat .val.blu{color:var(--blue)}.my-stat .val.org{color:var(--accent)}.my-stat .val.pur{color:var(--purple)}

    /* Filters */
    .filters{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
    .filter-btn{padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:var(--txt2);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.78em;transition:all 0.3s;white-space:nowrap}
    .filter-btn.active{background:rgba(255,159,67,0.15);border-color:var(--accent);color:var(--accent)}

    /* Ranking Table */
    .rank-header{display:grid;grid-template-columns:40px 1fr 60px 55px 55px 55px;gap:6px;padding:8px 14px;font-size:0.65em;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:0.5px}
    .rank-row{display:grid;grid-template-columns:40px 1fr 60px 55px 55px 55px;gap:6px;align-items:center;padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:6px;transition:all 0.2s}
    .rank-row:hover{border-color:rgba(255,159,67,0.2)}
    .rank-row.me{border-color:rgba(255,159,67,0.3);background:linear-gradient(145deg,rgba(255,159,67,0.06),var(--card))}
    .rank-row.top1{border-color:rgba(255,215,0,0.3);background:linear-gradient(145deg,rgba(255,215,0,0.06),var(--card))}
    .rank-row.top2{border-color:rgba(192,192,192,0.3)}
    .rank-row.top3{border-color:rgba(205,127,50,0.3)}
    .rank-pos{font-weight:800;font-size:1.1em;text-align:center}
    .rank-pos.g{color:#ffd700}.rank-pos.s{color:#c0c0c0}.rank-pos.b{color:#cd7f32}
    .rank-player{display:flex;align-items:center;gap:10px;overflow:hidden}
    .rank-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75em;color:white;flex-shrink:0}
    .rank-name{font-weight:600;font-size:0.85em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rank-team{font-size:0.6em;color:var(--txt2)}
    .rank-val{text-align:center;font-weight:700;font-size:0.82em}
    .rank-val.grn{color:var(--green)}.rank-val.red{color:var(--red)}.rank-val.blu{color:var(--blue)}.rank-val.org{color:var(--accent)}

    .loading{text-align:center;padding:60px 20px;color:var(--txt2)}
    .loading .spinner{display:inline-block;width:28px;height:28px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--accent);border-radius:50%;animation:sp 0.7s linear infinite;margin-bottom:12px}
    @keyframes sp{to{transform:rotate(360deg)}}

    .empty{text-align:center;padding:50px 20px;color:var(--txt2)}.empty .icon{font-size:3em;margin-bottom:10px}

    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,0.9);color:white;padding:14px 28px;border-radius:50px;font-weight:600;font-size:0.85em;z-index:3000;opacity:0;transition:all 0.3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(14,20,27,0.98);backdrop-filter:blur(20px);padding:10px 20px;border-top:1px solid rgba(255,255,255,0.1);z-index:99}
    .nav-content{max-width:600px;margin:0 auto;display:flex;justify-content:space-around}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:#a9b5c6;text-decoration:none;font-size:0.7em;transition:all 0.3s;padding:4px 10px}
    .nav-item:hover,.nav-item.active{color:var(--accent)}.nav-icon{font-size:1.5em}

    @media(max-width:420px){
      .rank-header,.rank-row{grid-template-columns:32px 1fr 48px 45px 45px 45px;gap:4px;padding:10px 10px;font-size:0.95em}
      .rank-name{font-size:0.78em}.rank-val{font-size:0.75em}
      .my-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="header"><div class="header-inner">
    <span class="logo">üèÜ Ranking P√™naltis</span>
    <a href="penaltis.html" class="btn-back">‚Üê Voltar</a>
  </div></div>

  <div class="container">
    <div class="page-hero">
      <h1>ü•Ö Ranking de P√™naltis</h1>
      <p>Os melhores cobradores e goleiros da plataforma</p>
    </div>

    <div class="my-stats" id="myStatsCard" style="display:none">
      <div class="my-stats-header">
        <div class="my-avatar" id="myAvatar">?</div>
        <div class="my-info"><h3 id="myName">Carregando...</h3><p id="myPosition">-</p></div>
      </div>
      <div class="my-grid" id="myGrid"></div>
    </div>

    <div class="filters">
      <button class="filter-btn active" onclick="setFilter('vitorias')">üèÜ Vit√≥rias</button>
      <button class="filter-btn" onclick="setFilter('winrate')">üìä Win Rate</button>
      <button class="filter-btn" onclick="setFilter('gols')">‚öΩ Gols</button>
      <button class="filter-btn" onclick="setFilter('defesas')">üß§ Defesas</button>
      <button class="filter-btn" onclick="setFilter('aproveitamento')">üéØ Aproveitamento</button>
    </div>

    <div class="rank-header">
      <span>#</span><span>Jogador</span><span>W-L</span><span>Win%</span><span>‚öΩ</span><span>üß§</span>
    </div>

    <div id="rankingList">
      <div class="loading"><div class="spinner"></div><br>Carregando ranking...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <nav class="bottom-nav"><div class="nav-content">
    <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
    <a href="penaltis.html" class="nav-item"><span class="nav-icon">‚öΩ</span>P√™naltis</a>
    <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
    <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
  </div></nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    var db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(e){console.error(e)});

    var currentUser=null,playerStats={},sortedPlayers=[],currentFilter='vitorias';

    auth.onAuthStateChanged(function(user){
      if(!user){window.location.href='index.html';return}
      currentUser=user;
      carregarDados();
    });

    async function carregarDados(){
      try{
        // Load all finalized penalty matches
        var snap=await db.collection('penaltis').where('status','==','finalizado').get();
        var stats={};

        snap.forEach(function(doc){
          var d=doc.data();
          if(!d.jogador1||!d.jogador2||!d.vencedor) return;
          if(d.tipo==='treino') return; // ü§ñ Excluir treinos do ranking

          var p1uid=d.jogador1.uid, p2uid=d.jogador2.uid;
          if(p1uid.startsWith('bot_')||p2uid.startsWith('bot_')) return; // ü§ñ Excluir bots
          var p1nome=d.jogador1.nome, p2nome=d.jogador2.nome;
          var p1time=d.jogador1.time||null, p2time=d.jogador2.time||null;
          var p1avatar=d.jogador1.avatarUrl||null, p2avatar=d.jogador2.avatarUrl||null;

          // Initialize players
          if(!stats[p1uid]) stats[p1uid]=newPlayer(p1nome);
          if(!stats[p2uid]) stats[p2uid]=newPlayer(p2nome);

          // Update names (use latest)
          stats[p1uid].nome=p1nome;
          stats[p2uid].nome=p2nome;
          if(p1time) stats[p1uid].time=p1time;
          if(p2time) stats[p2uid].time=p2time;
          if(p1avatar) stats[p1uid].avatarUrl=p1avatar;
          if(p2avatar) stats[p2uid].avatarUrl=p2avatar;

          // Wins/losses
          stats[p1uid].jogos++;
          stats[p2uid].jogos++;
          if(d.vencedor==='empate_timeout'){
            // Draw - no win/loss
          }else if(d.vencedor===p1uid){stats[p1uid].vitorias++;stats[p2uid].derrotas++}
          else{stats[p2uid].vitorias++;stats[p1uid].derrotas++}

          // Credits (v2: pr√™mio do sistema para vencedor, taxa queimada para perdedor)
          var premioSistema=d.premioSistema||4;
          var taxa=d.valorAposta||2;
          if(d.vencedor===p1uid){stats[p1uid].credGanhos+=premioSistema;stats[p2uid].credPerdidos+=taxa}
          else if(d.vencedor===p2uid){stats[p2uid].credGanhos+=premioSistema;stats[p1uid].credPerdidos+=taxa}

          // Per-round stats
          var rodadas=d.rodadas||[];
          rodadas.forEach(function(r){
            var cobrador=r.cobrador;
            var goleiro=cobrador==='jogador1'?'jogador2':'jogador1';
            var cobUid=d[cobrador].uid;
            var golUid=d[goleiro].uid;

            stats[cobUid].totalChutes++;
            stats[golUid].totalDefesas++;
            if(r.gol){
              stats[cobUid].gols++;
            }else{
              stats[golUid].defesas++;
            }

            // Track zones
            if(r.chute) stats[cobUid].chuteZones[r.chute]=(stats[cobUid].chuteZones[r.chute]||0)+1;
            if(r.defesa) stats[golUid].defesaZones[r.defesa]=(stats[golUid].defesaZones[r.defesa]||0)+1;
          });
        });

        // Compute derived stats
        Object.keys(stats).forEach(function(uid){
          var s=stats[uid];
          s.winRate=s.jogos>0?Math.round(s.vitorias/s.jogos*100):0;
          s.aprovChute=s.totalChutes>0?Math.round(s.gols/s.totalChutes*100):0;
          s.aprovDefesa=s.totalDefesas>0?Math.round(s.defesas/s.totalDefesas*100):0;
          // Favorite zones
          s.chuteF=bestZone(s.chuteZones);
          s.defesaF=bestZone(s.defesaZones);
          // Win streak (approximate from sorted matches - not perfect but useful)
        });

        playerStats=stats;
        sortAndRender();
        renderMyStats();
      }catch(e){
        console.error('Load error:',e);
        document.getElementById('rankingList').innerHTML='<div class="empty"><div class="icon">‚ùå</div><p>Erro ao carregar. Tente novamente.</p></div>';
      }
    }

    function newPlayer(nome){
      return{nome:nome,time:null,avatarUrl:null,jogos:0,vitorias:0,derrotas:0,gols:0,totalChutes:0,defesas:0,totalDefesas:0,winRate:0,aprovChute:0,aprovDefesa:0,credGanhos:0,credPerdidos:0,chuteZones:{},defesaZones:{},chuteF:'',defesaF:''};
    }

    function bestZone(zones){
      var best='',max=0;
      Object.keys(zones).forEach(function(k){if(zones[k]>max){max=zones[k];best=k}});
      return best;
    }

    var ZONE_NAMES={TL:'‚Üñ Esq Alto',TC:'‚¨Ü Centro Alto',TR:'‚Üó Dir Alto',ML:'‚¨Ö Esq Meio',MC:'‚óè Centro',MR:'‚û° Dir Meio',BL:'‚Üô Esq Baixo',BC:'‚¨á Centro Baixo',BR:'‚Üò Dir Baixo'};

    function setFilter(f){
      currentFilter=f;
      document.querySelectorAll('.filter-btn').forEach(function(b){b.classList.remove('active')});
      event.target.classList.add('active');
      sortAndRender();
    }

    function sortAndRender(){
      var arr=Object.keys(playerStats).map(function(uid){return{uid:uid,s:playerStats[uid]}});

      // Minimum 1 game to appear
      arr=arr.filter(function(x){return x.s.jogos>=1});

      var sortFn={
        vitorias:function(a,b){return b.s.vitorias-a.s.vitorias||b.s.winRate-a.s.winRate},
        winrate:function(a,b){return b.s.winRate-a.s.winRate||b.s.vitorias-a.s.vitorias},
        gols:function(a,b){return b.s.gols-a.s.gols||b.s.aprovChute-a.s.aprovChute},
        defesas:function(a,b){return b.s.defesas-a.s.defesas||b.s.aprovDefesa-a.s.aprovDefesa},
        aproveitamento:function(a,b){return b.s.aprovChute-a.s.aprovChute||b.s.gols-a.s.gols}
      };

      arr.sort(sortFn[currentFilter]||sortFn.vitorias);
      sortedPlayers=arr;

      var container=document.getElementById('rankingList');
      if(!arr.length){
        container.innerHTML='<div class="empty"><div class="icon">‚öΩ</div><p>Nenhuma disputa finalizada ainda</p></div>';
        return;
      }

      var html='';
      arr.forEach(function(item,i){
        var s=item.s, pos=i+1;
        var isMe=item.uid===currentUser.uid;
        var posClass=pos===1?'g':pos===2?'s':pos===3?'b':'';
        var rowClass=isMe?'me':pos===1?'top1':pos===2?'top2':pos===3?'top3':'';
        var medal=pos===1?'ü•á':pos===2?'ü•à':pos===3?'ü•â':pos;
        var colors=['#2563eb','#dc2626','#16a34a','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#84cc16'];
        var avatarColor=s.time?s.time.primaria:colors[pos%colors.length];
        var ini=(s.nome||'?').charAt(0).toUpperCase();
        var teamBadge=s.time?'<div class="rank-team">'+s.time.nome+'</div>':'';

        html+='<div class="rank-row '+rowClass+'">'+
          '<div class="rank-pos '+posClass+'">'+medal+'</div>'+
          '<div class="rank-player">'+
            '<div class="rank-avatar" style="background:linear-gradient(135deg,'+avatarColor+','+(s.time?s.time.secundaria||avatarColor:avatarColor)+'80)">'+(s.avatarUrl?'<img src="'+s.avatarUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':ini)+'</div>'+
            '<div><div class="rank-name">'+s.nome+(isMe?' (voc√™)':'')+'</div>'+teamBadge+'</div>'+
          '</div>'+
          '<div class="rank-val">'+s.vitorias+'-'+s.derrotas+'</div>'+
          '<div class="rank-val '+(s.winRate>=50?'grn':'red')+'">'+s.winRate+'%</div>'+
          '<div class="rank-val org">'+s.gols+'</div>'+
          '<div class="rank-val blu">'+s.defesas+'</div>'+
        '</div>';
      });

      container.innerHTML=html;
    }

    function renderMyStats(){
      var s=playerStats[currentUser.uid];
      if(!s){document.getElementById('myStatsCard').style.display='none';return}

      document.getElementById('myStatsCard').style.display='block';
      var myAvatarEl=document.getElementById('myAvatar');
      if(s.avatarUrl){
        myAvatarEl.innerHTML='<img src="'+s.avatarUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
      }else{
        myAvatarEl.textContent=(s.nome||'?').charAt(0).toUpperCase();
      }
      document.getElementById('myName').textContent=s.nome||'Voc√™';

      // Find position
      var pos=sortedPlayers.findIndex(function(x){return x.uid===currentUser.uid})+1;
      document.getElementById('myPosition').textContent=pos>0?'#'+pos+' no ranking de '+currentFilter:'Sem posi√ß√£o';

      document.getElementById('myGrid').innerHTML=
        '<div class="my-stat"><div class="val grn">'+s.vitorias+'</div><div class="lbl">Vit√≥rias</div></div>'+
        '<div class="my-stat"><div class="val red">'+s.derrotas+'</div><div class="lbl">Derrotas</div></div>'+
        '<div class="my-stat"><div class="val org">'+s.winRate+'%</div><div class="lbl">Win Rate</div></div>'+
        '<div class="my-stat"><div class="val blu">'+s.jogos+'</div><div class="lbl">Partidas</div></div>'+
        '<div class="my-stat"><div class="val grn">'+s.gols+'/'+s.totalChutes+'</div><div class="lbl">Gols ('+s.aprovChute+'%)</div></div>'+
        '<div class="my-stat"><div class="val blu">'+s.defesas+'/'+s.totalDefesas+'</div><div class="lbl">Defesas ('+s.aprovDefesa+'%)</div></div>'+
        '<div class="my-stat"><div class="val org">'+(s.chuteF?ZONE_NAMES[s.chuteF]||s.chuteF:'‚Äî')+'</div><div class="lbl">Chute Favorito</div></div>'+
        '<div class="my-stat"><div class="val pur">+'+s.credGanhos+'</div><div class="lbl">Cr√©ditos Ganhos</div></div>';
    }
  </script>
</body>
</html>
