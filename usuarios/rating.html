<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rating - Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0e141b;
      --bg-secondary: #1a2332;
      --bg-card: #232d3f;
      --text-primary: #e7eef7;
      --text-secondary: #a9b5c6;
      --accent: #ffb547;
      --accent-dark: #ff8c42;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --faixa-color: #6b7280;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
      overflow-x: hidden;
    }

    /* ===== HEADER ===== */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .header-content {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo-text { font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 1.2em; }
    .logo-text span { color: var(--accent); }
    .logo-badge {
      font-size: 0.6em; font-weight: 600;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #111; padding: 2px 8px; border-radius: 6px;
      letter-spacing: 1px;
    }
    .btn-voltar {
      background: rgba(255,255,255,0.08); border: none; color: var(--text-primary);
      padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit;
      font-size: 0.85em; transition: 0.2s;
    }
    .btn-voltar:hover { background: rgba(255,255,255,0.15); }

    /* ===== HERO - RATING DISPLAY ===== */
    .hero {
      position: relative;
      padding: 50px 20px 30px;
      text-align: center;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -100px; left: 50%; transform: translateX(-50%);
      width: 600px; height: 600px;
      background: radial-gradient(circle, var(--faixa-color) 0%, transparent 70%);
      opacity: 0.08;
      pointer-events: none;
    }

    .rating-ring-container {
      position: relative;
      width: 220px; height: 220px;
      margin: 0 auto 20px;
    }
    .rating-ring {
      width: 100%; height: 100%;
      transform: rotate(-90deg);
    }
    .ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 8; }
    .ring-progress {
      fill: none; stroke: var(--faixa-color); stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 628;
      transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 0 8px var(--faixa-color));
    }
    .rating-number-container {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .rating-number {
      font-family: 'Orbitron', sans-serif;
      font-size: 3.5em; font-weight: 900;
      line-height: 1;
      background: linear-gradient(135deg, var(--faixa-color), #fff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .rating-label {
      font-size: 0.7em; color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 2px; margin-top: 2px;
    }

    .faixa-badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 22px; border-radius: 30px;
      font-weight: 700; font-size: 1.05em;
      letter-spacing: 1px; text-transform: uppercase;
      background: linear-gradient(135deg, var(--faixa-color), rgba(255,255,255,0.1));
      color: #fff;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 0 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      animation: faixaPulse 3s ease-in-out infinite;
    }
    @keyframes faixaPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(0,0,0,0.3), 0 0 0 0 var(--faixa-color); }
      50% { box-shadow: 0 0 20px rgba(0,0,0,0.3), 0 0 15px 2px var(--faixa-color); }
    }

    .rating-meta {
      margin-top: 15px;
      display: flex; justify-content: center; gap: 25px;
      font-size: 0.8em; color: var(--text-secondary);
    }
    .rating-meta strong { color: var(--text-primary); }

    /* ===== CONTAINER ===== */
    .container { max-width: 1000px; margin: 0 auto; padding: 0 15px; }

    /* ===== RADAR CHART ===== */
    .radar-section {
      background: var(--bg-secondary);
      border-radius: 18px; padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .section-title {
      font-size: 1em; font-weight: 700;
      margin-bottom: 18px; color: var(--text-primary);
      display: flex; align-items: center; gap: 8px;
    }

    .radar-wrapper {
      display: flex; align-items: center; gap: 20px;
      flex-wrap: wrap; justify-content: center;
    }
    .radar-svg-container {
      width: 280px; height: 280px; flex-shrink: 0;
    }
    .radar-labels { flex: 1; min-width: 240px; }

    .component-row {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .component-row:last-child { border-bottom: none; }
    .comp-icon { font-size: 1.2em; width: 28px; text-align: center; }
    .comp-info { flex: 1; }
    .comp-name { font-size: 0.8em; font-weight: 600; }
    .comp-bar-bg {
      height: 6px; background: rgba(255,255,255,0.08);
      border-radius: 3px; margin-top: 3px; overflow: hidden;
    }
    .comp-bar {
      height: 100%; border-radius: 3px;
      transition: width 1s ease-out;
      background: linear-gradient(90deg, var(--faixa-color), rgba(255,255,255,0.3));
    }
    .comp-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85em; font-weight: 700;
      min-width: 40px; text-align: right;
    }
    .comp-weight {
      font-size: 0.6em; color: var(--text-secondary);
      min-width: 30px; text-align: right;
    }

    /* ===== HISTORY CHART ===== */
    .history-section {
      background: var(--bg-secondary);
      border-radius: 18px; padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .chart-container {
      height: 180px; position: relative;
      margin-top: 10px;
    }
    .chart-canvas { width: 100%; height: 100%; }

    /* ===== DECAY INFO ===== */
    .decay-card {
      background: var(--bg-secondary);
      border-radius: 18px; padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      display: flex; align-items: center; gap: 15px;
    }
    .decay-icon { font-size: 2em; }
    .decay-info { flex: 1; }
    .decay-title { font-size: 0.85em; font-weight: 600; }
    .decay-text { font-size: 0.75em; color: var(--text-secondary); margin-top: 2px; }
    .decay-status {
      padding: 5px 14px; border-radius: 20px;
      font-size: 0.75em; font-weight: 700;
    }
    .decay-safe { background: rgba(16,185,129,0.15); color: var(--success); }
    .decay-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .decay-danger { background: rgba(239,68,68,0.15); color: var(--danger); }

    /* ===== RANKING POSITION ===== */
    .ranking-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
      border-radius: 18px; padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
      display: flex; align-items: center; gap: 15px;
      cursor: pointer; transition: 0.2s;
    }
    .ranking-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .ranking-pos {
      font-family: 'Orbitron', sans-serif;
      font-size: 2em; font-weight: 900;
      color: var(--accent);
      min-width: 60px; text-align: center;
    }
    .ranking-info { flex: 1; }
    .ranking-label { font-size: 0.8em; color: var(--text-secondary); }
    .ranking-detail { font-size: 0.85em; font-weight: 600; }
    .ranking-arrow { font-size: 1.5em; color: var(--text-secondary); }

    /* ===== RESET INFO ===== */
    .reset-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1));
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: 18px; padding: 18px 20px;
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 12px;
      font-size: 0.8em;
    }
    .reset-icon { font-size: 1.8em; }
    .reset-info { flex: 1; }
    .reset-title { font-weight: 600; color: var(--info); }
    .reset-text { color: var(--text-secondary); margin-top: 2px; font-size: 0.9em; }

    /* ===== FAIXAS GUIDE ===== */
    .faixas-section {
      background: var(--bg-secondary);
      border-radius: 18px; padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .faixa-row {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 12px; border-radius: 10px;
      margin-bottom: 6px; transition: 0.2s;
    }
    .faixa-row.active { background: rgba(255,255,255,0.05); transform: scale(1.02); }
    .faixa-dot {
      width: 12px; height: 12px; border-radius: 50%;
      flex-shrink: 0;
    }
    .faixa-name { font-weight: 600; font-size: 0.85em; flex: 1; }
    .faixa-range { font-size: 0.75em; color: var(--text-secondary); font-family: 'Orbitron', sans-serif; }

    /* ===== LOADING ===== */
    .loading-overlay {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 60vh; gap: 15px;
    }
    .spinner {
      width: 40px; height: 40px; border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== TOAST ===== */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--bg-card); color: var(--text-primary);
      padding: 12px 24px; border-radius: 12px; font-size: 0.9em;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 9999; transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 600px) {
      .hero { padding: 35px 15px 20px; }
      .rating-ring-container { width: 180px; height: 180px; }
      .rating-number { font-size: 2.8em; }
      .radar-svg-container { width: 230px; height: 230px; }
      .rating-meta { flex-wrap: wrap; gap: 12px; }
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in {
      animation: fadeInUp 0.5s ease-out both;
    }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
    .delay-5 { animation-delay: 0.5s; }
    .delay-6 { animation-delay: 0.6s; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo-text"><span>YELLUP</span> <span class="logo-badge">RATING</span></div>
      </div>
      <button class="btn-voltar" onclick="window.history.back()">‚Üê Voltar</button>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <span style="color: var(--text-secondary); font-size: 0.85em;">Calculando seu Rating...</span>
  </div>

  <!-- MAIN CONTENT (hidden until loaded) -->
  <div id="mainContent" style="display: none;">

    <!-- HERO -->
    <div class="hero animate-in">
      <div class="rating-ring-container">
        <svg class="rating-ring" viewBox="0 0 220 220">
          <circle class="ring-bg" cx="110" cy="110" r="100" />
          <circle class="ring-progress" id="ratingRing" cx="110" cy="110" r="100" />
        </svg>
        <div class="rating-number-container">
          <div class="rating-number" id="ratingNumber">0</div>
          <div class="rating-label">Rating</div>
        </div>
      </div>
      <div class="faixa-badge" id="faixaBadge">
        <span id="faixaIcon">‚öΩ</span>
        <span id="faixaNome">Carregando...</span>
      </div>
      <div class="rating-meta">
        <span>üèÜ Posi√ß√£o: <strong id="rankPosition">-</strong></span>
        <span>üìÖ Atualizado: <strong id="lastUpdate">-</strong></span>
        <span id="decayMeta" style="display:none;">‚è≥ Decay: <strong id="decayDays">0</strong> dias</span>
      </div>
    </div>

    <div class="container">

      <!-- RADAR + COMPONENTS -->
      <div class="radar-section animate-in delay-1">
        <div class="section-title">üìä Breakdown do Rating</div>
        <div class="radar-wrapper">
          <div class="radar-svg-container">
            <svg id="radarChart" viewBox="0 0 300 300" style="width:100%;height:100%;"></svg>
          </div>
          <div class="radar-labels" id="componentsList"></div>
        </div>
      </div>

      <!-- DECAY -->
      <div class="decay-card animate-in delay-2" id="decayCard">
        <div class="decay-icon">üõ°Ô∏è</div>
        <div class="decay-info">
          <div class="decay-title" id="decayTitle">Ativo</div>
          <div class="decay-text" id="decayText">Jogando regularmente ‚Äî sem penalidade!</div>
        </div>
        <div class="decay-status decay-safe" id="decayBadge">Seguro</div>
      </div>

      <!-- RANKING -->
      <div class="ranking-card animate-in delay-3" onclick="window.location.href='ranking.html'" style="cursor:pointer;">
        <div class="ranking-pos" id="rankPos">#-</div>
        <div class="ranking-info">
          <div class="ranking-label">Posi√ß√£o no Ranking Global</div>
          <div class="ranking-detail" id="rankDetail">Carregando...</div>
        </div>
        <div style="font-size:1.2em;color:var(--text-secondary);">‚Ä∫</div>
      </div>

      <!-- ADMIN: CALCULAR MANUAL -->
      <div id="adminPanel" style="display:none; margin-bottom:20px;">
        <div style="background:linear-gradient(135deg, rgba(239,68,68,0.1), rgba(245,158,11,0.1)); border:1px solid rgba(239,68,68,0.2); border-radius:18px; padding:18px 20px;">
          <div style="font-size:0.85em;font-weight:700;color:var(--danger);margin-bottom:8px;">‚öôÔ∏è Admin ‚Äî Testar Rating</div>
          <div style="font-size:0.75em;color:var(--text-secondary);margin-bottom:12px;">Executa o c√°lculo de rating para TODOS os usu√°rios agora (mesmo efeito do cron di√°rio)</div>
          <button id="btnCalcular" onclick="calcularRatingManual()" style="
            background:linear-gradient(135deg, var(--danger), var(--accent-dark));
            border:none; color:#fff; padding:10px 20px; border-radius:10px;
            font-family:inherit; font-weight:700; font-size:0.85em;
            cursor:pointer; width:100%; transition:0.2s;
          ">üéØ Calcular Rating Agora</button>
          <div id="calcResultado" style="margin-top:10px;font-size:0.75em;color:var(--text-secondary);display:none;"></div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="history-section animate-in delay-4">
        <div class="section-title">üìà Evolu√ß√£o (√∫ltimos 30 dias)</div>
        <div class="chart-container">
          <canvas id="historyChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- RESET INFO -->
      <div class="reset-card animate-in delay-5">
        <div class="reset-icon">üîÑ</div>
        <div class="reset-info">
          <div class="reset-title">Soft Reset em <span id="resetDias">-</span> dias</div>
          <div class="reset-text">No dia 1¬∫ do m√™s, o rating √© comprimido. Quem est√° no topo perde mais, quem est√° embaixo ganha uma base de 100 pontos. A corrida recome√ßa!</div>
        </div>
      </div>

      <!-- FAIXAS GUIDE -->
      <div class="faixas-section animate-in delay-6">
        <div class="section-title">üèÖ Faixas de Rating</div>
        <div id="faixasGuide"></div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // ==================== FAIXAS ====================
    const FAIXAS = [
      { nome: 'Imortal',   icon: 'üèÜ', min: 850, max: 1000, color: '#dc2626' },
      { nome: 'Lenda',     icon: 'üî¥', min: 650, max: 849,  color: '#ea580c' },
      { nome: 'Fen√¥meno',  icon: 'üü†', min: 450, max: 649,  color: '#eab308' },
      { nome: 'Craque',    icon: 'üü°', min: 250, max: 449,  color: '#3b82f6' },
      { nome: 'Titular',   icon: 'üü¢', min: 100, max: 249,  color: '#10b981' },
      { nome: 'Reserva',   icon: '‚öΩ', min: 0,   max: 99,   color: '#6b7280' },
    ];

    const COMPONENTES = [
      { key: 'quiz',         nome: 'Quiz + XP',     icon: 'üß†', peso: 0.20 },
      { key: 'pvp',          nome: 'PvP',            icon: '‚öîÔ∏è', peso: 0.15 },
      { key: 'consistencia', nome: 'Consist√™ncia',   icon: 'üìÖ', peso: 0.15 },
      { key: 'torcida',      nome: 'Torcida',        icon: 'üì£', peso: 0.12 },
      { key: 'comunidade',   nome: 'Chat + Indica√ß√£o', icon: 'üí¨', peso: 0.10 },
      { key: 'torneios',     nome: 'Torneios',       icon: 'üèÜ', peso: 0.10 },
      { key: 'explorador',   nome: 'Explorador',     icon: 'üåü', peso: 0.10 },
      { key: 'missoes',      nome: 'Miss√µes',        icon: 'üéØ', peso: 0.08 },
    ];

    function getFaixa(rating) {
      return FAIXAS.find(f => rating >= f.min && rating <= f.max) || FAIXAS[FAIXAS.length - 1];
    }

    // ==================== AUTH ====================
    let currentUser = null;
    let currentUserData = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await carregarRating();
      } else {
        window.location.href = 'index.html';
      }
    });

    // ==================== CARREGAR RATING ====================
    async function carregarRating() {
      try {
        // 1. Buscar dados do usu√°rio (rating j√° est√° nos campos)
        const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
        if (!userDoc.exists) { showToast('Usu√°rio n√£o encontrado'); return; }
        currentUserData = userDoc.data();

        const ratingData = {
          ratingFinal: currentUserData.rating || 0,
          faixa: currentUserData.ratingFaixa || 'Reserva',
          componentes: currentUserData.ratingComponents || { quiz: 0, pvp: 0, torneios: 0, torcida: 0, comunidade: 0, missoes: 0, consistencia: 0, explorador: 0 },
          historico: currentUserData.ratingHistory || [],
          variacao: currentUserData.ratingVariacao || 0,
          diasInativo: 0,
          ultimoCalculo: null
        };

        // Calcular dias inativo
        const stats = currentUserData.stats || {};
        const ultimoLogin = stats.ultimoLogin?.toDate?.() || null;
        if (ultimoLogin) {
          ratingData.diasInativo = Math.floor((new Date() - ultimoLogin) / (1000 * 60 * 60 * 24));
        }

        // 2. Buscar posi√ß√£o no ranking via usuarios (mais seguro que ratingRanking)
        let posicao = null;
        let totalJogadores = 0;
        try {
          if (ratingData.ratingFinal > 0) {
            const superiores = await db.collection('usuarios')
              .where('rating', '>', ratingData.ratingFinal)
              .get();
            posicao = superiores.size + 1;
          }
          const todos = await db.collection('usuarios')
            .where('rating', '>', 0)
            .get();
          totalJogadores = todos.size;
          if (!posicao && ratingData.ratingFinal > 0) posicao = totalJogadores;
        } catch (e) {
          console.log('Ranking query:', e.message);
        }

        // 3. Renderizar
        renderizarRating(ratingData, posicao, totalJogadores);

        // 4. Se admin, mostrar bot√£o de c√°lculo manual
        const ehAdmin = currentUserData.isAdmin || currentUser?.email === 'admin@yellup.com';
        if (ehAdmin) {
          document.getElementById('adminPanel').style.display = 'block';
        }

        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

      } catch (error) {
        console.error('Erro ao carregar rating:', error);
        document.getElementById('loadingOverlay').innerHTML = `
          <div style="text-align:center;color:var(--text-secondary);">
            <div style="font-size:3em;margin-bottom:15px;">üìä</div>
            <div style="font-size:1.1em;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Rating ainda n√£o calculado</div>
            <div>O Rating Yellup √© calculado diariamente √† meia-noite.<br>Continue jogando e volte amanh√£!</div>
          </div>
        `;
      }
    }

    // ==================== RENDERIZAR ====================
    function renderizarRating(data, posicao, totalJogadores) {
      const rating = Math.round(data.ratingFinal || 0);
      const faixa = getFaixa(rating);
      const componentes = data.componentes || {};

      // Set CSS variable for faixa color
      document.documentElement.style.setProperty('--faixa-color', faixa.color);

      // Rating number (animate)
      animateNumber('ratingNumber', rating, 1500);

      // Ring progress
      const pct = rating / 1000;
      const circumference = 2 * Math.PI * 100; // r=100
      setTimeout(() => {
        document.getElementById('ratingRing').style.strokeDashoffset = circumference * (1 - pct);
      }, 200);

      // Faixa badge
      document.getElementById('faixaIcon').textContent = faixa.icon;
      document.getElementById('faixaNome').textContent = faixa.nome;

      // Meta
      document.getElementById('rankPosition').textContent = posicao ? `#${posicao}` : '-';
      if (data.ultimoCalculo) {
        const d = data.ultimoCalculo.toDate ? data.ultimoCalculo.toDate() : new Date(data.ultimoCalculo);
        document.getElementById('lastUpdate').textContent = d.toLocaleDateString('pt-BR');
      }

      // Varia√ß√£o
      const variacao = data.variacao || 0;
      if (variacao !== 0) {
        const varEl = document.createElement('span');
        varEl.innerHTML = `${variacao > 0 ? 'üìà' : 'üìâ'} Hoje: <strong style="color:${variacao > 0 ? 'var(--success)' : 'var(--danger)'}">${variacao > 0 ? '+' : ''}${variacao}</strong>`;
        document.querySelector('.rating-meta').appendChild(varEl);
      }

      // Decay
      renderizarDecay(data.diasInativo || 0);

      // Components
      renderizarComponentes(componentes);

      // Radar chart
      renderizarRadar(componentes);

      // History chart
      renderizarHistorico(data.historico || []);

      // Ranking card
      document.getElementById('rankPos').textContent = posicao ? `#${posicao}` : '#-';
      document.getElementById('rankDetail').textContent = totalJogadores > 0
        ? `Top ${Math.round(posicao / totalJogadores * 100)}% de ${totalJogadores} jogadores`
        : 'Ranking sendo calculado...';

      // Reset info
      const hoje = new Date();
      const proximoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
      const diasParaReset = Math.ceil((proximoMes - hoje) / (1000 * 60 * 60 * 24));
      document.getElementById('resetDias').textContent = diasParaReset;

      // Faixas guide
      renderizarFaixasGuide(rating);
    }

    function animateNumber(elementId, target, duration) {
      const el = document.getElementById(elementId);
      const start = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3); // ease out cubic
        el.textContent = Math.round(start + (target - start) * eased);
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    function renderizarDecay(diasInativo) {
      const card = document.getElementById('decayCard');
      const title = document.getElementById('decayTitle');
      const text = document.getElementById('decayText');
      const badge = document.getElementById('decayBadge');

      if (diasInativo <= 2) {
        title.textContent = 'üü¢ Ativo';
        text.textContent = 'Jogando regularmente ‚Äî sem penalidade de decay!';
        badge.textContent = 'Seguro';
        badge.className = 'decay-status decay-safe';
      } else if (diasInativo <= 5) {
        title.textContent = 'üü° Aten√ß√£o';
        text.textContent = `${diasInativo} dias sem jogar. Decay de -${(diasInativo - 2) * 2}% come√ßa a ser aplicado.`;
        badge.textContent = `${diasInativo}d inativo`;
        badge.className = 'decay-status decay-warning';
        document.getElementById('decayMeta').style.display = '';
        document.getElementById('decayDays').textContent = diasInativo;
      } else {
        title.textContent = 'üî¥ Decay Ativo';
        text.textContent = `${diasInativo} dias sem jogar! Seu rating est√° perdendo -${Math.min((diasInativo - 2) * 2, 20)}% por dia.`;
        badge.textContent = `${diasInativo}d inativo`;
        badge.className = 'decay-status decay-danger';
        document.getElementById('decayMeta').style.display = '';
        document.getElementById('decayDays').textContent = diasInativo;
      }
    }

    function renderizarComponentes(comp) {
      const container = document.getElementById('componentsList');
      let html = '';
      COMPONENTES.forEach(c => {
        const valor = Math.round(comp[c.key] || 0);
        const pct = Math.min(valor / 1000 * 100, 100);
        html += `
          <div class="component-row">
            <div class="comp-icon">${c.icon}</div>
            <div class="comp-info">
              <div class="comp-name">${c.nome}</div>
              <div class="comp-bar-bg"><div class="comp-bar" style="width:${pct}%;"></div></div>
            </div>
            <div class="comp-value">${valor}</div>
            <div class="comp-weight">${Math.round(c.peso * 100)}%</div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ==================== RADAR CHART (SVG) ====================
    function renderizarRadar(comp) {
      const svg = document.getElementById('radarChart');
      const cx = 150, cy = 150, r = 120;
      const n = COMPONENTES.length;

      // Draw grid
      let gridHtml = '';
      for (let level = 1; level <= 5; level++) {
        const lr = r * (level / 5);
        let points = '';
        for (let i = 0; i < n; i++) {
          const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
          points += `${cx + lr * Math.cos(angle)},${cy + lr * Math.sin(angle)} `;
        }
        gridHtml += `<polygon points="${points}" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>`;
      }

      // Draw axes
      for (let i = 0; i < n; i++) {
        const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        const x = cx + r * Math.cos(angle);
        const y = cy + r * Math.sin(angle);
        gridHtml += `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>`;
      }

      // Draw data polygon
      let dataPoints = '';
      const faixa = getFaixa(Math.round(Object.values(comp).reduce((s, v) => s + v, 0) / n * 0.25 + Object.values(comp).reduce((s, v) => s + v, 0) / n * 0.75));

      COMPONENTES.forEach((c, i) => {
        const valor = Math.min((comp[c.key] || 0) / 1000, 1);
        const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        const x = cx + r * valor * Math.cos(angle);
        const y = cy + r * valor * Math.sin(angle);
        dataPoints += `${x},${y} `;
      });

      gridHtml += `<polygon points="${dataPoints}" fill="var(--faixa-color)" fill-opacity="0.15" stroke="var(--faixa-color)" stroke-width="2.5" stroke-linejoin="round"/>`;

      // Draw dots + labels
      COMPONENTES.forEach((c, i) => {
        const valor = Math.min((comp[c.key] || 0) / 1000, 1);
        const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
        const x = cx + r * valor * Math.cos(angle);
        const y = cy + r * valor * Math.sin(angle);
        gridHtml += `<circle cx="${x}" cy="${y}" r="4" fill="var(--faixa-color)" stroke="#fff" stroke-width="1.5"/>`;

        // Label
        const lx = cx + (r + 18) * Math.cos(angle);
        const ly = cy + (r + 18) * Math.sin(angle);
        const anchor = Math.abs(Math.cos(angle)) < 0.1 ? 'middle' : Math.cos(angle) > 0 ? 'start' : 'end';
        gridHtml += `<text x="${lx}" y="${ly + 4}" fill="var(--text-secondary)" font-size="10" text-anchor="${anchor}" font-family="Poppins">${c.icon}</text>`;
      });

      svg.innerHTML = gridHtml;
    }

    // ==================== HISTORY CHART (Canvas) ====================
    function renderizarHistorico(historico) {
      const canvas = document.getElementById('historyChart');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;

      canvas.width = canvas.offsetWidth * dpr;
      canvas.height = canvas.offsetHeight * dpr;
      ctx.scale(dpr, dpr);

      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      const pad = { top: 20, right: 15, bottom: 25, left: 40 };

      // If no history, show placeholder
      if (!historico || historico.length < 2) {
        ctx.fillStyle = 'rgba(169, 181, 198, 0.4)';
        ctx.font = '13px Poppins';
        ctx.textAlign = 'center';
        ctx.fillText('Dados hist√≥ricos aparecer√£o ap√≥s alguns dias', w / 2, h / 2);
        return;
      }

      const values = historico.map(h => h.rating || h);
      const labels = historico.map(h => h.date || '');
      const minVal = Math.max(0, Math.min(...values) - 50);
      const maxVal = Math.min(1000, Math.max(...values) + 50);
      const range = maxVal - minVal || 1;

      const plotW = w - pad.left - pad.right;
      const plotH = h - pad.top - pad.bottom;

      // Grid lines
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = pad.top + plotH * (1 - i / 4);
        ctx.beginPath();
        ctx.moveTo(pad.left, y);
        ctx.lineTo(w - pad.right, y);
        ctx.stroke();

        const val = Math.round(minVal + range * (i / 4));
        ctx.fillStyle = 'rgba(169,181,198,0.4)';
        ctx.font = '10px Orbitron';
        ctx.textAlign = 'right';
        ctx.fillText(val, pad.left - 5, y + 3);
      }

      // Line
      const getColor = getComputedStyle(document.documentElement).getPropertyValue('--faixa-color').trim();
      ctx.strokeStyle = getColor;
      ctx.lineWidth = 2.5;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.beginPath();

      values.forEach((v, i) => {
        const x = pad.left + (i / (values.length - 1)) * plotW;
        const y = pad.top + plotH * (1 - (v - minVal) / range);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Gradient fill
      const gradient = ctx.createLinearGradient(0, pad.top, 0, h - pad.bottom);
      gradient.addColorStop(0, getColor + '30');
      gradient.addColorStop(1, getColor + '00');

      ctx.lineTo(pad.left + plotW, h - pad.bottom);
      ctx.lineTo(pad.left, h - pad.bottom);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();

      // Last point dot
      const lastX = pad.left + plotW;
      const lastY = pad.top + plotH * (1 - (values[values.length - 1] - minVal) / range);
      ctx.beginPath();
      ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
      ctx.fillStyle = getColor;
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // ==================== FAIXAS GUIDE ====================
    function renderizarFaixasGuide(currentRating) {
      const container = document.getElementById('faixasGuide');
      let html = '';
      FAIXAS.forEach(f => {
        const isActive = currentRating >= f.min && currentRating <= f.max;
        html += `
          <div class="faixa-row ${isActive ? 'active' : ''}">
            <div class="faixa-dot" style="background:${f.color};${isActive ? 'box-shadow:0 0 10px ' + f.color : ''}"></div>
            <div class="faixa-name" style="${isActive ? 'color:' + f.color : ''}">${f.icon} ${f.nome}</div>
            <div class="faixa-range">${f.min} ‚Äî ${f.max}</div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // ==================== ADMIN: CALCULAR MANUAL ====================
    async function calcularRatingManual() {
      const btn = document.getElementById('btnCalcular');
      const resultado = document.getElementById('calcResultado');
      btn.disabled = true;
      btn.textContent = '‚è≥ Calculando... (pode demorar)';
      resultado.style.display = 'none';

      try {
        const calcular = functions.httpsCallable('calcularRatingManual');
        const res = await calcular();
        const data = res.data;

        resultado.style.display = 'block';
        let html = `‚úÖ <strong>${data.processados}</strong> usu√°rios processados!<br><br>`;
        html += `<strong>üèÜ Top 10:</strong><br>`;
        (data.top10 || []).forEach((r, i) => {
          html += `${i + 1}. ${r.nome} ‚Äî <strong>${r.rating}</strong> (${r.faixa}) ${r.variacao > 0 ? 'üìà+' + r.variacao : r.variacao < 0 ? 'üìâ' + r.variacao : '‚Äî'}<br>`;
        });
        resultado.innerHTML = html;

        showToast('‚úÖ Rating calculado! Recarregando...');
        setTimeout(() => location.reload(), 2000);

      } catch (e) {
        console.error('Erro:', e);
        resultado.style.display = 'block';
        resultado.innerHTML = `‚ùå Erro: ${e.message}`;
        showToast('‚ùå Erro ao calcular');
      }
      btn.disabled = false;
      btn.textContent = 'üéØ Calcular Rating Agora';
    }

    // ==================== UTILS ====================
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>

</body>
</html>
