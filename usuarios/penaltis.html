<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0a0e13;--bg-card:#131920;--bg-elevated:#1a2230;--accent-primary:#ff9f43;--accent-secondary:#ffc048;--accent-glow:rgba(255,159,67,0.25);--live-red:#ff4757;--win-green:#2ed573;--text-primary:#f1f2f6;--text-secondary:#a4b0be}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);background-image:radial-gradient(ellipse at top,rgba(255,159,67,0.03) 0%,transparent 50%),radial-gradient(ellipse at bottom,rgba(26,34,48,0.5) 0%,transparent 50%);background-attachment:fixed;color:var(--text-primary);min-height:100vh;padding-bottom:100px}
    .header{background:rgba(10,14,19,0.95);backdrop-filter:blur(20px);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,159,67,0.1)}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo img{height:36px;filter:drop-shadow(0 2px 8px rgba(255,181,71,0.3))}
    .btn-back{padding:8px 16px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#e7eef7;cursor:pointer;font-family:'Poppins',sans-serif;font-size:0.85em;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all 0.3s}
    .container{max-width:600px;margin:0 auto;padding:24px 20px}
    .hero{text-align:center;padding:30px 20px;margin-bottom:24px;background:linear-gradient(145deg,rgba(27,94,32,0.15),rgba(46,125,50,0.08));border:1px solid rgba(46,125,50,0.3);border-radius:20px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--win-green),var(--accent-primary),var(--win-green));background-size:200% 100%;animation:shimmerBar 3s linear infinite}
    @keyframes shimmerBar{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .hero-icon{font-size:3.5em;margin-bottom:8px}.hero h1{font-size:1.6em;font-weight:800;margin-bottom:4px}.hero p{color:var(--text-secondary);font-size:0.9em}
    .credits-bar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;margin-bottom:20px;background:var(--bg-card);border-radius:14px;border:1px solid rgba(255,255,255,0.06)}
    .credits-label{font-size:0.85em;color:var(--text-secondary)}.credits-value{font-size:1.3em;font-weight:800;color:var(--accent-secondary)}
    .buttons-row{display:flex;gap:10px;margin-bottom:24px}
    .btn-create{flex:1;padding:16px;background:linear-gradient(135deg,var(--win-green),#7bed9f);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(46,213,115,0.3);display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-create:hover{transform:translateY(-2px)}.btn-create:active{transform:scale(0.97)}
    .btn-challenge{flex:1;padding:16px;background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;border-radius:14px;color:white;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(59,130,246,0.3);display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-challenge:hover{transform:translateY(-2px)}.btn-challenge:active{transform:scale(0.97)}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{flex:1;padding:10px;text-align:center;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;transition:all 0.3s;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.8em;color:var(--text-secondary)}
    .tab.active{background:rgba(255,159,67,0.15);border-color:var(--accent-primary);color:var(--accent-primary)}
    .matches-list{display:flex;flex-direction:column;gap:10px;margin-bottom:28px}
    .match-card{background:linear-gradient(145deg,var(--bg-card),var(--bg-elevated));border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;transition:all 0.3s}
    .match-card:hover{border-color:rgba(255,159,67,0.2);transform:translateY(-1px)}.match-card.my-match{border-color:rgba(46,213,115,0.3)}
    .match-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .match-creator{display:flex;align-items:center;gap:10px}
    .match-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ffb547,#ff8c42);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85em;color:var(--bg-dark)}
    .match-name{font-weight:600;font-size:0.9em}.match-time{font-size:0.7em;color:var(--text-secondary)}
    .match-status{padding:4px 10px;border-radius:20px;font-size:0.65em;font-weight:700;text-transform:uppercase}
    .status-aguardando{background:rgba(255,159,67,0.2);color:var(--accent-primary)}
    .status-em-andamento{background:rgba(255,71,87,0.2);color:var(--live-red);animation:pulse-live 2s ease-in-out infinite}
    @keyframes pulse-live{0%,100%{opacity:1}50%{opacity:0.7}}
    .match-middle{display:flex;align-items:center;justify-content:center;gap:20px;padding:12px 0;margin-bottom:10px}
    .match-bet-value{font-size:1.4em;font-weight:800;color:var(--accent-secondary)}.match-bet-label{font-size:0.7em;color:var(--text-secondary);text-align:center}
    .match-challenge-info{font-size:0.75em;color:#60a5fa;text-align:center;padding:6px 12px;background:rgba(59,130,246,0.1);border-radius:8px;margin-bottom:10px}
    .btn-accept{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent-primary),#ff8c42);border:none;border-radius:12px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px var(--accent-glow)}
    .btn-accept:hover{transform:translateY(-2px)}.btn-accept:active{transform:scale(0.97)}
    .btn-enter{width:100%;padding:12px;background:linear-gradient(135deg,var(--live-red),#ff6b81);border:none;border-radius:12px;color:white;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85em;cursor:pointer;transition:all 0.3s}
    .btn-cancel-match{width:100%;padding:12px;margin-top:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.8em;cursor:pointer;transition:all 0.3s}
    .btn-cancel-match:hover{background:rgba(255,71,87,0.1);border-color:rgba(255,71,87,0.3);color:var(--live-red)}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary)}.empty-icon{font-size:3em;margin-bottom:12px}
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(8px)}
    .modal-overlay.active{display:flex}
    .modal-card{background:linear-gradient(135deg,#1e2936,#18222e);border-radius:24px;padding:30px;max-width:420px;width:92%;border:1px solid rgba(255,181,71,0.3);animation:modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:85vh;overflow-y:auto}
    @keyframes modalPop{from{opacity:0;transform:scale(0.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal-title{font-size:1.3em;font-weight:800;text-align:center;margin-bottom:20px}
    .modal-field{margin-bottom:16px}.modal-label{font-size:0.8em;color:var(--text-secondary);margin-bottom:6px}
    .modal-input{width:100%;padding:14px 16px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:1.2em;font-weight:700;text-align:center;outline:none;transition:border-color 0.3s}
    .modal-input:focus{border-color:var(--accent-primary)}
    .modal-hint{font-size:0.75em;color:var(--text-secondary);text-align:center;margin-top:4px}
    .modal-presets{display:flex;gap:8px;margin-bottom:16px;justify-content:center;flex-wrap:wrap}
    .preset-btn{padding:8px 16px;background:rgba(255,159,67,0.1);border:1px solid rgba(255,159,67,0.2);border-radius:10px;color:var(--accent-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85em;cursor:pointer;transition:all 0.3s}
    .preset-btn:hover,.preset-btn.active{background:rgba(255,159,67,0.25);border-color:var(--accent-primary)}
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .modal-actions button{flex:1;padding:14px;border-radius:12px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s}
    .btn-modal-confirm{background:linear-gradient(135deg,var(--win-green),#7bed9f);color:var(--bg-dark);box-shadow:0 4px 15px rgba(46,213,115,0.3)}
    .btn-modal-cancel{background:rgba(255,255,255,0.08);color:var(--text-secondary)}
    .friends-list{max-height:300px;overflow-y:auto;margin-bottom:16px}
    .friend-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
    .friend-item:hover{background:rgba(255,255,255,0.05)}.friend-item.selected{background:rgba(59,130,246,0.15);border-color:#3b82f6}
    .friend-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85em;color:white;flex-shrink:0}
    .friend-info{flex:1}.friend-name{font-weight:600;font-size:0.9em}.friend-credits{font-size:0.75em;color:var(--text-secondary)}
    .friend-check{font-size:1.2em;opacity:0;transition:opacity 0.2s}.friend-item.selected .friend-check{opacity:1}
    .friends-empty{text-align:center;padding:30px 10px;color:var(--text-secondary);font-size:0.85em}
    .friends-search{width:100%;padding:10px 14px;margin-bottom:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:0.85em;outline:none}
    .friends-search:focus{border-color:#3b82f6}
    .team-picker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:240px;overflow-y:auto;padding:4px}
    .team-pick{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;border-radius:12px;border:2px solid transparent;cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.03)}
    .team-pick:hover{background:rgba(255,255,255,0.06)}
    .team-pick.selected{border-color:var(--accent-primary);background:rgba(255,159,67,0.12)}
    .team-pick-shield{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.65em;color:white}
    .team-pick-name{font-size:0.6em;font-weight:600;color:var(--text-secondary);text-align:center;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .team-pick.selected .team-pick-name{color:var(--accent-primary)}
    .team-search{width:100%;padding:8px 12px;margin-bottom:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:0.8em;outline:none}
    .team-search:focus{border-color:var(--accent-primary)}
    .ranking-link{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;background:linear-gradient(135deg,rgba(168,85,247,0.12),rgba(168,85,247,0.04));border:1px solid rgba(168,85,247,0.25);border-radius:14px;color:#c084fc;font-weight:600;font-size:0.85em;text-decoration:none;margin-bottom:20px;transition:all 0.3s}
    .ranking-link:hover{background:rgba(168,85,247,0.2);transform:translateY(-1px)}
    .match-team-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.7em;padding:2px 8px;border-radius:6px;font-weight:600;margin-top:2px}
    .accept-team-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:2001;justify-content:center;align-items:center;backdrop-filter:blur(8px)}
    .accept-team-modal.active{display:flex}
    .history-card{background:var(--bg-card);border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .history-card.win{border-left:3px solid var(--win-green)}.history-card.loss{border-left:3px solid var(--live-red)}
    .history-info{flex:1}.history-opponent{font-weight:600;font-size:0.85em}.history-score{font-size:0.75em;color:var(--text-secondary)}
    .history-result{font-weight:700;font-size:0.85em;padding:4px 12px;border-radius:8px}
    .history-result.win{background:rgba(46,213,115,0.15);color:var(--win-green)}.history-result.loss{background:rgba(255,71,87,0.15);color:var(--live-red)}
    .rules-card{background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:16px;padding:18px;margin-bottom:24px}
    .rules-title{font-weight:700;font-size:0.95em;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .rule-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:0.8em;color:var(--text-secondary);line-height:1.4}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,0.9);color:white;padding:15px 30px;border-radius:50px;font-weight:600;z-index:3000;opacity:0;transition:all 0.3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(14,20,27,0.98);backdrop-filter:blur(20px);padding:10px 20px;border-top:1px solid rgba(255,255,255,0.1);z-index:99}
    .nav-content{max-width:600px;margin:0 auto;display:flex;justify-content:space-around}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#a9b5c6;text-decoration:none;font-size:0.75em;transition:all 0.3s;padding:5px 10px}
    .nav-item:hover{color:#ffb547}.nav-icon{font-size:1.5em}
  </style>
</head>
<body>
  <div class="header"><div class="header-content">
    <div class="logo"><img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'"></div>
    <a href="painel.html" class="btn-back">‚Üê Voltar</a>
  </div></div>

  <div class="container">
    <div class="hero"><div class="hero-icon">‚öΩ</div><h1>Disputa de P√™naltis</h1><p>Desafie outros jogadores em cobran√ßas!</p></div>
    <div class="credits-bar"><span class="credits-label">üí∞ Seus cr√©ditos</span><span class="credits-value" id="myCredits">0</span></div>

    <div class="buttons-row">
      <button class="btn-create" onclick="abrirModalCriar('publica')">‚öΩ Criar Disputa</button>
      <button class="btn-challenge" onclick="abrirModalCriar('amigo')">üë• Desafiar Amigo</button>
    </div>

    <a href="ranking-penaltis.html" class="ranking-link">üèÜ Ver Ranking de P√™naltis ‚Üí</a>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('abertas')" id="tabAbertas">üî¥ Abertas</div>
      <div class="tab" onclick="switchTab('minhas')" id="tabMinhas">‚ö° Minhas</div>
      <div class="tab" onclick="switchTab('historico')" id="tabHistorico">üìã Hist√≥rico</div>
    </div>

    <div id="contentAbertas" class="matches-list"><div class="empty-state"><div class="empty-icon">‚öΩ</div><p>Carregando...</p></div></div>
    <div id="contentMinhas" class="matches-list" style="display:none;"><div class="empty-state"><div class="empty-icon">üí§</div><p>Carregando...</p></div></div>
    <div id="contentHistorico" class="matches-list" style="display:none;"><div class="empty-state"><div class="empty-icon">üìã</div><p>Carregando...</p></div></div>

    <div class="rules-card">
      <div class="rules-title">üìñ Como Funciona</div>
      <div class="rule-item"><span>ü•Ö</span><span>O gol tem 9 quadrantes (3√ó3)</span></div>
      <div class="rule-item"><span>üîÑ</span><span>5 cobran√ßas para cada (10 rodadas)</span></div>
      <div class="rule-item"><span>üéØ</span><span>Cobrador escolhe onde chutar, goleiro onde defender</span></div>
      <div class="rule-item"><span>üß§</span><span>Se acertar o quadrante = defende!</span></div>
      <div class="rule-item"><span>üí∞</span><span>Vencedor leva os cr√©ditos apostados</span></div>
      <div class="rule-item"><span>‚ö°</span><span>Morte s√∫bita se empatar ap√≥s 5√ó5</span></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalCriar" onclick="if(event.target===this)fecharModal()">
    <div class="modal-card">
      <div class="modal-title" id="modalTitle">‚öΩ Criar Disputa</div>
      <div id="friendPickerSection" style="display:none;">
        <div class="modal-field">
          <div class="modal-label">Escolha um amigo para desafiar</div>
          <input type="text" class="friends-search" id="searchFriend" placeholder="üîç Buscar..." oninput="filtrarAmigos()">
          <div class="friends-list" id="friendsList"><div class="friends-empty">Carregando...</div></div>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">üéΩ Escolha seu time</div>
        <input type="text" class="team-search" id="searchTeam" placeholder="üîç Buscar time..." oninput="filtrarTimes()">
        <div class="team-picker-grid" id="teamPickerGrid"><div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.8em;padding:20px">Carregando times...</div></div>
      </div>
      <div class="modal-field">
        <div class="modal-label">Quanto apostar?</div>
        <div class="modal-presets">
          <button class="preset-btn" onclick="setValor(5)">5</button>
          <button class="preset-btn" onclick="setValor(10)">10</button>
          <button class="preset-btn" onclick="setValor(25)">25</button>
          <button class="preset-btn" onclick="setValor(50)">50</button>
          <button class="preset-btn" onclick="setValor(100)">100</button>
        </div>
        <input type="number" class="modal-input" id="inputValor" value="10" min="1">
        <div class="modal-hint">Cr√©ditos que cada jogador aposta</div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="fecharModal()">Cancelar</button>
        <button class="btn-modal-confirm" id="btnModalConfirm" onclick="criarDisputa()">‚öΩ Criar!</button>
      </div>
    </div>
  </div>

  <!-- ACCEPT TEAM MODAL -->
  <div class="accept-team-modal" id="modalAcceptTeam" onclick="if(event.target===this)fecharAcceptTeam()">
    <div class="modal-card">
      <div class="modal-title" id="acceptTeamTitle">üéΩ Escolha seu time</div>
      <div class="modal-field">
        <div class="modal-label">Selecione o time para esta disputa</div>
        <input type="text" class="team-search" id="searchTeamAccept" placeholder="üîç Buscar time..." oninput="filtrarTimesAccept()">
        <div class="team-picker-grid" id="teamPickerAccept"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="fecharAcceptTeam()">Cancelar</button>
        <button class="btn-modal-confirm" onclick="confirmarAceitar()">‚öΩ Aceitar!</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <nav class="bottom-nav"><div class="nav-content">
    <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
    <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
    <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
    <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
  </div></nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));

    let currentUser=null,currentUserData=null,allMatches=[],allFriends=[],selectedFriendUid=null,modalMode='publica',currentTab='abertas';
    let allTimes=[],selectedTimeId=null,selectedTimeData=null;
    let acceptingMatchId=null,acceptingMatchValor=0,selectedTimeAcceptId=null,selectedTimeAcceptData=null;

    auth.onAuthStateChanged(async user=>{
      if(!user){window.location.href='index.html';return}
      currentUser=user;
      const doc=await db.collection('usuarios').doc(user.uid).get();
      if(doc.exists){currentUserData=doc.data();document.getElementById('myCredits').textContent=(currentUserData.creditos||0).toLocaleString()}
      carregarDisputas();
      carregarAmigos();
      carregarTimes();
    });

    // SIMPLE QUERY - no composite index needed, just orderBy timestamp
    function carregarDisputas(){
      db.collection('penaltis').limit(50).onSnapshot(snap=>{
        allMatches=[];
        snap.forEach(doc=>allMatches.push({id:doc.id,...doc.data()}));
        allMatches.sort((a,b)=>(b.criadoEm?.seconds||0)-(a.criadoEm?.seconds||0));
        renderCurrentTab();
      },err=>{
        console.error('Query error:',err);
        renderCurrentTab();
      });
    }

    async function carregarAmigos(){
      try{
        const snap=await db.collection('usuarios').limit(50).get();
        allFriends=[];
        snap.forEach(doc=>{
          if(doc.id===currentUser.uid) return;
          const d=doc.data();
          if(d.status==='bloqueado') return;
          allFriends.push({uid:doc.id,nome:d.usuarioUnico||d.usuario||d.nome||'Jogador',creditos:d.creditos||0});
        });
        allFriends.sort((a,b)=>a.nome.localeCompare(b.nome));
      }catch(e){console.error('Amigos:',e)}
    }

    async function carregarTimes(){
      try{
        const snap=await db.collection('times').orderBy('nome').get();
        allTimes=[];
        snap.forEach(doc=>{
          const d=doc.data();
          allTimes.push({id:doc.id,nome:d.nome||'Time',abreviacao:d.abreviacao||d.nome?.substring(0,3).toUpperCase()||'???',cor1:d.cor1||d.cores?.principal||'#333',cor2:d.cor2||d.cores?.secundaria||'#666',cor3:d.cor3||d.cores?.terciaria||'#999',escudo:d.escudo||null});
        });
        // Pre-select user's favorite team
        if(currentUserData?.timeId){
          const fav=allTimes.find(t=>t.id===currentUserData.timeId);
          if(fav){selectedTimeId=fav.id;selectedTimeData=fav}
        }
        renderTimePicker('teamPickerGrid','create');
        renderTimePicker('teamPickerAccept','accept');
      }catch(e){console.error('Times:',e);
        document.getElementById('teamPickerGrid').innerHTML='<div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.75em;padding:12px">Opcional - jogue sem time</div>';
      }
    }

    function renderTimePicker(containerId,mode,filter=''){
      const c=document.getElementById(containerId);
      const list=filter?allTimes.filter(t=>t.nome.toLowerCase().includes(filter.toLowerCase())):allTimes;
      const selId=mode==='create'?selectedTimeId:selectedTimeAcceptId;

      if(!list.length){c.innerHTML='<div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.75em;padding:12px">'+(filter?'Nenhum time encontrado':'Nenhum time cadastrado')+'</div>';return}

      c.innerHTML=list.map(t=>{
        const sel=selId===t.id?'selected':'';
        return `<div class="team-pick ${sel}" onclick="${mode==='create'?'selectTime':'selectTimeAccept'}('${t.id}')">
          <div class="team-pick-shield" style="background:linear-gradient(135deg,${t.cor1},${t.cor2})">${t.abreviacao.substring(0,3)}</div>
          <div class="team-pick-name">${t.nome}</div>
        </div>`;
      }).join('');
    }

    function selectTime(id){
      const t=allTimes.find(x=>x.id===id);
      if(selectedTimeId===id){selectedTimeId=null;selectedTimeData=null}
      else{selectedTimeId=id;selectedTimeData=t}
      renderTimePicker('teamPickerGrid','create',document.getElementById('searchTeam').value);
    }
    function selectTimeAccept(id){
      const t=allTimes.find(x=>x.id===id);
      if(selectedTimeAcceptId===id){selectedTimeAcceptId=null;selectedTimeAcceptData=null}
      else{selectedTimeAcceptId=id;selectedTimeAcceptData=t}
      renderTimePicker('teamPickerAccept','accept',document.getElementById('searchTeamAccept').value);
    }
    function filtrarTimes(){renderTimePicker('teamPickerGrid','create',document.getElementById('searchTeam').value)}
    function filtrarTimesAccept(){renderTimePicker('teamPickerAccept','accept',document.getElementById('searchTeamAccept').value)}

    // TABS
    function switchTab(tab){
      currentTab=tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
      document.getElementById('contentAbertas').style.display=tab==='abertas'?'flex':'none';
      document.getElementById('contentMinhas').style.display=tab==='minhas'?'flex':'none';
      document.getElementById('contentHistorico').style.display=tab==='historico'?'flex':'none';
      renderCurrentTab();
    }

    function renderCurrentTab(){
      if(currentTab==='abertas')renderAbertas();
      else if(currentTab==='minhas')renderMinhas();
      else renderHistorico();
    }

    function renderAbertas(){
      const c=document.getElementById('contentAbertas');
      const list=allMatches.filter(d=>d.status==='aguardando'&&d.jogador1?.uid!==currentUser.uid&&(!d.desafiadoUid||d.desafiadoUid===currentUser.uid));
      if(!list.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üò¥</div><p>Nenhuma disputa aberta. Crie uma!</p></div>';return}
      c.innerHTML=list.map(d=>{
        const nome=d.jogador1?.nome||'Jogador',ini=nome.charAt(0).toUpperCase(),tempo=d.criadoEm?.toDate?tempoRelativo(d.criadoEm.toDate()):'',isDesafio=d.desafiadoUid===currentUser.uid;
        const teamBadge=d.jogador1?.time?`<div class="match-team-badge" style="background:${d.jogador1.time.cor1}22;color:${d.jogador1.time.cor1}">${d.jogador1.time.abreviacao}</div>`:'';
        return `<div class="match-card"><div class="match-top"><div class="match-creator"><div class="match-avatar" ${d.jogador1?.time?'style="background:linear-gradient(135deg,'+d.jogador1.time.cor1+','+d.jogador1.time.cor2+')"':''}>${ini}</div><div><div class="match-name">${nome}</div>${teamBadge}<div class="match-time">${tempo}</div></div></div><span class="match-status status-aguardando">${isDesafio?'üì© Desafio':'Aguardando'}</span></div>${isDesafio?'<div class="match-challenge-info">üëä Voc√™ foi desafiado!</div>':''}<div class="match-middle"><div><div class="match-bet-value">üí∞ ${d.valorAposta}</div><div class="match-bet-label">cr√©ditos cada</div></div></div><button class="btn-accept" onclick="aceitarDisputa('${d.id}',${d.valorAposta})">‚öΩ Aceitar Desafio!</button></div>`
      }).join('');
    }

    function renderMinhas(){
      const c=document.getElementById('contentMinhas');
      const list=allMatches.filter(d=>(d.jogador1?.uid===currentUser.uid||d.jogador2?.uid===currentUser.uid)&&(d.status==='aguardando'||d.status==='em_andamento'));
      if(!list.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üí§</div><p>Nenhuma disputa ativa</p></div>';return}
      c.innerHTML=list.map(d=>{
        const isAg=d.status==='aguardando',isCr=d.jogador1?.uid===currentUser.uid;
        const op=isCr?(d.jogador2?.nome||(d.desafiadoNome||'Aguardando...')):(d.jogador1?.nome||'???');
        const placar=d.placar?`${d.placar.jogador1||0} √ó ${d.placar.jogador2||0}`:'0 √ó 0';
        let info='';if(isAg&&d.desafiadoNome)info=`<div class="match-challenge-info">üì© Desafio enviado para <strong>${d.desafiadoNome}</strong></div>`;
        let btns='';
        if(isAg&&isCr)btns=`<button class="btn-cancel-match" onclick="cancelarDisputa('${d.id}')">‚ùå Cancelar</button>`;
        else if(d.status==='em_andamento')btns=`<button class="btn-enter" onclick="window.location.href='arena-penalti.html?id=${d.id}'">üéØ Entrar na Arena</button>`;
        return `<div class="match-card my-match"><div class="match-top"><div class="match-creator"><div class="match-avatar">‚öΩ</div><div><div class="match-name">vs ${op}</div><div class="match-time">${!isAg?'Rodada '+(d.rodadaAtual||1)+' ‚Ä¢ '+placar+' ‚Ä¢ ':''}üí∞ ${d.valorAposta}</div></div></div><span class="match-status ${isAg?'status-aguardando':'status-em-andamento'}">${isAg?'Aguardando':'Ao Vivo'}</span></div>${info}${btns}</div>`
      }).join('');
    }

    function renderHistorico(){
      const c=document.getElementById('contentHistorico');
      const list=allMatches.filter(d=>d.status==='finalizado'&&(d.jogador1?.uid===currentUser.uid||d.jogador2?.uid===currentUser.uid));
      if(!list.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><p>Jogue sua primeira disputa!</p></div>';return}
      c.innerHTML=list.map(d=>{
        const w=d.vencedor===currentUser.uid,op=d.jogador1?.uid===currentUser.uid?d.jogador2?.nome:d.jogador1?.nome;
        return `<div class="history-card ${w?'win':'loss'}"><div class="history-info"><div class="history-opponent">vs ${op||'???'}</div><div class="history-score">${d.placar?.jogador1||0} √ó ${d.placar?.jogador2||0} ‚Ä¢ üí∞ ${d.valorAposta}</div></div><span class="history-result ${w?'win':'loss'}">${w?'+'+d.valorAposta:'-'+d.valorAposta}</span></div>`
      }).join('');
    }

    // MODAL
    function abrirModalCriar(mode){
      modalMode=mode;selectedFriendUid=null;
      document.getElementById('modalCriar').classList.add('active');
      if(mode==='amigo'){
        document.getElementById('modalTitle').textContent='üë• Desafiar Amigo';
        document.getElementById('friendPickerSection').style.display='block';
        document.getElementById('btnModalConfirm').textContent='‚ö° Desafiar!';
        renderFriendsList();
      }else{
        document.getElementById('modalTitle').textContent='‚öΩ Criar Disputa P√∫blica';
        document.getElementById('friendPickerSection').style.display='none';
        document.getElementById('btnModalConfirm').textContent='‚öΩ Criar!';
      }
    }
    function fecharModal(){document.getElementById('modalCriar').classList.remove('active')}
    function setValor(v){document.getElementById('inputValor').value=v;document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active')}

    function renderFriendsList(filter=''){
      const c=document.getElementById('friendsList');
      const f=filter?allFriends.filter(x=>x.nome.toLowerCase().includes(filter.toLowerCase())):allFriends;
      if(!f.length){c.innerHTML='<div class="friends-empty">Nenhum jogador encontrado</div>';return}
      c.innerHTML=f.map(x=>`<div class="friend-item ${selectedFriendUid===x.uid?'selected':''}" onclick="selectFriend('${x.uid}')"><div class="friend-avatar">${x.nome.charAt(0).toUpperCase()}</div><div class="friend-info"><div class="friend-name">${x.nome}</div><div class="friend-credits">üí∞ ${x.creditos.toLocaleString()}</div></div><span class="friend-check">‚úÖ</span></div>`).join('');
    }
    function filtrarAmigos(){renderFriendsList(document.getElementById('searchFriend').value)}
    function selectFriend(uid){selectedFriendUid=uid;renderFriendsList(document.getElementById('searchFriend').value)}

    // CRIAR
    async function criarDisputa(){
      const valor=parseInt(document.getElementById('inputValor').value);
      if(!valor||valor<1){showToast('‚ùå Valor inv√°lido');return}
      if((currentUserData?.creditos||0)<valor){showToast('‚ùå Cr√©ditos insuficientes');return}
      if(modalMode==='amigo'&&!selectedFriendUid){showToast('‚ùå Selecione um amigo');return}
      fecharModal();
      try{
        const nome=currentUserData.usuarioUnico||currentUserData.usuario||currentUserData.nome||'Jogador';
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(-valor)});
        const j1={uid:currentUser.uid,nome};
        if(selectedTimeData) j1.time={id:selectedTimeData.id,nome:selectedTimeData.nome,cor1:selectedTimeData.cor1,cor2:selectedTimeData.cor2,cor3:selectedTimeData.cor3,abreviacao:selectedTimeData.abreviacao};
        const matchData={jogador1:j1,jogador2:null,status:'aguardando',valorAposta:valor,rodadaAtual:1,rodadas:[],placar:{jogador1:0,jogador2:0},escolhaJogador1:null,escolhaJogador2:null,vencedor:null,criadoEm:firebase.firestore.FieldValue.serverTimestamp()};
        if(modalMode==='amigo'&&selectedFriendUid){
          const amigo=allFriends.find(f=>f.uid===selectedFriendUid);
          matchData.desafiadoUid=selectedFriendUid;
          matchData.desafiadoNome=amigo?.nome||'Amigo';
          await db.collection('notificacoes').add({para:selectedFriendUid,de:currentUser.uid,tipo:'desafio_penalti',titulo:'‚öΩ Desafio de P√™naltis!',mensagem:`${nome} te desafiou para p√™naltis! üí∞ ${valor} cr√©ditos`,link:'penaltis.html',lida:false,data:firebase.firestore.FieldValue.serverTimestamp()});
        }
        await db.collection('penaltis').add(matchData);
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'saida',valor,descricao:`P√™naltis: aposta de ${valor} cr√©ditos`,data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos-=valor;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();
        switchTab('minhas');
        showToast(modalMode==='amigo'?`‚úÖ Desafio enviado para ${allFriends.find(f=>f.uid===selectedFriendUid)?.nome}!`:'‚úÖ Disputa criada! Aguardando advers√°rio...');
      }catch(e){console.error('Criar:',e);showToast('‚ùå Erro ao criar')}
    }

    // ACEITAR - show team picker first
    function aceitarDisputa(id,valor){
      if((currentUserData?.creditos||0)<valor){showToast('‚ùå Cr√©ditos insuficientes');return}
      acceptingMatchId=id;acceptingMatchValor=valor;
      selectedTimeAcceptId=selectedTimeId;selectedTimeAcceptData=selectedTimeData; // pre-select favorite
      renderTimePicker('teamPickerAccept','accept');
      document.getElementById('modalAcceptTeam').classList.add('active');
    }
    function fecharAcceptTeam(){document.getElementById('modalAcceptTeam').classList.remove('active');acceptingMatchId=null}

    async function confirmarAceitar(){
      if(!acceptingMatchId) return;
      const id=acceptingMatchId,valor=acceptingMatchValor;
      document.getElementById('modalAcceptTeam').classList.remove('active');
      try{
        const nome=currentUserData.usuarioUnico||currentUserData.usuario||currentUserData.nome||'Jogador';
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(-valor)});
        const j2={uid:currentUser.uid,nome};
        if(selectedTimeAcceptData) j2.time={id:selectedTimeAcceptData.id,nome:selectedTimeAcceptData.nome,cor1:selectedTimeAcceptData.cor1,cor2:selectedTimeAcceptData.cor2,cor3:selectedTimeAcceptData.cor3,abreviacao:selectedTimeAcceptData.abreviacao};
        await db.collection('penaltis').doc(id).update({jogador2:j2,status:'em_andamento'});
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'saida',valor,descricao:`P√™naltis: aposta de ${valor} cr√©ditos`,data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos-=valor;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();
        showToast('‚úÖ Aceito! Entrando na arena...');
        setTimeout(()=>window.location.href=`arena-penalti.html?id=${id}`,800);
      }catch(e){console.error('Aceitar:',e);showToast('‚ùå Erro ao aceitar')}
    }

    // CANCELAR
    async function cancelarDisputa(id){
      try{
        const doc=await db.collection('penaltis').doc(id).get();
        const d=doc.data();
        if(d.jogador1.uid!==currentUser.uid||d.status!=='aguardando'){showToast('‚ùå N√£o pode cancelar');return}
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(d.valorAposta)});
        await db.collection('penaltis').doc(id).delete();
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:d.valorAposta,descricao:'P√™naltis: cancelada (reembolso)',data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos+=d.valorAposta;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();
        showToast('‚úÖ Cancelada, cr√©ditos devolvidos');
      }catch(e){console.error('Cancelar:',e);showToast('‚ùå Erro')}
    }

    function tempoRelativo(date){const d=Date.now()-date.getTime(),m=Math.floor(d/60000);if(m<1)return'Agora';if(m<60)return m+'min';const h=Math.floor(m/60);if(h<24)return h+'h';return Math.floor(h/24)+'d'}
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
