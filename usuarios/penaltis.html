<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0a0e13;--bg-card:#131920;--bg-elevated:#1a2230;--accent-primary:#ff9f43;--accent-secondary:#ffc048;--accent-glow:rgba(255,159,67,0.25);--live-red:#ff4757;--win-green:#2ed573;--text-primary:#f1f2f6;--text-secondary:#a4b0be}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);background-image:radial-gradient(ellipse at top,rgba(255,159,67,0.03) 0%,transparent 50%),radial-gradient(ellipse at bottom,rgba(26,34,48,0.5) 0%,transparent 50%);background-attachment:fixed;color:var(--text-primary);min-height:100vh;padding-bottom:100px}
    .header{background:rgba(10,14,19,0.95);backdrop-filter:blur(20px);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,159,67,0.1)}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo img{height:36px;filter:drop-shadow(0 2px 8px rgba(255,181,71,0.3))}
    .btn-back{padding:8px 16px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#e7eef7;cursor:pointer;font-family:'Poppins',sans-serif;font-size:0.85em;text-decoration:none;display:flex;align-items:center;gap:6px;transition:all 0.3s}
    .container{max-width:600px;margin:0 auto;padding:24px 20px}
    .hero{text-align:center;padding:30px 20px;margin-bottom:24px;background:linear-gradient(145deg,rgba(27,94,32,0.15),rgba(46,125,50,0.08));border:1px solid rgba(46,125,50,0.3);border-radius:20px;position:relative;overflow:hidden}
    .hero::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--win-green),var(--accent-primary),var(--win-green));background-size:200% 100%;animation:shimmerBar 3s linear infinite}
    @keyframes shimmerBar{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .hero-icon{font-size:3.5em;margin-bottom:8px}.hero h1{font-size:1.6em;font-weight:800;margin-bottom:4px}.hero p{color:var(--text-secondary);font-size:0.9em}
    .credits-bar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;margin-bottom:20px;background:var(--bg-card);border-radius:14px;border:1px solid rgba(255,255,255,0.06)}
    .credits-label{font-size:0.85em;color:var(--text-secondary)}.credits-value{font-size:1.3em;font-weight:800;color:var(--accent-secondary)}
    .buttons-row{display:flex;gap:10px;margin-bottom:24px}
    .btn-create{flex:1;padding:16px;background:linear-gradient(135deg,var(--win-green),#7bed9f);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(46,213,115,0.3);display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-create:hover{transform:translateY(-2px)}.btn-create:active{transform:scale(0.97)}
    .btn-challenge{flex:1;padding:16px;background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;border-radius:14px;color:white;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(59,130,246,0.3);display:flex;align-items:center;justify-content:center;gap:8px}
    .btn-challenge:hover{transform:translateY(-2px)}.btn-challenge:active{transform:scale(0.97)}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{flex:1;padding:10px;text-align:center;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;transition:all 0.3s;font-family:'Poppins',sans-serif;font-weight:600;font-size:0.8em;color:var(--text-secondary)}
    .tab.active{background:rgba(255,159,67,0.15);border-color:var(--accent-primary);color:var(--accent-primary)}
    .matches-list{display:flex;flex-direction:column;gap:10px;margin-bottom:28px}
    .match-card{background:linear-gradient(145deg,var(--bg-card),var(--bg-elevated));border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;transition:all 0.3s}
    .match-card:hover{border-color:rgba(255,159,67,0.2);transform:translateY(-1px)}.match-card.my-match{border-color:rgba(46,213,115,0.3)}
    .match-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .match-creator{display:flex;align-items:center;gap:10px}
    .match-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#ffb547,#ff8c42);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85em;color:var(--bg-dark);overflow:hidden;flex-shrink:0}
    .match-name{font-weight:600;font-size:0.9em}.match-time{font-size:0.7em;color:var(--text-secondary)}
    .match-status{padding:4px 10px;border-radius:20px;font-size:0.65em;font-weight:700;text-transform:uppercase}
    .status-aguardando{background:rgba(255,159,67,0.2);color:var(--accent-primary)}
    .status-em-andamento{background:rgba(255,71,87,0.2);color:var(--live-red);animation:pulse-live 2s ease-in-out infinite}
    @keyframes pulse-live{0%,100%{opacity:1}50%{opacity:0.7}}
    .match-middle{display:flex;align-items:center;justify-content:center;gap:20px;padding:12px 0;margin-bottom:10px}
    .match-bet-value{font-size:1.4em;font-weight:800;color:var(--accent-secondary)}.match-bet-label{font-size:0.7em;color:var(--text-secondary);text-align:center}
    .match-challenge-info{font-size:0.75em;color:#60a5fa;text-align:center;padding:6px 12px;background:rgba(59,130,246,0.1);border-radius:8px;margin-bottom:10px}
    .btn-accept{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent-primary),#ff8c42);border:none;border-radius:12px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px var(--accent-glow)}
    .btn-accept:hover{transform:translateY(-2px)}.btn-accept:active{transform:scale(0.97)}
    .btn-enter{width:100%;padding:12px;background:linear-gradient(135deg,var(--live-red),#ff6b81);border:none;border-radius:12px;color:white;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.85em;cursor:pointer;transition:all 0.3s}
    .btn-cancel-match{width:100%;padding:12px;margin-top:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.8em;cursor:pointer;transition:all 0.3s}
    .btn-cancel-match:hover{background:rgba(255,71,87,0.1);border-color:rgba(255,71,87,0.3);color:var(--live-red)}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-secondary)}.empty-icon{font-size:3em;margin-bottom:12px}
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(8px)}
    .modal-overlay.active{display:flex}
    .modal-card{background:linear-gradient(135deg,#1e2936,#18222e);border-radius:24px;padding:30px;max-width:420px;width:92%;border:1px solid rgba(255,181,71,0.3);animation:modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:85vh;overflow-y:auto}
    @keyframes modalPop{from{opacity:0;transform:scale(0.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal-title{font-size:1.3em;font-weight:800;text-align:center;margin-bottom:20px}
    .modal-field{margin-bottom:16px}.modal-label{font-size:0.8em;color:var(--text-secondary);margin-bottom:6px}
    .modal-input{width:100%;padding:14px 16px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:1.2em;font-weight:700;text-align:center;outline:none;transition:border-color 0.3s}
    .modal-input:focus{border-color:var(--accent-primary)}
    .modal-hint{font-size:0.75em;color:var(--text-secondary);text-align:center;margin-top:4px}
    .modal-presets{display:flex;gap:8px;margin-bottom:16px;justify-content:center;flex-wrap:wrap}
    .preset-btn{padding:8px 16px;background:rgba(255,159,67,0.1);border:1px solid rgba(255,159,67,0.2);border-radius:10px;color:var(--accent-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85em;cursor:pointer;transition:all 0.3s}
    .preset-btn:hover,.preset-btn.active{background:rgba(255,159,67,0.25);border-color:var(--accent-primary)}
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .modal-actions button{flex:1;padding:14px;border-radius:12px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;transition:all 0.3s}
    .btn-modal-confirm{background:linear-gradient(135deg,var(--win-green),#7bed9f);color:var(--bg-dark);box-shadow:0 4px 15px rgba(46,213,115,0.3)}
    .btn-modal-cancel{background:rgba(255,255,255,0.08);color:var(--text-secondary)}
    .friends-list{max-height:300px;overflow-y:auto;margin-bottom:16px}
    .friend-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
    .friend-item:hover{background:rgba(255,255,255,0.05)}.friend-item.selected{background:rgba(59,130,246,0.15);border-color:#3b82f6}
    .friend-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85em;color:white;flex-shrink:0;overflow:hidden}
    .friend-info{flex:1}.friend-name{font-weight:600;font-size:0.9em}.friend-credits{font-size:0.75em;color:var(--text-secondary)}
    .friend-check{font-size:1.2em;opacity:0;transition:opacity 0.2s}.friend-item.selected .friend-check{opacity:1}
    .friends-empty{text-align:center;padding:30px 10px;color:var(--text-secondary);font-size:0.85em}
    .friends-search{width:100%;padding:10px 14px;margin-bottom:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:0.85em;outline:none}
    .friends-search:focus{border-color:#3b82f6}
    .team-picker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:240px;overflow-y:auto;padding:4px}
    .team-pick{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;border-radius:12px;border:2px solid transparent;cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.03)}
    .team-pick:hover{background:rgba(255,255,255,0.06)}
    .team-pick.selected{border-color:var(--accent-primary);background:rgba(255,159,67,0.12)}
    .team-pick-shield{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.65em;color:white;overflow:hidden}
    .team-pick-shield svg{width:36px;height:42px}
    .team-pick-name{font-size:0.6em;font-weight:600;color:var(--text-secondary);text-align:center;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .team-pick.selected .team-pick-name{color:var(--accent-primary)}
    .team-search{width:100%;padding:8px 12px;margin-bottom:10px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-size:0.8em;outline:none}
    .team-search:focus{border-color:var(--accent-primary)}
    .ranking-link{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;background:linear-gradient(135deg,rgba(168,85,247,0.12),rgba(168,85,247,0.04));border:1px solid rgba(168,85,247,0.25);border-radius:14px;color:#c084fc;font-weight:600;font-size:0.85em;text-decoration:none;margin-bottom:20px;transition:all 0.3s}
    .ranking-link:hover{background:rgba(168,85,247,0.2);transform:translateY(-1px)}
    .match-team-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.7em;padding:2px 8px;border-radius:6px;font-weight:600;margin-top:2px}
    .accept-team-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:2001;justify-content:center;align-items:center;backdrop-filter:blur(8px)}
    .accept-team-modal.active{display:flex}
    .history-card{background:var(--bg-card);border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .history-card.win{border-left:3px solid var(--win-green)}.history-card.loss{border-left:3px solid var(--live-red)}
    .history-info{flex:1}.history-opponent{font-weight:600;font-size:0.85em}.history-score{font-size:0.75em;color:var(--text-secondary)}
    .history-result{font-weight:700;font-size:0.85em;padding:4px 12px;border-radius:8px}
    .history-result.win{background:rgba(46,213,115,0.15);color:var(--win-green)}.history-result.loss{background:rgba(255,71,87,0.15);color:var(--live-red)}.history-result.draw{background:rgba(255,159,67,0.15);color:#ff9f43}
    .rules-card{background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:16px;padding:18px;margin-bottom:24px}
    .rules-title{font-weight:700;font-size:0.95em;margin-bottom:10px;display:flex;align-items:center;gap:8px}
    .rule-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:0.8em;color:var(--text-secondary);line-height:1.4}
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,0.9);color:white;padding:15px 30px;border-radius:50px;font-weight:600;z-index:3000;opacity:0;transition:all 0.3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    /* SHARE MODAL */
    .share-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:2002;justify-content:center;align-items:center;backdrop-filter:blur(8px)}
    .share-overlay.active{display:flex}
    .share-card{background:linear-gradient(135deg,#1e2936,#18222e);border-radius:24px;padding:28px;max-width:380px;width:92%;border:1px solid rgba(46,213,115,0.3);animation:modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);text-align:center}
    .share-icon{font-size:2.8em;margin-bottom:8px}
    .share-title{font-size:1.2em;font-weight:800;margin-bottom:4px;color:var(--win-green)}
    .share-subtitle{font-size:0.8em;color:var(--text-secondary);margin-bottom:18px}
    .share-link-box{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:14px}
    .share-link-text{flex:1;font-size:0.7em;color:var(--text-secondary);word-break:break-all;text-align:left;font-family:monospace}
    .share-link-copy{padding:8px 14px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:var(--text-primary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.8em;cursor:pointer;transition:all 0.2s;flex-shrink:0}
    .share-link-copy:hover{background:rgba(255,255,255,0.2)}
    .share-timer{font-size:0.75em;color:var(--accent-primary);margin-bottom:16px;font-weight:600}
    .share-btns{display:flex;flex-direction:column;gap:8px}
    .btn-share-whats{padding:14px;background:linear-gradient(135deg,#25d366,#128c7e);border:none;border-radius:12px;color:white;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s}
    .btn-share-whats:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(37,211,102,0.3)}
    .btn-share-close{padding:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--text-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:0.85em;cursor:pointer}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(14,20,27,0.98);backdrop-filter:blur(20px);padding:10px 20px;border-top:1px solid rgba(255,255,255,0.1);z-index:99}
    .nav-content{max-width:600px;margin:0 auto;display:flex;justify-content:space-around}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#a9b5c6;text-decoration:none;font-size:0.75em;transition:all 0.3s;padding:5px 10px}
    .nav-item:hover{color:#ffb547}.nav-icon{font-size:1.5em}
  </style>
</head>
<body>
  <div class="header"><div class="header-content">
    <div class="logo"><img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'"></div>
    <a href="painel.html" class="btn-back">‚Üê Voltar</a>
  </div></div>

  <div class="container">
    <div class="hero"><div class="hero-icon">‚öΩ</div><h1>Disputa de P√™naltis</h1><p>Desafie outros jogadores em cobran√ßas!</p></div>
    <div class="credits-bar"><span class="credits-label">üí∞ Seus cr√©ditos</span><span class="credits-value" id="myCredits">0</span></div>

    <div class="buttons-row">
      <button class="btn-create" onclick="abrirModalCriar('publica')">‚öΩ Criar Disputa</button>
      <button class="btn-challenge" onclick="abrirModalCriar('amigo')">üë• Desafiar Amigo</button>
    </div>

    <a href="ranking-penaltis.html" class="ranking-link">üèÜ Ver Ranking de P√™naltis ‚Üí</a>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('abertas')" id="tabAbertas">üî¥ Abertas</div>
      <div class="tab" onclick="switchTab('minhas')" id="tabMinhas">‚ö° Minhas</div>
      <div class="tab" onclick="switchTab('historico')" id="tabHistorico">üìã Hist√≥rico</div>
    </div>

    <div id="contentAbertas" class="matches-list"><div class="empty-state"><div class="empty-icon">‚öΩ</div><p>Carregando...</p></div></div>
    <div id="contentMinhas" class="matches-list" style="display:none;"><div class="empty-state"><div class="empty-icon">üí§</div><p>Carregando...</p></div></div>
    <div id="contentHistorico" class="matches-list" style="display:none;"><div class="empty-state"><div class="empty-icon">üìã</div><p>Carregando...</p></div></div>

    <div class="rules-card">
      <div class="rules-title">üìñ Como Funciona</div>
      <div class="rule-item"><span>ü•Ö</span><span>O gol tem 9 quadrantes (3√ó3)</span></div>
      <div class="rule-item"><span>üîÑ</span><span>5 cobran√ßas para cada (10 rodadas)</span></div>
      <div class="rule-item"><span>üéØ</span><span>Cobrador escolhe onde chutar, goleiro onde defender</span></div>
      <div class="rule-item"><span>üß§</span><span>Se acertar o quadrante = defende!</span></div>
      <div class="rule-item"><span>üí∞</span><span>Vencedor leva os cr√©ditos apostados</span></div>
      <div class="rule-item"><span>‚ö°</span><span>Morte s√∫bita se empatar ap√≥s 5√ó5</span></div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalCriar" onclick="if(event.target===this)fecharModal()">
    <div class="modal-card">
      <div class="modal-title" id="modalTitle">‚öΩ Criar Disputa</div>
      <div id="friendPickerSection" style="display:none;">
        <div class="modal-field">
          <div class="modal-label">Escolha um amigo para desafiar</div>
          <input type="text" class="friends-search" id="searchFriend" placeholder="üîç Buscar..." oninput="filtrarAmigos()">
          <div class="friends-list" id="friendsList"><div class="friends-empty">Carregando...</div></div>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">üéΩ Escolha seu time</div>
        <input type="text" class="team-search" id="searchTeam" placeholder="üîç Buscar time..." oninput="filtrarTimes()">
        <div class="team-picker-grid" id="teamPickerGrid"><div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.8em;padding:20px">Carregando times...</div></div>
      </div>
      <div class="modal-field">
        <div class="modal-label">Quanto apostar?</div>
        <div class="modal-presets">
          <button class="preset-btn" onclick="setValor(5)">5</button>
          <button class="preset-btn" onclick="setValor(10)">10</button>
          <button class="preset-btn" onclick="setValor(25)">25</button>
          <button class="preset-btn" onclick="setValor(50)">50</button>
          <button class="preset-btn" onclick="setValor(100)">100</button>
        </div>
        <input type="number" class="modal-input" id="inputValor" value="10" min="1">
        <div class="modal-hint">Cr√©ditos que cada jogador aposta</div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="fecharModal()">Cancelar</button>
        <button class="btn-modal-confirm" id="btnModalConfirm" onclick="criarDisputa()">‚öΩ Criar!</button>
      </div>
    </div>
  </div>

  <!-- ACCEPT TEAM MODAL -->
  <div class="accept-team-modal" id="modalAcceptTeam" onclick="if(event.target===this)fecharAcceptTeam()">
    <div class="modal-card">
      <div class="modal-title" id="acceptTeamTitle">üéΩ Escolha seu time</div>
      <div class="modal-field">
        <div class="modal-label">Selecione o time para esta disputa</div>
        <input type="text" class="team-search" id="searchTeamAccept" placeholder="üîç Buscar time..." oninput="filtrarTimesAccept()">
        <div class="team-picker-grid" id="teamPickerAccept"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="fecharAcceptTeam()">Cancelar</button>
        <button class="btn-modal-confirm" onclick="confirmarAceitar()">‚öΩ Aceitar!</button>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div class="share-overlay" id="shareModal" onclick="if(event.target===this)fecharShare()">
    <div class="share-card">
      <div class="share-icon">‚öΩ</div>
      <div class="share-title">Disputa Criada!</div>
      <div class="share-subtitle">Envie o link para algu√©m aceitar o desafio</div>
      <div class="share-link-box">
        <div class="share-link-text" id="shareLinkText">...</div>
        <button class="share-link-copy" onclick="copiarLink()">üìã Copiar</button>
      </div>
      <div class="share-timer" id="shareTimer">‚è∞ Expira em 5:00</div>
      <div class="share-btns">
        <button class="btn-share-whats" id="btnShareWhats" onclick="compartilharWhats()">üì± Compartilhar no WhatsApp</button>
        <button class="btn-share-close" onclick="fecharShare()">Voltar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <nav class="bottom-nav"><div class="nav-content">
    <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
    <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
    <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
    <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
  </div></nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));

    let currentUser=null,currentUserData=null,allMatches=[],allFriends=[],allUsers=[],friendUids=new Set(),selectedFriendUid=null,modalMode='publica',currentTab='abertas';
    let allTimes=[],selectedTimeId=null,selectedTimeData=null;
    let acceptingMatchId=null,acceptingMatchValor=0,selectedTimeAcceptId=null,selectedTimeAcceptData=null;
    let unsubDisputas=null;
    let shareMatchId=null,shareTimerInterval=null;
    const STALE_TIMEOUT=5*60*1000; // 5 minutos (era 1 hora)
    const MAX_HISTORY=5;

    // ===== CAMISETA SVG =====
    function gerarCamisetaSVG(c1,c2,c3){
      c1=c1||'#28a745';c2=c2||'#fff';c3=c3||c1;
      const u=Math.random().toString(36).substr(2,6);
      return `<svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="sh_${u}" x1=".2" y1="0" x2=".8" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,.28)"/><stop offset="45%" stop-color="rgba(255,255,255,.03)"/><stop offset="100%" stop-color="rgba(0,0,0,.08)"/></linearGradient><linearGradient id="sl_${u}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="100%" stop-color="${c3}"/></linearGradient></defs><g><path d="M28,32 Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 Q72,28 72,32 L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" fill="${c1}"/><path d="M28,32 L10,46 Q6,49 7,54 L10,68 Q11,72 15,70 L26,58 Z" fill="url(#sl_${u})"/><path d="M72,32 L90,46 Q94,49 93,54 L90,68 Q89,72 85,70 L74,58 Z" fill="url(#sl_${u})"/><path d="M26,40 L28,105" stroke="${c2}" stroke-width="3" opacity=".5" stroke-linecap="round"/><path d="M74,40 L72,105" stroke="${c2}" stroke-width="3" opacity=".5" stroke-linecap="round"/><path d="M28,32 Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 Q72,28 72,32 L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" fill="url(#sh_${u})"/><path d="M43,26 L50,32 L57,26" fill="none" stroke="${c2}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></g></svg>`;
    }

    auth.onAuthStateChanged(async user=>{
      if(!user){window.location.href='index.html';return}
      currentUser=user;
      try{
        const doc=await db.collection('usuarios').doc(user.uid).get();
        if(doc.exists){currentUserData=doc.data();document.getElementById('myCredits').textContent=(currentUserData.creditos||0).toLocaleString()}
      }catch(e){console.error('User data error:',e)}
      carregarDisputas();
      carregarAmigos();
      carregarTimes();
      limparJogosPresos();
    });

    // Fix freeze: reload user data when returning from arena/other pages
    document.addEventListener('visibilitychange',async()=>{
      if(document.visibilityState==='visible'&&currentUser){
        try{
          const doc=await db.collection('usuarios').doc(currentUser.uid).get();
          if(doc.exists){currentUserData=doc.data();document.getElementById('myCredits').textContent=(currentUserData.creditos||0).toLocaleString()}
          renderCurrentTab();
        }catch(e){console.error('Refresh:',e)}
      }
    });

    // SIMPLE QUERY - no composite index needed, just orderBy timestamp
    function carregarDisputas(){
      if(unsubDisputas) unsubDisputas();
      unsubDisputas=db.collection('penaltis').orderBy('criadoEm','desc').limit(30).onSnapshot(snap=>{
        allMatches=[];
        snap.forEach(doc=>allMatches.push({id:doc.id,...doc.data()}));
        allMatches.sort((a,b)=>(b.criadoEm?.seconds||0)-(a.criadoEm?.seconds||0));
        renderCurrentTab();
      },err=>{
        console.error('Query error:',err);
        renderCurrentTab();
      });
    }

    async function carregarAmigos(){
      try{
        friendUids=new Set();
        allFriends=[];

        // Load real friendships where user is remetente
        const snap1=await db.collection('amizades').where('remetenteId','==',currentUser.uid).where('status','==','aceita').get();
        snap1.forEach(doc=>{const d=doc.data();friendUids.add(d.destinatarioId)});

        // Load real friendships where user is destinatario
        const snap2=await db.collection('amizades').where('destinatarioId','==',currentUser.uid).where('status','==','aceita').get();
        snap2.forEach(doc=>{const d=doc.data();friendUids.add(d.remetenteId)});

        console.log('üë• Amigos encontrados:',friendUids.size);

        // Load friend user data
        if(friendUids.size>0){
          const uids=Array.from(friendUids);
          // Firestore 'in' supports max 30 items
          for(let i=0;i<uids.length;i+=30){
            const batch=uids.slice(i,i+30);
            const snap=await db.collection('usuarios').where(firebase.firestore.FieldPath.documentId(),'in',batch).get();
            snap.forEach(doc=>{
              if(doc.id===currentUser.uid) return;
              const d=doc.data();
              if(d.status==='bloqueado') return;
              allFriends.push({uid:doc.id,nome:d.usuarioUnico||d.usuario||d.nome||'Jogador',creditos:d.creditos||0,avatarUrl:d.avatarUrl||null,isFriend:true});
            });
          }
        }
        allFriends.sort((a,b)=>a.nome.localeCompare(b.nome));
      }catch(e){
        console.error('Amigos:',e);
        // Fallback: load all users if amizades query fails (index issue)
        try{
          const snap=await db.collection('usuarios').limit(50).get();
          allFriends=[];
          snap.forEach(doc=>{
            if(doc.id===currentUser.uid) return;
            const d=doc.data();
            if(d.status==='bloqueado') return;
            allFriends.push({uid:doc.id,nome:d.usuarioUnico||d.usuario||d.nome||'Jogador',creditos:d.creditos||0,avatarUrl:d.avatarUrl||null,isFriend:false});
          });
          allFriends.sort((a,b)=>a.nome.localeCompare(b.nome));
        }catch(e2){console.error('Fallback:',e2)}
      }
    }

    async function buscarTodosUsuarios(){
      if(allUsers.length>0) return; // already loaded
      try{
        const snap=await db.collection('usuarios').limit(100).get();
        allUsers=[];
        snap.forEach(doc=>{
          if(doc.id===currentUser.uid) return;
          const d=doc.data();
          if(d.status==='bloqueado') return;
          allUsers.push({uid:doc.id,nome:d.usuarioUnico||d.usuario||d.nome||'Jogador',creditos:d.creditos||0,avatarUrl:d.avatarUrl||null,isFriend:friendUids.has(doc.id)});
        });
      }catch(e){console.error('AllUsers:',e)}
    }

    async function carregarTimes(){
      try{
        const snap=await db.collection('times').orderBy('nome').get();
        allTimes=[];
        snap.forEach(doc=>{
          const d=doc.data();
          allTimes.push({id:doc.id,nome:d.nome||'Time',abreviacao:d.abreviacao||d.nome?.substring(0,3).toUpperCase()||'???',primaria:d.primaria||'#333',secundaria:d.secundaria||'#fff',terciaria:d.terciaria||'#333',escudo:d.escudo||null});
        });
        console.log('‚öΩ Times carregados:', allTimes.length, allTimes.slice(0,3).map(t=>t.nome+' '+t.primaria));
        // Pre-select user's favorite team
        if(currentUserData?.timeId){
          const fav=allTimes.find(t=>t.id===currentUserData.timeId);
          if(fav){selectedTimeId=fav.id;selectedTimeData=fav}
        }
        renderTimePicker('teamPickerGrid','create');
        renderTimePicker('teamPickerAccept','accept');
      }catch(e){console.error('Times:',e);
        document.getElementById('teamPickerGrid').innerHTML='<div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.75em;padding:12px">Opcional - jogue sem time</div>';
      }
    }

    function renderTimePicker(containerId,mode,filter=''){
      const c=document.getElementById(containerId);
      const list=filter?allTimes.filter(t=>t.nome.toLowerCase().includes(filter.toLowerCase())):allTimes;
      const selId=mode==='create'?selectedTimeId:selectedTimeAcceptId;

      if(!list.length){c.innerHTML='<div style="grid-column:span 4;text-align:center;color:var(--text-secondary);font-size:0.75em;padding:12px">'+(filter?'Nenhum time encontrado':'Nenhum time cadastrado')+'</div>';return}

      c.innerHTML=list.map(t=>{
        const sel=selId===t.id?'selected':'';
        const jersey=gerarCamisetaSVG(t.primaria,t.secundaria,t.terciaria);
        return `<div class="team-pick ${sel}" onclick="${mode==='create'?'selectTime':'selectTimeAccept'}('${t.id}')">
          <div class="team-pick-shield">${jersey}</div>
          <div class="team-pick-name">${t.nome}</div>
        </div>`;
      }).join('');
    }

    function selectTime(id){
      const t=allTimes.find(x=>x.id===id);
      if(selectedTimeId===id){selectedTimeId=null;selectedTimeData=null}
      else{selectedTimeId=id;selectedTimeData=t}
      renderTimePicker('teamPickerGrid','create',document.getElementById('searchTeam').value);
    }
    function selectTimeAccept(id){
      const t=allTimes.find(x=>x.id===id);
      if(selectedTimeAcceptId===id){selectedTimeAcceptId=null;selectedTimeAcceptData=null}
      else{selectedTimeAcceptId=id;selectedTimeAcceptData=t}
      renderTimePicker('teamPickerAccept','accept',document.getElementById('searchTeamAccept').value);
    }
    function filtrarTimes(){renderTimePicker('teamPickerGrid','create',document.getElementById('searchTeam').value)}
    function filtrarTimesAccept(){renderTimePicker('teamPickerAccept','accept',document.getElementById('searchTeamAccept').value)}

    // TABS
    function switchTab(tab){
      currentTab=tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
      document.getElementById('contentAbertas').style.display=tab==='abertas'?'flex':'none';
      document.getElementById('contentMinhas').style.display=tab==='minhas'?'flex':'none';
      document.getElementById('contentHistorico').style.display=tab==='historico'?'flex':'none';
      renderCurrentTab();
    }

    function renderCurrentTab(){
      if(currentTab==='abertas')renderAbertas();
      else if(currentTab==='minhas')renderMinhas();
      else renderHistorico();
    }

    function renderAbertas(){
      const c=document.getElementById('contentAbertas');
      const list=allMatches.filter(d=>d.status==='aguardando'&&d.jogador1?.uid!==currentUser.uid&&(!d.desafiadoUid||d.desafiadoUid===currentUser.uid)).slice(0,5);
      if(!list.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üò¥</div><p>Nenhuma disputa aberta. Crie uma!</p></div>';return}
      c.innerHTML=list.map(d=>{
        const nome=d.jogador1?.nome||'Jogador',ini=nome.charAt(0).toUpperCase(),tempo=d.criadoEm?.toDate?tempoRelativo(d.criadoEm.toDate()):'',isDesafio=d.desafiadoUid===currentUser.uid;
        const teamBadge=d.jogador1?.time?`<div class="match-team-badge" style="background:${d.jogador1.time.primaria}22;color:${d.jogador1.time.primaria}">${d.jogador1.time.abreviacao||d.jogador1.time.nome}</div>`:'';
        const avatarContent=d.jogador1?.avatarUrl?`<img src="${d.jogador1.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`${ini}`;
        const avatarStyle=d.jogador1?.time?`style="background:linear-gradient(135deg,${d.jogador1.time.primaria},${d.jogador1.time.secundaria})"`:'';
        // Timer de expira√ß√£o
        let expiraHtml='';
        if(d.expiraEm){
          const expMs=(d.expiraEm.toDate?d.expiraEm.toDate():new Date(d.expiraEm)).getTime();
          const restante=Math.max(0,Math.floor((expMs-Date.now())/1000));
          const min=Math.floor(restante/60),seg=restante%60;
          expiraHtml=restante>0?`<div style="font-size:.7em;color:var(--accent-primary);text-align:center;margin-bottom:8px">‚è∞ Expira em ${min}:${String(seg).padStart(2,'0')}</div>`:'';
        }
        return `<div class="match-card"><div class="match-top"><div class="match-creator"><div class="match-avatar" ${avatarStyle}>${avatarContent}</div><div><div class="match-name">${nome}</div>${teamBadge}<div class="match-time">${tempo}</div></div></div><span class="match-status status-aguardando">${isDesafio?'üì© Desafio':'Aguardando'}</span></div>${isDesafio?'<div class="match-challenge-info">üëä Voc√™ foi desafiado!</div>':''}${expiraHtml}<div class="match-middle"><div><div class="match-bet-value">üí∞ ${d.valorAposta}</div><div class="match-bet-label">cr√©ditos cada</div></div></div><button class="btn-accept" onclick="aceitarDisputa('${d.id}',${d.valorAposta})">‚öΩ Aceitar Desafio!</button></div>`
      }).join('');
    }

    function renderMinhas(){
      const c=document.getElementById('contentMinhas');
      const list=allMatches.filter(d=>(d.jogador1?.uid===currentUser.uid||d.jogador2?.uid===currentUser.uid)&&(d.status==='aguardando'||d.status==='em_andamento'));
      if(!list.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üí§</div><p>Nenhuma disputa ativa</p></div>';return}
      c.innerHTML=list.map(d=>{
        const isAg=d.status==='aguardando',isCr=d.jogador1?.uid===currentUser.uid;
        const op=isCr?(d.jogador2?.nome||(d.desafiadoNome||'Aguardando...')):(d.jogador1?.nome||'???');
        const placar=d.placar?`${d.placar.jogador1||0} √ó ${d.placar.jogador2||0}`:'0 √ó 0';
        let info='';if(isAg&&d.desafiadoNome)info=`<div class="match-challenge-info">üì© Desafio enviado para <strong>${d.desafiadoNome}</strong></div>`;
        let btns='';
        if(isAg&&isCr){
          const shareLink=`${window.location.origin}/convite-penalti.html?id=${d.id}`;
          const whatsMsg=encodeURIComponent(`‚öΩ Te desafio para P√™naltis na Yellup! üí∞ ${d.valorAposta} cr√©ditos em jogo!\n\nüîó Aceite: ${shareLink}\n\n‚è∞ V√°lido por 5 min!`);
          btns=`<button class="btn-enter" onclick="window.open('https://wa.me/?text=${whatsMsg}','_blank')" style="background:linear-gradient(135deg,#25d366,#128c7e)">üì± Compartilhar no WhatsApp</button>`;
          btns+=`<button class="btn-cancel-match" onclick="cancelarDisputa('${d.id}')">‚ùå Cancelar</button>`;
        }
        else if(d.status==='em_andamento'){
          btns=`<button class="btn-enter" onclick="window.location.href='arena-penalti.html?id=${d.id}'">üéØ Entrar na Arena</button>`;
          btns+=`<button class="btn-cancel-match" onclick="abandonarDisputa('${d.id}')">üè≥Ô∏è Abandonar Partida</button>`;
        }
        return `<div class="match-card my-match"><div class="match-top"><div class="match-creator"><div class="match-avatar">‚öΩ</div><div><div class="match-name">vs ${op}</div><div class="match-time">${!isAg?'Rodada '+(d.rodadaAtual||1)+' ‚Ä¢ '+placar+' ‚Ä¢ ':''}üí∞ ${d.valorAposta}</div></div></div><span class="match-status ${isAg?'status-aguardando':'status-em-andamento'}">${isAg?'Aguardando':'Ao Vivo'}</span></div>${info}${btns}</div>`
      }).join('');
    }

    let showAllHistory=false;
    function renderHistorico(){
      const c=document.getElementById('contentHistorico');
      const all=allMatches.filter(d=>d.status==='finalizado'&&(d.jogador1?.uid===currentUser.uid||d.jogador2?.uid===currentUser.uid));
      if(!all.length){c.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><p>Jogue sua primeira disputa!</p></div>';return}
      const list=showAllHistory?all:all.slice(0,MAX_HISTORY);
      let html=list.map(d=>{
        const isTimeout=d.vencedor==='empate_timeout';
        const wasAbandoned=!!d.abandonou;
        const w=d.vencedor===currentUser.uid;
        const op=d.jogador1?.uid===currentUser.uid?d.jogador2?.nome:d.jogador1?.nome;
        let resultClass,resultText;
        if(isTimeout){resultClass='draw';resultText='üîÑ '+d.valorAposta}
        else if(w){resultClass='win';resultText='+'+(d.valorAposta*2)}
        else{resultClass='loss';resultText='-'+d.valorAposta}
        const suffix=isTimeout?' (empate/tempo)':wasAbandoned?(d.abandonou===currentUser.uid?' (abandonou)':' (W.O.)'):'';
        return `<div class="history-card ${isTimeout?'':w?'win':'loss'}"><div class="history-info"><div class="history-opponent">vs ${op||'???'}${suffix}</div><div class="history-score">${d.placar?.jogador1||0} √ó ${d.placar?.jogador2||0} ‚Ä¢ üí∞ ${d.valorAposta}</div></div><span class="history-result ${resultClass}">${resultText}</span></div>`
      }).join('');
      if(!showAllHistory&&all.length>MAX_HISTORY){
        html+=`<button onclick="showAllHistory=true;renderHistorico()" style="width:100%;padding:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:var(--text-secondary);font-family:'Poppins',sans-serif;font-weight:600;font-size:.8em;cursor:pointer;margin-top:4px">üìã Ver todos (${all.length} disputas)</button>`;
      }
      c.innerHTML=html;
    }

    // MODAL
    function abrirModalCriar(mode){
      modalMode=mode;selectedFriendUid=null;
      document.getElementById('modalCriar').classList.add('active');
      if(mode==='amigo'){
        document.getElementById('modalTitle').textContent='üë• Desafiar Amigo';
        document.getElementById('friendPickerSection').style.display='block';
        document.getElementById('btnModalConfirm').textContent='‚ö° Desafiar!';
        renderFriendsList();
      }else{
        document.getElementById('modalTitle').textContent='‚öΩ Criar Disputa P√∫blica';
        document.getElementById('friendPickerSection').style.display='none';
        document.getElementById('btnModalConfirm').textContent='‚öΩ Criar!';
      }
    }
    function fecharModal(){document.getElementById('modalCriar').classList.remove('active')}
    function setValor(v){document.getElementById('inputValor').value=v;document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active')}

    function renderFriendsList(filter=''){
      const c=document.getElementById('friendsList');
      let list;
      if(filter){
        // When searching, search through all users (load if needed)
        buscarTodosUsuarios().then(()=>{
          const combined=[...allFriends,...allUsers.filter(u=>!friendUids.has(u.uid)&&!allFriends.find(f=>f.uid===u.uid))];
          const filtered=combined.filter(x=>x.nome.toLowerCase().includes(filter.toLowerCase()));
          renderFriendsListHTML(c,filtered);
        });
        // Show friends matching filter immediately while loading all
        list=allFriends.filter(x=>x.nome.toLowerCase().includes(filter.toLowerCase()));
      }else{
        // No filter: show only friends
        list=allFriends;
      }
      renderFriendsListHTML(c,list);
    }

    function renderFriendsListHTML(c,list){
      if(!list.length){c.innerHTML='<div class="friends-empty">'+(allFriends.length===0?'Nenhum amigo ainda. Digite para buscar jogadores.':'Nenhum jogador encontrado')+'</div>';return}
      c.innerHTML=list.map(x=>{
        const sel=selectedFriendUid===x.uid?'selected':'';
        const badge=x.isFriend?'<span style="font-size:0.65em;background:rgba(46,213,115,0.15);color:#2ed573;padding:1px 6px;border-radius:4px;margin-left:4px">amigo</span>':'';
        const avatar=x.avatarUrl?`<img src="${x.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`${x.nome.charAt(0).toUpperCase()}`;
        return `<div class="friend-item ${sel}" onclick="selectFriend('${x.uid}')"><div class="friend-avatar">${avatar}</div><div class="friend-info"><div class="friend-name">${x.nome}${badge}</div><div class="friend-credits">üí∞ ${x.creditos.toLocaleString()}</div></div><span class="friend-check">‚úÖ</span></div>`
      }).join('');
    }
    function filtrarAmigos(){renderFriendsList(document.getElementById('searchFriend').value)}
    function selectFriend(uid){selectedFriendUid=uid;renderFriendsList(document.getElementById('searchFriend').value)}

    // CRIAR
    async function criarDisputa(){
      const valor=parseInt(document.getElementById('inputValor').value);
      if(!valor||valor<1){showToast('‚ùå Valor inv√°lido');return}
      if((currentUserData?.creditos||0)<valor){showToast('‚ùå Cr√©ditos insuficientes');return}
      if(modalMode==='amigo'&&!selectedFriendUid){showToast('‚ùå Selecione um amigo');return}

      // ‚úÖ Limite: 1 disputa aberta por vez
      const existente=allMatches.find(d=>d.jogador1?.uid===currentUser.uid&&d.status==='aguardando');
      if(existente){showToast('‚ùå Voc√™ j√° tem uma disputa aberta! Cancele antes de criar outra.');return}

      fecharModal();
      try{
        const nome=currentUserData.usuarioUnico||currentUserData.usuario||currentUserData.nome||'Jogador';
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(-valor)});
        const j1={uid:currentUser.uid,nome,avatarUrl:currentUserData.avatarUrl||null};
        if(selectedTimeData) j1.time={id:selectedTimeData.id,nome:selectedTimeData.nome,primaria:selectedTimeData.primaria,secundaria:selectedTimeData.secundaria,terciaria:selectedTimeData.terciaria,abreviacao:selectedTimeData.abreviacao};
        console.log('üéΩ Criando disputa - j1:', JSON.stringify(j1));
        const matchData={jogador1:j1,jogador2:null,status:'aguardando',valorAposta:valor,rodadaAtual:1,rodadas:[],placar:{jogador1:0,jogador2:0},escolhaJogador1:null,escolhaJogador2:null,vencedor:null,criadoEm:firebase.firestore.FieldValue.serverTimestamp(),expiraEm:new Date(Date.now()+5*60*1000)};
        if(modalMode==='amigo'&&selectedFriendUid){
          const amigo=allFriends.find(f=>f.uid===selectedFriendUid);
          matchData.desafiadoUid=selectedFriendUid;
          matchData.desafiadoNome=amigo?.nome||'Amigo';
          await db.collection('notificacoes').add({para:selectedFriendUid,de:currentUser.uid,tipo:'desafio_penalti',titulo:'‚öΩ Desafio de P√™naltis!',mensagem:`${nome} te desafiou para p√™naltis! üí∞ ${valor} cr√©ditos`,link:'penaltis.html',lida:false,data:firebase.firestore.FieldValue.serverTimestamp()});
        }
        const docRef=await db.collection('penaltis').add(matchData);
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'saida',valor,descricao:`P√™naltis: aposta de ${valor} cr√©ditos`,data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos-=valor;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();

        // ‚úÖ Mostrar modal de compartilhamento
        abrirShare(docRef.id, valor, nome);

      }catch(e){console.error('Criar:',e);showToast('‚ùå Erro ao criar')}
    }

    // ACEITAR - show team picker first
    function aceitarDisputa(id,valor){
      if((currentUserData?.creditos||0)<valor){showToast('‚ùå Cr√©ditos insuficientes');return}
      acceptingMatchId=id;acceptingMatchValor=valor;
      selectedTimeAcceptId=selectedTimeId;selectedTimeAcceptData=selectedTimeData; // pre-select favorite
      renderTimePicker('teamPickerAccept','accept');
      document.getElementById('modalAcceptTeam').classList.add('active');
    }
    function fecharAcceptTeam(){document.getElementById('modalAcceptTeam').classList.remove('active');acceptingMatchId=null}

    async function confirmarAceitar(){
      if(!acceptingMatchId) return;
      const id=acceptingMatchId,valor=acceptingMatchValor;
      document.getElementById('modalAcceptTeam').classList.remove('active');
      try{
        const nome=currentUserData.usuarioUnico||currentUserData.usuario||currentUserData.nome||'Jogador';
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(-valor)});
        const j2={uid:currentUser.uid,nome,avatarUrl:currentUserData.avatarUrl||null};
        if(selectedTimeAcceptData) j2.time={id:selectedTimeAcceptData.id,nome:selectedTimeAcceptData.nome,primaria:selectedTimeAcceptData.primaria,secundaria:selectedTimeAcceptData.secundaria,terciaria:selectedTimeAcceptData.terciaria,abreviacao:selectedTimeAcceptData.abreviacao};
        console.log('üéΩ Aceitando disputa - j2:', JSON.stringify(j2));
        await db.collection('penaltis').doc(id).update({jogador2:j2,status:'em_andamento'});
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'saida',valor,descricao:`P√™naltis: aposta de ${valor} cr√©ditos`,data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos-=valor;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();
        showToast('‚úÖ Aceito! Entrando na arena...');
        setTimeout(()=>window.location.href=`arena-penalti.html?id=${id}`,800);
      }catch(e){console.error('Aceitar:',e);showToast('‚ùå Erro ao aceitar')}
    }

    // CANCELAR
    async function cancelarDisputa(id){
      try{
        const doc=await db.collection('penaltis').doc(id).get();
        const d=doc.data();
        if(d.jogador1.uid!==currentUser.uid||d.status!=='aguardando'){showToast('‚ùå N√£o pode cancelar');return}
        await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(d.valorAposta)});
        await db.collection('penaltis').doc(id).delete();
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:d.valorAposta,descricao:'P√™naltis: cancelada (reembolso)',data:firebase.firestore.FieldValue.serverTimestamp()});
        currentUserData.creditos+=d.valorAposta;
        document.getElementById('myCredits').textContent=currentUserData.creditos.toLocaleString();
        showToast('‚úÖ Cancelada, cr√©ditos devolvidos');
      }catch(e){console.error('Cancelar:',e);showToast('‚ùå Erro')}
    }

    // AUTO-CLEANUP: finalize stuck games (>10 min em_andamento) + stale aguardando (>1 hour)
    // Each player only updates their OWN credits. Opponent claims via resgatarCreditos()
    async function limparJogosPresos(){
      try{
        const agora=Date.now();
        const TIMEOUT=10*60*1000;
        const STALE_TIMEOUT=5*60*1000; // 5 minutos

        // Clean stuck em_andamento games where I'm involved
        const snapEm=await db.collection('penaltis').where('status','==','em_andamento').get();
        for(const doc of snapEm.docs){
          const d=doc.data();
          if(!d.criadoEm||!d.criadoEm.toDate) continue;
          const elapsed=agora-d.criadoEm.toDate().getTime();
          if(elapsed<TIMEOUT) continue;
          // Only jogador1 finalizes the match (to avoid double writes)
          if(d.jogador1?.uid!==currentUser.uid) continue;

          console.log('üßπ Auto-cleaning stuck game:',doc.id);
          const p1s=d.placar?.jogador1||0, p2s=d.placar?.jogador2||0;
          const aposta=d.valorAposta||0;

          if(p1s===p2s){
            // Tie - refund myself (jogador1), store pending for jogador2
            await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(aposta)});
            await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:aposta,descricao:'P√™naltis: empate por tempo (reembolso)',data:firebase.firestore.FieldValue.serverTimestamp()});
            const pendente=d.jogador2?.uid?{uid:d.jogador2.uid,valor:aposta,tipo:'reembolso'}:null;
            await db.collection('penaltis').doc(doc.id).update({status:'finalizado',vencedor:'empate_timeout',creditoPendente:pendente,j1Resgatado:true});
          }else{
            const vencedorUid=p1s>p2s?d.jogador1.uid:d.jogador2.uid;
            const premio=aposta*2;
            // If I'm the winner, credit myself; otherwise store pending
            if(vencedorUid===currentUser.uid){
              await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(premio)});
              await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:premio,descricao:'P√™naltis: vit√≥ria por tempo (+'+premio+')',data:firebase.firestore.FieldValue.serverTimestamp()});
              await db.collection('penaltis').doc(doc.id).update({status:'finalizado',vencedor:vencedorUid,timeout:true,j1Resgatado:true});
            }else{
              await db.collection('penaltis').doc(doc.id).update({status:'finalizado',vencedor:vencedorUid,timeout:true,creditoPendente:{uid:vencedorUid,valor:premio,tipo:'vitoria'},j1Resgatado:true});
            }
          }
        }

        // Clean stale aguardando matches (>1 hour, refund creator = me)
        const snapAg=await db.collection('penaltis').where('status','==','aguardando').get();
        for(const doc of snapAg.docs){
          const d=doc.data();
          if(!d.criadoEm||!d.criadoEm.toDate) continue;
          const elapsed=agora-d.criadoEm.toDate().getTime();
          if(elapsed<STALE_TIMEOUT) continue;
          if(d.jogador1?.uid!==currentUser.uid) continue;

          console.log('üßπ Auto-canceling stale match:',doc.id);
          const aposta=d.valorAposta||0;
          await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(aposta)});
          await db.collection('penaltis').doc(doc.id).update({status:'cancelado'});
          await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:aposta,descricao:'P√™naltis: disputa expirada (reembolso)',data:firebase.firestore.FieldValue.serverTimestamp()});
        }

        // CLAIM PENDING CREDITS: check finalized games where I'm owed credits
        await resgatarCreditos();

        // Refresh credits display
        const myDoc=await db.collection('usuarios').doc(currentUser.uid).get();
        if(myDoc.exists){currentUserData=myDoc.data();document.getElementById('myCredits').textContent=(currentUserData.creditos||0).toLocaleString()}
      }catch(e){console.error('Cleanup:',e)}
    }

    // RESGATAR: claim pending credits from finalized games
    async function resgatarCreditos(){
      try{
        // Find games where I have pending credits
        const snap=await db.collection('penaltis').where('status','==','finalizado').where('creditoPendente.uid','==',currentUser.uid).get();
        for(const doc of snap.docs){
          const d=doc.data();
          const pendente=d.creditoPendente;
          if(!pendente||pendente.uid!==currentUser.uid) continue;

          console.log('üí∞ Claiming pending credits from:',doc.id,'valor:',pendente.valor);
          await db.collection('usuarios').doc(currentUser.uid).update({creditos:firebase.firestore.FieldValue.increment(pendente.valor)});
          const desc=pendente.tipo==='wo'?`P√™naltis: vit√≥ria por W.O. (+${pendente.valor})`:pendente.tipo==='reembolso'?`P√™naltis: empate por tempo (reembolso)`:`P√™naltis: vit√≥ria por tempo (+${pendente.valor})`;
          await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({tipo:'entrada',valor:pendente.valor,descricao:desc,data:firebase.firestore.FieldValue.serverTimestamp()});
          // Clear the pending flag
          await db.collection('penaltis').doc(doc.id).update({creditoPendente:firebase.firestore.FieldValue.delete()});
        }
      }catch(e){console.error('Resgate:',e)}
    }

    // ABANDONAR (player forfeits - opponent wins)
    async function abandonarDisputa(id){
      if(!confirm('üè≥Ô∏è Tem certeza? Voc√™ perder√° seus cr√©ditos apostados.')) return;
      try{
        const doc=await db.collection('penaltis').doc(id).get();
        const d=doc.data();
        if(d.status!=='em_andamento'){showToast('‚ùå Partida n√£o est√° em andamento');return}
        const isP1=d.jogador1?.uid===currentUser.uid;
        const vencedorUid=isP1?d.jogador2.uid:d.jogador1.uid;
        const perdedorUid=currentUser.uid;
        const premio=d.valorAposta*2;
        // Only update penaltis doc - credits will be claimed by winner on their next page load
        await db.collection('penaltis').doc(id).update({
          status:'finalizado',
          vencedor:vencedorUid,
          abandonou:perdedorUid,
          creditoPendente:{uid:vencedorUid,valor:premio,tipo:'wo'}
        });
        // Notify winner
        const nomePerdedor=isP1?d.jogador1.nome:d.jogador2.nome;
        try{
          await db.collection('notificacoes').add({para:vencedorUid,tipo:'penalti_resultado',titulo:'üèÜ Vit√≥ria por W.O.!',mensagem:`${nomePerdedor} abandonou a partida! Voc√™ ganhou ${d.valorAposta} cr√©ditos.`,link:'penaltis.html',lida:false,data:firebase.firestore.FieldValue.serverTimestamp()});
        }catch(e){console.warn('Notif:',e)}
        showToast('üè≥Ô∏è Partida abandonada. Cr√©ditos perdidos.');
        renderCurrentTab();
      }catch(e){console.error('Abandonar:',e);showToast('‚ùå Erro ao abandonar')}
    }

    // ===== COMPARTILHAMENTO =====
    function abrirShare(matchId, valor, nomeJogador){
      shareMatchId=matchId;
      const baseUrl=window.location.origin;
      const link=`${baseUrl}/convite-penalti.html?id=${matchId}`;

      document.getElementById('shareLinkText').textContent=link;
      document.getElementById('shareModal').classList.add('active');

      // Timer visual de 5 minutos
      let restante=5*60;
      clearInterval(shareTimerInterval);
      shareTimerInterval=setInterval(()=>{
        restante--;
        if(restante<=0){clearInterval(shareTimerInterval);fecharShare();return}
        const min=Math.floor(restante/60),seg=restante%60;
        const el=document.getElementById('shareTimer');
        if(el) el.textContent=`‚è∞ Expira em ${min}:${String(seg).padStart(2,'0')}`;
      },1000);

      // WhatsApp message
      const whatsMsg=encodeURIComponent(`‚öΩ ${nomeJogador} te desafia para P√™naltis na Yellup! üí∞ ${valor} cr√©ditos em jogo!\n\nüîó Aceite aqui: ${link}\n\n‚è∞ V√°lido por 5 minutos!`);
      document.getElementById('btnShareWhats').onclick=()=>{
        window.open(`https://wa.me/?text=${whatsMsg}`,'_blank');
      };

      switchTab('minhas');
    }

    function copiarLink(){
      const link=document.getElementById('shareLinkText').textContent;
      if(navigator.clipboard){
        navigator.clipboard.writeText(link).then(()=>showToast('üìã Link copiado!')).catch(()=>fallbackCopy(link));
      }else{fallbackCopy(link)}
    }
    function fallbackCopy(text){
      const ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.opacity='0';
      document.body.appendChild(ta);ta.select();
      try{document.execCommand('copy');showToast('üìã Link copiado!')}catch(e){showToast('‚ùå Erro ao copiar')}
      document.body.removeChild(ta);
    }

    function compartilharWhats(){
      // handled by onclick set in abrirShare
    }

    function fecharShare(){
      document.getElementById('shareModal').classList.remove('active');
      clearInterval(shareTimerInterval);
      shareMatchId=null;
    }

    function tempoRelativo(date){const d=Date.now()-date.getTime(),m=Math.floor(d/60000);if(m<1)return'Agora';if(m<60)return m+'min';const h=Math.floor(m/60);if(h<24)return h+'h';return Math.floor(h/24)+'d'}
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
