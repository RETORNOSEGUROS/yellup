<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0e13;
      --bg-card: #131920;
      --bg-elevated: #1a2230;
      --accent-primary: #ff9f43;
      --accent-secondary: #ffc048;
      --accent-glow: rgba(255, 159, 67, 0.25);
      --live-red: #ff4757;
      --win-green: #2ed573;
      --text-primary: #f1f2f6;
      --text-secondary: #a4b0be;
      --field-green: #1b5e20;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse at top, rgba(255, 159, 67, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, rgba(26, 34, 48, 0.5) 0%, transparent 50%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .header {
      background: rgba(10, 14, 19, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(255, 159, 67, 0.1);
    }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .logo img { height: 36px; filter: drop-shadow(0 2px 8px rgba(255, 181, 71, 0.3)); }
    .btn-back {
      padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px; color: #e7eef7; cursor: pointer; font-family: 'Poppins', sans-serif;
      font-size: 0.85em; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: all 0.3s;
    }
    .btn-back:hover { background: rgba(255,255,255,0.2); }

    .container { max-width: 600px; margin: 0 auto; padding: 24px 20px; }

    /* HERO */
    .hero {
      text-align: center; padding: 30px 20px; margin-bottom: 24px;
      background: linear-gradient(145deg, rgba(27, 94, 32, 0.15), rgba(46, 125, 50, 0.08));
      border: 1px solid rgba(46, 125, 50, 0.3);
      border-radius: 20px; position: relative; overflow: hidden;
    }
    .hero::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, var(--win-green), var(--accent-primary), var(--win-green));
      background-size: 200% 100%; animation: shimmerBar 3s linear infinite;
    }
    @keyframes shimmerBar { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .hero-icon { font-size: 3.5em; margin-bottom: 8px; }
    .hero h1 { font-size: 1.6em; font-weight: 800; margin-bottom: 4px; }
    .hero p { color: var(--text-secondary); font-size: 0.9em; }

    /* MY CREDITS */
    .credits-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 18px; margin-bottom: 20px;
      background: var(--bg-card); border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .credits-label { font-size: 0.85em; color: var(--text-secondary); }
    .credits-value { font-size: 1.3em; font-weight: 800; color: var(--accent-secondary); }

    /* CREATE BUTTON */
    .btn-create {
      width: 100%; padding: 16px; margin-bottom: 24px;
      background: linear-gradient(135deg, var(--win-green), #7bed9f);
      border: none; border-radius: 14px;
      color: var(--bg-dark); font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 1em; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 4px 20px rgba(46, 213, 115, 0.3);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-create:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(46, 213, 115, 0.4); }
    .btn-create:active { transform: scale(0.97); }

    /* SECTION */
    .section-title {
      font-size: 1.1em; font-weight: 700; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-count { font-size: 0.8em; color: var(--text-secondary); font-weight: 400; }

    /* MATCH CARD */
    .matches-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }

    .match-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-elevated));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px; padding: 16px; transition: all 0.3s;
    }
    .match-card:hover { border-color: rgba(255,159,67,0.2); transform: translateY(-1px); }
    .match-card.my-match { border-color: rgba(46, 213, 115, 0.3); }

    .match-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .match-creator { display: flex; align-items: center; gap: 10px; }
    .match-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.85em; color: var(--bg-dark);
    }
    .match-name { font-weight: 600; font-size: 0.9em; }
    .match-time { font-size: 0.7em; color: var(--text-secondary); }
    .match-status {
      padding: 4px 10px; border-radius: 20px;
      font-size: 0.65em; font-weight: 700; text-transform: uppercase;
    }
    .status-aguardando { background: rgba(255, 159, 67, 0.2); color: var(--accent-primary); }
    .status-em-andamento { background: rgba(255, 71, 87, 0.2); color: var(--live-red); animation: pulse-live 2s ease-in-out infinite; }
    @keyframes pulse-live { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
    .status-finalizado { background: rgba(255,255,255,0.1); color: var(--text-secondary); }

    .match-middle {
      display: flex; align-items: center; justify-content: center; gap: 20px;
      padding: 12px 0; margin-bottom: 10px;
    }
    .match-bet { text-align: center; }
    .match-bet-value { font-size: 1.4em; font-weight: 800; color: var(--accent-secondary); }
    .match-bet-label { font-size: 0.7em; color: var(--text-secondary); }
    .match-vs { font-size: 1.2em; font-weight: 800; color: var(--text-secondary); }

    .btn-accept {
      width: 100%; padding: 12px;
      background: linear-gradient(135deg, var(--accent-primary), #ff8c42);
      border: none; border-radius: 12px;
      color: var(--bg-dark); font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 0.85em; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 4px 15px var(--accent-glow);
    }
    .btn-accept:hover { transform: translateY(-2px); }
    .btn-accept:active { transform: scale(0.97); }
    .btn-accept:disabled { background: rgba(255,255,255,0.1); color: var(--text-secondary); box-shadow: none; cursor: default; }

    .btn-enter {
      width: 100%; padding: 12px;
      background: linear-gradient(135deg, var(--live-red), #ff6b81);
      border: none; border-radius: 12px;
      color: white; font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 0.85em; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,71,87,0.3);
    }

    .btn-cancel-match {
      width: 100%; padding: 12px; margin-top: 6px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; color: var(--text-secondary);
      font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 0.8em;
      cursor: pointer; transition: all 0.3s;
    }
    .btn-cancel-match:hover { background: rgba(255,71,87,0.1); border-color: rgba(255,71,87,0.3); color: var(--live-red); }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .empty-icon { font-size: 3em; margin-bottom: 12px; }

    /* MODAL */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 2000;
      justify-content: center; align-items: center; backdrop-filter: blur(8px);
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      background: linear-gradient(135deg, #1e2936, #18222e);
      border-radius: 24px; padding: 30px; max-width: 420px; width: 92%;
      border: 1px solid rgba(255,181,71,0.3);
      animation: modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    @keyframes modalPop { from { opacity:0; transform: scale(0.9) translateY(20px); } to { opacity:1; transform: scale(1) translateY(0); } }

    .modal-title { font-size: 1.3em; font-weight: 800; text-align: center; margin-bottom: 20px; }
    .modal-field { margin-bottom: 16px; }
    .modal-label { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 6px; }
    .modal-input {
      width: 100%; padding: 14px 16px;
      background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; color: var(--text-primary);
      font-family: 'Poppins', sans-serif; font-size: 1.2em;
      font-weight: 700; text-align: center;
      outline: none; transition: border-color 0.3s;
    }
    .modal-input:focus { border-color: var(--accent-primary); }
    .modal-hint { font-size: 0.75em; color: var(--text-secondary); text-align: center; margin-top: 4px; }

    .modal-presets {
      display: flex; gap: 8px; margin-bottom: 16px; justify-content: center;
    }
    .preset-btn {
      padding: 8px 16px; background: rgba(255,159,67,0.1);
      border: 1px solid rgba(255,159,67,0.2); border-radius: 10px;
      color: var(--accent-secondary); font-family: 'Poppins', sans-serif;
      font-weight: 600; font-size: 0.85em; cursor: pointer; transition: all 0.3s;
    }
    .preset-btn:hover { background: rgba(255,159,67,0.2); border-color: rgba(255,159,67,0.4); }

    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-actions button {
      flex: 1; padding: 14px; border-radius: 12px; border: none;
      font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 0.9em;
      cursor: pointer; transition: all 0.3s;
    }
    .btn-modal-confirm {
      background: linear-gradient(135deg, var(--win-green), #7bed9f);
      color: var(--bg-dark); box-shadow: 0 4px 15px rgba(46,213,115,0.3);
    }
    .btn-modal-cancel { background: rgba(255,255,255,0.08); color: var(--text-secondary); }

    /* HISTORY CARD */
    .history-card {
      background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px; padding: 14px; display: flex; align-items: center;
      justify-content: space-between; gap: 12px;
    }
    .history-card.win { border-left: 3px solid var(--win-green); }
    .history-card.loss { border-left: 3px solid var(--live-red); }
    .history-info { flex: 1; }
    .history-opponent { font-weight: 600; font-size: 0.85em; }
    .history-score { font-size: 0.75em; color: var(--text-secondary); }
    .history-result { font-weight: 700; font-size: 0.85em; padding: 4px 12px; border-radius: 8px; }
    .history-result.win { background: rgba(46,213,115,0.15); color: var(--win-green); }
    .history-result.loss { background: rgba(255,71,87,0.15); color: var(--live-red); }

    /* TOAST */
    .toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.9); color: white; padding: 15px 30px;
      border-radius: 50px; font-weight: 600; z-index: 3000; opacity: 0; transition: all 0.3s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* BOTTOM NAV */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(14,20,27,0.98); backdrop-filter: blur(20px);
      padding: 10px 20px; border-top: 1px solid rgba(255,255,255,0.1); z-index: 99;
    }
    .nav-content { max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      color: #a9b5c6; text-decoration: none; font-size: 0.75em; transition: all 0.3s; padding: 5px 10px;
    }
    .nav-item:hover, .nav-item.active { color: #ffb547; }
    .nav-icon { font-size: 1.5em; }

    /* RULES */
    .rules-card {
      background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15);
      border-radius: 16px; padding: 18px; margin-bottom: 24px;
    }
    .rules-title { font-weight: 700; font-size: 0.95em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .rule-item { display: flex; align-items: flex-start; gap: 8px; padding: 6px 0; font-size: 0.8em; color: var(--text-secondary); line-height: 1.4; }
    .rule-icon { flex-shrink: 0; }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-content">
      <div class="logo">
        <img src="/icons/logo-branca-amarela.png" alt="Yellup" onerror="this.outerHTML='<span style=\'font-size:1.4em;font-weight:800;color:#ffb547\'>YELLUP</span>'">
      </div>
      <a href="painel.html" class="btn-back">‚Üê Voltar</a>
    </div>
  </div>

  <div class="container">

    <!-- HERO -->
    <div class="hero">
      <div class="hero-icon">‚öΩ</div>
      <h1>Disputa de P√™naltis</h1>
      <p>Desafie outros jogadores em cobran√ßas!</p>
    </div>

    <!-- CR√âDITOS -->
    <div class="credits-bar">
      <span class="credits-label">üí∞ Seus cr√©ditos</span>
      <span class="credits-value" id="myCredits">0</span>
    </div>

    <!-- CRIAR DISPUTA -->
    <button class="btn-create" onclick="abrirModalCriar()">‚öΩ Criar Disputa de P√™naltis</button>

    <!-- DISPUTAS ABERTAS -->
    <div class="section-title">üî¥ Disputas Abertas <span class="section-count" id="countAbertas"></span></div>
    <div class="matches-list" id="listaAbertas">
      <div class="empty-state"><div class="empty-icon">‚öΩ</div><p>Carregando...</p></div>
    </div>

    <!-- MINHAS DISPUTAS EM ANDAMENTO -->
    <div class="section-title">‚ö° Em Andamento <span class="section-count" id="countAtivas"></span></div>
    <div class="matches-list" id="listaAtivas">
      <div class="empty-state"><div class="empty-icon">üí§</div><p>Nenhuma disputa ativa</p></div>
    </div>

    <!-- HIST√ìRICO -->
    <div class="section-title">üìã Hist√≥rico Recente</div>
    <div class="matches-list" id="listaHistorico">
      <div class="empty-state"><div class="empty-icon">üìã</div><p>Nenhum hist√≥rico</p></div>
    </div>

    <!-- REGRAS -->
    <div class="rules-card">
      <div class="rules-title">üìñ Como Funciona</div>
      <div class="rule-item"><span class="rule-icon">ü•Ö</span><span>O gol tem 9 quadrantes (3√ó3)</span></div>
      <div class="rule-item"><span class="rule-icon">üîÑ</span><span>5 cobran√ßas para cada jogador (10 rodadas)</span></div>
      <div class="rule-item"><span class="rule-icon">üéØ</span><span>Cobrador escolhe onde chutar, goleiro onde defender</span></div>
      <div class="rule-item"><span class="rule-icon">üß§</span><span>Se o goleiro acertar o quadrante, defende!</span></div>
      <div class="rule-item"><span class="rule-icon">üí∞</span><span>Vencedor leva os cr√©ditos apostados</span></div>
      <div class="rule-item"><span class="rule-icon">‚ö°</span><span>Morte s√∫bita se empatar ap√≥s 5√ó5</span></div>
    </div>
  </div>

  <!-- MODAL CRIAR -->
  <div class="modal-overlay" id="modalCriar">
    <div class="modal-card">
      <div class="modal-title">‚öΩ Criar Disputa</div>
      <div class="modal-field">
        <div class="modal-label">Quanto quer apostar?</div>
        <div class="modal-presets">
          <button class="preset-btn" onclick="setValor(5)">5</button>
          <button class="preset-btn" onclick="setValor(10)">10</button>
          <button class="preset-btn" onclick="setValor(25)">25</button>
          <button class="preset-btn" onclick="setValor(50)">50</button>
          <button class="preset-btn" onclick="setValor(100)">100</button>
        </div>
        <input type="number" class="modal-input" id="inputValor" value="10" min="1">
        <div class="modal-hint">Cr√©ditos que cada jogador aposta</div>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" onclick="fecharModal()">Cancelar</button>
        <button class="btn-modal-confirm" onclick="criarDisputa()">‚öΩ Criar!</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <div class="nav-content">
      <a href="painel.html" class="nav-item"><span class="nav-icon">üè†</span>In√≠cio</a>
      <a href="ranking-geral.html" class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</a>
      <a href="indicacoes.html" class="nav-item"><span class="nav-icon">üîó</span>Indicar</a>
      <a href="editar-perfil.html" class="nav-item"><span class="nav-icon">üë§</span>Perfil</a>
    </div>
  </nav>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e => console.error(e));

    let currentUser = null;
    let currentUserData = null;
    let unsubAbertas = null;
    let unsubAtivas = null;

    // ==========================================
    // AUTH
    // ==========================================
    auth.onAuthStateChanged(async user => {
      if (!user) { window.location.href = 'index.html'; return; }
      currentUser = user;

      const doc = await db.collection('usuarios').doc(user.uid).get();
      if (doc.exists) {
        currentUserData = doc.data();
        document.getElementById('myCredits').textContent = (currentUserData.creditos || 0).toLocaleString();
      }

      escutarDisputas();
      carregarHistorico();
    });

    // ==========================================
    // ESCUTAR DISPUTAS EM TEMPO REAL
    // ==========================================
    function escutarDisputas() {
      // Abertas (aguardando advers√°rio, n√£o s√£o minhas)
      unsubAbertas = db.collection('penaltis')
        .where('status', '==', 'aguardando')
        .orderBy('criadoEm', 'desc')
        .limit(20)
        .onSnapshot(snap => {
          const lista = [];
          snap.forEach(doc => {
            const d = { id: doc.id, ...doc.data() };
            lista.push(d);
          });
          renderAbertas(lista);
        });

      // Minhas ativas
      unsubAtivas = db.collection('penaltis')
        .where('status', '==', 'em_andamento')
        .orderBy('criadoEm', 'desc')
        .limit(20)
        .onSnapshot(snap => {
          const lista = [];
          snap.forEach(doc => {
            const d = { id: doc.id, ...doc.data() };
            if (d.jogador1?.uid === currentUser.uid || d.jogador2?.uid === currentUser.uid) {
              lista.push(d);
            }
          });

          // Also check for my "aguardando" matches
          db.collection('penaltis')
            .where('status', '==', 'aguardando')
            .where('jogador1.uid', '==', currentUser.uid)
            .get().then(snap2 => {
              snap2.forEach(doc => {
                const d = { id: doc.id, ...doc.data() };
                lista.push(d);
              });
              renderAtivas(lista);
            });
        });
    }

    // ==========================================
    // RENDER ABERTAS
    // ==========================================
    function renderAbertas(lista) {
      const container = document.getElementById('listaAbertas');
      const abertas = lista.filter(d => d.jogador1?.uid !== currentUser.uid);

      document.getElementById('countAbertas').textContent = abertas.length > 0 ? `(${abertas.length})` : '';

      if (abertas.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üò¥</div><p>Nenhuma disputa aberta. Crie uma!</p></div>';
        return;
      }

      container.innerHTML = abertas.map(d => {
        const nome = d.jogador1?.nome || 'Jogador';
        const inicial = nome.charAt(0).toUpperCase();
        const tempo = d.criadoEm?.toDate ? tempoRelativo(d.criadoEm.toDate()) : '';

        return `<div class="match-card">
          <div class="match-top">
            <div class="match-creator">
              <div class="match-avatar">${inicial}</div>
              <div>
                <div class="match-name">${nome}</div>
                <div class="match-time">${tempo}</div>
              </div>
            </div>
            <span class="match-status status-aguardando">Aguardando</span>
          </div>
          <div class="match-middle">
            <div class="match-bet">
              <div class="match-bet-value">üí∞ ${d.valorAposta}</div>
              <div class="match-bet-label">cr√©ditos cada</div>
            </div>
          </div>
          <button class="btn-accept" onclick="aceitarDisputa('${d.id}', ${d.valorAposta})">‚öΩ Aceitar Desafio!</button>
        </div>`;
      }).join('');
    }

    // ==========================================
    // RENDER ATIVAS (minhas)
    // ==========================================
    function renderAtivas(lista) {
      const container = document.getElementById('listaAtivas');
      document.getElementById('countAtivas').textContent = lista.length > 0 ? `(${lista.length})` : '';

      if (lista.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí§</div><p>Nenhuma disputa ativa</p></div>';
        return;
      }

      container.innerHTML = lista.map(d => {
        const isAguardando = d.status === 'aguardando';
        const oponente = d.jogador1?.uid === currentUser.uid
          ? (d.jogador2?.nome || 'Aguardando...')
          : (d.jogador1?.nome || '???');

        const statusClass = isAguardando ? 'status-aguardando' : 'status-em-andamento';
        const statusText = isAguardando ? 'Aguardando' : 'Ao Vivo';
        const placar = d.placar ? `${d.placar.jogador1 || 0} √ó ${d.placar.jogador2 || 0}` : '0 √ó 0';

        let buttons = '';
        if (isAguardando) {
          buttons = `<button class="btn-cancel-match" onclick="cancelarDisputa('${d.id}')">‚ùå Cancelar</button>`;
        } else {
          buttons = `<button class="btn-enter" onclick="window.location.href='arena-penalti.html?id=${d.id}'">üéØ Entrar na Arena</button>`;
        }

        return `<div class="match-card my-match">
          <div class="match-top">
            <div class="match-creator">
              <div class="match-avatar">‚öΩ</div>
              <div>
                <div class="match-name">vs ${oponente}</div>
                <div class="match-time">${!isAguardando ? 'Rodada ' + (d.rodadaAtual || 1) + '/10 ‚Ä¢ ' + placar : ''} üí∞ ${d.valorAposta} cr√©ditos</div>
              </div>
            </div>
            <span class="match-status ${statusClass}">${statusText}</span>
          </div>
          ${buttons}
        </div>`;
      }).join('');
    }

    // ==========================================
    // HIST√ìRICO
    // ==========================================
    async function carregarHistorico() {
      const container = document.getElementById('listaHistorico');
      try {
        // Buscar finalizados onde sou jogador1 ou jogador2
        const snap1 = await db.collection('penaltis')
          .where('status', '==', 'finalizado')
          .where('jogador1.uid', '==', currentUser.uid)
          .orderBy('criadoEm', 'desc').limit(5).get();

        const snap2 = await db.collection('penaltis')
          .where('status', '==', 'finalizado')
          .where('jogador2.uid', '==', currentUser.uid)
          .orderBy('criadoEm', 'desc').limit(5).get();

        const historico = [];
        snap1.forEach(doc => historico.push({ id: doc.id, ...doc.data() }));
        snap2.forEach(doc => historico.push({ id: doc.id, ...doc.data() }));
        historico.sort((a, b) => (b.criadoEm?.seconds || 0) - (a.criadoEm?.seconds || 0));

        if (historico.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p>Jogue sua primeira disputa!</p></div>';
          return;
        }

        container.innerHTML = historico.slice(0, 8).map(d => {
          const ganhei = d.vencedor === currentUser.uid;
          const oponente = d.jogador1?.uid === currentUser.uid ? d.jogador2?.nome : d.jogador1?.nome;
          const placar = `${d.placar?.jogador1 || 0} √ó ${d.placar?.jogador2 || 0}`;

          return `<div class="history-card ${ganhei ? 'win' : 'loss'}">
            <div class="history-info">
              <div class="history-opponent">vs ${oponente || '???'}</div>
              <div class="history-score">${placar} ‚Ä¢ üí∞ ${d.valorAposta}</div>
            </div>
            <span class="history-result ${ganhei ? 'win' : 'loss'}">${ganhei ? '+' + d.valorAposta : '-' + d.valorAposta}</span>
          </div>`;
        }).join('');
      } catch (e) {
        console.error('Hist√≥rico:', e);
        container.innerHTML = '<div class="empty-state"><p>Erro ao carregar</p></div>';
      }
    }

    // ==========================================
    // CRIAR DISPUTA
    // ==========================================
    function abrirModalCriar() { document.getElementById('modalCriar').classList.add('active'); }
    function fecharModal() { document.getElementById('modalCriar').classList.remove('active'); }
    function setValor(v) { document.getElementById('inputValor').value = v; }

    async function criarDisputa() {
      const valor = parseInt(document.getElementById('inputValor').value);
      if (!valor || valor < 1) { showToast('‚ùå Valor inv√°lido'); return; }
      if ((currentUserData?.creditos || 0) < valor) { showToast('‚ùå Cr√©ditos insuficientes'); return; }

      fecharModal();

      try {
        const nome = currentUserData.usuarioUnico || currentUserData.usuario || currentUserData.nome || 'Jogador';

        // Debitar cr√©ditos do criador
        await db.collection('usuarios').doc(currentUser.uid).update({
          creditos: firebase.firestore.FieldValue.increment(-valor)
        });

        // Criar documento da disputa
        await db.collection('penaltis').add({
          jogador1: { uid: currentUser.uid, nome },
          jogador2: null,
          status: 'aguardando',
          valorAposta: valor,
          rodadaAtual: 1,
          rodadas: [],
          placar: { jogador1: 0, jogador2: 0 },
          escolhaJogador1: null,
          escolhaJogador2: null,
          vencedor: null,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Registrar extrato
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({
          tipo: 'saida',
          valor,
          descricao: `P√™naltis: aposta de ${valor} cr√©ditos`,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Atualizar cr√©ditos na tela
        currentUserData.creditos -= valor;
        document.getElementById('myCredits').textContent = currentUserData.creditos.toLocaleString();

        showToast('‚úÖ Disputa criada! Aguardando advers√°rio...');
      } catch (e) {
        console.error('Criar disputa:', e);
        showToast('‚ùå Erro ao criar disputa');
      }
    }

    // ==========================================
    // ACEITAR DISPUTA
    // ==========================================
    async function aceitarDisputa(id, valor) {
      if ((currentUserData?.creditos || 0) < valor) {
        showToast('‚ùå Cr√©ditos insuficientes'); return;
      }

      try {
        const nome = currentUserData.usuarioUnico || currentUserData.usuario || currentUserData.nome || 'Jogador';

        // Debitar cr√©ditos
        await db.collection('usuarios').doc(currentUser.uid).update({
          creditos: firebase.firestore.FieldValue.increment(-valor)
        });

        // Atualizar disputa
        await db.collection('penaltis').doc(id).update({
          jogador2: { uid: currentUser.uid, nome },
          status: 'em_andamento'
        });

        // Extrato
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({
          tipo: 'saida',
          valor,
          descricao: `P√™naltis: aposta de ${valor} cr√©ditos`,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        currentUserData.creditos -= valor;
        document.getElementById('myCredits').textContent = currentUserData.creditos.toLocaleString();

        showToast('‚úÖ Aceito! Entrando na arena...');
        setTimeout(() => window.location.href = `arena-penalti.html?id=${id}`, 800);
      } catch (e) {
        console.error('Aceitar:', e);
        showToast('‚ùå Erro ao aceitar');
      }
    }

    // ==========================================
    // CANCELAR DISPUTA (minha, aguardando)
    // ==========================================
    async function cancelarDisputa(id) {
      try {
        const doc = await db.collection('penaltis').doc(id).get();
        const data = doc.data();

        if (data.jogador1.uid !== currentUser.uid || data.status !== 'aguardando') {
          showToast('‚ùå N√£o pode cancelar'); return;
        }

        // Devolver cr√©ditos
        await db.collection('usuarios').doc(currentUser.uid).update({
          creditos: firebase.firestore.FieldValue.increment(data.valorAposta)
        });

        // Deletar disputa
        await db.collection('penaltis').doc(id).delete();

        // Extrato
        await db.collection('usuarios').doc(currentUser.uid).collection('extrato').doc().set({
          tipo: 'entrada',
          valor: data.valorAposta,
          descricao: 'P√™naltis: disputa cancelada (reembolso)',
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        currentUserData.creditos += data.valorAposta;
        document.getElementById('myCredits').textContent = currentUserData.creditos.toLocaleString();

        showToast('‚úÖ Disputa cancelada, cr√©ditos devolvidos');
      } catch (e) {
        console.error('Cancelar:', e);
        showToast('‚ùå Erro ao cancelar');
      }
    }

    // ==========================================
    // HELPERS
    // ==========================================
    function tempoRelativo(date) {
      const diff = Date.now() - date.getTime();
      const min = Math.floor(diff / 60000);
      if (min < 1) return 'Agora';
      if (min < 60) return `${min}min atr√°s`;
      const h = Math.floor(min / 60);
      if (h < 24) return `${h}h atr√°s`;
      return `${Math.floor(h / 24)}d atr√°s`;
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
