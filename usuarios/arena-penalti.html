<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arena de P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e13">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#070b10;--bg-card:#0f1419;--accent:#ff9f43;--accent2:#ffc048;--glow:rgba(255,159,67,0.25);--red:#ff4757;--green:#2ed573;--txt:#f1f2f6;--txt2:#8899aa;--grass1:#1a6b1a;--grass2:#1e7a1e;--sky1:#0c1929;--sky2:#162740}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);color:var(--txt);min-height:100vh;overflow-x:hidden;overflow-y:auto}

    /* === SCOREBOARD === */
    .scoreboard{background:rgba(7,11,16,0.96);backdrop-filter:blur(24px);padding:10px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,0.06)}
    .sb-inner{max-width:500px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .sb-player{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1}
    .sb-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85em;color:white}
    .sb-p1 .sb-avatar{background:linear-gradient(135deg,#2563eb,#3b82f6);box-shadow:0 2px 12px rgba(37,99,235,0.4)}
    .sb-p2 .sb-avatar{background:linear-gradient(135deg,#dc2626,#ef4444);box-shadow:0 2px 12px rgba(220,38,38,0.4)}
    .sb-name{font-size:0.68em;font-weight:600;max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sb-role{font-size:0.58em;padding:2px 8px;border-radius:10px;font-weight:700;letter-spacing:0.3px}
    .sb-role.cobrador{background:rgba(255,159,67,0.15);color:var(--accent)}
    .sb-role.goleiro{background:rgba(59,130,246,0.15);color:#60a5fa}
    .sb-role.hidden{visibility:hidden}
    .sb-center{display:flex;flex-direction:column;align-items:center;padding:0 12px}
    .sb-score{font-size:2.2em;font-weight:900;letter-spacing:6px;display:flex;align-items:center;gap:6px;line-height:1}
    .sb-score .s1{color:#60a5fa}.sb-score .s2{color:#f87171}.sb-score .div{color:rgba(255,255,255,0.2);font-size:0.6em}
    .sb-round{font-size:0.6em;color:var(--txt2);font-weight:600;margin-top:2px}

    /* === TRACKER === */
    .tracker{display:flex;justify-content:center;gap:14px;padding:8px 16px;background:rgba(15,20,25,0.9);border-bottom:1px solid rgba(255,255,255,0.04)}
    .tracker-side{display:flex;gap:4px}.tracker-lbl{font-size:0.55em;font-weight:700;color:var(--txt2);margin:0 2px;align-self:center}
    .tdot{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.5em;border:2px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.4)}
    .tdot.gol{border-color:var(--green);background:rgba(46,213,115,0.15);color:var(--green)}
    .tdot.def{border-color:var(--red);background:rgba(255,71,87,0.15);color:var(--red)}
    .tdot.cur{border-color:var(--accent);animation:dp 1.5s ease-in-out infinite}
    @keyframes dp{0%,100%{box-shadow:0 0 0 rgba(255,159,67,0)}50%{box-shadow:0 0 8px rgba(255,159,67,0.5)}}

    /* === STADIUM === */
    .stadium{position:relative;width:100%;max-width:540px;margin:0 auto;overflow:hidden}

    /* Sky */
    .sky{position:relative;width:100%;height:80px;background:linear-gradient(180deg,#060d17 0%,#0c1929 40%,#162740 100%);overflow:hidden}

    /* Stars */
    .stars{position:absolute;top:0;left:0;right:0;bottom:0}
    .star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;animation:twinkle 3s ease-in-out infinite}
    @keyframes twinkle{0%,100%{opacity:0.3}50%{opacity:1}}

    /* Floodlights */
    .floodlight{position:absolute;top:0;width:60px;height:70px}
    .floodlight.left{left:8%}.floodlight.right{right:8%}
    .fl-pole{position:absolute;bottom:0;left:50%;width:3px;height:100%;background:linear-gradient(180deg,#666,#444);transform:translateX(-50%)}
    .fl-head{position:absolute;top:0;left:50%;transform:translateX(-50%);width:20px;height:8px;background:#aaa;border-radius:2px;box-shadow:0 0 20px rgba(255,200,100,0.4)}
    .fl-beam{position:absolute;top:8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:40px solid transparent;border-right:40px solid transparent;border-top:60px solid rgba(255,230,170,0.03)}

    /* Crowd */
    .crowd{position:relative;width:100%;height:55px;background:linear-gradient(180deg,#162740 0%,#1a2d45 50%,#1e3350 100%);overflow:hidden}
    .crowd-row{display:flex;justify-content:center;gap:0;position:absolute;bottom:0;left:-5%;right:-5%}
    .crowd-row.back{bottom:20px;transform:scale(0.85);opacity:0.5}
    .crowd-row.mid{bottom:10px;transform:scale(0.92);opacity:0.7}
    .crowd-row.front{bottom:0;opacity:0.9}
    .person{width:8px;height:14px;display:flex;flex-direction:column;align-items:center;margin:0 1px}
    .person .head{width:5px;height:5px;border-radius:50%;margin-bottom:1px}
    .person .body{width:7px;height:8px;border-radius:2px 2px 0 0}

    /* Camera flashes */
    .flash{position:absolute;width:3px;height:3px;background:white;border-radius:50%;opacity:0;animation:camFlash 4s ease-in-out infinite}
    @keyframes camFlash{0%,95%,100%{opacity:0}96%{opacity:1}97%{opacity:0}98%{opacity:0.8}99%{opacity:0}}

    /* Banner */
    .banner{position:absolute;bottom:0;left:10%;right:10%;height:14px;background:linear-gradient(90deg,#1a3a5c,#234a6e,#1a3a5c);border-radius:2px 2px 0 0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .banner-text{font-size:0.4em;font-weight:700;color:rgba(255,255,255,0.5);letter-spacing:4px;white-space:nowrap;animation:scrollBanner 15s linear infinite}
    @keyframes scrollBanner{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

    /* === FIELD / GOAL AREA === */
    .field{position:relative;width:100%;padding-bottom:68%;background:linear-gradient(180deg,var(--grass1) 0%,var(--grass2) 40%,#1b6e1b 100%);overflow:hidden}

    /* Grass stripes */
    .field::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(90deg,rgba(255,255,255,0.015) 0px,rgba(255,255,255,0.015) 30px,transparent 30px,transparent 60px)}

    /* Penalty area lines */
    .field-lines{position:absolute;top:0;left:15%;right:15%;bottom:30%;border:2px solid rgba(255,255,255,0.12);border-top:none}
    .field-lines::after{content:'';position:absolute;top:0;left:15%;right:15%;bottom:40%;border:2px solid rgba(255,255,255,0.08);border-top:none}

    /* Penalty spot */
    .penalty-spot{position:absolute;bottom:18%;left:50%;width:6px;height:6px;background:rgba(255,255,255,0.3);border-radius:50%;transform:translateX(-50%)}

    /* === GOAL STRUCTURE === */
    .goal-wrapper{position:absolute;top:2%;left:12%;right:12%;bottom:30%;perspective:600px}

    /* 3D Goal Frame */
    .goal-frame{position:absolute;top:0;left:0;right:0;bottom:0;transform:rotateX(2deg);transform-origin:bottom center}

    /* Posts */
    .post{position:absolute;bottom:0;width:8px;background:linear-gradient(90deg,#e8e8e8,#ffffff,#d0d0d0);border-radius:4px 4px 0 0;box-shadow:2px 0 10px rgba(0,0,0,0.3),-1px 0 4px rgba(255,255,255,0.2)}
    .post.left{left:0;top:0;height:100%}.post.right{right:0;top:0;height:100%}
    .crossbar{position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(180deg,#ffffff,#e0e0e0,#c8c8c8);border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.3),0 -1px 4px rgba(255,255,255,0.3)}

    /* Net */
    .net{position:absolute;top:8px;left:8px;right:8px;bottom:0;overflow:hidden;background:rgba(0,0,0,0.35)}
    .net::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(90deg,transparent,transparent 10px,rgba(255,255,255,0.06) 10px,rgba(255,255,255,0.06) 11px),repeating-linear-gradient(0deg,transparent,transparent 10px,rgba(255,255,255,0.06) 10px,rgba(255,255,255,0.06) 11px)}
    /* Net depth illusion */
    .net::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0.1) 0%,rgba(0,0,0,0.4) 100%);pointer-events:none}

    /* Net side panels (depth) */
    .net-side{position:absolute;top:8px;bottom:0;width:20px;background:repeating-linear-gradient(0deg,transparent,transparent 10px,rgba(255,255,255,0.04) 10px,rgba(255,255,255,0.04) 11px),repeating-linear-gradient(60deg,transparent,transparent 10px,rgba(255,255,255,0.03) 10px,rgba(255,255,255,0.03) 11px);opacity:0.6}
    .net-side.left{right:100%;transform:skewY(-15deg);transform-origin:top right}
    .net-side.right{left:100%;transform:skewY(15deg);transform-origin:top left}

    /* Net top */
    .net-top{position:absolute;bottom:100%;left:8px;right:8px;height:15px;background:repeating-linear-gradient(90deg,transparent,transparent 10px,rgba(255,255,255,0.04) 10px,rgba(255,255,255,0.04) 11px),repeating-linear-gradient(120deg,transparent,transparent 10px,rgba(255,255,255,0.03) 10px,rgba(255,255,255,0.03) 11px);transform:skewX(0deg) perspective(200px) rotateX(40deg);transform-origin:bottom center;opacity:0.5}

    /* === CLICKABLE GRID === */
    .goal-grid{position:absolute;top:8px;left:8px;right:8px;bottom:0;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:2px;z-index:10}
    .gz{border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0;color:transparent;transition:all 0.2s;background:transparent;border:2px solid transparent;position:relative}
    .gz::after{content:attr(data-label);position:absolute;font-size:0.7em;font-weight:700;opacity:0;transition:opacity 0.2s;color:rgba(255,255,255,0.7);text-shadow:0 1px 4px rgba(0,0,0,0.8)}
    .gz:hover{background:rgba(255,159,67,0.12);border-color:rgba(255,159,67,0.35)}.gz:hover::after{opacity:1}
    .gz:active{transform:scale(0.96)}
    .gz.sel{background:rgba(255,159,67,0.2);border-color:var(--accent);box-shadow:0 0 20px var(--glow),inset 0 0 15px rgba(255,159,67,0.1)}.gz.sel::after{opacity:1;color:var(--accent)}
    .gz.off{pointer-events:none;opacity:0.4}
    .gz.r-gol{background:rgba(46,213,115,0.25);border-color:var(--green);box-shadow:inset 0 0 20px rgba(46,213,115,0.15)}
    .gz.r-def{background:rgba(255,71,87,0.25);border-color:var(--red);box-shadow:inset 0 0 20px rgba(255,71,87,0.15)}
    .gz .zone-icon{font-size:1.6em;display:none}.gz.r-gol .zone-icon,.gz.r-def .zone-icon{display:block}

    /* === BALL & GOALKEEPER === */
    .ball{position:absolute;font-size:26px;z-index:20;bottom:32%;left:50%;transform:translateX(-50%);display:none;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.6))}
    .ball.kick{display:block;animation:bk 0.5s cubic-bezier(0.22,0.61,0.36,1) forwards}
    .keeper{position:absolute;font-size:2.8em;z-index:15;top:25%;left:50%;transform:translate(-50%,-50%);display:none;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.5))}
    .keeper.dive{display:block;animation:kd 0.45s cubic-bezier(0.22,0.61,0.36,1) forwards}

    /* === CONTROLS === */
    .controls{max-width:500px;margin:0 auto;padding:20px;text-align:center}
    .instr{font-size:1.05em;font-weight:700;margin-bottom:14px;padding:14px 20px;border-radius:14px;transition:all 0.3s}
    .instr.kick{background:linear-gradient(135deg,rgba(255,159,67,0.12),rgba(255,159,67,0.04));border:1px solid rgba(255,159,67,0.25);color:var(--accent)}
    .instr.defend{background:linear-gradient(135deg,rgba(59,130,246,0.12),rgba(59,130,246,0.04));border:1px solid rgba(59,130,246,0.25);color:#60a5fa}
    .instr.wait{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);color:var(--txt2)}
    .instr.gol{background:rgba(46,213,115,0.12);border:1px solid rgba(46,213,115,0.25);color:var(--green);font-size:1.3em}
    .instr.saved{background:rgba(255,71,87,0.12);border:1px solid rgba(255,71,87,0.25);color:var(--red);font-size:1.3em}
    .instr.sd{background:rgba(168,85,247,0.12);border:1px solid rgba(168,85,247,0.25);color:#c084fc;animation:sdp 1.5s ease-in-out infinite}
    @keyframes sdp{0%,100%{box-shadow:none}50%{box-shadow:0 0 20px rgba(168,85,247,0.15)}}

    .btn-go{padding:16px 40px;background:linear-gradient(135deg,var(--accent),#ff8c42);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:1em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px var(--glow)}
    .btn-go:hover{transform:translateY(-2px)}.btn-go:active{transform:scale(0.97)}
    .btn-go:disabled{background:rgba(255,255,255,0.08);color:var(--txt2);box-shadow:none;cursor:default}

    .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.15);border-top-color:var(--accent);border-radius:50%;animation:sp 0.7s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes sp{to{transform:rotate(360deg)}}

    /* === RESULT OVERLAY === */
    .result-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(10px)}
    .result-overlay.active{display:flex}
    .result-card{text-align:center;padding:28px 22px;background:linear-gradient(145deg,#151d28,#111820);border-radius:24px;max-width:400px;width:92%;animation:rpop 0.5s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,0,0,0.6);max-height:90vh;overflow-y:auto}
    .result-card.win{border:2px solid var(--green)}.result-card.loss{border:2px solid var(--red)}
    @keyframes rpop{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}
    .r-icon{font-size:3.5em;margin-bottom:6px}.r-title{font-size:1.5em;font-weight:900;margin-bottom:4px}
    .r-score{font-size:1.1em;color:var(--txt2);margin-bottom:10px}
    .r-credits{font-size:1.6em;font-weight:800;margin-bottom:14px}
    .r-credits.win{color:var(--green)}.r-credits.loss{color:var(--red)}

    .stats-section{margin:14px 0;text-align:left}
    .stats-title{font-size:0.8em;font-weight:700;color:var(--txt2);margin-bottom:8px;text-align:center}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px}
    .stat-box{background:rgba(255,255,255,0.04);border-radius:10px;padding:8px;text-align:center}
    .stat-val{font-size:1.2em;font-weight:800}.stat-lbl{font-size:0.6em;color:var(--txt2)}
    .stat-val.grn{color:var(--green)}.stat-val.red{color:var(--red)}.stat-val.blu{color:#60a5fa}.stat-val.org{color:var(--accent)}
    .hm-section{margin:10px 0}.hm-row{display:flex;gap:8px;justify-content:center;margin-bottom:6px}
    .hm-title{font-size:0.65em;color:var(--txt2);text-align:center;margin-bottom:4px}
    .hm-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;max-width:130px;margin:0 auto 4px}
    .hm-cell{aspect-ratio:1;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:0.55em;font-weight:700;color:white;min-height:22px}

    .btn-res{padding:14px 40px;border-radius:14px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:0.95em;cursor:pointer;width:100%;transition:all 0.3s}
    .btn-res.win{background:linear-gradient(135deg,var(--green),#7bed9f);color:var(--bg-dark)}
    .btn-res.loss{background:rgba(255,255,255,0.08);color:var(--txt)}

    .confetti-c{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2001}
    .cft{position:absolute;top:-10px;animation:cfall 3s ease-in forwards}
    @keyframes cfall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

    .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,0.92);color:white;padding:14px 28px;border-radius:50px;font-weight:600;font-size:0.9em;z-index:3000;opacity:0;transition:all 0.3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    @media(max-width:400px){.sb-score{font-size:1.6em;letter-spacing:3px}.sb-name{font-size:0.6em;max-width:60px}.crowd{height:40px}.sky{height:60px}}
  </style>
</head>
<body>

  <!-- SCOREBOARD -->
  <div class="scoreboard"><div class="sb-inner">
    <div class="sb-player sb-p1">
      <div class="sb-avatar" id="p1Avatar">?</div>
      <div class="sb-name" id="p1Name">Jogador 1</div>
      <span class="sb-role hidden" id="p1Role">‚öΩ Cobrador</span>
    </div>
    <div class="sb-center">
      <div class="sb-score"><span class="s1" id="score1">0</span><span class="div">√ó</span><span class="s2" id="score2">0</span></div>
      <div class="sb-round" id="roundInfo">Rodada 1/10</div>
    </div>
    <div class="sb-player sb-p2">
      <div class="sb-avatar" id="p2Avatar">?</div>
      <div class="sb-name" id="p2Name">Jogador 2</div>
      <span class="sb-role hidden" id="p2Role">üß§ Goleiro</span>
    </div>
  </div></div>

  <!-- TRACKER -->
  <div class="tracker">
    <div class="tracker-side" id="tP1"></div>
    <span class="tracker-lbl">P1</span>
    <span style="color:rgba(255,255,255,0.15);font-size:0.6em">‚îÇ</span>
    <span class="tracker-lbl">P2</span>
    <div class="tracker-side" id="tP2"></div>
  </div>

  <!-- STADIUM -->
  <div class="stadium">
    <!-- Sky with stars -->
    <div class="sky">
      <div class="stars" id="starsContainer"></div>
      <div class="floodlight left"><div class="fl-pole"></div><div class="fl-head"></div><div class="fl-beam"></div></div>
      <div class="floodlight right"><div class="fl-pole"></div><div class="fl-head"></div><div class="fl-beam"></div></div>
    </div>

    <!-- Crowd -->
    <div class="crowd" id="crowdArea">
      <div id="flashContainer"></div>
      <div class="banner"><span class="banner-text">‚òÖ YELLUP ARENA ‚òÖ DISPUTA DE P√äNALTIS ‚òÖ YELLUP ARENA ‚òÖ DISPUTA DE P√äNALTIS ‚òÖ</span></div>
    </div>

    <!-- Field -->
    <div class="field">
      <div class="field-lines"></div>
      <div class="penalty-spot"></div>

      <!-- Goal -->
      <div class="goal-wrapper">
        <div class="goal-frame">
          <div class="net">
            <div class="net-side left"></div>
            <div class="net-side right"></div>
            <div class="net-top"></div>
          </div>
          <div class="post left"></div>
          <div class="post right"></div>
          <div class="crossbar"></div>

          <!-- 3x3 grid -->
          <div class="goal-grid" id="goalGrid">
            <div class="gz" data-zone="TL" data-label="‚Üñ" onclick="selZone('TL')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="TC" data-label="‚¨Ü" onclick="selZone('TC')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="TR" data-label="‚Üó" onclick="selZone('TR')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="ML" data-label="‚¨Ö" onclick="selZone('ML')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="MC" data-label="‚óè" onclick="selZone('MC')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="MR" data-label="‚û°" onclick="selZone('MR')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="BL" data-label="‚Üô" onclick="selZone('BL')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="BC" data-label="‚¨á" onclick="selZone('BC')"><span class="zone-icon"></span></div>
            <div class="gz" data-zone="BR" data-label="‚Üò" onclick="selZone('BR')"><span class="zone-icon"></span></div>
          </div>
        </div>
      </div>

      <div class="ball" id="ball">‚öΩ</div>
      <div class="keeper" id="keeper">üß§</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="instr wait" id="instr">Carregando...</div>
    <button class="btn-go" id="btnGo" disabled onclick="confirmar()">Confirmar</button>
  </div>

  <!-- RESULT -->
  <div class="result-overlay" id="resOverlay">
    <div class="result-card" id="resCard">
      <div class="r-icon" id="resIcon">üèÜ</div>
      <div class="r-title" id="resTitle">Vit√≥ria!</div>
      <div class="r-score" id="resScore">3 √ó 1</div>
      <div class="r-credits" id="resCred">+20</div>
      <div id="statsBox"></div>
      <button class="btn-res" id="btnRes" onclick="location.href='penaltis.html'">Voltar ao Lobby</button>
    </div>
  </div>

  <div class="confetti-c" id="confC"></div>
  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // === GENERATE CROWD & STARS ===
    (function(){
      // Stars
      const sc=document.getElementById('starsContainer');
      for(let i=0;i<30;i++){const s=document.createElement('div');s.className='star';s.style.left=Math.random()*100+'%';s.style.top=Math.random()*80+'%';s.style.animationDelay=Math.random()*3+'s';s.style.width=s.style.height=(1+Math.random()*1.5)+'px';sc.appendChild(s)}

      // Crowd
      const ca=document.getElementById('crowdArea');
      const colors=['#c62828','#1565c0','#2e7d32','#f57f17','#4527a0','#d84315','#00838f','#6a1b9a','#ef6c00','#1b5e20'];
      ['back','mid','front'].forEach(layer=>{
        const row=document.createElement('div');row.className='crowd-row '+layer;
        const count=layer==='front'?70:layer==='mid'?60:50;
        for(let i=0;i<count;i++){
          const p=document.createElement('div');p.className='person';
          const c=colors[Math.floor(Math.random()*colors.length)];
          const skin=['#d4a574','#c68642','#8d5524','#e0ac69','#f1c27d'][Math.floor(Math.random()*5)];
          p.innerHTML=`<div class="head" style="background:${skin}"></div><div class="body" style="background:${c}"></div>`;
          row.appendChild(p);
        }
        ca.insertBefore(row,ca.firstChild);
      });

      // Camera flashes
      const fc=document.getElementById('flashContainer');
      for(let i=0;i<12;i++){const f=document.createElement('div');f.className='flash';f.style.left=Math.random()*100+'%';f.style.top=(10+Math.random()*60)+'%';f.style.animationDelay=Math.random()*6+'s';f.style.animationDuration=(3+Math.random()*4)+'s';fc.appendChild(f)}
    })();

    // === FIREBASE ===
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));

    const matchId=new URLSearchParams(location.search).get('id');
    let currentUser=null,md=null,myRole=null,selZ=null,busy=false,unsub=null,lastR=0;
    const ZP={TL:{x:'18%',y:'18%'},TC:{x:'50%',y:'12%'},TR:{x:'82%',y:'18%'},ML:{x:'18%',y:'50%'},MC:{x:'50%',y:'50%'},MR:{x:'82%',y:'50%'},BL:{x:'18%',y:'78%'},BC:{x:'50%',y:'82%'},BR:{x:'82%',y:'78%'}};
    const ZN={TL:'‚Üñ Esq Alto',TC:'‚¨Ü Centro Alto',TR:'‚Üó Dir Alto',ML:'‚¨Ö Esq Meio',MC:'‚óè Centro',MR:'‚û° Dir Meio',BL:'‚Üô Esq Baixo',BC:'‚¨á Centro Baixo',BR:'‚Üò Dir Baixo'};

    auth.onAuthStateChanged(u=>{if(!u){location.href='index.html';return}if(!matchId){location.href='penaltis.html';return}currentUser=u;listen()});

    function listen(){
      unsub=db.collection('penaltis').doc(matchId).onSnapshot(s=>{
        if(!s.exists){toast('‚ùå Partida n√£o encontrada');setTimeout(()=>location.href='penaltis.html',1500);return}
        md=s.data();myRole=md.jogador1?.uid===currentUser.uid?'jogador1':'jogador2';
        if(md.status==='finalizado'){renderEnd();return}
        renderSB();renderTK();renderRound();
      });
    }

    function renderSB(){
      const p1=md.jogador1,p2=md.jogador2,r=md.rodadaAtual||1;
      $('p1Name').textContent=p1?.nome||'???';$('p2Name').textContent=p2?.nome||'???';
      $('p1Avatar').textContent=(p1?.nome||'?')[0].toUpperCase();$('p2Avatar').textContent=(p2?.nome||'?')[0].toUpperCase();
      $('score1').textContent=md.placar?.jogador1||0;$('score2').textContent=md.placar?.jogador2||0;
      const sd=r>10;$('roundInfo').textContent=sd?`‚ö° Morte S√∫bita R${r-10} ‚Ä¢ üí∞${md.valorAposta}`:`Rodada ${r}/10 ‚Ä¢ üí∞${md.valorAposta}`;
      const c=getCob(r);const r1=$('p1Role'),r2=$('p2Role');
      if(c==='jogador1'){r1.textContent='‚öΩ Cobrador';r1.className='sb-role cobrador';r2.textContent='üß§ Goleiro';r2.className='sb-role goleiro'}
      else{r1.textContent='üß§ Goleiro';r1.className='sb-role goleiro';r2.textContent='‚öΩ Cobrador';r2.className='sb-role cobrador'}
    }

    function renderTK(){
      const rds=md.rodadas||[];let d1='',d2='';const mx=Math.max(5,Math.ceil(rds.length/2));
      for(let i=0;i<mx;i++){
        const a=i*2,b=i*2+1,ra=rds[a],rb=rds[b],cur=(md.rodadaAtual||1)-1;
        let c1='',i1='',c2='',i2='';
        if(ra){c1=ra.gol?'gol':'def';i1=ra.gol?'‚öΩ':'‚úï'}else if(a===cur){c1='cur';i1='‚Ä¢'}
        if(rb){c2=rb.gol?'gol':'def';i2=rb.gol?'‚öΩ':'‚úï'}else if(b===cur){c2='cur';i2='‚Ä¢'}
        d1+=`<div class="tdot ${c1}">${i1}</div>`;d2+=`<div class="tdot ${c2}">${i2}</div>`;
      }
      $('tP1').innerHTML=d1;$('tP2').innerHTML=d2;
    }

    function renderRound(){
      if(busy)return;
      const r=md.rodadaAtual||1,c=getCob(r),amC=c===myRole;
      const mine=md['escolha'+cap(myRole)],other=md['escolha'+cap(myRole==='jogador1'?'jogador2':'jogador1')];
      const el=$('instr'),btn=$('btnGo');resetGrid();selZ=null;

      if(mine&&other&&r>lastR){lastR=r;resolve(c);return}
      if(mine&&!other){el.className='instr wait';el.innerHTML=`<span class="spinner"></span>Aguardando advers√°rio...`;btn.disabled=true;btn.textContent='Aguardando...';offGrid()}
      else if(!mine){
        const sd=r>10;
        if(sd){el.className='instr sd';el.textContent=amC?'üíÄ MORTE S√öBITA ‚Äî Escolha onde CHUTAR!':'üíÄ MORTE S√öBITA ‚Äî Escolha onde DEFENDER!'}
        else if(amC){el.className='instr kick';el.textContent='‚öΩ Escolha onde CHUTAR!'}
        else{el.className='instr defend';el.textContent='üß§ Escolha onde DEFENDER!'}
        btn.disabled=true;btn.textContent='Selecione um quadrante';onGrid();
      }
    }

    function getCob(r){return r%2===1?'jogador1':'jogador2'}
    function cap(s){return s[0].toUpperCase()+s.slice(1)}
    function $(id){return document.getElementById(id)}

    function selZone(z){selZ=z;document.querySelectorAll('.gz').forEach(e=>e.classList.remove('sel'));document.querySelector(`[data-zone="${z}"]`).classList.add('sel');$('btnGo').disabled=false;$('btnGo').textContent='Confirmar! ‚úÖ'}
    function onGrid(){document.querySelectorAll('.gz').forEach(z=>z.classList.remove('off'))}
    function offGrid(){document.querySelectorAll('.gz').forEach(z=>z.classList.add('off'))}
    function resetGrid(){document.querySelectorAll('.gz').forEach(z=>{z.classList.remove('sel','off','r-gol','r-def');z.querySelector('.zone-icon').textContent=''})}

    async function confirmar(){
      if(!selZ)return;$('btnGo').disabled=true;
      try{
        await db.collection('penaltis').doc(matchId).update({['escolha'+cap(myRole)]:selZ});
        offGrid();$('instr').className='instr wait';$('instr').innerHTML=`<span class="spinner"></span>Aguardando advers√°rio...`;$('btnGo').textContent='Aguardando...';
      }catch(e){console.error(e);toast('‚ùå Erro');$('btnGo').disabled=false}
    }

    async function resolve(cob){
      busy=true;offGrid();
      const mine=md['escolha'+cap(myRole)],ot=myRole==='jogador1'?'jogador2':'jogador1',other=md['escolha'+cap(ot)];
      const amC=cob===myRole,chute=amC?mine:other,def=amC?other:mine,gol=chute!==def;

      await animate(chute,def,gol);
      const el=$('instr');
      if(gol){el.className='instr gol';el.textContent='‚öΩ GOOOL!!!'}else{el.className='instr saved';el.textContent='üß§ DEFENDEU!!!'}
      if(myRole==='jogador1')await processResult(chute,def,gol,cob);
      setTimeout(()=>{busy=false},2500);
    }

    function animate(chute,def,gol){
      return new Promise(res=>{
        const b=$('ball'),k=$('keeper'),cp=ZP[chute],dp=ZP[def];
        let s=document.getElementById('dkf');if(!s){s=document.createElement('style');s.id='dkf';document.head.appendChild(s)}
        s.textContent=`@keyframes bk{0%{bottom:28%;left:50%;transform:translateX(-50%) scale(1)}100%{bottom:calc(68% - ${cp.y}*0.7);left:${cp.x};transform:translateX(-50%) scale(0.6)}}@keyframes kd{0%{top:35%;left:50%;transform:translate(-50%,-50%) scale(1)}100%{top:calc(${dp.y}*0.7 + 5%);left:${dp.x};transform:translate(-50%,-50%) scale(1.15)}}`;
        b.className='ball';k.className='keeper';void b.offsetWidth;
        b.classList.add('kick');k.classList.add('dive');
        setTimeout(()=>{
          const cz=document.querySelector(`[data-zone="${chute}"]`),dz=document.querySelector(`[data-zone="${def}"]`);
          if(gol){cz.classList.add('r-gol');cz.querySelector('.zone-icon').textContent='‚öΩ';if(chute!==def){dz.classList.add('r-def');dz.querySelector('.zone-icon').textContent='üß§'}}
          else{cz.classList.add('r-def');cz.querySelector('.zone-icon').textContent='üß§‚öΩ'}
        },400);
        setTimeout(()=>{b.className='ball';k.className='keeper';res()},2000);
      });
    }

    async function processResult(chute,def,gol,cob){
      const r=md.rodadaAtual||1,nova={rodada:r,cobrador:cob,chute,defesa:def,gol};
      const rds=[...(md.rodadas||[]),nova],pl={...(md.placar||{jogador1:0,jogador2:0})};
      if(gol)pl[cob]++;
      let st='em_andamento',vc=null;

      if(rds.length>=10&&pl.jogador1!==pl.jogador2){st='finalizado';vc=pl.jogador1>pl.jogador2?md.jogador1.uid:md.jogador2.uid}
      if(st==='em_andamento'&&rds.length>=6&&rds.length<10){
        const rp1=Math.ceil((10-rds.length)/2),rp2=Math.floor((10-rds.length)/2);
        if(pl.jogador1>pl.jogador2+rp2){st='finalizado';vc=md.jogador1.uid}
        else if(pl.jogador2>pl.jogador1+rp1){st='finalizado';vc=md.jogador2.uid}
      }
      if(st==='em_andamento'&&rds.length>10&&rds.length%2===0&&pl.jogador1!==pl.jogador2){
        st='finalizado';vc=pl.jogador1>pl.jogador2?md.jogador1.uid:md.jogador2.uid;
      }

      const up={rodadas:rds,placar:pl,rodadaAtual:rds.length+1,escolhaJogador1:null,escolhaJogador2:null};
      if(st==='finalizado'){
        up.status='finalizado';up.vencedor=vc;up.stats=compStats(rds);
        if(vc){
          const pr=md.valorAposta*2;
          await db.collection('usuarios').doc(vc).update({creditos:firebase.firestore.FieldValue.increment(pr)});
          await db.collection('usuarios').doc(vc).collection('extrato').doc().set({tipo:'entrada',valor:pr,descricao:`P√™naltis: vit√≥ria! (+${pr} cr√©ditos)`,data:firebase.firestore.FieldValue.serverTimestamp()});
          const loser=vc===md.jogador1.uid?md.jogador2.uid:md.jogador1.uid;
          const wName=vc===md.jogador1.uid?md.jogador1.nome:md.jogador2.nome;
          try{await db.collection('notificacoes').add({para:loser,tipo:'penalti_resultado',titulo:'‚öΩ Resultado P√™naltis',mensagem:`Perdeu para ${wName} (${pl.jogador1}√ó${pl.jogador2}). -${md.valorAposta} cr√©ditos`,lida:false,data:firebase.firestore.FieldValue.serverTimestamp()})}catch(e){}
        }
      }
      await db.collection('penaltis').doc(matchId).update(up);
    }

    function compStats(rds){
      const s={jogador1:{chutes:{},defesas:{},gols:0,defs:0,tc:0,td:0},jogador2:{chutes:{},defesas:{},gols:0,defs:0,tc:0,td:0}};
      rds.forEach(r=>{const c=r.cobrador,g=c==='jogador1'?'jogador2':'jogador1';s[c].chutes[r.chute]=(s[c].chutes[r.chute]||0)+1;s[c].tc++;if(r.gol)s[c].gols++;s[g].defesas[r.defesa]=(s[g].defesas[r.defesa]||0)+1;s[g].td++;if(!r.gol)s[g].defs++});
      return s;
    }

    function renderEnd(){
      renderSB();renderTK();
      const w=md.vencedor===currentUser.uid,pl=`${md.placar?.jogador1||0} √ó ${md.placar?.jogador2||0}`,pr=md.valorAposta*2;
      const card=$('resCard');
      if(w){card.className='result-card win';$('resIcon').textContent='üèÜ';$('resTitle').textContent='VIT√ìRIA!';$('resTitle').style.color='var(--green)';$('resCred').className='r-credits win';$('resCred').textContent=`+${pr} cr√©ditos üí∞`;$('btnRes').className='btn-res win';confetti()}
      else{card.className='result-card loss';$('resIcon').textContent='üò¢';$('resTitle').textContent='Derrota...';$('resTitle').style.color='var(--red)';$('resCred').className='r-credits loss';$('resCred').textContent=`-${md.valorAposta} cr√©ditos`;$('btnRes').className='btn-res loss'}
      $('resScore').textContent=pl;$('btnRes').textContent='Voltar ao Lobby';
      renderStats();$('resOverlay').classList.add('active');
    }

    function renderStats(){
      const st=md.stats,c=$('statsBox');if(!st){c.innerHTML='';return}
      const my=st[myRole],op=st[myRole==='jogador1'?'jogador2':'jogador1'];
      const opN=md[myRole==='jogador1'?'jogador2':'jogador1']?.nome||'Adv.';
      const ma=my.tc>0?Math.round(my.gols/my.tc*100):0;
      const md2=my.td>0?Math.round(my.defs/my.td*100):0;
      const oa=op.tc>0?Math.round(op.gols/op.tc*100):0;
      const fk=best(my.chutes);

      c.innerHTML=`<div class="stats-section"><div class="stats-title">üìä Suas Estat√≠sticas</div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-val grn">${my.gols}/${my.tc}</div><div class="stat-lbl">Gols (${ma}%)</div></div>
          <div class="stat-box"><div class="stat-val blu">${my.defs}/${my.td}</div><div class="stat-lbl">Defesas (${md2}%)</div></div>
          <div class="stat-box"><div class="stat-val org">${fk?ZN[fk]||fk:'‚Äî'}</div><div class="stat-lbl">Chute favorito</div></div>
          <div class="stat-box"><div class="stat-val red">${oa}%</div><div class="stat-lbl">Aproveit. ${opN}</div></div>
        </div></div>
        <div class="hm-section"><div class="hm-row">
          <div style="flex:1"><div class="hm-title">üéØ Seus Chutes</div>${hmap(my.chutes,'grn')}</div>
          <div style="flex:1"><div class="hm-title">üß§ Suas Defesas</div>${hmap(my.defesas,'blu')}</div>
        </div><div class="hm-row">
          <div style="flex:1"><div class="hm-title">üéØ ${opN}</div>${hmap(op.chutes,'red')}</div>
          <div style="flex:1"><div class="hm-title">üß§ ${opN}</div>${hmap(op.defesas,'red')}</div>
        </div></div>`;
    }

    function hmap(d,c){
      const z=['TL','TC','TR','ML','MC','MR','BL','BC','BR'],mx=Math.max(1,...Object.values(d||{}));
      const rgb={grn:'46,213,115',blu:'59,130,246',red:'255,71,87',org:'255,159,67'}[c]||'46,213,115';
      return `<div class="hm-grid">${z.map(k=>{const v=(d||{})[k]||0;return `<div class="hm-cell" style="background:rgba(${rgb},${v>0?0.2+v/mx*0.8:0.05})">${v||''}</div>`}).join('')}</div>`;
    }
    function best(o){let m=0,b=null;for(const[k,v]of Object.entries(o||{}))if(v>m){m=v;b=k}return b}

    function confetti(){const c=$('confC'),cols=['#ff9f43','#ffc048','#ff4757','#2ed573','#3b82f6','#a855f7','#ffffff'];for(let i=0;i<80;i++){const d=document.createElement('div');d.className='cft';d.style.left=Math.random()*100+'%';d.style.backgroundColor=cols[Math.floor(Math.random()*cols.length)];d.style.animationDelay=Math.random()*2+'s';d.style.animationDuration=(2+Math.random()*2)+'s';d.style.borderRadius=Math.random()>0.5?'50%':'2px';d.style.width=(5+Math.random()*8)+'px';d.style.height=(5+Math.random()*8)+'px';c.appendChild(d);setTimeout(()=>d.remove(),5000)}}

    function toast(m){const t=$('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
