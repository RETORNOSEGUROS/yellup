<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arena de P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1a1a6e">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #0a0e13;
      --bg-card: #131920;
      --bg-elevated: #1a2230;
      --accent-primary: #ff9f43;
      --accent-secondary: #ffc048;
      --accent-glow: rgba(255, 159, 67, 0.25);
      --live-red: #ff4757;
      --win-green: #2ed573;
      --text-primary: #f1f2f6;
      --text-secondary: #a4b0be;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* SCOREBOARD */
    .scoreboard {
      background: rgba(10, 14, 19, 0.98);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      position: sticky; top: 0; z-index: 100;
      border-bottom: 1px solid rgba(255, 159, 67, 0.1);
    }
    .scoreboard-inner {
      max-width: 500px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
    }
    .sb-player {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      flex: 1; text-align: center;
    }
    .sb-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.9em; color: var(--bg-dark);
    }
    .sb-p1 .sb-avatar { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .sb-p2 .sb-avatar { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .sb-name { font-size: 0.7em; font-weight: 600; max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sb-role { font-size: 0.6em; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .sb-role.cobrador { background: rgba(255, 159, 67, 0.2); color: var(--accent-primary); }
    .sb-role.goleiro { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .sb-role.hidden { visibility: hidden; }

    .sb-center {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 0 16px;
    }
    .sb-score {
      font-size: 2em; font-weight: 800; letter-spacing: 4px;
      display: flex; align-items: center; gap: 8px;
    }
    .sb-score .p1-score { color: #60a5fa; }
    .sb-score .p2-score { color: #f87171; }
    .sb-score .divider { color: var(--text-secondary); font-size: 0.7em; }
    .sb-round { font-size: 0.65em; color: var(--text-secondary); font-weight: 600; }

    /* PENALTY DOTS */
    .penalty-tracker {
      display: flex; justify-content: center; gap: 20px;
      padding: 10px 16px;
      background: var(--bg-card);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .tracker-side { display: flex; gap: 5px; align-items: center; }
    .tracker-dot {
      width: 18px; height: 18px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.55em; border: 2px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.3);
    }
    .tracker-dot.gol { border-color: var(--win-green); background: rgba(46,213,115,0.2); }
    .tracker-dot.defesa { border-color: var(--live-red); background: rgba(255,71,87,0.2); }
    .tracker-dot.current { border-color: var(--accent-primary); animation: dotPulse 1.5s ease-in-out infinite; }
    @keyframes dotPulse { 0%,100% { box-shadow: 0 0 0 rgba(255,159,67,0); } 50% { box-shadow: 0 0 10px rgba(255,159,67,0.4); } }
    .tracker-label { font-size: 0.6em; font-weight: 700; color: var(--text-secondary); margin: 0 4px; }

    /* FIELD */
    .field-area {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding: 30px 20px 20px;
    }

    /* GOAL */
    .goal-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1.5;
      max-height: 320px;
      margin: 0 auto;
    }

    /* Goal frame */
    .goal-frame {
      position: absolute;
      top: 0; left: 5%; right: 5%; bottom: 10%;
      border: 5px solid #e0e0e0;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      background: repeating-linear-gradient(
        90deg,
        transparent, transparent 14px,
        rgba(255,255,255,0.06) 14px, rgba(255,255,255,0.06) 15px
      ),
      repeating-linear-gradient(
        0deg,
        transparent, transparent 14px,
        rgba(255,255,255,0.06) 14px, rgba(255,255,255,0.06) 15px
      );
      background-color: rgba(0,0,0,0.4);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.3);
    }

    /* Goal posts shadow */
    .goal-frame::before {
      content: '';
      position: absolute;
      bottom: -10px; left: -8px; right: -8px;
      height: 10px;
      background: linear-gradient(180deg, rgba(0,0,0,0.3), transparent);
    }

    /* Grass */
    .grass {
      position: absolute;
      bottom: 0; left: 0; right: 0; height: 12%;
      background: linear-gradient(180deg, #1b5e20, #2e7d32);
      border-radius: 0 0 4px 4px;
    }
    .grass::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    /* 3x3 grid */
    .goal-grid {
      position: absolute;
      top: 5px; left: calc(5% + 5px); right: calc(5% + 5px); bottom: calc(10% + 0px);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 3px;
      z-index: 10;
    }

    .goal-zone {
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: 700;
      color: transparent;
      transition: all 0.2s;
      position: relative;
      background: rgba(255,255,255,0.02);
      border: 2px solid transparent;
    }
    .goal-zone:hover {
      background: rgba(255, 159, 67, 0.15);
      border-color: rgba(255, 159, 67, 0.4);
      color: var(--accent-primary);
    }
    .goal-zone:active { transform: scale(0.95); }
    .goal-zone.selected {
      background: rgba(255, 159, 67, 0.25);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      box-shadow: 0 0 15px var(--accent-glow);
    }
    .goal-zone.disabled { pointer-events: none; opacity: 0.5; }

    /* Result overlay on zones */
    .goal-zone.result-gol {
      background: rgba(46, 213, 115, 0.3);
      border-color: var(--win-green);
      color: white;
    }
    .goal-zone.result-defesa {
      background: rgba(255, 71, 87, 0.3);
      border-color: var(--live-red);
      color: white;
    }

    /* Ball */
    .ball {
      position: absolute;
      width: 30px; height: 30px;
      font-size: 28px; line-height: 1;
      z-index: 20;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      transition: none;
      display: none;
    }
    .ball.kick {
      display: block;
      animation: ballKick 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    /* Goalkeeper */
    .goalkeeper {
      position: absolute;
      font-size: 2.5em;
      z-index: 15;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: none;
      display: none;
    }
    .goalkeeper.dive {
      display: block;
      animation: gkDive 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    /* CONTROLS */
    .controls-area {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    .instruction {
      font-size: 1.1em; font-weight: 700;
      margin-bottom: 16px; padding: 14px 20px;
      border-radius: 14px;
    }
    .instruction.kick-mode {
      background: linear-gradient(135deg, rgba(255,159,67,0.15), rgba(255,159,67,0.05));
      border: 1px solid rgba(255,159,67,0.3);
      color: var(--accent-primary);
    }
    .instruction.defend-mode {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05));
      border: 1px solid rgba(59,130,246,0.3);
      color: #60a5fa;
    }
    .instruction.waiting {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-secondary);
    }
    .instruction.result-gol {
      background: rgba(46,213,115,0.15);
      border: 1px solid rgba(46,213,115,0.3);
      color: var(--win-green); font-size: 1.3em;
    }
    .instruction.result-defesa {
      background: rgba(255,71,87,0.15);
      border: 1px solid rgba(255,71,87,0.3);
      color: var(--live-red); font-size: 1.3em;
    }

    .btn-confirm {
      padding: 16px 40px;
      background: linear-gradient(135deg, var(--accent-primary), #ff8c42);
      border: none; border-radius: 14px;
      color: var(--bg-dark); font-family: 'Poppins', sans-serif;
      font-weight: 700; font-size: 1em; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-confirm:hover { transform: translateY(-2px); }
    .btn-confirm:active { transform: scale(0.97); }
    .btn-confirm:disabled { background: rgba(255,255,255,0.1); color: var(--text-secondary); box-shadow: none; cursor: default; }

    /* WAITING SPINNER */
    .waiting-spinner {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.2); border-top-color: var(--accent-primary);
      border-radius: 50%; animation: spin 0.8s linear infinite;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* RESULT OVERLAY */
    .result-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.88); z-index: 2000;
      justify-content: center; align-items: center; backdrop-filter: blur(10px);
    }
    .result-overlay.active { display: flex; }
    .result-card {
      text-align: center; padding: 40px 30px;
      background: linear-gradient(135deg, #1e2936, #18222e);
      border-radius: 24px; max-width: 380px; width: 92%;
      animation: modalPop 0.5s cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .result-card.win { border: 2px solid var(--win-green); }
    .result-card.loss { border: 2px solid var(--live-red); }
    @keyframes modalPop { from { opacity:0; transform: scale(0.5); } to { opacity:1; transform: scale(1); } }

    .result-icon { font-size: 4em; margin-bottom: 12px; }
    .result-title { font-size: 1.6em; font-weight: 800; margin-bottom: 6px; }
    .result-score { font-size: 1.2em; color: var(--text-secondary); margin-bottom: 16px; }
    .result-credits { font-size: 1.8em; font-weight: 800; margin-bottom: 20px; }
    .result-credits.win { color: var(--win-green); }
    .result-credits.loss { color: var(--live-red); }

    .btn-result {
      padding: 14px 40px; border-radius: 14px; border: none;
      font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1em;
      cursor: pointer; transition: all 0.3s;
    }
    .btn-result.win { background: linear-gradient(135deg, var(--win-green), #7bed9f); color: var(--bg-dark); }
    .btn-result.loss { background: rgba(255,255,255,0.1); color: var(--text-primary); }

    /* TOAST */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.9); color: white; padding: 15px 30px;
      border-radius: 50px; font-weight: 600; z-index: 3000; opacity: 0; transition: all 0.3s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* CONFETTI */
    .confetti-container { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:2001; }
    .confetti { position: absolute; width: 10px; height: 10px; top: -10px; animation: confettiFall 3s ease-in forwards; }
    @keyframes confettiFall { 0% { transform: translateY(0) rotate(0); opacity:1; } 100% { transform: translateY(100vh) rotate(720deg); opacity:0; } }

    @media (max-width: 380px) {
      .sb-score { font-size: 1.5em; letter-spacing: 2px; }
      .sb-name { font-size: 0.6em; max-width: 60px; }
      .goal-container { max-height: 260px; }
    }
  </style>
</head>
<body>

  <!-- SCOREBOARD -->
  <div class="scoreboard">
    <div class="scoreboard-inner">
      <div class="sb-player sb-p1">
        <div class="sb-avatar" id="p1Avatar">?</div>
        <div class="sb-name" id="p1Name">Jogador 1</div>
        <span class="sb-role hidden" id="p1Role">‚öΩ Cobrador</span>
      </div>
      <div class="sb-center">
        <div class="sb-score">
          <span class="p1-score" id="score1">0</span>
          <span class="divider">√ó</span>
          <span class="p2-score" id="score2">0</span>
        </div>
        <div class="sb-round" id="roundInfo">Rodada 1/10</div>
      </div>
      <div class="sb-player sb-p2">
        <div class="sb-avatar" id="p2Avatar">?</div>
        <div class="sb-name" id="p2Name">Jogador 2</div>
        <span class="sb-role hidden" id="p2Role">üß§ Goleiro</span>
      </div>
    </div>
  </div>

  <!-- PENALTY TRACKER -->
  <div class="penalty-tracker">
    <div class="tracker-side" id="trackerP1"></div>
    <span class="tracker-label">P1</span>
    <span style="color:var(--text-secondary); font-size:0.7em;">|</span>
    <span class="tracker-label">P2</span>
    <div class="tracker-side" id="trackerP2"></div>
  </div>

  <!-- FIELD + GOAL -->
  <div class="field-area">
    <div class="goal-container" id="goalContainer">
      <div class="goal-frame"></div>
      <div class="grass"></div>
      <div class="goal-grid" id="goalGrid">
        <div class="goal-zone" data-zone="TL" onclick="selectZone('TL')">‚Üñ</div>
        <div class="goal-zone" data-zone="TC" onclick="selectZone('TC')">‚¨Ü</div>
        <div class="goal-zone" data-zone="TR" onclick="selectZone('TR')">‚Üó</div>
        <div class="goal-zone" data-zone="ML" onclick="selectZone('ML')">‚¨Ö</div>
        <div class="goal-zone" data-zone="MC" onclick="selectZone('MC')">‚óè</div>
        <div class="goal-zone" data-zone="MR" onclick="selectZone('MR')">‚û°</div>
        <div class="goal-zone" data-zone="BL" onclick="selectZone('BL')">‚Üô</div>
        <div class="goal-zone" data-zone="BC" onclick="selectZone('BC')">‚¨á</div>
        <div class="goal-zone" data-zone="BR" onclick="selectZone('BR')">‚Üò</div>
      </div>
      <div class="ball" id="ball">‚öΩ</div>
      <div class="goalkeeper" id="goalkeeper">üß§</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls-area">
    <div class="instruction waiting" id="instruction">Carregando...</div>
    <button class="btn-confirm" id="btnConfirm" disabled onclick="confirmarEscolha()">Confirmar</button>
  </div>

  <!-- RESULT OVERLAY -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">üèÜ</div>
      <div class="result-title" id="resultTitle">Vit√≥ria!</div>
      <div class="result-score" id="resultScore">3 √ó 1</div>
      <div class="result-credits" id="resultCredits">+20 cr√©ditos</div>
      <button class="btn-result" id="btnResult" onclick="window.location.href='penaltis.html'">Voltar ao Lobby</button>
    </div>
  </div>

  <!-- CONFETTI -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e => console.error(e));

    // ==========================================
    // STATE
    // ==========================================
    const matchId = new URLSearchParams(window.location.search).get('id');
    let currentUser = null;
    let matchData = null;
    let myRole = null; // 'jogador1' or 'jogador2'
    let selectedZone = null;
    let isProcessing = false;
    let unsubMatch = null;

    const ZONE_POSITIONS = {
      TL: { x: '18%', y: '20%' }, TC: { x: '50%', y: '15%' }, TR: { x: '82%', y: '20%' },
      ML: { x: '18%', y: '50%' }, MC: { x: '50%', y: '50%' }, MR: { x: '82%', y: '50%' },
      BL: { x: '18%', y: '75%' }, BC: { x: '50%', y: '78%' }, BR: { x: '82%', y: '75%' }
    };

    // ==========================================
    // AUTH
    // ==========================================
    auth.onAuthStateChanged(user => {
      if (!user) { window.location.href = 'index.html'; return; }
      if (!matchId) { window.location.href = 'penaltis.html'; return; }
      currentUser = user;
      escutarPartida();
    });

    // ==========================================
    // LISTEN TO MATCH IN REAL-TIME
    // ==========================================
    function escutarPartida() {
      unsubMatch = db.collection('penaltis').doc(matchId).onSnapshot(snap => {
        if (!snap.exists) {
          showToast('‚ùå Partida n√£o encontrada');
          setTimeout(() => window.location.href = 'penaltis.html', 1500);
          return;
        }

        matchData = snap.data();
        myRole = matchData.jogador1?.uid === currentUser.uid ? 'jogador1' : 'jogador2';

        if (matchData.status === 'finalizado') {
          renderFinished();
          return;
        }

        renderScoreboard();
        renderTracker();
        renderRound();
      });
    }

    // ==========================================
    // RENDER SCOREBOARD
    // ==========================================
    function renderScoreboard() {
      const p1 = matchData.jogador1;
      const p2 = matchData.jogador2;
      const rodada = matchData.rodadaAtual || 1;

      document.getElementById('p1Name').textContent = p1?.nome || '???';
      document.getElementById('p2Name').textContent = p2?.nome || '???';
      document.getElementById('p1Avatar').textContent = (p1?.nome || '?').charAt(0).toUpperCase();
      document.getElementById('p2Avatar').textContent = (p2?.nome || '?').charAt(0).toUpperCase();

      document.getElementById('score1').textContent = matchData.placar?.jogador1 || 0;
      document.getElementById('score2').textContent = matchData.placar?.jogador2 || 0;

      const totalRodadas = Math.max(10, (matchData.rodadas?.length || 0) + 1);
      document.getElementById('roundInfo').textContent = `Rodada ${rodada}/${totalRodadas > 10 ? '‚àû Morte S√∫bita' : '10'} ‚Ä¢ üí∞ ${matchData.valorAposta}`;

      // Roles
      const cobrador = getCobrador(rodada);
      const p1RoleEl = document.getElementById('p1Role');
      const p2RoleEl = document.getElementById('p2Role');

      if (cobrador === 'jogador1') {
        p1RoleEl.textContent = '‚öΩ Cobrador'; p1RoleEl.className = 'sb-role cobrador';
        p2RoleEl.textContent = 'üß§ Goleiro'; p2RoleEl.className = 'sb-role goleiro';
      } else {
        p1RoleEl.textContent = 'üß§ Goleiro'; p1RoleEl.className = 'sb-role goleiro';
        p2RoleEl.textContent = '‚öΩ Cobrador'; p2RoleEl.className = 'sb-role cobrador';
      }
    }

    // ==========================================
    // RENDER PENALTY TRACKER
    // ==========================================
    function renderTracker() {
      const rodadas = matchData.rodadas || [];
      const t1 = document.getElementById('trackerP1');
      const t2 = document.getElementById('trackerP2');

      let dotsP1 = '', dotsP2 = '';

      for (let i = 0; i < 5; i++) {
        // P1 kicks in rounds 1,3,5,7,9 (index 0,2,4,6,8)
        const roundIdxP1 = i * 2; // round 0,2,4,6,8
        const roundIdxP2 = i * 2 + 1; // round 1,3,5,7,9

        const rP1 = rodadas[roundIdxP1];
        const rP2 = rodadas[roundIdxP2];

        let clsP1 = '', iconP1 = '';
        if (rP1) {
          clsP1 = rP1.gol ? 'gol' : 'defesa';
          iconP1 = rP1.gol ? '‚öΩ' : '‚ùå';
        } else if (roundIdxP1 === (matchData.rodadaAtual || 1) - 1) {
          clsP1 = 'current';
          iconP1 = '‚Ä¢';
        }

        let clsP2 = '', iconP2 = '';
        if (rP2) {
          clsP2 = rP2.gol ? 'gol' : 'defesa';
          iconP2 = rP2.gol ? '‚öΩ' : '‚ùå';
        } else if (roundIdxP2 === (matchData.rodadaAtual || 1) - 1) {
          clsP2 = 'current';
          iconP2 = '‚Ä¢';
        }

        dotsP1 += `<div class="tracker-dot ${clsP1}">${iconP1}</div>`;
        dotsP2 += `<div class="tracker-dot ${clsP2}">${iconP2}</div>`;
      }

      // Morte s√∫bita dots
      for (let i = 10; i < rodadas.length; i++) {
        const r = rodadas[i];
        const isP1 = getCobrador(i + 1) === 'jogador1';
        const cls = r.gol ? 'gol' : 'defesa';
        const icon = r.gol ? '‚öΩ' : '‚ùå';
        if (isP1) dotsP1 += `<div class="tracker-dot ${cls}">${icon}</div>`;
        else dotsP2 += `<div class="tracker-dot ${cls}">${icon}</div>`;
      }

      t1.innerHTML = dotsP1;
      t2.innerHTML = dotsP2;
    }

    // ==========================================
    // RENDER CURRENT ROUND
    // ==========================================
    function renderRound() {
      const rodada = matchData.rodadaAtual || 1;
      const cobrador = getCobrador(rodada);
      const iAmCobrador = cobrador === myRole;
      const minhaEscolha = matchData[`escolha${capitalize(myRole)}`];
      const outroRole = myRole === 'jogador1' ? 'jogador2' : 'jogador1';
      const outroEscolha = matchData[`escolha${capitalize(outroRole)}`];

      const instrEl = document.getElementById('instruction');
      const btnEl = document.getElementById('btnConfirm');

      // Reset zones
      resetGoalGrid();
      selectedZone = null;

      if (minhaEscolha && !outroEscolha) {
        // I chose, waiting for opponent
        instrEl.className = 'instruction waiting';
        instrEl.innerHTML = `<span class="waiting-spinner"></span> Aguardando advers√°rio...`;
        btnEl.disabled = true;
        btnEl.textContent = 'Aguardando...';
        disableGoalGrid();
      } else if (!minhaEscolha) {
        // My turn to choose
        if (iAmCobrador) {
          instrEl.className = 'instruction kick-mode';
          instrEl.textContent = '‚öΩ Escolha onde CHUTAR!';
        } else {
          instrEl.className = 'instruction defend-mode';
          instrEl.textContent = 'üß§ Escolha onde DEFENDER!';
        }
        btnEl.disabled = true;
        btnEl.textContent = 'Selecione um quadrante';
        enableGoalGrid();
      }

      // Both chose ‚Üí resolve (handled by the writer)
      if (minhaEscolha && outroEscolha && !isProcessing) {
        resolverRodada(cobrador, minhaEscolha, outroEscolha);
      }
    }

    // ==========================================
    // WHO KICKS THIS ROUND
    // ==========================================
    function getCobrador(rodada) {
      // Odd rounds (1,3,5,...): jogador1 kicks
      // Even rounds (2,4,6,...): jogador2 kicks
      return rodada % 2 === 1 ? 'jogador1' : 'jogador2';
    }

    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // ==========================================
    // SELECT ZONE
    // ==========================================
    function selectZone(zone) {
      selectedZone = zone;
      document.querySelectorAll('.goal-zone').forEach(z => z.classList.remove('selected'));
      document.querySelector(`[data-zone="${zone}"]`).classList.add('selected');
      document.getElementById('btnConfirm').disabled = false;
      document.getElementById('btnConfirm').textContent = 'Confirmar! ‚úÖ';
    }

    function enableGoalGrid() {
      document.querySelectorAll('.goal-zone').forEach(z => z.classList.remove('disabled'));
    }
    function disableGoalGrid() {
      document.querySelectorAll('.goal-zone').forEach(z => z.classList.add('disabled'));
    }
    function resetGoalGrid() {
      document.querySelectorAll('.goal-zone').forEach(z => {
        z.classList.remove('selected', 'disabled', 'result-gol', 'result-defesa');
      });
    }

    // ==========================================
    // CONFIRM CHOICE
    // ==========================================
    async function confirmarEscolha() {
      if (!selectedZone) return;
      const btn = document.getElementById('btnConfirm');
      btn.disabled = true;

      try {
        const campo = `escolha${capitalize(myRole)}`;
        await db.collection('penaltis').doc(matchId).update({
          [campo]: selectedZone
        });

        disableGoalGrid();
        document.getElementById('instruction').className = 'instruction waiting';
        document.getElementById('instruction').innerHTML = `<span class="waiting-spinner"></span> Aguardando advers√°rio...`;
        btn.textContent = 'Aguardando...';
      } catch (e) {
        console.error('Erro:', e);
        showToast('‚ùå Erro ao enviar escolha');
        btn.disabled = false;
      }
    }

    // ==========================================
    // RESOLVE ROUND (when both choices arrive)
    // ==========================================
    async function resolverRodada(cobrador, minhaEscolha, outroEscolha) {
      isProcessing = true;
      disableGoalGrid();

      const iAmCobrador = cobrador === myRole;
      const chute = iAmCobrador ? minhaEscolha : outroEscolha;
      const defesa = iAmCobrador ? outroEscolha : minhaEscolha;
      const isGol = chute !== defesa;

      // Animate
      await animateResult(chute, defesa, isGol);

      // Show result message
      const instrEl = document.getElementById('instruction');
      if (isGol) {
        instrEl.className = 'instruction result-gol';
        instrEl.textContent = '‚öΩ GOOOL!!!';
      } else {
        instrEl.className = 'instruction result-defesa';
        instrEl.textContent = 'üß§ DEFENDEU!!!';
      }

      // Only one player should write the result (jogador1 to avoid race conditions)
      if (myRole === 'jogador1') {
        await processarResultado(chute, defesa, isGol, cobrador);
      }

      // Wait, then the onSnapshot will trigger next round
      setTimeout(() => { isProcessing = false; }, 2500);
    }

    // ==========================================
    // ANIMATE
    // ==========================================
    function animateResult(chute, defesa, isGol) {
      return new Promise(resolve => {
        const ball = document.getElementById('ball');
        const gk = document.getElementById('goalkeeper');
        const chutePos = ZONE_POSITIONS[chute];
        const defesaPos = ZONE_POSITIONS[defesa];

        // Set CSS custom properties for animation targets
        ball.style.setProperty('--target-x', chutePos.x);
        ball.style.setProperty('--target-y', chutePos.y);
        gk.style.setProperty('--target-x', defesaPos.x);
        gk.style.setProperty('--target-y', defesaPos.y);

        // Create dynamic keyframes
        const ballKF = `@keyframes ballKick { 
          0% { bottom: 5%; left: 50%; transform: translateX(-50%) scale(1); }
          100% { bottom: calc(90% - ${chutePos.y}); left: ${chutePos.x}; transform: translateX(-50%) scale(0.7); }
        }`;
        const gkKF = `@keyframes gkDive { 
          0% { top: 45%; left: 50%; transform: translate(-50%, -50%) scale(1); }
          100% { top: ${defesaPos.y}; left: ${defesaPos.x}; transform: translate(-50%, -50%) scale(1.2); }
        }`;

        // Inject keyframes
        let styleEl = document.getElementById('dynamicKF');
        if (!styleEl) {
          styleEl = document.createElement('style');
          styleEl.id = 'dynamicKF';
          document.head.appendChild(styleEl);
        }
        styleEl.textContent = ballKF + gkKF;

        // Trigger
        ball.className = 'ball';
        gk.className = 'goalkeeper';
        void ball.offsetWidth; // force reflow
        ball.classList.add('kick');
        gk.classList.add('dive');

        // Highlight zones
        setTimeout(() => {
          const chuteZone = document.querySelector(`[data-zone="${chute}"]`);
          const defesaZone = document.querySelector(`[data-zone="${defesa}"]`);

          if (isGol) {
            chuteZone.classList.add('result-gol');
            chuteZone.textContent = '‚öΩ';
            if (chute !== defesa) {
              defesaZone.classList.add('result-defesa');
              defesaZone.textContent = 'üß§';
            }
          } else {
            chuteZone.classList.add('result-defesa');
            chuteZone.textContent = 'üß§‚öΩ';
          }
        }, 500);

        setTimeout(() => {
          ball.className = 'ball';
          gk.className = 'goalkeeper';
          resolve();
        }, 2000);
      });
    }

    // ==========================================
    // PROCESS RESULT (only jogador1 writes)
    // ==========================================
    async function processarResultado(chute, defesa, isGol, cobrador) {
      const rodada = matchData.rodadaAtual || 1;
      const novaRodada = {
        rodada,
        cobrador,
        chute, defesa, gol: isGol
      };

      const rodadas = [...(matchData.rodadas || []), novaRodada];
      const placar = { ...(matchData.placar || { jogador1: 0, jogador2: 0 }) };
      if (isGol) placar[cobrador]++;

      // Check if match is decided
      let status = 'em_andamento';
      let vencedor = null;

      if (rodadas.length >= 10) {
        // After 10 rounds, check score
        if (placar.jogador1 !== placar.jogador2) {
          status = 'finalizado';
          vencedor = placar.jogador1 > placar.jogador2 ? matchData.jogador1.uid : matchData.jogador2.uid;
        }
        // Else: sudden death continues
      } else if (rodadas.length >= 6) {
        // Early finish check: can trailing player still catch up?
        const p1Kicks = Math.ceil((10 - rodadas.length) / 2); // remaining kicks for p1
        const p2Kicks = Math.floor((10 - rodadas.length) / 2);
        const p1Max = placar.jogador1 + (getCobrador(rodadas.length + 1) === 'jogador1' ? p1Kicks : p1Kicks);
        const p2Max = placar.jogador2 + p2Kicks + (getCobrador(rodadas.length + 1) === 'jogador2' ? 1 : 0);

        // Simplified: if one player leads by more than remaining kicks of other
        const remainingForP1 = Math.ceil((10 - rodadas.length) / 2);
        const remainingForP2 = Math.floor((10 - rodadas.length) / 2);

        if (placar.jogador1 > placar.jogador2 + remainingForP2) {
          status = 'finalizado';
          vencedor = matchData.jogador1.uid;
        } else if (placar.jogador2 > placar.jogador1 + remainingForP1) {
          status = 'finalizado';
          vencedor = matchData.jogador2.uid;
        }
      }

      // Sudden death (after 10): if both have had equal kicks and scores differ
      if (rodadas.length > 10 && rodadas.length % 2 === 0) {
        if (placar.jogador1 !== placar.jogador2) {
          status = 'finalizado';
          vencedor = placar.jogador1 > placar.jogador2 ? matchData.jogador1.uid : matchData.jogador2.uid;
        }
      }

      const update = {
        rodadas,
        placar,
        rodadaAtual: rodadas.length + 1,
        escolhaJogador1: null,
        escolhaJogador2: null
      };

      if (status === 'finalizado') {
        update.status = 'finalizado';
        update.vencedor = vencedor;

        // Pay winner
        if (vencedor) {
          const premio = matchData.valorAposta * 2;
          await db.collection('usuarios').doc(vencedor).update({
            creditos: firebase.firestore.FieldValue.increment(premio)
          });
          await db.collection('usuarios').doc(vencedor).collection('extrato').doc().set({
            tipo: 'entrada',
            valor: premio,
            descricao: `P√™naltis: vit√≥ria! (+${premio} cr√©ditos)`,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }

      // Write after a small delay to let animations play
      setTimeout(async () => {
        await db.collection('penaltis').doc(matchId).update(update);
      }, 2000);
    }

    // ==========================================
    // RENDER FINISHED
    // ==========================================
    function renderFinished() {
      renderScoreboard();
      renderTracker();

      const ganhei = matchData.vencedor === currentUser.uid;
      const placar = `${matchData.placar?.jogador1 || 0} √ó ${matchData.placar?.jogador2 || 0}`;
      const premio = matchData.valorAposta * 2;

      const overlay = document.getElementById('resultOverlay');
      const card = document.getElementById('resultCard');
      const icon = document.getElementById('resultIcon');
      const title = document.getElementById('resultTitle');
      const score = document.getElementById('resultScore');
      const credits = document.getElementById('resultCredits');
      const btn = document.getElementById('btnResult');

      if (ganhei) {
        card.className = 'result-card win';
        icon.textContent = 'üèÜ';
        title.textContent = 'VIT√ìRIA!';
        title.style.color = 'var(--win-green)';
        credits.className = 'result-credits win';
        credits.textContent = `+${premio} cr√©ditos üí∞`;
        btn.className = 'btn-result win';
        spawnConfetti();
      } else {
        card.className = 'result-card loss';
        icon.textContent = 'üò¢';
        title.textContent = 'Derrota...';
        title.style.color = 'var(--live-red)';
        credits.className = 'result-credits loss';
        credits.textContent = `-${matchData.valorAposta} cr√©ditos`;
        btn.className = 'btn-result loss';
      }

      score.textContent = placar;
      btn.textContent = 'Voltar ao Lobby';
      overlay.classList.add('active');
    }

    // ==========================================
    // CONFETTI
    // ==========================================
    function spawnConfetti() {
      const container = document.getElementById('confettiContainer');
      const colors = ['#ff9f43','#ffc048','#ff4757','#2ed573','#3b82f6','#a855f7'];
      for (let i = 0; i < 60; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.animationDelay = Math.random() * 1.5 + 's';
        c.style.animationDuration = (2 + Math.random() * 2) + 's';
        c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        c.style.width = (6 + Math.random() * 8) + 'px';
        c.style.height = (6 + Math.random() * 8) + 'px';
        container.appendChild(c);
        setTimeout(() => c.remove(), 4000);
      }
    }

    // ==========================================
    // TOAST
    // ==========================================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
