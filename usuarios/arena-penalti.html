<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arena de P√™naltis - Yellup</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e13">
  <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0a0e13;--bg-card:#131920;--bg-elevated:#1a2230;--accent-primary:#ff9f43;--accent-secondary:#ffc048;--accent-glow:rgba(255,159,67,0.25);--live-red:#ff4757;--win-green:#2ed573;--text-primary:#f1f2f6;--text-secondary:#a4b0be}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Poppins',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;overflow-x:hidden}

    /* SCOREBOARD */
    .scoreboard{background:rgba(10,14,19,0.98);backdrop-filter:blur(20px);padding:12px 16px;position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,159,67,0.1)}
    .scoreboard-inner{max-width:500px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .sb-player{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1;text-align:center}
    .sb-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.9em;color:white;border:3px solid transparent}
    .sb-p1 .sb-avatar{background:linear-gradient(135deg,#3b82f6,#2563eb);border-color:rgba(59,130,246,0.5)}
    .sb-p2 .sb-avatar{background:linear-gradient(135deg,#ef4444,#dc2626);border-color:rgba(239,68,68,0.5)}
    .sb-name{font-size:0.7em;font-weight:600;max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sb-role{font-size:0.6em;padding:2px 8px;border-radius:10px;font-weight:600}
    .sb-role.cobrador{background:rgba(255,159,67,0.2);color:var(--accent-primary)}
    .sb-role.goleiro{background:rgba(59,130,246,0.2);color:#60a5fa}
    .sb-role.hidden{visibility:hidden}
    .sb-center{display:flex;flex-direction:column;align-items:center;gap:2px;padding:0 16px}
    .sb-score{font-size:2em;font-weight:800;letter-spacing:4px;display:flex;align-items:center;gap:8px}
    .sb-score .p1-score{color:#60a5fa}.sb-score .p2-score{color:#f87171}.sb-score .divider{color:var(--text-secondary);font-size:0.7em}
    .sb-round{font-size:0.65em;color:var(--text-secondary);font-weight:600}

    /* PENALTY TRACKER */
    .penalty-tracker{display:flex;justify-content:center;gap:16px;padding:10px 16px;background:var(--bg-card);border-bottom:1px solid rgba(255,255,255,0.05)}
    .tracker-side{display:flex;gap:4px;align-items:center}
    .tracker-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.55em;border:2px solid rgba(255,255,255,0.15);background:rgba(0,0,0,0.3)}
    .tracker-dot.gol{border-color:var(--win-green);background:rgba(46,213,115,0.2)}
    .tracker-dot.defesa{border-color:var(--live-red);background:rgba(255,71,87,0.2)}
    .tracker-dot.current{border-color:var(--accent-primary);animation:dotPulse 1.5s ease-in-out infinite}
    @keyframes dotPulse{0%,100%{box-shadow:0 0 0 rgba(255,159,67,0)}50%{box-shadow:0 0 10px rgba(255,159,67,0.4)}}
    .tracker-label{font-size:0.6em;font-weight:700;color:var(--text-secondary);margin:0 2px}

    /* FIELD */
    .field-area{position:relative;width:100%;max-width:500px;margin:0 auto;padding:30px 20px 20px}

    /* GOAL */
    .goal-container{position:relative;width:100%;aspect-ratio:1.5;max-height:320px;margin:0 auto}
    .goal-frame{position:absolute;top:0;left:5%;right:5%;bottom:10%;border:5px solid #e0e0e0;border-bottom:none;border-radius:4px 4px 0 0;background:repeating-linear-gradient(90deg,transparent,transparent 14px,rgba(255,255,255,0.06) 14px,rgba(255,255,255,0.06) 15px),repeating-linear-gradient(0deg,transparent,transparent 14px,rgba(255,255,255,0.06) 14px,rgba(255,255,255,0.06) 15px);background-color:rgba(0,0,0,0.4);box-shadow:inset 0 0 30px rgba(0,0,0,0.5),0 0 20px rgba(0,0,0,0.3)}
    .goal-frame::before{content:'';position:absolute;bottom:-10px;left:-8px;right:-8px;height:10px;background:linear-gradient(180deg,rgba(0,0,0,0.3),transparent)}
    .grass{position:absolute;bottom:0;left:0;right:0;height:12%;background:linear-gradient(180deg,#1b5e20,#2e7d32);border-radius:0 0 4px 4px}

    /* GRID */
    .goal-grid{position:absolute;top:5px;left:calc(5% + 5px);right:calc(5% + 5px);bottom:calc(10%);display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:3px;z-index:10}
    .goal-zone{border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.75em;font-weight:700;color:transparent;transition:all 0.2s;position:relative;background:rgba(255,255,255,0.02);border:2px solid transparent}
    .goal-zone:hover{background:rgba(255,159,67,0.15);border-color:rgba(255,159,67,0.4);color:var(--accent-primary)}
    .goal-zone:active{transform:scale(0.95)}
    .goal-zone.selected{background:rgba(255,159,67,0.25);border-color:var(--accent-primary);color:var(--accent-primary);box-shadow:0 0 15px var(--accent-glow)}
    .goal-zone.disabled{pointer-events:none;opacity:0.5}
    .goal-zone.result-gol{background:rgba(46,213,115,0.3);border-color:var(--win-green);color:white;font-size:1.2em}
    .goal-zone.result-defesa{background:rgba(255,71,87,0.3);border-color:var(--live-red);color:white;font-size:1.2em}

    /* BALL & GK */
    .ball{position:absolute;font-size:28px;z-index:20;bottom:5%;left:50%;transform:translateX(-50%);display:none}
    .ball.kick{display:block;animation:ballKick 0.6s cubic-bezier(0.25,0.46,0.45,0.94) forwards}
    .goalkeeper{position:absolute;font-size:2.5em;z-index:15;top:45%;left:50%;transform:translate(-50%,-50%);display:none}
    .goalkeeper.dive{display:block;animation:gkDive 0.5s cubic-bezier(0.25,0.46,0.45,0.94) forwards}

    /* CONTROLS */
    .controls-area{max-width:500px;margin:0 auto;padding:20px;text-align:center}
    .instruction{font-size:1.1em;font-weight:700;margin-bottom:16px;padding:14px 20px;border-radius:14px}
    .instruction.kick-mode{background:linear-gradient(135deg,rgba(255,159,67,0.15),rgba(255,159,67,0.05));border:1px solid rgba(255,159,67,0.3);color:var(--accent-primary)}
    .instruction.defend-mode{background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.3);color:#60a5fa}
    .instruction.waiting{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text-secondary)}
    .instruction.result-gol{background:rgba(46,213,115,0.15);border:1px solid rgba(46,213,115,0.3);color:var(--win-green);font-size:1.3em}
    .instruction.result-defesa{background:rgba(255,71,87,0.15);border:1px solid rgba(255,71,87,0.3);color:var(--live-red);font-size:1.3em}
    .instruction.sudden-death{background:rgba(168,85,247,0.15);border:1px solid rgba(168,85,247,0.3);color:#c084fc;font-size:1.1em;animation:sdPulse 1.5s ease-in-out infinite}
    @keyframes sdPulse{0%,100%{box-shadow:0 0 0 rgba(168,85,247,0)}50%{box-shadow:0 0 20px rgba(168,85,247,0.2)}}

    .btn-confirm{padding:16px 40px;background:linear-gradient(135deg,var(--accent-primary),#ff8c42);border:none;border-radius:14px;color:var(--bg-dark);font-family:'Poppins',sans-serif;font-weight:700;font-size:1em;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px var(--accent-glow)}
    .btn-confirm:hover{transform:translateY(-2px)}.btn-confirm:active{transform:scale(0.97)}
    .btn-confirm:disabled{background:rgba(255,255,255,0.1);color:var(--text-secondary);box-shadow:none;cursor:default}

    .waiting-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.2);border-top-color:var(--accent-primary);border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* RESULT OVERLAY */
    .result-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(10px)}
    .result-overlay.active{display:flex}
    .result-card{text-align:center;padding:30px 24px;background:linear-gradient(135deg,#1e2936,#18222e);border-radius:24px;max-width:400px;width:92%;animation:modalPop 0.5s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto}
    .result-card.win{border:2px solid var(--win-green)}.result-card.loss{border:2px solid var(--live-red)}
    @keyframes modalPop{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}
    .result-icon{font-size:4em;margin-bottom:8px}
    .result-title{font-size:1.6em;font-weight:800;margin-bottom:4px}
    .result-score{font-size:1.2em;color:var(--text-secondary);margin-bottom:12px}
    .result-credits{font-size:1.8em;font-weight:800;margin-bottom:16px}
    .result-credits.win{color:var(--win-green)}.result-credits.loss{color:var(--live-red)}

    /* POST-GAME STATS */
    .stats-section{margin:16px 0;text-align:left}
    .stats-title{font-size:0.85em;font-weight:700;color:var(--text-secondary);margin-bottom:10px;text-align:center}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .stat-box{background:rgba(255,255,255,0.05);border-radius:10px;padding:10px;text-align:center}
    .stat-val{font-size:1.3em;font-weight:800}.stat-lbl{font-size:0.65em;color:var(--text-secondary)}
    .stat-val.green{color:var(--win-green)}.stat-val.red{color:var(--live-red)}.stat-val.blue{color:#60a5fa}.stat-val.orange{color:var(--accent-primary)}

    /* HEATMAP */
    .heatmap-section{margin:12px 0}
    .heatmap-row{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
    .heatmap-title{font-size:0.75em;color:var(--text-secondary);text-align:center;margin-bottom:6px}
    .heatmap-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;max-width:180px;margin:0 auto 6px}
    .heatmap-cell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.65em;font-weight:700;color:white;min-height:28px}

    .btn-result{padding:14px 40px;border-radius:14px;border:none;font-family:'Poppins',sans-serif;font-weight:700;font-size:1em;cursor:pointer;transition:all 0.3s;width:100%}
    .btn-result.win{background:linear-gradient(135deg,var(--win-green),#7bed9f);color:var(--bg-dark)}
    .btn-result.loss{background:rgba(255,255,255,0.1);color:var(--text-primary)}

    /* CONFETTI */
    .confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2001}
    .confetti{position:absolute;width:10px;height:10px;top:-10px;animation:confettiFall 3s ease-in forwards}
    @keyframes confettiFall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

    .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:rgba(0,0,0,0.9);color:white;padding:15px 30px;border-radius:50px;font-weight:600;z-index:3000;opacity:0;transition:all 0.3s}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    @media(max-width:380px){.sb-score{font-size:1.5em;letter-spacing:2px}.sb-name{font-size:0.6em;max-width:60px}.goal-container{max-height:260px}}
  </style>
</head>
<body>
  <div class="scoreboard"><div class="scoreboard-inner">
    <div class="sb-player sb-p1">
      <div class="sb-avatar" id="p1Avatar">?</div>
      <div class="sb-name" id="p1Name">Jogador 1</div>
      <span class="sb-role hidden" id="p1Role">‚öΩ Cobrador</span>
    </div>
    <div class="sb-center">
      <div class="sb-score"><span class="p1-score" id="score1">0</span><span class="divider">√ó</span><span class="p2-score" id="score2">0</span></div>
      <div class="sb-round" id="roundInfo">Rodada 1/10</div>
    </div>
    <div class="sb-player sb-p2">
      <div class="sb-avatar" id="p2Avatar">?</div>
      <div class="sb-name" id="p2Name">Jogador 2</div>
      <span class="sb-role hidden" id="p2Role">üß§ Goleiro</span>
    </div>
  </div></div>

  <div class="penalty-tracker">
    <div class="tracker-side" id="trackerP1"></div>
    <span class="tracker-label">P1</span>
    <span style="color:var(--text-secondary);font-size:0.7em;">|</span>
    <span class="tracker-label">P2</span>
    <div class="tracker-side" id="trackerP2"></div>
  </div>

  <div class="field-area">
    <div class="goal-container" id="goalContainer">
      <div class="goal-frame"></div>
      <div class="grass"></div>
      <div class="goal-grid" id="goalGrid">
        <div class="goal-zone" data-zone="TL" onclick="selectZone('TL')">‚Üñ</div>
        <div class="goal-zone" data-zone="TC" onclick="selectZone('TC')">‚¨Ü</div>
        <div class="goal-zone" data-zone="TR" onclick="selectZone('TR')">‚Üó</div>
        <div class="goal-zone" data-zone="ML" onclick="selectZone('ML')">‚¨Ö</div>
        <div class="goal-zone" data-zone="MC" onclick="selectZone('MC')">‚óè</div>
        <div class="goal-zone" data-zone="MR" onclick="selectZone('MR')">‚û°</div>
        <div class="goal-zone" data-zone="BL" onclick="selectZone('BL')">‚Üô</div>
        <div class="goal-zone" data-zone="BC" onclick="selectZone('BC')">‚¨á</div>
        <div class="goal-zone" data-zone="BR" onclick="selectZone('BR')">‚Üò</div>
      </div>
      <div class="ball" id="ball">‚öΩ</div>
      <div class="goalkeeper" id="goalkeeper">üß§</div>
    </div>
  </div>

  <div class="controls-area">
    <div class="instruction waiting" id="instruction">Carregando...</div>
    <button class="btn-confirm" id="btnConfirm" disabled onclick="confirmarEscolha()">Confirmar</button>
  </div>

  <div class="result-overlay" id="resultOverlay">
    <div class="result-card" id="resultCard">
      <div class="result-icon" id="resultIcon">üèÜ</div>
      <div class="result-title" id="resultTitle">Vit√≥ria!</div>
      <div class="result-score" id="resultScore">3 √ó 1</div>
      <div class="result-credits" id="resultCredits">+20 cr√©ditos</div>
      <div id="statsContainer"></div>
      <button class="btn-result" id="btnResult" onclick="window.location.href='penaltis.html'">Voltar ao Lobby</button>
    </div>
  </div>

  <div class="confetti-container" id="confettiContainer"></div>
  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8",measurementId:"G-SYZ16X31KQ"};
    if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore(),auth=firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.error(e));

    const matchId=new URLSearchParams(window.location.search).get('id');
    let currentUser=null,matchData=null,myRole=null,selectedZone=null,isProcessing=false,unsubMatch=null;
    let lastProcessedRound=0; // prevents double-processing

    const ZONE_POS={
      TL:{x:'18%',y:'20%'},TC:{x:'50%',y:'15%'},TR:{x:'82%',y:'20%'},
      ML:{x:'18%',y:'50%'},MC:{x:'50%',y:'50%'},MR:{x:'82%',y:'50%'},
      BL:{x:'18%',y:'75%'},BC:{x:'50%',y:'78%'},BR:{x:'82%',y:'75%'}
    };
    const ZONE_NAMES={TL:'‚Üñ Esq Alto',TC:'‚¨Ü Centro Alto',TR:'‚Üó Dir Alto',ML:'‚¨Ö Esq Meio',MC:'‚óè Centro',MR:'‚û° Dir Meio',BL:'‚Üô Esq Baixo',BC:'‚¨á Centro Baixo',BR:'‚Üò Dir Baixo'};

    auth.onAuthStateChanged(user=>{
      if(!user){window.location.href='index.html';return}
      if(!matchId){window.location.href='penaltis.html';return}
      currentUser=user;
      escutarPartida();
    });

    function escutarPartida(){
      unsubMatch=db.collection('penaltis').doc(matchId).onSnapshot(snap=>{
        if(!snap.exists){showToast('‚ùå Partida n√£o encontrada');setTimeout(()=>window.location.href='penaltis.html',1500);return}
        matchData=snap.data();
        myRole=matchData.jogador1?.uid===currentUser.uid?'jogador1':'jogador2';
        if(matchData.status==='finalizado'){renderFinished();return}
        renderScoreboard();
        renderTracker();
        renderRound();
      });
    }

    function renderScoreboard(){
      const p1=matchData.jogador1,p2=matchData.jogador2,r=matchData.rodadaAtual||1;
      document.getElementById('p1Name').textContent=p1?.nome||'???';
      document.getElementById('p2Name').textContent=p2?.nome||'???';
      document.getElementById('p1Avatar').textContent=(p1?.nome||'?').charAt(0).toUpperCase();
      document.getElementById('p2Avatar').textContent=(p2?.nome||'?').charAt(0).toUpperCase();
      document.getElementById('score1').textContent=matchData.placar?.jogador1||0;
      document.getElementById('score2').textContent=matchData.placar?.jogador2||0;
      const isSuddenDeath=r>10;
      document.getElementById('roundInfo').textContent=isSuddenDeath?`‚ö° Morte S√∫bita R${r-10} ‚Ä¢ üí∞ ${matchData.valorAposta}`:`Rodada ${r}/10 ‚Ä¢ üí∞ ${matchData.valorAposta}`;
      const cob=getCobrador(r);
      const p1R=document.getElementById('p1Role'),p2R=document.getElementById('p2Role');
      if(cob==='jogador1'){p1R.textContent='‚öΩ Cobrador';p1R.className='sb-role cobrador';p2R.textContent='üß§ Goleiro';p2R.className='sb-role goleiro'}
      else{p1R.textContent='üß§ Goleiro';p1R.className='sb-role goleiro';p2R.textContent='‚öΩ Cobrador';p2R.className='sb-role cobrador'}
    }

    function renderTracker(){
      const rds=matchData.rodadas||[],t1=document.getElementById('trackerP1'),t2=document.getElementById('trackerP2');
      let d1='',d2='';
      const maxDots=Math.max(5,Math.ceil(rds.length/2));
      for(let i=0;i<maxDots;i++){
        const ri1=i*2,ri2=i*2+1;
        const r1=rds[ri1],r2=rds[ri2];
        let c1='',i1='',c2='',i2='';
        if(r1){c1=r1.gol?'gol':'defesa';i1=r1.gol?'‚öΩ':'‚ùå'}else if(ri1===(matchData.rodadaAtual||1)-1){c1='current';i1='‚Ä¢'}
        if(r2){c2=r2.gol?'gol':'defesa';i2=r2.gol?'‚öΩ':'‚ùå'}else if(ri2===(matchData.rodadaAtual||1)-1){c2='current';i2='‚Ä¢'}
        d1+=`<div class="tracker-dot ${c1}">${i1}</div>`;
        d2+=`<div class="tracker-dot ${c2}">${i2}</div>`;
      }
      t1.innerHTML=d1;t2.innerHTML=d2;
    }

    function renderRound(){
      if(isProcessing)return;
      const r=matchData.rodadaAtual||1;
      const cob=getCobrador(r);
      const iAmCob=cob===myRole;
      const minha=matchData['escolha'+cap(myRole)];
      const outro=myRole==='jogador1'?'jogador2':'jogador1';
      const outra=matchData['escolha'+cap(outro)];
      const instrEl=document.getElementById('instruction'),btnEl=document.getElementById('btnConfirm');

      resetGoalGrid();selectedZone=null;

      if(minha&&outra&&r>lastProcessedRound){
        // Both chose ‚Äî resolve!
        lastProcessedRound=r;
        resolverRodada(cob);
        return;
      }

      if(minha&&!outra){
        instrEl.className='instruction waiting';
        instrEl.innerHTML=`<span class="waiting-spinner"></span> Aguardando advers√°rio...`;
        btnEl.disabled=true;btnEl.textContent='Aguardando...';
        disableGoalGrid();
      }else if(!minha){
        const isSD=r>10;
        if(isSD){
          instrEl.className='instruction sudden-death';
          instrEl.textContent=iAmCob?'üíÄ MORTE S√öBITA ‚Äî Escolha onde CHUTAR!':'üíÄ MORTE S√öBITA ‚Äî Escolha onde DEFENDER!';
        }else if(iAmCob){
          instrEl.className='instruction kick-mode';
          instrEl.textContent='‚öΩ Escolha onde CHUTAR!';
        }else{
          instrEl.className='instruction defend-mode';
          instrEl.textContent='üß§ Escolha onde DEFENDER!';
        }
        btnEl.disabled=true;btnEl.textContent='Selecione um quadrante';
        enableGoalGrid();
      }
    }

    function getCobrador(r){return r%2===1?'jogador1':'jogador2'}
    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}

    function selectZone(z){
      selectedZone=z;
      document.querySelectorAll('.goal-zone').forEach(el=>el.classList.remove('selected'));
      document.querySelector(`[data-zone="${z}"]`).classList.add('selected');
      document.getElementById('btnConfirm').disabled=false;
      document.getElementById('btnConfirm').textContent='Confirmar! ‚úÖ';
    }
    function enableGoalGrid(){document.querySelectorAll('.goal-zone').forEach(z=>z.classList.remove('disabled'))}
    function disableGoalGrid(){document.querySelectorAll('.goal-zone').forEach(z=>z.classList.add('disabled'))}
    function resetGoalGrid(){document.querySelectorAll('.goal-zone').forEach(z=>{z.classList.remove('selected','disabled','result-gol','result-defesa');z.textContent=z.dataset.zone==='TL'?'‚Üñ':z.dataset.zone==='TC'?'‚¨Ü':z.dataset.zone==='TR'?'‚Üó':z.dataset.zone==='ML'?'‚¨Ö':z.dataset.zone==='MC'?'‚óè':z.dataset.zone==='MR'?'‚û°':z.dataset.zone==='BL'?'‚Üô':z.dataset.zone==='BC'?'‚¨á':'‚Üò'})}

    async function confirmarEscolha(){
      if(!selectedZone)return;
      const btn=document.getElementById('btnConfirm');btn.disabled=true;
      try{
        await db.collection('penaltis').doc(matchId).update({['escolha'+cap(myRole)]:selectedZone});
        disableGoalGrid();
        document.getElementById('instruction').className='instruction waiting';
        document.getElementById('instruction').innerHTML=`<span class="waiting-spinner"></span> Aguardando advers√°rio...`;
        btn.textContent='Aguardando...';
      }catch(e){console.error(e);showToast('‚ùå Erro');btn.disabled=false}
    }

    // === RESOLVE ROUND ===
    async function resolverRodada(cobrador){
      isProcessing=true;disableGoalGrid();
      const minha=matchData['escolha'+cap(myRole)];
      const outro=myRole==='jogador1'?'jogador2':'jogador1';
      const outra=matchData['escolha'+cap(outro)];
      const iAmCob=cobrador===myRole;
      const chute=iAmCob?minha:outra;
      const defesa=iAmCob?outra:minha;
      const isGol=chute!==defesa;

      await animateResult(chute,defesa,isGol);

      const instrEl=document.getElementById('instruction');
      if(isGol){instrEl.className='instruction result-gol';instrEl.textContent='‚öΩ GOOOL!!!'}
      else{instrEl.className='instruction result-defesa';instrEl.textContent='üß§ DEFENDEU!!!'}

      // Only jogador1 writes to avoid race conditions
      if(myRole==='jogador1'){
        // Write IMMEDIATELY (no setTimeout - this was the bug!)
        await processarResultado(chute,defesa,isGol,cobrador);
      }

      // Wait for onSnapshot to trigger next state
      setTimeout(()=>{isProcessing=false},2500);
    }

    function animateResult(chute,defesa,isGol){
      return new Promise(resolve=>{
        const ball=document.getElementById('ball'),gk=document.getElementById('goalkeeper');
        const cp=ZONE_POS[chute],dp=ZONE_POS[defesa];
        let s=document.getElementById('dynamicKF');
        if(!s){s=document.createElement('style');s.id='dynamicKF';document.head.appendChild(s)}
        s.textContent=`@keyframes ballKick{0%{bottom:5%;left:50%;transform:translateX(-50%) scale(1)}100%{bottom:calc(90% - ${cp.y});left:${cp.x};transform:translateX(-50%) scale(0.7)}}@keyframes gkDive{0%{top:45%;left:50%;transform:translate(-50%,-50%) scale(1)}100%{top:${dp.y};left:${dp.x};transform:translate(-50%,-50%) scale(1.2)}}`;
        ball.className='ball';gk.className='goalkeeper';void ball.offsetWidth;
        ball.classList.add('kick');gk.classList.add('dive');
        setTimeout(()=>{
          const cz=document.querySelector(`[data-zone="${chute}"]`),dz=document.querySelector(`[data-zone="${defesa}"]`);
          if(isGol){cz.classList.add('result-gol');cz.textContent='‚öΩ';if(chute!==defesa){dz.classList.add('result-defesa');dz.textContent='üß§'}}
          else{cz.classList.add('result-defesa');cz.textContent='üß§‚öΩ'}
        },500);
        setTimeout(()=>{ball.className='ball';gk.className='goalkeeper';resolve()},2000);
      });
    }

    // === PROCESS RESULT (jogador1 only) ‚Äî FIX: no setTimeout ===
    async function processarResultado(chute,defesa,isGol,cobrador){
      const rodada=matchData.rodadaAtual||1;
      const nova={rodada,cobrador,chute,defesa,gol:isGol};
      const rodadas=[...(matchData.rodadas||[]),nova];
      const placar={...(matchData.placar||{jogador1:0,jogador2:0})};
      if(isGol)placar[cobrador]++;

      let status='em_andamento',vencedor=null;

      if(rodadas.length>=10){
        if(placar.jogador1!==placar.jogador2){
          status='finalizado';
          vencedor=placar.jogador1>placar.jogador2?matchData.jogador1.uid:matchData.jogador2.uid;
        }
        // Equal after 10 = sudden death (continues)
      }

      // Early finish (before round 10)
      if(status==='em_andamento'&&rodadas.length>=6&&rodadas.length<10){
        const remP1=Math.ceil((10-rodadas.length)/2);
        const remP2=Math.floor((10-rodadas.length)/2);
        if(placar.jogador1>placar.jogador2+remP2){status='finalizado';vencedor=matchData.jogador1.uid}
        else if(placar.jogador2>placar.jogador1+remP1){status='finalizado';vencedor=matchData.jogador2.uid}
      }

      // Sudden death: after each PAIR of extra kicks (11+12, 13+14, etc), check
      if(status==='em_andamento'&&rodadas.length>10&&rodadas.length%2===0){
        if(placar.jogador1!==placar.jogador2){
          status='finalizado';
          vencedor=placar.jogador1>placar.jogador2?matchData.jogador1.uid:matchData.jogador2.uid;
        }
      }

      const update={rodadas,placar,rodadaAtual:rodadas.length+1,escolhaJogador1:null,escolhaJogador2:null};

      if(status==='finalizado'){
        update.status='finalizado';update.vencedor=vencedor;
        if(vencedor){
          const premio=matchData.valorAposta*2;
          // Compute stats and save them in the match doc
          const stats=computeStats(rodadas,matchData.jogador1.uid,matchData.jogador2.uid);
          update.stats=stats;
          await db.collection('usuarios').doc(vencedor).update({creditos:firebase.firestore.FieldValue.increment(premio)});
          await db.collection('usuarios').doc(vencedor).collection('extrato').doc().set({tipo:'entrada',valor:premio,descricao:`P√™naltis: vit√≥ria! (+${premio} cr√©ditos)`,data:firebase.firestore.FieldValue.serverTimestamp()});
          // Notify loser
          const perdedor=vencedor===matchData.jogador1.uid?matchData.jogador2.uid:matchData.jogador1.uid;
          const nomeVencedor=vencedor===matchData.jogador1.uid?matchData.jogador1.nome:matchData.jogador2.nome;
          try{
            await db.collection('notificacoes').add({para:perdedor,tipo:'penalti_resultado',titulo:'‚öΩ Resultado P√™naltis',mensagem:`Voc√™ perdeu para ${nomeVencedor} (${placar.jogador1}√ó${placar.jogador2}). -${matchData.valorAposta} cr√©ditos`,lida:false,data:firebase.firestore.FieldValue.serverTimestamp()});
          }catch(e){}
        }
      }

      // WRITE IMMEDIATELY - no delay!
      await db.collection('penaltis').doc(matchId).update(update);
    }

    // === COMPUTE POST-GAME STATS ===
    function computeStats(rodadas,uid1,uid2){
      const s={
        jogador1:{chutes:{},defesas:{},gols:0,defendidos:0,totalChutes:0,totalDefesas:0},
        jogador2:{chutes:{},defesas:{},gols:0,defendidos:0,totalChutes:0,totalDefesas:0}
      };
      rodadas.forEach(r=>{
        const cob=r.cobrador; // jogador1 or jogador2
        const gol=r.gol?'jogador2':'jogador1'; // opposite defends
        const goleiro=cob==='jogador1'?'jogador2':'jogador1';
        // Track kicks
        s[cob].chutes[r.chute]=(s[cob].chutes[r.chute]||0)+1;
        s[cob].totalChutes++;
        if(r.gol)s[cob].gols++;
        // Track saves
        s[goleiro].defesas[r.defesa]=(s[goleiro].defesas[r.defesa]||0)+1;
        s[goleiro].totalDefesas++;
        if(!r.gol)s[goleiro].defendidos++;
      });
      return s;
    }

    // === RENDER FINISHED ===
    function renderFinished(){
      renderScoreboard();renderTracker();
      const win=matchData.vencedor===currentUser.uid;
      const pl=`${matchData.placar?.jogador1||0} √ó ${matchData.placar?.jogador2||0}`;
      const premio=matchData.valorAposta*2;
      const card=document.getElementById('resultCard');
      const icon=document.getElementById('resultIcon'),title=document.getElementById('resultTitle');
      const score=document.getElementById('resultScore'),credits=document.getElementById('resultCredits');
      const btn=document.getElementById('btnResult');

      if(win){
        card.className='result-card win';icon.textContent='üèÜ';
        title.textContent='VIT√ìRIA!';title.style.color='var(--win-green)';
        credits.className='result-credits win';credits.textContent=`+${premio} cr√©ditos üí∞`;
        btn.className='btn-result win';spawnConfetti();
      }else{
        card.className='result-card loss';icon.textContent='üò¢';
        title.textContent='Derrota...';title.style.color='var(--live-red)';
        credits.className='result-credits loss';credits.textContent=`-${matchData.valorAposta} cr√©ditos`;
        btn.className='btn-result loss';
      }
      score.textContent=pl;btn.textContent='Voltar ao Lobby';

      // POST-GAME STATS
      renderPostGameStats();
      document.getElementById('resultOverlay').classList.add('active');
    }

    function renderPostGameStats(){
      const stats=matchData.stats;
      const container=document.getElementById('statsContainer');
      if(!stats){container.innerHTML='';return}

      const myStats=stats[myRole];
      const opRole=myRole==='jogador1'?'jogador2':'jogador1';
      const opStats=stats[opRole];
      const myName=matchData[myRole]?.nome||'Voc√™';
      const opName=matchData[opRole]?.nome||'Advers√°rio';

      // Approval rate
      const myAprov=myStats.totalChutes>0?Math.round((myStats.gols/myStats.totalChutes)*100):0;
      const opAprov=opStats.totalChutes>0?Math.round((opStats.gols/opStats.totalChutes)*100):0;
      const myDefRate=myStats.totalDefesas>0?Math.round((myStats.defendidos/myStats.totalDefesas)*100):0;
      const opDefRate=opStats.totalDefesas>0?Math.round((opStats.defendidos/opStats.totalDefesas)*100):0;

      // Most used kick zone
      const myFavKick=getMostUsed(myStats.chutes);
      const opFavKick=getMostUsed(opStats.chutes);

      let html=`
        <div class="stats-section">
          <div class="stats-title">üìä Suas Estat√≠sticas</div>
          <div class="stats-grid">
            <div class="stat-box"><div class="stat-val green">${myStats.gols}/${myStats.totalChutes}</div><div class="stat-lbl">Gols (${myAprov}%)</div></div>
            <div class="stat-box"><div class="stat-val blue">${myStats.defendidos}/${myStats.totalDefesas}</div><div class="stat-lbl">Defesas (${myDefRate}%)</div></div>
            <div class="stat-box"><div class="stat-val orange">${myFavKick?ZONE_NAMES[myFavKick]||myFavKick:'‚Äî'}</div><div class="stat-lbl">Chute favorito</div></div>
            <div class="stat-box"><div class="stat-val red">${opAprov}%</div><div class="stat-lbl">Aproveit. ${opName}</div></div>
          </div>
        </div>

        <div class="heatmap-section">
          <div class="heatmap-row">
            <div style="flex:1">
              <div class="heatmap-title">üéØ Seus Chutes</div>
              ${renderHeatmap(myStats.chutes,'green')}
            </div>
            <div style="flex:1">
              <div class="heatmap-title">üß§ Suas Defesas</div>
              ${renderHeatmap(myStats.defesas,'blue')}
            </div>
          </div>
          <div class="heatmap-row">
            <div style="flex:1">
              <div class="heatmap-title">üéØ Chutes de ${opName}</div>
              ${renderHeatmap(opStats.chutes,'red')}
            </div>
            <div style="flex:1">
              <div class="heatmap-title">üß§ Defesas de ${opName}</div>
              ${renderHeatmap(opStats.defesas,'red')}
            </div>
          </div>
        </div>
      `;
      container.innerHTML=html;
    }

    function renderHeatmap(data,color){
      const zones=['TL','TC','TR','ML','MC','MR','BL','BC','BR'];
      const max=Math.max(1,...Object.values(data));
      const colors={green:'46,213,115',blue:'59,130,246',red:'255,71,87',orange:'255,159,67'};
      const rgb=colors[color]||colors.green;
      return `<div class="heatmap-grid">${zones.map(z=>{
        const v=data[z]||0;
        const op=v>0?0.2+((v/max)*0.8):0.05;
        return `<div class="heatmap-cell" style="background:rgba(${rgb},${op})">${v||''}</div>`;
      }).join('')}</div>`;
    }

    function getMostUsed(obj){
      let max=0,best=null;
      for(const[k,v]of Object.entries(obj)){if(v>max){max=v;best=k}}
      return best;
    }

    function spawnConfetti(){
      const c=document.getElementById('confettiContainer');
      const cols=['#ff9f43','#ffc048','#ff4757','#2ed573','#3b82f6','#a855f7'];
      for(let i=0;i<60;i++){
        const d=document.createElement('div');d.className='confetti';
        d.style.left=Math.random()*100+'%';d.style.backgroundColor=cols[Math.floor(Math.random()*cols.length)];
        d.style.animationDelay=Math.random()*1.5+'s';d.style.animationDuration=(2+Math.random()*2)+'s';
        d.style.borderRadius=Math.random()>0.5?'50%':'2px';
        d.style.width=(6+Math.random()*8)+'px';d.style.height=(6+Math.random()*8)+'px';
        c.appendChild(d);setTimeout(()=>d.remove(),4000);
      }
    }

    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
