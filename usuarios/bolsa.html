<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bolsa de Times - Yellup Stock</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0e141b;
      --bg-secondary: #1a2332;
      --bg-card: #232d3f;
      --text-primary: #e7eef7;
      --text-secondary: #a9b5c6;
      --accent: #ffb547;
      --accent-dark: #ff8c42;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
    }

    .logo-yellup {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-stock { color: var(--success); font-size: 0.8em; }

    .user-credits {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 181, 71, 0.1);
      border: 1px solid rgba(255, 181, 71, 0.3);
      border-radius: 10px;
    }

    .credits-value { font-weight: 700; color: var(--accent); }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-value.green { color: var(--success); }
    .stat-value.red { color: var(--danger); }

    .stat-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .tab-btn:hover { border-color: rgba(255, 181, 71, 0.5); }

    .tab-btn.active {
      border-color: var(--accent);
      background: rgba(255, 181, 71, 0.1);
      color: var(--accent);
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      padding: 14px 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Table */
    .table-container {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      overflow: hidden;
    }

    .stock-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stock-table th {
      background: rgba(255, 181, 71, 0.1);
      padding: 15px 10px;
      text-align: left;
      font-weight: 600;
      color: var(--accent);
      font-size: 0.8em;
      text-transform: uppercase;
    }

    .stock-table th.sortable {
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .stock-table th.sortable:hover {
      background: rgba(255, 181, 71, 0.2);
    }

    .stock-table th.sortable .sort-icon {
      font-size: 0.75em;
      opacity: 0.5;
      margin-left: 4px;
    }

    .stock-table th.sortable.active .sort-icon {
      opacity: 1;
      color: #10b981;
    }

    .stock-table td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9em;
    }

    .stock-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
    }

    /* Team cell */
    .team-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .team-jersey { width: 35px; height: 40px; flex-shrink: 0; }
    .team-jersey svg { width: 100%; height: 100%; }

    .team-name { font-weight: 600; }
    .team-country { font-size: 0.75em; color: var(--text-secondary); }

    /* Price cells */
    .price-algo { font-weight: 700; color: var(--info); }
    .price-market { font-weight: 600; }

    /* Variation */
    .variation { font-weight: 600; display: flex; align-items: center; gap: 3px; }
    .variation.positive { color: var(--success); }
    .variation.negative { color: var(--danger); }
    .variation.neutral { color: var(--text-secondary); }

    /* Dividend */
    .dividend { color: var(--success); font-weight: 600; }

    /* Actions */
    .actions-cell { display: flex; gap: 6px; }

    .btn-buy, .btn-sell {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-buy {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
    }

    .btn-sell {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
    }

    .btn-buy:hover, .btn-sell:hover { transform: scale(1.05); }

    /* Portfolio Grid */
    .section-title {
      font-size: 1.2em;
      font-weight: 700;
      margin: 30px 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .portfolio-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .portfolio-card:hover {
      border-color: rgba(255, 181, 71, 0.4);
      transform: translateY(-3px);
    }

    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .portfolio-team {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .shares-count {
      font-size: 1.5em;
      font-weight: 800;
      color: var(--accent);
    }

    .shares-label {
      font-size: 0.7em;
      color: var(--text-secondary);
    }

    .portfolio-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .portfolio-stat { text-align: center; }
    .portfolio-stat-value { font-weight: 700; }
    .portfolio-stat-label { font-size: 0.7em; color: var(--text-secondary); }

    /* Orders */
    .orders-list { display: flex; flex-direction: column; gap: 10px; }

    .order-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-card.venda { border-left: 4px solid var(--danger); }
    .order-card.compra { border-left: 4px solid var(--success); }

    .order-type {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
    }

    .order-type.venda { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .order-type.compra { background: rgba(16, 185, 129, 0.2); color: var(--success); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon { font-size: 4em; margin-bottom: 15px; }
    .empty-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title { font-size: 1.2em; font-weight: 700; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5em;
      cursor: pointer;
    }

    .modal-body { padding: 20px; }

    /* Modal Team Info */
    .modal-team-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .modal-team-info .team-jersey { width: 50px; height: 55px; }
    .modal-team-info .team-jersey svg { width: 100%; height: 100%; }

    /* Price Comparison Box */
    .price-comparison {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .price-row:last-child { border-bottom: none; }

    .price-label { color: var(--text-secondary); font-size: 0.9em; }
    .price-value { font-weight: 700; }
    .price-value.algo { color: var(--info); }
    .price-value.market { color: var(--accent); }

    /* Deal Indicator */
    .deal-indicator {
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .deal-indicator.good {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .deal-indicator.neutral {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }

    .deal-indicator.expensive {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }

    /* Form */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .form-input:focus { outline: none; border-color: var(--accent); }

    /* Order Summary */
    .order-summary {
      background: rgba(255, 181, 71, 0.1);
      border: 1px solid rgba(255, 181, 71, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }

    .summary-row.total {
      border-top: 1px solid rgba(255, 181, 71, 0.3);
      margin-top: 10px;
      padding-top: 15px;
      font-weight: 700;
      font-size: 1.1em;
    }

    .summary-value { color: var(--accent); }

    /* Modal Actions */
    .modal-actions { display: flex; gap: 10px; }

    .btn-confirm {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-confirm.buy { background: linear-gradient(135deg, var(--success), #059669); color: white; }
    .btn-confirm.sell { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
    .btn-confirm:hover { transform: translateY(-2px); }

    .btn-cancel {
      flex: 1;
      padding: 14px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 30px;
      border-radius: 12px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Loading */
    .loading { display: flex; justify-content: center; padding: 40px; }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 181, 71, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Bot√£o Cancelar Ordem */
    .btn-cancel-order {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      color: #ef4444;
      font-weight: 600;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }
    .btn-cancel-order:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: #ef4444;
    }

    /* Bot√£o desabilitado */
    .btn-buy:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #6b7280;
    }
    .btn-buy:disabled:hover {
      background: #6b7280;
      transform: none;
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .filter-toggle {
      display: flex;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .filter-toggle button {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-family: 'Poppins', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-toggle button.active {
      background: var(--accent);
      color: #111;
      font-weight: 600;
    }

    .filter-select {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #1a1a2e;
      color: #ffffff;
      color-scheme: dark;
      font-family: 'Poppins', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      min-width: 160px;
    }

    .filter-select option {
      background-color: #1a1a2e !important;
      color: #ffffff !important;
      font-weight: 500;
      padding: 8px;
      font-size: 0.9rem;
    }

    .filter-select option:checked {
      background-color: #f59e0b !important;
      color: #000 !important;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .filter-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-left: auto;
    }

    /* Ranking Podium */
    .podium-container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 10px;
      margin-bottom: 25px;
      padding: 0 20px;
    }

    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      flex: 1;
      max-width: 180px;
    }

    .podium-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .podium-name {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 2px;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .podium-value {
      font-size: 0.8rem;
      color: var(--success);
      font-weight: 600;
    }

    .podium-bar {
      width: 100%;
      border-radius: 10px 10px 0 0;
      margin-top: 8px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 8px;
    }

    .podium-item:nth-child(1) .podium-bar { background: linear-gradient(to top, #c0c0c0, #e8e8e8); height: 80px; }
    .podium-item:nth-child(2) .podium-bar { background: linear-gradient(to top, #ffd700, #ffec80); height: 100px; }
    .podium-item:nth-child(3) .podium-bar { background: linear-gradient(to top, #cd7f32, #e8a860); height: 60px; }

    .podium-medal { font-size: 1.5rem; }

    /* Responsive */
    @media (max-width: 768px) {
      .stock-table th:nth-child(4),
      .stock-table td:nth-child(4),
      .stock-table th:nth-child(5),
      .stock-table td:nth-child(5) {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="painel.html" class="btn-back">‚Üê Voltar</a>
        <div class="logo">
          <span class="logo-yellup">Yellup</span>
          <span class="logo-stock">STOCK</span>
        </div>
      </div>
      <div class="user-credits">
        <span>üí∞</span>
        <span class="credits-value" id="userCredits">0</span>
        <span>cr√©ditos</span>
      </div>
    </div>
  </header>

  <!-- Container -->
  <div class="container">
    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value" id="totalTimes">0</div>
        <div class="stat-label">Times Listados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="volumeTotal">0</div>
        <div class="stat-label">Volume 24h</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="minhasCotas">0</div>
        <div class="stat-label">Minhas Cotas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="valorCarteira">0</div>
        <div class="stat-label">Valor Carteira</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="dividendosRecebidos">0</div>
        <div class="stat-label">Dividendos Recebidos</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('mercado')">üìä Mercado</button>
      <button class="tab-btn" onclick="showTab('carteira')">üíº Minha Carteira</button>
      <button class="tab-btn" onclick="showTab('ordens')">üìã Minhas Ordens</button>
      <button class="tab-btn" onclick="showTab('historico')">üìú Hist√≥rico</button>
      <button class="tab-btn" onclick="showTab('ranking')">üèÜ Ranking</button>
    </div>

    <!-- Tab: Mercado -->
    <div id="tab-mercado" class="tab-content">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="üîç Buscar time..." oninput="filterTimes()">
      </div>
      <div class="filters-bar">
        <div class="filter-toggle" id="tipoToggle">
          <button class="active" onclick="filtrarTipo('todos')">Todos</button>
          <button onclick="filtrarTipo('clube')">üèüÔ∏è Clubes</button>
          <button onclick="filtrarTipo('selecao')">üè≥Ô∏è Sele√ß√µes</button>
        </div>
        <select class="filter-select" id="paisFilter" onchange="filtrarPais()">
          <option value="">üåç Todos os pa√≠ses</option>
        </select>
        <span class="filter-count" id="filterCount"></span>
      </div>

      <div class="table-container">
        <table class="stock-table">
          <thead>
            <tr>
              <th class="sortable" onclick="ordenarTabela('nome')" title="Clique para ordenar">Time <span id="sort-icon-nome" class="sort-icon">‚áÖ</span></th>
              <th class="sortable" onclick="ordenarTabela('preco')" title="Clique para ordenar">Pre√ßo Mercado <span id="sort-icon-preco" class="sort-icon">‚áÖ</span></th>
              <th class="sortable" onclick="ordenarTabela('variacao')" title="Clique para ordenar">Varia√ß√£o <span id="sort-icon-variacao" class="sort-icon">‚áÖ</span></th>
              <th class="sortable" onclick="ordenarTabela('dividendos')" title="Clique para ordenar">M√©d. Dividendos <span id="sort-icon-dividendos" class="sort-icon">‚áÖ</span></th>
              <th class="sortable" onclick="ordenarTabela('aVenda')" title="Clique para ordenar">√Ä Venda <span id="sort-icon-aVenda" class="sort-icon">‚áÖ</span></th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="stockTableBody">
            <tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>
          </tbody>
        </table>
        <div id="expandirContainer" style="display: none; text-align: center; padding: 15px;">
          <button id="btnExpandir" onclick="expandirTabela()" style="padding: 10px 25px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: #111; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
            üìã Ver todos os times (<span id="totalRestantes">0</span> restantes)
          </button>
        </div>
      </div>
    </div>

    <!-- Tab: Carteira -->
    <div id="tab-carteira" class="tab-content" style="display: none;">
      <h3 class="section-title">üíº Minhas Cotas</h3>
      <div class="search-box">
        <input type="text" class="search-input" id="carteiraSearchInput" placeholder="üîç Buscar time na carteira..." oninput="filterCarteira()">
      </div>
      <div class="portfolio-grid" id="portfolioGrid">
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <div class="empty-title">Nenhuma cota ainda</div>
          <p>Compre cotas de times e comece a receber dividendos!</p>
        </div>
      </div>
    </div>

    <!-- Tab: Ordens -->
    <div id="tab-ordens" class="tab-content" style="display: none;">
      <h3 class="section-title">üìã Minhas Ordens Abertas</h3>
      <div class="orders-list" id="ordersList">
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <div class="empty-title">Nenhuma ordem aberta</div>
        </div>
      </div>
    </div>

    <!-- Tab: Hist√≥rico -->
    <div id="tab-historico" class="tab-content" style="display: none;">
      <h3 class="section-title">üìú Hist√≥rico de Transa√ß√µes</h3>
      <div class="orders-list" id="historicoList">
        <div class="empty-state">
          <div class="empty-icon">üìú</div>
          <div class="empty-title">Nenhuma transa√ß√£o ainda</div>
        </div>
      </div>
    </div>

    <!-- Tab: Ranking -->
    <div id="tab-ranking" class="tab-content" style="display: none;">
      <h3 class="section-title">üèÜ Ranking de Investidores</h3>
      
      <!-- Podium top 3 -->
      <div id="podiumContainer" class="podium-container" style="display: none;">
        <div class="podium-item" id="podium2"></div>
        <div class="podium-item" id="podium1"></div>
        <div class="podium-item" id="podium3"></div>
      </div>

      <!-- Stats resumo -->
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <span class="stat-value" id="totalInvestidores">0</span>
            <span class="stat-label">Investidores Ativos</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üé´</div>
          <div class="stat-content">
            <span class="stat-value" id="totalCotasNegociadas">0</span>
            <span class="stat-label">Cotas Negociadas</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üíé</div>
          <div class="stat-content">
            <span class="stat-value" id="maiorPatrimonio">0</span>
            <span class="stat-label">Maior Patrim√¥nio</span>
          </div>
        </div>
      </div>

      <!-- Ordena√ß√£o -->
      <div class="filters-bar" style="margin-bottom: 10px;">
        <div class="filter-toggle" id="rankingSortToggle">
          <button class="active" onclick="ordenarRanking('patrimonio')">üí∞ Patrim√¥nio</button>
          <button onclick="ordenarRanking('cotas')">üé´ Cotas</button>
          <button onclick="ordenarRanking('times')">‚öΩ Times</button>
          <button onclick="ordenarRanking('diversificacao')">üìä Diversifica√ß√£o</button>
        </div>
      </div>

      <div class="table-container">
        <table class="stock-table">
          <thead>
            <tr>
              <th>üèÖ</th>
              <th>Investidor</th>
              <th>Cotas</th>
              <th>Times</th>
              <th>Patrim√¥nio Est.</th>
            </tr>
          </thead>
          <tbody id="rankingTableBody">
            <tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr>
          </tbody>
        </table>
        <div id="rankingExpandir" style="display: none; text-align: center; padding: 15px;">
          <button onclick="expandirRanking()" style="padding: 10px 25px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: #111; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.9rem;">
            üìã Ver mais investidores (<span id="rankingRestantes">0</span> restantes)
          </button>
        </div>
      </div>
    </div>


  </div>

  <!-- Modal Book de Ofertas -->
  <div class="modal-overlay" id="modalBook">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">üìñ Book de Ofertas - <span id="bookTimeNome">Time</span></h2>
        <button class="modal-close" onclick="fecharModal('modalBook')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <!-- Vendas -->
          <div>
            <h4 style="color: var(--danger); margin-bottom: 10px;">üì§ Ordens de Venda</h4>
            <div id="bookVendas" style="max-height: 300px; overflow-y: auto;">
              <div class="empty-state" style="padding: 20px;">Nenhuma ordem</div>
            </div>
          </div>
          <!-- Info -->
          <div>
            <h4 style="color: var(--info); margin-bottom: 10px;">üìä Resumo</h4>
            <div class="price-comparison" style="margin: 0;">
              <div class="price-row">
                <span class="price-label">Total √† venda</span>
                <span class="price-value" id="bookTotalVenda">0 cotas</span>
              </div>
              <div class="price-row">
                <span class="price-label">Menor pre√ßo</span>
                <span class="price-value" style="color: var(--success);" id="bookMenorPreco">0 cr</span>
              </div>
              <div class="price-row">
                <span class="price-label">Maior pre√ßo</span>
                <span class="price-value" style="color: var(--danger);" id="bookMaiorPreco">0 cr</span>
              </div>
              <div class="price-row">
                <span class="price-label">Vendedores</span>
                <span class="price-value" id="bookVendedores">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Comprar -->
  <div class="modal-overlay" id="modalComprar">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üõí Comprar Cotas</h2>
        <button class="modal-close" onclick="fecharModal('modalComprar')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-team-info">
          <div class="team-jersey" id="modalComprarJersey"></div>
          <div>
            <h3 id="modalComprarTime">Time</h3>
            <span style="color: var(--text-secondary);" id="modalComprarPais">Pa√≠s</span>
          </div>
        </div>

        <!-- Comparativo de Pre√ßos -->
        <div class="price-comparison">
          <div class="price-row">
            <span class="price-label">üí° Pre√ßo Algoritmo (justo)</span>
            <span class="price-value algo" id="modalPrecoAlgo">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üè∑Ô∏è Menor Pre√ßo √† Venda</span>
            <span class="price-value market" id="modalPrecoVenda">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìä Diferen√ßa</span>
            <span class="price-value" id="modalDiferenca">0%</span>
          </div>
          <div class="price-row">
            <span class="price-label">üí∞ M√©dia Dividendos/Jogo</span>
            <span class="price-value" style="color: var(--success);" id="modalDividendos">0.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìà Jogos p/ Retorno</span>
            <span class="price-value" id="modalRetorno">- jogos</span>
          </div>
        </div>

        <!-- Indicador de Neg√≥cio -->
        <div class="deal-indicator good" id="dealIndicator">
          üü¢ Bom neg√≥cio! Pre√ßo igual ou abaixo do algoritmo
        </div>

        <!-- Lista de Ordens Dispon√≠veis -->
        <div id="listaOrdensDisponiveis" style="margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 120px; overflow-y: auto;">
          <small style="color: var(--text-secondary);">üìã Ordens dispon√≠veis:</small>
          <div id="ordensListaCompra" style="margin-top: 8px;"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade de cotas</label>
          <input type="number" class="form-input" id="inputQtdCompra" min="1" value="1" oninput="calcularTotalCompra()">
          <small style="color: var(--text-secondary);">Dispon√≠veis: <span id="cotasDisponiveis">0</span></small>
        </div>

        <div class="order-summary">
          <div class="summary-row">
            <span>Quantidade</span>
            <span class="summary-value" id="summaryQtdCompra">1 cotas</span>
          </div>
          <div class="summary-row">
            <span>Pre√ßo unit√°rio</span>
            <span class="summary-value" id="summaryPrecoCompra">1.00 cr</span>
          </div>
          <div class="summary-row total">
            <span>Total a pagar</span>
            <span class="summary-value" id="summaryTotalCompra">1.00 cr</span>
          </div>
          <div id="summaryDetalhes" style="text-align: center; margin-top: 5px;"></div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="fecharModal('modalComprar')">Cancelar</button>
          <button class="btn-confirm buy" onclick="confirmarCompra()">‚úÖ Confirmar Compra</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Vender -->
  <div class="modal-overlay" id="modalVender">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üì§ Vender Cotas</h2>
        <button class="modal-close" onclick="fecharModal('modalVender')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-team-info">
          <div class="team-jersey" id="modalVenderJersey"></div>
          <div>
            <h3 id="modalVenderTime">Time</h3>
            <span style="color: var(--text-secondary);">Suas cotas: <strong id="modalMinhasCotas">0</strong></span>
          </div>
        </div>

        <!-- Comparativo de Pre√ßos -->
        <div class="price-comparison">
          <div class="price-row">
            <span class="price-label">üí° Pre√ßo Algoritmo (justo)</span>
            <span class="price-value algo" id="modalVenderPrecoAlgo">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìä M√©dia √öltimas Vendas</span>
            <span class="price-value" id="modalMediaVendas">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üí∞ M√©dia Dividendos/Jogo</span>
            <span class="price-value" style="color: var(--success);" id="modalVenderDividendos">0.00 cr</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade de cotas para vender</label>
          <input type="number" class="form-input" id="inputQtdVenda" min="1" value="1" oninput="calcularTotalVenda()">
        </div>

        <div class="form-group">
          <label class="form-label">Pre√ßo por cota (cr√©ditos)</label>
          <input type="number" class="form-input" id="inputPrecoVenda" min="1" step="1" value="500" oninput="calcularTotalVenda()">
          <small style="color: var(--text-secondary);">Sugest√£o: entre <span id="sugestaoMin">0.90</span> e <span id="sugestaoMax">1.10</span> cr</small>
        </div>

        <div class="order-summary">
          <div class="summary-row">
            <span>Quantidade</span>
            <span class="summary-value" id="summaryQtdVenda">1 cotas</span>
          </div>
          <div class="summary-row">
            <span>Pre√ßo unit√°rio</span>
            <span class="summary-value" id="summaryPrecoVenda">1.00 cr</span>
          </div>
          <div class="summary-row total">
            <span>Total a receber</span>
            <span class="summary-value" id="summaryTotalVenda">1.00 cr</span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="fecharModal('modalVender')">Cancelar</button>
          <button class="btn-confirm sell" onclick="confirmarVenda()">üì§ Criar Ordem de Venda</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <script>
    // ==================== CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions(); // ‚úÖ NOVO: Para transa√ß√µes seguras da Bolsa

    // ==================== CONSTANTES ====================
    const DONO_INICIAL_ID = 'GfpBgfT9e8g5GaTQruvX6YcwtE23';
    const COTAS_POR_TIME = 1000;
    const PRECO_INICIAL = 500.00;

    // Pesos de valoriza√ß√£o/desvaloriza√ß√£o
    const CONFIG_VALORIZACAO = {
      porJogo: 0.25,             // +0.25% por jogo participado
      porTorcedor: 0.05,         // +0.05% por torcedor
      porVitoriaTorcida: 0.5,    // +0.5% maior torcida
      porPonto: 0.005,           // +0.005% por ponto
      porVitoriaPontuacao: 0.9,  // +0.9% maior pontua√ß√£o
      maxVariacao: 12,           // ¬±12% m√°ximo
      
      porDerrotaTorcida: 0.3,    // -0.3% menor torcida
      porDerrotaPontuacao: 0.5,  // -0.5% menor pontua√ß√£o
      
      pesoAjusteMercado: 0.5,    // 50% da diferen√ßa
      maxAjusteMercado: 5        // ¬±5% m√°ximo ajuste mercado
    };

    // ==================== VARI√ÅVEIS GLOBAIS ====================
    let currentUser = null;
    let currentUserData = null;
    let allTimes = [];
    let metricas = {};      // M√©tricas por time
    let minhasCotas = {};   // Minhas cotas
    let ordensAbertas = []; // Minhas ordens
    let ordens = {};        // Ordens por time (para compra)
    let dividendosRecebidos = 0; // Total de dividendos recebidos

    let modalTimeAtual = null;

    // ==================== AUTH ====================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await carregarDadosUsuario();
        await carregarBolsa();
      } else {
        window.location.href = 'index.html';
      }
    });

    async function carregarDadosUsuario() {
      const doc = await db.collection('usuarios').doc(currentUser.uid).get();
      if (doc.exists) {
        currentUserData = doc.data();
        document.getElementById('userCredits').textContent = (currentUserData.creditos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
      }
    }

    // ==================== CARREGAR BOLSA ====================
    async function carregarBolsa() {
      try {
        // Carregar times
        const timesSnap = await db.collection('times').orderBy('nome').get();
        allTimes = [];
        timesSnap.forEach(doc => allTimes.push({ id: doc.id, ...doc.data() }));
        document.getElementById('totalTimes').textContent = allTimes.length;

        // Carregar m√©tricas
        await carregarMetricas();

        // Carregar minhas cotas
        await carregarMinhasCotas();

        // Carregar ordens abertas (para book de ofertas)
        await carregarOrdensAbertas();

        // Carregar minhas ordens
        await carregarMinhasOrdens();

        // Carregar dividendos recebidos
        await carregarDividendosRecebidos();

        // ‚úÖ AUTO-PROCESSAR jogos finalizados pendentes (silencioso)
        await autoProcessarJogosPendentes();

        // Renderizar
        popularPaises();
        renderizarTabelaMercado();

      } catch (error) {
        console.error('Erro ao carregar bolsa:', error);
        showToast('‚ùå Erro ao carregar dados');
      }
    }

    async function carregarMetricas() {
      const metricasSnap = await db.collection('bolsa_metricas_time').get();
      metricas = {};
      metricasSnap.forEach(doc => {
        metricas[doc.id] = doc.data();
      });

      // Para times sem m√©tricas, usar valores iniciais
      allTimes.forEach(time => {
        if (!metricas[time.id]) {
          metricas[time.id] = {
            precoAlgoritmo: PRECO_INICIAL,
            precoMercado: PRECO_INICIAL,
            mediaDividendos: 0,
            totalJogos: 0,
            totalTorcedores: 0,
            variacaoDia: 0
          };
        }
      });
    }

    async function carregarMinhasCotas() {
      const cotasSnap = await db.collection('bolsa_cotas')
        .where('userId', '==', currentUser.uid)
        .get();

      minhasCotas = {};
      let totalCotas = 0;
      let valorTotal = 0;

      cotasSnap.forEach(doc => {
        const data = doc.data();
        minhasCotas[data.timeId] = { id: doc.id, ...data };
        totalCotas += data.quantidade;
        const preco = metricas[data.timeId]?.precoAlgoritmo || PRECO_INICIAL;
        valorTotal += data.quantidade * preco;
      });

      document.getElementById('minhasCotas').textContent = totalCotas.toLocaleString('pt-BR');
      document.getElementById('valorCarteira').textContent = valorTotal.toFixed(2);
    }

    async function carregarOrdensAbertas() {
      // CORRE√á√ÉO: Query simplificada para evitar erro de √≠ndice composto
      // Busca todas as ordens de venda e filtra no JavaScript
      try {
        const ordensSnap = await db.collection('bolsa_ordens')
          .where('tipo', '==', 'venda')
          .get();

        ordens = {};
        ordensSnap.forEach(doc => {
          const data = doc.data();
          // Filtrar apenas ordens abertas ou parciais
          if (data.status === 'aberta' || data.status === 'parcial') {
            if (!ordens[data.timeId]) {
              ordens[data.timeId] = [];
            }
            ordens[data.timeId].push({ id: doc.id, ...data });
          }
        });

        // Ordenar por pre√ßo (menor primeiro)
        Object.keys(ordens).forEach(timeId => {
          ordens[timeId].sort((a, b) => a.precoUnitario - b.precoUnitario);
        });
        
        console.log('Ordens carregadas:', Object.keys(ordens).length, 'times com ordens');
      } catch (error) {
        console.error('Erro ao carregar ordens:', error);
        ordens = {};
      }
    }

    async function carregarMinhasOrdens() {
      // CORRE√á√ÉO: Query simplificada para evitar erro de √≠ndice composto
      try {
        const ordensSnap = await db.collection('bolsa_ordens')
          .where('userId', '==', currentUser.uid)
          .get();

        ordensAbertas = [];
        ordensSnap.forEach(doc => {
          const data = doc.data();
          // Filtrar apenas ordens abertas ou parciais
          if (data.status === 'aberta' || data.status === 'parcial') {
            ordensAbertas.push({ id: doc.id, ...data });
          }
        });
      } catch (error) {
        console.error('Erro ao carregar minhas ordens:', error);
        ordensAbertas = [];
      }
    }

    // Fun√ß√£o para carregar dividendos recebidos
    // ‚úÖ CORRIGIDO: Busca de distribuicao_cotistas_jogo (dados salvos pelo painel-jogo)
    async function carregarDividendosRecebidos() {
      try {
        // Buscar todos os registros de distribui√ß√£o de cotistas
        const distSnap = await db.collection('distribuicao_cotistas_jogo').get();
        dividendosRecebidos = 0;
        
        distSnap.forEach(doc => {
          const dist = doc.data();
          // Verificar se tem cotistas premiados
          if (dist.cotistasPremiados && Array.isArray(dist.cotistasPremiados)) {
            dist.cotistasPremiados.forEach(cotista => {
              // Verificar se o cotista √© o usu√°rio atual
              if (cotista.odId === currentUser.uid) {
                dividendosRecebidos += cotista.creditos || 0;
              }
            });
          }
        });
        
        document.getElementById('dividendosRecebidos').textContent = dividendosRecebidos.toLocaleString('pt-BR', {minimumFractionDigits: 2});
        console.log(`üí∞ Dividendos recebidos: ${dividendosRecebidos} cr`);
      } catch (error) {
        console.error('Erro ao carregar dividendos:', error);
      }
    }

    // ==================== RENDERIZAR ====================
    // ==================== ORDENA√á√ÉO, FILTROS E PAGINA√á√ÉO ====================
    let sortColumn = 'variacao';
    let sortDirection = 'desc';
    let tabelaExpandida = false;
    let filtroTipo = 'todos';
    let filtroPais = '';
    const LIMITE_INICIAL = 30;

    function filtrarTipo(tipo) {
      filtroTipo = tipo;
      document.querySelectorAll('#tipoToggle button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      tabelaExpandida = false;
      popularPaises(); // atualizar pa√≠ses dispon√≠veis
      renderizarTabelaMercado();
    }

    function filtrarPais() {
      filtroPais = document.getElementById('paisFilter').value;
      tabelaExpandida = false;
      renderizarTabelaMercado();
    }

    function popularPaises() {
      const select = document.getElementById('paisFilter');
      const paisAtual = select.value;
      
      // Pegar pa√≠ses dos times vis√≠veis pelo filtro de tipo
      const timesFiltrados = filtroTipo === 'todos' ? allTimes : allTimes.filter(t => t.tipo === filtroTipo);
      const paisesSet = new Map();
      timesFiltrados.forEach(t => {
        if (t.pais) paisesSet.set(t.pais, (paisesSet.get(t.pais) || 0) + 1);
      });
      
      const paisesOrdenados = [...paisesSet.entries()].sort((a, b) => b[1] - a[1]);
      
      let html = '<option value="" style="color:#fff;">üåç Todos os pa√≠ses</option>';
      paisesOrdenados.forEach(([pais, count]) => {
        html += `<option value="${pais}" style="color:#fff;" ${pais === paisAtual ? 'selected' : ''}>${pais} (${count})</option>`;
      });
      select.innerHTML = html;
    }

    function ordenarTabela(coluna) {
      if (sortColumn === coluna) {
        sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      } else {
        sortColumn = coluna;
        sortDirection = (coluna === 'nome') ? 'asc' : 'desc';
      }
      renderizarTabelaMercado();
    }

    function expandirTabela() {
      tabelaExpandida = true;
      renderizarTabelaMercado();
    }

    function renderizarTabelaMercado() {
      const tbody = document.getElementById('stockTableBody');
      
      if (allTimes.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Nenhum time encontrado</div></div></td></tr>`;
        document.getElementById('expandirContainer').style.display = 'none';
        return;
      }

      // Aplicar filtros de tipo e pa√≠s
      let timesFiltrados = allTimes;
      if (filtroTipo !== 'todos') {
        timesFiltrados = timesFiltrados.filter(t => t.tipo === filtroTipo);
      }
      if (filtroPais) {
        timesFiltrados = timesFiltrados.filter(t => t.pais === filtroPais);
      }

      if (timesFiltrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">Nenhum time encontrado com esses filtros</div></div></td></tr>`;
        document.getElementById('expandirContainer').style.display = 'none';
        document.getElementById('filterCount').textContent = '0 times';
        return;
      }

      // Preparar dados com m√©tricas
      let timesComDados = timesFiltrados.map(time => {
        const m = metricas[time.id] || {};
        const precoMercado = m.precoMercado || PRECO_INICIAL;
        const variacao = m.variacaoDia || 0;
        const dividendos = m.mediaDividendos || 0;

        const todasOrdensTime = ordens[time.id] || [];
        const ordensOutros = todasOrdensTime.filter(o => o.userId !== currentUser.uid);
        const menorPrecoVenda = ordensOutros.length > 0 ? ordensOutros[0].precoUnitario : (m.precoAlgoritmo || PRECO_INICIAL);
        const cotasDisponiveis = ordensOutros.reduce((sum, o) => sum + o.quantidadeRestante, 0);

        const minhaCota = minhasCotas[time.id];
        const minhasQtd = minhaCota ? minhaCota.quantidade : 0;
        const possuiTodas = minhasQtd >= COTAS_POR_TIME;

        // √Ä Venda: se possui todas mostra as suas, sen√£o mostra dispon√≠veis de outros
        const qtdAVenda = possuiTodas ? minhasQtd : cotasDisponiveis;

        return {
          time,
          precoAlgo: m.precoAlgoritmo || PRECO_INICIAL,
          precoMercado,
          variacao,
          dividendos,
          cotasDisponiveis,
          menorPrecoVenda,
          possuiTodas,
          minhasQtd,
          qtdAVenda,
          temVariacao: variacao !== 0
        };
      });

      // Ordenar: primeiro por varia√ß√£o (quem tem varia√ß√£o vem antes), depois pela coluna selecionada
      timesComDados.sort((a, b) => {
        // Sempre priorizar quem tem varia√ß√£o sobre quem n√£o tem (a n√£o ser que esteja ordenando por nome)
        if (sortColumn !== 'nome') {
          if (a.temVariacao && !b.temVariacao) return -1;
          if (!a.temVariacao && b.temVariacao) return 1;
        }

        let valA, valB;
        switch (sortColumn) {
          case 'nome':
            valA = a.time.nome.toLowerCase();
            valB = b.time.nome.toLowerCase();
            return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'preco':
            valA = a.precoMercado;
            valB = b.precoMercado;
            break;
          case 'variacao':
            valA = Math.abs(a.variacao);
            valB = Math.abs(b.variacao);
            break;
          case 'dividendos':
            valA = a.dividendos;
            valB = b.dividendos;
            break;
          case 'aVenda':
            valA = a.qtdAVenda;
            valB = b.qtdAVenda;
            break;
          default:
            valA = Math.abs(a.variacao);
            valB = Math.abs(b.variacao);
        }
        return sortDirection === 'desc' ? valB - valA : valA - valB;
      });

      // Limitar quantidade exibida
      const totalTimes = timesComDados.length;
      const timesExibir = (tabelaExpandida || buscaAtiva) ? timesComDados : timesComDados.slice(0, LIMITE_INICIAL);
      const restantes = totalTimes - LIMITE_INICIAL;

      // Atualizar √≠cones de ordena√ß√£o
      document.querySelectorAll('.stock-table th.sortable').forEach(th => th.classList.remove('active'));
      const activeIcon = document.getElementById(`sort-icon-${sortColumn}`);
      if (activeIcon) {
        activeIcon.parentElement.classList.add('active');
        activeIcon.textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
      }
      // Resetar outros √≠cones
      document.querySelectorAll('.sort-icon').forEach(icon => {
        if (icon.id !== `sort-icon-${sortColumn}`) icon.textContent = '‚áÖ';
      });

      let html = '';

      timesExibir.forEach(item => {
        const { time, precoAlgo, precoMercado, variacao, dividendos, cotasDisponiveis, menorPrecoVenda, possuiTodas, minhasQtd, qtdAVenda } = item;

        const varClass = variacao > 0 ? 'positive' : variacao < 0 ? 'negative' : 'neutral';
        const varIcon = variacao > 0 ? '‚ñ≤' : variacao < 0 ? '‚ñº' : '‚óè';

        // Pre√ßo de mercado: menor pre√ßo √† venda real ou pre√ßo do algoritmo
        const precoMostrar = cotasDisponiveis > 0 ? menorPrecoVenda : precoAlgo;

        // √Ä Venda: n√∫mero de cotas + menor pre√ßo se dispon√≠veis
        let textoDisponivel = '';
        let corDisponivel = '#6b7280';
        if (possuiTodas) {
          textoDisponivel = `${minhasQtd.toLocaleString('pt-BR')}`;
          corDisponivel = '#f59e0b';
        } else if (cotasDisponiveis > 0) {
          textoDisponivel = `${cotasDisponiveis.toLocaleString('pt-BR')} a ${menorPrecoVenda} cr`;
          corDisponivel = '#10b981';
        } else {
          textoDisponivel = 'Sem ordens';
          corDisponivel = '#6b7280';
        }

        html += `
          <tr data-time="${time.nome.toLowerCase()}">
            <td>
              <div class="team-cell">
                <div class="team-jersey">${gerarCamisetaSVG(time.primaria, time.secundaria, time.terciaria)}</div>
                <div>
                  <div class="team-name">${time.nome}</div>
                  <div class="team-country">${time.pais || ''}</div>
                </div>
              </div>
            </td>
            <td class="price-market">${precoMostrar.toFixed(2)} cr</td>
            <td><span class="variation ${varClass}">${varIcon} ${variacao >= 0 ? '+' : ''}${variacao.toFixed(2)}%</span></td>
            <td class="dividend">${dividendos.toFixed(3)} cr</td>
            <td style="color: ${corDisponivel}; font-weight: 600; cursor: pointer;" onclick="abrirBook('${time.id}')" title="Ver book de ofertas">
              ${textoDisponivel} üìñ
            </td>
            <td>
              <div class="actions-cell">
                <button class="btn-buy" onclick="abrirModalCompra('${time.id}')" ${possuiTodas ? 'disabled title="Voc√™ j√° possui todas as cotas"' : cotasDisponiveis === 0 ? 'disabled title="Sem ordens de venda dispon√≠veis"' : ''}>Comprar</button>
                <button class="btn-sell" onclick="abrirModalVenda('${time.id}')">Vender</button>
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Mostrar/esconder bot√£o de expandir
      const expandirContainer = document.getElementById('expandirContainer');
      if (!tabelaExpandida && !buscaAtiva && restantes > 0) {
        document.getElementById('totalRestantes').textContent = restantes;
        expandirContainer.style.display = 'block';
      } else {
        expandirContainer.style.display = 'none';
      }

      // Atualizar contagem de filtro
      document.getElementById('filterCount').textContent = `${totalTimes} time${totalTimes !== 1 ? 's' : ''}`;
    }

    // ==================== FILTRAR ====================
    let buscaAtiva = false;
    function filterTimes() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const novaAtiva = search.length > 0;
      if (novaAtiva !== buscaAtiva) {
        buscaAtiva = novaAtiva;
        renderizarTabelaMercado();
      }
      document.querySelectorAll('#stockTableBody tr').forEach(row => {
        const timeNome = row.getAttribute('data-time') || '';
        row.style.display = timeNome.includes(search) ? '' : 'none';
      });
    }

    function filterCarteira() {
      const search = document.getElementById('carteiraSearchInput').value.toLowerCase();
      document.querySelectorAll('#portfolioGrid .portfolio-card').forEach(card => {
        const timeNome = card.getAttribute('data-time') || '';
        card.style.display = timeNome.includes(search) ? '' : 'none';
      });
    }

    // ==================== TABS ====================
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).style.display = 'block';
      event.target.classList.add('active');

      if (tabName === 'carteira') renderizarCarteira();
      else if (tabName === 'ordens') renderizarOrdens();
      else if (tabName === 'historico') renderizarHistorico();
      else if (tabName === 'ranking') carregarRanking();
    }

    function renderizarCarteira() {
      const grid = document.getElementById('portfolioGrid');
      const cotasArray = Object.entries(minhasCotas);
      
      if (cotasArray.length === 0) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Nenhuma cota ainda</div><p>Compre cotas e comece a receber dividendos!</p></div>`;
        return;
      }

      let html = '';
      cotasArray.forEach(([timeId, cota]) => {
        const time = allTimes.find(t => t.id === timeId) || {};
        const m = metricas[timeId] || {};
        const preco = m.precoAlgoritmo || PRECO_INICIAL;
        const valorTotal = (cota.quantidade * preco).toFixed(2);
        const lucro = ((preco - (cota.precoMedioAquisicao || PRECO_INICIAL)) * cota.quantidade).toFixed(2);

        html += `
          <div class="portfolio-card" data-time="${(time.nome || '').toLowerCase()}">
            <div class="portfolio-header">
              <div class="portfolio-team">
                <div class="team-jersey" style="width: 35px; height: 40px;">${gerarCamisetaSVG(time.primaria, time.secundaria, time.terciaria)}</div>
                <span style="font-weight: 600;">${time.nome || 'Time'}</span>
              </div>
              <div style="text-align: right;">
                <div class="shares-count">${cota.quantidade}</div>
                <div class="shares-label">cotas</div>
              </div>
            </div>
            <div class="portfolio-stats">
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${preco.toFixed(2)} cr</div>
                <div class="portfolio-stat-label">Pre√ßo atual</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${valorTotal} cr</div>
                <div class="portfolio-stat-label">Valor total</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${(cota.precoMedioAquisicao || PRECO_INICIAL).toFixed(2)} cr</div>
                <div class="portfolio-stat-label">Pre√ßo m√©dio</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" style="color: ${lucro >= 0 ? 'var(--success)' : 'var(--danger)'}">${lucro >= 0 ? '+' : ''}${lucro} cr</div>
                <div class="portfolio-stat-label">Lucro/Preju√≠zo</div>
              </div>
            </div>
          </div>
        `;
      });

      grid.innerHTML = html;
    }

    function renderizarOrdens() {
      const list = document.getElementById('ordersList');
      
      if (ordensAbertas.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Nenhuma ordem aberta</div></div>`;
        return;
      }

      let html = '';
      ordensAbertas.forEach(ordem => {
        html += `
          <div class="order-card ${ordem.tipo}">
            <div style="display: flex; align-items: center; gap: 15px;">
              <span class="order-type ${ordem.tipo}">${ordem.tipo}</span>
              <div>
                <h4>${ordem.timeNome}</h4>
                <span style="font-size: 0.85em; color: var(--text-secondary);">${ordem.quantidadeRestante}/${ordem.quantidade} cotas</span>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="text-align: right;">
                <div style="font-weight: 700; color: var(--accent);">${ordem.precoUnitario.toFixed(2)} cr/cota</div>
                <div style="font-size: 0.85em; color: var(--text-secondary);">Total: ${(ordem.quantidadeRestante * ordem.precoUnitario).toFixed(2)} cr</div>
              </div>
              <button class="btn-cancel-order" onclick="cancelarOrdem('${ordem.id}')">‚úï Cancelar</button>
            </div>
          </div>
        `;
      });

      list.innerHTML = html;
    }

    // CORRE√á√ÉO: Fun√ß√£o para cancelar ordens
    async function cancelarOrdem(ordemId) {
      if (!confirm('Tem certeza que deseja cancelar esta ordem de venda?')) return;
      
      try {
        await db.collection('bolsa_ordens').doc(ordemId).update({
          status: 'cancelada',
          dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('‚úÖ Ordem cancelada com sucesso!');
        await carregarMinhasOrdens();
        await carregarOrdensAbertas();
        renderizarOrdens();
        renderizarTabelaMercado();
      } catch (error) {
        console.error('Erro ao cancelar ordem:', error);
        showToast('‚ùå Erro ao cancelar ordem');
      }
    }

    async function renderizarHistorico() {
      const list = document.getElementById('historicoList');
      list.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div> Carregando...</div>';
      
      try {
        // CORRE√á√ÉO: Queries sem orderBy para evitar erro de √≠ndice composto
        const [compras, vendas] = await Promise.all([
          db.collection('bolsa_transacoes').where('compradorId', '==', currentUser.uid).limit(30).get(),
          db.collection('bolsa_transacoes').where('vendedorId', '==', currentUser.uid).limit(30).get()
        ]);

        const transacoes = [];
        compras.forEach(doc => transacoes.push({ ...doc.data(), tipo: 'compra' }));
        vendas.forEach(doc => transacoes.push({ ...doc.data(), tipo: 'venda' }));
        // Ordenar no JavaScript
        transacoes.sort((a, b) => (b.dataTransacao?.toMillis() || 0) - (a.dataTransacao?.toMillis() || 0));

        if (transacoes.length === 0) {
          list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Nenhuma transa√ß√£o</div></div>`;
          return;
        }

        let html = '';
        transacoes.slice(0, 30).forEach(t => {
          const data = t.dataTransacao?.toDate().toLocaleString('pt-BR') || '';
          html += `
            <div class="order-card ${t.tipo}">
              <div style="display: flex; align-items: center; gap: 15px;">
                <span class="order-type ${t.tipo}">${t.tipo}</span>
                <div>
                  <h4>${t.timeNome}</h4>
                  <span style="font-size: 0.8em; color: var(--text-secondary);">${data}</span>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 700;">${t.quantidade} cotas</div>
                <div style="font-size: 0.85em; color: var(--accent);">${t.valorTotal.toFixed(2)} cr</div>
              </div>
            </div>
          `;
        });

        list.innerHTML = html;
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Erro ao carregar</div></div>`;
      }
    }

    // ==================== MODAL COMPRAR ====================
    function abrirModalCompra(timeId) {
      // CORRE√á√ÉO: Verificar se j√° possui todas as cotas
      const minhaCota = minhasCotas[timeId];
      if (minhaCota && minhaCota.quantidade >= COTAS_POR_TIME) {
        showToast('‚ùå Voc√™ j√° possui todas as ' + COTAS_POR_TIME + ' cotas deste time!');
        return;
      }

      const time = allTimes.find(t => t.id === timeId);
      if (!time) return;

      modalTimeAtual = time;
      const m = metricas[timeId] || {};
      
      // CORRE√á√ÉO: Filtrar ordens do pr√≥prio usu√°rio (n√£o pode comprar de si mesmo)
      const todasOrdensTime = ordens[timeId] || [];
      const ordensOutros = todasOrdensTime.filter(o => o.userId !== currentUser.uid);

      const precoAlgo = m.precoAlgoritmo || PRECO_INICIAL;
      const menorPrecoVenda = ordensOutros.length > 0 ? ordensOutros[0].precoUnitario : precoAlgo;
      const cotasDisp = ordensOutros.reduce((sum, o) => sum + o.quantidadeRestante, 0);
      const dividendos = m.mediaDividendos || 0;
      const diferenca = precoAlgo > 0 ? ((menorPrecoVenda - precoAlgo) / precoAlgo * 100) : 0;
      const jogosRetorno = dividendos > 0 ? Math.ceil(menorPrecoVenda / dividendos) : 999;

      // Atualizar modal
      document.getElementById('modalComprarTime').textContent = time.nome;
      document.getElementById('modalComprarPais').textContent = time.pais || '';
      document.getElementById('modalPrecoAlgo').textContent = precoAlgo.toFixed(2) + ' cr';
      document.getElementById('modalPrecoVenda').textContent = menorPrecoVenda.toFixed(2) + ' cr';
      document.getElementById('modalDiferenca').textContent = (diferenca >= 0 ? '+' : '') + diferenca.toFixed(1) + '%';
      document.getElementById('modalDiferenca').style.color = diferenca <= 0 ? 'var(--success)' : diferenca <= 10 ? 'var(--warning)' : 'var(--danger)';
      document.getElementById('modalDividendos').textContent = dividendos.toFixed(3) + ' cr';
      document.getElementById('modalRetorno').textContent = jogosRetorno < 999 ? jogosRetorno + ' jogos' : '‚àû';
      
      // CORRE√á√ÉO: Mostrar informa√ß√£o mais clara sobre disponibilidade
      if (cotasDisp > 0) {
        document.getElementById('cotasDisponiveis').textContent = cotasDisp + ' cotas dispon√≠veis';
      } else {
        document.getElementById('cotasDisponiveis').textContent = 'Nenhuma ordem de venda';
      }
      
      document.getElementById('inputQtdCompra').value = 1;
      document.getElementById('inputQtdCompra').max = cotasDisp > 0 ? cotasDisp : 1000;

      // CORRE√á√ÉO: Indicador de neg√≥cio melhorado
      const indicator = document.getElementById('dealIndicator');
      if (cotasDisp === 0) {
        indicator.className = 'deal-indicator good';
        indicator.innerHTML = 'üü¢ Compra do dono inicial pelo pre√ßo do algoritmo';
      } else if (diferenca <= 0) {
        indicator.className = 'deal-indicator good';
        indicator.innerHTML = 'üü¢ Bom neg√≥cio! Pre√ßo igual ou abaixo do algoritmo';
      } else if (diferenca <= 10) {
        indicator.className = 'deal-indicator neutral';
        indicator.innerHTML = 'üü° Pre√ßo levemente acima do algoritmo';
      } else {
        indicator.className = 'deal-indicator expensive';
        indicator.innerHTML = 'üî¥ Cuidado! Pre√ßo muito acima do justo';
      }

      // NOVO: Preencher lista de ordens dispon√≠veis
      const listaOrdens = document.getElementById('ordensListaCompra');
      const containerLista = document.getElementById('listaOrdensDisponiveis');
      if (ordensOutros.length > 0) {
        containerLista.style.display = 'block';
        let htmlLista = '';
        ordensOutros.forEach((o, i) => {
          const corLinha = i === 0 ? 'var(--success)' : 'var(--text-secondary)';
          htmlLista += `<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: ${corLinha};">
            <span>${o.quantidadeRestante} cotas de ${o.usuarioNome}</span>
            <span style="font-weight: 600;">${o.precoUnitario} cr</span>
          </div>`;
        });
        listaOrdens.innerHTML = htmlLista;
      } else {
        containerLista.style.display = 'none';
      }

      // Atualizar camisa
      document.getElementById('modalComprarJersey').innerHTML = gerarCamisetaSVG(time.primaria, time.secundaria, time.terciaria);

      calcularTotalCompra();
      document.getElementById('modalComprar').classList.add('active');
    }

    function calcularTotalCompra() {
      const qtd = parseInt(document.getElementById('inputQtdCompra').value) || 0;
      // CORRE√á√ÉO: Filtrar ordens do pr√≥prio usu√°rio
      const todasOrdensTime = ordens[modalTimeAtual?.id] || [];
      const ordensOutros = todasOrdensTime.filter(o => o.userId !== currentUser.uid);
      
      // CORRE√á√ÉO: Calcular valor real somando pre√ßos de cada ordem
      let qtdRestante = qtd;
      let valorTotal = 0;
      let detalhes = [];
      
      for (const ordem of ordensOutros) {
        if (qtdRestante <= 0) break;
        
        const qtdDestaOrdem = Math.min(qtdRestante, ordem.quantidadeRestante);
        const valorDestaOrdem = qtdDestaOrdem * ordem.precoUnitario;
        
        valorTotal += valorDestaOrdem;
        qtdRestante -= qtdDestaOrdem;
        
        detalhes.push(`${qtdDestaOrdem}x ${ordem.precoUnitario} cr`);
      }
      
      // Calcular pre√ßo m√©dio
      const precoMedio = qtd > 0 ? valorTotal / qtd : 0;

      document.getElementById('summaryQtdCompra').textContent = qtd + ' cotas';
      document.getElementById('summaryPrecoCompra').textContent = precoMedio.toFixed(2) + ' cr (m√©dio)';
      document.getElementById('summaryTotalCompra').textContent = valorTotal.toFixed(2) + ' cr';
      
      // Mostrar detalhamento se houver m√∫ltiplas ordens
      const detalheEl = document.getElementById('summaryDetalhes');
      if (detalheEl) {
        if (detalhes.length > 1) {
          detalheEl.innerHTML = '<small style="color: var(--text-secondary);">(' + detalhes.join(' + ') + ')</small>';
        } else {
          detalheEl.innerHTML = '';
        }
      }
    }

    async function confirmarCompra() {
      if (!modalTimeAtual) return;

      // CORRE√á√ÉO: Verificar se j√° possui todas as cotas
      const minhaCota = minhasCotas[modalTimeAtual.id];
      if (minhaCota && minhaCota.quantidade >= COTAS_POR_TIME) {
        showToast('‚ùå Voc√™ j√° possui todas as ' + COTAS_POR_TIME + ' cotas deste time!');
        fecharModal('modalComprar');
        return;
      }

      const qtdDesejada = parseInt(document.getElementById('inputQtdCompra').value) || 0;
      if (qtdDesejada <= 0) return showToast('‚ùå Quantidade inv√°lida');

      // ‚úÖ IMPORTANTE: Recarregar ordens do servidor para garantir dados atualizados
      try {
        const ordensSnap = await db.collection('bolsa_ordens')
          .where('timeId', '==', modalTimeAtual.id)
          .where('tipo', '==', 'venda')
          .get();
        
        const ordensAtualizadas = [];
        ordensSnap.forEach(doc => {
          const data = doc.data();
          if ((data.status === 'aberta' || data.status === 'parcial') && data.quantidadeRestante > 0) {
            ordensAtualizadas.push({ id: doc.id, ...data });
          }
        });
        
        // Ordenar por pre√ßo (menor primeiro)
        ordensAtualizadas.sort((a, b) => a.precoUnitario - b.precoUnitario);
        
        // Filtrar ordens do pr√≥prio usu√°rio
        const ordensOutros = ordensAtualizadas.filter(o => o.userId !== currentUser.uid);
        
        if (ordensOutros.length === 0) {
          showToast('‚ùå N√£o h√° cotas √† venda para este time. Aguarde algu√©m criar uma ordem de venda.');
          fecharModal('modalComprar');
          return;
        }

        // Calcular total dispon√≠vel
        const totalDisponivel = ordensOutros.reduce((sum, o) => sum + o.quantidadeRestante, 0);
        
        if (totalDisponivel < qtdDesejada) {
          return showToast(`‚ùå Apenas ${totalDisponivel} cotas dispon√≠veis para compra`);
        }

        // Calcular compras por ordem
        let qtdRestante = qtdDesejada;
        let valorTotalCompra = 0;
        const comprasPorOrdem = [];
        
        for (const ordem of ordensOutros) {
          if (qtdRestante <= 0) break;
          
          const qtdDestaOrdem = Math.min(qtdRestante, ordem.quantidadeRestante);
          const valorDestaOrdem = qtdDestaOrdem * ordem.precoUnitario;
          
          comprasPorOrdem.push({ ordem, qtd: qtdDestaOrdem, valor: valorDestaOrdem });
          valorTotalCompra += valorDestaOrdem;
          qtdRestante -= qtdDestaOrdem;
        }

        // ‚úÖ CONFIRMA√á√ÉO CLARA DO PRE√áO
        const precoMedio = (valorTotalCompra / qtdDesejada).toFixed(2);
        const detalhesCompra = comprasPorOrdem.map(c => `${c.qtd}x ${c.ordem.precoUnitario} cr`).join(' + ');
        
        if (!confirm(`‚ö†Ô∏è CONFIRMAR COMPRA?\n\n` +
          `Quantidade: ${qtdDesejada} cotas\n` +
          `Pre√ßo: ${detalhesCompra}\n` +
          `Total: ${valorTotalCompra.toFixed(2)} cr\n\n` +
          `Voc√™ est√° comprando pelo PRE√áO DO VENDEDOR.\n` +
          `Clique OK para confirmar.`)) {
          return;
        }

        if ((currentUserData.creditos || 0) < valorTotalCompra) {
          return showToast('‚ùå Cr√©ditos insuficientes');
        }

        // =====================================================
        // ‚úÖ VERS√ÉO SEGURA: Usa Cloud Function
        // O SISTEMA faz a transfer√™ncia, n√£o o usu√°rio
        // =====================================================
        
        // Desabilitar bot√£o enquanto processa
        const btnComprar = document.querySelector('#modalComprar .btn-confirm');
        const btnTextoOriginal = btnComprar ? btnComprar.innerHTML : '';
        if (btnComprar) {
          btnComprar.disabled = true;
          btnComprar.innerHTML = '‚è≥ Processando...';
        }
        
        try {
          // Executar compra de cada ordem via Cloud Function
          for (const compra of comprasPorOrdem) {
            const executarCompra = functions.httpsCallable('executarCompraBolsa');
            
            const resultado = await executarCompra({
              ordemId: compra.ordem.id,
              quantidade: compra.qtd
            });
            
            console.log('‚úÖ Compra executada:', resultado.data);
          }
          
          // Sucesso!
          const msgOrdens = comprasPorOrdem.length > 1 ? ` (de ${comprasPorOrdem.length} vendedores)` : '';
          showToast(`‚úÖ Compra realizada! ${qtdDesejada} cotas por ${valorTotalCompra.toFixed(2)} cr${msgOrdens}`);
          fecharModal('modalComprar');
          await carregarDadosUsuario();
          await carregarMinhasCotas();
          await carregarOrdensAbertas();
          renderizarTabelaMercado();
          
        } catch (funcError) {
          console.error('Erro na Cloud Function:', funcError);
          
          let mensagem = 'Erro ao processar compra. Tente novamente.';
          
          if (funcError.code === 'resource-exhausted' || funcError.message?.includes('Cr√©ditos')) {
            mensagem = funcError.message || 'Cr√©ditos insuficientes!';
          } else if (funcError.code === 'failed-precondition') {
            mensagem = funcError.message || 'Ordem n√£o dispon√≠vel';
          } else if (funcError.code === 'not-found') {
            mensagem = 'Ordem n√£o encontrada';
          } else if (funcError.code === 'unauthenticated') {
            mensagem = 'Fa√ßa login novamente';
          }
          
          showToast('‚ùå ' + mensagem);
        } finally {
          // Reabilitar bot√£o
          if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.innerHTML = btnTextoOriginal || 'üí∞ Confirmar Compra';
          }
        }

      } catch (error) {
        console.error(error);
        showToast('‚ùå Erro ao processar compra');
      }
    }

    // ==================== MODAL VENDER ====================
    function abrirModalVenda(timeId) {
      const time = allTimes.find(t => t.id === timeId);
      if (!time) return;

      const minhaCota = minhasCotas[timeId];
      if (!minhaCota || minhaCota.quantidade <= 0) {
        return showToast('‚ùå Voc√™ n√£o possui cotas deste time');
      }

      modalTimeAtual = time;
      const m = metricas[timeId] || {};
      const precoAlgo = m.precoAlgoritmo || PRECO_INICIAL;
      const precoMercado = m.precoMercado || PRECO_INICIAL;
      const dividendos = m.mediaDividendos || 0;

      document.getElementById('modalVenderTime').textContent = time.nome;
      document.getElementById('modalMinhasCotas').textContent = minhaCota.quantidade;
      document.getElementById('modalVenderPrecoAlgo').textContent = Math.round(precoAlgo) + ' cr';
      document.getElementById('modalMediaVendas').textContent = Math.round(precoMercado) + ' cr';
      document.getElementById('modalVenderDividendos').textContent = dividendos.toFixed(3) + ' cr';
      document.getElementById('inputQtdVenda').value = 1;
      document.getElementById('inputQtdVenda').max = minhaCota.quantidade;
      // CORRE√á√ÉO: Pre√ßo sugerido deve ser inteiro
      document.getElementById('inputPrecoVenda').value = Math.round(precoAlgo);
      document.getElementById('sugestaoMin').textContent = Math.round(precoAlgo * 0.9);
      document.getElementById('sugestaoMax').textContent = Math.round(precoAlgo * 1.1);

      document.getElementById('modalVenderJersey').innerHTML = gerarCamisetaSVG(time.primaria, time.secundaria, time.terciaria);

      calcularTotalVenda();
      document.getElementById('modalVender').classList.add('active');
    }

    function calcularTotalVenda() {
      const qtd = parseInt(document.getElementById('inputQtdVenda').value) || 0;
      const preco = parseInt(document.getElementById('inputPrecoVenda').value) || 0;
      const total = qtd * preco;

      document.getElementById('summaryQtdVenda').textContent = qtd + ' cotas';
      document.getElementById('summaryPrecoVenda').textContent = preco + ' cr';
      document.getElementById('summaryTotalVenda').textContent = total + ' cr';
    }

    async function confirmarVenda() {
      if (!modalTimeAtual) return;

      const qtd = parseInt(document.getElementById('inputQtdVenda').value) || 0;
      const precoInput = parseFloat(document.getElementById('inputPrecoVenda').value) || 0;
      
      // CORRE√á√ÉO: Garantir que pre√ßo √© inteiro (sem centavos)
      const preco = Math.floor(precoInput);
      if (preco !== precoInput) {
        return showToast('‚ùå Pre√ßo deve ser um valor inteiro (sem centavos)');
      }

      if (qtd <= 0) return showToast('‚ùå Quantidade inv√°lida');
      if (preco <= 0) return showToast('‚ùå Pre√ßo inv√°lido');
      
      // ‚úÖ VALIDA√á√ÉO: Pre√ßo m√≠nimo de 1 cr√©dito
      if (preco < 1) {
        return showToast('‚ùå Pre√ßo m√≠nimo √© 1 cr√©dito');
      }
      
      // ‚úÖ AVISO: Pre√ßo muito baixo
      const precoAlgo = metricas[modalTimeAtual.id]?.precoAlgoritmo || PRECO_INICIAL;
      if (preco < precoAlgo * 0.5) {
        if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° vendendo por ${preco} cr, mas o pre√ßo do algoritmo √© ${precoAlgo.toFixed(0)} cr.\n\nIsso √© ${((1 - preco/precoAlgo) * 100).toFixed(0)}% ABAIXO do valor justo!\n\nTem certeza que quer continuar?`)) {
          return;
        }
      }

      const minhaCota = minhasCotas[modalTimeAtual.id];
      if (!minhaCota || minhaCota.quantidade < qtd) {
        return showToast('‚ùå Cotas insuficientes');
      }

      // ‚úÖ CONFIRMA√á√ÉO CLARA
      const valorTotal = qtd * preco;
      if (!confirm(`üì§ CONFIRMAR ORDEM DE VENDA?\n\n` +
        `Time: ${modalTimeAtual.nome}\n` +
        `Quantidade: ${qtd} cotas\n` +
        `Pre√ßo por cota: ${preco} cr\n` +
        `Valor total: ${valorTotal} cr\n\n` +
        `Outros usu√°rios poder√£o comprar suas cotas por este pre√ßo.\n` +
        `Clique OK para confirmar.`)) {
        return;
      }

      try {
        await db.collection('bolsa_ordens').add({
          tipo: 'venda',
          timeId: modalTimeAtual.id,
          timeNome: modalTimeAtual.nome,
          userId: currentUser.uid,
          usuarioNome: currentUserData.usuarioUnico || currentUserData.nome,
          quantidade: qtd,
          precoUnitario: preco,
          valorTotal: qtd * preco,
          quantidadeRestante: qtd,
          status: 'aberta',
          dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
          dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`‚úÖ Ordem criada! ${qtd} cotas a ${preco} cr cada`);
        fecharModal('modalVender');
        await carregarMinhasOrdens();
        await carregarOrdensAbertas();
        renderizarTabelaMercado();

      } catch (error) {
        console.error(error);
        showToast('‚ùå Erro ao criar ordem');
      }
    }

    // ==================== UTILS ====================
    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
      modalTimeAtual = null;
    }

    // ==================== CAMISETA SVG ====================
    function gerarCamisetaSVG(corPrimaria, corSecundaria, corTerciaria) {
      corPrimaria = corPrimaria || '#28a745';
      corSecundaria = corSecundaria || '#ffffff';
      corTerciaria = corTerciaria || corPrimaria;
      
      const uid = Math.random().toString(36).substr(2, 6);
      return `
        <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="shine_${uid}" x1="0.2" y1="0" x2="0.8" y2="1">
              <stop offset="0%" stop-color="rgba(255,255,255,0.28)"/>
              <stop offset="45%" stop-color="rgba(255,255,255,0.03)"/>
              <stop offset="100%" stop-color="rgba(0,0,0,0.08)"/>
            </linearGradient>
            <linearGradient id="sleeve_${uid}" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="${corPrimaria}"/>
              <stop offset="100%" stop-color="${corTerciaria}"/>
            </linearGradient>
            <filter id="shadow_${uid}">
              <feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.35"/>
            </filter>
          </defs>
          
          <g filter="url(#shadow_${uid})">
            <path d="M28,32 
                     Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 
                     Q72,28 72,32 
                     L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" 
                  fill="${corPrimaria}"/>
            
            <path d="M28,32 L10,46 Q6,49 7,54 L10,68 Q11,72 15,70 L26,58 Z" 
                  fill="url(#sleeve_${uid})"/>
            
            <path d="M72,32 L90,46 Q94,49 93,54 L90,68 Q89,72 85,70 L74,58 Z" 
                  fill="url(#sleeve_${uid})"/>
            
            <path d="M26,40 L28,105" stroke="${corSecundaria}" stroke-width="3" opacity="0.5" stroke-linecap="round"/>
            <path d="M74,40 L72,105" stroke="${corSecundaria}" stroke-width="3" opacity="0.5" stroke-linecap="round"/>
            
            <path d="M38,50 L62,90" stroke="${corTerciaria}" stroke-width="8" opacity="0.12" stroke-linecap="round"/>
            
            <path d="M28,32 
                     Q28,28 32,28 L40,28 Q45,28 47,24 Q50,20 53,24 Q55,28 60,28 L68,28 
                     Q72,28 72,32 
                     L74,105 Q74,112 68,112 L32,112 Q28,112 26,105 Z" 
                  fill="url(#shine_${uid})"/>
            
            <path d="M43,26 L50,32 L57,26" fill="none" stroke="${corSecundaria}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            
            <path d="M28,107 Q28,112 32,112 L68,112 Q72,112 72,107" 
                  fill="${corSecundaria}" opacity="0.3"/>
            
            <path d="M10,65 Q11,70 15,68" stroke="${corTerciaria}" stroke-width="2.5" opacity="0.5" fill="none" stroke-linecap="round"/>
            <path d="M90,65 Q89,70 85,68" stroke="${corTerciaria}" stroke-width="2.5" opacity="0.5" fill="none" stroke-linecap="round"/>
          </g>
        </svg>
      `;
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==================== RANKING ====================
    let rankingData = [];
    let rankingSort = 'patrimonio';
    let rankingExpandido = false;
    const RANKING_LIMITE = 20;

    function ordenarRanking(criterio) {
      rankingSort = criterio;
      document.querySelectorAll('#rankingSortToggle button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderizarRanking();
    }

    function expandirRanking() {
      rankingExpandido = true;
      renderizarRanking();
    }

    async function carregarRanking() {
      const tbody = document.getElementById('rankingTableBody');
      tbody.innerHTML = '<tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr>';
      document.getElementById('podiumContainer').style.display = 'none';

      try {
        const cotasSnap = await db.collection('bolsa_cotas').get();
        
        const investidores = {};
        cotasSnap.forEach(doc => {
          const cota = doc.data();
          if (cota.userId === DONO_INICIAL_ID) return;
          
          if (!investidores[cota.userId]) {
            investidores[cota.userId] = {
              nome: cota.usuarioNome || 'An√¥nimo',
              cotas: 0,
              times: new Set(),
              patrimonio: 0
            };
          }
          
          investidores[cota.userId].cotas += cota.quantidade;
          investidores[cota.userId].times.add(cota.timeId);
          
          const precoTime = metricas[cota.timeId]?.precoAlgoritmo || PRECO_INICIAL;
          investidores[cota.userId].patrimonio += cota.quantidade * precoTime;
        });

        rankingData = Object.entries(investidores)
          .map(([id, data]) => ({ id, ...data, times: data.times.size }));

        // Estat√≠sticas
        document.getElementById('totalInvestidores').textContent = rankingData.length;
        document.getElementById('totalCotasNegociadas').textContent = rankingData.reduce((sum, i) => sum + i.cotas, 0).toLocaleString('pt-BR');
        
        const topPat = [...rankingData].sort((a, b) => b.patrimonio - a.patrimonio);
        document.getElementById('maiorPatrimonio').textContent = topPat.length > 0 ? topPat[0].patrimonio.toLocaleString('pt-BR') + ' cr' : '0 cr';

        rankingExpandido = false;
        renderizarRanking();
      } catch (error) {
        console.error('Erro ao carregar ranking:', error);
        tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Erro ao carregar</div></div></td></tr>';
      }
    }

    function renderizarRanking() {
      const tbody = document.getElementById('rankingTableBody');

      if (rankingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-icon">üèÜ</div><div class="empty-title">Nenhum investidor ainda</div></div></td></tr>';
        document.getElementById('podiumContainer').style.display = 'none';
        document.getElementById('rankingExpandir').style.display = 'none';
        return;
      }

      // Ordenar conforme crit√©rio
      const ranking = [...rankingData].sort((a, b) => {
        switch (rankingSort) {
          case 'cotas': return b.cotas - a.cotas;
          case 'times': return b.times - a.times;
          case 'diversificacao':
            const divA = a.times > 0 ? a.patrimonio / a.times : 0;
            const divB = b.times > 0 ? b.patrimonio / b.times : 0;
            return b.times - a.times || divB - divA;
          default: return b.patrimonio - a.patrimonio;
        }
      });

      // Podium (top 3) ‚Äî s√≥ mostra se tiver 3+ investidores e ordenando por patrim√¥nio
      const podium = document.getElementById('podiumContainer');
      if (ranking.length >= 3 && rankingSort === 'patrimonio') {
        podium.style.display = 'flex';
        const cores = ['#C0C0C0', '#FFD700', '#CD7F32'];
        const medalhas = ['ü•à', 'ü•á', 'ü•â'];
        const indices = [1, 0, 2]; // prata, ouro, bronze (ordem visual)
        
        indices.forEach((idx, pos) => {
          const inv = ranking[idx];
          const isMe = inv.id === currentUser?.uid;
          document.getElementById(`podium${idx + 1}`).innerHTML = `
            <div class="podium-avatar" style="background: ${cores[idx]}; color: #111;">${inv.nome.charAt(0).toUpperCase()}</div>
            <div class="podium-name" ${isMe ? 'style="color: var(--accent);"' : ''}>${isMe ? '‚≠ê ' : ''}${inv.nome}</div>
            <div class="podium-value">${inv.patrimonio.toLocaleString('pt-BR')} cr</div>
            <div class="podium-bar"><span class="podium-medal">${medalhas[idx]}</span></div>
          `;
        });
      } else {
        podium.style.display = 'none';
      }

      // Pagina√ß√£o
      const total = ranking.length;
      const exibir = rankingExpandido ? ranking : ranking.slice(0, RANKING_LIMITE);
      const restantes = total - RANKING_LIMITE;

      let html = '';
      exibir.forEach((inv, idx) => {
        const medalha = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}¬∫`;
        const isMe = inv.id === currentUser?.uid;
        
        // Valor principal baseado no crit√©rio
        let valorPrincipal;
        switch (rankingSort) {
          case 'cotas': valorPrincipal = inv.cotas.toLocaleString('pt-BR'); break;
          case 'times': valorPrincipal = inv.times; break;
          case 'diversificacao': valorPrincipal = inv.times; break;
          default: valorPrincipal = inv.patrimonio.toLocaleString('pt-BR') + ' cr';
        }
        
        html += `
          <tr style="${isMe ? 'background: rgba(255,181,71,0.1);' : ''}">
            <td style="font-size: 1.1em; font-weight: 700; width: 50px;">${medalha}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                ${isMe ? '<span style="background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; font-weight: 700;">VOC√ä</span>' : ''}
                ${inv.nome}
              </div>
            </td>
            <td style="font-weight: 600;">${inv.cotas.toLocaleString('pt-BR')}</td>
            <td>${inv.times}</td>
            <td style="color: var(--success); font-weight: 700;">${inv.patrimonio.toLocaleString('pt-BR')} cr</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Expandir
      const expandir = document.getElementById('rankingExpandir');
      if (!rankingExpandido && restantes > 0) {
        document.getElementById('rankingRestantes').textContent = restantes;
        expandir.style.display = 'block';
      } else {
        expandir.style.display = 'none';
      }
    }

    // ==================== BOOK DE OFERTAS ====================
    function abrirBook(timeId) {
      const time = allTimes.find(t => t.id === timeId);
      if (!time) return;

      document.getElementById('bookTimeNome').textContent = time.nome;
      
      const ordensTime = ordens[timeId] || [];
      const divVendas = document.getElementById('bookVendas');
      
      if (ordensTime.length === 0) {
        divVendas.innerHTML = '<div class="empty-state" style="padding: 20px;"><div class="empty-icon">üì≠</div><div class="empty-title">Sem ordens</div></div>';
        document.getElementById('bookTotalVenda').textContent = '0 cotas';
        document.getElementById('bookMenorPreco').textContent = '-';
        document.getElementById('bookMaiorPreco').textContent = '-';
        document.getElementById('bookVendedores').textContent = '0';
      } else {
        let html = '';
        let totalCotas = 0;
        const vendedores = new Set();
        
        ordensTime.forEach(o => {
          totalCotas += o.quantidadeRestante;
          vendedores.add(o.userId);
          const isMe = o.userId === currentUser?.uid;
          
          html += `
            <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 5px; ${isMe ? 'border-left: 3px solid var(--accent);' : ''}">
              <div>
                <div style="font-weight: 600;">${o.quantidadeRestante} cotas</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">${o.usuarioNome || 'An√¥nimo'}${isMe ? ' (voc√™)' : ''}</div>
              </div>
              <div style="text-align: right;">
                <div style="color: var(--danger); font-weight: 700;">${o.precoUnitario} cr</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">cada</div>
              </div>
            </div>
          `;
        });
        
        divVendas.innerHTML = html;
        document.getElementById('bookTotalVenda').textContent = totalCotas + ' cotas';
        document.getElementById('bookMenorPreco').textContent = ordensTime[0].precoUnitario + ' cr';
        document.getElementById('bookMaiorPreco').textContent = ordensTime[ordensTime.length - 1].precoUnitario + ' cr';
        document.getElementById('bookVendedores').textContent = vendedores.size;
      }
      
      document.getElementById('modalBook').classList.add('active');
    }

    // ==================== ADMIN ====================
    function logAdmin(msg, tipo = 'info') {
      const log = document.getElementById('adminLog');
      if (!log) { console.log(`[BOLSA ${tipo}] ${msg}`); return; }
      log.style.display = 'block';
      const cores = { info: '#3b82f6', success: '#10b981', error: '#ef4444', warn: '#f59e0b' };
      log.innerHTML += `<div style="color: ${cores[tipo]};">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    async function inicializarMetricas() {
      if (!confirm('Isso vai criar/atualizar m√©tricas de TODOS os times com pre√ßo 500 cr. Continuar?')) return;
      
      logAdmin('Iniciando cria√ß√£o de m√©tricas...', 'info');
      let criados = 0, erros = 0;

      for (const time of allTimes) {
        try {
          await db.collection('bolsa_metricas_time').doc(time.id).set({
            timeId: time.id,
            timeNome: time.nome,
            precoAlgoritmo: 500,
            precoMercado: 500,
            variacaoDia: 0,
            mediaDividendos: 0,
            volumeDia: 0,
            ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          criados++;
        } catch (e) {
          erros++;
          logAdmin(`Erro em ${time.nome}: ${e.message}`, 'error');
        }
      }

      logAdmin(`‚úÖ M√©tricas criadas: ${criados} times, ${erros} erros`, criados === allTimes.length ? 'success' : 'warn');
      showToast(`‚úÖ M√©tricas criadas para ${criados} times!`);
      await carregarMetricas();
      renderizarTabelaMercado();
    }

    async function inicializarCotasDono() {
      if (!confirm('Isso vai criar 1000 cotas de cada time para o dono inicial. Continuar?')) return;
      
      logAdmin('Criando cotas do dono inicial...', 'info');
      let criados = 0, erros = 0;

      for (const time of allTimes) {
        try {
          // Verificar se j√° existe
          const existente = await db.collection('bolsa_cotas')
            .where('timeId', '==', time.id)
            .where('userId', '==', DONO_INICIAL_ID)
            .get();
          
          if (existente.empty) {
            await db.collection('bolsa_cotas').add({
              timeId: time.id,
              timeNome: time.nome,
              userId: DONO_INICIAL_ID,
              usuarioNome: 'Dono Inicial',
              quantidade: 1000,
              precoMedioAquisicao: 500,
              dataAquisicao: firebase.firestore.FieldValue.serverTimestamp()
            });
            criados++;
          } else {
            // Atualizar para 1000
            await existente.docs[0].ref.update({ quantidade: 1000 });
            criados++;
          }
        } catch (e) {
          erros++;
          logAdmin(`Erro em ${time.nome}: ${e.message}`, 'error');
        }
      }

      logAdmin(`‚úÖ Cotas criadas: ${criados} times, ${erros} erros`, criados === allTimes.length ? 'success' : 'warn');
      showToast(`‚úÖ Cotas do dono inicial criadas para ${criados} times!`);
    }

    async function limparColecao(colecao) {
      if (!confirm(`ATEN√á√ÉO: Isso vai APAGAR TODOS os documentos de "${colecao}"! Confirma?`)) return;
      
      logAdmin(`Limpando ${colecao}...`, 'warn');
      
      try {
        const snap = await db.collection(colecao).get();
        const batch = db.batch();
        let count = 0;
        
        snap.forEach(doc => {
          batch.delete(doc.ref);
          count++;
          if (count % 500 === 0) {
            // Firestore tem limite de 500 ops por batch
            batch.commit();
          }
        });
        
        await batch.commit();
        logAdmin(`‚úÖ ${colecao} limpo: ${count} documentos removidos`, 'success');
        showToast(`‚úÖ ${count} documentos removidos de ${colecao}`);
        
        // Recarregar dados
        if (colecao === 'bolsa_ordens') {
          await carregarOrdensAbertas();
          await carregarMinhasOrdens();
        } else if (colecao === 'bolsa_cotas') {
          await carregarMinhasCotas();
        }
        renderizarTabelaMercado();
        
      } catch (e) {
        logAdmin(`‚ùå Erro: ${e.message}`, 'error');
        showToast('‚ùå Erro ao limpar cole√ß√£o');
      }
    }

    async function resetCompleto() {
      if (!confirm('‚ö†Ô∏è RESET TOTAL: Isso vai:\n1. Apagar TODAS as ordens\n2. Apagar TODAS as transa√ß√µes\n3. Apagar TODAS as cotas\n4. Recriar m√©tricas com 500 cr\n5. Recriar cotas do dono inicial\n\nTEM CERTEZA?')) return;
      if (!confirm('√öLTIMA CHANCE: Realmente quer apagar tudo?')) return;
      
      logAdmin('üî• INICIANDO RESET COMPLETO...', 'error');
      
      try {
        // 1. Limpar ordens
        logAdmin('Limpando ordens...', 'info');
        const ordensSnap = await db.collection('bolsa_ordens').get();
        for (const doc of ordensSnap.docs) await doc.ref.delete();
        logAdmin(`‚úÖ ${ordensSnap.size} ordens removidas`, 'success');
        
        // 2. Limpar transa√ß√µes
        logAdmin('Limpando transa√ß√µes...', 'info');
        const transSnap = await db.collection('bolsa_transacoes').get();
        for (const doc of transSnap.docs) await doc.ref.delete();
        logAdmin(`‚úÖ ${transSnap.size} transa√ß√µes removidas`, 'success');
        
        // 3. Limpar cotas
        logAdmin('Limpando cotas...', 'info');
        const cotasSnap = await db.collection('bolsa_cotas').get();
        for (const doc of cotasSnap.docs) await doc.ref.delete();
        logAdmin(`‚úÖ ${cotasSnap.size} cotas removidas`, 'success');
        
        // 4. Recriar m√©tricas
        logAdmin('Recriando m√©tricas...', 'info');
        for (const time of allTimes) {
          await db.collection('bolsa_metricas_time').doc(time.id).set({
            timeId: time.id,
            timeNome: time.nome,
            precoAlgoritmo: 500,
            precoMercado: 500,
            variacaoDia: 0,
            mediaDividendos: 0,
            volumeDia: 0,
            ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        logAdmin(`‚úÖ M√©tricas criadas para ${allTimes.length} times`, 'success');
        
        // 5. Recriar cotas do dono
        logAdmin('Recriando cotas do dono inicial...', 'info');
        for (const time of allTimes) {
          await db.collection('bolsa_cotas').add({
            timeId: time.id,
            timeNome: time.nome,
            userId: DONO_INICIAL_ID,
            usuarioNome: 'Dono Inicial',
            quantidade: 1000,
            precoMedioAquisicao: 500,
            dataAquisicao: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        logAdmin(`‚úÖ Cotas criadas para ${allTimes.length} times`, 'success');
        
        logAdmin('üéâ RESET COMPLETO FINALIZADO!', 'success');
        showToast('‚úÖ Reset completo! Sistema reiniciado com pre√ßo 500 cr');
        
        // Recarregar tudo
        await carregarMetricas();
        await carregarOrdensAbertas();
        await carregarMinhasOrdens();
        await carregarMinhasCotas();
        renderizarTabelaMercado();
        
      } catch (e) {
        logAdmin(`‚ùå ERRO NO RESET: ${e.message}`, 'error');
        showToast('‚ùå Erro no reset completo');
      }
    }

    // ==================== PROCESSAR JOGOS PARA BOLSA ====================
    // ==================== AUTO-PROCESSAR JOGOS (silencioso) ====================
    async function autoProcessarJogosPendentes() {
      try {
        const jogosSnap = await db.collection('jogos').get();
        const now = new Date();
        const pendentes = [];
        
        jogosSnap.forEach(doc => {
          const jogo = { id: doc.id, ...doc.data() };
          const dataFim = jogo.dataFim?.toDate ? jogo.dataFim.toDate() : null;
          const isFinalizado = jogo.status === 'finalizado' || (dataFim && dataFim < now);
          
          if (isFinalizado && !jogo.bolsaProcessado) {
            pendentes.push(jogo);
          }
        });

        if (pendentes.length === 0) {
          console.log('üìä Bolsa: todos os jogos j√° processados');
          return;
        }

        console.log(`üìä Bolsa: processando ${pendentes.length} jogos pendentes...`);

        let processados = 0;
        for (const jogo of pendentes) {
          try {
            await processarJogoIndividual(jogo);
            processados++;
          } catch (e) {
            console.warn(`‚ö†Ô∏è Erro ao processar jogo ${jogo.id}:`, e.message);
          }
        }

        if (processados > 0) {
          console.log(`‚úÖ Bolsa: ${processados} jogos processados automaticamente`);
          // Recarregar m√©tricas e re-renderizar
          await carregarMetricas();
          renderizarTabelaMercado();
          showToast(`üìà ${processados} jogo(s) atualizado(s) na bolsa!`);
        }
      } catch (error) {
        console.error('Erro no auto-processamento da bolsa:', error);
      }
    }

    // ==================== ADMIN: PROCESSAR JOGOS (manual, com logs) ====================
    async function processarJogosParaBolsa() {
      logAdmin('üéÆ Buscando jogos finalizados para processar...', 'info');
      
      try {
        // Buscar jogos finalizados que ainda n√£o foram processados na bolsa
        const jogosSnap = await db.collection('jogos').get();
        
        // Filtrar jogos finalizados n√£o processados
        const jogosParaProcessar = [];
        const now = new Date();
        
        jogosSnap.forEach(doc => {
          const jogo = { id: doc.id, ...doc.data() };
          const dataFim = jogo.dataFim?.toDate ? jogo.dataFim.toDate() : null;
          const isFinalizado = jogo.status === 'finalizado' || (dataFim && dataFim < now);
          
          if (isFinalizado && !jogo.bolsaProcessado) {
            jogosParaProcessar.push(jogo);
          }
        });

        if (jogosParaProcessar.length === 0) {
          logAdmin('‚úÖ Todos os jogos j√° foram processados', 'info');
          showToast('‚úÖ Nenhum jogo novo para processar');
          return;
        }

        logAdmin(`üìä ${jogosParaProcessar.length} jogos para processar...`, 'info');

        let processados = 0;
        let erros = 0;

        for (const jogo of jogosParaProcessar) {
          try {
            await processarJogoIndividual(jogo);
            processados++;
          } catch (e) {
            erros++;
            logAdmin(`‚ùå Erro no jogo ${jogo.id}: ${e.message}`, 'error');
          }
        }

        logAdmin(`‚úÖ Processamento conclu√≠do: ${processados} jogos, ${erros} erros`, processados > 0 ? 'success' : 'warn');
        showToast(`‚úÖ ${processados} jogos processados!`);

        // Recarregar m√©tricas
        await carregarMetricas();
        renderizarTabelaMercado();

      } catch (error) {
        console.error('Erro ao processar jogos:', error);
        logAdmin(`‚ùå Erro geral: ${error.message}`, 'error');
        showToast('‚ùå Erro ao processar jogos');
      }
    }

    async function processarJogoIndividual(jogo) {
      const timeCasaId = jogo.timeCasaId;
      const timeForaId = jogo.timeForaId;
      
      if (!timeCasaId || !timeForaId) {
        logAdmin(`‚ö†Ô∏è Jogo ${jogo.id} sem times definidos, pulando...`, 'warn');
        return;
      }

      // Buscar nomes dos times
      const timeCasa = allTimes.find(t => t.id === timeCasaId);
      const timeFora = allTimes.find(t => t.id === timeForaId);
      
      logAdmin(`üéØ Processando: ${timeCasa?.nome || timeCasaId} vs ${timeFora?.nome || timeForaId}`, 'info');

      // ‚úÖ NOVO: Buscar dados de distribui√ß√£o de cotistas do painel-jogo
      let distribuicaoCotistas = null;
      let dividendosCasa = 0;
      let dividendosFora = 0;
      
      try {
        const distDoc = await db.collection('distribuicao_cotistas_jogo').doc(jogo.id).get();
        if (distDoc.exists) {
          distribuicaoCotistas = distDoc.data();
          dividendosCasa = distribuicaoCotistas.creditosCasa || 0;
          dividendosFora = distribuicaoCotistas.creditosFora || 0;
          logAdmin(`  üí∞ Dividendos encontrados: Casa ${dividendosCasa} cr | Fora ${dividendosFora} cr`, 'info');
        }
      } catch (e) {
        console.log('Sem dados de distribui√ß√£o para este jogo:', e);
      }

      // Dados de torcida
      const torcidaCasa = jogo.torcidaCasaCount || 0;
      const torcidaFora = jogo.torcidaForaCount || 0;
      const totalTorcida = torcidaCasa + torcidaFora;

      // Dados de pontua√ß√£o - PRIORIZAR dados do jogo, sen√£o da distribui√ß√£o
      const pontosCasa = jogo.pontosCasa || jogo.creditosCasa || distribuicaoCotistas?.pontosCasa || 0;
      const pontosFora = jogo.pontosFora || jogo.creditosFora || distribuicaoCotistas?.pontosFora || 0;

      // Calcular varia√ß√µes
      let variacaoCasa = 0;
      let variacaoFora = 0;

      // 1. B√¥nus por participa√ß√£o no jogo (+0.5% cada)
      variacaoCasa += CONFIG_VALORIZACAO.porJogo;
      variacaoFora += CONFIG_VALORIZACAO.porJogo;
      logAdmin(`  +${CONFIG_VALORIZACAO.porJogo}% participa√ß√£o para ambos`, 'info');

      // 2. Varia√ß√£o por torcida
      if (totalTorcida > 0) {
        // B√¥nus por torcedor
        variacaoCasa += torcidaCasa * CONFIG_VALORIZACAO.porTorcedor;
        variacaoFora += torcidaFora * CONFIG_VALORIZACAO.porTorcedor;

        if (torcidaCasa > torcidaFora) {
          // Time Casa ganhou na torcida
          variacaoCasa += CONFIG_VALORIZACAO.porVitoriaTorcida;
          variacaoFora -= CONFIG_VALORIZACAO.porDerrotaTorcida;
          logAdmin(`  üèÜ Torcida: ${timeCasa?.nome} venceu (${torcidaCasa} vs ${torcidaFora})`, 'success');
        } else if (torcidaFora > torcidaCasa) {
          // Time Fora ganhou na torcida
          variacaoFora += CONFIG_VALORIZACAO.porVitoriaTorcida;
          variacaoCasa -= CONFIG_VALORIZACAO.porDerrotaTorcida;
          logAdmin(`  üèÜ Torcida: ${timeFora?.nome} venceu (${torcidaFora} vs ${torcidaCasa})`, 'success');
        } else {
          logAdmin(`  ü§ù Torcida empatada (${torcidaCasa} vs ${torcidaFora})`, 'info');
        }
      }

      // 3. Varia√ß√£o por pontua√ß√£o/cr√©ditos
      if (pontosCasa > 0 || pontosFora > 0) {
        // B√¥nus por ponto
        variacaoCasa += pontosCasa * CONFIG_VALORIZACAO.porPonto;
        variacaoFora += pontosFora * CONFIG_VALORIZACAO.porPonto;

        if (pontosCasa > pontosFora) {
          variacaoCasa += CONFIG_VALORIZACAO.porVitoriaPontuacao;
          variacaoFora -= CONFIG_VALORIZACAO.porDerrotaPontuacao;
          logAdmin(`  üéØ Pontua√ß√£o: ${timeCasa?.nome} venceu (${pontosCasa} vs ${pontosFora})`, 'success');
        } else if (pontosFora > pontosCasa) {
          variacaoFora += CONFIG_VALORIZACAO.porVitoriaPontuacao;
          variacaoCasa -= CONFIG_VALORIZACAO.porDerrotaPontuacao;
          logAdmin(`  üéØ Pontua√ß√£o: ${timeFora?.nome} venceu (${pontosFora} vs ${pontosCasa})`, 'success');
        }
      }

      // Limitar varia√ß√£o m√°xima
      variacaoCasa = Math.max(-CONFIG_VALORIZACAO.maxVariacao, Math.min(CONFIG_VALORIZACAO.maxVariacao, variacaoCasa));
      variacaoFora = Math.max(-CONFIG_VALORIZACAO.maxVariacao, Math.min(CONFIG_VALORIZACAO.maxVariacao, variacaoFora));

      // Atualizar m√©tricas dos times
      const batch = db.batch();

      // Time Casa
      const metricaCasa = metricas[timeCasaId] || { precoAlgoritmo: PRECO_INICIAL, variacaoDia: 0, mediaDividendos: 0, totalJogos: 0 };
      const novoPrecoAlgoCasa = metricaCasa.precoAlgoritmo * (1 + variacaoCasa / 100);
      const novaVariacaoCasa = (metricaCasa.variacaoDia || 0) + variacaoCasa;
      
      // ‚úÖ NOVO: Calcular m√©dia de dividendos
      const totalJogosCasa = (metricaCasa.totalJogos || 0) + 1;
      const novaMediaDivCasa = ((metricaCasa.mediaDividendos || 0) * (metricaCasa.totalJogos || 0) + dividendosCasa) / totalJogosCasa;

      batch.set(db.collection('bolsa_metricas_time').doc(timeCasaId), {
        timeId: timeCasaId,
        timeNome: timeCasa?.nome || '',
        precoAlgoritmo: Math.round(novoPrecoAlgoCasa * 100) / 100,
        precoMercado: metricaCasa.precoMercado || PRECO_INICIAL,
        variacaoDia: Math.round(novaVariacaoCasa * 100) / 100,
        mediaDividendos: Math.round(novaMediaDivCasa * 1000) / 1000,  // ‚úÖ NOVO
        totalJogos: totalJogosCasa,
        totalTorcedores: (metricaCasa.totalTorcedores || 0) + torcidaCasa,
        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      // Time Fora
      const metricaFora = metricas[timeForaId] || { precoAlgoritmo: PRECO_INICIAL, variacaoDia: 0, mediaDividendos: 0, totalJogos: 0 };
      const novoPrecoAlgoFora = metricaFora.precoAlgoritmo * (1 + variacaoFora / 100);
      const novaVariacaoFora = (metricaFora.variacaoDia || 0) + variacaoFora;
      
      // ‚úÖ NOVO: Calcular m√©dia de dividendos
      const totalJogosFora = (metricaFora.totalJogos || 0) + 1;
      const novaMediaDivFora = ((metricaFora.mediaDividendos || 0) * (metricaFora.totalJogos || 0) + dividendosFora) / totalJogosFora;

      batch.set(db.collection('bolsa_metricas_time').doc(timeForaId), {
        timeId: timeForaId,
        timeNome: timeFora?.nome || '',
        precoAlgoritmo: Math.round(novoPrecoAlgoFora * 100) / 100,
        precoMercado: metricaFora.precoMercado || PRECO_INICIAL,
        variacaoDia: Math.round(novaVariacaoFora * 100) / 100,
        mediaDividendos: Math.round(novaMediaDivFora * 1000) / 1000,  // ‚úÖ NOVO
        totalJogos: totalJogosFora,
        totalTorcedores: (metricaFora.totalTorcedores || 0) + torcidaFora,
        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      // Marcar jogo como processado
      batch.update(db.collection('jogos').doc(jogo.id), {
        bolsaProcessado: true,
        bolsaProcessadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });

      await batch.commit();

      logAdmin(`  üìà ${timeCasa?.nome}: ${variacaoCasa >= 0 ? '+' : ''}${variacaoCasa.toFixed(2)}% ‚Üí ${novoPrecoAlgoCasa.toFixed(2)} cr | Div: ${novaMediaDivCasa.toFixed(3)} cr`, variacaoCasa >= 0 ? 'success' : 'warn');
      logAdmin(`  üìà ${timeFora?.nome}: ${variacaoFora >= 0 ? '+' : ''}${variacaoFora.toFixed(2)}% ‚Üí ${novoPrecoAlgoFora.toFixed(2)} cr | Div: ${novaMediaDivFora.toFixed(3)} cr`, variacaoFora >= 0 ? 'success' : 'warn');
    }

    // Resetar varia√ß√£o di√°ria (rodar uma vez por dia)
    async function resetarVariacaoDiaria() {
      if (!confirm('Isso vai zerar a varia√ß√£o do dia de TODOS os times. Continuar?')) return;
      
      logAdmin('üîÑ Resetando varia√ß√£o di√°ria...', 'info');
      
      try {
        const batch = db.batch();
        
        for (const time of allTimes) {
          if (metricas[time.id]) {
            batch.update(db.collection('bolsa_metricas_time').doc(time.id), {
              variacaoDia: 0,
              ultimoResetDia: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        await batch.commit();
        logAdmin(`‚úÖ Varia√ß√£o zerada para ${allTimes.length} times`, 'success');
        showToast('‚úÖ Varia√ß√£o di√°ria resetada!');
        
        await carregarMetricas();
        renderizarTabelaMercado();
      } catch (e) {
        logAdmin(`‚ùå Erro: ${e.message}`, 'error');
        showToast('‚ùå Erro ao resetar varia√ß√£o');
      }
    }

    // Reprocessar todos os jogos (cuidado!)
    async function reprocessarTodosJogos() {
      if (!confirm('‚ö†Ô∏è Isso vai REPROCESSAR todos os jogos.\n\nOs pre√ßos v√£o mudar novamente!\n\nTem certeza?')) return;
      if (!confirm('√öLTIMA CHANCE: Realmente quer reprocessar?')) return;
      
      logAdmin('üîÑ Removendo flag de processamento...', 'warn');
      
      try {
        const jogosSnap = await db.collection('jogos')
          .where('bolsaProcessado', '==', true)
          .get();
        
        if (jogosSnap.empty) {
          logAdmin('Nenhum jogo para reprocessar', 'info');
          return;
        }

        const batch = db.batch();
        jogosSnap.forEach(doc => {
          batch.update(doc.ref, { bolsaProcessado: false });
        });
        
        await batch.commit();
        logAdmin(`‚úÖ ${jogosSnap.size} jogos prontos para reprocessamento`, 'success');
        
        // Agora processar
        await processarJogosParaBolsa();
      } catch (e) {
        logAdmin(`‚ùå Erro: ${e.message}`, 'error');
      }
    }

    // Verificar se √© admin e mostrar √°rea
    function verificarAdmin() {
      if (currentUserData?.isAdmin || currentUser?.email === 'admin@yellup.com') {
        document.getElementById('adminArea').style.display = 'block';
      }
    }

    // Chamar ap√≥s carregar dados
    const originalCarregarBolsa = carregarBolsa;
    carregarBolsa = async function() {
      await originalCarregarBolsa();
      verificarAdmin();
    };

    // Fechar modal ao clicar fora
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) fecharModal(modal.id);
      });
    });
  </script>

  <!-- √Årea Admin (s√≥ aparece para admins) -->
  <div id="adminArea" style="display: none; max-width: 1200px; margin: 40px auto; padding: 20px;">
    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 20px;">
      <h3 style="color: #ef4444; margin-bottom: 15px;">üîß Painel Admin - Bolsa</h3>
      
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
        <button onclick="processarJogosParaBolsa()" style="padding: 12px 20px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          üéÆ Processar Jogos Encerrados
        </button>
        
        <button onclick="resetarVariacaoDiaria()" style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          üîÑ Resetar Varia√ß√£o Di√°ria
        </button>
        
        <button onclick="inicializarMetricas()" style="padding: 12px 20px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          üìä Inicializar M√©tricas (500cr)
        </button>
        
        <button onclick="inicializarCotasDono()" style="padding: 12px 20px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          üíº Criar Cotas Dono Inicial
        </button>
        
        <button onclick="reprocessarTodosJogos()" style="padding: 12px 20px; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          ‚ö†Ô∏è Reprocessar Todos Jogos
        </button>
        
        <button onclick="resetCompleto()" style="padding: 12px 20px; background: #1a1a1a; border: 2px solid #ef4444; border-radius: 10px; color: #ef4444; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif;">
          üî• RESET COMPLETO
        </button>
      </div>
      
      <div id="adminLog" style="background: #0a0a0a; border-radius: 10px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em; display: none;">
        <!-- Log aparece aqui -->
      </div>
    </div>
  </div>
</body>
</html>
