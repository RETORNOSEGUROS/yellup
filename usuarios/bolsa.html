<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bolsa de Times - Yellup Stock</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0e141b;
      --bg-secondary: #1a2332;
      --bg-card: #232d3f;
      --text-primary: #e7eef7;
      --text-secondary: #a9b5c6;
      --accent: #ffb547;
      --accent-dark: #ff8c42;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* Header */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-back:hover { background: rgba(255, 255, 255, 0.2); }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
    }

    .logo-yellup {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-stock { color: var(--success); font-size: 0.8em; }

    .user-credits {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 181, 71, 0.1);
      border: 1px solid rgba(255, 181, 71, 0.3);
      border-radius: 10px;
    }

    .credits-value { font-weight: 700; color: var(--accent); }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-value.green { color: var(--success); }
    .stat-value.red { color: var(--danger); }

    .stat-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .tab-btn:hover { border-color: rgba(255, 181, 71, 0.5); }

    .tab-btn.active {
      border-color: var(--accent);
      background: rgba(255, 181, 71, 0.1);
      color: var(--accent);
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-input {
      flex: 1;
      padding: 14px 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Table */
    .table-container {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      overflow: hidden;
    }

    .stock-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stock-table th {
      background: rgba(255, 181, 71, 0.1);
      padding: 15px 10px;
      text-align: left;
      font-weight: 600;
      color: var(--accent);
      font-size: 0.8em;
      text-transform: uppercase;
    }

    .stock-table td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9em;
    }

    .stock-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
      cursor: pointer;
    }

    /* Team cell */
    .team-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .team-jersey { width: 35px; height: 40px; }

    .team-name { font-weight: 600; }
    .team-country { font-size: 0.75em; color: var(--text-secondary); }

    /* Price cells */
    .price-algo { font-weight: 700; color: var(--info); }
    .price-market { font-weight: 600; }

    /* Variation */
    .variation { font-weight: 600; display: flex; align-items: center; gap: 3px; }
    .variation.positive { color: var(--success); }
    .variation.negative { color: var(--danger); }
    .variation.neutral { color: var(--text-secondary); }

    /* Dividend */
    .dividend { color: var(--success); font-weight: 600; }

    /* Actions */
    .actions-cell { display: flex; gap: 6px; }

    .btn-buy, .btn-sell {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-buy {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
    }

    .btn-sell {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
    }

    .btn-buy:hover, .btn-sell:hover { transform: scale(1.05); }

    /* Portfolio Grid */
    .section-title {
      font-size: 1.2em;
      font-weight: 700;
      margin: 30px 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .portfolio-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .portfolio-card:hover {
      border-color: rgba(255, 181, 71, 0.4);
      transform: translateY(-3px);
    }

    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .portfolio-team {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .shares-count {
      font-size: 1.5em;
      font-weight: 800;
      color: var(--accent);
    }

    .shares-label {
      font-size: 0.7em;
      color: var(--text-secondary);
    }

    .portfolio-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .portfolio-stat { text-align: center; }
    .portfolio-stat-value { font-weight: 700; }
    .portfolio-stat-label { font-size: 0.7em; color: var(--text-secondary); }

    /* Orders */
    .orders-list { display: flex; flex-direction: column; gap: 10px; }

    .order-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 45, 63, 0.8) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-card.venda { border-left: 4px solid var(--danger); }
    .order-card.compra { border-left: 4px solid var(--success); }

    .order-type {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7em;
      font-weight: 700;
      text-transform: uppercase;
    }

    .order-type.venda { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .order-type.compra { background: rgba(16, 185, 129, 0.2); color: var(--success); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon { font-size: 4em; margin-bottom: 15px; }
    .empty-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title { font-size: 1.2em; font-weight: 700; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5em;
      cursor: pointer;
    }

    .modal-body { padding: 20px; }

    /* Modal Team Info */
    .modal-team-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .modal-team-info .team-jersey { width: 50px; height: 55px; }

    /* Price Comparison Box */
    .price-comparison {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .price-row:last-child { border-bottom: none; }

    .price-label { color: var(--text-secondary); font-size: 0.9em; }
    .price-value { font-weight: 700; }
    .price-value.algo { color: var(--info); }
    .price-value.market { color: var(--accent); }

    /* Deal Indicator */
    .deal-indicator {
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .deal-indicator.good {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--success);
    }

    .deal-indicator.neutral {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
    }

    .deal-indicator.expensive {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }

    /* Form */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .form-input:focus { outline: none; border-color: var(--accent); }

    /* Order Summary */
    .order-summary {
      background: rgba(255, 181, 71, 0.1);
      border: 1px solid rgba(255, 181, 71, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }

    .summary-row.total {
      border-top: 1px solid rgba(255, 181, 71, 0.3);
      margin-top: 10px;
      padding-top: 15px;
      font-weight: 700;
      font-size: 1.1em;
    }

    .summary-value { color: var(--accent); }

    /* Modal Actions */
    .modal-actions { display: flex; gap: 10px; }

    .btn-confirm {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-confirm.buy { background: linear-gradient(135deg, var(--success), #059669); color: white; }
    .btn-confirm.sell { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
    .btn-confirm:hover { transform: translateY(-2px); }

    .btn-cancel {
      flex: 1;
      padding: 14px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 30px;
      border-radius: 12px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Loading */
    .loading { display: flex; justify-content: center; padding: 40px; }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 181, 71, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .stock-table th:nth-child(4),
      .stock-table td:nth-child(4),
      .stock-table th:nth-child(5),
      .stock-table td:nth-child(5),
      .stock-table th:nth-child(6),
      .stock-table td:nth-child(6) {
        display: none;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="painel.html" class="btn-back">‚Üê Voltar</a>
        <div class="logo">
          <span class="logo-yellup">Yellup</span>
          <span class="logo-stock">STOCK</span>
        </div>
      </div>
      <div class="user-credits">
        <span>üí∞</span>
        <span class="credits-value" id="userCredits">0</span>
        <span>cr√©ditos</span>
      </div>
    </div>
  </header>

  <!-- Container -->
  <div class="container">
    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value" id="totalTimes">0</div>
        <div class="stat-label">Times Listados</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="volumeTotal">0</div>
        <div class="stat-label">Volume 24h</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="minhasCotas">0</div>
        <div class="stat-label">Minhas Cotas</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="valorCarteira">0</div>
        <div class="stat-label">Valor Carteira</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="dividendosRecebidos">0</div>
        <div class="stat-label">Dividendos Recebidos</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('mercado')">üìä Mercado</button>
      <button class="tab-btn" onclick="showTab('carteira')">üíº Minha Carteira</button>
      <button class="tab-btn" onclick="showTab('ordens')">üìã Minhas Ordens</button>
      <button class="tab-btn" onclick="showTab('historico')">üìú Hist√≥rico</button>
    </div>

    <!-- Tab: Mercado -->
    <div id="tab-mercado" class="tab-content">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="üîç Buscar time..." oninput="filterTimes()">
      </div>

      <div class="table-container">
        <table class="stock-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Pre√ßo Algoritmo</th>
              <th>Pre√ßo Mercado</th>
              <th>Varia√ß√£o</th>
              <th>M√©d. Dividendos</th>
              <th>Volume</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="stockTableBody">
            <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab: Carteira -->
    <div id="tab-carteira" class="tab-content" style="display: none;">
      <h3 class="section-title">üíº Minhas Cotas</h3>
      <div class="portfolio-grid" id="portfolioGrid">
        <div class="empty-state">
          <div class="empty-icon">üì≠</div>
          <div class="empty-title">Nenhuma cota ainda</div>
          <p>Compre cotas de times e comece a receber dividendos!</p>
        </div>
      </div>
    </div>

    <!-- Tab: Ordens -->
    <div id="tab-ordens" class="tab-content" style="display: none;">
      <h3 class="section-title">üìã Minhas Ordens Abertas</h3>
      <div class="orders-list" id="ordersList">
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <div class="empty-title">Nenhuma ordem aberta</div>
        </div>
      </div>
    </div>

    <!-- Tab: Hist√≥rico -->
    <div id="tab-historico" class="tab-content" style="display: none;">
      <h3 class="section-title">üìú Hist√≥rico de Transa√ß√µes</h3>
      <div class="orders-list" id="historicoList">
        <div class="empty-state">
          <div class="empty-icon">üìú</div>
          <div class="empty-title">Nenhuma transa√ß√£o ainda</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Comprar -->
  <div class="modal-overlay" id="modalComprar">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üõí Comprar Cotas</h2>
        <button class="modal-close" onclick="fecharModal('modalComprar')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-team-info">
          <svg class="team-jersey" id="modalComprarJersey" viewBox="0 0 100 120">
            <path d="M50 10 L30 20 L20 15 L5 30 L15 45 L20 40 L20 110 L80 110 L80 40 L85 45 L95 30 L80 15 L70 20 L50 10" fill="#28a745" stroke="#1a7431" stroke-width="2"/>
          </svg>
          <div>
            <h3 id="modalComprarTime">Time</h3>
            <span style="color: var(--text-secondary);" id="modalComprarPais">Pa√≠s</span>
          </div>
        </div>

        <!-- Comparativo de Pre√ßos -->
        <div class="price-comparison">
          <div class="price-row">
            <span class="price-label">üí° Pre√ßo Algoritmo (justo)</span>
            <span class="price-value algo" id="modalPrecoAlgo">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üè∑Ô∏è Menor Pre√ßo √† Venda</span>
            <span class="price-value market" id="modalPrecoVenda">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìä Diferen√ßa</span>
            <span class="price-value" id="modalDiferenca">0%</span>
          </div>
          <div class="price-row">
            <span class="price-label">üí∞ M√©dia Dividendos/Jogo</span>
            <span class="price-value" style="color: var(--success);" id="modalDividendos">0.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìà Jogos p/ Retorno</span>
            <span class="price-value" id="modalRetorno">- jogos</span>
          </div>
        </div>

        <!-- Indicador de Neg√≥cio -->
        <div class="deal-indicator good" id="dealIndicator">
          üü¢ Bom neg√≥cio! Pre√ßo igual ou abaixo do algoritmo
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade de cotas</label>
          <input type="number" class="form-input" id="inputQtdCompra" min="1" value="1" oninput="calcularTotalCompra()">
          <small style="color: var(--text-secondary);">Dispon√≠veis: <span id="cotasDisponiveis">0</span></small>
        </div>

        <div class="order-summary">
          <div class="summary-row">
            <span>Quantidade</span>
            <span class="summary-value" id="summaryQtdCompra">1 cotas</span>
          </div>
          <div class="summary-row">
            <span>Pre√ßo unit√°rio</span>
            <span class="summary-value" id="summaryPrecoCompra">1.00 cr</span>
          </div>
          <div class="summary-row total">
            <span>Total a pagar</span>
            <span class="summary-value" id="summaryTotalCompra">1.00 cr</span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="fecharModal('modalComprar')">Cancelar</button>
          <button class="btn-confirm buy" onclick="confirmarCompra()">‚úÖ Confirmar Compra</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Vender -->
  <div class="modal-overlay" id="modalVender">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üì§ Vender Cotas</h2>
        <button class="modal-close" onclick="fecharModal('modalVender')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-team-info">
          <svg class="team-jersey" id="modalVenderJersey" viewBox="0 0 100 120">
            <path d="M50 10 L30 20 L20 15 L5 30 L15 45 L20 40 L20 110 L80 110 L80 40 L85 45 L95 30 L80 15 L70 20 L50 10" fill="#28a745" stroke="#1a7431" stroke-width="2"/>
          </svg>
          <div>
            <h3 id="modalVenderTime">Time</h3>
            <span style="color: var(--text-secondary);">Suas cotas: <strong id="modalMinhasCotas">0</strong></span>
          </div>
        </div>

        <!-- Comparativo de Pre√ßos -->
        <div class="price-comparison">
          <div class="price-row">
            <span class="price-label">üí° Pre√ßo Algoritmo (justo)</span>
            <span class="price-value algo" id="modalVenderPrecoAlgo">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üìä M√©dia √öltimas Vendas</span>
            <span class="price-value" id="modalMediaVendas">1.00 cr</span>
          </div>
          <div class="price-row">
            <span class="price-label">üí∞ M√©dia Dividendos/Jogo</span>
            <span class="price-value" style="color: var(--success);" id="modalVenderDividendos">0.00 cr</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Quantidade de cotas para vender</label>
          <input type="number" class="form-input" id="inputQtdVenda" min="1" value="1" oninput="calcularTotalVenda()">
        </div>

        <div class="form-group">
          <label class="form-label">Pre√ßo por cota (cr√©ditos)</label>
          <input type="number" class="form-input" id="inputPrecoVenda" min="0.01" step="0.01" value="1.00" oninput="calcularTotalVenda()">
          <small style="color: var(--text-secondary);">Sugest√£o: entre <span id="sugestaoMin">0.90</span> e <span id="sugestaoMax">1.10</span> cr</small>
        </div>

        <div class="order-summary">
          <div class="summary-row">
            <span>Quantidade</span>
            <span class="summary-value" id="summaryQtdVenda">1 cotas</span>
          </div>
          <div class="summary-row">
            <span>Pre√ßo unit√°rio</span>
            <span class="summary-value" id="summaryPrecoVenda">1.00 cr</span>
          </div>
          <div class="summary-row total">
            <span>Total a receber</span>
            <span class="summary-value" id="summaryTotalVenda">1.00 cr</span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" onclick="fecharModal('modalVender')">Cancelar</button>
          <button class="btn-confirm sell" onclick="confirmarVenda()">üì§ Criar Ordem de Venda</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ==================== CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================== CONSTANTES ====================
    const DONO_INICIAL_ID = 'GfpBgfT9e8g5GaTQruvX6YcwtE23';
    const COTAS_POR_TIME = 1000;
    const PRECO_INICIAL = 1.00;

    // Pesos de valoriza√ß√£o/desvaloriza√ß√£o
    const CONFIG_VALORIZACAO = {
      porJogo: 0.5,              // +0.5% por jogo participado
      porTorcedor: 0.05,         // +0.05% por torcedor
      porVitoriaTorcida: 2.0,    // +2% maior torcida
      porPonto: 0.005,           // +0.005% por ponto
      porVitoriaPontuacao: 3.0,  // +3% maior pontua√ß√£o
      maxVariacao: 15,           // ¬±15% m√°ximo
      
      porDerrotaTorcida: 1.5,    // -1.5% menor torcida
      porDerrotaPontuacao: 2.0,  // -2% menor pontua√ß√£o
      
      pesoAjusteMercado: 0.5,    // 50% da diferen√ßa
      maxAjusteMercado: 5        // ¬±5% m√°ximo ajuste mercado
    };

    // ==================== VARI√ÅVEIS GLOBAIS ====================
    let currentUser = null;
    let currentUserData = null;
    let allTimes = [];
    let metricas = {};      // M√©tricas por time
    let minhasCotas = {};   // Minhas cotas
    let ordensAbertas = []; // Minhas ordens
    let ordens = {};        // Ordens por time (para compra)

    let modalTimeAtual = null;

    // ==================== AUTH ====================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await carregarDadosUsuario();
        await carregarBolsa();
      } else {
        window.location.href = 'index.html';
      }
    });

    async function carregarDadosUsuario() {
      const doc = await db.collection('usuarios').doc(currentUser.uid).get();
      if (doc.exists) {
        currentUserData = doc.data();
        document.getElementById('userCredits').textContent = (currentUserData.creditos || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
      }
    }

    // ==================== CARREGAR BOLSA ====================
    async function carregarBolsa() {
      try {
        // Carregar times
        const timesSnap = await db.collection('times').orderBy('nome').get();
        allTimes = [];
        timesSnap.forEach(doc => allTimes.push({ id: doc.id, ...doc.data() }));
        document.getElementById('totalTimes').textContent = allTimes.length;

        // Carregar m√©tricas
        await carregarMetricas();

        // Carregar minhas cotas
        await carregarMinhasCotas();

        // Carregar ordens abertas (para book de ofertas)
        await carregarOrdensAbertas();

        // Carregar minhas ordens
        await carregarMinhasOrdens();

        // Renderizar
        renderizarTabelaMercado();

      } catch (error) {
        console.error('Erro ao carregar bolsa:', error);
        showToast('‚ùå Erro ao carregar dados');
      }
    }

    async function carregarMetricas() {
      const metricasSnap = await db.collection('bolsa_metricas_time').get();
      metricas = {};
      metricasSnap.forEach(doc => {
        metricas[doc.id] = doc.data();
      });

      // Para times sem m√©tricas, usar valores iniciais
      allTimes.forEach(time => {
        if (!metricas[time.id]) {
          metricas[time.id] = {
            precoAlgoritmo: PRECO_INICIAL,
            precoMercado: PRECO_INICIAL,
            mediaDividendos: 0,
            totalJogos: 0,
            totalTorcedores: 0,
            variacaoDia: 0
          };
        }
      });
    }

    async function carregarMinhasCotas() {
      const cotasSnap = await db.collection('bolsa_cotas')
        .where('userId', '==', currentUser.uid)
        .get();

      minhasCotas = {};
      let totalCotas = 0;
      let valorTotal = 0;

      cotasSnap.forEach(doc => {
        const data = doc.data();
        minhasCotas[data.timeId] = { id: doc.id, ...data };
        totalCotas += data.quantidade;
        const preco = metricas[data.timeId]?.precoAlgoritmo || PRECO_INICIAL;
        valorTotal += data.quantidade * preco;
      });

      document.getElementById('minhasCotas').textContent = totalCotas.toLocaleString('pt-BR');
      document.getElementById('valorCarteira').textContent = valorTotal.toFixed(2);
    }

    async function carregarOrdensAbertas() {
      const ordensSnap = await db.collection('bolsa_ordens')
        .where('tipo', '==', 'venda')
        .where('status', 'in', ['aberta', 'parcial'])
        .get();

      ordens = {};
      ordensSnap.forEach(doc => {
        const data = doc.data();
        if (!ordens[data.timeId]) {
          ordens[data.timeId] = [];
        }
        ordens[data.timeId].push({ id: doc.id, ...data });
      });

      // Ordenar por pre√ßo (menor primeiro)
      Object.keys(ordens).forEach(timeId => {
        ordens[timeId].sort((a, b) => a.precoUnitario - b.precoUnitario);
      });
    }

    async function carregarMinhasOrdens() {
      const ordensSnap = await db.collection('bolsa_ordens')
        .where('userId', '==', currentUser.uid)
        .where('status', 'in', ['aberta', 'parcial'])
        .get();

      ordensAbertas = [];
      ordensSnap.forEach(doc => {
        ordensAbertas.push({ id: doc.id, ...doc.data() });
      });
    }

    // ==================== RENDERIZAR ====================
    function renderizarTabelaMercado() {
      const tbody = document.getElementById('stockTableBody');
      
      if (allTimes.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Nenhum time encontrado</div></div></td></tr>`;
        return;
      }

      let html = '';
      let volumeTotal = 0;

      allTimes.forEach(time => {
        const m = metricas[time.id] || {};
        const precoAlgo = m.precoAlgoritmo || PRECO_INICIAL;
        const precoMercado = m.precoMercado || PRECO_INICIAL;
        const variacao = m.variacaoDia || 0;
        const dividendos = m.mediaDividendos || 0;
        const volume = m.volumeDia || 0;
        volumeTotal += volume;

        // Menor pre√ßo √† venda
        const ordensTime = ordens[time.id] || [];
        const menorPrecoVenda = ordensTime.length > 0 ? ordensTime[0].precoUnitario : precoAlgo;
        const cotasDisponiveis = ordensTime.reduce((sum, o) => sum + o.quantidadeRestante, 0);

        const varClass = variacao > 0 ? 'positive' : variacao < 0 ? 'negative' : 'neutral';
        const varIcon = variacao > 0 ? '‚ñ≤' : variacao < 0 ? '‚ñº' : '‚óè';

        html += `
          <tr data-time="${time.nome.toLowerCase()}">
            <td>
              <div class="team-cell">
                <svg class="team-jersey" viewBox="0 0 100 120">
                  <path d="M50 10 L30 20 L20 15 L5 30 L15 45 L20 40 L20 110 L80 110 L80 40 L85 45 L95 30 L80 15 L70 20 L50 10" 
                        fill="${time.primaria || '#28a745'}" stroke="${time.secundaria || '#1a7431'}" stroke-width="2"/>
                </svg>
                <div>
                  <div class="team-name">${time.nome}</div>
                  <div class="team-country">${time.pais || ''}</div>
                </div>
              </div>
            </td>
            <td class="price-algo">${precoAlgo.toFixed(2)} cr</td>
            <td class="price-market">${menorPrecoVenda.toFixed(2)} cr</td>
            <td><span class="variation ${varClass}">${varIcon} ${variacao >= 0 ? '+' : ''}${variacao.toFixed(2)}%</span></td>
            <td class="dividend">${dividendos.toFixed(3)} cr</td>
            <td>${volume}</td>
            <td>
              <div class="actions-cell">
                <button class="btn-buy" onclick="abrirModalCompra('${time.id}')">Comprar</button>
                <button class="btn-sell" onclick="abrirModalVenda('${time.id}')">Vender</button>
              </div>
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      document.getElementById('volumeTotal').textContent = volumeTotal;
    }

    // ==================== FILTRAR ====================
    function filterTimes() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('#stockTableBody tr').forEach(row => {
        const timeNome = row.getAttribute('data-time') || '';
        row.style.display = timeNome.includes(search) ? '' : 'none';
      });
    }

    // ==================== TABS ====================
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).style.display = 'block';
      event.target.classList.add('active');

      if (tabName === 'carteira') renderizarCarteira();
      else if (tabName === 'ordens') renderizarOrdens();
      else if (tabName === 'historico') renderizarHistorico();
    }

    function renderizarCarteira() {
      const grid = document.getElementById('portfolioGrid');
      const cotasArray = Object.entries(minhasCotas);
      
      if (cotasArray.length === 0) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">Nenhuma cota ainda</div><p>Compre cotas e comece a receber dividendos!</p></div>`;
        return;
      }

      let html = '';
      cotasArray.forEach(([timeId, cota]) => {
        const time = allTimes.find(t => t.id === timeId) || {};
        const m = metricas[timeId] || {};
        const preco = m.precoAlgoritmo || PRECO_INICIAL;
        const valorTotal = (cota.quantidade * preco).toFixed(2);
        const lucro = ((preco - (cota.precoMedioAquisicao || PRECO_INICIAL)) * cota.quantidade).toFixed(2);

        html += `
          <div class="portfolio-card">
            <div class="portfolio-header">
              <div class="portfolio-team">
                <svg class="team-jersey" viewBox="0 0 100 120" style="width: 35px; height: 40px;">
                  <path d="M50 10 L30 20 L20 15 L5 30 L15 45 L20 40 L20 110 L80 110 L80 40 L85 45 L95 30 L80 15 L70 20 L50 10" 
                        fill="${time.primaria || '#28a745'}" stroke="${time.secundaria || '#1a7431'}" stroke-width="2"/>
                </svg>
                <span style="font-weight: 600;">${time.nome || 'Time'}</span>
              </div>
              <div style="text-align: right;">
                <div class="shares-count">${cota.quantidade}</div>
                <div class="shares-label">cotas</div>
              </div>
            </div>
            <div class="portfolio-stats">
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${preco.toFixed(2)} cr</div>
                <div class="portfolio-stat-label">Pre√ßo atual</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${valorTotal} cr</div>
                <div class="portfolio-stat-label">Valor total</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value">${(cota.precoMedioAquisicao || PRECO_INICIAL).toFixed(2)} cr</div>
                <div class="portfolio-stat-label">Pre√ßo m√©dio</div>
              </div>
              <div class="portfolio-stat">
                <div class="portfolio-stat-value" style="color: ${lucro >= 0 ? 'var(--success)' : 'var(--danger)'}">${lucro >= 0 ? '+' : ''}${lucro} cr</div>
                <div class="portfolio-stat-label">Lucro/Preju√≠zo</div>
              </div>
            </div>
          </div>
        `;
      });

      grid.innerHTML = html;
    }

    function renderizarOrdens() {
      const list = document.getElementById('ordersList');
      
      if (ordensAbertas.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Nenhuma ordem aberta</div></div>`;
        return;
      }

      let html = '';
      ordensAbertas.forEach(ordem => {
        html += `
          <div class="order-card ${ordem.tipo}">
            <div style="display: flex; align-items: center; gap: 15px;">
              <span class="order-type ${ordem.tipo}">${ordem.tipo}</span>
              <div>
                <h4>${ordem.timeNome}</h4>
                <span style="font-size: 0.85em; color: var(--text-secondary);">${ordem.quantidadeRestante}/${ordem.quantidade} cotas</span>
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; color: var(--accent);">${ordem.precoUnitario.toFixed(2)} cr/cota</div>
              <div style="font-size: 0.85em; color: var(--text-secondary);">Total: ${(ordem.quantidadeRestante * ordem.precoUnitario).toFixed(2)} cr</div>
            </div>
          </div>
        `;
      });

      list.innerHTML = html;
    }

    async function renderizarHistorico() {
      const list = document.getElementById('historicoList');
      
      try {
        const [compras, vendas] = await Promise.all([
          db.collection('bolsa_transacoes').where('compradorId', '==', currentUser.uid).orderBy('dataTransacao', 'desc').limit(25).get(),
          db.collection('bolsa_transacoes').where('vendedorId', '==', currentUser.uid).orderBy('dataTransacao', 'desc').limit(25).get()
        ]);

        const transacoes = [];
        compras.forEach(doc => transacoes.push({ ...doc.data(), tipo: 'compra' }));
        vendas.forEach(doc => transacoes.push({ ...doc.data(), tipo: 'venda' }));
        transacoes.sort((a, b) => (b.dataTransacao?.toMillis() || 0) - (a.dataTransacao?.toMillis() || 0));

        if (transacoes.length === 0) {
          list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìú</div><div class="empty-title">Nenhuma transa√ß√£o</div></div>`;
          return;
        }

        let html = '';
        transacoes.slice(0, 30).forEach(t => {
          const data = t.dataTransacao?.toDate().toLocaleString('pt-BR') || '';
          html += `
            <div class="order-card ${t.tipo}">
              <div style="display: flex; align-items: center; gap: 15px;">
                <span class="order-type ${t.tipo}">${t.tipo}</span>
                <div>
                  <h4>${t.timeNome}</h4>
                  <span style="font-size: 0.8em; color: var(--text-secondary);">${data}</span>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 700;">${t.quantidade} cotas</div>
                <div style="font-size: 0.85em; color: var(--accent);">${t.valorTotal.toFixed(2)} cr</div>
              </div>
            </div>
          `;
        });

        list.innerHTML = html;
      } catch (error) {
        console.error(error);
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ùå</div><div class="empty-title">Erro ao carregar</div></div>`;
      }
    }

    // ==================== MODAL COMPRAR ====================
    function abrirModalCompra(timeId) {
      const time = allTimes.find(t => t.id === timeId);
      if (!time) return;

      modalTimeAtual = time;
      const m = metricas[timeId] || {};
      const ordensTime = ordens[timeId] || [];

      const precoAlgo = m.precoAlgoritmo || PRECO_INICIAL;
      const menorPrecoVenda = ordensTime.length > 0 ? ordensTime[0].precoUnitario : precoAlgo;
      const cotasDisp = ordensTime.reduce((sum, o) => sum + o.quantidadeRestante, 0);
      const dividendos = m.mediaDividendos || 0;
      const diferenca = precoAlgo > 0 ? ((menorPrecoVenda - precoAlgo) / precoAlgo * 100) : 0;
      const jogosRetorno = dividendos > 0 ? Math.ceil(menorPrecoVenda / dividendos) : 999;

      // Atualizar modal
      document.getElementById('modalComprarTime').textContent = time.nome;
      document.getElementById('modalComprarPais').textContent = time.pais || '';
      document.getElementById('modalPrecoAlgo').textContent = precoAlgo.toFixed(2) + ' cr';
      document.getElementById('modalPrecoVenda').textContent = menorPrecoVenda.toFixed(2) + ' cr';
      document.getElementById('modalDiferenca').textContent = (diferenca >= 0 ? '+' : '') + diferenca.toFixed(1) + '%';
      document.getElementById('modalDiferenca').style.color = diferenca <= 0 ? 'var(--success)' : diferenca <= 10 ? 'var(--warning)' : 'var(--danger)';
      document.getElementById('modalDividendos').textContent = dividendos.toFixed(3) + ' cr';
      document.getElementById('modalRetorno').textContent = jogosRetorno < 999 ? jogosRetorno + ' jogos' : '‚àû';
      document.getElementById('cotasDisponiveis').textContent = cotasDisp || '0 (sem ofertas)';
      document.getElementById('inputQtdCompra').value = 1;
      document.getElementById('inputQtdCompra').max = cotasDisp;

      // Indicador de neg√≥cio
      const indicator = document.getElementById('dealIndicator');
      if (diferenca <= 0) {
        indicator.className = 'deal-indicator good';
        indicator.innerHTML = 'üü¢ Bom neg√≥cio! Pre√ßo igual ou abaixo do algoritmo';
      } else if (diferenca <= 10) {
        indicator.className = 'deal-indicator neutral';
        indicator.innerHTML = 'üü° Pre√ßo levemente acima do algoritmo';
      } else {
        indicator.className = 'deal-indicator expensive';
        indicator.innerHTML = 'üî¥ Cuidado! Pre√ßo muito acima do justo';
      }

      // Atualizar camisa
      const jersey = document.querySelector('#modalComprarJersey path');
      jersey.setAttribute('fill', time.primaria || '#28a745');
      jersey.setAttribute('stroke', time.secundaria || '#1a7431');

      calcularTotalCompra();
      document.getElementById('modalComprar').classList.add('active');
    }

    function calcularTotalCompra() {
      const qtd = parseInt(document.getElementById('inputQtdCompra').value) || 0;
      const ordensTime = ordens[modalTimeAtual?.id] || [];
      const preco = ordensTime.length > 0 ? ordensTime[0].precoUnitario : (metricas[modalTimeAtual?.id]?.precoAlgoritmo || PRECO_INICIAL);
      const total = qtd * preco;

      document.getElementById('summaryQtdCompra').textContent = qtd + ' cotas';
      document.getElementById('summaryPrecoCompra').textContent = preco.toFixed(2) + ' cr';
      document.getElementById('summaryTotalCompra').textContent = total.toFixed(2) + ' cr';
    }

    async function confirmarCompra() {
      if (!modalTimeAtual) return;

      const qtd = parseInt(document.getElementById('inputQtdCompra').value) || 0;
      if (qtd <= 0) return showToast('‚ùå Quantidade inv√°lida');

      const ordensTime = ordens[modalTimeAtual.id] || [];
      if (ordensTime.length === 0) {
        // Comprar do dono inicial
        await comprarDoDonoInicial(qtd);
        return;
      }

      const ordem = ordensTime[0];
      if (ordem.quantidadeRestante < qtd) {
        return showToast(`‚ùå Apenas ${ordem.quantidadeRestante} cotas dispon√≠veis`);
      }

      const valorTotal = qtd * ordem.precoUnitario;
      if ((currentUserData.creditos || 0) < valorTotal) {
        return showToast('‚ùå Cr√©ditos insuficientes');
      }

      try {
        const batch = db.batch();

        // 1. Debitar comprador
        batch.update(db.collection('usuarios').doc(currentUser.uid), {
          creditos: firebase.firestore.FieldValue.increment(-valorTotal)
        });

        // 2. Creditar vendedor
        batch.update(db.collection('usuarios').doc(ordem.userId), {
          creditos: firebase.firestore.FieldValue.increment(valorTotal)
        });

        // 3. Atualizar/criar cotas comprador
        const cotaComprador = await db.collection('bolsa_cotas')
          .where('timeId', '==', modalTimeAtual.id)
          .where('userId', '==', currentUser.uid)
          .get();

        if (cotaComprador.empty) {
          batch.set(db.collection('bolsa_cotas').doc(), {
            timeId: modalTimeAtual.id,
            timeNome: modalTimeAtual.nome,
            userId: currentUser.uid,
            usuarioNome: currentUserData.usuarioUnico || currentUserData.nome,
            quantidade: qtd,
            precoMedioAquisicao: ordem.precoUnitario,
            dataAquisicao: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          const cotaDoc = cotaComprador.docs[0];
          const cotaAtual = cotaDoc.data();
          const novaQtd = cotaAtual.quantidade + qtd;
          const novoPreco = ((cotaAtual.quantidade * cotaAtual.precoMedioAquisicao) + (qtd * ordem.precoUnitario)) / novaQtd;
          batch.update(cotaDoc.ref, { quantidade: novaQtd, precoMedioAquisicao: novoPreco });
        }

        // 4. Atualizar cotas vendedor
        const cotaVendedor = await db.collection('bolsa_cotas')
          .where('timeId', '==', modalTimeAtual.id)
          .where('userId', '==', ordem.userId)
          .get();

        if (!cotaVendedor.empty) {
          const cotaVDoc = cotaVendedor.docs[0];
          const novaQtdV = cotaVDoc.data().quantidade - qtd;
          if (novaQtdV <= 0) {
            batch.delete(cotaVDoc.ref);
          } else {
            batch.update(cotaVDoc.ref, { quantidade: novaQtdV });
          }
        }

        // 5. Atualizar ordem
        const novaQtdOrdem = ordem.quantidadeRestante - qtd;
        batch.update(db.collection('bolsa_ordens').doc(ordem.id), {
          quantidadeRestante: novaQtdOrdem,
          status: novaQtdOrdem <= 0 ? 'concluida' : 'parcial',
          dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 6. Registrar transa√ß√£o
        batch.set(db.collection('bolsa_transacoes').doc(), {
          timeId: modalTimeAtual.id,
          timeNome: modalTimeAtual.nome,
          vendedorId: ordem.userId,
          vendedorNome: ordem.usuarioNome,
          compradorId: currentUser.uid,
          compradorNome: currentUserData.usuarioUnico || currentUserData.nome,
          quantidade: qtd,
          precoUnitario: ordem.precoUnitario,
          valorTotal: valorTotal,
          dataTransacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();

        showToast(`‚úÖ Compra realizada! ${qtd} cotas de ${modalTimeAtual.nome}`);
        fecharModal('modalComprar');
        await carregarDadosUsuario();
        await carregarMinhasCotas();
        await carregarOrdensAbertas();
        renderizarTabelaMercado();

      } catch (error) {
        console.error(error);
        showToast('‚ùå Erro ao processar compra');
      }
    }

    async function comprarDoDonoInicial(qtd) {
      const precoAlgo = metricas[modalTimeAtual.id]?.precoAlgoritmo || PRECO_INICIAL;
      const valorTotal = qtd * precoAlgo;

      if ((currentUserData.creditos || 0) < valorTotal) {
        return showToast('‚ùå Cr√©ditos insuficientes');
      }

      // Verificar se dono inicial tem cotas
      const cotaDonoSnap = await db.collection('bolsa_cotas')
        .where('timeId', '==', modalTimeAtual.id)
        .where('userId', '==', DONO_INICIAL_ID)
        .get();

      if (cotaDonoSnap.empty) {
        return showToast('‚ùå Sem cotas dispon√≠veis');
      }

      const cotaDono = cotaDonoSnap.docs[0];
      if (cotaDono.data().quantidade < qtd) {
        return showToast(`‚ùå Apenas ${cotaDono.data().quantidade} cotas dispon√≠veis`);
      }

      try {
        const batch = db.batch();

        // Debitar comprador
        batch.update(db.collection('usuarios').doc(currentUser.uid), {
          creditos: firebase.firestore.FieldValue.increment(-valorTotal)
        });

        // Creditar dono inicial
        batch.update(db.collection('usuarios').doc(DONO_INICIAL_ID), {
          creditos: firebase.firestore.FieldValue.increment(valorTotal)
        });

        // Criar/atualizar cotas comprador
        const cotaComprador = await db.collection('bolsa_cotas')
          .where('timeId', '==', modalTimeAtual.id)
          .where('userId', '==', currentUser.uid)
          .get();

        if (cotaComprador.empty) {
          batch.set(db.collection('bolsa_cotas').doc(), {
            timeId: modalTimeAtual.id,
            timeNome: modalTimeAtual.nome,
            userId: currentUser.uid,
            usuarioNome: currentUserData.usuarioUnico || currentUserData.nome,
            quantidade: qtd,
            precoMedioAquisicao: precoAlgo,
            dataAquisicao: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          const cotaDoc = cotaComprador.docs[0];
          const cotaAtual = cotaDoc.data();
          const novaQtd = cotaAtual.quantidade + qtd;
          const novoPreco = ((cotaAtual.quantidade * cotaAtual.precoMedioAquisicao) + (qtd * precoAlgo)) / novaQtd;
          batch.update(cotaDoc.ref, { quantidade: novaQtd, precoMedioAquisicao: novoPreco });
        }

        // Diminuir cotas do dono inicial
        const novaQtdDono = cotaDono.data().quantidade - qtd;
        if (novaQtdDono <= 0) {
          batch.delete(cotaDono.ref);
        } else {
          batch.update(cotaDono.ref, { quantidade: novaQtdDono });
        }

        // Registrar transa√ß√£o
        batch.set(db.collection('bolsa_transacoes').doc(), {
          timeId: modalTimeAtual.id,
          timeNome: modalTimeAtual.nome,
          vendedorId: DONO_INICIAL_ID,
          vendedorNome: 'guruh',
          compradorId: currentUser.uid,
          compradorNome: currentUserData.usuarioUnico || currentUserData.nome,
          quantidade: qtd,
          precoUnitario: precoAlgo,
          valorTotal: valorTotal,
          dataTransacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        await batch.commit();

        showToast(`‚úÖ Compra realizada! ${qtd} cotas de ${modalTimeAtual.nome}`);
        fecharModal('modalComprar');
        await carregarDadosUsuario();
        await carregarMinhasCotas();
        renderizarTabelaMercado();

      } catch (error) {
        console.error(error);
        showToast('‚ùå Erro ao processar compra');
      }
    }

    // ==================== MODAL VENDER ====================
    function abrirModalVenda(timeId) {
      const time = allTimes.find(t => t.id === timeId);
      if (!time) return;

      const minhaCota = minhasCotas[timeId];
      if (!minhaCota || minhaCota.quantidade <= 0) {
        return showToast('‚ùå Voc√™ n√£o possui cotas deste time');
      }

      modalTimeAtual = time;
      const m = metricas[timeId] || {};
      const precoAlgo = m.precoAlgoritmo || PRECO_INICIAL;
      const precoMercado = m.precoMercado || PRECO_INICIAL;
      const dividendos = m.mediaDividendos || 0;

      document.getElementById('modalVenderTime').textContent = time.nome;
      document.getElementById('modalMinhasCotas').textContent = minhaCota.quantidade;
      document.getElementById('modalVenderPrecoAlgo').textContent = precoAlgo.toFixed(2) + ' cr';
      document.getElementById('modalMediaVendas').textContent = precoMercado.toFixed(2) + ' cr';
      document.getElementById('modalVenderDividendos').textContent = dividendos.toFixed(3) + ' cr';
      document.getElementById('inputQtdVenda').value = 1;
      document.getElementById('inputQtdVenda').max = minhaCota.quantidade;
      document.getElementById('inputPrecoVenda').value = precoAlgo.toFixed(2);
      document.getElementById('sugestaoMin').textContent = (precoAlgo * 0.9).toFixed(2);
      document.getElementById('sugestaoMax').textContent = (precoAlgo * 1.1).toFixed(2);

      const jersey = document.querySelector('#modalVenderJersey path');
      jersey.setAttribute('fill', time.primaria || '#28a745');
      jersey.setAttribute('stroke', time.secundaria || '#1a7431');

      calcularTotalVenda();
      document.getElementById('modalVender').classList.add('active');
    }

    function calcularTotalVenda() {
      const qtd = parseInt(document.getElementById('inputQtdVenda').value) || 0;
      const preco = parseFloat(document.getElementById('inputPrecoVenda').value) || 0;
      const total = qtd * preco;

      document.getElementById('summaryQtdVenda').textContent = qtd + ' cotas';
      document.getElementById('summaryPrecoVenda').textContent = preco.toFixed(2) + ' cr';
      document.getElementById('summaryTotalVenda').textContent = total.toFixed(2) + ' cr';
    }

    async function confirmarVenda() {
      if (!modalTimeAtual) return;

      const qtd = parseInt(document.getElementById('inputQtdVenda').value) || 0;
      const preco = parseFloat(document.getElementById('inputPrecoVenda').value) || 0;

      if (qtd <= 0) return showToast('‚ùå Quantidade inv√°lida');
      if (preco <= 0) return showToast('‚ùå Pre√ßo inv√°lido');

      const minhaCota = minhasCotas[modalTimeAtual.id];
      if (!minhaCota || minhaCota.quantidade < qtd) {
        return showToast('‚ùå Cotas insuficientes');
      }

      try {
        await db.collection('bolsa_ordens').add({
          tipo: 'venda',
          timeId: modalTimeAtual.id,
          timeNome: modalTimeAtual.nome,
          userId: currentUser.uid,
          usuarioNome: currentUserData.usuarioUnico || currentUserData.nome,
          quantidade: qtd,
          precoUnitario: preco,
          valorTotal: qtd * preco,
          quantidadeRestante: qtd,
          status: 'aberta',
          dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
          dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`‚úÖ Ordem criada! ${qtd} cotas a ${preco.toFixed(2)} cr`);
        fecharModal('modalVender');
        await carregarMinhasOrdens();
        await carregarOrdensAbertas();
        renderizarTabelaMercado();

      } catch (error) {
        console.error(error);
        showToast('‚ùå Erro ao criar ordem');
      }
    }

    // ==================== UTILS ====================
    function fecharModal(id) {
      document.getElementById(id).classList.remove('active');
      modalTimeAtual = null;
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Fechar modal ao clicar fora
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) fecharModal(modal.id);
      });
    });
  </script>
</body>
</html>
