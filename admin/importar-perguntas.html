<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar Perguntas V2 - Yellup Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b, #1a2332);
      color: #e7eef7;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 { color: #ffb547; margin-bottom: 5px; }
    .header p { color: #a9b5c6; font-size: 0.9rem; }
    .version-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 3px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      margin-left: 10px;
    }
    
    .card {
      background: rgba(30, 41, 54, 0.9);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .card-title {
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card-title .material-icons { color: #ffb547; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value { font-size: 1.8em; font-weight: 700; color: #ffb547; }
    .stat-label { font-size: 0.8em; color: #a9b5c6; }
    .stat-item.times .stat-value { color: #38ef7d; }
    .stat-item.camps .stat-value { color: #667eea; }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,181,71,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-success { background: #22c55e; color: white; }
    .btn-success:hover { background: #16a34a; }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
    
    .progress-container {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-bar {
      height: 35px;
      background: linear-gradient(90deg, #ffb547, #ff8c42);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #0e141b;
    }
    
    .log {
      background: #0e141b;
      border-radius: 10px;
      padding: 15px;
      max-height: 250px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }
    .log-item { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    .log-warning { color: #f59e0b; }
    
    /* Preview melhorado */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding: 10px 0;
    }
    .preview-item {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid #ffb547;
    }
    .preview-item.time { border-left-color: #38ef7d; }
    .preview-item.camp { border-left-color: #667eea; }
    .preview-item .nome {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .preview-item .nome .icon { font-size: 1.2rem; }
    .preview-item .count {
      background: rgba(255,255,255,0.1);
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
    }
    .preview-item.time .count { color: #38ef7d; }
    .preview-item.camp .count { color: #667eea; }
    
    textarea {
      width: 100%;
      height: 200px;
      background: #0e141b;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 15px;
      color: #e7eef7;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #ffb547;
    }
    
    .upload-area {
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .upload-area:hover { border-color: #ffb547; background: rgba(255,181,71,0.1); }
    .upload-area.dragover { border-color: #ffb547; background: rgba(255,181,71,0.2); }
    .upload-area .material-icons { font-size: 48px; color: #ffb547; margin-bottom: 10px; }
    .upload-area p { color: #a9b5c6; }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: #a9b5c6;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn:hover { background: rgba(255,255,255,0.1); }
    .tab-btn.active {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
      border-color: transparent;
    }
    
    .validation-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .validation-item {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .validation-item.ok { border-left: 3px solid #22c55e; }
    .validation-item.warning { border-left: 3px solid #f59e0b; }
    .validation-item.error { border-left: 3px solid #ef4444; }
    .validation-item .material-icons.ok { color: #22c55e; }
    .validation-item .material-icons.warning { color: #f59e0b; }
    .validation-item .material-icons.error { color: #ef4444; }
    
    .sample-json {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre;
      color: #a9b5c6;
      max-height: 300px;
      overflow-y: auto;
    }
    .sample-json .key { color: #f59e0b; }
    .sample-json .string { color: #22c55e; }
    .sample-json .number { color: #667eea; }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: #fff;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast-success { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0,0,0,0.3);
      border-top-color: #0e141b;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .preview-grid { grid-template-columns: 1fr; }
      .tabs { flex-wrap: wrap; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ“š Importar Perguntas <span class="version-badge">V2</span></h1>
    <p>Suporta Times + Campeonatos â€¢ IDs personalizados (santos-001) â€¢ ValidaÃ§Ã£o automÃ¡tica</p>
  </div>

  <!-- Stats -->
  <div class="card">
    <h3 class="card-title">
      <span class="material-icons">analytics</span>
      EstatÃ­sticas do Banco
    </h3>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value" id="totalPerguntas">-</div>
        <div class="stat-label">Total no Banco</div>
      </div>
      <div class="stat-item times">
        <div class="stat-value" id="totalTimes">-</div>
        <div class="stat-label">âš½ De Times</div>
      </div>
      <div class="stat-item camps">
        <div class="stat-value" id="totalCamps">-</div>
        <div class="stat-label">ğŸ† De Campeonatos</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="perguntasCarregadas">0</div>
        <div class="stat-label">Para Importar</div>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="verificarBanco()">
      <span class="material-icons">refresh</span>
      Atualizar Stats
    </button>
  </div>

  <!-- Upload -->
  <div class="card">
    <h3 class="card-title">
      <span class="material-icons">upload_file</span>
      Carregar Perguntas
    </h3>
    
    <div class="upload-area" id="uploadArea">
      <span class="material-icons">cloud_upload</span>
      <p>Arraste um arquivo JSON ou clique para selecionar</p>
      <input type="file" id="fileInput" accept=".json" style="display: none;">
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="mostrarTab('colar')">ğŸ“‹ Colar JSON</button>
      <button class="tab-btn" onclick="mostrarTab('exemplo')">ğŸ“– Ver Formato</button>
    </div>
    
    <div id="tabColar">
      <textarea id="jsonInput" placeholder='Cole o JSON aqui...

Formatos aceitos:
â€¢ Array: [{"pergunta": "...", ...}, ...]
â€¢ Objeto: {"001": {"pergunta": "...", ...}, ...}

Campos obrigatÃ³rios:
â€¢ pergunta, alternativas, correta
â€¢ timeId OU campeonatoId (pelo menos um)'></textarea>
      <br><br>
      <button class="btn btn-primary" onclick="carregarJSON()">
        <span class="material-icons">play_arrow</span>
        Processar JSON
      </button>
    </div>
    
    <div id="tabExemplo" style="display: none;">
      <h4 style="margin-bottom: 15px; color: #ffb547;">ğŸ“‹ Formato Esperado (V5 compatÃ­vel)</h4>
      <div class="sample-json" id="sampleJson"></div>
    </div>
  </div>

  <!-- ValidaÃ§Ã£o -->
  <div class="card" id="validationCard" style="display: none;">
    <h3 class="card-title">
      <span class="material-icons">fact_check</span>
      ValidaÃ§Ã£o
    </h3>
    <div class="validation-summary" id="validationSummary"></div>
  </div>

  <!-- Preview -->
  <div class="card" id="previewCard" style="display: none;">
    <h3 class="card-title">
      <span class="material-icons">preview</span>
      Preview - Perguntas por Entidade
    </h3>
    <div class="preview-grid" id="previewGrid"></div>
  </div>

  <!-- Import Actions -->
  <div class="card">
    <h3 class="card-title">
      <span class="material-icons">cloud_upload</span>
      Importar para Firebase
    </h3>
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn btn-success" id="btnImportar" onclick="importarPerguntas()" disabled>
        <span class="material-icons">rocket_launch</span>
        Importar Perguntas
      </button>
      <button class="btn btn-danger" onclick="limparPerguntas()">
        <span class="material-icons">delete_forever</span>
        Limpar TODAS
      </button>
      <button class="btn btn-secondary" onclick="limparForm()">
        <span class="material-icons">clear</span>
        Limpar Form
      </button>
    </div>
    
    <div class="log" id="logContainer" style="margin-top: 20px;">
      <div class="log-item log-info">[Sistema] Aguardando aÃ§Ã£o...</div>
    </div>
  </div>
</div>
<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FIREBASE CONFIG
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const firebaseConfig = {
    apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
    authDomain: "painel-yellup.firebaseapp.com",
    projectId: "painel-yellup",
    storageBucket: "painel-yellup.appspot.com",
    messagingSenderId: "608347210297",
    appId: "1:608347210297:web:75092713724e617c7203e8"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let perguntasParaImportar = [];
  let validationResults = { ok: [], warnings: [], errors: [] };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INICIALIZAÃ‡ÃƒO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  document.addEventListener('DOMContentLoaded', function() {
    setupUploadArea();
    renderSampleJSON();
    
    auth.onAuthStateChanged(function(user) {
      if (user) {
        log('Logado como: ' + user.email, 'success');
        verificarBanco();
      } else {
        log('Tentando autenticaÃ§Ã£o anÃ´nima...', 'info');
        auth.signInAnonymously().catch(function(e) {
          log('Auth: ' + e.message, 'error');
        });
      }
    });
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UPLOAD AREA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function setupUploadArea() {
    var area = document.getElementById('uploadArea');
    var input = document.getElementById('fileInput');
    
    area.addEventListener('click', function() { input.click(); });
    
    area.addEventListener('dragover', function(e) {
      e.preventDefault();
      area.classList.add('dragover');
    });
    
    area.addEventListener('dragleave', function() {
      area.classList.remove('dragover');
    });
    
    area.addEventListener('drop', function(e) {
      e.preventDefault();
      area.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        carregarArquivo(e.dataTransfer.files[0]);
      }
    });
    
    input.addEventListener('change', function(e) {
      if (e.target.files.length) {
        carregarArquivo(e.target.files[0]);
      }
    });
  }

  function carregarArquivo(file) {
    if (!file.name.endsWith('.json')) {
      showToast('Selecione um arquivo .json', 'error');
      return;
    }
    
    var reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('jsonInput').value = e.target.result;
      carregarJSON();
    };
    reader.readAsText(file);
    log('Arquivo carregado: ' + file.name, 'info');
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TABS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function mostrarTab(tab) {
    document.getElementById('tabColar').style.display = tab === 'colar' ? 'block' : 'none';
    document.getElementById('tabExemplo').style.display = tab === 'exemplo' ? 'block' : 'none';
    
    document.querySelectorAll('.tab-btn').forEach(function(btn, i) {
      btn.classList.toggle('active', (i === 0 && tab === 'colar') || (i === 1 && tab === 'exemplo'));
    });
  }

  function renderSampleJSON() {
    var sample = {
      "id": "santos-001",
      "pergunta": "Em que ano o Santos FC foi fundado?",
      "alternativas": {
        "A": "1910",
        "B": "1912",
        "C": "1914",
        "D": "1916"
      },
      "correta": "B",
      "pontuacao": 4,
      "timeId": "abc123firebaseId",
      "timeNome": "Santos FC",
      "campeonatoId": "",
      "campeonatoNome": "",
      "fonte": "Site oficial do Santos FC"
    };
    
    var json = JSON.stringify([sample], null, 2);
    document.getElementById('sampleJson').textContent = json;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VERIFICAR BANCO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async function verificarBanco() {
    log('Verificando banco de dados...', 'info');
    
    try {
      var snapshot = await db.collection('perguntas').get();
      var total = snapshot.size;
      var times = 0;
      var camps = 0;
      
      snapshot.forEach(function(doc) {
        var data = doc.data();
        if (data.timeId && data.timeId !== '') times++;
        if (data.campeonatoId && data.campeonatoId !== '') camps++;
      });
      
      document.getElementById('totalPerguntas').textContent = total;
      document.getElementById('totalTimes').textContent = times;
      document.getElementById('totalCamps').textContent = camps;
      
      log('Banco: ' + total + ' perguntas (' + times + ' times, ' + camps + ' campeonatos)', 'success');
      
    } catch (error) {
      log('Erro ao verificar banco: ' + error.message, 'error');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CARREGAR E VALIDAR JSON
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function carregarJSON() {
    var jsonText = document.getElementById('jsonInput').value.trim();
    
    if (!jsonText) {
      showToast('Cole ou carregue um JSON primeiro!', 'error');
      return;
    }
    
    try {
      // Limpar markdown code blocks
      var cleanJson = jsonText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
      var data = JSON.parse(cleanJson);
      
      // Aceitar mÃºltiplos formatos
      if (Array.isArray(data)) {
        perguntasParaImportar = data;
      } else if (data.perguntas && Array.isArray(data.perguntas)) {
        perguntasParaImportar = data.perguntas;
      } else if (typeof data === 'object') {
        perguntasParaImportar = Object.values(data);
      } else {
        throw new Error('Formato de JSON invÃ¡lido');
      }
      
      // Validar perguntas
      validarPerguntas();
      
    } catch (error) {
      log('Erro ao parsear JSON: ' + error.message, 'error');
      showToast('JSON invÃ¡lido: ' + error.message, 'error');
      perguntasParaImportar = [];
      document.getElementById('btnImportar').disabled = true;
    }
  }

  function validarPerguntas() {
    validationResults = { ok: [], warnings: [], errors: [] };
    var validas = [];
    var porEntidade = {};
    
    perguntasParaImportar.forEach(function(p, idx) {
      var erros = [];
      var avisos = [];
      
      // Campos obrigatÃ³rios
      if (!p.pergunta || p.pergunta.trim() === '') {
        erros.push('Sem pergunta');
      }
      
      if (!p.alternativas || typeof p.alternativas !== 'object') {
        erros.push('Sem alternativas');
      } else {
        if (!p.alternativas.A && !p.alternativas.a) erros.push('Falta alternativa A');
        if (!p.alternativas.B && !p.alternativas.b) erros.push('Falta alternativa B');
        if (!p.alternativas.C && !p.alternativas.c) erros.push('Falta alternativa C');
        if (!p.alternativas.D && !p.alternativas.d) erros.push('Falta alternativa D');
      }
      
      if (!p.correta) {
        erros.push('Sem resposta correta');
      }
      
      // V2: Aceita timeId OU campeonatoId (nÃ£o precisa dos dois)
      var temTime = p.timeId && p.timeId !== '';
      var temCamp = p.campeonatoId && p.campeonatoId !== '';
      
      if (!temTime && !temCamp) {
        erros.push('Sem timeId nem campeonatoId');
      }
      
      // Avisos
      if (!p.fonte || p.fonte.trim() === '') {
        avisos.push('Sem fonte');
      }
      
      if (!p.pontuacao || p.pontuacao < 1 || p.pontuacao > 10) {
        avisos.push('PontuaÃ§Ã£o fora do range 1-10');
      }
      
      if (erros.length === 0) {
        validas.push(p);
        
        // Agrupar por entidade
        var key, tipo;
        if (temTime) {
          key = p.timeNome || p.timeId;
          tipo = 'time';
        } else {
          key = p.campeonatoNome || p.campeonatoId;
          tipo = 'camp';
        }
        
        if (!porEntidade[key]) {
          porEntidade[key] = { count: 0, tipo: tipo };
        }
        porEntidade[key].count++;
      }
      
      if (erros.length > 0) {
        validationResults.errors.push('Pergunta ' + (idx + 1) + ': ' + erros.join(', '));
      }
      if (avisos.length > 0) {
        validationResults.warnings.push('Pergunta ' + (idx + 1) + ': ' + avisos.join(', '));
      }
    });
    
    perguntasParaImportar = validas;
    
    if (validas.length > 0) {
      validationResults.ok.push(validas.length + ' perguntas vÃ¡lidas');
      
      var qtdTimes = Object.values(porEntidade).filter(function(e) { return e.tipo === 'time'; }).length;
      var qtdCamps = Object.values(porEntidade).filter(function(e) { return e.tipo === 'camp'; }).length;
      
      if (qtdTimes > 0) validationResults.ok.push(qtdTimes + ' times diferentes');
      if (qtdCamps > 0) validationResults.ok.push(qtdCamps + ' campeonatos diferentes');
    }
    
    exibirValidacao();
    exibirPreview(porEntidade);
    
    document.getElementById('perguntasCarregadas').textContent = validas.length;
    document.getElementById('btnImportar').disabled = validas.length === 0;
    
    if (validas.length > 0) {
      log(validas.length + ' perguntas prontas para importar', 'success');
      showToast(validas.length + ' perguntas carregadas!', 'success');
    } else {
      log('Nenhuma pergunta vÃ¡lida encontrada', 'error');
      showToast('Nenhuma pergunta vÃ¡lida!', 'error');
    }
  }

  function exibirValidacao() {
    var html = '';
    
    validationResults.ok.forEach(function(msg) {
      html += '<div class="validation-item ok"><span class="material-icons ok">check_circle</span><span>' + msg + '</span></div>';
    });
    
    validationResults.warnings.slice(0, 5).forEach(function(msg) {
      html += '<div class="validation-item warning"><span class="material-icons warning">warning</span><span>' + msg + '</span></div>';
    });
    
    if (validationResults.warnings.length > 5) {
      html += '<div class="validation-item warning"><span class="material-icons warning">warning</span><span>... e mais ' + (validationResults.warnings.length - 5) + ' avisos</span></div>';
    }
    
    validationResults.errors.slice(0, 5).forEach(function(msg) {
      html += '<div class="validation-item error"><span class="material-icons error">error</span><span>' + msg + '</span></div>';
    });
    
    if (validationResults.errors.length > 5) {
      html += '<div class="validation-item error"><span class="material-icons error">error</span><span>... e mais ' + (validationResults.errors.length - 5) + ' erros</span></div>';
    }
    
    document.getElementById('validationSummary').innerHTML = html;
    document.getElementById('validationCard').style.display = 'block';
  }

  function exibirPreview(porEntidade) {
    var sorted = Object.entries(porEntidade).sort(function(a, b) { return b[1].count - a[1].count; });
    
    var html = sorted.map(function(item) {
      var nome = item[0];
      var info = item[1];
      var icon = info.tipo === 'time' ? 'âš½' : 'ğŸ†';
      return '<div class="preview-item ' + info.tipo + '">' +
        '<span class="nome"><span class="icon">' + icon + '</span> ' + nome + '</span>' +
        '<span class="count">' + info.count + '</span>' +
      '</div>';
    }).join('');
    
    document.getElementById('previewGrid').innerHTML = html;
    document.getElementById('previewCard').style.display = 'block';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IMPORTAR PERGUNTAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async function importarPerguntas() {
    if (perguntasParaImportar.length === 0) {
      showToast('Nenhuma pergunta para importar!', 'error');
      return;
    }
    
    var btn = document.getElementById('btnImportar');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Importando...';
    
    log('Iniciando importaÃ§Ã£o de ' + perguntasParaImportar.length + ' perguntas...', 'info');
    
    var importadas = 0;
    var total = perguntasParaImportar.length;
    var batchSize = 50;
    
    try {
      for (var i = 0; i < total; i += batchSize) {
        var batch = db.batch();
        var lote = perguntasParaImportar.slice(i, i + batchSize);
        
        lote.forEach(function(p) {
          var docRef = db.collection('perguntas').doc();
          
          // Normalizar alternativas
          var alternativas = {
            A: String(p.alternativas.A || p.alternativas.a || ''),
            B: String(p.alternativas.B || p.alternativas.b || ''),
            C: String(p.alternativas.C || p.alternativas.c || ''),
            D: String(p.alternativas.D || p.alternativas.d || '')
          };
          
          var dados = {
            // V2: Salvar ID personalizado!
            id: String(p.id || ''),
            pergunta: String(p.pergunta || ''),
            alternativas: alternativas,
            correta: String(p.correta || 'A').toUpperCase(),
            pontuacao: Number(p.pontuacao) || 5,
            fonte: String(p.fonte || ''),
            // V2: Salvar AMBOS time e campeonato
            timeId: String(p.timeId || ''),
            timeNome: String(p.timeNome || ''),
            campeonatoId: String(p.campeonatoId || ''),
            campeonatoNome: String(p.campeonatoNome || ''),
            criadoEm: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          batch.set(docRef, dados);
        });
        
        await batch.commit();
        importadas += lote.length;
        
        var percent = Math.round((importadas / total) * 100);
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressBar').textContent = percent + '%';
        
        log('Lote ' + Math.ceil((i + batchSize) / batchSize) + ': ' + lote.length + ' perguntas', 'success');
      }
      
      log('âœ… ImportaÃ§Ã£o concluÃ­da! ' + importadas + ' perguntas adicionadas.', 'success');
      showToast(importadas + ' perguntas importadas!', 'success');
      
      limparForm();
      await verificarBanco();
      
    } catch (error) {
      log('Erro na importaÃ§Ã£o: ' + error.message, 'error');
      showToast('Erro: ' + error.message, 'error');
    }
    
    btn.disabled = false;
    btn.innerHTML = '<span class="material-icons">rocket_launch</span> Importar Perguntas';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LIMPAR PERGUNTAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async function limparPerguntas() {
    if (!confirm('âš ï¸ ATENÃ‡ÃƒO: Isso vai DELETAR TODAS as perguntas do banco!\n\nTem certeza?')) {
      return;
    }
    
    if (!confirm('ğŸš¨ ÃšLTIMA CHANCE: Isso Ã© IRREVERSÃVEL!\n\nContinuar?')) {
      return;
    }
    
    log('Iniciando limpeza de perguntas...', 'warning');
    
    try {
      var snapshot = await db.collection('perguntas').get();
      var total = snapshot.size;
      var deletadas = 0;
      var batchSize = 50;
      
      var docs = snapshot.docs;
      
      for (var i = 0; i < docs.length; i += batchSize) {
        var batch = db.batch();
        var lote = docs.slice(i, i + batchSize);
        
        lote.forEach(function(doc) {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        deletadas += lote.length;
        
        var percent = Math.round((deletadas / total) * 100);
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressBar').textContent = 'Deletando... ' + percent + '%';
        
        log('Deletadas ' + deletadas + ' de ' + total, 'info');
      }
      
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressBar').textContent = '0%';
      
      log('âœ… ' + total + ' perguntas deletadas!', 'success');
      showToast(total + ' perguntas deletadas!', 'success');
      
      await verificarBanco();
      
    } catch (error) {
      log('Erro: ' + error.message, 'error');
    }
  }

  function limparForm() {
    perguntasParaImportar = [];
    document.getElementById('jsonInput').value = '';
    document.getElementById('perguntasCarregadas').textContent = '0';
    document.getElementById('btnImportar').disabled = true;
    document.getElementById('previewCard').style.display = 'none';
    document.getElementById('validationCard').style.display = 'none';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').textContent = '0%';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  function log(message, type) {
    type = type || 'info';
    var logContainer = document.getElementById('logContainer');
    var item = document.createElement('div');
    item.className = 'log-item log-' + type;
    item.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
    logContainer.insertBefore(item, logContainer.firstChild);
  }

  function showToast(message, type) {
    type = type || 'success';
    var toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
  }
</script>

</body>
</html>
