<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar Perguntas - Yellup Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b, #1a2332);
      color: #e7eef7;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 30px; color: #ffb547; }
    
    .card {
      background: rgba(30, 41, 54, 0.9);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value { font-size: 2em; font-weight: 700; color: #ffb547; }
    .stat-label { font-size: 0.85em; color: #a9b5c6; }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }
    
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,181,71,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-danger { background: #ef4444; color: white; }
    .btn-success { background: #22c55e; color: white; }
    
    .progress-container {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-bar {
      height: 30px;
      background: linear-gradient(90deg, #ffb547, #ff8c42);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #0e141b;
    }
    
    .log {
      background: #0e141b;
      border-radius: 10px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85em;
    }
    
    .log-item { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    
    .times-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .time-item {
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }
    
    .time-count { color: #ffb547; font-weight: 600; }

    textarea {
      width: 100%;
      height: 200px;
      background: #0e141b;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 15px;
      color: #e7eef7;
      font-family: monospace;
      resize: vertical;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üìö Importar Perguntas - Yellup</h1>

  <!-- Stats -->
  <div class="card">
    <h3 style="margin-bottom: 15px;">üìä Estat√≠sticas</h3>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value" id="totalPerguntas">0</div>
        <div class="stat-label">Perguntas no Banco</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalTimes">0</div>
        <div class="stat-label">Times com Perguntas</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="perguntasCarregadas">0</div>
        <div class="stat-label">Para Importar</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="perguntasImportadas">0</div>
        <div class="stat-label">Importadas</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="verificarBanco()">üîÑ Verificar Banco</button>
  </div>

  <!-- Upload -->
  <div class="card">
    <h3 style="margin-bottom: 15px;">üìÅ Carregar Perguntas</h3>
    <p style="color: #a9b5c6; margin-bottom: 15px;">Cole o JSON das perguntas ou fa√ßa upload do arquivo:</p>
    
    <div class="file-input-wrapper">
      <button class="btn btn-primary">üìÇ Escolher Arquivo JSON</button>
      <input type="file" id="fileInput" accept=".json" onchange="carregarArquivo(event)">
    </div>
    
    <p style="margin: 15px 0; color: #a9b5c6;">Ou cole o JSON aqui:</p>
    <textarea id="jsonInput" placeholder='Cole o JSON aqui... formato: [{"pergunta": "...", "alternativas": {...}, ...}]'></textarea>
    <br><br>
    <button class="btn btn-primary" onclick="carregarJSON()">üì• Carregar JSON</button>
  </div>

  <!-- Times Preview -->
  <div class="card" id="previewCard" style="display: none;">
    <h3 style="margin-bottom: 15px;">üëÄ Preview - Perguntas por Time</h3>
    <div class="times-list" id="timesList"></div>
  </div>

  <!-- Import Actions -->
  <div class="card">
    <h3 style="margin-bottom: 15px;">‚ö° Importar</h3>
    
    <div class="progress-container">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <button class="btn btn-success" id="btnImportar" onclick="importarPerguntas()" disabled>
      üöÄ Importar Perguntas
    </button>
    <button class="btn btn-danger" onclick="limparPerguntas()">
      üóëÔ∏è Limpar Todas Perguntas
    </button>
    
    <div class="log" id="logContainer" style="margin-top: 20px;">
      <div class="log-item log-info">Aguardando a√ß√£o...</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
  // Configura√ß√£o Firebase (mesma do seu projeto)
  const firebaseConfig = {
    apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
    authDomain: "painel-yellup.firebaseapp.com",
    projectId: "painel-yellup",
    storageBucket: "painel-yellup.appspot.com",
    messagingSenderId: "608347210297",
    appId: "1:608347210297:web:75092713724e617c7203e8",
    measurementId: "G-SYZ16X31KQ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let perguntasParaImportar = [];

  // Log helper
  function log(message, type = 'info') {
    const logContainer = document.getElementById('logContainer');
    const item = document.createElement('div');
    item.className = `log-item log-${type}`;
    item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContainer.insertBefore(item, logContainer.firstChild);
  }

  // Verificar banco atual
  async function verificarBanco() {
    log('Verificando banco de dados...', 'info');
    
    try {
      const snapshot = await db.collection('perguntas').get();
      const perguntas = snapshot.docs;
      
      document.getElementById('totalPerguntas').textContent = perguntas.length;
      
      // Contar times √∫nicos
      const times = new Set();
      perguntas.forEach(doc => {
        const data = doc.data();
        if (data.timeId) times.add(data.timeId);
      });
      
      document.getElementById('totalTimes').textContent = times.size;
      log(`Encontradas ${perguntas.length} perguntas para ${times.size} times`, 'success');
      
    } catch (error) {
      log(`Erro: ${error.message}`, 'error');
    }
  }

  // Carregar arquivo JSON
  function carregarArquivo(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('jsonInput').value = e.target.result;
      carregarJSON();
    };
    reader.readAsText(file);
  }

  // Carregar JSON
  function carregarJSON() {
    const jsonText = document.getElementById('jsonInput').value.trim();
    
    if (!jsonText) {
      log('JSON vazio!', 'error');
      return;
    }
    
    try {
      const data = JSON.parse(jsonText);
      
      // Aceita tanto array quanto objeto
      if (Array.isArray(data)) {
        perguntasParaImportar = data;
      } else if (data.perguntas && Array.isArray(data.perguntas)) {
        perguntasParaImportar = data.perguntas;
      } else if (typeof data === 'object') {
        // Formato de objeto com IDs como chaves
        perguntasParaImportar = Object.values(data);
      } else {
        throw new Error('Formato inv√°lido');
      }
      
      // Validar estrutura
      const validas = perguntasParaImportar.filter(p => 
        p.pergunta && p.alternativas && p.correta && p.timeId
      );
      
      if (validas.length === 0) {
        throw new Error('Nenhuma pergunta v√°lida encontrada');
      }
      
      perguntasParaImportar = validas;
      
      document.getElementById('perguntasCarregadas').textContent = perguntasParaImportar.length;
      document.getElementById('btnImportar').disabled = false;
      
      // Mostrar preview por time
      mostrarPreview();
      
      log(`${perguntasParaImportar.length} perguntas carregadas com sucesso!`, 'success');
      
    } catch (error) {
      log(`Erro ao parsear JSON: ${error.message}`, 'error');
      perguntasParaImportar = [];
      document.getElementById('btnImportar').disabled = true;
    }
  }

  // Mostrar preview
  function mostrarPreview() {
    const timesList = document.getElementById('timesList');
    const previewCard = document.getElementById('previewCard');
    
    // Contar por time
    const porTime = {};
    perguntasParaImportar.forEach(p => {
      const nome = p.timeNome || 'Desconhecido';
      porTime[nome] = (porTime[nome] || 0) + 1;
    });
    
    // Ordenar por quantidade
    const sorted = Object.entries(porTime).sort((a, b) => b[1] - a[1]);
    
    timesList.innerHTML = sorted.map(([nome, count]) => `
      <div class="time-item">
        <span>${nome}</span>
        <span class="time-count">${count}</span>
      </div>
    `).join('');
    
    previewCard.style.display = 'block';
  }

  // Importar perguntas
  async function importarPerguntas() {
    if (perguntasParaImportar.length === 0) {
      log('Nenhuma pergunta para importar!', 'error');
      return;
    }
    
    const btn = document.getElementById('btnImportar');
    btn.disabled = true;
    
    log(`Iniciando importa√ß√£o de ${perguntasParaImportar.length} perguntas...`, 'info');
    
    let importadas = 0;
    let erros = 0;
    const total = perguntasParaImportar.length;
    const batchSize = 50; // Limite do Firestore
    
    try {
      // Processar em lotes
      for (let i = 0; i < total; i += batchSize) {
        const batch = db.batch();
        const lote = perguntasParaImportar.slice(i, i + batchSize);
        
        lote.forEach(pergunta => {
          const docRef = db.collection('perguntas').doc();
          batch.set(docRef, {
            pergunta: pergunta.pergunta,
            alternativas: pergunta.alternativas,
            correta: pergunta.correta,
            pontuacao: pergunta.pontuacao || 5,
            timeId: pergunta.timeId,
            timeNome: pergunta.timeNome || '',
            fonte: pergunta.fonte || '',
            criadoEm: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        
        await batch.commit();
        importadas += lote.length;
        
        // Atualizar progresso
        const percent = Math.round((importadas / total) * 100);
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressBar').textContent = percent + '%';
        document.getElementById('perguntasImportadas').textContent = importadas;
        
        log(`Lote ${Math.ceil((i + batchSize) / batchSize)}: ${lote.length} perguntas importadas`, 'success');
      }
      
      log(`‚úÖ Importa√ß√£o conclu√≠da! ${importadas} perguntas adicionadas.`, 'success');
      
      // Limpar
      perguntasParaImportar = [];
      document.getElementById('perguntasCarregadas').textContent = '0';
      document.getElementById('jsonInput').value = '';
      document.getElementById('previewCard').style.display = 'none';
      
      // Atualizar stats
      await verificarBanco();
      
    } catch (error) {
      log(`Erro na importa√ß√£o: ${error.message}`, 'error');
    }
    
    btn.disabled = false;
  }

  // Limpar todas as perguntas
  async function limparPerguntas() {
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai DELETAR TODAS as perguntas do banco!\n\nTem certeza?')) {
      return;
    }
    
    if (!confirm('üö® √öLTIMA CHANCE: Isso √© IRREVERS√çVEL!\n\nContinuar?')) {
      return;
    }
    
    log('Iniciando limpeza de perguntas...', 'info');
    
    try {
      const snapshot = await db.collection('perguntas').get();
      const total = snapshot.docs.length;
      let deletadas = 0;
      
      // Deletar em lotes
      const batchSize = 50;
      const batches = [];
      let batch = db.batch();
      let count = 0;
      
      snapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
        count++;
        
        if (count >= batchSize) {
          batches.push(batch);
          batch = db.batch();
          count = 0;
        }
      });
      
      if (count > 0) {
        batches.push(batch);
      }
      
      for (const b of batches) {
        await b.commit();
        deletadas += batchSize;
        log(`Deletadas ${Math.min(deletadas, total)} de ${total}...`, 'info');
      }
      
      log(`‚úÖ ${total} perguntas deletadas!`, 'success');
      await verificarBanco();
      
    } catch (error) {
      log(`Erro: ${error.message}`, 'error');
    }
  }

  // Inicializar
  auth.onAuthStateChanged(user => {
    if (user) {
      log(`Logado como: ${user.email}`, 'success');
      verificarBanco();
    } else {
      log('N√£o autenticado. Algumas fun√ß√µes podem n√£o funcionar.', 'info');
      // Tentar login an√¥nimo para testes
      auth.signInAnonymously().catch(e => log('Auth: ' + e.message, 'error'));
    }
  });
</script>

</body>
</html>
