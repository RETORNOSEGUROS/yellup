<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premia√ß√£o - Yellup Admin</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="/admin/js/firebase-config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
    }
    .header h1 { font-size: 1.8em; }
    .btn-voltar {
      background: rgba(255,255,255,0.1);
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
    }
    .config-section {
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .config-section h2 {
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 0.9em;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: #fff;
    }
    .btn-gerar {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a1a2e;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1em;
    }
    .btn-gerar:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,215,0,0.4); }
    .btn-pagar-todos {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: #fff;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      margin-left: 15px;
    }
    .table-container {
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: rgba(255,215,0,0.2);
      color: #FFD700;
      padding: 15px;
      text-align: left;
    }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    tr:hover { background: rgba(255,255,255,0.05); }
    .rank-cell { font-weight: 700; font-size: 1.2em; }
    .rank-1 { color: #FFD700; }
    .rank-2 { color: #C0C0C0; }
    .rank-3 { color: #CD7F32; }
    .premio { color: #2ecc71; font-weight: 700; }
    .btn-pagar {
      background: #2ecc71;
      color: #fff;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-pagar:disabled {
      background: rgba(255,255,255,0.2);
      cursor: not-allowed;
    }
    .btn-pagar.pago {
      background: rgba(46,204,113,0.2);
      color: #2ecc71;
    }
    .stats-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-box {
      background: rgba(0,0,0,0.2);
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-box .value { font-size: 1.5em; font-weight: 700; color: #FFD700; }
    .stat-box .label { font-size: 0.85em; color: rgba(255,255,255,0.6); }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 10px;
      color: #fff;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .toast.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .empty-state { text-align: center; padding: 60px; color: rgba(255,255,255,0.5); }
    .premio-config {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    .premio-config input {
      padding: 8px;
      text-align: center;
      font-size: 0.9em;
    }
    .premio-config label {
      font-size: 0.8em;
      text-align: center;
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÅ Sistema de Premia√ß√£o</h1>
      <a href="dashboard.html" class="btn-voltar">‚Üê Painel Admin</a>
    </div>

    <div class="config-section">
      <h2>‚öôÔ∏è Configurar Premia√ß√£o</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Tipo de Ranking</label>
          <select id="tipoRanking">
            <option value="xp">XP / Pontua√ß√£o</option>
            <option value="jogos">Jogos Participados</option>
            <option value="vitorias">Vit√≥rias</option>
            <option value="streak">Maior Streak</option>
          </select>
        </div>
        <div class="form-group">
          <label>Per√≠odo</label>
          <select id="periodo">
            <option value="semana">Esta Semana</option>
            <option value="mes">Este M√™s</option>
            <option value="temporada">Temporada Atual</option>
            <option value="geral">Geral (Todo Tempo)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantidade de Premiados</label>
          <select id="qtdPremiados">
            <option value="3">Top 3</option>
            <option value="5">Top 5</option>
            <option value="10" selected>Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
          </select>
        </div>
      </div>

      <h3 style="margin-bottom: 15px; font-size: 1em; color: rgba(255,255,255,0.8);">üí∞ Pr√™mios por Posi√ß√£o (cr√©ditos)</h3>
      <div class="premio-config">
        <div><label>ü•á 1¬∫</label><input type="number" id="premio1" value="500"></div>
        <div><label>ü•à 2¬∫</label><input type="number" id="premio2" value="300"></div>
        <div><label>ü•â 3¬∫</label><input type="number" id="premio3" value="200"></div>
        <div><label>4¬∫</label><input type="number" id="premio4" value="100"></div>
        <div><label>5¬∫-10¬∫</label><input type="number" id="premio5" value="50"></div>
      </div>

      <div style="margin-top: 25px; display: flex; align-items: center;">
        <button class="btn-gerar" onclick="gerarRanking()">üìä Gerar Ranking de Premia√ß√£o</button>
        <button class="btn-pagar-todos" id="btnPagarTodos" onclick="pagarTodos()" style="display:none">üí∞ Pagar Todos</button>
      </div>
    </div>

    <div class="config-section" id="resultadoSection" style="display:none">
      <h2>üèÜ Ranking de Premia√ß√£o</h2>
      
      <div class="stats-row">
        <div class="stat-box">
          <div class="value" id="totalPremios">0</div>
          <div class="label">Total em Pr√™mios</div>
        </div>
        <div class="stat-box">
          <div class="value" id="qtdPremiados2">0</div>
          <div class="label">Usu√°rios Premiados</div>
        </div>
        <div class="stat-box">
          <div class="value" id="jaPageos">0</div>
          <div class="label">J√° Pagos</div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:60px">#</th>
              <th>Usu√°rio</th>
              <th>Pontua√ß√£o</th>
              <th>Pr√™mio</th>
              <th style="width:120px">A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tabela"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const db = firebase.firestore();
    let rankingAtual = [];
    let premiosConfig = {};

    async function gerarRanking() {
      const tipo = document.getElementById('tipoRanking').value;
      const qtd = parseInt(document.getElementById('qtdPremiados').value);
      
      premiosConfig = {
        1: parseInt(document.getElementById('premio1').value) || 500,
        2: parseInt(document.getElementById('premio2').value) || 300,
        3: parseInt(document.getElementById('premio3').value) || 200,
        4: parseInt(document.getElementById('premio4').value) || 100,
        5: parseInt(document.getElementById('premio5').value) || 50
      };

      try {
        const snap = await db.collection('usuarios').get();
        let usuarios = [];
        snap.forEach(doc => usuarios.push({ id: doc.id, ...doc.data() }));

        // Ordenar pelo tipo escolhido
        const campoOrdem = {
          xp: u => u.xp || u.pontuacao || 0,
          jogos: u => u.jogosParticipados || u.totalJogos || 0,
          vitorias: u => u.vitorias || 0,
          streak: u => u.maiorStreak || u.streakMaximo || 0
        };

        usuarios.sort((a, b) => campoOrdem[tipo](b) - campoOrdem[tipo](a));
        rankingAtual = usuarios.slice(0, qtd).map((u, i) => ({
          ...u,
          posicao: i + 1,
          pontuacao: campoOrdem[tipo](u),
          premio: getPremio(i + 1),
          pago: false
        }));

        renderizarRanking();
        document.getElementById('resultadoSection').style.display = 'block';
        document.getElementById('btnPagarTodos').style.display = 'inline-block';
      } catch (e) {
        console.error('Erro:', e);
        showToast('‚ùå Erro ao gerar ranking', 'error');
      }
    }

    function getPremio(posicao) {
      if (posicao === 1) return premiosConfig[1];
      if (posicao === 2) return premiosConfig[2];
      if (posicao === 3) return premiosConfig[3];
      if (posicao === 4) return premiosConfig[4];
      return premiosConfig[5];
    }

    function renderizarRanking() {
      const tbody = document.getElementById('tabela');
      let totalPremios = 0;
      let pagos = 0;

      rankingAtual.forEach(u => {
        totalPremios += u.premio;
        if (u.pago) pagos++;
      });

      document.getElementById('totalPremios').textContent = totalPremios + ' üíé';
      document.getElementById('qtdPremiados2').textContent = rankingAtual.length;
      document.getElementById('jaPageos').textContent = pagos;

      tbody.innerHTML = rankingAtual.map(u => {
        const rankIcon = u.posicao === 1 ? 'ü•á' : u.posicao === 2 ? 'ü•à' : u.posicao === 3 ? 'ü•â' : u.posicao + '¬∫';
        const rankClass = u.posicao <= 3 ? `rank-${u.posicao}` : '';
        
        return `
          <tr>
            <td class="rank-cell ${rankClass}">${rankIcon}</td>
            <td>
              <div style="font-weight:600">${u.nome || u.usuarioUnico || 'Usu√°rio'}</div>
              <div style="font-size:0.8em;color:rgba(255,255,255,0.5)">${u.email || ''}</div>
            </td>
            <td style="font-weight:600">${u.pontuacao.toLocaleString()}</td>
            <td class="premio">${u.premio} üíé</td>
            <td>
              <button class="btn-pagar ${u.pago ? 'pago' : ''}" 
                      onclick="pagarPremio('${u.id}', ${u.posicao})" 
                      ${u.pago ? 'disabled' : ''}>
                ${u.pago ? '‚úì Pago' : 'üí∞ Pagar'}
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function pagarPremio(userId, posicao) {
      const usuario = rankingAtual.find(u => u.id === userId);
      if (!usuario || usuario.pago) return;

      try {
        // Atualizar cr√©ditos do usu√°rio
        await db.collection('usuarios').doc(userId).update({
          creditos: firebase.firestore.FieldValue.increment(usuario.premio)
        });

        // Registrar transa√ß√£o
        await db.collection('transacoes').add({
          usuarioId: userId,
          tipo: 'credito',
          categoria: 'premio_ranking',
          valor: usuario.premio,
          descricao: `Pr√™mio ${posicao}¬∫ lugar no ranking`,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Notificar usu√°rio
        await db.collection('notificacoes').add({
          para: userId,
          tipo: 'premio',
          titulo: 'üèÜ Parab√©ns! Voc√™ ganhou um pr√™mio!',
          mensagem: `Voc√™ ficou em ${posicao}¬∫ lugar e ganhou ${usuario.premio} cr√©ditos!`,
          lida: false,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        usuario.pago = true;
        renderizarRanking();
        showToast(`‚úÖ ${usuario.premio} cr√©ditos pagos para ${usuario.nome || 'usu√°rio'}!`, 'success');
      } catch (e) {
        console.error('Erro:', e);
        showToast('‚ùå Erro ao pagar: ' + e.message, 'error');
      }
    }

    async function pagarTodos() {
      if (!confirm('Confirma pagar TODOS os pr√™mios do ranking?')) return;

      for (const u of rankingAtual) {
        if (!u.pago) {
          await pagarPremio(u.id, u.posicao);
          await new Promise(r => setTimeout(r, 300)); // Delay entre pagamentos
        }
      }

      showToast('‚úÖ Todos os pr√™mios foram pagos!', 'success');
    }

    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
