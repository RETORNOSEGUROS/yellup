<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Perguntas | Yellup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 { color: #FFD700; font-size: 28px; }
        .sidebar-header span { font-size: 12px; background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; }

        .nav-section { margin-bottom: 20px; }
        .nav-section-title { color: rgba(255, 255, 255, 0.5); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; padding: 0 20px; margin-bottom: 10px; }

        .sidebar a {
            display: flex; align-items: center; gap: 12px; padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar a:hover, .sidebar a.active { background: rgba(255, 215, 0, 0.1); color: #FFD700; border-left-color: #FFD700; }
        .sidebar a .icon { font-size: 18px; width: 24px; text-align: center; }

        /* Main Content */
        .main { flex: 1; margin-left: 260px; padding: 30px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: white; font-size: 28px; }

        .btn {
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
            transition: all 0.3s; border: none; display: inline-flex; align-items: center; gap: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a2e; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3); }
        .btn-danger { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; }
        .btn-danger:hover { background: #e74c3c; color: white; }
        .btn-success { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71; }
        .btn-success:hover { background: #2ecc71; color: white; }
        .btn-info { background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db; color: #3498db; }
        .btn-info:hover { background: #3498db; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; text-align: center;
        }

        .stat-card .icon { font-size: 32px; margin-bottom: 10px; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: white; }
        .stat-card .label { color: rgba(255, 255, 255, 0.6); font-size: 14px; }

        /* Filters */
        .filters-bar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }

        .search-box { flex: 1; min-width: 250px; position: relative; }

        .search-box input {
            width: 100%; padding: 12px 20px 12px 45px; border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1);
            color: white; font-size: 14px;
        }

        .search-box input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .search-box input:focus { outline: none; border-color: #FFD700; }
        .search-box .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.5); }

        .filter-select {
            padding: 12px 20px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; min-width: 150px;
        }

        .filter-select option { background: #1a1a2e; color: white; }

        /* Table */
        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }

        th {
            background: rgba(0, 0, 0, 0.3); color: #FFD700; padding: 15px; text-align: left;
            font-weight: 600; font-size: 13px; text-transform: uppercase;
        }

        td { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: white; font-size: 14px; }
        tr:hover { background: rgba(255, 255, 255, 0.03); }

        .pergunta-text { max-width: 400px; }

        .alternativas {
            display: flex; flex-direction: column; gap: 4px; font-size: 12px;
        }

        .alt-item { display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; }
        .alt-item.correta { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .alt-item.incorreta { color: rgba(255, 255, 255, 0.5); }

        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-facil { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .badge-medio { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
        .badge-dificil { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        .time-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; font-size: 12px; }

        .actions { display: flex; gap: 8px; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 30px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-header h2 { color: white; font-size: 22px; }
        .modal-close { background: none; border: none; color: rgba(255, 255, 255, 0.5); font-size: 24px; cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; font-size: 14px; }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px 15px; border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;
        }

        .form-group textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #FFD700; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .alternativas-form { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .alternativas-form h4 { color: white; margin-bottom: 15px; font-size: 16px; }

        .alt-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .alt-input-group .letra { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.1); border-radius: 8px; color: #FFD700; font-weight: bold; }
        .alt-input-group input { flex: 1; }
        .alt-input-group .radio-label { display: flex; align-items: center; gap: 5px; color: rgba(255, 255, 255, 0.7); font-size: 12px; cursor: pointer; white-space: nowrap; }
        .alt-input-group input[type="radio"] { width: auto; margin: 0; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px; }
        .pagination button { padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 8px; cursor: pointer; }
        .pagination button:hover { background: rgba(255, 215, 0, 0.2); border-color: #FFD700; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination span { color: rgba(255, 255, 255, 0.7); }

        .loading { text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>‚öΩ Yellup <span>Admin</span></h2>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Principal</div>
            <a href="dashboard.html"><span class="icon">üìä</span> Dashboard</a>
            <a href="usuarios.html"><span class="icon">üë•</span> Usu√°rios</a>
            <a href="jogos.html"><span class="icon">üéÆ</span> Jogos</a>
            <a href="perguntas.html" class="active"><span class="icon">‚ùì</span> Perguntas</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Modos de Jogo</div>
            <a href="torneios.html"><span class="icon">üèÖ</span> Torneios</a>
            <a href="embates.html"><span class="icon">‚öîÔ∏è</span> Embates PvP</a>
            <a href="ligas.html"><span class="icon">üèÜ</span> Teste de Ligas</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Comunidade</div>
            <a href="chat.html"><span class="icon">üí¨</span> Chat Global</a>
            <a href="amizades.html"><span class="icon">ü§ù</span> Amizades</a>
            <a href="notificacoes.html"><span class="icon">üîî</span> Notifica√ß√µes</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Financeiro</div>
            <a href="creditos.html"><span class="icon">üí∞</span> Cr√©ditos</a>
            <a href="transacoes.html"><span class="icon">üí≥</span> Transa√ß√µes</a>
            <a href="indicacoes.html"><span class="icon">üîó</span> Indica√ß√µes</a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Sistema</div>
            <a href="times.html"><span class="icon">‚öΩ</span> Times</a>
            <a href="configuracoes.html"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="header">
            <h1>‚ùì Gerenciar Perguntas</h1>
            <button class="btn btn-primary" onclick="abrirModal()">‚ûï Nova Pergunta</button>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="icon">‚ùì</div>
                <div class="value" id="statTotal">0</div>
                <div class="label">Total de Perguntas</div>
            </div>
            <div class="stat-card">
                <div class="icon">üü¢</div>
                <div class="value" id="statFacil">0</div>
                <div class="label">F√°ceis</div>
            </div>
            <div class="stat-card">
                <div class="icon">üü°</div>
                <div class="value" id="statMedio">0</div>
                <div class="label">M√©dias</div>
            </div>
            <div class="stat-card">
                <div class="icon">üî¥</div>
                <div class="value" id="statDificil">0</div>
                <div class="label">Dif√≠ceis</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="search-box">
                <span class="icon">üîç</span>
                <input type="text" id="busca" placeholder="Buscar pergunta..." oninput="buscarPerguntas()">
            </div>
            <select class="filter-select" id="filtroTime" onchange="filtrarPerguntas()">
                <option value="">Todos os Times</option>
            </select>
            <select class="filter-select" id="filtroDificuldade" onchange="filtrarPerguntas()">
                <option value="">Todas as Dificuldades</option>
                <option value="facil">üü¢ F√°cil</option>
                <option value="medio">üü° M√©dio</option>
                <option value="dificil">üî¥ Dif√≠cil</option>
            </select>
            <select class="filter-select" id="filtroLiga" onchange="filtrarPerguntas()">
                <option value="">Todas as Ligas</option>
                <option value="serie_a">üáßüá∑ S√©rie A</option>
                <option value="serie_b">üáßüá∑ S√©rie B</option>
                <option value="libertadores">üèÜ Libertadores</option>
                <option value="champions">‚≠ê Champions</option>
                <option value="premier">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier</option>
                <option value="laliga">üá™üá∏ La Liga</option>
            </select>
            <button class="btn btn-info" onclick="exportarCSV()">üì• Exportar</button>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Pergunta</th>
                        <th>Alternativas</th>
                        <th>Time</th>
                        <th>Dificuldade</th>
                        <th>Pontos</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaPerguntas">
                    <tr><td colspan="6" class="loading">Carregando perguntas...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <button onclick="paginaAnterior()" id="btnAnterior" disabled>‚Üê Anterior</button>
            <span id="paginaInfo">P√°gina 1</span>
            <button onclick="proximaPagina()" id="btnProxima">Pr√≥xima ‚Üí</button>
        </div>
    </div>

    <!-- Modal Nova/Editar Pergunta -->
    <div class="modal" id="modalPergunta">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo">‚ûï Nova Pergunta</h2>
                <button class="modal-close" onclick="fecharModal()">‚úï</button>
            </div>

            <input type="hidden" id="perguntaId">

            <div class="form-group">
                <label>Texto da Pergunta</label>
                <textarea id="pergunta" placeholder="Digite a pergunta aqui..."></textarea>
            </div>

            <div class="alternativas-form">
                <h4>üìù Alternativas</h4>
                <div class="alt-input-group">
                    <span class="letra">A</span>
                    <input type="text" id="altA" placeholder="Alternativa A">
                    <label class="radio-label"><input type="radio" name="correta" value="A"> Correta</label>
                </div>
                <div class="alt-input-group">
                    <span class="letra">B</span>
                    <input type="text" id="altB" placeholder="Alternativa B">
                    <label class="radio-label"><input type="radio" name="correta" value="B"> Correta</label>
                </div>
                <div class="alt-input-group">
                    <span class="letra">C</span>
                    <input type="text" id="altC" placeholder="Alternativa C">
                    <label class="radio-label"><input type="radio" name="correta" value="C"> Correta</label>
                </div>
                <div class="alt-input-group">
                    <span class="letra">D</span>
                    <input type="text" id="altD" placeholder="Alternativa D">
                    <label class="radio-label"><input type="radio" name="correta" value="D"> Correta</label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Time Relacionado</label>
                    <select id="timeId">
                        <option value="">Geral (sem time)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pontua√ß√£o</label>
                    <input type="number" id="pontuacao" value="10" min="1" max="100">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Dificuldade</label>
                    <select id="dificuldade">
                        <option value="facil">üü¢ F√°cil</option>
                        <option value="medio" selected>üü° M√©dio</option>
                        <option value="dificil">üî¥ Dif√≠cil</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Liga</label>
                    <select id="liga">
                        <option value="">Geral</option>
                        <option value="serie_a">üáßüá∑ S√©rie A</option>
                        <option value="serie_b">üáßüá∑ S√©rie B</option>
                        <option value="libertadores">üèÜ Libertadores</option>
                        <option value="champions">‚≠ê Champions</option>
                        <option value="premier">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League</option>
                        <option value="laliga">üá™üá∏ La Liga</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="salvarPergunta()" style="flex: 1;">üíæ Salvar</button>
                <button class="btn btn-danger" onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
            authDomain: "painel-yellup.firebaseapp.com",
            projectId: "painel-yellup",
            storageBucket: "painel-yellup.appspot.com",
            messagingSenderId: "608347210297",
            appId: "1:608347210297:web:75092713724e617c7203e8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Verificar autentica√ß√£o
        firebase.auth().onAuthStateChanged(user => {
            if (!user || user.email !== "admin@yellup.com") {
                window.location.href = "login.html";
            } else {
                carregarTimes();
                carregarPerguntas();
            }
        });

        // Vari√°veis
        let todasPerguntas = [];
        let perguntasFiltradas = [];
        let todosTimes = [];
        let timesMap = {};
        let paginaAtual = 1;
        const porPagina = 15;

        // =====================================================
        // FUN√á√ÉO HELPER PARA EXTRAIR ALTERNATIVAS
        // Suporta AMBOS os formatos: 
        //   - Novo: { alternativas: { A: "...", B: "...", C: "...", D: "..." } }
        //   - Antigo: { altA: "...", altB: "...", altC: "...", altD: "..." }
        // =====================================================
        function getAlternativa(p, letra) {
            // Primeiro tenta o formato novo (alternativas.A, alternativas.B, etc)
            if (p.alternativas && typeof p.alternativas === 'object') {
                return p.alternativas[letra] || p.alternativas[letra.toLowerCase()] || '';
            }
            // Depois tenta os formatos antigos
            return p[`alt${letra}`] || p[`alternativa${letra}`] || p[`Alt${letra}`] || '';
        }

        async function carregarTimes() {
            try {
                const snap = await db.collection('times').orderBy('nome').get();
                todosTimes = [];
                snap.forEach(doc => {
                    const t = { id: doc.id, ...doc.data() };
                    todosTimes.push(t);
                    timesMap[doc.id] = t;
                });

                // Popular selects
                const selectTime = document.getElementById('timeId');
                const selectFiltro = document.getElementById('filtroTime');

                let options = '<option value="">Geral (sem time)</option>';
                todosTimes.forEach(t => {
                    options += `<option value="${t.id}">${t.nome}</option>`;
                });

                selectTime.innerHTML = options;
                selectFiltro.innerHTML = '<option value="">Todos os Times</option>' + 
                    todosTimes.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');

            } catch (error) {
                console.error('Erro ao carregar times:', error);
            }
        }

        async function carregarPerguntas() {
            try {
                const snap = await db.collection('perguntas').get();

                todasPerguntas = [];
                let facil = 0, medio = 0, dificil = 0;

                snap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    todasPerguntas.push(p);

                    const dif = (p.dificuldade || 'medio').toLowerCase();
                    if (dif === 'facil') facil++;
                    else if (dif === 'medio') medio++;
                    else if (dif === 'dificil') dificil++;
                });

                document.getElementById('statTotal').textContent = todasPerguntas.length;
                document.getElementById('statFacil').textContent = facil;
                document.getElementById('statMedio').textContent = medio;
                document.getElementById('statDificil').textContent = dificil;

                perguntasFiltradas = [...todasPerguntas];
                renderizarPerguntas();
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('listaPerguntas').innerHTML = 
                    '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">Erro ao carregar perguntas</td></tr>';
            }
        }

        function renderizarPerguntas() {
            const inicio = (paginaAtual - 1) * porPagina;
            const fim = inicio + porPagina;
            const perguntasPagina = perguntasFiltradas.slice(inicio, fim);

            const tbody = document.getElementById('listaPerguntas');

            if (perguntasPagina.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Nenhuma pergunta encontrada</td></tr>';
                return;
            }

            let html = '';
            perguntasPagina.forEach(p => {
                const time = timesMap[p.timeId] || { nome: 'Geral' };
                const dif = (p.dificuldade || 'medio').toLowerCase();
                const difBadge = {
                    'facil': 'badge-facil',
                    'medio': 'badge-medio',
                    'dificil': 'badge-dificil'
                }[dif] || 'badge-medio';
                const difText = {
                    'facil': 'üü¢ F√°cil',
                    'medio': 'üü° M√©dio',
                    'dificil': 'üî¥ Dif√≠cil'
                }[dif] || 'üü° M√©dio';

                const correta = p.correta || 'A';
                
                // CORRE√á√ÉO: Usar a fun√ß√£o helper para extrair alternativas
                const alternativas = ['A', 'B', 'C', 'D'].map(letra => {
                    const texto = getAlternativa(p, letra) || '-';
                    const isCorreta = letra === correta;
                    return `<div class="alt-item ${isCorreta ? 'correta' : 'incorreta'}">
                        <strong>${letra}:</strong> ${texto.substring(0, 30)}${texto.length > 30 ? '...' : ''}
                        ${isCorreta ? '‚úì' : ''}
                    </div>`;
                }).join('');

                html += `
                    <tr>
                        <td class="pergunta-text">${(p.pergunta || '').substring(0, 80)}${(p.pergunta || '').length > 80 ? '...' : ''}</td>
                        <td><div class="alternativas">${alternativas}</div></td>
                        <td><span class="time-badge">‚öΩ ${time.nome}</span></td>
                        <td><span class="badge ${difBadge}">${difText}</span></td>
                        <td>${p.pontuacao || 10} pts</td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-success btn-sm" onclick="editarPergunta('${p.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="excluirPergunta('${p.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            atualizarPaginacao();
        }

        function buscarPerguntas() {
            const termo = document.getElementById('busca').value.toLowerCase();
            perguntasFiltradas = todasPerguntas.filter(p => {
                const pergunta = (p.pergunta || '').toLowerCase();
                return pergunta.includes(termo);
            });
            paginaAtual = 1;
            renderizarPerguntas();
        }

        function filtrarPerguntas() {
            const timeId = document.getElementById('filtroTime').value;
            const dificuldade = document.getElementById('filtroDificuldade').value;
            const liga = document.getElementById('filtroLiga').value;
            const termo = document.getElementById('busca').value.toLowerCase();

            perguntasFiltradas = todasPerguntas.filter(p => {
                if (termo) {
                    const pergunta = (p.pergunta || '').toLowerCase();
                    if (!pergunta.includes(termo)) return false;
                }
                if (timeId && p.timeId !== timeId) return false;
                if (dificuldade && (p.dificuldade || 'medio') !== dificuldade) return false;
                if (liga && p.liga !== liga) return false;
                return true;
            });

            paginaAtual = 1;
            renderizarPerguntas();
        }

        function atualizarPaginacao() {
            const totalPaginas = Math.ceil(perguntasFiltradas.length / porPagina);
            document.getElementById('paginaInfo').textContent = `P√°gina ${paginaAtual} de ${totalPaginas || 1}`;
            document.getElementById('btnAnterior').disabled = paginaAtual <= 1;
            document.getElementById('btnProxima').disabled = paginaAtual >= totalPaginas;
        }

        function paginaAnterior() {
            if (paginaAtual > 1) { paginaAtual--; renderizarPerguntas(); }
        }

        function proximaPagina() {
            const totalPaginas = Math.ceil(perguntasFiltradas.length / porPagina);
            if (paginaAtual < totalPaginas) { paginaAtual++; renderizarPerguntas(); }
        }

        // Modal functions
        function abrirModal() {
            document.getElementById('modalTitulo').textContent = '‚ûï Nova Pergunta';
            document.getElementById('perguntaId').value = '';
            document.getElementById('pergunta').value = '';
            document.getElementById('altA').value = '';
            document.getElementById('altB').value = '';
            document.getElementById('altC').value = '';
            document.getElementById('altD').value = '';
            document.querySelectorAll('input[name="correta"]').forEach(r => r.checked = false);
            document.getElementById('timeId').value = '';
            document.getElementById('pontuacao').value = '10';
            document.getElementById('dificuldade').value = 'medio';
            document.getElementById('liga').value = '';
            document.getElementById('modalPergunta').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modalPergunta').classList.remove('active');
        }

        function editarPergunta(id) {
            const p = todasPerguntas.find(x => x.id === id);
            if (!p) return;

            document.getElementById('modalTitulo').textContent = '‚úèÔ∏è Editar Pergunta';
            document.getElementById('perguntaId').value = id;
            document.getElementById('pergunta').value = p.pergunta || '';
            
            // CORRE√á√ÉO: Usar a fun√ß√£o helper para extrair alternativas
            document.getElementById('altA').value = getAlternativa(p, 'A');
            document.getElementById('altB').value = getAlternativa(p, 'B');
            document.getElementById('altC').value = getAlternativa(p, 'C');
            document.getElementById('altD').value = getAlternativa(p, 'D');

            const correta = p.correta || 'A';
            document.querySelectorAll('input[name="correta"]').forEach(r => {
                r.checked = r.value === correta;
            });

            document.getElementById('timeId').value = p.timeId || '';
            document.getElementById('pontuacao').value = p.pontuacao || 10;
            document.getElementById('dificuldade').value = p.dificuldade || 'medio';
            document.getElementById('liga').value = p.liga || '';
            document.getElementById('modalPergunta').classList.add('active');
        }

        async function salvarPergunta() {
            const id = document.getElementById('perguntaId').value;
            const pergunta = document.getElementById('pergunta').value.trim();

            if (!pergunta) {
                alert('Digite a pergunta!');
                return;
            }

            const corretaRadio = document.querySelector('input[name="correta"]:checked');
            if (!corretaRadio) {
                alert('Selecione a alternativa correta!');
                return;
            }

            // CORRE√á√ÉO: Salvar no formato correto (alternativas como objeto)
            const dados = {
                pergunta,
                alternativas: {
                    A: document.getElementById('altA').value.trim(),
                    B: document.getElementById('altB').value.trim(),
                    C: document.getElementById('altC').value.trim(),
                    D: document.getElementById('altD').value.trim()
                },
                correta: corretaRadio.value,
                timeId: document.getElementById('timeId').value || null,
                pontuacao: parseInt(document.getElementById('pontuacao').value) || 10,
                dificuldade: document.getElementById('dificuldade').value,
                liga: document.getElementById('liga').value || null
            };

            // Adicionar nome do time se selecionado
            if (dados.timeId && timesMap[dados.timeId]) {
                dados.timeNome = timesMap[dados.timeId].nome;
            }

            try {
                if (id) {
                    await db.collection('perguntas').doc(id).update(dados);
                    alert('Pergunta atualizada!');
                } else {
                    dados.dataCriacao = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('perguntas').add(dados);
                    alert('Pergunta criada!');
                }
                fecharModal();
                carregarPerguntas();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar: ' + error.message);
            }
        }

        async function excluirPergunta(id) {
            if (!confirm('Tem certeza que deseja excluir esta pergunta?')) return;

            try {
                await db.collection('perguntas').doc(id).delete();
                alert('Pergunta exclu√≠da!');
                carregarPerguntas();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function exportarCSV() {
            let csv = 'Pergunta,Alt A,Alt B,Alt C,Alt D,Correta,Time,Dificuldade,Pontos\n';
            perguntasFiltradas.forEach(p => {
                const time = timesMap[p.timeId]?.nome || 'Geral';
                // CORRE√á√ÉO: Usar a fun√ß√£o helper para extrair alternativas
                const altA = getAlternativa(p, 'A');
                const altB = getAlternativa(p, 'B');
                const altC = getAlternativa(p, 'C');
                const altD = getAlternativa(p, 'D');
                csv += `"${(p.pergunta || '').replace(/"/g, '""')}","${altA}","${altB}","${altC}","${altD}","${p.correta}","${time}","${p.dificuldade || 'medio'}",${p.pontuacao || 10}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'perguntas_yellup.csv';
            a.click();
        }
    </script>
</body>
</html>
