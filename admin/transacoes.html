<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transa√ß√µes - Yellup Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-primary: #0c0e14; --bg-secondary: #12141c; --bg-card: #181a24;
            --bg-card-hover: #1e2030; --bg-sidebar: #10121a;
            --border: #1e2030; --border-light: #282a3a;
            --text-primary: #e8e9ed; --text-secondary: #8b8d9a; --text-muted: #5c5e6e;
            --accent: #f0b429; --accent-dim: rgba(240, 180, 41, 0.12);
            --green: #34d399; --green-dim: rgba(52, 211, 153, 0.12);
            --red: #f87171; --red-dim: rgba(248, 113, 113, 0.12);
            --blue: #60a5fa; --blue-dim: rgba(96, 165, 250, 0.12);
            --purple: #a78bfa; --purple-dim: rgba(167, 139, 250, 0.12);
            --orange: #fb923c; --orange-dim: rgba(251, 146, 60, 0.12);
            --teal: #2dd4bf; --teal-dim: rgba(45, 212, 191, 0.12);
            --sidebar-w: 250px; --header-h: 64px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

        /* SIDEBAR */
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-w); height: 100vh; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s ease; }
        .sidebar-brand { height: var(--header-h); display: flex; align-items: center; gap: 10px; padding: 0 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .sidebar-brand .logo { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; color: #000; }
        .sidebar-brand h1 { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }
        .sidebar-brand h1 span { color: var(--text-muted); font-weight: 500; font-size: 12px; margin-left: 6px; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; }
        .sidebar-nav::-webkit-scrollbar { width: 0; }
        .nav-group { margin-bottom: 8px; }
        .nav-group-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); padding: 12px 20px 6px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 16px; margin: 1px 8px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.15s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item .icon { width: 20px; text-align: center; font-size: 14px; flex-shrink: 0; }
        .sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .sidebar-footer .admin-box { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; }
        .admin-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #e09800); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #000; }
        .admin-info-text { flex: 1; }
        .admin-info-text .name { font-size: 13px; font-weight: 600; }
        .admin-info-text .role { font-size: 11px; color: var(--text-muted); }
        .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px; border-radius: 6px; }
        .btn-logout:hover { color: var(--red); background: var(--red-dim); }

        /* MAIN */
        .main { margin-left: var(--sidebar-w); min-height: 100vh; }
        .header { height: var(--header-h); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; background: var(--bg-primary); position: sticky; top: 0; z-index: 50; }
        .header-left h2 { font-size: 16px; font-weight: 600; }
        .header-left p { font-size: 12px; color: var(--text-muted); margin-top: 1px; }
        .header-actions { display: flex; gap: 8px; }
        .btn-header { display: flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.15s; text-decoration: none; }
        .btn-header:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
        .content { padding: 24px 32px 40px; }

        /* STATS */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .stat-icon-box { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-bottom: 10px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; line-height: 1; margin-bottom: 3px; }
        .stat-label { font-size: 11px; color: var(--text-muted); font-weight: 500; }

        /* FILTERS */
        .filters-bar {
            display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
            margin-bottom: 16px; padding: 16px 20px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
        }
        .filter-group { flex: 1; min-width: 140px; }
        .filter-group label { display: block; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-muted); margin-bottom: 5px; }
        .filter-group input, .filter-group select {
            width: 100%; padding: 8px 12px;
            border: 1px solid var(--border); border-radius: 8px;
            background: var(--bg-secondary); color: var(--text-primary);
            font-size: 12px; font-family: inherit;
        }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: var(--accent); }
        .filter-group select option { background: var(--bg-card); }
        .btn-filter {
            padding: 8px 18px; border-radius: 8px; border: none;
            background: var(--accent); color: #000; font-size: 12px; font-weight: 600;
            cursor: pointer; font-family: inherit; flex-shrink: 0;
        }
        .btn-filter:hover { opacity: 0.9; }

        /* TABLE */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        tbody td { padding: 10px 16px; font-size: 12px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--bg-card-hover); }
        tbody tr:last-child td { border-bottom: none; }

        .mono { font-family: 'JetBrains Mono', monospace; }
        .fw600 { font-weight: 600; }
        .val-pos { color: var(--green); font-weight: 600; }
        .val-neg { color: var(--red); font-weight: 600; }

        .badge-cat { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .badge-compra { color: var(--green); background: var(--green-dim); }
        .badge-premio { color: var(--accent); background: var(--accent-dim); }
        .badge-entrada { color: var(--blue); background: var(--blue-dim); }
        .badge-saque { color: var(--red); background: var(--red-dim); }
        .badge-bonus { color: var(--purple); background: var(--purple-dim); }
        .badge-bolsa { color: var(--teal); background: var(--teal-dim); }
        .badge-indicacao { color: var(--orange); background: var(--orange-dim); }
        .badge-outro { color: var(--text-muted); background: var(--bg-card-hover); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 13px; }

        /* PAGINATION */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 8px; padding: 16px;
        }
        .page-btn {
            padding: 6px 14px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-size: 12px; font-weight: 500;
            cursor: pointer; font-family: inherit; transition: all 0.15s;
        }
        .page-btn:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .page-info { font-size: 12px; color: var(--text-muted); padding: 0 8px; }

        /* MOBILE */
        .mobile-toggle { display: none; position: fixed; top: 16px; left: 16px; z-index: 200; width: 40px; height: 40px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; }
        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .overlay.open { display: block; }
            .mobile-toggle { display: flex; }
            .main { margin-left: 0; }
            .header { padding: 0 16px 0 64px; }
            .content { padding: 16px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .filters-bar { flex-direction: column; }
        }
    </style>
</head>
<body>

    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand"><div class="logo">Y</div><h1>Yellup <span>Admin</span></h1></div>
        <nav class="sidebar-nav">
            <div class="nav-group"><div class="nav-group-title">Vis√£o Geral</div><a href="dashboard.html" class="nav-item"><span class="icon">üìä</span> Dashboard</a></div>
            <div class="nav-group"><div class="nav-group-title">Conte√∫do</div><a href="jogos.html" class="nav-item"><span class="icon">üéÆ</span> Jogos</a><a href="perguntas.html" class="nav-item"><span class="icon">‚ùì</span> Perguntas</a><a href="importar-perguntas.html" class="nav-item"><span class="icon">üì•</span> Importar</a><a href="gerar-perguntas.html" class="nav-item"><span class="icon">ü§ñ</span> Gerar com IA</a><a href="times.html" class="nav-item"><span class="icon">‚öΩ</span> Times</a></div>
            <div class="nav-group"><div class="nav-group-title">Jogadores</div><a href="usuarios.html" class="nav-item"><span class="icon">üë•</span> Usu√°rios</a><a href="ranking.html" class="nav-item"><span class="icon">üèÜ</span> Rankings</a><a href="admin-noticias.html" class="nav-item"><span class="icon">üì∞</span> Not√≠cias</a></div>
            <div class="nav-group"><div class="nav-group-title">Competi√ß√µes</div><a href="torneios.html" class="nav-item"><span class="icon">üèÖ</span> Torneios</a><a href="inicializar-pvp.html" class="nav-item"><span class="icon">‚öîÔ∏è</span> Embates PvP</a></div>
            <div class="nav-group"><div class="nav-group-title">Financeiro</div><a href="financeiro.html" class="nav-item"><span class="icon">üí∞</span> Resumo</a><a href="creditar-manual.html" class="nav-item"><span class="icon">‚ûï</span> Creditar Manual</a><a href="transacoes.html" class="nav-item active"><span class="icon">üí≥</span> Transa√ß√µes</a><a href="premiacao.html" class="nav-item"><span class="icon">üéÅ</span> Premia√ß√£o</a><a href="indicacoes.html" class="nav-item"><span class="icon">üîó</span> Indica√ß√µes</a></div>
            <div class="nav-group"><div class="nav-group-title">Bolsa</div><a href="bolsa-admin.html" class="nav-item"><span class="icon">üìà</span> Gest√£o da Bolsa</a></div>
            <div class="nav-group"><div class="nav-group-title">Sistema</div><a href="configuracoes.html" class="nav-item"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a><a href="checkup.html" class="nav-item"><span class="icon">üîç</span> Checkup</a><a href="simulador_avancado.html" class="nav-item"><span class="icon">üß™</span> Simulador</a><a href="teste-regras.html" class="nav-item"><span class="icon">üìú</span> Regras</a></div>
        </nav>
        <div class="sidebar-footer"><div class="admin-box"><div class="admin-avatar">A</div><div class="admin-info-text"><div class="name">Admin</div><div class="role">Administrador</div></div><button class="btn-logout" onclick="sair()" title="Sair">‚èª</button></div></div>
    </aside>

    <!-- MAIN -->
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h2>üí≥ Transa√ß√µes</h2>
                <p>Hist√≥rico de todas as movimenta√ß√µes de cr√©ditos</p>
            </div>
            <div class="header-actions">
                <button class="btn-header" onclick="carregarDados()">‚Üª Atualizar</button>
            </div>
        </header>

        <div class="content">
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--green-dim)">üì•</div>
                    <div class="stat-value" style="color:var(--green)" id="totalEntradas">...</div>
                    <div class="stat-label">Entradas (cr√©ditos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--red-dim)">üì§</div>
                    <div class="stat-value" style="color:var(--red)" id="totalSaidas">...</div>
                    <div class="stat-label">Sa√≠das (cr√©ditos)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--blue-dim)">üìä</div>
                    <div class="stat-value" style="color:var(--blue)" id="totalTransacoes">...</div>
                    <div class="stat-label">Total transa√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--accent-dim)">üí∞</div>
                    <div class="stat-value" style="color:var(--accent)" id="saldoLiquido">...</div>
                    <div class="stat-label">Saldo l√≠quido</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Buscar Usu√°rio</label>
                    <input type="text" id="filtroUsuario" placeholder="Nome ou email...">
                </div>
                <div class="filter-group">
                    <label>Tipo</label>
                    <select id="filtroTipo">
                        <option value="">Todos</option>
                        <option value="credito">Cr√©dito (+)</option>
                        <option value="debito">D√©bito (‚àí)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Categoria</label>
                    <select id="filtroCategoria">
                        <option value="">Todas</option>
                        <option value="compra">üõí Compra</option>
                        <option value="premio">üèÜ Pr√™mio</option>
                        <option value="entrada">üéÆ Entrada Jogo</option>
                        <option value="bonus">üéÅ B√¥nus</option>
                        <option value="bolsa">üìà Bolsa</option>
                        <option value="indicacao">üîó Indica√ß√£o</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Data In√≠cio</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="filter-group">
                    <label>Data Fim</label>
                    <input type="date" id="dataFim">
                </div>
                <button class="btn-filter" onclick="aplicarFiltros()">üîç Filtrar</button>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usu√°rio</th>
                                <th>Descri√ß√£o</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="tabela">
                            <tr><td colspan="5" class="empty-state">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button class="page-btn" id="btnAnterior" onclick="paginaAnterior()" disabled>‚Üê Anterior</button>
                    <span class="page-info" id="paginaInfo">P√°gina 1</span>
                    <button class="page-btn" id="btnProximo" onclick="proximaPagina()">Pr√≥ximo ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
            authDomain: "painel-yellup.firebaseapp.com",
            projectId: "painel-yellup",
            storageBucket: "painel-yellup.appspot.com",
            messagingSenderId: "608347210297",
            appId: "1:608347210297:web:75092713724e617c7203e8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let todasTransacoes = [];
        let transacoesFiltradas = [];
        let usuarios = {};
        let pagina = 1;
        const porPagina = 25;

        auth.onAuthStateChanged(user => {
            if (!user || user.email !== 'admin@yellup.com') {
                window.location.href = 'login.html';
                return;
            }
            carregarDados();
        });

        function sair() { auth.signOut().then(() => window.location.href = 'login.html'); }
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        // ===================================
        // CARREGAR DADOS
        // ===================================
        async function carregarDados() {
            try {
                // Carregar mapa de usu√°rios
                const usersSnap = await db.collection('usuarios').get();
                usersSnap.forEach(doc => {
                    const u = doc.data();
                    usuarios[doc.id] = u.nome || u.usuarioUnico || u.email || doc.id.substring(0, 8);
                });

                // Carregar transa√ß√µes
                const snap = await db.collection('transacoes')
                    .orderBy('data', 'desc').limit(500).get();
                todasTransacoes = [];
                snap.forEach(doc => todasTransacoes.push({ id: doc.id, ...doc.data() }));

                transacoesFiltradas = [...todasTransacoes];
                atualizarStats();
                renderizar();
            } catch (e) {
                console.error('Erro:', e);
            }
        }

        // ===================================
        // STATS
        // ===================================
        function atualizarStats() {
            let entradas = 0, saidas = 0;
            transacoesFiltradas.forEach(t => {
                if (t.tipo === 'credito') entradas += t.valor || 0;
                else saidas += t.valor || 0;
            });

            document.getElementById('totalEntradas').textContent = entradas.toLocaleString('pt-BR');
            document.getElementById('totalSaidas').textContent = saidas.toLocaleString('pt-BR');
            document.getElementById('totalTransacoes').textContent = transacoesFiltradas.length;
            document.getElementById('saldoLiquido').textContent = (entradas - saidas).toLocaleString('pt-BR');
        }

        // ===================================
        // FILTROS
        // ===================================
        function aplicarFiltros() {
            const usuario = document.getElementById('filtroUsuario').value.toLowerCase();
            const tipo = document.getElementById('filtroTipo').value;
            const categoria = document.getElementById('filtroCategoria').value;
            const dataInicio = document.getElementById('dataInicio').value ? new Date(document.getElementById('dataInicio').value) : null;
            const dataFim = document.getElementById('dataFim').value ? new Date(document.getElementById('dataFim').value + 'T23:59:59') : null;

            transacoesFiltradas = todasTransacoes.filter(t => {
                const nomeUsuario = (usuarios[t.usuarioId] || '').toLowerCase();
                const dataT = t.data?.toDate ? t.data.toDate() : new Date(0);

                if (usuario && !nomeUsuario.includes(usuario)) return false;
                if (tipo && t.tipo !== tipo) return false;
                if (categoria && !(t.categoria || '').toLowerCase().includes(categoria)) return false;
                if (dataInicio && dataT < dataInicio) return false;
                if (dataFim && dataT > dataFim) return false;
                return true;
            });

            pagina = 1;
            atualizarStats();
            renderizar();
        }

        // ===================================
        // RENDERIZAR
        // ===================================
        function renderizar() {
            const tbody = document.getElementById('tabela');
            const inicio = (pagina - 1) * porPagina;
            const fim = inicio + porPagina;
            const paginadas = transacoesFiltradas.slice(inicio, fim);

            if (paginadas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">üí≥ Nenhuma transa√ß√£o encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = paginadas.map(t => {
                const data = t.data?.toDate ? t.data.toDate().toLocaleString('pt-BR') : '‚Äî';
                const usuario = usuarios[t.usuarioId] || t.usuarioId?.substring(0, 8) || '‚Äî';
                const valorClass = t.tipo === 'credito' ? 'val-pos' : 'val-neg';
                const prefix = t.tipo === 'credito' ? '+' : '‚àí';
                const badge = getBadge(t.categoria);

                return `<tr>
                    <td style="white-space:nowrap">${data}</td>
                    <td class="fw600">${usuario}</td>
                    <td>${t.descricao || '‚Äî'}</td>
                    <td><span class="badge-cat ${badge.cls}">${badge.text}</span></td>
                    <td class="mono ${valorClass}">${prefix}${(t.valor || 0).toLocaleString('pt-BR')}</td>
                </tr>`;
            }).join('');

            // Pagina√ß√£o
            const totalPaginas = Math.ceil(transacoesFiltradas.length / porPagina) || 1;
            document.getElementById('paginaInfo').textContent = `P√°gina ${pagina} de ${totalPaginas}`;
            document.getElementById('btnAnterior').disabled = pagina === 1;
            document.getElementById('btnProximo').disabled = fim >= transacoesFiltradas.length;
        }

        function getBadge(cat) {
            const map = {
                compra: { cls: 'badge-compra', text: 'üõí Compra' },
                premio: { cls: 'badge-premio', text: 'üèÜ Pr√™mio' },
                entrada: { cls: 'badge-entrada', text: 'üéÆ Entrada' },
                saque: { cls: 'badge-saque', text: 'üí∏ Saque' },
                bonus: { cls: 'badge-bonus', text: 'üéÅ B√¥nus' },
                credito_manual: { cls: 'badge-bonus', text: '‚ûï Manual' },
                bolsa: { cls: 'badge-bolsa', text: 'üìà Bolsa' },
                indicacao: { cls: 'badge-indicacao', text: 'üîó Indica√ß√£o' }
            };
            for (const [key, val] of Object.entries(map)) {
                if ((cat || '').toLowerCase().includes(key)) return val;
            }
            return { cls: 'badge-outro', text: cat || 'Outro' };
        }

        function paginaAnterior() { if (pagina > 1) { pagina--; renderizar(); } }
        function proximaPagina() { if (pagina * porPagina < transacoesFiltradas.length) { pagina++; renderizar(); } }
    </script>
</body>
</html>
