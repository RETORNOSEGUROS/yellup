<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Torneios - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: rgba(14, 20, 27, 0.95);
      backdrop-filter: blur(20px);
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-back {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.5em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .btn-create {
      padding: 12px 24px;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      border: none;
      border-radius: 10px;
      color: #0e141b;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 181, 71, 0.3);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Page Title */
    .page-title {
      font-size: 2em;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .page-subtitle {
      color: #a9b5c6;
      margin-bottom: 30px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 800;
      color: #ffb547;
    }

    .stat-label {
      font-size: 0.9em;
      color: #a9b5c6;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #a9b5c6;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 10px;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .tab.active {
      background: rgba(255, 181, 71, 0.2);
      color: #ffb547;
    }

    /* Torneio Card */
    .torneio-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .torneio-card {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      transition: all 0.3s ease;
    }

    .torneio-card:hover {
      border-color: rgba(255, 181, 71, 0.3);
      transform: translateY(-2px);
    }

    .torneio-icon {
      font-size: 2.5em;
      width: 60px;
      text-align: center;
    }

    .torneio-info {
      flex: 1;
    }

    .torneio-nome {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .torneio-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      font-size: 0.9em;
      color: #a9b5c6;
      margin-bottom: 10px;
    }

    .torneio-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .torneio-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
    }

    .torneio-status.rascunho {
      background: rgba(107, 114, 128, 0.3);
      color: #9ca3af;
    }

    .torneio-status.inscricoes_abertas {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .torneio-status.inscricoes_fechadas {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .torneio-status.em_andamento {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .torneio-status.finalizado {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .torneio-status.cancelado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .torneio-actions {
      display: flex;
      gap: 10px;
    }

    .btn-action {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-action.primary {
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      color: #0e141b;
    }

    .btn-action.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .btn-action.danger {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .btn-action:hover {
      transform: translateY(-2px);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a9b5c6;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 20px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    /* Modal de Detalhes */
    #modalDetalhes {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    #modalDetalhes.active {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, #1e2936 0%, #182230 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.3em;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #a9b5c6;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #a9b5c6;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 1em;
      font-family: 'Poppins', sans-serif;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #ffb547;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .form-hint {
      font-size: 0.85em;
      color: #6b7280;
      margin-top: 5px;
    }

    /* Radio Cards */
    .radio-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .radio-card {
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }

    .radio-card:hover {
      border-color: rgba(255, 181, 71, 0.5);
    }

    .radio-card.selected {
      border-color: #ffb547;
      background: rgba(255, 181, 71, 0.15);
    }

    .radio-card-icon {
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    .radio-card-label {
      font-weight: 600;
      font-size: 0.9em;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(30, 41, 54, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 25px;
      border-radius: 12px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .torneio-card {
        flex-direction: column;
        text-align: center;
      }

      .torneio-meta {
        justify-content: center;
      }

      .torneio-actions {
        width: 100%;
        justify-content: center;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="btn-back" onclick="window.location.href='dashboard.html'">‚Üê Voltar</button>
      <div class="logo">YELLUP ADMIN</div>
      <button class="btn-create" onclick="abrirModalCriar()">+ Criar Torneio</button>
    </div>
  </div>

  <!-- Container -->
  <div class="container">
    
    <h1 class="page-title">üèÜ Gerenciar Torneios</h1>
    <p class="page-subtitle">Crie e gerencie torneios para a comunidade</p>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total de Torneios</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAtivos">0</div>
        <div class="stat-label">Ativos Agora</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statInscritos">0</div>
        <div class="stat-label">Total Inscritos</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPrize">0</div>
        <div class="stat-label">Prize Pool Total</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="filtrarTorneios('todos')" id="tabTodos">Todos</button>
      <button class="tab" onclick="filtrarTorneios('rascunho')" id="tabRascunho">Rascunhos</button>
      <button class="tab" onclick="filtrarTorneios('inscricoes_abertas')" id="tabAbertos">Inscri√ß√µes Abertas</button>
      <button class="tab" onclick="filtrarTorneios('em_andamento')" id="tabAndamento">Em Andamento</button>
      <button class="tab" onclick="filtrarTorneios('finalizado')" id="tabFinalizado">Finalizados</button>
    </div>

    <!-- Lista de Torneios -->
    <div class="torneio-list" id="torneiosList">
      <div class="empty-state">
        <div class="empty-icon">üèÜ</div>
        <p>Nenhum torneio encontrado</p>
        <p>Clique em "Criar Torneio" para come√ßar</p>
      </div>
    </div>

  </div>

  <!-- Modal Criar Torneio -->
  <div class="modal-overlay" id="modalCriar">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üèÜ Criar Novo Torneio</div>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- Nome e Descri√ß√£o -->
        <div class="form-group">
          <label class="form-label">Nome do Torneio</label>
          <input type="text" class="form-input" id="torneioNome" placeholder="Ex: Torneio Semanal Yellup">
        </div>

        <div class="form-group">
          <label class="form-label">Descri√ß√£o</label>
          <textarea class="form-textarea" id="torneioDescricao" placeholder="Descreva o torneio..."></textarea>
        </div>

        <!-- Tema -->
        <div class="form-group">
          <label class="form-label">Tema</label>
          <div class="radio-cards">
            <div class="radio-card selected" onclick="selecionarTema('misto')" id="temaMisto">
              <div class="radio-card-icon">üéØ</div>
              <div class="radio-card-label">Misto</div>
            </div>
            <div class="radio-card" onclick="selecionarTema('time')" id="temaTime">
              <div class="radio-card-icon">‚öΩ</div>
              <div class="radio-card-label">Time Espec√≠fico</div>
            </div>
            <div class="radio-card" onclick="selecionarTema('campeonato')" id="temaCampeonato">
              <div class="radio-card-icon">üèÜ</div>
              <div class="radio-card-label">Campeonato</div>
            </div>
          </div>
        </div>

        <!-- Estilo de Jogo -->
        <div class="form-group">
          <label class="form-label">Estilo de Jogo</label>
          <div class="radio-cards">
            <div class="radio-card selected" onclick="selecionarEstilo('pontuacao')" id="estiloPontuacao">
              <div class="radio-card-icon">üìä</div>
              <div class="radio-card-label">Pontua√ß√£o</div>
            </div>
            <div class="radio-card" onclick="selecionarEstilo('sobrevivencia')" id="estiloSobrevivencia">
              <div class="radio-card-icon">‚ù§Ô∏è</div>
              <div class="radio-card-label">Sobreviv√™ncia</div>
            </div>
          </div>
        </div>

        <!-- Formato -->
        <div class="form-group">
          <label class="form-label">Formato do Torneio</label>
          <div class="radio-cards">
            <div class="radio-card selected" onclick="selecionarFormato('fase_unica')" id="formatoFaseUnica">
              <div class="radio-card-icon">1Ô∏è‚É£</div>
              <div class="radio-card-label">Fase √önica</div>
            </div>
            <div class="radio-card" onclick="selecionarFormato('grupos_eliminatorias')" id="formatoGrupos">
              <div class="radio-card-icon">üîÑ</div>
              <div class="radio-card-label">Grupos + Elim.</div>
            </div>
            <div class="radio-card" onclick="selecionarFormato('eliminatorias')" id="formatoEliminatorias">
              <div class="radio-card-icon">üèÖ</div>
              <div class="radio-card-label">Eliminat√≥rias</div>
            </div>
          </div>
        </div>

        <!-- Participantes -->
        <div class="form-group">
          <label class="form-label">Participantes</label>
          <div class="form-row">
            <div>
              <input type="number" class="form-input" id="torneioMin" placeholder="M√≠nimo" value="8">
              <p class="form-hint">M√≠nimo para iniciar</p>
            </div>
            <div>
              <input type="number" class="form-input" id="torneioMax" placeholder="M√°ximo" value="64">
              <p class="form-hint">M√°ximo de vagas (0 = ilimitado)</p>
            </div>
          </div>
        </div>

        <!-- Taxa e Dura√ß√£o -->
        <div class="form-group">
          <label class="form-label">Configura√ß√µes</label>
          <div class="form-row">
            <div>
              <input type="number" class="form-input" id="torneioTaxa" placeholder="Taxa de inscri√ß√£o" value="10">
              <p class="form-hint">Cr√©ditos de entrada</p>
            </div>
            <div>
              <input type="number" class="form-input" id="torneioDuracao" placeholder="Dura√ß√£o" value="15">
              <p class="form-hint">Minutos por fase</p>
            </div>
          </div>
        </div>

        <!-- Premia√ß√£o -->
        <div class="form-group">
          <label class="form-label">Distribui√ß√£o de Pr√™mios (%)</label>
          <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
            <div>
              <input type="number" class="form-input" id="premio1" placeholder="1¬∫" value="50">
              <p class="form-hint">1¬∫ lugar</p>
            </div>
            <div>
              <input type="number" class="form-input" id="premio2" placeholder="2¬∫" value="30">
              <p class="form-hint">2¬∫ lugar</p>
            </div>
            <div>
              <input type="number" class="form-input" id="premio3" placeholder="3¬∫" value="20">
              <p class="form-hint">3¬∫ lugar</p>
            </div>
          </div>
        </div>

        <!-- Agendamento -->
        <div class="form-group">
          <label class="form-label">Agendamento</label>
          <div class="form-row">
            <div>
              <input type="datetime-local" class="form-input" id="torneioInscricaoAbre">
              <p class="form-hint">Inscri√ß√µes abrem</p>
            </div>
            <div>
              <input type="datetime-local" class="form-input" id="torneioInscricaoFecha">
              <p class="form-hint">Inscri√ß√µes fecham</p>
            </div>
          </div>
          <div style="margin-top: 10px;">
            <input type="datetime-local" class="form-input" id="torneioInicio">
            <p class="form-hint">Torneio inicia</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-action secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn-action secondary" onclick="salvarRascunho()">Salvar Rascunho</button>
        <button class="btn-action primary" onclick="publicarTorneio()">Publicar Agora</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Modal Detalhes -->
  <div class="modal" id="modalDetalhes">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 id="detalheTitulo">Detalhes do Torneio</h2>
        <button class="modal-close" onclick="fecharModalDetalhes()">√ó</button>
      </div>
      <div class="modal-body" id="detalheBody">
        <!-- Conte√∫do din√¢mico -->
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-init.js"></script>

  <script>
    // ===================================
    // GARANTIR QUE AUTH EXISTE
    // ===================================
    var auth = firebase.auth();

    // ===================================
    // VARI√ÅVEIS GLOBAIS
    // ===================================
    var currentUserId = null;
    var todosTorneios = [];
    var filtroAtual = 'todos';
    
    // Dados do novo torneio
    var novoTorneio = {
      tema: 'misto',
      estilo: 'pontuacao',
      formato: 'fase_unica'
    };

    // ===================================
    // INICIALIZA√á√ÉO
    // ===================================
    auth.onAuthStateChanged(async user => {
      if (!user || user.email !== "admin@yellup.com") {
        window.location.href = 'login.html';
        return;
      }

      currentUserId = user.uid;
      carregarTorneios();
    });

    // ===================================
    // CARREGAR TORNEIOS
    // ===================================
    async function carregarTorneios() {
      try {
        const snapshot = await db.collection('torneios')
          .orderBy('dataCriacao', 'desc')
          .get();
        
        todosTorneios = [];
        snapshot.forEach(doc => {
          todosTorneios.push({ id: doc.id, ...doc.data() });
        });

        atualizarStats();
        renderizarTorneios();
        
      } catch (error) {
        console.error("Erro ao carregar torneios:", error);
      }
    }

    // ===================================
    // ATUALIZAR STATS
    // ===================================
    function atualizarStats() {
      const ativos = todosTorneios.filter(t => 
        ['inscricoes_abertas', 'em_andamento'].includes(t.status)
      ).length;
      
      const totalInscritos = todosTorneios.reduce((sum, t) => 
        sum + (t.totalInscritos || 0), 0
      );
      
      const totalPrize = todosTorneios.reduce((sum, t) => 
        sum + (t.prizePool || 0), 0
      );

      document.getElementById('statTotal').textContent = todosTorneios.length;
      document.getElementById('statAtivos').textContent = ativos;
      document.getElementById('statInscritos').textContent = totalInscritos;
      document.getElementById('statPrize').textContent = `${totalPrize} üíé`;
    }

    // ===================================
    // RENDERIZAR TORNEIOS
    // ===================================
    function renderizarTorneios() {
      const container = document.getElementById('torneiosList');
      
      let torneiosFiltrados = todosTorneios;
      if (filtroAtual !== 'todos') {
        torneiosFiltrados = todosTorneios.filter(t => t.status === filtroAtual);
      }

      if (torneiosFiltrados.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üèÜ</div>
            <p>Nenhum torneio encontrado</p>
          </div>
        `;
        return;
      }

      container.innerHTML = torneiosFiltrados.map(t => {
        const statusLabels = {
          rascunho: 'Rascunho',
          inscricoes_abertas: 'Inscri√ß√µes Abertas',
          inscricoes_fechadas: 'Inscri√ß√µes Fechadas',
          em_andamento: 'Em Andamento',
          finalizado: 'Finalizado',
          cancelado: 'Cancelado'
        };

        const dataInicio = t.agendamento?.dataInicio?.toDate?.() 
          ? t.agendamento.dataInicio.toDate().toLocaleString('pt-BR')
          : '-';

        return `
          <div class="torneio-card">
            <div class="torneio-icon">üèÜ</div>
            <div class="torneio-info">
              <div class="torneio-nome">${t.nome || 'Sem nome'}</div>
              <div class="torneio-meta">
                <span class="torneio-meta-item">üë• ${t.totalInscritos || 0}/${t.config?.maxParticipantes || '‚àû'}</span>
                <span class="torneio-meta-item">üíé ${t.prizePool || 0}</span>
                <span class="torneio-meta-item">üìÖ ${dataInicio}</span>
              </div>
              <span class="torneio-status ${t.status}">${statusLabels[t.status] || t.status}</span>
            </div>
            <div class="torneio-actions">
              ${t.status === 'rascunho' ? `
                <button class="btn-action primary" onclick="publicarTorneioExistente('${t.id}')">Publicar</button>
                <button class="btn-action secondary" onclick="editarTorneio('${t.id}')">Editar</button>
                <button class="btn-action danger" onclick="excluirTorneio('${t.id}')">Excluir</button>
              ` : t.status === 'inscricoes_abertas' ? `
                <button class="btn-action secondary" onclick="verDetalhes('${t.id}')">Ver</button>
                <button class="btn-action danger" onclick="cancelarTorneio('${t.id}')">Cancelar</button>
              ` : t.status === 'em_andamento' ? `
                <button class="btn-action primary" onclick="verAoVivo('${t.id}')">Ao Vivo</button>
              ` : `
                <button class="btn-action secondary" onclick="verDetalhes('${t.id}')">Ver Resultado</button>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    // ===================================
    // FILTRAR TORNEIOS
    // ===================================
    function filtrarTorneios(filtro) {
      filtroAtual = filtro;
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      const tabMap = {
        todos: 'tabTodos',
        rascunho: 'tabRascunho',
        inscricoes_abertas: 'tabAbertos',
        em_andamento: 'tabAndamento',
        finalizado: 'tabFinalizado'
      };
      
      document.getElementById(tabMap[filtro])?.classList.add('active');
      renderizarTorneios();
    }

    // ===================================
    // MODAL
    // ===================================
    function abrirModalCriar() {
      document.getElementById('modalCriar').classList.add('show');
      
      // Valores padr√£o de data
      const agora = new Date();
      const amanha = new Date(agora.getTime() + 24 * 60 * 60 * 1000);
      
      document.getElementById('torneioInscricaoAbre').value = formatarDataInput(agora);
      document.getElementById('torneioInscricaoFecha').value = formatarDataInput(amanha);
      document.getElementById('torneioInicio').value = formatarDataInput(new Date(amanha.getTime() + 60 * 60 * 1000));
    }

    function fecharModal() {
      document.getElementById('modalCriar').classList.remove('show');
    }

    function formatarDataInput(date) {
      return date.toISOString().slice(0, 16);
    }

    // ===================================
    // SELE√á√ïES
    // ===================================
    function selecionarTema(tema) {
      novoTorneio.tema = tema;
      document.querySelectorAll('[id^="tema"]').forEach(el => el.classList.remove('selected'));
      document.getElementById(`tema${tema.charAt(0).toUpperCase() + tema.slice(1)}`).classList.add('selected');
    }

    function selecionarEstilo(estilo) {
      novoTorneio.estilo = estilo;
      document.querySelectorAll('[id^="estilo"]').forEach(el => el.classList.remove('selected'));
      document.getElementById(`estilo${estilo.charAt(0).toUpperCase() + estilo.slice(1)}`).classList.add('selected');
    }

    function selecionarFormato(formato) {
      novoTorneio.formato = formato;
      document.querySelectorAll('[id^="formato"]').forEach(el => el.classList.remove('selected'));
      
      const formatoMap = {
        fase_unica: 'FaseUnica',
        grupos_eliminatorias: 'Grupos',
        eliminatorias: 'Eliminatorias'
      };
      document.getElementById(`formato${formatoMap[formato]}`).classList.add('selected');
    }

    // ===================================
    // CRIAR TORNEIO
    // ===================================
    async function criarTorneio(status) {
      const nome = document.getElementById('torneioNome').value.trim();
      const descricao = document.getElementById('torneioDescricao').value.trim();
      const minParticipantes = parseInt(document.getElementById('torneioMin').value) || 8;
      const maxParticipantes = parseInt(document.getElementById('torneioMax').value) || 0;
      const taxaInscricao = parseInt(document.getElementById('torneioTaxa').value) || 10;
      const duracaoFase = parseInt(document.getElementById('torneioDuracao').value) || 15;
      const premio1 = parseInt(document.getElementById('premio1').value) || 50;
      const premio2 = parseInt(document.getElementById('premio2').value) || 30;
      const premio3 = parseInt(document.getElementById('premio3').value) || 20;
      
      const inscricaoAbre = document.getElementById('torneioInscricaoAbre').value;
      const inscricaoFecha = document.getElementById('torneioInscricaoFecha').value;
      const inicio = document.getElementById('torneioInicio').value;

      if (!nome) {
        showToast('‚ùå Digite o nome do torneio');
        return;
      }

      if (!inscricaoAbre || !inscricaoFecha || !inicio) {
        showToast('‚ùå Preencha todas as datas');
        return;
      }

      try {
        const codigo = 'TRN-' + new Date().getFullYear() + '-' + 
                       Math.random().toString(36).substring(2, 6).toUpperCase();

        await db.collection('torneios').add({
          codigo,
          nome,
          descricao,
          
          tema: {
            tipo: novoTorneio.tema,
            id: null,
            nome: novoTorneio.tema === 'misto' ? 'Misto' : null
          },
          
          config: {
            estilo: novoTorneio.estilo,
            formato: novoTorneio.formato,
            vagasIlimitadas: maxParticipantes === 0,
            maxParticipantes: maxParticipantes || 9999,
            minParticipantes,
            taxaInscricao,
            duracaoFase,
            distribuicaoPremio: {
              primeiro: premio1,
              segundo: premio2,
              terceiro: premio3
            }
          },
          
          agendamento: {
            inscricoesAbrem: firebase.firestore.Timestamp.fromDate(new Date(inscricaoAbre)),
            inscricoesFecham: firebase.firestore.Timestamp.fromDate(new Date(inscricaoFecha)),
            dataInicio: firebase.firestore.Timestamp.fromDate(new Date(inicio)),
            dataFim: null
          },
          
          inscritos: [],
          totalInscritos: 0,
          prizePool: 0,
          
          status,
          
          faseAtual: null,
          resultado: null,
          
          criadoPor: currentUserId,
          dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`‚úÖ Torneio ${status === 'rascunho' ? 'salvo como rascunho' : 'publicado'}!`);
        fecharModal();
        carregarTorneios();
        
      } catch (error) {
        console.error("Erro ao criar torneio:", error);
        showToast('‚ùå Erro ao criar torneio');
      }
    }

    function salvarRascunho() {
      criarTorneio('rascunho');
    }

    function publicarTorneio() {
      criarTorneio('inscricoes_abertas');
    }

    // ===================================
    // A√á√ïES DOS TORNEIOS
    // ===================================
    async function publicarTorneioExistente(id) {
      try {
        await db.collection('torneios').doc(id).update({
          status: 'inscricoes_abertas',
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('‚úÖ Torneio publicado!');
        carregarTorneios();
      } catch (error) {
        showToast('‚ùå Erro ao publicar');
      }
    }

    async function cancelarTorneio(id) {
      if (!confirm('Tem certeza que deseja cancelar este torneio? Os cr√©ditos ser√£o devolvidos.')) {
        return;
      }
      
      try {
        // TODO: Implementar devolu√ß√£o de cr√©ditos
        await db.collection('torneios').doc(id).update({
          status: 'cancelado',
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('‚úÖ Torneio cancelado');
        carregarTorneios();
      } catch (error) {
        showToast('‚ùå Erro ao cancelar');
      }
    }

    async function excluirTorneio(id) {
      if (!confirm('Tem certeza que deseja excluir este torneio?')) {
        return;
      }
      
      try {
        await db.collection('torneios').doc(id).delete();
        showToast('‚úÖ Torneio exclu√≠do');
        carregarTorneios();
      } catch (error) {
        showToast('‚ùå Erro ao excluir');
      }
    }

    function verDetalhes(id) {
      const torneio = todosTorneios.find(t => t.id === id);
      if (!torneio) return;

      document.getElementById('detalheTitulo').textContent = torneio.nome || 'Torneio';
      
      const statusMap = {
        'rascunho': { texto: 'Rascunho', cor: '#6b7280' },
        'inscricoes_abertas': { texto: 'Inscri√ß√µes Abertas', cor: '#10b981' },
        'inscricoes_fechadas': { texto: 'Inscri√ß√µes Fechadas', cor: '#f59e0b' },
        'em_andamento': { texto: 'Em Andamento', cor: '#3b82f6' },
        'finalizado': { texto: 'Finalizado', cor: '#6b7280' },
        'cancelado': { texto: 'Cancelado', cor: '#ef4444' }
      };
      
      const status = statusMap[torneio.status] || { texto: torneio.status, cor: '#6b7280' };
      const dataInicio = torneio.agendamento?.dataInicio?.toDate?.() || null;
      const dataInicioStr = dataInicio ? dataInicio.toLocaleString('pt-BR') : 'N√£o definido';
      
      const config = torneio.config || {};
      const maxParticipantes = config.maxParticipantes === 0 || config.maxParticipantes === 9999 ? '‚àû' : config.maxParticipantes || 64;

      let botoesAcao = '';
      
      if (torneio.status === 'inscricoes_abertas') {
        botoesAcao = `
          <button onclick="iniciarTorneio('${id}')" style="flex:1; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer;">
            üöÄ Iniciar Torneio Agora
          </button>
        `;
      } else if (torneio.status === 'em_andamento') {
        botoesAcao = `
          <button onclick="verAoVivo('${id}')" style="flex:1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer;">
            üì∫ Ver Ao Vivo
          </button>
          <button onclick="finalizarTorneio('${id}')" style="flex:1; padding: 14px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer;">
            üèÅ Finalizar Torneio
          </button>
        `;
      } else if (torneio.status === 'rascunho') {
        botoesAcao = `
          <button onclick="publicarTorneioExistente('${id}'); fecharModalDetalhes();" style="flex:1; padding: 14px; background: linear-gradient(135deg, #ffb547, #ff8c42); border: none; border-radius: 10px; color: #0e141b; font-weight: 700; cursor: pointer;">
            üì¢ Publicar Torneio
          </button>
        `;
      }

      document.getElementById('detalheBody').innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <!-- Status -->
          <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px;">
            <span style="background: ${status.cor}; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;">
              ${status.texto}
            </span>
          </div>

          <!-- Info Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; text-align: center;">
              <div style="font-size: 1.8em; font-weight: 700; color: #ffb547;">${torneio.totalInscritos || 0}</div>
              <div style="color: #a9b5c6; font-size: 0.85em;">de ${maxParticipantes} inscritos</div>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; text-align: center;">
              <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">${torneio.prizePool || 0} üíé</div>
              <div style="color: #a9b5c6; font-size: 0.85em;">Prize Pool</div>
            </div>
          </div>

          <!-- Detalhes -->
          <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #a9b5c6;">üìÖ In√≠cio:</span>
              <span>${dataInicioStr}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #a9b5c6;">üéÆ Estilo:</span>
              <span>${config.estilo === 'sobrevivencia' ? '‚ù§Ô∏è Sobreviv√™ncia' : 'üéØ Pontua√ß√£o'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #a9b5c6;">üí∞ Taxa:</span>
              <span>${config.taxaInscricao || 0} üíé</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
              <span style="color: #a9b5c6;">‚è±Ô∏è Dura√ß√£o:</span>
              <span>${config.duracaoFase || 15} minutos</span>
            </div>
          </div>

          <!-- A√ß√µes -->
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            ${botoesAcao}
          </div>
          
          <button onclick="fecharModalDetalhes()" style="padding: 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: #fff; cursor: pointer;">
            Fechar
          </button>
        </div>
      `;
      
      document.getElementById('modalDetalhes').classList.add('active');
    }

    function fecharModalDetalhes() {
      document.getElementById('modalDetalhes').classList.remove('active');
    }

    async function iniciarTorneio(id) {
      if (!confirm('Tem certeza que deseja INICIAR o torneio agora? Os jogadores poder√£o come√ßar a jogar imediatamente.')) {
        return;
      }
      
      try {
        const torneio = todosTorneios.find(t => t.id === id);
        const duracaoMinutos = torneio?.config?.duracaoFase || 15;
        const dataFim = new Date(Date.now() + duracaoMinutos * 60 * 1000);
        
        await db.collection('torneios').doc(id).update({
          status: 'em_andamento',
          'agendamento.dataInicio': firebase.firestore.FieldValue.serverTimestamp(),
          'agendamento.dataFim': firebase.firestore.Timestamp.fromDate(dataFim),
          ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('üöÄ Torneio iniciado!');
        fecharModalDetalhes();
        carregarTorneios();
      } catch (error) {
        console.error("Erro ao iniciar:", error);
        showToast('‚ùå Erro ao iniciar torneio');
      }
    }

    async function finalizarTorneio(id) {
      if (!confirm('Tem certeza que deseja FINALIZAR o torneio? Isso vai calcular o ranking e distribuir os pr√™mios.')) {
        return;
      }
      
      showToast('üèÅ Calculando resultado...');
      
      try {
        // Buscar dados do torneio
        const torneioDoc = await db.collection('torneios').doc(id).get();
        const torneioAtual = torneioDoc.data();
        
        if (torneioAtual.status === 'finalizado') {
          showToast('‚ö†Ô∏è Torneio j√° foi finalizado');
          fecharModalDetalhes();
          carregarTorneios();
          return;
        }
        
        // Buscar ranking final (ordenado por pontos)
        const participacoesSnap = await db.collection('torneios').doc(id)
          .collection('participacoes').orderBy('pontos', 'desc').get();
        
        let ranking = [];
        participacoesSnap.forEach(doc => {
          ranking.push({ odId: doc.id, ...doc.data() });
        });
        
        // Calcular pr√™mios
        const prizePool = torneioAtual.prizePool || 0;
        const distribuicao = torneioAtual.config?.distribuicaoPremio || { primeiro: 50, segundo: 30, terceiro: 20 };
        
        const premio1 = Math.floor(prizePool * distribuicao.primeiro / 100);
        const premio2 = Math.floor(prizePool * distribuicao.segundo / 100);
        const premio3 = Math.floor(prizePool * distribuicao.terceiro / 100);
        
        console.log("Prize Pool:", prizePool, "Pr√™mios:", premio1, premio2, premio3);
        console.log("Ranking:", ranking);
        
        // Resultado final
        const resultado = {
          primeiro: ranking[0] ? { ...ranking[0], premio: premio1 } : null,
          segundo: ranking[1] ? { ...ranking[1], premio: premio2 } : null,
          terceiro: ranking[2] ? { ...ranking[2], premio: premio3 } : null,
          ranking: ranking.map((r, i) => ({
            posicao: i + 1,
            odId: r.odId,
            odNome: r.odNome,
            pontos: r.pontos || 0,
            acertos: r.acertos || 0,
            erros: r.erros || 0
          }))
        };
        
        // Distribuir pr√™mios para top 3
        if (ranking[0] && premio1 > 0) {
          await db.collection('usuarios').doc(ranking[0].odId).update({
            creditos: firebase.firestore.FieldValue.increment(premio1),
            'torneios.vitorias': firebase.firestore.FieldValue.increment(1),
            'torneios.creditosGanhos': firebase.firestore.FieldValue.increment(premio1),
            'torneios.totalTorneios': firebase.firestore.FieldValue.increment(1)
          });
          
          await db.collection('transacoes').add({
            usuarioId: ranking[0].odId,
            tipo: 'credito',
            valor: premio1,
            descricao: `ü•á 1¬∫ lugar no torneio ${torneioAtual.nome} (+${premio1} cr√©ditos)`,
            torneioId: id,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log("‚úÖ Pr√™mio 1¬∫ lugar distribu√≠do:", ranking[0].odNome, premio1);
        }
        
        if (ranking[1] && premio2 > 0) {
          await db.collection('usuarios').doc(ranking[1].odId).update({
            creditos: firebase.firestore.FieldValue.increment(premio2),
            'torneios.top3': firebase.firestore.FieldValue.increment(1),
            'torneios.creditosGanhos': firebase.firestore.FieldValue.increment(premio2),
            'torneios.totalTorneios': firebase.firestore.FieldValue.increment(1)
          });
          
          await db.collection('transacoes').add({
            usuarioId: ranking[1].odId,
            tipo: 'credito',
            valor: premio2,
            descricao: `ü•à 2¬∫ lugar no torneio ${torneioAtual.nome} (+${premio2} cr√©ditos)`,
            torneioId: id,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log("‚úÖ Pr√™mio 2¬∫ lugar distribu√≠do:", ranking[1].odNome, premio2);
        }
        
        if (ranking[2] && premio3 > 0) {
          await db.collection('usuarios').doc(ranking[2].odId).update({
            creditos: firebase.firestore.FieldValue.increment(premio3),
            'torneios.top3': firebase.firestore.FieldValue.increment(1),
            'torneios.creditosGanhos': firebase.firestore.FieldValue.increment(premio3),
            'torneios.totalTorneios': firebase.firestore.FieldValue.increment(1)
          });
          
          await db.collection('transacoes').add({
            usuarioId: ranking[2].odId,
            tipo: 'credito',
            valor: premio3,
            descricao: `ü•â 3¬∫ lugar no torneio ${torneioAtual.nome} (+${premio3} cr√©ditos)`,
            torneioId: id,
            data: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log("‚úÖ Pr√™mio 3¬∫ lugar distribu√≠do:", ranking[2].odNome, premio3);
        }
        
        // Atualizar estat√≠sticas dos demais participantes
        for (let i = 3; i < ranking.length; i++) {
          try {
            await db.collection('usuarios').doc(ranking[i].odId).update({
              'torneios.totalTorneios': firebase.firestore.FieldValue.increment(1)
            });
          } catch (e) { console.error("Erro ao atualizar participante:", e); }
        }
        
        // Marcar torneio como finalizado
        await db.collection('torneios').doc(id).update({
          status: 'finalizado',
          resultado: resultado,
          dataFinalizacao: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const vencedor = ranking[0]?.odNome || 'Ningu√©m';
        showToast(`üèÜ Torneio finalizado! Vencedor: ${vencedor}`);
        fecharModalDetalhes();
        carregarTorneios();
        
      } catch (error) {
        console.error("Erro ao finalizar torneio:", error);
        showToast('‚ùå Erro ao finalizar: ' + error.message);
      }
    }

    function verAoVivo(id) {
      // Abre a arena em nova aba para acompanhar
      window.open(`../usuarios/arena-torneio.html?id=${id}&modo=espectador`, '_blank');
    }

    function editarTorneio(id) {
      // TODO: Implementar edi√ß√£o
      showToast('üöß Em desenvolvimento');
    }

    // ===================================
    // TOAST
    // ===================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    console.log("‚úÖ Gerenciador de Torneios carregado");
  </script>

</body>
</html>
