<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Yellup Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            color: #fff;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: #FFD700;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header h2 span {
            font-size: 12px;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .nav-section { margin-bottom: 20px; }

        .nav-section-title {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar a:hover, .sidebar a.active {
            background: rgba(255, 215, 0, 0.1);
            color: #FFD700;
            border-left-color: #FFD700;
        }

        .sidebar a .icon { font-size: 18px; width: 24px; text-align: center; }

        .sidebar a .badge {
            margin-left: auto;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .sidebar a .badge.green { background: #2ecc71; }
        .sidebar a .badge.yellow { background: #f39c12; }

        /* Main */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 20px 30px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }

        .header-right { display: flex; align-items: center; gap: 15px; }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 20px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-logout {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .btn-logout:hover { background: #e74c3c; color: white; }

        /* Alertas Topo */
        .alertas-topo {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .alerta-box {
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alerta-box.critico {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #ff6b6b;
        }

        .alerta-box.aviso {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid rgba(243, 156, 18, 0.5);
            color: #ffc107;
        }

        .alerta-box a {
            color: inherit;
            text-decoration: underline;
            margin-left: 5px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { 
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .stat-card.destaque {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .stat-card.alerta {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.blue { background: rgba(52, 152, 219, 0.2); }
        .stat-icon.green { background: rgba(46, 204, 113, 0.2); }
        .stat-icon.red { background: rgba(231, 76, 60, 0.2); }
        .stat-icon.yellow { background: rgba(241, 196, 15, 0.2); }
        .stat-icon.purple { background: rgba(155, 89, 182, 0.2); }
        .stat-icon.orange { background: rgba(230, 126, 34, 0.2); }

        .stat-trend {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .stat-trend.up { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .stat-trend.down { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: #fff;
            line-height: 1.2;
        }

        .stat-value.loading {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 5px;
            color: transparent;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-top: 5px;
        }

        .stat-extra {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Se√ß√µes */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-badge {
            background: #e74c3c;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .section-link {
            color: #FFD700;
            text-decoration: none;
            font-size: 12px;
        }

        .section-content {
            padding: 0;
            max-height: 350px;
            overflow-y: auto;
        }

        /* Lista de Items */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .list-item:hover { background: rgba(255, 255, 255, 0.03); }
        .list-item:last-child { border-bottom: none; }

        .list-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .list-info h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .list-info span {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .list-badge {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        .badge-online { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .badge-live { background: rgba(231, 76, 60, 0.2); color: #e74c3c; animation: pulse 1s infinite; }
        .badge-pending { background: rgba(243, 156, 18, 0.2); color: #f39c12; }
        .badge-active { background: rgba(52, 152, 219, 0.2); color: #3498db; }

        /* A√ß√µes R√°pidas */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .quick-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-decoration: none;
            color: #fff;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #FFD700;
            transform: translateY(-3px);
        }

        .quick-btn .icon { font-size: 24px; }
        .quick-btn .label { font-size: 12px; font-weight: 500; }

        /* Vazio */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state .icon { font-size: 40px; margin-bottom: 10px; }

        /* Responsivo */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main {
                margin-left: 0;
                padding: 15px;
            }
            .sections-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>‚öΩ Yellup <span>Admin</span></h2>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Principal</div>
            <a href="dashboard.html" class="active">
                <span class="icon">üìä</span> Dashboard
            </a>
            <a href="alertas.html">
                <span class="icon">üö®</span> Alertas
                <span class="badge" id="badgeAlertas">0</span>
            </a>
            <a href="usuarios.html">
                <span class="icon">üë•</span> Usu√°rios
                <span class="badge green" id="badgeUsuarios">0</span>
            </a>
            <a href="jogos.html">
                <span class="icon">üéÆ</span> Jogos
            </a>
            <a href="perguntas.html">
                <span class="icon">‚ùì</span> Perguntas
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Modos de Jogo</div>
            <a href="torneios.html">
                <span class="icon">üèÖ</span> Torneios
                <span class="badge yellow" id="badgeTorneios">0</span>
            </a>
            <a href="relatorio-jogo.html">
                <span class="icon">üìä</span> Relat√≥rio Jogos
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Financeiro</div>
            <a href="financeiro.html">
                <span class="icon">üí∞</span> Dashboard Financeiro
            </a>
            <a href="vendas-creditos.html">
                <span class="icon">üí∏</span> Saques
                <span class="badge" id="badgeSaques">0</span>
            </a>
            <a href="creditar-manual.html">
                <span class="icon">‚ûï</span> Creditar Manual
            </a>
            <a href="transacoes.html">
                <span class="icon">üí≥</span> Transa√ß√µes
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Bolsa de Valores</div>
            <a href="bolsa-admin.html">
                <span class="icon">üìà</span> Gest√£o da Bolsa
            </a>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">Sistema</div>
            <a href="times.html">
                <span class="icon">‚öΩ</span> Times
            </a>
            <a href="configuracoes.html">
                <span class="icon">‚öôÔ∏è</span> Configura√ß√µes
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Header -->
        <div class="header">
            <h1>üìä Dashboard</h1>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Tempo Real</span>
                </div>
                <button class="btn-logout" onclick="sair()">üö™ Sair</button>
            </div>
        </div>

        <!-- Alertas Importantes -->
        <div class="alertas-topo" id="alertasTopo"></div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon blue">üë•</div>
                </div>
                <div class="stat-value loading" id="statUsuarios">--</div>
                <div class="stat-label">Total Usu√°rios</div>
                <div class="stat-extra" id="extraUsuarios">Carregando...</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon green">üü¢</div>
                </div>
                <div class="stat-value loading" id="statOnline">--</div>
                <div class="stat-label">Online Agora</div>
                <div class="stat-extra" id="extraOnline">√∫ltimos 5 min</div>
            </div>

            <div class="stat-card" id="cardJogosVivo">
                <div class="stat-header">
                    <div class="stat-icon red">üî¥</div>
                </div>
                <div class="stat-value loading" id="statAoVivo">--</div>
                <div class="stat-label">Jogos Ativos</div>
                <div class="stat-extra" id="extraJogos">--</div>
            </div>

            <div class="stat-card destaque">
                <div class="stat-header">
                    <div class="stat-icon yellow">üí∞</div>
                </div>
                <div class="stat-value loading" id="statCreditos">--</div>
                <div class="stat-label">Cr√©ditos Circula√ß√£o</div>
                <div class="stat-extra" id="extraCreditos">--</div>
            </div>

            <div class="stat-card" id="cardSaques">
                <div class="stat-header">
                    <div class="stat-icon orange">üí∏</div>
                </div>
                <div class="stat-value loading" id="statSaques">--</div>
                <div class="stat-label">Saques Pendentes</div>
                <div class="stat-extra" id="extraSaques">--</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon purple">üìà</div>
                </div>
                <div class="stat-value loading" id="statBolsa">--</div>
                <div class="stat-label">Ordens na Bolsa</div>
                <div class="stat-extra" id="extraBolsa">--</div>
            </div>
        </div>

        <!-- A√ß√µes R√°pidas -->
        <h3 style="margin-bottom: 15px; font-size: 16px;">‚ö° A√ß√µes R√°pidas</h3>
        <div class="quick-actions">
            <a href="jogos.html?action=novo" class="quick-btn">
                <div class="icon">‚ûï</div>
                <div class="label">Novo Jogo</div>
            </a>
            <a href="vendas-creditos.html" class="quick-btn" id="btnSaques">
                <div class="icon">üí∏</div>
                <div class="label">Ver Saques</div>
            </a>
            <a href="creditar-manual.html" class="quick-btn">
                <div class="icon">üíé</div>
                <div class="label">Creditar</div>
            </a>
            <a href="perguntas.html" class="quick-btn">
                <div class="icon">‚ùì</div>
                <div class="label">Perguntas</div>
            </a>
            <a href="usuarios.html" class="quick-btn">
                <div class="icon">üë•</div>
                <div class="label">Usu√°rios</div>
            </a>
        </div>

        <!-- Se√ß√µes -->
        <div class="sections-grid">
            <!-- Saques Pendentes -->
            <div class="section-card">
                <div class="section-header">
                    <span class="section-title">üí∏ Saques Pendentes <span class="section-badge" id="countSaques">0</span></span>
                    <a href="vendas-creditos.html" class="section-link">Ver todos ‚Üí</a>
                </div>
                <div class="section-content" id="listaSaques">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- √öltimos Usu√°rios -->
            <div class="section-card">
                <div class="section-header">
                    <span class="section-title">üë• √öltimos Cadastros</span>
                    <a href="usuarios.html" class="section-link">Ver todos ‚Üí</a>
                </div>
                <div class="section-content" id="listaUsuarios">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Jogos -->
            <div class="section-card">
                <div class="section-header">
                    <span class="section-title">üéÆ Jogos Recentes</span>
                    <a href="jogos.html" class="section-link">Ver todos ‚Üí</a>
                </div>
                <div class="section-content" id="listaJogos">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Atividade Real -->
            <div class="section-card">
                <div class="section-header">
                    <span class="section-title">üìã Atividade Recente</span>
                </div>
                <div class="section-content" id="listaAtividade">
                    <div class="empty-state">
                        <div class="icon">‚è≥</div>
                        <p>Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCNBDcIEmdb2fQsiL0UsEAwdZlHTgM7Nesg",
            authDomain: "painel-yellup.firebaseapp.com",
            projectId: "painel-yellup",
            storageBucket: "painel-yellup.appspot.com",
            messagingSenderId: "608347210297",
            appId: "1:608347210297:web:75092713724e617c7203e8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Listeners ativos
        let unsubscribes = [];

        // Verificar autentica√ß√£o
        auth.onAuthStateChanged(user => {
            if (!user || user.email !== 'admin@yellup.com') {
                window.location.href = 'login.html';
            } else {
                iniciarDashboard();
            }
        });

        function sair() {
            // Cancelar listeners
            unsubscribes.forEach(unsub => unsub());
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // ==================== INICIAR DASHBOARD ====================
        async function iniciarDashboard() {
            // Carregar stats iniciais
            await carregarStats();
            
            // Iniciar listeners em tempo real
            iniciarListenerSaques();
            iniciarListenerUsuarios();
            iniciarListenerJogos();
            carregarAtividadeReal();
            
            // Verificar alertas
            verificarAlertas();
            
            // Atualizar stats a cada 30 segundos
            setInterval(carregarStats, 30000);
            setInterval(verificarAlertas, 60000);
        }

        // ==================== CARREGAR STATS ====================
        async function carregarStats() {
            try {
                // 1. Total de Usu√°rios
                const usuariosSnap = await db.collection('usuarios').get();
                const totalUsuarios = usuariosSnap.size;
                document.getElementById('statUsuarios').textContent = totalUsuarios;
                document.getElementById('statUsuarios').classList.remove('loading');
                document.getElementById('badgeUsuarios').textContent = totalUsuarios;
                
                // Calcular novos hoje
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                let novosHoje = 0;
                usuariosSnap.forEach(doc => {
                    const data = doc.data().dataCadastro;
                    if (data && data.toDate && data.toDate() >= hoje) novosHoje++;
                });
                document.getElementById('extraUsuarios').textContent = `+${novosHoje} hoje`;

                // 2. Usu√°rios Online (√∫ltimos 5 min)
                const cincoMinAtras = new Date(Date.now() - 5 * 60 * 1000);
                let online = 0;
                usuariosSnap.forEach(doc => {
                    const ultima = doc.data().ultimaAtividade;
                    if (ultima) {
                        const dataUltima = ultima.toDate ? ultima.toDate() : new Date(ultima);
                        if (dataUltima >= cincoMinAtras) online++;
                    }
                });
                document.getElementById('statOnline').textContent = online;
                document.getElementById('statOnline').classList.remove('loading');

                // 3. Cr√©ditos em Circula√ß√£o
                let totalCreditos = 0;
                let totalCreditosPagos = 0;
                usuariosSnap.forEach(doc => {
                    const d = doc.data();
                    totalCreditos += (d.creditos || 0);
                    totalCreditosPagos += (d.creditosPagos || 0);
                });
                document.getElementById('statCreditos').textContent = totalCreditos.toLocaleString('pt-BR');
                document.getElementById('statCreditos').classList.remove('loading');
                document.getElementById('extraCreditos').textContent = `${totalCreditosPagos.toLocaleString('pt-BR')} pagos`;

                // 4. Jogos Ativos
                const jogosSnap = await db.collection('jogos')
                    .where('status', 'in', ['ao_vivo', 'ativo', 'agendado'])
                    .get();
                
                let aoVivo = 0, agendados = 0;
                jogosSnap.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'ao_vivo' || status === 'ativo') aoVivo++;
                    else agendados++;
                });
                
                document.getElementById('statAoVivo').textContent = aoVivo;
                document.getElementById('statAoVivo').classList.remove('loading');
                document.getElementById('extraJogos').textContent = `${agendados} agendados`;
                
                if (aoVivo > 0) {
                    document.getElementById('cardJogosVivo').classList.add('destaque');
                }

                // 5. Saques Pendentes
                const saquesSnap = await db.collection('vendas_creditos')
                    .where('status', '==', 'pendente')
                    .get();
                
                let valorTotalSaques = 0;
                saquesSnap.forEach(doc => {
                    valorTotalSaques += (doc.data().creditos || 0) * 0.40;
                });
                
                document.getElementById('statSaques').textContent = saquesSnap.size;
                document.getElementById('statSaques').classList.remove('loading');
                document.getElementById('badgeSaques').textContent = saquesSnap.size;
                document.getElementById('extraSaques').textContent = `R$ ${valorTotalSaques.toFixed(2)} total`;
                
                if (saquesSnap.size > 0) {
                    document.getElementById('cardSaques').classList.add('alerta');
                }

                // 6. Ordens na Bolsa
                const bolsaSnap = await db.collection('bolsa_ordens')
                    .where('status', 'in', ['ativa', 'parcial'])
                    .get();
                
                let volumeBolsa = 0;
                bolsaSnap.forEach(doc => {
                    const d = doc.data();
                    volumeBolsa += (d.quantidadeRestante || d.quantidade || 0) * (d.precoUnitario || 0);
                });
                
                document.getElementById('statBolsa').textContent = bolsaSnap.size;
                document.getElementById('statBolsa').classList.remove('loading');
                document.getElementById('extraBolsa').textContent = `${volumeBolsa.toLocaleString('pt-BR')} cr em ordens`;

                // 7. Torneios
                const torneiosSnap = await db.collection('torneios')
                    .where('status', 'in', ['aberto', 'em_andamento'])
                    .get();
                document.getElementById('badgeTorneios').textContent = torneiosSnap.size;

            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        // ==================== LISTENER SAQUES (TEMPO REAL) ====================
        function iniciarListenerSaques() {
            const unsub = db.collection('vendas_creditos')
                .where('status', '==', 'pendente')
                .orderBy('dataSolicitacao', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('listaSaques');
                    document.getElementById('countSaques').textContent = snapshot.size;
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">‚úÖ</div>
                                <p>Nenhum saque pendente!</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    snapshot.forEach(doc => {
                        const s = doc.data();
                        const valor = ((s.creditos || 0) * 0.40).toFixed(2);
                        const data = s.dataSolicitacao?.toDate ? 
                            formatarDataRelativa(s.dataSolicitacao.toDate()) : '--';

                        html += `
                            <div class="list-item">
                                <div class="list-item-left">
                                    <div class="list-avatar" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white;">üí∏</div>
                                    <div class="list-info">
                                        <h4>${s.usuarioNome || 'Usu√°rio'}</h4>
                                        <span>${s.creditos || 0} cr ‚Üí R$ ${valor}</span>
                                    </div>
                                </div>
                                <span class="list-badge badge-pending">‚è≥ ${data}</span>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }, error => {
                    console.error('Erro listener saques:', error);
                });
            
            unsubscribes.push(unsub);
        }

        // ==================== LISTENER USU√ÅRIOS ====================
        function iniciarListenerUsuarios() {
            const unsub = db.collection('usuarios')
                .orderBy('dataCadastro', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('listaUsuarios');
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üë•</div>
                                <p>Nenhum usu√°rio ainda</p>
                            </div>
                        `;
                        return;
                    }

                    const cincoMinAtras = Date.now() - 5 * 60 * 1000;
                    let html = '';
                    
                    snapshot.forEach(doc => {
                        const u = doc.data();
                        const inicial = (u.nome || u.usuarioUnico || 'U')[0].toUpperCase();
                        const data = u.dataCadastro?.toDate ? 
                            formatarDataRelativa(u.dataCadastro.toDate()) : '--';
                        
                        // Verificar se est√° online
                        let online = '';
                        if (u.ultimaAtividade) {
                            const ultimaMs = u.ultimaAtividade.toMillis ? 
                                u.ultimaAtividade.toMillis() : new Date(u.ultimaAtividade).getTime();
                            if (ultimaMs > cincoMinAtras) {
                                online = '<span class="list-badge badge-online">Online</span>';
                            }
                        }

                        html += `
                            <div class="list-item">
                                <div class="list-item-left">
                                    <div class="list-avatar" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">${inicial}</div>
                                    <div class="list-info">
                                        <h4>${u.nome || 'Sem nome'}</h4>
                                        <span>@${u.usuarioUnico || 'usuario'} ‚Ä¢ ${data}</span>
                                    </div>
                                </div>
                                ${online}
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }, error => {
                    console.error('Erro listener usu√°rios:', error);
                });
            
            unsubscribes.push(unsub);
        }

        // ==================== LISTENER JOGOS ====================
        function iniciarListenerJogos() {
            const unsub = db.collection('jogos')
                .orderBy('dataCriacao', 'desc')
                .limit(5)
                .onSnapshot(async snapshot => {
                    const container = document.getElementById('listaJogos');
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üéÆ</div>
                                <p>Nenhum jogo cadastrado</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    
                    for (const doc of snapshot.docs) {
                        const j = doc.data();
                        
                        // Buscar nomes dos times
                        let timeCasa = j.timeCasaNome || 'Time A';
                        let timeFora = j.timeForaNome || 'Time B';
                        
                        if (!j.timeCasaNome && j.timeCasaId) {
                            const tCasa = await db.collection('times').doc(j.timeCasaId).get();
                            if (tCasa.exists) timeCasa = tCasa.data().nome;
                        }
                        if (!j.timeForaNome && j.timeForaId) {
                            const tFora = await db.collection('times').doc(j.timeForaId).get();
                            if (tFora.exists) timeFora = tFora.data().nome;
                        }

                        // Status
                        let statusBadge = '';
                        const status = j.status || 'criado';
                        if (status === 'ao_vivo' || status === 'ativo') {
                            statusBadge = '<span class="list-badge badge-live">üî¥ AO VIVO</span>';
                        } else if (status === 'agendado') {
                            statusBadge = '<span class="list-badge badge-active">üìÖ Agendado</span>';
                        } else if (status === 'finalizado' || status === 'encerrado') {
                            statusBadge = '<span class="list-badge" style="background: rgba(255,255,255,0.1); color: #888;">‚úÖ Finalizado</span>';
                        }

                        html += `
                            <div class="list-item">
                                <div class="list-item-left">
                                    <div class="list-avatar" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white;">‚öΩ</div>
                                    <div class="list-info">
                                        <h4>${timeCasa} x ${timeFora}</h4>
                                        <span>${j.participantes || 0} participantes</span>
                                    </div>
                                </div>
                                ${statusBadge}
                            </div>
                        `;
                    }
                    container.innerHTML = html;
                }, error => {
                    console.error('Erro listener jogos:', error);
                });
            
            unsubscribes.push(unsub);
        }

        // ==================== ATIVIDADE REAL ====================
        async function carregarAtividadeReal() {
            const container = document.getElementById('listaAtividade');
            const atividades = [];

            try {
                // Buscar √∫ltimas transa√ß√µes de cr√©dito
                const transacoesSnap = await db.collection('transacoes')
                    .orderBy('data', 'desc')
                    .limit(3)
                    .get();
                
                transacoesSnap.forEach(doc => {
                    const t = doc.data();
                    const data = t.data?.toDate ? t.data.toDate() : new Date();
                    atividades.push({
                        icon: 'üí∞',
                        bg: '#2ecc71',
                        texto: `${t.tipo || 'Transa√ß√£o'}: ${t.creditos || 0} cr - ${t.usuarioNome || 'Usu√°rio'}`,
                        tempo: data
                    });
                });

                // Buscar √∫ltimas compras na bolsa
                const bolsaSnap = await db.collection('bolsa_transacoes')
                    .orderBy('dataTransacao', 'desc')
                    .limit(3)
                    .get();
                
                bolsaSnap.forEach(doc => {
                    const b = doc.data();
                    const data = b.dataTransacao?.toDate ? b.dataTransacao.toDate() : new Date();
                    atividades.push({
                        icon: 'üìà',
                        bg: '#3498db',
                        texto: `Bolsa: ${b.compradorNome || 'Algu√©m'} comprou ${b.quantidade || 0} cotas`,
                        tempo: data
                    });
                });

                // Buscar √∫ltimos cadastros
                const cadastrosSnap = await db.collection('usuarios')
                    .orderBy('dataCadastro', 'desc')
                    .limit(2)
                    .get();
                
                cadastrosSnap.forEach(doc => {
                    const u = doc.data();
                    const data = u.dataCadastro?.toDate ? u.dataCadastro.toDate() : new Date();
                    atividades.push({
                        icon: 'üë§',
                        bg: '#9b59b6',
                        texto: `Novo usu√°rio: @${u.usuarioUnico || 'usuario'}`,
                        tempo: data
                    });
                });

                // Ordenar por tempo
                atividades.sort((a, b) => b.tempo - a.tempo);

                if (atividades.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìã</div>
                            <p>Nenhuma atividade recente</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                atividades.slice(0, 8).forEach(a => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-left">
                                <div class="list-avatar" style="background: ${a.bg}; color: white;">${a.icon}</div>
                                <div class="list-info">
                                    <h4>${a.texto}</h4>
                                    <span>${formatarDataRelativa(a.tempo)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar atividade:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Erro ao carregar atividade</p>
                    </div>
                `;
            }
        }

        // ==================== VERIFICAR ALERTAS ====================
        async function verificarAlertas() {
            const container = document.getElementById('alertasTopo');
            const alertas = [];

            try {
                // 1. Saques pendentes h√° mais de 24h
                const ontem = new Date();
                ontem.setDate(ontem.getDate() - 1);
                
                const saquesAntigos = await db.collection('vendas_creditos')
                    .where('status', '==', 'pendente')
                    .where('dataSolicitacao', '<', ontem)
                    .get();
                
                if (!saquesAntigos.empty) {
                    alertas.push({
                        tipo: 'critico',
                        texto: `‚ö†Ô∏è ${saquesAntigos.size} saque(s) pendente(s) h√° mais de 24h!`,
                        link: 'vendas-creditos.html'
                    });
                }

                // 2. Muitos cr√©ditos em circula√ß√£o (ajuste o limite)
                const usuariosSnap = await db.collection('usuarios').get();
                let totalCreditos = 0;
                usuariosSnap.forEach(doc => {
                    totalCreditos += (doc.data().creditos || 0);
                });
                
                if (totalCreditos > 500000) {
                    alertas.push({
                        tipo: 'aviso',
                        texto: `üí∞ Alto volume: ${totalCreditos.toLocaleString('pt-BR')} cr√©ditos em circula√ß√£o`,
                        link: 'financeiro.html'
                    });
                }

                // Atualizar badge de alertas
                document.getElementById('badgeAlertas').textContent = alertas.length;

                // Renderizar alertas
                if (alertas.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = alertas.map(a => `
                    <div class="alerta-box ${a.tipo}">
                        ${a.texto}
                        <a href="${a.link}">Ver</a>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao verificar alertas:', error);
            }
        }

        // ==================== HELPERS ====================
        function formatarDataRelativa(data) {
            if (!data) return '--';
            
            const agora = new Date();
            const diff = agora - data;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d`;
            
            return data.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>
