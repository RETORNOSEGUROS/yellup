<!-- painel-jogo.html -->
<div id="perguntaContainer" style="display:none; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: #fff; max-width: 400px; margin: 20px auto;">
  <h3 id="textoPergunta" style="font-weight: bold;"></h3>

  <div id="botoesAlternativas" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;"></div>

  <div style="margin-top: 15px;">
    <div id="barraTempo" style="height: 10px; background: green; transition: width 0.1s linear;"></div>
  </div>
</div>

<div id="rankingContainer" style="display:none; margin: 30px auto; max-width: 400px; background: #f8f8f8; padding: 20px; border-radius: 8px;">
  <h4>🏆 Ranking ao Vivo</h4>
  <ol id="listaRanking"></ol>
  <p id="minhaPontuacao" style="margin-top: 10px; font-weight: bold;"></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    // 👉 insira suas credenciais aqui
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const jogoId = "SEU_JOGO_ID";
  const timeId = "TIME_DO_USUARIO";
  const userId = "USUARIO_ATUAL";

  const container = document.getElementById("perguntaContainer");
  const textoPergunta = document.getElementById("textoPergunta");
  const botoesAlternativas = document.getElementById("botoesAlternativas");
  const barraTempo = document.getElementById("barraTempo");

  const rankingContainer = document.getElementById("rankingContainer");
  const listaRanking = document.getElementById("listaRanking");
  const minhaPontuacao = document.getElementById("minhaPontuacao");

  let tempoTotal = 10;
  let intervalId;
  let perguntaRespondida = false;

  async function buscarCreditos(usuarioId) {
    const userDoc = await getDoc(doc(db, "usuarios", usuarioId));
    const dados = userDoc.data();
    return dados.creditos || 0;
  }

  async function descontarCreditos(usuarioId, valor) {
    const ref = doc(db, "usuarios", usuarioId);
    const userDoc = await getDoc(ref);
    const dados = userDoc.data();
    const novosCreditos = (dados.creditos || 0) - valor;
    await setDoc(ref, { ...dados, creditos: novosCreditos }, { merge: true });
  }

  // Escuta nova pergunta para o time do usuário
  const q = query(
    collection(db, "chats_jogo_demo"),
    where("jogoId", "==", jogoId),
    where("timeId", "==", timeId),
    where("tipo", "==", "pergunta")
  );

  onSnapshot(q, async (snapshot) => {
    snapshot.docChanges().forEach(async (change) => {
      if (change.type === "added") {
        const dados = change.doc.data();
        const perguntaId = dados.perguntaId;

        const perguntaDoc = await getDoc(doc(db, "perguntas", perguntaId));
        const perguntaData = perguntaDoc.data();

        mostrarPergunta(perguntaData, perguntaId);
      }
    });
  });

  async function mostrarPergunta(pergunta, perguntaId) {
    perguntaRespondida = false;
    container.style.display = "block";
    textoPergunta.textContent = pergunta.pergunta;
    botoesAlternativas.innerHTML = "";

    const alternativas = ["A", "B", "C", "D"];
    alternativas.forEach((letra) => {
      const btn = document.createElement("button");
      btn.textContent = `${letra}) ${pergunta.alternativas[letra]}`;
      btn.style.padding = "10px";
      btn.style.borderRadius = "5px";
      btn.style.border = "1px solid #ccc";
      btn.style.cursor = "pointer";
      btn.onclick = () => responder(letra, pergunta.correta, pergunta.pontuacao, perguntaId, btn);
      botoesAlternativas.appendChild(btn);
    });

    const creditos = await buscarCreditos(userId);
    if (creditos >= 5) {
      tempoTotal = 15;
      await descontarCreditos(userId, 5);
    } else {
      tempoTotal = 10;
    }

    iniciarTempo();
  }

  function iniciarTempo() {
    let tempoRestante = tempoTotal;
    barraTempo.style.width = "100%";
    barraTempo.style.background = "green";

    intervalId = setInterval(() => {
      tempoRestante--;
      barraTempo.style.width = `${(tempoRestante / tempoTotal) * 100}%`;

      if (tempoRestante <= 0) {
        clearInterval(intervalId);
        if (!perguntaRespondida) {
          ocultarPergunta();
        }
      }
    }, 1000);
  }

  async function responder(letraSelecionada, correta, pontos, perguntaId, botaoClicado) {
    perguntaRespondida = true;
    clearInterval(intervalId);

    const botoes = botoesAlternativas.querySelectorAll("button");

    botoes.forEach(btn => {
      const letra = btn.textContent.charAt(0);
      if (letra === correta) {
        btn.style.background = "#4CAF50";
        btn.style.color = "#fff";
      } else if (btn === botaoClicado) {
        btn.style.background = "#f44336";
        btn.style.color = "#fff";
      } else {
        btn.disabled = true;
      }
    });

    await addDoc(collection(db, "respostas"), {
      userId,
      jogoId,
      perguntaId,
      pontos: letraSelecionada === correta ? pontos : 0,
      data: serverTimestamp()
    });

    setTimeout(() => {
      ocultarPergunta();
      carregarRanking();
    }, 3000);
  }

  function ocultarPergunta() {
    container.style.display = "none";
    botoesAlternativas.innerHTML = "";
    textoPergunta.textContent = "";
  }

  async function carregarRanking() {
    const respostasSnap = await getDocs(query(
      collection(db, "respostas"),
      where("jogoId", "==", jogoId)
    ));

    const pontuacoes = {};
    respostasSnap.forEach(doc => {
      const r = doc.data();
      if (!pontuacoes[r.userId]) pontuacoes[r.userId] = 0;
      pontuacoes[r.userId] += r.pontos;
    });

    const ranking = Object.entries(pontuacoes)
      .map(([user, pontos]) => ({ user, pontos }))
      .sort((a, b) => b.pontos - a.pontos);

    const top10 = ranking.slice(0, 10);
    listaRanking.innerHTML = top10.map((item, i) => `<li>${item.user}: ${item.pontos} pts</li>`).join("");

    const minhaPosicao = ranking.findIndex(r => r.user === userId) + 1;
    const meusPontos = pontuacoes[userId] || 0;
    minhaPontuacao.textContent = `Sua posição: #${minhaPosicao} — ${meusPontos} pts`;

    rankingContainer.style.display = "block";
  }
</script>
