
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel do Jogo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    #perguntaContainer, #chatContainer { margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px; }
    #botoesAlternativas button { display: block; margin-top: 10px; padding: 10px; width: 100%; }
    #barraTempo { height: 10px; background: green; transition: width 0.2s; }
    #chatMensagens { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; background: #fafafa; }
    .chat-msg { margin: 5px 0; }
  </style>
</head>
<body>

<h2>ðŸ“¢ Painel do Jogo</h2>

<div id="perguntaContainer" style="display:none;">
  <h3 id="textoPergunta"></h3>
  <div id="botoesAlternativas"></div>
  <div style="margin-top: 10px;">
    <div id="barraTempo" style="width: 100%;"></div>
  </div>
</div>

<div id="chatContainer">
  <h4>ðŸ’¬ Chat da Torcida</h4>
  <div id="chatMensagens"></div>
  <input type="text" id="inputChat" placeholder="Digite sua mensagem..." style="width:80%;" />
  <button onclick="enviarChat()">Enviar</button>
</div>

<div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
  <h4>ðŸŽ¯ Envio Manual de Pergunta</h4>
  <button onclick="sortearPergunta()">+ Sortear e Enviar Pergunta</button>
</div>

<!-- Firebase compat libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
    authDomain: "painel-yellup.firebaseapp.com",
    projectId: "painel-yellup",
    storageBucket: "painel-yellup.appspot.com",
    messagingSenderId: "608347210297",
    appId: "1:608347210297:web:75092713724e617c7203e8",
    measurementId: "G-SYZ16X31KQ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const jogoId = urlParams.get("id");
  const container = document.getElementById("perguntaContainer");
  const textoPergunta = document.getElementById("textoPergunta");
  const botoesAlternativas = document.getElementById("botoesAlternativas");
  const barraTempo = document.getElementById("barraTempo");

  let intervaloBarra, perguntaAtual;

  function sortearPergunta() {
    db.collection("jogos").doc(jogoId).get().then(doc => {
      const timeId = doc.data().timeCasaId;
      db.collection("perguntas").where("timeId", "==", timeId).limit(1).get().then(snapshot => {
        snapshot.forEach(doc => {
          const pergunta = doc.data();
          enviarPerguntaParaChat(pergunta, timeId, doc.id);
        });
      });
    });
  }

  function enviarPerguntaParaChat(pergunta, timeId, perguntaId) {
    db.collection("chats_jogo_demo").add({
      jogId: jogoId,
      timeId: timeId,
      perguntaId: perguntaId,
      tipo: "pergunta",
      data: new Date().toISOString()
    });
  }

  function iniciarBarraTempo(duracao = 10) {
    let tempoRestante = duracao;
    barraTempo.style.width = "100%";
    clearInterval(intervaloBarra);
    intervaloBarra = setInterval(() => {
      tempoRestante--;
      barraTempo.style.width = (tempoRestante * 10) + "%";
      if (tempoRestante <= 0) {
        clearInterval(intervaloBarra);
        container.style.display = "none";
      }
    }, 1000);
  }

  db.collection("chats_jogo_demo")
    .where("jogId", "==", jogoId)
    .where("tipo", "==", "pergunta")
    .orderBy("data", "desc")
    .limit(1)
    .onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const perguntaId = doc.data().perguntaId;
        db.collection("perguntas").doc(perguntaId).get().then(pdoc => {
          const p = pdoc.data();
          textoPergunta.innerText = p.pergunta;
          botoesAlternativas.innerHTML = "";
          ["a", "b", "c", "d"].forEach(letra => {
            const btn = document.createElement("button");
            btn.textContent = letra.toUpperCase() + ") " + p[letra];
            botoesAlternativas.appendChild(btn);
          });
          container.style.display = "block";
          iniciarBarraTempo(10);
        });
      });
    });

  // Chat da torcida
  const chatMensagens = document.getElementById("chatMensagens");
  const inputChat = document.getElementById("inputChat");

  function enviarChat() {
    const texto = inputChat.value;
    if (texto.trim() !== "") {
      db.collection("chats_jogo_demo").add({
        jogId: jogoId,
        tipo: "chat",
        mensagem: texto,
        data: new Date().toISOString()
      });
      inputChat.value = "";
    }
  }

  db.collection("chats_jogo_demo")
    .where("jogId", "==", jogoId)
    .where("tipo", "==", "chat")
    .orderBy("data", "desc")
    .limit(50)
    .onSnapshot(snapshot => {
      chatMensagens.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = document.createElement("div");
        msg.className = "chat-msg";
        msg.textContent = doc.data().mensagem;
        chatMensagens.appendChild(msg);
      });
    });

  setInterval(() => sortearPergunta(), 5 * 60 * 1000); // auto a cada 5 min
</script>
</body>
</html>
