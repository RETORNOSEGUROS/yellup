<!-- pergunta-interativa.html -->
<div id="perguntaContainer" style="display:none; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: #fff; max-width: 400px; margin: 20px auto;">
  <h3 id="textoPergunta" style="font-weight: bold;"></h3>

  <div id="botoesAlternativas" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;"></div>

  <div style="margin-top: 15px;">
    <div id="barraTempo" style="height: 10px; background: green; transition: width 0.1s linear;"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    // ðŸ”’ insira suas credenciais aqui
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const jogoId = "SEU_JOGO_ID";
  const timeId = "TIME_DO_USUARIO";
  const userId = "USUARIO_ATUAL";
  const container = document.getElementById("perguntaContainer");
  const textoPergunta = document.getElementById("textoPergunta");
  const botoesAlternativas = document.getElementById("botoesAlternativas");
  const barraTempo = document.getElementById("barraTempo");

  let tempoTotal = 10; // padrÃ£o
  let intervalId;
  let perguntaRespondida = false;

  // ðŸ”„ Escuta por nova pergunta no chat do time
  const q = query(
    collection(db, "chats_jogo_demo"),
    where("jogoId", "==", jogoId),
    where("timeId", "==", timeId),
    where("tipo", "==", "pergunta")
  );

  onSnapshot(q, async (snapshot) => {
    snapshot.docChanges().forEach(async (change) => {
      if (change.type === "added") {
        const dados = change.doc.data();
        const perguntaId = dados.perguntaId;

        // busca a pergunta
        const perguntaDoc = await getDoc(doc(db, "perguntas", perguntaId));
        const perguntaData = perguntaDoc.data();

        mostrarPergunta(perguntaData, perguntaId);
      }
    });
  });

  function mostrarPergunta(pergunta, perguntaId) {
    perguntaRespondida = false;
    container.style.display = "block";
    textoPergunta.textContent = pergunta.pergunta;
    botoesAlternativas.innerHTML = "";

    const alternativas = ["A", "B", "C", "D"];
    alternativas.forEach((letra) => {
      const btn = document.createElement("button");
      btn.textContent = `${letra}) ${pergunta.alternativas[letra]}`;
      btn.style.padding = "10px";
      btn.style.borderRadius = "5px";
      btn.style.border = "1px solid #ccc";
      btn.style.cursor = "pointer";
      btn.onclick = () => responder(letra, pergunta.correta, pergunta.pontuacao, perguntaId, btn);
      botoesAlternativas.appendChild(btn);
    });

    iniciarTempo();
  }

  function iniciarTempo() {
    let tempoRestante = tempoTotal;
    barraTempo.style.width = "100%";
    barraTempo.style.background = "green";

    intervalId = setInterval(() => {
      tempoRestante--;
      barraTempo.style.width = `${(tempoRestante / tempoTotal) * 100}%`;

      if (tempoRestante <= 0) {
        clearInterval(intervalId);
        if (!perguntaRespondida) {
          ocultarPergunta();
        }
      }
    }, 1000);
  }

  async function responder(letraSelecionada, correta, pontos, perguntaId, botaoClicado) {
    perguntaRespondida = true;
    clearInterval(intervalId);

    const botoes = botoesAlternativas.querySelectorAll("button");

    botoes.forEach(btn => {
      const letra = btn.textContent.charAt(0);
      if (letra === correta) {
        btn.style.background = "#4CAF50"; // verde
        btn.style.color = "#fff";
      } else if (btn === botaoClicado) {
        btn.style.background = "#f44336"; // vermelho
        btn.style.color = "#fff";
      } else {
        btn.disabled = true;
      }
    });

    // salvar resposta no Firestore
    await addDoc(collection(db, "respostas"), {
      userId,
      jogoId,
      perguntaId,
      pontos: letraSelecionada === correta ? pontos : 0,
      data: serverTimestamp()
    });

    setTimeout(ocultarPergunta, 3000);
  }

  function ocultarPergunta() {
    container.style.display = "none";
    botoesAlternativas.innerHTML = "";
    textoPergunta.textContent = "";
  }
</script>
