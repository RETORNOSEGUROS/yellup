<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Partida - Yellup Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-primary: #0c0e14; --bg-secondary: #12141c; --bg-card: #181a24;
            --bg-card-hover: #1e2030; --border: #1e2030; --border-light: #282a3a;
            --text-primary: #e8e9ed; --text-secondary: #8b8d9a; --text-muted: #5c5e6e;
            --accent: #f0b429; --accent-dim: rgba(240,180,41,0.12);
            --green: #34d399; --green-dim: rgba(52,211,153,0.12);
            --red: #f87171; --red-dim: rgba(248,113,113,0.12);
            --blue: #60a5fa; --blue-dim: rgba(96,165,250,0.12);
            --purple: #a78bfa; --purple-dim: rgba(167,139,250,0.12);
            --orange: #fb923c; --orange-dim: rgba(251,146,60,0.12);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',-apple-system,sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; }

        .topbar { height:56px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 24px; background:var(--bg-secondary); position:sticky; top:0; z-index:50; }
        .topbar-left { display:flex; align-items:center; gap:12px; }
        .topbar-left h1 { font-size:15px; font-weight:600; }
        .topbar-left .back { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:13px; font-family:inherit; padding:6px 12px; border-radius:6px; }
        .topbar-left .back:hover { color:var(--accent); background:var(--accent-dim); }
        .status-pill { padding:5px 14px; border-radius:20px; font-size:11px; font-weight:600; display:inline-flex; align-items:center; gap:6px; }
        .status-live { background:var(--red-dim); color:var(--red); }
        .status-live .dot { width:6px; height:6px; border-radius:50%; background:var(--red); animation:pulse 2s infinite; }
        .status-agendado { background:var(--accent-dim); color:var(--accent); }
        .status-finalizado { background:var(--green-dim); color:var(--green); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

        .container { max-width:1400px; margin:0 auto; padding:20px 24px 40px; }

        .match-header { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:24px; margin-bottom:16px; text-align:center; }
        .match-meta { font-size:12px; color:var(--text-muted); margin-bottom:16px; display:flex; justify-content:center; gap:20px; }
        .teams-row { display:flex; justify-content:center; align-items:center; gap:40px; }
        .team-block { text-align:center; min-width:180px; }
        .escudo { width:64px; height:64px; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:26px; font-weight:700; color:#fff; box-shadow:0 4px 20px rgba(0,0,0,.3); }
        .team-name { font-size:16px; font-weight:700; margin-bottom:8px; }
        .team-nums { display:flex; justify-content:center; gap:16px; }
        .team-num .v { font-size:20px; font-weight:700; font-family:'JetBrains Mono',monospace; color:var(--accent); }
        .team-num .l { font-size:10px; color:var(--text-muted); }
        .vs { font-size:28px; font-weight:700; color:var(--text-muted); }

        .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:16px; }
        .stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:14px; text-align:center; }
        .stat-card .icon { font-size:20px; margin-bottom:4px; }
        .stat-card .val { font-size:22px; font-weight:700; font-family:'JetBrains Mono',monospace; }
        .stat-card .lbl { font-size:10px; color:var(--text-muted); margin-top:2px; }

        .sorteio-card { background:var(--bg-card); border:1px solid var(--purple); border-radius:14px; padding:20px; margin-bottom:16px; }
        .sorteio-card h3 { font-size:14px; font-weight:600; color:var(--purple); margin-bottom:14px; }
        .sorteio-form { display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
        .sorteio-form .fg { flex:1; min-width:180px; }
        .sorteio-form label { display:block; font-size:11px; color:var(--text-muted); margin-bottom:4px; }
        .sorteio-form input, .sorteio-form select { width:100%; padding:9px 12px; border:1px solid var(--border); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary); font-size:13px; font-family:inherit; }
        .sorteio-form input:focus, .sorteio-form select:focus { outline:none; border-color:var(--purple); }
        .sorteio-form select option { background:var(--bg-card); }
        .btn-sorteio { padding:9px 20px; border-radius:8px; border:1px solid var(--purple); background:var(--purple-dim); color:var(--purple); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; white-space:nowrap; }
        .btn-sorteio:hover { background:var(--purple); color:#fff; }
        .sorteio-result { margin-top:14px; padding:16px; background:var(--bg-secondary); border-radius:10px; text-align:center; display:none; }
        .sorteio-result.show { display:block; animation:fadeScale .4s ease; }
        .sorteio-result .big { font-size:36px; margin-bottom:6px; }
        .sorteio-result .winner { font-size:18px; font-weight:700; color:var(--accent); }
        .sorteio-result .prize { font-size:12px; color:var(--text-secondary); margin-top:4px; }
        @keyframes fadeScale { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
        .hist-title { font-size:11px; color:var(--text-muted); margin:12px 0 6px; }
        .hist-item { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--bg-secondary); border-radius:8px; margin-bottom:4px; font-size:12px; }
        .hist-item .hn { color:var(--purple); font-weight:600; }
        .hist-item .hv { color:var(--text-primary); }
        .hist-item .hd { color:var(--text-muted); font-size:10px; }

        .grid-main { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
        .chats-col { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
        .card-head { padding:10px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .card-head .title { font-size:12px; font-weight:600; }
        .card-head .badge { padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; font-family:'JetBrains Mono',monospace; }
        .badge-green { background:var(--green-dim); color:var(--green); }
        .badge-yellow { background:var(--accent-dim); color:var(--accent); }
        .badge-red { background:var(--red-dim); color:var(--red); }

        .chat-box { height:260px; overflow-y:auto; padding:8px; flex:1; }
        .chat-box::-webkit-scrollbar { width:4px; }
        .chat-box::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
        .chat-msg { padding:8px 10px; margin-bottom:4px; background:var(--bg-secondary); border-radius:8px; font-size:12px; position:relative; }
        .chat-msg:hover { background:var(--bg-card-hover); }
        .chat-msg .nm { color:var(--accent); font-weight:600; font-size:11px; }
        .chat-msg .hr { color:var(--text-muted); font-size:10px; margin-left:6px; }
        .chat-msg .tx { margin-top:2px; word-break:break-word; line-height:1.4; }
        .chat-msg .del-btn { position:absolute; top:6px; right:6px; background:var(--red); color:#fff; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:9px; opacity:0; transition:opacity .15s; }
        .chat-msg:hover .del-btn { opacity:1; }
        .chat-input-row { display:flex; gap:6px; padding:8px; border-top:1px solid var(--border); }
        .chat-input-row input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; background:var(--bg-secondary); color:var(--text-primary); font-size:12px; font-family:inherit; }
        .chat-input-row input:focus { outline:none; border-color:var(--accent); }
        .chat-input-row input::placeholder { color:var(--text-muted); }
        .btn-send { padding:8px 14px; border-radius:6px; border:none; background:var(--accent); color:#000; font-size:11px; font-weight:600; cursor:pointer; font-family:inherit; }
        .btn-send:hover { opacity:.9; }

        .ranking-list { flex:1; overflow-y:auto; max-height:420px; padding:8px; }
        .ranking-list::-webkit-scrollbar { width:4px; }
        .ranking-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
        .rank-item { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border); }
        .rank-item:last-child { border-bottom:none; }
        .rank-pos { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; flex-shrink:0; }
        .pos-1 { background:linear-gradient(135deg,#FFD700,#FFA500); color:#000; }
        .pos-2 { background:linear-gradient(135deg,#C0C0C0,#A0A0A0); color:#000; }
        .pos-3 { background:linear-gradient(135deg,#CD7F32,#8B4513); color:#fff; }
        .pos-n { background:var(--bg-secondary); color:var(--text-secondary); }
        .rank-avatar { width:30px; height:30px; border-radius:50%; background:linear-gradient(135deg,var(--blue),#2563eb); display:flex; align-items:center; justify-content:center; font-weight:600; font-size:12px; flex-shrink:0; }
        .rank-info { flex:1; min-width:0; }
        .rank-name { font-size:12px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .rank-team { font-size:10px; color:var(--text-muted); }
        .rank-pts { font-weight:700; color:var(--accent); font-size:14px; font-family:'JetBrains Mono',monospace; flex-shrink:0; }
        .btn-refresh { padding:5px 10px; border-radius:6px; border:1px solid var(--border); background:var(--bg-secondary); color:var(--text-secondary); font-size:11px; cursor:pointer; font-family:inherit; }
        .btn-refresh:hover { border-color:var(--accent); color:var(--accent); }
        .empty { text-align:center; padding:30px; color:var(--text-muted); font-size:12px; }

        .toast { position:fixed; bottom:20px; right:20px; padding:12px 20px; border-radius:10px; background:var(--bg-card); border:1px solid var(--border); color:var(--text-primary); font-size:13px; font-weight:500; z-index:999; transform:translateY(80px); opacity:0; transition:all .3s; }
        .toast.show { transform:translateY(0); opacity:1; }

        @media(max-width:1200px) { .chats-col { grid-template-columns:1fr; } }
        @media(max-width:900px) {
            .grid-main { grid-template-columns:1fr; }
            .stats-row { grid-template-columns:repeat(2,1fr); }
            .teams-row { flex-direction:column; gap:16px; }
            .sorteio-form { flex-direction:column; }
        }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="topbar-left">
            <button class="back" onclick="window.location.href='jogos.html'">‚Üê Voltar</button>
            <h1>üéÆ Painel da Partida</h1>
        </div>
        <span class="status-pill status-live" id="statusJogo"><span class="dot"></span> Carregando...</span>
    </div>

    <div class="container">
        <div class="match-header">
            <div class="match-meta">
                <span>üìÖ <span id="jogoData">--</span></span>
                <span>‚è∞ <span id="jogoHora">--</span></span>
                <span>üèÜ <span id="jogoLiga">--</span></span>
            </div>
            <div class="teams-row">
                <div class="team-block">
                    <div class="escudo" id="escudoCasa">?</div>
                    <div class="team-name" id="nomeCasa">Time Casa</div>
                    <div class="team-nums">
                        <div class="team-num"><div class="v" id="torcedoresCasa">0</div><div class="l">Torcedores</div></div>
                        <div class="team-num"><div class="v" id="pontosCasa">0</div><div class="l">Pontos</div></div>
                    </div>
                </div>
                <div class="vs">VS</div>
                <div class="team-block">
                    <div class="escudo" id="escudoFora">?</div>
                    <div class="team-name" id="nomeFora">Time Fora</div>
                    <div class="team-nums">
                        <div class="team-num"><div class="v" id="torcedoresFora">0</div><div class="l">Torcedores</div></div>
                        <div class="team-num"><div class="v" id="pontosFora">0</div><div class="l">Pontos</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card"><div class="icon">üë•</div><div class="val" id="totalTorcedores">0</div><div class="lbl">Total Torcedores</div></div>
            <div class="stat-card"><div class="icon">üí¨</div><div class="val" id="totalMensagens">0</div><div class="lbl">Mensagens Chat</div></div>
            <div class="stat-card"><div class="icon">‚ùì</div><div class="val" id="totalRespostas">0</div><div class="lbl">Perguntas Respondidas</div></div>
            <div class="stat-card"><div class="icon">üèÜ</div><div class="val" id="totalPontos">0</div><div class="lbl">Pontos Totais</div></div>
        </div>

        <div class="sorteio-card">
            <h3>üéÅ Sistema de Sorteio</h3>
            <div class="sorteio-form">
                <div class="fg"><label>Nome do Pr√™mio</label><input type="text" id="premioNome" placeholder="Ex: Camiseta oficial do time"></div>
                <div class="fg"><label>Sortear entre</label>
                    <select id="sorteioTime">
                        <option value="todos">Todos os torcedores</option>
                        <option value="casa">Apenas torcida da casa</option>
                        <option value="fora">Apenas torcida visitante</option>
                    </select>
                </div>
                <button class="btn-sorteio" onclick="realizarSorteio()">üé≤ Sortear!</button>
            </div>
            <div class="sorteio-result" id="sorteioResultado">
                <div class="big">üéâ</div>
                <div class="winner" id="vencedorNome">‚Äî</div>
                <div class="prize">Ganhou: <strong id="vencedorPremio">‚Äî</strong></div>
            </div>
            <div id="sorteiosHistorico"></div>
        </div>

        <div class="grid-main">
            <div class="chats-col">
                <div class="card">
                    <div class="card-head"><span class="title">üí¨ Chat Geral</span><span class="badge badge-green" id="countGeral">0</span></div>
                    <div class="chat-box" id="chatGeral"><div class="empty">Nenhuma mensagem</div></div>
                    <div class="chat-input-row"><input type="text" id="inputGeral" placeholder="Mensagem geral..."><button class="btn-send" onclick="enviarMensagem('geral')">Enviar</button></div>
                </div>
                <div class="card">
                    <div class="card-head"><span class="title">üè† <span id="chatNomeCasa">Casa</span></span><span class="badge badge-yellow" id="countCasa">0</span></div>
                    <div class="chat-box" id="chatCasa"><div class="empty">Nenhuma mensagem</div></div>
                    <div class="chat-input-row"><input type="text" id="inputCasa" placeholder="Mensagem..."><button class="btn-send" onclick="enviarMensagem('casa')">Enviar</button></div>
                </div>
                <div class="card">
                    <div class="card-head"><span class="title">‚úàÔ∏è <span id="chatNomeFora">Fora</span></span><span class="badge badge-red" id="countFora">0</span></div>
                    <div class="chat-box" id="chatFora"><div class="empty">Nenhuma mensagem</div></div>
                    <div class="chat-input-row"><input type="text" id="inputFora" placeholder="Mensagem..."><button class="btn-send" onclick="enviarMensagem('fora')">Enviar</button></div>
                </div>
            </div>
            <div class="card">
                <div class="card-head"><span class="title">üèÜ Ranking da Partida</span><button class="btn-refresh" onclick="carregarTorcedores()">üîÑ Atualizar</button></div>
                <div class="ranking-list" id="rankingList"><div class="empty">Carregando ranking...</div></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c", authDomain: "painel-yellup.firebaseapp.com",
            projectId: "painel-yellup", storageBucket: "painel-yellup.appspot.com",
            messagingSenderId: "608347210297", appId: "1:608347210297:web:75092713724e617c7203e8"
        });
        const db = firebase.firestore();

        let jogoId = null, jogoData = null, timeCasa = null, timeFora = null;
        let torcedoresList = [], sorteiosRealizados = [], totalCreditosPagosJogo = 0;

        const urlParams = new URLSearchParams(window.location.search);
        jogoId = urlParams.get('jogoId');
        if (!jogoId) { alert('ID do jogo n√£o informado!'); window.location.href = 'jogos.html'; }

        firebase.auth().onAuthStateChanged(user => {
            if (!user || user.email !== 'admin@yellup.com') { window.location.href = 'login.html'; return; }
            carregarJogo();
        });

        async function carregarJogo() {
            try {
                const jogoDoc = await db.collection('jogos').doc(jogoId).get();
                if (!jogoDoc.exists) { alert('Jogo n√£o encontrado!'); window.location.href = 'jogos.html'; return; }
                jogoData = { id: jogoDoc.id, ...jogoDoc.data() };

                const [casaDoc, foraDoc] = await Promise.all([
                    db.collection('times').doc(jogoData.timeCasaId).get(),
                    db.collection('times').doc(jogoData.timeForaId).get()
                ]);
                timeCasa = casaDoc.exists ? { id: casaDoc.id, ...casaDoc.data() } : { id: jogoData.timeCasaId, nome: 'Time Casa', primaria: '#2ecc71', secundaria: '#27ae60', terciaria: '#1e8449' };
                timeFora = foraDoc.exists ? { id: foraDoc.id, ...foraDoc.data() } : { id: jogoData.timeForaId, nome: 'Time Fora', primaria: '#3498db', secundaria: '#2980b9', terciaria: '#1a5276' };

                atualizarUI();
                carregarTorcedores();
                carregarSorteios();
                iniciarListenersChat();
            } catch (e) { console.error('Erro:', e); showToast('Erro ao carregar jogo'); }
        }

        function atualizarUI() {
            const dt = jogoData.dataInicio?.toDate ? jogoData.dataInicio.toDate() : new Date();
            document.getElementById('jogoData').textContent = dt.toLocaleDateString('pt-BR');
            document.getElementById('jogoHora').textContent = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('jogoLiga').textContent = jogoData.liga || 'Amistoso';

            const el = document.getElementById('statusJogo');
            if (jogoData.status === 'ao_vivo') { el.innerHTML = '<span class="dot"></span> AO VIVO'; el.className = 'status-pill status-live'; }
            else if (jogoData.status === 'agendado') { el.textContent = 'üìÜ AGENDADO'; el.className = 'status-pill status-agendado'; }
            else { el.textContent = '‚úÖ FINALIZADO'; el.className = 'status-pill status-finalizado'; }

            const eCasa = document.getElementById('escudoCasa');
            eCasa.textContent = (timeCasa.nome || 'T')[0];
            eCasa.style.background = `linear-gradient(135deg, ${timeCasa.primaria || '#2ecc71'}, ${timeCasa.secundaria || '#27ae60'})`;
            eCasa.style.border = `3px solid ${timeCasa.terciaria || '#1e8449'}`;

            const eFora = document.getElementById('escudoFora');
            eFora.textContent = (timeFora.nome || 'T')[0];
            eFora.style.background = `linear-gradient(135deg, ${timeFora.primaria || '#3498db'}, ${timeFora.secundaria || '#2980b9'})`;
            eFora.style.border = `3px solid ${timeFora.terciaria || '#1a5276'}`;

            document.getElementById('nomeCasa').textContent = timeCasa.nome;
            document.getElementById('nomeFora').textContent = timeFora.nome;
            document.getElementById('chatNomeCasa').textContent = timeCasa.nome;
            document.getElementById('chatNomeFora').textContent = timeFora.nome;
        }

        async function carregarTorcedores() {
            try {
                const snap = await db.collection('usuarios').get();
                torcedoresList = [];
                let countCasa = 0, countFora = 0, pontosCasa = 0, pontosFora = 0, totalRespostas = 0;
                totalCreditosPagosJogo = 0;

                snap.forEach(doc => {
                    const user = doc.data();
                    const timeUser = user.torcidas?.[jogoId];
                    if (!timeUser) return;
                    if (timeUser !== timeCasa.id && timeUser !== timeFora.id) return;

                    const pontos = user.pontuacoes?.[jogoId] || 0;
                    const respostas = (user[`perguntasRespondidas_${jogoId}`] || []).length;
                    const creditosPagos = user.creditosPagosJogo?.[jogoId] || 0;
                    const usuario = user.usuarioUnico || user.usuario || user.nome || 'An√¥nimo';

                    torcedoresList.push({ odecId: doc.id, timeId: timeUser, pontos, respostas, creditosPagos, usuario });
                    totalRespostas += respostas;
                    totalCreditosPagosJogo += creditosPagos;

                    if (timeUser === timeCasa.id) { countCasa++; pontosCasa += pontos; }
                    else { countFora++; pontosFora += pontos; }
                });

                document.getElementById('torcedoresCasa').textContent = countCasa;
                document.getElementById('torcedoresFora').textContent = countFora;
                document.getElementById('pontosCasa').textContent = pontosCasa;
                document.getElementById('pontosFora').textContent = pontosFora;
                document.getElementById('totalTorcedores').textContent = torcedoresList.length;
                document.getElementById('totalPontos').textContent = pontosCasa + pontosFora;
                document.getElementById('totalRespostas').textContent = totalRespostas;
                renderRanking();
            } catch (e) { console.error('Erro torcedores:', e); }
        }

        function renderRanking() {
            const sorted = [...torcedoresList].sort((a, b) => (b.pontos || 0) - (a.pontos || 0)).slice(0, 20);
            const el = document.getElementById('rankingList');
            if (!sorted.length) { el.innerHTML = '<div class="empty">Nenhum torcedor ainda</div>'; return; }
            el.innerHTML = sorted.map((t, i) => {
                const pc = i === 0 ? 'pos-1' : i === 1 ? 'pos-2' : i === 2 ? 'pos-3' : 'pos-n';
                const tn = t.timeId === timeCasa.id ? timeCasa.nome : timeFora.nome;
                const ini = (t.usuario || 'A')[0].toUpperCase();
                return `<div class="rank-item"><div class="rank-pos ${pc}">${i+1}</div><div class="rank-avatar">${ini}</div><div class="rank-info"><div class="rank-name">${esc(t.usuario)}</div><div class="rank-team">${tn} ¬∑ ${t.respostas||0} respostas</div></div><div class="rank-pts">${t.pontos||0}</div></div>`;
            }).join('');
        }

        function iniciarListenersChat() {
            db.collection('chats').where('jogoId', '==', jogoId).limit(200).onSnapshot(snapshot => {
                const msgsGeral = [], msgsCasa = [], msgsFora = [];
                let total = 0;
                snapshot.forEach(doc => {
                    const m = { id: doc.id, ...doc.data() }; total++;
                    if (!m.timeId || m.tipo === 'geral') msgsGeral.push(m);
                    if (m.timeId === timeCasa.id) msgsCasa.push(m);
                    if (m.timeId === timeFora.id) msgsFora.push(m);
                });
                const srt = arr => arr.sort((a,b) => { const g=m=>m.timestamp?.toMillis?.()||m.timestamp?.seconds*1000||0; return g(a)-g(b); });
                renderChat('chatGeral', srt(msgsGeral).slice(-50), 'countGeral');
                renderChat('chatCasa', srt(msgsCasa).slice(-50), 'countCasa');
                renderChat('chatFora', srt(msgsFora).slice(-50), 'countFora');
                document.getElementById('totalMensagens').textContent = total;
            }, e => console.error('Chat error:', e));
        }

        function renderChat(containerId, msgs, countId) {
            const el = document.getElementById(containerId);
            document.getElementById(countId).textContent = msgs.length;
            if (!msgs.length) { el.innerHTML = '<div class="empty">Nenhuma mensagem</div>'; return; }
            el.innerHTML = msgs.map(m => {
                const hora = m.timestamp?.toDate ? m.timestamp.toDate().toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' }) : '--:--';
                const nome = m.usuarioUnico || m.usuario || m.nome || 'An√¥nimo';
                return `<div class="chat-msg"><span class="nm">${esc(nome)}</span><span class="hr">${hora}</span><div class="tx">${esc(m.mensagem||'')}</div><button class="del-btn" onclick="excluirMensagem('${m.id}')">üóëÔ∏è</button></div>`;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }

        async function excluirMensagem(msgId) {
            if (!confirm('Excluir esta mensagem?')) return;
            try { await db.collection('chats').doc(msgId).delete(); showToast('üóëÔ∏è Exclu√≠da!'); }
            catch(e) { showToast('Erro ao excluir'); }
        }

        async function enviarMensagem(tipo) {
            const inputId = tipo==='geral'?'inputGeral':tipo==='casa'?'inputCasa':'inputFora';
            const input = document.getElementById(inputId);
            const mensagem = input.value.trim();
            if (!mensagem) return;
            try {
                let timeId = null, tipoMsg = 'geral';
                if (tipo==='casa') { timeId=timeCasa.id; tipoMsg='torcida'; }
                else if (tipo==='fora') { timeId=timeFora.id; tipoMsg='torcida'; }
                await db.collection('chats').add({
                    jogoId, timeId, tipo: tipoMsg,
                    userId:'admin', usuario:'üõ°Ô∏è Admin', usuarioUnico:'üõ°Ô∏è Admin', nome:'üõ°Ô∏è Admin',
                    avatar:'https://ui-avatars.com/api/?name=Admin&background=FFD700&color=1a1a2e',
                    mensagem, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = '';
            } catch(e) { showToast('Erro ao enviar'); }
        }

        async function carregarSorteios() {
            try {
                const snap = await db.collection('sorteios').where('jogoId','==',jogoId).orderBy('data','desc').limit(10).get();
                sorteiosRealizados = [];
                snap.forEach(doc => sorteiosRealizados.push({id:doc.id,...doc.data()}));
                renderSorteios();
            } catch(e) { console.log('Nenhum sorteio ainda'); }
        }

        function renderSorteios() {
            const el = document.getElementById('sorteiosHistorico');
            if (!sorteiosRealizados.length) { el.innerHTML=''; return; }
            el.innerHTML = `<div class="hist-title">üìú Sorteios Realizados</div>` +
                sorteiosRealizados.map(s => {
                    const d = s.data?.toDate ? s.data.toDate().toLocaleString('pt-BR') : '--';
                    return `<div class="hist-item"><div><span class="hn">üéÅ ${esc(s.premio)}</span> <span class="hv">‚Üí ${esc(s.vencedorNome)}</span></div><span class="hd">${d}</span></div>`;
                }).join('');
        }

        async function realizarSorteio() {
            const premio = document.getElementById('premioNome').value.trim();
            if (!premio) { showToast('‚ö†Ô∏è Digite o pr√™mio!'); return; }
            const filtro = document.getElementById('sorteioTime').value;
            let elegiveis = [...torcedoresList];
            if (filtro==='casa') elegiveis = elegiveis.filter(t=>t.timeId===timeCasa.id);
            else if (filtro==='fora') elegiveis = elegiveis.filter(t=>t.timeId===timeFora.id);
            if (!elegiveis.length) { showToast('‚ö†Ô∏è Nenhum eleg√≠vel!'); return; }

            const vencedor = elegiveis[Math.floor(Math.random()*elegiveis.length)];
            try {
                await db.collection('sorteios').add({
                    jogoId, premio, vencedorId:vencedor.odecId, vencedorNome:vencedor.usuario||'An√¥nimo',
                    timeId:vencedor.timeId, data:firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('notificacoes').add({
                    userId:vencedor.odecId, tipo:'sorteio', titulo:'üéâ Voc√™ ganhou um sorteio!',
                    mensagem:`Parab√©ns! Voc√™ foi sorteado e ganhou: ${premio}`,
                    jogoId, lida:false, data:firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('vencedorNome').textContent = vencedor.usuario||'An√¥nimo';
                document.getElementById('vencedorPremio').textContent = premio;
                document.getElementById('sorteioResultado').classList.add('show');
                document.getElementById('premioNome').value = '';
                showToast(`üéâ ${vencedor.usuario||'An√¥nimo'} ganhou!`);
                carregarSorteios();
            } catch(e) { showToast('Erro no sorteio'); console.error(e); }
        }

        function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

        document.querySelectorAll('.chat-input-row input').forEach(input => {
            input.addEventListener('keypress', e => { if(e.key==='Enter'){ enviarMensagem(input.id.replace('input','').toLowerCase()); } });
        });

        setInterval(carregarTorcedores, 30000);
    </script>
</body>
</html>
