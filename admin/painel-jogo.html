<!-- painel-jogo.html -->
<div id="perguntaContainer" style="display:none; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: #fff; max-width: 400px; margin: 20px auto;">
  <h3 id="textoPergunta" style="font-weight: bold;"></h3>

  <div id="botoesAlternativas" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;"></div>

  <div style="margin-top: 15px;">
    <div id="barraTempo" style="height: 10px; background: green; transition: width 0.1s linear;"></div>
  </div>
</div>

<!-- Botão Ver Ranking -->
<div style="text-align: center; margin-top: 30px;">
  <button onclick="carregarRanking()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
    👀 Ver Ranking ao Vivo
  </button>
</div>

<!-- Container do Ranking -->
<div id="rankingContainer" style="display:none; margin: 30px auto; max-width: 400px; background: #f8f8f8; padding: 20px; border-radius: 8px; text-align: center;">
  <h4>🏆 Ranking ao Vivo</h4>
  <ol id="listaRanking" style="text-align: left;"></ol>
  <p id="minhaPontuacao" style="margin-top: 10px; font-weight: bold;"></p>
  <button onclick="fecharRanking()" style="margin-top: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
    ✖️ Fechar
  </button>
</div>

<!-- Firebase compat libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
    authDomain: "painel-yellup.firebaseapp.com",
    projectId: "painel-yellup",
    storageBucket: "painel-yellup.appspot.com",
    messagingSenderId: "608347210297",
    appId: "1:608347210297:web:75092713724e617c7203e8",
    measurementId: "G-SYZ16X31KQ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const jogoId = "SEU_JOGO_ID";
  const timeId = "SEU_TIME_ID";
  const userId = "SEU_USER_ID";

  const container = document.getElementById("perguntaContainer");
  const textoPergunta = document.getElementById("textoPergunta");
  const botoesAlternativas = document.getElementById("botoesAlternativas");
  const barraTempo = document.getElementById("barraTempo");

  const rankingContainer = document.getElementById("rankingContainer");
  const listaRanking = document.getElementById("listaRanking");
  const minhaPontuacao = document.getElementById("minhaPontuacao");

  let tempoTotal = 10;
  let intervalId;
  let perguntaRespondida = false;

  async function buscarCreditos(usuarioId) {
    const docRef = db.collection("usuarios").doc(usuarioId);
    const docSnap = await docRef.get();
    return docSnap.exists ? (docSnap.data().creditos || 0) : 0;
  }

  async function descontarCreditos(usuarioId, valor) {
    const ref = db.collection("usuarios").doc(usuarioId);
    const docSnap = await ref.get();
    if (!docSnap.exists) return;
    const dados = docSnap.data();
    const novosCreditos = (dados.creditos || 0) - valor;
    await ref.set({ ...dados, creditos: novosCreditos }, { merge: true });
  }

  db.collection("chats_jogo_demo")
    .where("jogoId", "==", jogoId)
    .where("timeId", "==", timeId)
    .where("tipo", "==", "pergunta")
    .onSnapshot(async (snapshot) => {
      snapshot.docChanges().forEach(async (change) => {
        if (change.type === "added") {
          const dados = change.doc.data();
          const perguntaId = dados.perguntaId;

          const perguntaDoc = await db.collection("perguntas").doc(perguntaId).get();
          if (perguntaDoc.exists) {
            mostrarPergunta(perguntaDoc.data(), perguntaId);
          }
        }
      });
    });

  async function mostrarPergunta(pergunta, perguntaId) {
    perguntaRespondida = false;
    container.style.display = "block";
    textoPergunta.textContent = pergunta.pergunta;
    botoesAlternativas.innerHTML = "";

    ["A", "B", "C", "D"].forEach((letra) => {
      const btn = document.createElement("button");
      btn.textContent = `${letra}) ${pergunta.alternativas[letra]}`;
      btn.style.padding = "10px";
      btn.style.borderRadius = "5px";
      btn.style.border = "1px solid #ccc";
      btn.style.cursor = "pointer";
      btn.onclick = () => responder(letra, pergunta.correta, pergunta.pontuacao, perguntaId, btn);
      botoesAlternativas.appendChild(btn);
    });

    const creditos = await buscarCreditos(userId);
    if (creditos >= 5) {
      tempoTotal = 15;
      await descontarCreditos(userId, 5);
    } else {
      tempoTotal = 10;
    }

    iniciarTempo();
  }

  function iniciarTempo() {
    let tempoRestante = tempoTotal;
    barraTempo.style.width = "100%";
    barraTempo.style.background = "green";

    intervalId = setInterval(() => {
      tempoRestante--;
      barraTempo.style.width = `${(tempoRestante / tempoTotal) * 100}%`;

      if (tempoRestante <= 0) {
        clearInterval(intervalId);
        if (!perguntaRespondida) {
          ocultarPergunta();
        }
      }
    }, 1000);
  }

  async function responder(letraSelecionada, correta, pontos, perguntaId, botaoClicado) {
    perguntaRespondida = true;
    clearInterval(intervalId);

    const botoes = botoesAlternativas.querySelectorAll("button");

    botoes.forEach(btn => {
      const letra = btn.textContent.charAt(0);
      if (letra === correta) {
        btn.style.background = "#4CAF50";
        btn.style.color = "#fff";
      } else if (btn === botaoClicado) {
        btn.style.background = "#f44336";
        btn.style.color = "#fff";
      } else {
        btn.disabled = true;
      }
    });

    await db.collection("respostas").add({
      userId,
      jogoId,
      perguntaId,
      pontos: letraSelecionada === correta ? pontos : 0,
      data: firebase.firestore.FieldValue.serverTimestamp()
    });

    setTimeout(() => {
      ocultarPergunta();
      carregarRanking();
    }, 3000);
  }

  function ocultarPergunta() {
    container.style.display = "none";
    botoesAlternativas.innerHTML = "";
    textoPergunta.textContent = "";
  }

  async function carregarRanking() {
    const snap = await db.collection("respostas").where("jogoId", "==", jogoId).get();
    const pontuacoes = {};

    snap.forEach(doc => {
      const r = doc.data();
      if (!pontuacoes[r.userId]) pontuacoes[r.userId] = 0;
      pontuacoes[r.userId] += r.pontos;
    });

    const ranking = Object.entries(pontuacoes)
      .map(([user, pontos]) => ({ user, pontos }))
      .sort((a, b) => b.pontos - a.pontos);

    const top10 = ranking.slice(0, 10);
    listaRanking.innerHTML = top10.map(item => `<li>${item.user}: ${item.pontos} pts</li>`).join("");

    const minhaPosicao = ranking.findIndex(r => r.user === userId) + 1;
    const meusPontos = pontuacoes[userId] || 0;
    minhaPontuacao.textContent = `Sua posição: #${minhaPosicao} — ${meusPontos} pts`;

    rankingContainer.style.display = "block";
  }

  function fecharRanking() {
    rankingContainer.style.display = "none";
  }
</script>
