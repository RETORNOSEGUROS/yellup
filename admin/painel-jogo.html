
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Jogo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; }
    .painel { background: white; max-width: 800px; margin: 30px auto; padding: 20px; border-radius: 10px; }
    .titulo { font-size: 22px; font-weight: bold; margin-bottom: 10px; }
    .info { margin-bottom: 20px; }
    .chat-box { width: 100%; height: 150px; margin-bottom: 10px; }
    .envio { display: flex; gap: 10px; margin-bottom: 20px; }
    .envio input { flex: 1; padding: 8px; }
    .pergunta { background: #fff7d7; padding: 10px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="painel">
    <div class="titulo">📢 Painel do Jogo</div>
    <div class="info" id="infoJogo">⌛ Carregando dados do jogo...</div>

    <div class="chat">
      <div class="titulo">💬 Chat da Torcida</div>
      <textarea class="chat-box" id="chatDisplay" readonly></textarea>
      <div class="envio">
        <input id="mensagemInput" placeholder="Digite sua mensagem..." />
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>

    <div class="pergunta">
      <div class="titulo">🎯 Envio Manual de Pergunta</div>
      <button onclick="sortearEEnviar()">+ Sortear e Enviar Pergunta</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const jogoId = urlParams.get("id");

    let idTimeA = "";
    let idTimeB = "";

    function carregarJogo() {
      if (!jogoId) return;
      db.collection("jogos").doc(jogoId).get().then(doc => {
        if (doc.exists) {
          const dados = doc.data();
          idTimeA = dados.idTimeA;
          idTimeB = dados.idTimeB;
          const inicio = dados.inicio || "-";
          const entrada = dados.entrada || "-";
          const nomeCasa = dados.nomeTimeA || "Time A";
          const nomeFora = dados.nomeTimeB || "Time B";
          document.getElementById("infoJogo").innerText = `🏟️ ${nomeCasa} vs ${nomeFora}
📅 Início: ${inicio}
💳 Entrada: ${entrada}`;
        } else {
          document.getElementById("infoJogo").innerText = "❌ Jogo não encontrado.";
        }
      });
    }

    function sortearEEnviar() {
      if (!jogoId || !idTimeA || !idTimeB) return alert("Jogo ou times não carregados.");
      const times = [idTimeA, idTimeB];
      const sorteado = times[Math.floor(Math.random() * times.length)];
      db.collection("perguntas")
        .where("idTime", "==", sorteado)
        .get()
        .then(snapshot => {
          const perguntas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const usadas = perguntas.filter(p => p.jogoId === jogoId);
          const restantes = perguntas.filter(p => !usadas.some(u => u.id === p.id));
          if (restantes.length === 0) return alert("Sem perguntas inéditas.");
          const escolhida = restantes[Math.floor(Math.random() * restantes.length)];
          db.collection("perguntas_jogo").add({
            perguntaId: escolhida.id,
            jogoId,
            enviadaEm: new Date(),
            tempoSegundos: 10
          });
          alert("Pergunta enviada!");
        });
    }

    function enviarMensagem() {
      const texto = document.getElementById("mensagemInput").value;
      if (!texto || !jogoId) return;
      db.collection("chats_jogo_demo").add({
        jogoId,
        mensagem: texto,
        criadaEm: new Date()
      });
      document.getElementById("mensagemInput").value = "";
    }

    function escutarMensagens() {
      db.collection("chats_jogo_demo")
        .where("jogoId", "==", jogoId)
        .orderBy("criadaEm")
        .onSnapshot(snapshot => {
          let chat = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            chat += msg.mensagem + "\n";
          });
          document.getElementById("chatDisplay").value = chat;
        });
    }

    carregarJogo();
    escutarMensagens();
  </script>
</body>
</html>
