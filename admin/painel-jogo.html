<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Jogo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 2rem;
    }
    .painel {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #c40064;
    }
    .bloco {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
    }
    .chat {
      background-color: #f0f0f0;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    input[type="text"] {
      width: 80%;
      padding: 0.5rem;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #c40064;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #a30050;
    }
  </style>
</head>
<body>
  <div class="painel">
    <h2>üéØ Painel do Jogo</h2>
    <div id="infoJogo">‚è≥ Carregando dados do jogo...</div>

    <div class="bloco chat">
      <h3>üí¨ Chat da Torcida</h3>
      <textarea id="chatMensagens" readonly></textarea><br />
      <input type="text" id="mensagemInput" placeholder="Digite sua mensagem..." />
      <button onclick="enviarMensagem()">Enviar</button>
    </div>

    <div class="bloco" style="background-color: #fff5cc;">
      <h3>üéØ Envio Manual de Pergunta</h3>
      <button onclick="sortearEEnviarPergunta()">+ Sortear e Enviar Pergunta</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8",
      measurementId: "G-SYZ16X31KQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const jogoId = urlParams.get("id");

    let jogoData = null;

    async function carregarJogo() {
      const doc = await db.collection("jogos").doc(jogoId).get();
      if (doc.exists) {
        jogoData = doc.data();
        document.getElementById("infoJogo").innerHTML = `
          <strong>üèü ${jogoData.timeCasa} vs ${jogoData.timeVisitante}</strong><br />
          üìÖ In√≠cio: ${jogoData.inicio || "-"}<br />
          üéü Entrada: ${jogoData.valorCreditos || "-"} cr√©ditos
        `;
      } else {
        document.getElementById("infoJogo").innerText = "‚ùå Jogo n√£o encontrado.";
      }
    }

    async function sortearEEnviarPergunta() {
      if (!jogoData || !jogoData.timeId) {
        alert("Jogo ainda n√£o carregado!");
        return;
      }

      const perguntasSnapshot = await db.collection("perguntas")
        .where("timeId", "==", jogoData.timeId)
        .get();

      const perguntas = perguntasSnapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(p => p.ativa !== false); // Pode aplicar mais filtros

      if (perguntas.length === 0) {
        alert("Nenhuma pergunta dispon√≠vel para esse time.");
        return;
      }

      const perguntaSorteada = perguntas[Math.floor(Math.random() * perguntas.length)];

      await db.collection("perguntas_ativas").doc(jogoId).set({
        ...perguntaSorteada,
        perguntaId: perguntaSorteada.id,
        enviadaEm: new Date(),
        tempoSegundos: 10
      });

      alert("Pergunta enviada com sucesso!");
    }

    function enviarMensagem() {
      const input = document.getElementById("mensagemInput");
      const texto = input.value.trim();
      if (texto === "") return;

      db.collection("chats_jogo_demo").add({
        jogoId,
        texto,
        data: new Date()
      });
      input.value = "";
    }

    function carregarChat() {
      db.collection("chats_jogo_demo")
        .where("jogoId", "==", jogoId)
        .orderBy("data")
        .onSnapshot(snapshot => {
          const mensagens = snapshot.docs.map(doc => doc.data().texto);
          document.getElementById("chatMensagens").value = mensagens.join("\n");
        });
    }

    carregarJogo();
    carregarChat();
  </script>
</body>
</html>
