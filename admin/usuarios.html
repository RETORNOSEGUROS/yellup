<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Usu√°rios - Yellup Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
:root{--bg-primary:#0c0e14;--bg-secondary:#12141c;--bg-card:#181a24;--bg-card-hover:#1e2030;--bg-sidebar:#10121a;--border:#1e2030;--border-light:#282a3a;--text-primary:#e8e9ed;--text-secondary:#8b8d9a;--text-muted:#5c5e6e;--accent:#f0b429;--accent-dim:rgba(240,180,41,.12);--green:#34d399;--green-dim:rgba(52,211,153,.12);--red:#f87171;--red-dim:rgba(248,113,113,.12);--blue:#60a5fa;--blue-dim:rgba(96,165,250,.12);--purple:#a78bfa;--purple-dim:rgba(167,139,250,.12);--orange:#fb923c;--orange-dim:rgba(251,146,60,.12);--cyan:#22d3ee;--cyan-dim:rgba(34,211,238,.12);--sidebar-w:250px;--header-h:64px;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;}

/* SIDEBAR */
.sidebar{position:fixed;left:0;top:0;width:var(--sidebar-w);height:100vh;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:transform .3s;}
.sidebar-brand{height:var(--header-h);display:flex;align-items:center;gap:10px;padding:0 20px;border-bottom:1px solid var(--border);flex-shrink:0;}
.sidebar-brand .logo{width:32px;height:32px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#000;}
.sidebar-brand h1{font-size:17px;font-weight:700;} .sidebar-brand h1 span{color:var(--text-muted);font-weight:500;font-size:12px;margin-left:6px;}
.sidebar-nav{flex:1;overflow-y:auto;padding:12px 0;} .sidebar-nav::-webkit-scrollbar{width:0;}
.nav-group{margin-bottom:8px;} .nav-group-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);padding:12px 20px 6px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 16px;margin:1px 8px;border-radius:8px;color:var(--text-secondary);text-decoration:none;font-size:13px;font-weight:500;transition:all .15s;}
.nav-item:hover{background:var(--bg-card);color:var(--text-primary);} .nav-item.active{background:var(--accent-dim);color:var(--accent);}
.nav-item .icon{width:20px;text-align:center;font-size:14px;flex-shrink:0;}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;}
.sidebar-footer .admin-box{display:flex;align-items:center;gap:10px;padding:8px;}
.admin-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#e09800);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#000;}
.admin-info-text{flex:1;} .admin-info-text .name{font-size:13px;font-weight:600;} .admin-info-text .role{font-size:11px;color:var(--text-muted);}
.btn-logout{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px;border-radius:6px;} .btn-logout:hover{color:var(--red);background:var(--red-dim);}

/* MAIN */
.main{margin-left:var(--sidebar-w);min-height:100vh;}
.topbar{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 32px;background:var(--bg-primary);position:sticky;top:0;z-index:50;}
.topbar h2{font-size:16px;font-weight:600;}
.topbar-actions{display:flex;gap:8px;}
.btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px;}
.btn:hover{border-color:var(--accent);}
.btn-accent{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
.btn-accent:hover{opacity:.9;}
.btn-green{background:var(--green-dim);color:var(--green);border-color:rgba(52,211,153,.3);} .btn-green:hover{background:var(--green);color:#000;}
.btn-red{background:var(--red-dim);color:var(--red);border-color:rgba(248,113,113,.3);} .btn-red:hover{background:var(--red);color:#fff;}
.btn-blue{background:var(--blue-dim);color:var(--blue);border-color:rgba(96,165,250,.3);} .btn-blue:hover{background:var(--blue);color:#000;}
.btn-purple{background:var(--purple-dim);color:var(--purple);border-color:rgba(167,139,250,.3);} .btn-purple:hover{background:var(--purple);color:#fff;}
.btn-sm{padding:5px 10px;font-size:11px;}
.content{padding:24px 32px 40px;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;}
.stat-card .ic{font-size:20px;margin-bottom:2px;}
.stat-card .val{font-size:20px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.stat-card .lbl{font-size:10px;color:var(--text-muted);margin-top:2px;}

/* FILTERS */
.filters-bar{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.search-box{flex:1;min-width:200px;position:relative;}
.search-box input{width:100%;padding:9px 12px 9px 34px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:13px;font-family:inherit;}
.search-box input:focus{outline:none;border-color:var(--accent);}
.search-box input::placeholder{color:var(--text-muted);}
.search-box .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;}
.fsel{padding:9px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:12px;font-family:inherit;min-width:130px;}
.fsel:focus{outline:none;border-color:var(--accent);} .fsel option{background:var(--bg-card);}

/* TABLE */
.table-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{padding:10px 14px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);border-bottom:1px solid var(--border);text-align:left;background:var(--bg-secondary);}
tbody td{padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px;}
tbody tr:hover{background:var(--bg-card-hover);} tbody tr:last-child td{border-bottom:none;}
.user-cell{display:flex;align-items:center;gap:10px;}
.uav{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;color:#fff;}
.uname{font-weight:600;font-size:13px;} .uhandle{font-size:11px;color:var(--text-muted);}
.online-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-left:4px;}
.badge{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:600;}
.badge-ativo{background:var(--green-dim);color:var(--green);} .badge-inativo{background:var(--red-dim);color:var(--red);}
.badge-bloqueado{background:var(--orange-dim);color:var(--orange);}
.nivel-bronze{background:rgba(205,127,50,.15);color:#CD7F32;} .nivel-prata{background:rgba(192,192,192,.15);color:#C0C0C0;}
.nivel-ouro{background:var(--accent-dim);color:var(--accent);} .nivel-diamante{background:var(--cyan-dim);color:var(--cyan);}
.nivel-mestre{background:var(--purple-dim);color:var(--purple);} .nivel-iniciante{background:rgba(100,100,120,.15);color:var(--text-secondary);}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px;}
.acts{display:flex;gap:4px;}

/* PAGINATION */
.pag{display:flex;justify-content:center;align-items:center;gap:10px;padding:16px;font-size:12px;color:var(--text-muted);}
.pag button{padding:7px 16px;border:1px solid var(--border);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:12px;cursor:pointer;font-family:inherit;}
.pag button:hover:not(:disabled){border-color:var(--accent);color:var(--accent);} .pag button:disabled{opacity:.4;cursor:not-allowed;}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-bg.active{display:flex;}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;width:90%;max-height:90vh;overflow-y:auto;padding:24px;}
.modal::-webkit-scrollbar{width:4px;} .modal::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
.modal-sm{max-width:500px;} .modal-md{max-width:640px;} .modal-lg{max-width:800px;}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.modal-head h3{font-size:16px;font-weight:600;}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:6px;} .modal-close:hover{color:var(--red);background:var(--red-dim);}
.fg{margin-bottom:14px;}
.fg label{display:block;font-size:11px;color:var(--text-muted);margin-bottom:4px;font-weight:500;}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary);font-size:13px;font-family:inherit;}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--accent);}
.fg textarea{resize:vertical;min-height:60px;}
.fg select option{background:var(--bg-card);}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.modal-footer{display:flex;gap:10px;margin-top:20px;}
.modal-footer .btn{flex:1;justify-content:center;padding:10px;}

/* DETAIL GRID */
.det-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.det-item{background:var(--bg-secondary);border-radius:8px;padding:10px 12px;}
.det-item .dl{font-size:10px;color:var(--text-muted);margin-bottom:2px;}
.det-item .dv{font-size:14px;font-weight:600;}
.det-section{font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin:16px 0 8px;padding-top:12px;border-top:1px solid var(--border);}
.det-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding-top:14px;border-top:1px solid var(--border);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:10px;background:var(--bg-card);border:1px solid var(--green);color:var(--text-primary);font-size:13px;font-weight:500;z-index:999;transform:translateY(80px);opacity:0;transition:all .3s;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.error{border-color:var(--red);}

/* MOBILE */
.mobile-toggle{display:none;position:fixed;top:16px;left:16px;z-index:200;width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-size:18px;cursor:pointer;align-items:center;justify-content:center;}
.overlay-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;}
@media(max-width:900px){
    .sidebar{transform:translateX(-100%);} .sidebar.open{transform:translateX(0);} .overlay-bg.open{display:block;}
    .mobile-toggle{display:flex;} .main{margin-left:0;} .topbar{padding:0 16px 0 64px;} .content{padding:16px;}
    .stats-row{grid-template-columns:repeat(2,1fr);} .det-grid{grid-template-columns:1fr 1fr;}
    .filters-bar{flex-direction:column;}
}
@media(max-width:600px){.stats-row{grid-template-columns:1fr;} .det-grid{grid-template-columns:1fr;} .frow{grid-template-columns:1fr;}}
</style>
</head>
<body>

<button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
<div class="overlay-bg" id="overlay" onclick="toggleSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-brand"><div class="logo">Y</div><h1>Yellup <span>Admin</span></h1></div>
    <nav class="sidebar-nav">
        <div class="nav-group"><div class="nav-group-title">Vis√£o Geral</div><a href="dashboard.html" class="nav-item"><span class="icon">üìä</span> Dashboard</a></div>
        <div class="nav-group"><div class="nav-group-title">Conte√∫do</div><a href="jogos.html" class="nav-item"><span class="icon">üéÆ</span> Jogos</a><a href="perguntas.html" class="nav-item"><span class="icon">‚ùì</span> Perguntas</a><a href="gerar-perguntas.html" class="nav-item"><span class="icon">ü§ñ</span> Gerar com IA</a><a href="times.html" class="nav-item"><span class="icon">‚öΩ</span> Times</a></div>
        <div class="nav-group"><div class="nav-group-title">Jogadores</div><a href="usuarios.html" class="nav-item active"><span class="icon">üë•</span> Usu√°rios</a><a href="ranking.html" class="nav-item"><span class="icon">üèÜ</span> Rankings</a><a href="admin-noticias.html" class="nav-item"><span class="icon">üì∞</span> Not√≠cias</a></div>
        <div class="nav-group"><div class="nav-group-title">Competi√ß√µes</div><a href="torneios.html" class="nav-item"><span class="icon">üèÖ</span> Torneios</a><a href="inicializar-pvp.html" class="nav-item"><span class="icon">‚öîÔ∏è</span> Embates PvP</a></div>
        <div class="nav-group"><div class="nav-group-title">Financeiro</div><a href="financeiro.html" class="nav-item"><span class="icon">üí∞</span> Resumo</a><a href="creditar-manual.html" class="nav-item"><span class="icon">‚ûï</span> Creditar Manual</a><a href="transacoes.html" class="nav-item"><span class="icon">üí≥</span> Transa√ß√µes</a><a href="premiacao.html" class="nav-item"><span class="icon">üéÅ</span> Premia√ß√£o</a><a href="indicacoes.html" class="nav-item"><span class="icon">üîó</span> Indica√ß√µes</a></div>
        <div class="nav-group"><div class="nav-group-title">Bolsa</div><a href="bolsa-admin.html" class="nav-item"><span class="icon">üìà</span> Gest√£o da Bolsa</a></div>
        <div class="nav-group"><div class="nav-group-title">Sistema</div><a href="configuracoes.html" class="nav-item"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a><a href="checkup.html" class="nav-item"><span class="icon">üîç</span> Checkup</a><a href="simulador_avancado.html" class="nav-item"><span class="icon">üß™</span> Simulador</a><a href="teste-regras.html" class="nav-item"><span class="icon">üìú</span> Regras</a></div>
    </nav>
    <div class="sidebar-footer"><div class="admin-box"><div class="admin-avatar">A</div><div class="admin-info-text"><div class="name">Admin</div><div class="role">Administrador</div></div><button class="btn-logout" onclick="sair()" title="Sair">‚èª</button></div></div>
</aside>

<div class="main">
    <div class="topbar">
        <h2>üë• Gerenciar Usu√°rios</h2>
        <div class="topbar-actions">
            <button class="btn" onclick="exportarCSV()">üì• Exportar CSV</button>
            <button class="btn btn-accent" onclick="abrirModalNovo()">+ Novo Usu√°rio</button>
        </div>
    </div>

    <div class="content">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card"><div class="ic">üë•</div><div class="val" id="stTotal">0</div><div class="lbl">Total Usu√°rios</div></div>
            <div class="stat-card"><div class="ic">üü¢</div><div class="val" id="stOnline">0</div><div class="lbl">Online Agora</div></div>
            <div class="stat-card"><div class="ic">üíé</div><div class="val" id="stDiamante">0</div><div class="lbl">N√≠vel Diamante+</div></div>
            <div class="stat-card"><div class="ic">üí∞</div><div class="val" id="stCreditos">0</div><div class="lbl">Cr√©ditos Circulando</div></div>
            <div class="stat-card"><div class="ic">‚≠ê</div><div class="val" id="stXP">0</div><div class="lbl">XP Total</div></div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="search-box"><span class="si">üîç</span><input type="text" id="busca" placeholder="Buscar por nome, @usu√°rio ou email..." oninput="filtrar()"></div>
            <select class="fsel" id="filtroNivel" onchange="filtrar()">
                <option value="">Todos N√≠veis</option>
                <option value="mestre">üíú Mestre</option>
                <option value="diamante">üíé Diamante</option>
                <option value="ouro">ü•á Ouro</option>
                <option value="prata">ü•à Prata</option>
                <option value="bronze">ü•â Bronze</option>
                <option value="iniciante">üÜï Iniciante</option>
            </select>
            <select class="fsel" id="filtroStatus" onchange="filtrar()">
                <option value="">Todos Status</option>
                <option value="online">üü¢ Online</option>
                <option value="ativo">‚úÖ Ativo</option>
                <option value="inativo">‚ùå Inativo</option>
                <option value="bloqueado">üö´ Bloqueado</option>
            </select>
            <button class="btn btn-sm" onclick="limparFiltros()">Limpar</button>
        </div>

        <!-- Table -->
        <div class="table-card">
            <table>
                <thead><tr>
                    <th>Usu√°rio</th>
                    <th>N√≠vel</th>
                    <th>XP</th>
                    <th>Cr√©ditos</th>
                    <th>Jogos</th>
                    <th>Status</th>
                    <th>Cadastro</th>
                    <th>A√ß√µes</th>
                </tr></thead>
                <tbody id="tbody"><tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">Carregando...</td></tr></tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pag">
            <button onclick="pagAnterior()" id="btnPrev" disabled>‚Üê Anterior</button>
            <span id="pagInfo">P√°gina 1</span>
            <button onclick="pagProxima()" id="btnNext">Pr√≥xima ‚Üí</button>
        </div>
    </div>
</div>

<!-- MODAL: Novo/Editar -->
<div class="modal-bg" id="modalEdit">
    <div class="modal modal-md">
        <div class="modal-head"><h3 id="meTitulo">+ Novo Usu√°rio</h3><button class="modal-close" onclick="fecharModal('modalEdit')">‚úï</button></div>
        <input type="hidden" id="meId">
        <div class="frow">
            <div class="fg"><label>Nome Completo</label><input type="text" id="meNome" placeholder="Nome"></div>
            <div class="fg"><label>@Usu√°rio (√∫nico)</label><input type="text" id="meUser" placeholder="usuario123"></div>
        </div>
        <div class="frow">
            <div class="fg"><label>Email</label><input type="email" id="meEmail" placeholder="email@ex.com"></div>
            <div class="fg"><label>Celular</label><input type="text" id="meCel" placeholder="(11) 99999-9999"></div>
        </div>
        <div class="frow">
            <div class="fg"><label>Data de Nascimento</label><input type="date" id="meNasc"></div>
            <div class="fg"><label>Status</label>
                <select id="meStatus"><option value="ativo">Ativo</option><option value="inativo">Inativo</option><option value="bloqueado">Bloqueado</option></select>
            </div>
        </div>
        <div class="frow">
            <div class="fg"><label>Cr√©ditos</label><input type="number" id="meCreditos" value="50"></div>
            <div class="fg"><label>XP</label><input type="number" id="meXP" value="0"></div>
        </div>
        <div class="frow">
            <div class="fg"><label>Cidade</label><input type="text" id="meCidade" placeholder="S√£o Paulo"></div>
            <div class="fg"><label>Estado</label><input type="text" id="meEstado" placeholder="SP"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-accent" onclick="salvarUsuario()">üíæ Salvar</button>
            <button class="btn btn-red" onclick="fecharModal('modalEdit')">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL: Detalhes -->
<div class="modal-bg" id="modalDet">
    <div class="modal modal-lg">
        <div class="modal-head"><h3>üìã Detalhes do Usu√°rio</h3><button class="modal-close" onclick="fecharModal('modalDet')">‚úï</button></div>
        <div id="detConteudo"></div>
    </div>
</div>

<!-- MODAL: Enviar Notifica√ß√£o -->
<div class="modal-bg" id="modalNotif">
    <div class="modal modal-sm">
        <div class="modal-head"><h3>üîî Enviar Notifica√ß√£o</h3><button class="modal-close" onclick="fecharModal('modalNotif')">‚úï</button></div>
        <input type="hidden" id="notifUserId">
        <div class="fg"><label>T√≠tulo</label><input type="text" id="notifTitulo" placeholder="Ex: Aviso importante"></div>
        <div class="fg"><label>Mensagem</label><textarea id="notifCorpo" placeholder="Escreva a mensagem..."></textarea></div>
        <div class="modal-footer">
            <button class="btn btn-accent" onclick="enviarNotificacao()">üì§ Enviar</button>
            <button class="btn" onclick="fecharModal('modalNotif')">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL: Adicionar Cr√©ditos -->
<div class="modal-bg" id="modalCreditos">
    <div class="modal modal-sm">
        <div class="modal-head"><h3>üí∞ Adicionar Cr√©ditos</h3><button class="modal-close" onclick="fecharModal('modalCreditos')">‚úï</button></div>
        <input type="hidden" id="credUserId">
        <div class="fg"><label>Quantidade</label><input type="number" id="credValor" placeholder="100" min="1"></div>
        <div class="fg"><label>Motivo (aparece no extrato)</label><input type="text" id="credMotivo" placeholder="Ex: B√¥nus promocional"></div>
        <div class="modal-footer">
            <button class="btn btn-green" onclick="adicionarCreditos()">‚úÖ Creditar</button>
            <button class="btn" onclick="fecharModal('modalCreditos')">Cancelar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",
    projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",
    messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8"
});
const db=firebase.firestore(), auth=firebase.auth();
let todos=[],filtrados=[],pag=1;const PP=15;

auth.onAuthStateChanged(u=>{
    if(!u||u.email!=='admin@yellup.com'){window.location.href='login.html';return;}
    carregar();
});
function sair(){auth.signOut().then(()=>window.location.href='login.html');}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('open');}

// ===== LOAD =====
async function carregar(){
    try{
        const snap=await db.collection('usuarios').orderBy('dataCadastro','desc').get();
        todos=[];
        snap.forEach(d=>todos.push({id:d.id,...d.data()}));
        filtrados=[...todos];
        render();
        calcStats();
    }catch(e){console.error(e);document.getElementById('tbody').innerHTML='<tr><td colspan="8" class="empty">Erro ao carregar</td></tr>';}
}

function calcStats(){
    let online=0,diamante=0,creditos=0,xp=0;
    todos.forEach(u=>{
        if(u.online)online++;
        const x=u.xp||0;
        if(x>=3000)diamante++;
        creditos+=u.creditos||0;
        xp+=x;
    });
    document.getElementById('stTotal').textContent=todos.length;
    document.getElementById('stOnline').textContent=online;
    document.getElementById('stDiamante').textContent=diamante;
    document.getElementById('stCreditos').textContent=creditos.toLocaleString();
    document.getElementById('stXP').textContent=xp.toLocaleString();
}

// ===== RENDER =====
function render(){
    const ini=(pag-1)*PP, fim=ini+PP, pagina=filtrados.slice(ini,fim);
    const tb=document.getElementById('tbody');
    if(!pagina.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-muted)">Nenhum usu√°rio encontrado</td></tr>';atualizarPag();return;}

    tb.innerHTML=pagina.map(u=>{
        const initial=(u.nome||u.usuarioUnico||'U')[0].toUpperCase();
        const nv=getNivel(u.xp||0);
        const statusCls=u.status==='bloqueado'?'badge-bloqueado':u.status==='inativo'?'badge-inativo':'badge-ativo';
        const statusTxt=u.status||'ativo';
        const dt=u.dataCadastro?.toDate?u.dataCadastro.toDate().toLocaleDateString('pt-BR'):'N/A';
        const onlineDot=u.online?'<span class="online-dot"></span>':'';
        return`<tr>
            <td><div class="user-cell"><div class="uav" style="background:${nv.cor}">${esc(initial)}</div><div><div class="uname">${esc(u.nome||'Sem nome')}${onlineDot}</div><div class="uhandle">@${esc(u.usuarioUnico||'user')}</div></div></div></td>
            <td><span class="badge ${nv.cls}">${nv.emoji} ${nv.nome}</span></td>
            <td class="mono">${(u.xp||0).toLocaleString()}</td>
            <td class="mono">${(u.creditos||0).toLocaleString()}</td>
            <td class="mono">${u.jogosParticipados||u.totalJogos||0}</td>
            <td><span class="badge ${statusCls}">${statusTxt}</span></td>
            <td style="font-size:11px;color:var(--text-muted)">${dt}</td>
            <td><div class="acts">
                <button class="btn btn-blue btn-sm" onclick="verDetalhes('${u.id}')" title="Ver">üëÅÔ∏è</button>
                <button class="btn btn-green btn-sm" onclick="editarUsuario('${u.id}')" title="Editar">‚úèÔ∏è</button>
                <button class="btn btn-red btn-sm" onclick="excluirUsuario('${u.id}','${esc(u.nome||u.usuarioUnico||'')}')" title="Excluir">üóëÔ∏è</button>
            </div></td>
        </tr>`;
    }).join('');
    atualizarPag();
}

function atualizarPag(){
    const tp=Math.ceil(filtrados.length/PP)||1;
    document.getElementById('pagInfo').textContent=`P√°gina ${pag} de ${tp} ¬∑ ${filtrados.length} usu√°rios`;
    document.getElementById('btnPrev').disabled=pag<=1;
    document.getElementById('btnNext').disabled=pag>=tp;
}
function pagAnterior(){if(pag>1){pag--;render();}}
function pagProxima(){if(pag<Math.ceil(filtrados.length/PP)){pag++;render();}}

// ===== FILTER =====
function filtrar(){
    const t=document.getElementById('busca').value.toLowerCase();
    const nv=document.getElementById('filtroNivel').value;
    const st=document.getElementById('filtroStatus').value;
    filtrados=todos.filter(u=>{
        if(t){
            const n=(u.nome||'').toLowerCase(), h=(u.usuarioUnico||'').toLowerCase(), e=(u.email||'').toLowerCase();
            if(!n.includes(t)&&!h.includes(t)&&!e.includes(t))return false;
        }
        if(nv&&getNivelSlug(u.xp||0)!==nv)return false;
        if(st==='online'&&!u.online)return false;
        if(st==='ativo'&&u.status!=='ativo'&&u.status!==undefined)return false;
        if(st==='inativo'&&u.status!=='inativo')return false;
        if(st==='bloqueado'&&u.status!=='bloqueado')return false;
        return true;
    });
    pag=1;render();
}
function limparFiltros(){document.getElementById('busca').value='';document.getElementById('filtroNivel').value='';document.getElementById('filtroStatus').value='';filtrados=[...todos];pag=1;render();}

// ===== NIVEL HELPERS =====
function getNivel(xp){
    if(xp>=5000)return{nome:'Mestre',emoji:'üíú',cls:'nivel-mestre',cor:'linear-gradient(135deg,#a78bfa,#7c3aed)'};
    if(xp>=3000)return{nome:'Diamante',emoji:'üíé',cls:'nivel-diamante',cor:'linear-gradient(135deg,#22d3ee,#0891b2)'};
    if(xp>=1500)return{nome:'Ouro',emoji:'ü•á',cls:'nivel-ouro',cor:'linear-gradient(135deg,#f0b429,#d97706)'};
    if(xp>=500)return{nome:'Prata',emoji:'ü•à',cls:'nivel-prata',cor:'linear-gradient(135deg,#C0C0C0,#808080)'};
    if(xp>=100)return{nome:'Bronze',emoji:'ü•â',cls:'nivel-bronze',cor:'linear-gradient(135deg,#cd7f32,#8b4513)'};
    return{nome:'Iniciante',emoji:'üÜï',cls:'nivel-iniciante',cor:'linear-gradient(135deg,#6b7280,#4b5563)'};
}
function getNivelSlug(xp){if(xp>=5000)return'mestre';if(xp>=3000)return'diamante';if(xp>=1500)return'ouro';if(xp>=500)return'prata';if(xp>=100)return'bronze';return'iniciante';}

// ===== VER DETALHES =====
function verDetalhes(id){
    const u=todos.find(x=>x.id===id);if(!u)return;
    const nv=getNivel(u.xp||0);
    const dt=u.dataCadastro?.toDate?u.dataCadastro.toDate().toLocaleString('pt-BR'):'N/A';
    const torcidas=u.torcidas?Object.keys(u.torcidas).length:0;
    const statusLabel=u.status==='bloqueado'?'üö´ Bloqueado':u.status==='inativo'?'‚ùå Inativo':'‚úÖ Ativo';

    document.getElementById('detConteudo').innerHTML=`
        <div class="det-grid">
            <div class="det-item"><div class="dl">Nome</div><div class="dv">${esc(u.nome||'N/A')}</div></div>
            <div class="det-item"><div class="dl">@Usu√°rio</div><div class="dv">@${esc(u.usuarioUnico||'N/A')}</div></div>
            <div class="det-item"><div class="dl">Email</div><div class="dv">${esc(u.email||'N/A')}</div></div>
            <div class="det-item"><div class="dl">Celular</div><div class="dv">${esc(u.celular||'N/A')}</div></div>
            <div class="det-item"><div class="dl">Apelido</div><div class="dv">${esc(u.apelido||u.usuario||'N/A')}</div></div>
            <div class="det-item"><div class="dl">Status</div><div class="dv">${statusLabel} ${u.online?'üü¢':''}</div></div>
        </div>

        <div class="det-section">üìä Estat√≠sticas</div>
        <div class="det-grid">
            <div class="det-item"><div class="dl">N√≠vel</div><div class="dv"><span class="badge ${nv.cls}">${nv.emoji} ${nv.nome}</span></div></div>
            <div class="det-item"><div class="dl">XP</div><div class="dv" style="color:var(--accent)">${(u.xp||u.pontuacao||0).toLocaleString()}</div></div>
            <div class="det-item"><div class="dl">Cr√©ditos</div><div class="dv" style="color:var(--green)">${(u.creditos||0).toLocaleString()}</div></div>
            <div class="det-item"><div class="dl">Jogos</div><div class="dv">${u.jogosParticipados||u.totalJogos||0}</div></div>
            <div class="det-item"><div class="dl">Vit√≥rias</div><div class="dv">${u.vitorias||0}</div></div>
            <div class="det-item"><div class="dl">Streak Atual</div><div class="dv">üî• ${u.streak||0} dias</div></div>
            <div class="det-item"><div class="dl">Maior Streak</div><div class="dv">üî• ${u.maiorStreak||u.streakMaximo||0}</div></div>
            <div class="det-item"><div class="dl">Torcidas</div><div class="dv">${torcidas} jogos</div></div>
            <div class="det-item"><div class="dl">Conquistas</div><div class="dv">üèÜ ${u.conquistas?.length||0}</div></div>
        </div>

        <div class="det-section">üìç Informa√ß√µes</div>
        <div class="det-grid">
            <div class="det-item"><div class="dl">Localiza√ß√£o</div><div class="dv">${esc(u.cidade||'')} ${u.estado?'- '+u.estado:''}</div></div>
            <div class="det-item"><div class="dl">Nascimento</div><div class="dv">${esc(u.dataNascimento||'N/A')}</div></div>
            <div class="det-item"><div class="dl">Cadastrado em</div><div class="dv">${dt}</div></div>
            <div class="det-item"><div class="dl">C√≥digo Indica√ß√£o</div><div class="dv">${esc(u.codigoIndicacao||'N/A')}</div></div>
            <div class="det-item"><div class="dl">ID Firebase</div><div class="dv" style="font-family:'JetBrains Mono',monospace;font-size:11px;word-break:break-all">${u.id}</div></div>
            <div class="det-item"><div class="dl">Clube</div><div class="dv">${esc(u.clubeId||'Nenhum')}</div></div>
        </div>

        <div class="det-actions">
            <button class="btn btn-green btn-sm" onclick="editarUsuario('${u.id}');fecharModal('modalDet');">‚úèÔ∏è Editar</button>
            <button class="btn btn-accent btn-sm" onclick="abrirModalCreditos('${u.id}')">üí∞ Add Cr√©ditos</button>
            <button class="btn btn-purple btn-sm" onclick="abrirModalNotif('${u.id}')">üîî Enviar Notifica√ß√£o</button>
            <button class="btn btn-blue btn-sm" onclick="resetarSenha('${u.id}')">üîë Reset Senha</button>
            ${u.status==='bloqueado'
                ?`<button class="btn btn-green btn-sm" onclick="toggleBloquear('${u.id}',false)">‚úÖ Desbloquear</button>`
                :`<button class="btn btn-red btn-sm" onclick="toggleBloquear('${u.id}',true)">üö´ Bloquear</button>`}
        </div>
    `;
    document.getElementById('modalDet').classList.add('active');
}

// ===== MODAL EDIT =====
function abrirModalNovo(){
    document.getElementById('meTitulo').textContent='+ Novo Usu√°rio';
    document.getElementById('meId').value='';
    ['meNome','meUser','meEmail','meCel','meNasc','meCidade','meEstado'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('meStatus').value='ativo';
    document.getElementById('meCreditos').value='50';
    document.getElementById('meXP').value='0';
    document.getElementById('modalEdit').classList.add('active');
}
function editarUsuario(id){
    const u=todos.find(x=>x.id===id);if(!u)return;
    document.getElementById('meTitulo').textContent='‚úèÔ∏è Editar Usu√°rio';
    document.getElementById('meId').value=id;
    document.getElementById('meNome').value=u.nome||'';
    document.getElementById('meUser').value=u.usuarioUnico||'';
    document.getElementById('meEmail').value=u.email||'';
    document.getElementById('meCel').value=u.celular||'';
    document.getElementById('meNasc').value=u.dataNascimento||'';
    document.getElementById('meStatus').value=u.status||'ativo';
    document.getElementById('meCreditos').value=u.creditos||50;
    document.getElementById('meXP').value=u.xp||0;
    document.getElementById('meCidade').value=u.cidade||'';
    document.getElementById('meEstado').value=u.estado||'';
    document.getElementById('modalEdit').classList.add('active');
}
async function salvarUsuario(){
    const id=document.getElementById('meId').value;
    const dados={
        nome:document.getElementById('meNome').value,
        usuarioUnico:document.getElementById('meUser').value,
        email:document.getElementById('meEmail').value,
        celular:document.getElementById('meCel').value,
        dataNascimento:document.getElementById('meNasc').value,
        status:document.getElementById('meStatus').value,
        creditos:parseInt(document.getElementById('meCreditos').value)||50,
        xp:parseInt(document.getElementById('meXP').value)||0,
        cidade:document.getElementById('meCidade').value,
        estado:document.getElementById('meEstado').value
    };
    if(!dados.nome||!dados.usuarioUnico){showToast('‚ö†Ô∏è Preencha nome e usu√°rio!',true);return;}
    try{
        if(id){await db.collection('usuarios').doc(id).update(dados);showToast('‚úÖ Usu√°rio atualizado!');}
        else{dados.dataCadastro=firebase.firestore.FieldValue.serverTimestamp();dados.online=false;dados.jogosParticipados=0;dados.streak=0;dados.conquistas=[];await db.collection('usuarios').add(dados);showToast('‚úÖ Usu√°rio criado!');}
        fecharModal('modalEdit');carregar();
    }catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== DELETE =====
async function excluirUsuario(id,nome){
    if(!confirm(`Excluir "${nome}"? Esta a√ß√£o n√£o pode ser desfeita.`))return;
    try{await db.collection('usuarios').doc(id).delete();showToast('üóëÔ∏è Exclu√≠do!');carregar();}
    catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== BLOQUEAR/DESBLOQUEAR =====
async function toggleBloquear(id,bloquear){
    const acao=bloquear?'bloquear':'desbloquear';
    if(!confirm(`Deseja ${acao} este usu√°rio?`))return;
    try{
        await db.collection('usuarios').doc(id).update({status:bloquear?'bloqueado':'ativo'});
        if(bloquear){
            // Notificar o usu√°rio que foi bloqueado
            await db.collection('usuarios').doc(id).collection('notificacoes').add({
                titulo:'‚ö†Ô∏è Conta suspensa',
                corpo:'Sua conta foi suspensa temporariamente. Entre em contato com o suporte.',
                lida:false,
                data:firebase.firestore.Timestamp.now()
            });
        }
        showToast(bloquear?'üö´ Usu√°rio bloqueado':'‚úÖ Usu√°rio desbloqueado');
        fecharModal('modalDet');carregar();
    }catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== ENVIAR NOTIFICA√á√ÉO =====
function abrirModalNotif(id){
    document.getElementById('notifUserId').value=id;
    document.getElementById('notifTitulo').value='';
    document.getElementById('notifCorpo').value='';
    document.getElementById('modalNotif').classList.add('active');
}
async function enviarNotificacao(){
    const userId=document.getElementById('notifUserId').value;
    const titulo=document.getElementById('notifTitulo').value.trim();
    const corpo=document.getElementById('notifCorpo').value.trim();
    if(!titulo||!corpo){showToast('‚ö†Ô∏è Preencha t√≠tulo e mensagem!',true);return;}
    try{
        // Salvar na subcollection do usu√°rio (sininho)
        await db.collection('usuarios').doc(userId).collection('notificacoes').add({
            titulo,corpo,lida:false,
            data:firebase.firestore.Timestamp.now()
        });
        // Salvar tamb√©m na collection global (compatibilidade)
        await db.collection('notificacoes').add({
            userId,tipo:'admin',titulo,mensagem:corpo,
            lida:false,data:firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('üîî Notifica√ß√£o enviada!');
        fecharModal('modalNotif');
    }catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== ADICIONAR CR√âDITOS =====
function abrirModalCreditos(id){
    document.getElementById('credUserId').value=id;
    document.getElementById('credValor').value='';
    document.getElementById('credMotivo').value='';
    document.getElementById('modalCreditos').classList.add('active');
}
async function adicionarCreditos(){
    const userId=document.getElementById('credUserId').value;
    const valor=parseInt(document.getElementById('credValor').value);
    const motivo=document.getElementById('credMotivo').value.trim()||'Cr√©dito manual pelo admin';
    if(!valor||valor<=0){showToast('‚ö†Ô∏è Informe um valor v√°lido!',true);return;}
    try{
        // Incrementar cr√©ditos
        await db.collection('usuarios').doc(userId).update({
            creditos:firebase.firestore.FieldValue.increment(valor)
        });
        // Registrar no extrato do usu√°rio
        await db.collection('usuarios').doc(userId).collection('extrato').add({
            tipo:'entrada',valor,descricao:motivo,
            data:firebase.firestore.Timestamp.now()
        });
        // Registrar transa√ß√£o global
        await db.collection('transacoes').add({
            usuarioId:userId,tipo:'credito_manual',valor,descricao:motivo,
            adminId:'admin@yellup.com',
            data:firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast(`‚úÖ ${valor} cr√©ditos adicionados!`);
        fecharModal('modalCreditos');fecharModal('modalDet');carregar();
    }catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== RESET SENHA =====
async function resetarSenha(id){
    const u=todos.find(x=>x.id===id);
    if(!u||!u.email){showToast('‚ö†Ô∏è Usu√°rio sem email!',true);return;}
    if(!confirm(`Enviar email de reset de senha para ${u.email}?`))return;
    try{
        await firebase.auth().sendPasswordResetEmail(u.email);
        // Notificar o usu√°rio
        await db.collection('usuarios').doc(id).collection('notificacoes').add({
            titulo:'üîë Reset de senha solicitado',
            corpo:'Um email de recupera√ß√£o de senha foi enviado. Verifique sua caixa de entrada.',
            lida:false,data:firebase.firestore.Timestamp.now()
        });
        showToast('üìß Email de reset enviado!');
    }catch(e){showToast('‚ùå Erro: '+e.message,true);}
}

// ===== EXPORTAR CSV =====
function exportarCSV(){
    let csv='Nome,Usuario,Email,Celular,Nivel,XP,Creditos,Jogos,Vitorias,Streak,Status,Cadastro\n';
    filtrados.forEach(u=>{
        const nv=getNivel(u.xp||0);
        const dt=u.dataCadastro?.toDate?u.dataCadastro.toDate().toLocaleDateString('pt-BR'):'';
        csv+=`"${u.nome||''}","${u.usuarioUnico||''}","${u.email||''}","${u.celular||''}","${nv.nome}",${u.xp||0},${u.creditos||0},${u.jogosParticipados||0},${u.vitorias||0},${u.streak||0},"${u.status||'ativo'}","${dt}"\n`;
    });
    const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=`usuarios-yellup-${new Date().toISOString().slice(0,10)}.csv`;a.click();
    showToast('üì• CSV exportado!');
}

// ===== UTILS =====
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function fecharModal(id){document.getElementById(id).classList.remove('active');}
function showToast(m,err){const t=document.getElementById('toast');t.textContent=m;t.className='toast show'+(err?' error':'');setTimeout(()=>t.classList.remove('show'),3000);}

// Fechar modais com Escape
document.addEventListener('keydown',e=>{if(e.key==='Escape'){['modalEdit','modalDet','modalNotif','modalCreditos'].forEach(id=>fecharModal(id));}});

// Fechar clicando fora
document.querySelectorAll('.modal-bg').forEach(bg=>{bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('active');});});

// M√°scara celular
document.getElementById('meCel').addEventListener('input',function(){this.value=this.value.replace(/\D/g,'').replace(/(\d{2})(\d)/,'($1) $2').replace(/(\d{5})(\d)/,'$1-$2').replace(/(-\d{4})\d+?$/,'$1');});
</script>
</body>
</html>
