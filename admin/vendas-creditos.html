<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saques - Yellup Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-primary: #0c0e14;
            --bg-secondary: #12141c;
            --bg-card: #181a24;
            --bg-card-hover: #1e2030;
            --bg-sidebar: #10121a;
            --border: #1e2030;
            --border-light: #282a3a;
            --text-primary: #e8e9ed;
            --text-secondary: #8b8d9a;
            --text-muted: #5c5e6e;
            --accent: #f0b429;
            --accent-dim: rgba(240, 180, 41, 0.12);
            --green: #34d399;
            --green-dim: rgba(52, 211, 153, 0.12);
            --red: #f87171;
            --red-dim: rgba(248, 113, 113, 0.12);
            --blue: #60a5fa;
            --blue-dim: rgba(96, 165, 250, 0.12);
            --purple: #a78bfa;
            --purple-dim: rgba(167, 139, 250, 0.12);
            --orange: #fb923c;
            --orange-dim: rgba(251, 146, 60, 0.12);
            --sidebar-w: 250px;
            --header-h: 64px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-w); height: 100vh; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s ease; }
        .sidebar-brand { height: var(--header-h); display: flex; align-items: center; gap: 10px; padding: 0 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .sidebar-brand .logo { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; color: #000; }
        .sidebar-brand h1 { font-size: 17px; font-weight: 700; letter-spacing: -0.3px; }
        .sidebar-brand h1 span { color: var(--text-muted); font-weight: 500; font-size: 12px; margin-left: 6px; }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; }
        .sidebar-nav::-webkit-scrollbar { width: 0; }
        .nav-group { margin-bottom: 8px; }
        .nav-group-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); padding: 12px 20px 6px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 16px; margin: 1px 8px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.15s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item .icon { width: 20px; text-align: center; font-size: 14px; flex-shrink: 0; }
        .nav-item .badge { margin-left: auto; background: var(--red); color: #fff; font-size: 10px; font-weight: 600; padding: 1px 7px; border-radius: 10px; }
        .sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .sidebar-footer .admin-box { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; }
        .admin-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), #e09800); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #000; }
        .admin-info-text { flex: 1; }
        .admin-info-text .name { font-size: 13px; font-weight: 600; }
        .admin-info-text .role { font-size: 11px; color: var(--text-muted); }
        .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 4px; border-radius: 6px; }
        .btn-logout:hover { color: var(--red); background: var(--red-dim); }

        /* ===== MAIN ===== */
        .main { margin-left: var(--sidebar-w); min-height: 100vh; }
        .header { height: var(--header-h); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 32px; background: var(--bg-primary); position: sticky; top: 0; z-index: 50; }
        .header-left h2 { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; }
        .header-left p { font-size: 12px; color: var(--text-muted); margin-top: 1px; }
        .header-actions { display: flex; gap: 8px; }
        .btn-header { display: flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 12px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.15s; text-decoration: none; }
        .btn-header:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
        .content { padding: 24px 32px 40px; }

        /* ===== STATS ===== */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .stat-card:hover { border-color: var(--border-light); }
        .stat-icon-box { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-bottom: 10px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; line-height: 1; margin-bottom: 3px; }
        .stat-label { font-size: 11px; color: var(--text-muted); font-weight: 500; }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-accent { color: var(--accent); }
        .text-orange { color: var(--orange); }

        /* ===== TABS ===== */
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 4px; width: fit-content; }
        .tab-btn { padding: 7px 16px; border-radius: 7px; border: none; background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
        .tab-btn:hover { color: var(--text-secondary); }
        .tab-btn.active { background: var(--accent-dim); color: var(--accent); }
        .tab-count { font-family: 'JetBrains Mono', monospace; font-size: 10px; background: var(--bg-card-hover); padding: 1px 6px; border-radius: 4px; }
        .tab-btn.active .tab-count { background: rgba(240, 180, 41, 0.2); }

        /* ===== CARD / TABLE ===== */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        tbody td { padding: 10px 16px; font-size: 12px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: var(--bg-card-hover); }
        tbody tr:last-child td { border-bottom: none; }

        .mono { font-family: 'JetBrains Mono', monospace; }
        .fw600 { font-weight: 600; }

        .user-cell .name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .user-cell .email { font-size: 10px; color: var(--text-muted); margin-top: 1px; }
        .pix-cell { font-size: 10px; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-muted); cursor: pointer; }
        .pix-cell:hover { color: var(--text-secondary); }

        .badge-status { display: inline-block; padding: 2px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .badge-aprovado { color: var(--green); background: var(--green-dim); }
        .badge-pendente { color: var(--orange); background: var(--orange-dim); }
        .badge-rejeitado { color: var(--red); background: var(--red-dim); }

        .btn-action { padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; font-family: inherit; transition: all 0.15s; margin: 0 2px; }
        .btn-aprovar { background: var(--green-dim); color: var(--green); }
        .btn-aprovar:hover { background: rgba(52, 211, 153, 0.25); }
        .btn-rejeitar { background: var(--red-dim); color: var(--red); }
        .btn-rejeitar:hover { background: rgba(248, 113, 113, 0.25); }
        .btn-detalhes { background: var(--blue-dim); color: var(--blue); }
        .btn-detalhes:hover { background: rgba(96, 165, 250, 0.25); }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 13px; }

        /* ===== MODAL ===== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 480px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .modal-header h3 { font-size: 15px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
        .modal-close:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .modal-body { padding: 24px; }

        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 12px; color: var(--text-muted); }
        .detail-value { font-size: 13px; font-weight: 600; }
        .detail-value.highlight { color: var(--green); font-family: 'JetBrains Mono', monospace; font-size: 18px; }

        .pix-box { margin: 20px 24px; padding: 16px; background: var(--bg-secondary); border: 1px dashed var(--border-light); border-radius: 10px; }
        .pix-box label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .pix-key { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--accent); word-break: break-all; margin-bottom: 10px; }
        .btn-copy { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 11px; font-weight: 500; cursor: pointer; font-family: inherit; }
        .btn-copy:hover { border-color: var(--accent); background: var(--accent-dim); }

        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
        .modal-footer .btn { padding: 8px 20px; border-radius: 8px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s; }
        .btn-confirm { background: var(--green); color: #000; }
        .btn-confirm:hover { opacity: 0.9; }
        .btn-reject { background: var(--red-dim); color: var(--red); }
        .btn-reject:hover { background: rgba(248, 113, 113, 0.25); }
        .btn-cancel { background: var(--bg-card-hover); color: var(--text-secondary); }

        /* ===== TOAST ===== */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 24px; border-radius: 10px; font-size: 13px; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ===== MOBILE ===== */
        .mobile-toggle { display: none; position: fixed; top: 16px; left: 16px; z-index: 200; width: 40px; height: 40px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-primary); font-size: 18px; cursor: pointer; align-items: center; justify-content: center; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; }
        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .overlay.open { display: block; }
            .mobile-toggle { display: flex; }
            .main { margin-left: 0; }
            .header { padding: 0 16px 0 64px; }
            .content { padding: 16px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .tabs { flex-wrap: wrap; width: 100%; }
        }
    </style>
</head>
<body>

    <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand"><div class="logo">Y</div><h1>Yellup <span>Admin</span></h1></div>
        <nav class="sidebar-nav">
            <div class="nav-group"><div class="nav-group-title">Vis√£o Geral</div><a href="dashboard.html" class="nav-item"><span class="icon">üìä</span> Dashboard</a></div>
            <div class="nav-group"><div class="nav-group-title">Conte√∫do</div><a href="jogos.html" class="nav-item"><span class="icon">üéÆ</span> Jogos</a><a href="perguntas.html" class="nav-item"><span class="icon">‚ùì</span> Perguntas</a><a href="importar-perguntas.html" class="nav-item"><span class="icon">üì•</span> Importar Perguntas</a><a href="gerar-perguntas.html" class="nav-item"><span class="icon">ü§ñ</span> Gerar com IA</a><a href="times.html" class="nav-item"><span class="icon">‚öΩ</span> Times</a></div>
            <div class="nav-group"><div class="nav-group-title">Jogadores</div><a href="usuarios.html" class="nav-item"><span class="icon">üë•</span> Usu√°rios</a><a href="ranking.html" class="nav-item"><span class="icon">üèÜ</span> Rankings</a><a href="admin-noticias.html" class="nav-item"><span class="icon">üì∞</span> Not√≠cias</a></div>
            <div class="nav-group"><div class="nav-group-title">Competi√ß√µes</div><a href="torneios.html" class="nav-item"><span class="icon">üèÖ</span> Torneios</a><a href="inicializar-pvp.html" class="nav-item"><span class="icon">‚öîÔ∏è</span> Embates PvP</a></div>
            <div class="nav-group"><div class="nav-group-title">Financeiro</div><a href="financeiro.html" class="nav-item"><span class="icon">üí∞</span> Resumo</a><a href="vendas-creditos.html" class="nav-item active"><span class="icon">üí∏</span> Saques<span class="badge" id="badgeSaquesNav" style="display:none"></span></a><a href="creditar-manual.html" class="nav-item"><span class="icon">‚ûï</span> Creditar Manual</a><a href="transacoes.html" class="nav-item"><span class="icon">üí≥</span> Transa√ß√µes</a><a href="premiacao.html" class="nav-item"><span class="icon">üéÅ</span> Premia√ß√£o</a><a href="indicacoes.html" class="nav-item"><span class="icon">üîó</span> Indica√ß√µes</a></div>
            <div class="nav-group"><div class="nav-group-title">Bolsa</div><a href="bolsa-admin.html" class="nav-item"><span class="icon">üìà</span> Gest√£o da Bolsa</a></div>
            <div class="nav-group"><div class="nav-group-title">Sistema</div><a href="configuracoes.html" class="nav-item"><span class="icon">‚öôÔ∏è</span> Configura√ß√µes</a><a href="checkup.html" class="nav-item"><span class="icon">üîç</span> Checkup</a><a href="simulador_avancado.html" class="nav-item"><span class="icon">üß™</span> Simulador</a><a href="teste-regras.html" class="nav-item"><span class="icon">üìú</span> Regras</a></div>
        </nav>
        <div class="sidebar-footer"><div class="admin-box"><div class="admin-avatar">A</div><div class="admin-info-text"><div class="name">Admin</div><div class="role">Administrador</div></div><button class="btn-logout" onclick="sair()" title="Sair">‚èª</button></div></div>
    </aside>

    <!-- MAIN -->
    <div class="main">
        <header class="header">
            <div class="header-left">
                <h2>üí∏ Saques (Cashout)</h2>
                <p>Aprovar e gerenciar solicita√ß√µes de saque</p>
            </div>
            <div class="header-actions">
                <button class="btn-header" onclick="carregarVendas()">‚Üª Atualizar</button>
            </div>
        </header>

        <div class="content">
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--orange-dim)">‚è≥</div>
                    <div class="stat-value text-orange" id="statPendentes">...</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--green-dim)">‚úÖ</div>
                    <div class="stat-value text-green" id="statAprovados">...</div>
                    <div class="stat-label">Aprovados (m√™s)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--accent-dim)">üíé</div>
                    <div class="stat-value text-accent" id="statCreditosPendentes">...</div>
                    <div class="stat-label">Cr√©ditos pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon-box" style="background:var(--green-dim)">üí∞</div>
                    <div class="stat-value text-green" id="statValorPendente">...</div>
                    <div class="stat-label">Valor a pagar</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="filtrarPor('pendente', this)">‚è≥ Pendentes <span class="tab-count" id="countPendentes">0</span></button>
                <button class="tab-btn" onclick="filtrarPor('aprovado', this)">‚úÖ Aprovados</button>
                <button class="tab-btn" onclick="filtrarPor('rejeitado', this)">‚ùå Rejeitados</button>
                <button class="tab-btn" onclick="filtrarPor('todos', this)">üìã Todos</button>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Usu√°rio</th>
                                <th>Cr√©ditos</th>
                                <th>Valor R$</th>
                                <th>Chave PIX</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="7" class="empty-state">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div class="modal-overlay" id="modalDetalhes">
        <div class="modal">
            <div class="modal-header">
                <h3>üìã Detalhes do Saque</h3>
                <button class="modal-close" onclick="fecharModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="pix-box">
                <label>Chave PIX do Usu√°rio</label>
                <div class="pix-key" id="modalPixKey">‚Äî</div>
                <button class="btn-copy" onclick="copiarPix()">üìã Copiar Chave</button>
            </div>
            <div class="modal-footer" id="modalActions">
                <button class="btn btn-cancel" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-reject" onclick="rejeitarVenda()">‚ùå Rejeitar</button>
                <button class="btn btn-confirm" onclick="aprovarVenda()">‚úÖ Confirmar PIX</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ===================================
        // FIREBASE
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
            authDomain: "painel-yellup.firebaseapp.com",
            projectId: "painel-yellup",
            storageBucket: "painel-yellup.appspot.com",
            messagingSenderId: "608347210297",
            appId: "1:608347210297:web:75092713724e617c7203e8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let vendasData = [];
        let filtroAtual = 'pendente';
        let vendaSelecionada = null;

        // ===================================
        // AUTH
        // ===================================
        auth.onAuthStateChanged(user => {
            if (!user || user.email !== 'admin@yellup.com') {
                window.location.href = 'login.html';
                return;
            }
            carregarVendas();
        });

        function sair() { auth.signOut().then(() => window.location.href = 'login.html'); }
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ===================================
        // CARREGAR VENDAS
        // ===================================
        async function carregarVendas() {
            try {
                const snap = await db.collection('vendas_creditos')
                    .orderBy('dataSolicitacao', 'desc')
                    .limit(100).get();

                vendasData = [];
                let pendentes = 0, aprovados = 0, creditosPendentes = 0, valorPendente = 0;

                snap.forEach(doc => {
                    const venda = { id: doc.id, ...doc.data() };
                    vendasData.push(venda);

                    if (venda.status === 'pendente') {
                        pendentes++;
                        creditosPendentes += venda.creditos || 0;
                        valorPendente += venda.valorTotal || 0;
                    } else if (venda.status === 'aprovado') {
                        const dv = venda.dataProcessamento?.toDate ? venda.dataProcessamento.toDate() : null;
                        if (dv && dv.getMonth() === new Date().getMonth()) aprovados++;
                    }
                });

                document.getElementById('statPendentes').textContent = pendentes;
                document.getElementById('statAprovados').textContent = aprovados;
                document.getElementById('statCreditosPendentes').textContent = creditosPendentes.toLocaleString('pt-BR');
                document.getElementById('statValorPendente').textContent = `R$${valorPendente.toFixed(2)}`;
                document.getElementById('countPendentes').textContent = pendentes;

                // Badge na sidebar
                const badge = document.getElementById('badgeSaquesNav');
                if (pendentes > 0) { badge.textContent = pendentes; badge.style.display = 'inline'; }

                renderizarTabela();
            } catch (e) {
                console.error('Erro:', e);
                showToast('‚ùå Erro ao carregar');
            }
        }

        // ===================================
        // FILTROS / TABS
        // ===================================
        function filtrarPor(status, el) {
            filtroAtual = status;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            renderizarTabela();
        }

        // ===================================
        // RENDERIZAR TABELA
        // ===================================
        function renderizarTabela() {
            const tbody = document.getElementById('tableBody');
            let filtradas = vendasData;
            if (filtroAtual !== 'todos') {
                filtradas = vendasData.filter(v => v.status === filtroAtual);
            }

            if (filtradas.length === 0) {
                const msg = filtroAtual === 'pendente' ? '‚úÖ Nenhum saque pendente!' : `Nenhum saque ${filtroAtual}`;
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state">${msg}</td></tr>`;
                return;
            }

            tbody.innerHTML = filtradas.map(v => {
                const data = v.dataSolicitacao?.toDate ? v.dataSolicitacao.toDate().toLocaleDateString('pt-BR') : '‚Äî';
                const valor = ((v.creditos || 0) * 0.40).toFixed(2);
                const sClass = v.status === 'aprovado' ? 'badge-aprovado' : v.status === 'rejeitado' ? 'badge-rejeitado' : 'badge-pendente';
                const sText = v.status === 'aprovado' ? '‚úì Pago' : v.status === 'rejeitado' ? '‚úó Rejeitado' : '‚è≥ Pendente';

                const acoes = v.status === 'pendente'
                    ? `<button class="btn-action btn-detalhes" onclick="abrirDetalhes('${v.id}')">üëÅÔ∏è</button>
                       <button class="btn-action btn-aprovar" onclick="abrirDetalhes('${v.id}')">‚úì</button>
                       <button class="btn-action btn-rejeitar" onclick="rejeitarRapido('${v.id}')">‚úó</button>`
                    : `<button class="btn-action btn-detalhes" onclick="abrirDetalhes('${v.id}')">üëÅÔ∏è</button>`;

                return `<tr>
                    <td><div class="user-cell"><div class="name">${v.usuarioNome || 'Usu√°rio'}</div><div class="email">${v.usuarioEmail || ''}</div></div></td>
                    <td class="mono fw600">${(v.creditos || 0).toLocaleString('pt-BR')}</td>
                    <td class="mono text-green fw600">R$${valor}</td>
                    <td class="pix-cell" title="${v.chavePix || ''}" onclick="copiarTexto('${v.chavePix || ''}')">${v.chavePix || '‚Äî'}</td>
                    <td>${data}</td>
                    <td><span class="badge-status ${sClass}">${sText}</span></td>
                    <td>${acoes}</td>
                </tr>`;
            }).join('');
        }

        // ===================================
        // MODAL DETALHES
        // ===================================
        function abrirDetalhes(vendaId) {
            vendaSelecionada = vendasData.find(v => v.id === vendaId);
            if (!vendaSelecionada) return;

            const data = vendaSelecionada.dataSolicitacao?.toDate
                ? vendaSelecionada.dataSolicitacao.toDate().toLocaleString('pt-BR') : '‚Äî';
            const valor = (vendaSelecionada.valorTotal || (vendaSelecionada.creditos || 0) * 0.40);

            document.getElementById('modalBody').innerHTML = `
                <div class="detail-row"><span class="detail-label">Usu√°rio</span><span class="detail-value">${vendaSelecionada.usuarioNome || '‚Äî'}</span></div>
                <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${vendaSelecionada.usuarioEmail || '‚Äî'}</span></div>
                <div class="detail-row"><span class="detail-label">CPF</span><span class="detail-value">${vendaSelecionada.cpf || '‚Äî'}</span></div>
                <div class="detail-row"><span class="detail-label">Cr√©ditos</span><span class="detail-value mono">${(vendaSelecionada.creditos || 0).toLocaleString('pt-BR')}</span></div>
                <div class="detail-row"><span class="detail-label">Valor a Pagar</span><span class="detail-value highlight">R$ ${valor.toFixed(2)}</span></div>
                <div class="detail-row"><span class="detail-label">Data Solicita√ß√£o</span><span class="detail-value">${data}</span></div>
                <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value"><span class="badge-status badge-${vendaSelecionada.status === 'aprovado' ? 'aprovado' : vendaSelecionada.status === 'rejeitado' ? 'rejeitado' : 'pendente'}">${vendaSelecionada.status || 'pendente'}</span></span></div>
            `;

            document.getElementById('modalPixKey').textContent = vendaSelecionada.chavePix || 'N√£o informado';

            // Mostrar/ocultar bot√µes
            const actions = document.getElementById('modalActions');
            actions.style.display = vendaSelecionada.status === 'pendente' ? 'flex' : 'none';

            document.getElementById('modalDetalhes').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modalDetalhes').classList.remove('active');
            vendaSelecionada = null;
        }

        function copiarPix() {
            const pix = document.getElementById('modalPixKey').textContent;
            copiarTexto(pix);
        }

        function copiarTexto(texto) {
            if (!texto || texto === '‚Äî' || texto === 'N√£o informado') return;
            navigator.clipboard.writeText(texto).then(() => showToast('üìã Copiado!'));
        }

        // ===================================
        // APROVAR VENDA (via modal)
        // ===================================
        async function aprovarVenda() {
            if (!vendaSelecionada) return;
            const valor = (vendaSelecionada.valorTotal || (vendaSelecionada.creditos || 0) * 0.40);

            if (!confirm(`Confirma que j√° fez o PIX de R$ ${valor.toFixed(2)} para ${vendaSelecionada.usuarioNome}?`)) return;

            try {
                await db.collection('vendas_creditos').doc(vendaSelecionada.id).update({
                    status: 'aprovado',
                    dataProcessamento: firebase.firestore.FieldValue.serverTimestamp(),
                    processadoPor: auth.currentUser.uid
                });

                await db.collection('usuarios').doc(vendaSelecionada.usuarioId).update({
                    creditosBloqueados: firebase.firestore.FieldValue.increment(-(vendaSelecionada.creditos || 0))
                });

                await db.collection('transacoes').add({
                    tipo: 'venda_creditos',
                    usuarioId: vendaSelecionada.usuarioId,
                    creditos: -(vendaSelecionada.creditos || 0),
                    valor: valor,
                    status: 'aprovado',
                    vendaId: vendaSelecionada.id,
                    data: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Notificar usu√°rio
                await db.collection('notificacoes').add({
                    para: vendaSelecionada.usuarioId,
                    tipo: 'saque_aprovado',
                    titulo: 'üí∞ Saque Aprovado!',
                    mensagem: `Seu saque de ${vendaSelecionada.creditos} cr√©ditos (R$ ${valor.toFixed(2)}) foi aprovado!`,
                    lida: false,
                    data: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('‚úÖ Saque aprovado com sucesso!');
                fecharModal();
                carregarVendas();
            } catch (e) {
                console.error('Erro ao aprovar:', e);
                showToast('‚ùå Erro ao aprovar');
            }
        }

        // ===================================
        // REJEITAR VENDA
        // ===================================
        async function rejeitarVenda() {
            if (!vendaSelecionada) return;
            const motivo = prompt('Motivo da rejei√ß√£o (opcional):');
            if (motivo === null) return;

            try {
                await db.collection('vendas_creditos').doc(vendaSelecionada.id).update({
                    status: 'rejeitado',
                    dataProcessamento: firebase.firestore.FieldValue.serverTimestamp(),
                    processadoPor: auth.currentUser.uid,
                    observacao: motivo || 'Rejeitado pelo administrador'
                });

                // Devolver cr√©ditos
                await db.collection('usuarios').doc(vendaSelecionada.usuarioId).update({
                    creditos: firebase.firestore.FieldValue.increment(vendaSelecionada.creditos || 0),
                    creditosBloqueados: firebase.firestore.FieldValue.increment(-(vendaSelecionada.creditos || 0))
                });

                // Notificar
                await db.collection('notificacoes').add({
                    para: vendaSelecionada.usuarioId,
                    tipo: 'saque_rejeitado',
                    titulo: '‚ùå Saque Rejeitado',
                    mensagem: motivo || 'Seu saque foi rejeitado. Cr√©ditos devolvidos.',
                    lida: false,
                    data: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast('Saque rejeitado. Cr√©ditos devolvidos.');
                fecharModal();
                carregarVendas();
            } catch (e) {
                console.error('Erro ao rejeitar:', e);
                showToast('‚ùå Erro ao rejeitar');
            }
        }

        async function rejeitarRapido(vendaId) {
            vendaSelecionada = vendasData.find(v => v.id === vendaId);
            if (!vendaSelecionada) return;
            await rejeitarVenda();
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') fecharModal();
        });

        console.log('‚úÖ Saques Yellup Admin v3.0');
    </script>
</body>
</html>
