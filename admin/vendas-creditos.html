<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendas de CrÃ©ditos - Admin Yellup</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      max-width: 1200px;
      margin: 0 auto 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo {
      font-size: 1.8em;
      font-weight: 800;
      background: linear-gradient(135deg, #ffb547 0%, #ff8c42 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 800;
      color: #ffb547;
    }

    .stat-value.green { color: #10b981; }
    .stat-value.yellow { color: #f59e0b; }
    .stat-value.red { color: #ef4444; }

    .stat-label {
      color: #a9b5c6;
      font-size: 0.9em;
      margin-top: 5px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #a9b5c6;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .tab-btn:hover {
      border-color: rgba(255, 181, 71, 0.5);
    }

    .tab-btn.active {
      border-color: #ffb547;
      background: rgba(255, 181, 71, 0.1);
      color: #ffb547;
    }

    /* Table */
    .table-container {
      background: linear-gradient(135deg, rgba(30, 41, 54, 0.9) 0%, rgba(24, 34, 46, 0.9) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 150px;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      font-weight: 600;
      color: #a9b5c6;
      font-size: 0.85em;
    }

    .table-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 150px;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      align-items: center;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
    }

    .user-email {
      font-size: 0.8em;
      color: #a9b5c6;
    }

    .creditos {
      font-weight: 700;
      color: #ffb547;
    }

    .valor {
      font-weight: 700;
      color: #10b981;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .status-pendente {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .status-aprovado {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-rejeitado {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn-action {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8em;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-aprovar {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.5);
    }

    .btn-aprovar:hover {
      background: rgba(16, 185, 129, 0.3);
    }

    .btn-rejeitar {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .btn-rejeitar:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .btn-detalhes {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.5);
    }

    .btn-detalhes:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #a9b5c6;
    }

    .empty-state h3 {
      margin-bottom: 10px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 1.3em;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: #a9b5c6;
      font-size: 1.5em;
      cursor: pointer;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: #a9b5c6;
    }

    .detail-value {
      font-weight: 600;
    }

    .detail-value.highlight {
      color: #10b981;
    }

    .pix-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }

    .pix-box label {
      display: block;
      color: #a9b5c6;
      font-size: 0.85em;
      margin-bottom: 8px;
    }

    .pix-key {
      font-size: 1.1em;
      font-weight: 700;
      color: #ffb547;
      word-break: break-all;
    }

    .btn-copy {
      margin-top: 10px;
      padding: 8px 20px;
      background: linear-gradient(135deg, #ffb547, #ff8c42);
      border: none;
      border-radius: 8px;
      color: #0e141b;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    .modal-actions .btn {
      flex: 1;
      padding: 15px;
      font-size: 1em;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
    }

    .btn-reject {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #fff;
    }

    .btn-cancel {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #1e293b, #334155);
      color: #fff;
      padding: 15px 25px;
      border-radius: 12px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10000;
      border: 1px solid rgba(255, 181, 71, 0.3);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .table-header, .table-row {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .table-header {
        display: none;
      }

      .table-row {
        padding: 20px;
      }

      .table-row > div::before {
        content: attr(data-label);
        font-weight: 600;
        color: #a9b5c6;
        display: block;
        margin-bottom: 5px;
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">âš½ Yellup Admin</div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">â† Dashboard</button>
      <button class="btn btn-secondary" onclick="carregarVendas()">ğŸ”„ Atualizar</button>
    </div>
  </div>

  <div class="container">
    
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value yellow" id="statPendentes">0</div>
        <div class="stat-label">â³ Pendentes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="statAprovados">0</div>
        <div class="stat-label">âœ… Aprovados (mÃªs)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statCreditosPendentes">0</div>
        <div class="stat-label">ğŸ’ CrÃ©ditos Pendentes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="statValorPendente">R$ 0</div>
        <div class="stat-label">ğŸ’° Valor a Pagar</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="filtrarPor('pendente')">â³ Pendentes</button>
      <button class="tab-btn" onclick="filtrarPor('aprovado')">âœ… Aprovados</button>
      <button class="tab-btn" onclick="filtrarPor('rejeitado')">âŒ Rejeitados</button>
      <button class="tab-btn" onclick="filtrarPor('todos')">ğŸ“‹ Todos</button>
    </div>

    <!-- Tabela -->
    <div class="table-container">
      <div class="table-header">
        <div>UsuÃ¡rio</div>
        <div>CrÃ©ditos</div>
        <div>Valor</div>
        <div>Data</div>
        <div>Status</div>
        <div>AÃ§Ãµes</div>
      </div>
      <div id="tableBody">
        <div class="empty-state">
          <h3>Carregando...</h3>
          <p>Buscando solicitaÃ§Ãµes de venda</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal de Detalhes -->
  <div class="modal-overlay" id="modalDetalhes">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“‹ Detalhes da Venda</div>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      
      <div id="modalBody">
        <!-- Preenchido via JS -->
      </div>

      <div class="pix-box">
        <label>Chave PIX do UsuÃ¡rio</label>
        <div class="pix-key" id="modalPixKey">-</div>
        <button class="btn-copy" onclick="copiarPix()">ğŸ“‹ Copiar Chave</button>
      </div>

      <div class="modal-actions" id="modalActions">
        <button class="btn btn-confirm" onclick="aprovarVenda()">âœ… Confirmar Pagamento</button>
        <button class="btn btn-reject" onclick="rejeitarVenda()">âŒ Rejeitar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.appspot.com",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let vendasData = [];
    let filtroAtual = 'pendente';
    let vendaSelecionada = null;

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Verificar autenticaÃ§Ã£o admin
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (!userDoc.exists || !userDoc.data().isAdmin) {
          window.location.href = 'login.html';
          return;
        }

        carregarVendas();
      } catch (error) {
        console.error("Erro:", error);
        window.location.href = 'login.html';
      }
    });

    async function carregarVendas() {
      try {
        const snapshot = await db.collection('vendas_creditos')
          .orderBy('dataSolicitacao', 'desc')
          .limit(100)
          .get();

        vendasData = [];
        let pendentes = 0;
        let aprovados = 0;
        let creditosPendentes = 0;
        let valorPendente = 0;

        snapshot.forEach(doc => {
          const venda = { id: doc.id, ...doc.data() };
          vendasData.push(venda);

          if (venda.status === 'pendente') {
            pendentes++;
            creditosPendentes += venda.creditos;
            valorPendente += venda.valorTotal;
          } else if (venda.status === 'aprovado') {
            // Verificar se Ã© do mÃªs atual
            const dataVenda = venda.dataProcessamento?.toDate();
            if (dataVenda) {
              const mesAtual = new Date().getMonth();
              if (dataVenda.getMonth() === mesAtual) {
                aprovados++;
              }
            }
          }
        });

        document.getElementById('statPendentes').textContent = pendentes;
        document.getElementById('statAprovados').textContent = aprovados;
        document.getElementById('statCreditosPendentes').textContent = creditosPendentes.toLocaleString('pt-BR');
        document.getElementById('statValorPendente').textContent = `R$ ${valorPendente.toFixed(2).replace('.', ',')}`;

        renderizarTabela();

      } catch (error) {
        console.error("Erro ao carregar vendas:", error);
        showToast('âŒ Erro ao carregar dados');
      }
    }

    function filtrarPor(status) {
      filtroAtual = status;
      
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderizarTabela();
    }

    function renderizarTabela() {
      const container = document.getElementById('tableBody');
      
      let vendasFiltradas = vendasData;
      if (filtroAtual !== 'todos') {
        vendasFiltradas = vendasData.filter(v => v.status === filtroAtual);
      }

      if (vendasFiltradas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Nenhuma solicitaÃ§Ã£o</h3>
            <p>NÃ£o hÃ¡ solicitaÃ§Ãµes ${filtroAtual === 'todos' ? '' : filtroAtual + 's'}</p>
          </div>
        `;
        return;
      }

      let html = '';
      vendasFiltradas.forEach(venda => {
        const data = venda.dataSolicitacao?.toDate ? 
          venda.dataSolicitacao.toDate().toLocaleDateString('pt-BR') : '-';

        let statusClass = 'status-pendente';
        let statusText = 'â³ Pendente';
        
        if (venda.status === 'aprovado') {
          statusClass = 'status-aprovado';
          statusText = 'âœ… Pago';
        } else if (venda.status === 'rejeitado') {
          statusClass = 'status-rejeitado';
          statusText = 'âŒ Rejeitado';
        }

        const acoesPendente = `
          <button class="btn-action btn-detalhes" onclick="abrirDetalhes('${venda.id}')">ğŸ‘ï¸</button>
          <button class="btn-action btn-aprovar" onclick="aprovarRapido('${venda.id}')">âœ…</button>
          <button class="btn-action btn-rejeitar" onclick="rejeitarRapido('${venda.id}')">âŒ</button>
        `;

        const acoesOutros = `
          <button class="btn-action btn-detalhes" onclick="abrirDetalhes('${venda.id}')">ğŸ‘ï¸ Ver</button>
        `;

        html += `
          <div class="table-row">
            <div class="user-info" data-label="UsuÃ¡rio">
              <span class="user-name">${venda.usuarioNome || 'UsuÃ¡rio'}</span>
              <span class="user-email">${venda.usuarioEmail || '-'}</span>
            </div>
            <div class="creditos" data-label="CrÃ©ditos">ğŸ’ ${venda.creditos.toLocaleString('pt-BR')}</div>
            <div class="valor" data-label="Valor">R$ ${venda.valorTotal.toFixed(2).replace('.', ',')}</div>
            <div data-label="Data">${data}</div>
            <div data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></div>
            <div class="actions" data-label="AÃ§Ãµes">
              ${venda.status === 'pendente' ? acoesPendente : acoesOutros}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function abrirDetalhes(vendaId) {
      vendaSelecionada = vendasData.find(v => v.id === vendaId);
      if (!vendaSelecionada) return;

      const data = vendaSelecionada.dataSolicitacao?.toDate ? 
        vendaSelecionada.dataSolicitacao.toDate().toLocaleString('pt-BR') : '-';

      document.getElementById('modalBody').innerHTML = `
        <div class="detail-row">
          <span class="detail-label">UsuÃ¡rio</span>
          <span class="detail-value">${vendaSelecionada.usuarioNome || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Email</span>
          <span class="detail-value">${vendaSelecionada.usuarioEmail || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">CPF</span>
          <span class="detail-value">${vendaSelecionada.cpf || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">CrÃ©ditos</span>
          <span class="detail-value">ğŸ’ ${vendaSelecionada.creditos.toLocaleString('pt-BR')}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Valor Total</span>
          <span class="detail-value highlight">R$ ${vendaSelecionada.valorTotal.toFixed(2).replace('.', ',')}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Data SolicitaÃ§Ã£o</span>
          <span class="detail-value">${data}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="detail-value">${vendaSelecionada.status}</span>
        </div>
      `;

      document.getElementById('modalPixKey').textContent = vendaSelecionada.chavePix || 'NÃ£o informado';

      // Mostrar/ocultar botÃµes de aÃ§Ã£o
      const modalActions = document.getElementById('modalActions');
      if (vendaSelecionada.status === 'pendente') {
        modalActions.style.display = 'flex';
      } else {
        modalActions.style.display = 'none';
      }

      document.getElementById('modalDetalhes').classList.add('active');
    }

    function fecharModal() {
      document.getElementById('modalDetalhes').classList.remove('active');
      vendaSelecionada = null;
    }

    function copiarPix() {
      const pixKey = document.getElementById('modalPixKey').textContent;
      navigator.clipboard.writeText(pixKey);
      showToast('ğŸ“‹ Chave PIX copiada!');
    }

    async function aprovarVenda() {
      if (!vendaSelecionada) return;
      
      if (!confirm(`Confirma que vocÃª jÃ¡ fez o PIX de R$ ${vendaSelecionada.valorTotal.toFixed(2).replace('.', ',')} para ${vendaSelecionada.usuarioNome}?`)) {
        return;
      }

      try {
        // Atualizar status da venda
        await db.collection('vendas_creditos').doc(vendaSelecionada.id).update({
          status: 'aprovado',
          dataProcessamento: firebase.firestore.FieldValue.serverTimestamp(),
          processadoPor: auth.currentUser.uid
        });

        // Remover crÃ©ditos bloqueados do usuÃ¡rio
        await db.collection('usuarios').doc(vendaSelecionada.usuarioId).update({
          creditosBloqueados: firebase.firestore.FieldValue.increment(-vendaSelecionada.creditos)
        });

        // Registrar transaÃ§Ã£o
        await db.collection('transacoes').add({
          tipo: 'venda_creditos',
          usuarioId: vendaSelecionada.usuarioId,
          creditos: -vendaSelecionada.creditos,
          valor: vendaSelecionada.valorTotal,
          status: 'aprovado',
          vendaId: vendaSelecionada.id,
          data: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('âœ… Venda aprovada com sucesso!');
        fecharModal();
        carregarVendas();

      } catch (error) {
        console.error("Erro ao aprovar:", error);
        showToast('âŒ Erro ao aprovar venda');
      }
    }

    async function rejeitarVenda() {
      if (!vendaSelecionada) return;
      
      const motivo = prompt('Motivo da rejeiÃ§Ã£o (opcional):');
      
      try {
        // Atualizar status da venda
        await db.collection('vendas_creditos').doc(vendaSelecionada.id).update({
          status: 'rejeitado',
          dataProcessamento: firebase.firestore.FieldValue.serverTimestamp(),
          processadoPor: auth.currentUser.uid,
          observacao: motivo || 'Rejeitado pelo administrador'
        });

        // Devolver crÃ©ditos ao usuÃ¡rio
        await db.collection('usuarios').doc(vendaSelecionada.usuarioId).update({
          creditos: firebase.firestore.FieldValue.increment(vendaSelecionada.creditos),
          creditosBloqueados: firebase.firestore.FieldValue.increment(-vendaSelecionada.creditos)
        });

        showToast('âŒ Venda rejeitada. CrÃ©ditos devolvidos.');
        fecharModal();
        carregarVendas();

      } catch (error) {
        console.error("Erro ao rejeitar:", error);
        showToast('âŒ Erro ao rejeitar venda');
      }
    }

    async function aprovarRapido(vendaId) {
      vendaSelecionada = vendasData.find(v => v.id === vendaId);
      if (!vendaSelecionada) return;
      
      abrirDetalhes(vendaId);
    }

    async function rejeitarRapido(vendaId) {
      vendaSelecionada = vendasData.find(v => v.id === vendaId);
      if (!vendaSelecionada) return;
      
      await rejeitarVenda();
    }

    console.log("âœ… Admin Vendas v1.0");
  </script>

</body>
</html>
