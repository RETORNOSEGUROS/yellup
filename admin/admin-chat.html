<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat â€” Yellup Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root{--bg-primary:#0c0e14;--bg-secondary:#12141c;--bg-card:#181a24;--bg-card-hover:#1e2030;--bg-sidebar:#10121a;--border:#1e2030;--border-light:#282a3a;--text-primary:#e8e9ed;--text-secondary:#8b8d9a;--text-muted:#5c5e6e;--accent:#f0b429;--accent-dim:rgba(240,180,41,.12);--green:#34d399;--green-dim:rgba(52,211,153,.12);--red:#f87171;--red-dim:rgba(248,113,113,.12);--blue:#60a5fa;--blue-dim:rgba(96,165,250,.12);--purple:#a78bfa;--purple-dim:rgba(167,139,250,.12);--orange:#fb923c;--orange-dim:rgba(251,146,60,.12);--sidebar-w:250px;--header-h:64px;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden;}
        .sidebar{position:fixed;left:0;top:0;width:var(--sidebar-w);height:100vh;background:var(--bg-sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:transform .3s ease;}
        .sidebar-brand{height:var(--header-h);display:flex;align-items:center;gap:10px;padding:0 20px;border-bottom:1px solid var(--border);flex-shrink:0;}
        .sidebar-brand .logo{width:32px;height:32px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#000;}
        .sidebar-brand h1{font-size:17px;font-weight:700;letter-spacing:-.3px;} .sidebar-brand h1 span{color:var(--text-muted);font-weight:500;font-size:12px;margin-left:6px;}
        .sidebar-nav{flex:1;overflow-y:auto;padding:12px 0;} .sidebar-nav::-webkit-scrollbar{width:0;}
        .nav-group{margin-bottom:8px;} .nav-group-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.2px;color:var(--text-muted);padding:12px 20px 6px;}
        .nav-item{display:flex;align-items:center;gap:10px;padding:8px 16px;margin:1px 8px;border-radius:8px;color:var(--text-secondary);text-decoration:none;font-size:13px;font-weight:500;transition:all .15s;cursor:pointer;}
        .nav-item:hover{background:var(--bg-card);color:var(--text-primary);} .nav-item.active{background:var(--accent-dim);color:var(--accent);}
        .nav-item .icon{width:20px;text-align:center;font-size:14px;flex-shrink:0;}
        .sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);flex-shrink:0;}
        .sidebar-footer .admin-box{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;} .admin-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#e09800);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#000;}
        .admin-info-text{flex:1;} .admin-info-text .name{font-size:13px;font-weight:600;} .admin-info-text .role{font-size:11px;color:var(--text-muted);}
        .btn-logout{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px;border-radius:6px;} .btn-logout:hover{color:var(--red);background:var(--red-dim);}
        .main{margin-left:var(--sidebar-w);min-height:100vh;display:flex;flex-direction:column;}
        .header{height:var(--header-h);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 32px;background:var(--bg-primary);position:sticky;top:0;z-index:50;flex-shrink:0;}
        .header-left h2{font-size:16px;font-weight:600;} .header-left p{font-size:12px;color:var(--text-muted);margin-top:1px;}

        /* Chat layout */
        .chat-container{flex:1;display:flex;flex-direction:column;padding:20px 32px;gap:16px;max-height:calc(100vh - var(--header-h));overflow:hidden;}
        .chat-stats{display:flex;gap:16px;flex-shrink:0;}
        .mini-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;flex:1;}
        .mini-stat .ms-icon{font-size:18px;} .mini-stat .ms-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;} .mini-stat .ms-label{font-size:11px;color:var(--text-muted);}

        .chat-tabs{display:flex;gap:4px;flex-shrink:0;}
        .chat-tab{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;color:var(--text-muted);background:var(--bg-card);border:1px solid var(--border);transition:all .15s;font-family:inherit;}
        .chat-tab:hover{color:var(--text-primary);} .chat-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}

        .chat-feed{flex:1;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow-y:auto;display:flex;flex-direction:column;}
        .chat-feed::-webkit-scrollbar{width:4px;} .chat-feed::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

        .msg{display:flex;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);transition:background .1s;align-items:flex-start;}
        .msg:hover{background:var(--bg-card-hover);}
        .msg-avatar{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;flex-shrink:0;}
        .msg-body{flex:1;min-width:0;}
        .msg-head{display:flex;align-items:center;gap:8px;margin-bottom:2px;}
        .msg-name{font-size:12px;font-weight:600;color:var(--text-primary);}
        .msg-time{font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;}
        .msg-badge{font-size:9px;font-weight:600;padding:1px 6px;border-radius:4px;}
        .msg-text{font-size:13px;color:var(--text-secondary);line-height:1.5;word-break:break-word;}
        .msg-actions{display:flex;gap:4px;flex-shrink:0;opacity:0;transition:opacity .15s;}
        .msg:hover .msg-actions{opacity:1;}
        .msg-btn{background:none;border:1px solid var(--border);color:var(--text-muted);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
        .msg-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim);}
        .msg-btn.warn:hover{border-color:var(--orange);color:var(--orange);background:var(--orange-dim);}
        .msg-deleted{opacity:.4;text-decoration:line-through;}

        .refresh-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-right:6px;animation:pulse-dot 2s infinite;}
        @keyframes pulse-dot{0%,100%{opacity:1;}50%{opacity:.3;}}
        .btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px;} .btn:hover{border-color:var(--accent);}
        .toast{position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);padding:12px 20px;border-radius:10px;font-size:13px;z-index:300;transform:translateY(80px);opacity:0;transition:all .3s;} .toast.show{transform:translateY(0);opacity:1;}
        .empty-state{text-align:center;padding:40px;color:var(--text-muted);font-size:13px;margin:auto;}
        .mobile-toggle{display:none;position:fixed;top:16px;left:16px;z-index:200;width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);font-size:18px;cursor:pointer;align-items:center;justify-content:center;}
        .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;} .overlay.open{display:block;}
        @media(max-width:768px){.sidebar{transform:translateX(-100%);} .sidebar.open{transform:translateX(0);} .overlay.open{display:block;} .mobile-toggle{display:flex;} .main{margin-left:0;} .header{padding:0 16px 0 64px;} .chat-container{padding:12px;} .chat-stats{flex-wrap:wrap;} .mini-stat{flex:none;width:calc(50% - 8px);}}
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">â˜°</button>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="toast" id="toast"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand"><div class="logo">Y</div><h1>Yellup <span>Admin</span></h1></div>
        <nav class="sidebar-nav">
            <div class="nav-group"><div class="nav-group-title">VisÃ£o Geral</div><a href="dashboard.html" class="nav-item"><span class="icon">ğŸ“Š</span> Dashboard</a></div>
            <div class="nav-group"><div class="nav-group-title">ConteÃºdo</div><a href="jogos.html" class="nav-item"><span class="icon">ğŸ®</span> Jogos</a><a href="perguntas.html" class="nav-item"><span class="icon">â“</span> Perguntas</a><a href="importar-perguntas.html" class="nav-item"><span class="icon">ğŸ“¥</span> Importar</a><a href="gerar-perguntas.html" class="nav-item"><span class="icon">ğŸ¤–</span> Gerar com IA</a><a href="times.html" class="nav-item"><span class="icon">âš½</span> Times</a></div>
            <div class="nav-group"><div class="nav-group-title">Jogadores</div><a href="usuarios.html" class="nav-item"><span class="icon">ğŸ‘¥</span> UsuÃ¡rios</a><a href="ranking.html" class="nav-item"><span class="icon">ğŸ†</span> Rankings</a><a href="admin-noticias.html" class="nav-item"><span class="icon">ğŸ“°</span> NotÃ­cias</a></div>
            <div class="nav-group"><div class="nav-group-title">CompetiÃ§Ãµes</div><a href="torneios.html" class="nav-item"><span class="icon">ğŸ…</span> Torneios</a><a href="admin-pvp.html" class="nav-item"><span class="icon">âš”ï¸</span> PvP Center</a></div>
            <div class="nav-group"><div class="nav-group-title">Financeiro</div><a href="financeiro.html" class="nav-item"><span class="icon">ğŸ’°</span> Resumo</a><a href="creditar-manual.html" class="nav-item"><span class="icon">â•</span> Creditar Manual</a><a href="transacoes.html" class="nav-item"><span class="icon">ğŸ’³</span> TransaÃ§Ãµes</a><a href="premiacao.html" class="nav-item"><span class="icon">ğŸ</span> PremiaÃ§Ã£o</a><a href="admin-passes.html" class="nav-item"><span class="icon">ğŸ«</span> Passes</a><a href="indicacoes.html" class="nav-item"><span class="icon">ğŸ”—</span> IndicaÃ§Ãµes</a></div>
            <div class="nav-group"><div class="nav-group-title">Comunidade</div><a href="admin-chat.html" class="nav-item active"><span class="icon">ğŸ’¬</span> Chat</a><a href="admin-logs.html" class="nav-item"><span class="icon">ğŸ“‹</span> Logs</a></div>
            <div class="nav-group"><div class="nav-group-title">Sistema</div><a href="bolsa-admin.html" class="nav-item"><span class="icon">ğŸ“ˆ</span> Bolsa</a><a href="configuracoes.html" class="nav-item"><span class="icon">âš™ï¸</span> Config</a><a href="suporte-admin.html" class="nav-item"><span class="icon">ğŸ§</span> Suporte</a></div>
        </nav>
        <div class="sidebar-footer"><div class="admin-box"><div class="admin-avatar">A</div><div class="admin-info-text"><div class="name" id="adminName">Admin</div><div class="role">Administrador</div></div><button class="btn-logout" onclick="sair()" title="Sair">â»</button></div></div>
    </aside>

    <div class="main">
        <header class="header">
            <div class="header-left"><h2>ğŸ’¬ ModeraÃ§Ã£o de Chat</h2><p><span class="refresh-dot"></span>Tempo real via onSnapshot</p></div>
            <div><button class="btn" id="btnScroll" onclick="scrollBottom()">â†“ Ãšltimas</button></div>
        </header>

        <div class="chat-container">
            <div class="chat-stats">
                <div class="mini-stat"><span class="ms-icon">ğŸ’¬</span><div><div class="ms-val" id="sMsgHoje">â€”</div><div class="ms-label">Mensagens hoje</div></div></div>
                <div class="mini-stat"><span class="ms-icon">ğŸ‘¥</span><div><div class="ms-val" id="sUsuarios">â€”</div><div class="ms-label">UsuÃ¡rios ativos no chat</div></div></div>
                <div class="mini-stat"><span class="ms-icon">ğŸ—‘ï¸</span><div><div class="ms-val" id="sDeletadas">0</div><div class="ms-label">Deletadas hoje</div></div></div>
                <div class="mini-stat"><span class="ms-icon">ğŸš¨</span><div><div class="ms-val" id="sSpam">0</div><div class="ms-label">Spam detectado</div></div></div>
            </div>

            <div class="chat-tabs">
                <button class="chat-tab active" onclick="trocarChat('global')">ğŸ’¬ Chat Global</button>
                <button class="chat-tab" onclick="trocarChat('jogo')">ğŸ® Chat de Jogos</button>
            </div>

            <div class="chat-feed" id="chatFeed">
                <div class="empty-state">ğŸ’¬ Conectando ao chat...</div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig={apiKey:"AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",authDomain:"painel-yellup.firebaseapp.com",projectId:"painel-yellup",storageBucket:"painel-yellup.appspot.com",messagingSenderId:"608347210297",appId:"1:608347210297:web:75092713724e617c7203e8"};
        firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore(), auth=firebase.auth();

        let chatAtual='global', unsubscribe=null, deletadasHoje=0;

        auth.onAuthStateChanged(u=>{
            if(!u){window.location.href='login.html';return;}
            document.getElementById('adminName').textContent=u.email.split('@')[0];
            iniciarChat();
        });

        function trocarChat(tipo){
            chatAtual=tipo;
            document.querySelectorAll('.chat-tab').forEach((t,i)=>t.classList.toggle('active',['global','jogo'][i]===tipo));
            iniciarChat();
        }

        function iniciarChat(){
            if(unsubscribe) unsubscribe();
            const feed=document.getElementById('chatFeed');
            feed.innerHTML='<div class="empty-state">ğŸ’¬ Conectando...</div>';

            const collection=chatAtual==='global'?'chat':'chats_jogo';
            const query=db.collection(collection).orderBy('data','desc').limit(100);

            unsubscribe=query.onSnapshot(snap=>{
                const msgs=snap.docs.map(d=>({id:d.id,...d.data()})).reverse();
                renderMensagens(msgs);
                calcularStats(msgs);
            },err=>{
                console.error('Chat listener:',err);
                feed.innerHTML='<div class="empty-state">âŒ Erro ao conectar: '+esc(err.message)+'</div>';
            });
        }

        function renderMensagens(msgs){
            const feed=document.getElementById('chatFeed');
            if(!msgs.length){feed.innerHTML='<div class="empty-state">ğŸ’¬ Nenhuma mensagem ainda</div>';return;}

            const autoScroll=feed.scrollTop>=feed.scrollHeight-feed.clientHeight-50;

            feed.innerHTML=msgs.map(m=>{
                const dt=m.data?.toDate?m.data.toDate():new Date();
                const hora=dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
                const nome=esc(m.nomeUsuario||m.usuario||m.nome||'AnÃ´nimo');
                const texto=esc(m.mensagem||m.texto||m.message||'');
                const ini=nome.charAt(0).toUpperCase();
                const isDeleted=m.deletada||m.removida;
                const colors=['var(--blue)','var(--green)','var(--purple)','var(--accent)','var(--orange)','var(--pink)'];
                const cor=colors[nome.length%colors.length];
                const corDim=cor.replace(')',',0.12)').replace('var(','rgba(').replace('--','');
                return `<div class="msg ${isDeleted?'msg-deleted':''}">
                    <div class="msg-avatar" style="background:${cor}20;color:${cor}">${ini}</div>
                    <div class="msg-body">
                        <div class="msg-head">
                            <span class="msg-name" style="color:${cor}">${nome}</span>
                            <span class="msg-time">${hora}</span>
                            ${m.jogoId?'<span class="msg-badge" style="color:var(--blue);background:var(--blue-dim)">ğŸ® Jogo</span>':''}
                        </div>
                        <div class="msg-text">${texto}</div>
                    </div>
                    <div class="msg-actions">
                        ${!isDeleted?`<button class="msg-btn" onclick="deletarMsg('${m.id}')" title="Deletar">ğŸ—‘ï¸</button>`:''}
                        <button class="msg-btn warn" onclick="verUsuario('${m.odId||m.usuarioId||m.odid||''}')" title="Ver usuÃ¡rio">ğŸ‘¤</button>
                    </div>
                </div>`;
            }).join('');

            if(autoScroll) feed.scrollTop=feed.scrollHeight;
        }

        function calcularStats(msgs){
            const hoje=new Date();hoje.setHours(0,0,0,0);
            const msgsHoje=msgs.filter(m=>{const d=m.data?.toDate?m.data.toDate():null;return d&&d>=hoje;});
            const usuarios=new Set(msgsHoje.map(m=>m.odId||m.usuarioId||m.nome).filter(Boolean));
            document.getElementById('sMsgHoje').textContent=msgsHoje.length;
            document.getElementById('sUsuarios').textContent=usuarios.size;

            // Detect spam patterns (same user >5 msgs in 60s)
            let spam=0;
            const byUser={};
            msgsHoje.forEach(m=>{
                const uid=m.odId||m.usuarioId||'';
                if(!uid)return;
                if(!byUser[uid])byUser[uid]=[];
                byUser[uid].push(m.data?.toDate?m.data.toDate().getTime():0);
            });
            Object.values(byUser).forEach(times=>{
                for(let i=0;i<times.length-4;i++){
                    if(times[i+4]-times[i]<60000)spam++;
                }
            });
            document.getElementById('sSpam').textContent=spam;
        }

        async function deletarMsg(id){
            const collection=chatAtual==='global'?'chat':'chats_jogo';
            try{
                await db.collection(collection).doc(id).update({deletada:true,removidaPor:'admin',removidaEm:firebase.firestore.FieldValue.serverTimestamp()});
                deletadasHoje++;
                document.getElementById('sDeletadas').textContent=deletadasHoje;
                showToast('ğŸ—‘ï¸ Mensagem removida');
            }catch(e){
                // If update fails, try delete
                try{
                    await db.collection(collection).doc(id).delete();
                    deletadasHoje++;
                    document.getElementById('sDeletadas').textContent=deletadasHoje;
                    showToast('ğŸ—‘ï¸ Mensagem deletada');
                }catch(e2){showToast('âŒ Erro: '+e2.message);}
            }
        }

        function verUsuario(uid){
            if(!uid){showToast('UID nÃ£o disponÃ­vel');return;}
            window.open('usuarios.html?busca='+uid,'_blank');
        }

        function scrollBottom(){document.getElementById('chatFeed').scrollTop=999999;}
        function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
        function sair(){auth.signOut().then(()=>window.location.href='login.html');}
        function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('open');}
    </script>
</body>
</html>
