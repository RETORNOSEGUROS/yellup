<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Bolsa - Yellup Stock</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0e141b 0%, #1a2332 100%);
      color: #e7eef7;
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; color: #ffb547; font-size: 2em; }
    .subtitle { text-align: center; color: #a9b5c6; margin-bottom: 40px; }
    
    .card {
      background: rgba(35, 45, 63, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }
    .card h3 { color: #ffb547; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    
    .info-box {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #a9b5c6; }
    .info-value { font-weight: 600; color: #ffb547; }
    
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-primary { background: linear-gradient(135deg, #ffb547, #ff8c42); color: #0e141b; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    
    .progress {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      height: 30px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #10b981, #059669);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .log {
      background: #0d1117;
      border-radius: 10px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      font-size: 0.85em;
    }
    .log-entry { padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    .log-warning { color: #f59e0b; }
    
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .warning-box h4 { color: #f59e0b; margin-bottom: 10px; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
    
    .stat-mini {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-mini-value { font-size: 1.8em; font-weight: 800; color: #ffb547; }
    .stat-mini-label { font-size: 0.8em; color: #a9b5c6; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìà Admin - Yellup Stock</h1>
    <p class="subtitle">Gerenciamento da Bolsa de Valores de Times</p>

    <!-- Status -->
    <div class="card">
      <h3>üìä Status da Bolsa</h3>
      <div class="grid-2">
        <div class="stat-mini">
          <div class="stat-mini-value" id="totalTimes">0</div>
          <div class="stat-mini-label">Times</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-value" id="cotasCriadas">0</div>
          <div class="stat-mini-label">Cotas Criadas</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-value" id="totalTransacoes">0</div>
          <div class="stat-mini-label">Transa√ß√µes</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-value" id="volumeTotal">0</div>
          <div class="stat-mini-label">Volume Total (cr)</div>
        </div>
      </div>
    </div>

    <!-- Inicializa√ß√£o -->
    <div class="card">
      <h3>üöÄ Inicializa√ß√£o</h3>
      <div class="warning-box">
        <h4>‚ö†Ô∏è Aten√ß√£o</h4>
        <p>A inicializa√ß√£o cria <strong>1.000 cotas</strong> de cada time para o usu√°rio <strong>guruh</strong>. Execute apenas uma vez!</p>
      </div>
      <button class="btn btn-success" id="btnInicializar" onclick="inicializarBolsa()">
        üìà Inicializar Bolsa (Criar Cotas)
      </button>
      <button class="btn btn-primary" onclick="verificarStatus()">
        üîç Verificar Status
      </button>
    </div>

    <!-- Atualiza√ß√£o de Pre√ßos -->
    <div class="card">
      <h3>üíπ Atualizar Cota√ß√µes</h3>
      <p style="color: #a9b5c6; margin-bottom: 15px;">
        Recalcula os pre√ßos de todos os times baseado nas m√©tricas dos jogos finalizados.
      </p>
      <button class="btn btn-info" onclick="atualizarCotacoes()">
        üîÑ Recalcular Pre√ßos (Algoritmo)
      </button>
      <button class="btn btn-primary" onclick="atualizarPrecosMercado()">
        üìä Atualizar Pre√ßos de Mercado
      </button>
    </div>

    <!-- Dividendos -->
    <div class="card">
      <h3>üí∞ Dividendos</h3>
      <p style="color: #a9b5c6; margin-bottom: 15px;">
        Distribui 10% do valor arrecadado nos jogos finalizados para os donos de cotas.
      </p>
      <button class="btn btn-success" onclick="distribuirDividendos()">
        üíé Distribuir Dividendos Pendentes
      </button>
    </div>

    <!-- Progresso e Log -->
    <div class="card" id="progressCard" style="display: none;">
      <h3>‚è≥ Progresso</h3>
      <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
      </div>
      <div class="log" id="logContainer"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC5ZrkEy7KuCFJOtPvI7-P-JcA0MF4im5c",
      authDomain: "painel-yellup.firebaseapp.com",
      projectId: "painel-yellup",
      storageBucket: "painel-yellup.firebasestorage.app",
      messagingSenderId: "608347210297",
      appId: "1:608347210297:web:75092713724e617c7203e8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Constantes
    const DONO_INICIAL_ID = 'GfpBgfT9e8g5GaTQruvX6YcwtE23';
    const DONO_INICIAL_NOME = 'guruh';
    const COTAS_POR_TIME = 1000;
    const PRECO_INICIAL = 1.00;
    const PERCENTUAL_DIVIDENDOS = 10;

    // Pesos de valoriza√ß√£o
    const CONFIG = {
      porJogo: 0.5,
      porTorcedor: 0.05,
      porVitoriaTorcida: 2.0,
      porPonto: 0.005,
      porVitoriaPontuacao: 3.0,
      maxVariacao: 15,
      porDerrotaTorcida: 1.5,
      porDerrotaPontuacao: 2.0,
      pesoAjusteMercado: 0.5,
      maxAjusteMercado: 5
    };

    let allTimes = [];

    // Auth check
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('usuarios').doc(user.uid).get();
        if (userDoc.exists && userDoc.data().isAdmin) {
          await verificarStatus();
        } else {
          alert('Acesso negado!');
          window.location.href = '../painel.html';
        }
      } else {
        window.location.href = '../index.html';
      }
    });

    // ==================== VERIFICAR STATUS ====================
    async function verificarStatus() {
      showProgress();
      log('üîç Verificando status da bolsa...', 'info');

      try {
        // Times
        const timesSnap = await db.collection('times').get();
        allTimes = [];
        timesSnap.forEach(doc => allTimes.push({ id: doc.id, ...doc.data() }));
        document.getElementById('totalTimes').textContent = allTimes.length;
        log(`üìä ${allTimes.length} times encontrados`, 'success');

        // Cotas
        const cotasSnap = await db.collection('bolsa_cotas').get();
        document.getElementById('cotasCriadas').textContent = cotasSnap.size;
        log(`üí∞ ${cotasSnap.size} registros de cotas`, 'info');

        // Transa√ß√µes
        const transSnap = await db.collection('bolsa_transacoes').get();
        let volumeTotal = 0;
        transSnap.forEach(doc => volumeTotal += doc.data().valorTotal || 0);
        document.getElementById('totalTransacoes').textContent = transSnap.size;
        document.getElementById('volumeTotal').textContent = volumeTotal.toFixed(2);
        log(`üìà ${transSnap.size} transa√ß√µes (${volumeTotal.toFixed(2)} cr)`, 'info');

        log('‚úÖ Status verificado!', 'success');

      } catch (error) {
        console.error(error);
        log('‚ùå Erro: ' + error.message, 'error');
      }
    }

    // ==================== INICIALIZAR BOLSA ====================
    async function inicializarBolsa() {
      if (!confirm('Tem certeza? Isso criar√° cotas para TODOS os times.')) return;

      const btn = document.getElementById('btnInicializar');
      btn.disabled = true;
      showProgress();

      try {
        // Verificar cotas existentes
        const cotasExistentes = new Set();
        const cotasSnap = await db.collection('bolsa_cotas').get();
        cotasSnap.forEach(doc => cotasExistentes.add(doc.data().timeId));

        const timesParaCriar = allTimes.filter(t => !cotasExistentes.has(t.id));
        
        if (timesParaCriar.length === 0) {
          log('‚úÖ Todos os times j√° possuem cotas!', 'success');
          btn.disabled = false;
          return;
        }

        log(`üìù Criando cotas para ${timesParaCriar.length} times...`, 'info');

        // Processar em lotes
        const batchSize = 50;
        let processados = 0;

        for (let i = 0; i < timesParaCriar.length; i += batchSize) {
          const batch = db.batch();
          const lote = timesParaCriar.slice(i, i + batchSize);

          for (const time of lote) {
            // Criar cota
            const cotaRef = db.collection('bolsa_cotas').doc();
            batch.set(cotaRef, {
              timeId: time.id,
              timeNome: time.nome,
              userId: DONO_INICIAL_ID,
              usuarioNome: DONO_INICIAL_NOME,
              quantidade: COTAS_POR_TIME,
              precoMedioAquisicao: PRECO_INICIAL,
              dataAquisicao: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Criar m√©tricas iniciais
            const metricaRef = db.collection('bolsa_metricas_time').doc(time.id);
            batch.set(metricaRef, {
              timeId: time.id,
              timeNome: time.nome,
              precoAlgoritmo: PRECO_INICIAL,
              precoMercado: PRECO_INICIAL,
              totalJogos: 0,
              totalTorcedores: 0,
              totalPontuacao: 0,
              totalVitoriasTorcida: 0,
              totalVitoriasPontuacao: 0,
              totalDerrotasTorcida: 0,
              totalDerrotasPontuacao: 0,
              mediaDividendos: 0,
              variacaoDia: 0,
              ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          }

          await batch.commit();
          
          processados += lote.length;
          const pct = Math.round((processados / timesParaCriar.length) * 100);
          updateProgress(pct);
          log(`‚úÖ Lote ${Math.ceil((i + 1) / batchSize)}: ${lote.length} times`, 'success');
        }

        // Salvar config
        await db.collection('bolsa_config').doc('config').set({
          cotasPorTime: COTAS_POR_TIME,
          precoInicial: PRECO_INICIAL,
          percentualDividendos: PERCENTUAL_DIVIDENDOS,
          valorizacao: CONFIG,
          donoInicialId: DONO_INICIAL_ID,
          donoInicialNome: DONO_INICIAL_NOME,
          dataInicializacao: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        log('üéâ BOLSA INICIALIZADA COM SUCESSO!', 'success');
        await verificarStatus();

      } catch (error) {
        console.error(error);
        log('‚ùå Erro: ' + error.message, 'error');
      }

      btn.disabled = false;
    }

    // ==================== ATUALIZAR COTA√á√ïES ====================
    async function atualizarCotacoes() {
      showProgress();
      log('üíπ Atualizando cota√ß√µes...', 'info');

      try {
        // Buscar jogos finalizados
        const jogosSnap = await db.collection('jogos')
          .where('status', '==', 'finalizado')
          .get();

        log(`üìä ${jogosSnap.size} jogos finalizados encontrados`, 'info');

        // Agrupar m√©tricas por time
        const metricasPorTime = {};

        jogosSnap.forEach(doc => {
          const jogo = doc.data();
          const timeCasaId = jogo.timeCasaId;
          const timeForaId = jogo.timeForaId;
          const torcidaCasa = jogo.torcidaCasaCount || 0;
          const torcidaFora = jogo.torcidaForaCount || 0;

          // Inicializar se n√£o existe
          [timeCasaId, timeForaId].forEach(tid => {
            if (tid && !metricasPorTime[tid]) {
              metricasPorTime[tid] = {
                jogos: 0, torcedores: 0, pontos: 0,
                vitoriasTorcida: 0, vitoriasGols: 0,
                derrotasTorcida: 0, derrotasGols: 0
              };
            }
          });

          if (timeCasaId) {
            metricasPorTime[timeCasaId].jogos++;
            metricasPorTime[timeCasaId].torcedores += torcidaCasa;
            if (torcidaCasa > torcidaFora) metricasPorTime[timeCasaId].vitoriasTorcida++;
            if (torcidaCasa < torcidaFora) metricasPorTime[timeCasaId].derrotasTorcida++;
          }

          if (timeForaId) {
            metricasPorTime[timeForaId].jogos++;
            metricasPorTime[timeForaId].torcedores += torcidaFora;
            if (torcidaFora > torcidaCasa) metricasPorTime[timeForaId].vitoriasTorcida++;
            if (torcidaFora < torcidaCasa) metricasPorTime[timeForaId].derrotasTorcida++;
          }
        });

        // Buscar pontua√ß√µes dos usu√°rios
        const usuariosSnap = await db.collection('usuarios').get();
        usuariosSnap.forEach(doc => {
          const usuario = doc.data();
          const pontuacoes = usuario.pontuacoes || {};
          const torcidas = usuario.torcidas || {};

          Object.keys(pontuacoes).forEach(jogoId => {
            const timeId = torcidas[jogoId];
            if (timeId && metricasPorTime[timeId]) {
              metricasPorTime[timeId].pontos += pontuacoes[jogoId] || 0;
            }
          });
        });

        // Calcular novos pre√ßos
        let processados = 0;
        const totalTimes = Object.keys(metricasPorTime).length;

        for (const [timeId, m] of Object.entries(metricasPorTime)) {
          // Carregar m√©trica atual
          const metricaDoc = await db.collection('bolsa_metricas_time').doc(timeId).get();
          const metricaAtual = metricaDoc.exists ? metricaDoc.data() : { precoAlgoritmo: PRECO_INICIAL };
          const precoAtual = metricaAtual.precoAlgoritmo || PRECO_INICIAL;

          // Calcular varia√ß√£o
          let variacao = 0;
          variacao += m.jogos * CONFIG.porJogo;
          variacao += m.torcedores * CONFIG.porTorcedor;
          variacao += m.vitoriasTorcida * CONFIG.porVitoriaTorcida;
          variacao += m.pontos * CONFIG.porPonto;
          variacao -= m.derrotasTorcida * CONFIG.porDerrotaTorcida;

          // Limitar varia√ß√£o
          variacao = Math.max(-CONFIG.maxVariacao, Math.min(CONFIG.maxVariacao, variacao));

          // Novo pre√ßo
          const novoPreco = Math.max(0.01, precoAtual * (1 + variacao / 100));

          // Atualizar m√©tricas
          await db.collection('bolsa_metricas_time').doc(timeId).set({
            precoAlgoritmo: novoPreco,
            totalJogos: m.jogos,
            totalTorcedores: m.torcedores,
            totalPontuacao: m.pontos,
            totalVitoriasTorcida: m.vitoriasTorcida,
            totalDerrotasTorcida: m.derrotasTorcida,
            variacaoDia: variacao,
            ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          processados++;
          updateProgress(Math.round((processados / totalTimes) * 100));
        }

        log(`‚úÖ ${processados} times atualizados!`, 'success');

      } catch (error) {
        console.error(error);
        log('‚ùå Erro: ' + error.message, 'error');
      }
    }

    // ==================== ATUALIZAR PRE√áOS DE MERCADO ====================
    async function atualizarPrecosMercado() {
      showProgress();
      log('üìä Calculando pre√ßos de mercado...', 'info');

      try {
        // Buscar √∫ltimas transa√ß√µes por time
        const transSnap = await db.collection('bolsa_transacoes')
          .orderBy('dataTransacao', 'desc')
          .limit(1000)
          .get();

        const precosPorTime = {};

        transSnap.forEach(doc => {
          const t = doc.data();
          if (!precosPorTime[t.timeId]) {
            precosPorTime[t.timeId] = [];
          }
          precosPorTime[t.timeId].push(t.precoUnitario);
        });

        // Calcular m√©dia
        let atualizados = 0;
        for (const [timeId, precos] of Object.entries(precosPorTime)) {
          if (precos.length > 0) {
            const ultimos = precos.slice(0, 10); // √öltimas 10 transa√ß√µes
            const media = ultimos.reduce((a, b) => a + b, 0) / ultimos.length;

            await db.collection('bolsa_metricas_time').doc(timeId).set({
              precoMercado: media,
              volumeDia: precos.length
            }, { merge: true });

            atualizados++;
          }
        }

        log(`‚úÖ ${atualizados} times com pre√ßo de mercado atualizado`, 'success');

      } catch (error) {
        console.error(error);
        log('‚ùå Erro: ' + error.message, 'error');
      }
    }

    // ==================== DISTRIBUIR DIVIDENDOS ====================
    async function distribuirDividendos() {
      showProgress();
      log('üí∞ Calculando dividendos...', 'info');

      try {
        // Buscar jogos finalizados sem dividendos pagos
        const jogosSnap = await db.collection('jogos')
          .where('status', '==', 'finalizado')
          .get();

        // Verificar quais j√° tiveram dividendos
        const dividendosPagos = new Set();
        const divSnap = await db.collection('bolsa_dividendos').get();
        divSnap.forEach(doc => dividendosPagos.add(doc.data().jogoId));

        const jogosPendentes = [];
        jogosSnap.forEach(doc => {
          if (!dividendosPagos.has(doc.id)) {
            jogosPendentes.push({ id: doc.id, ...doc.data() });
          }
        });

        if (jogosPendentes.length === 0) {
          log('‚úÖ Nenhum dividendo pendente!', 'success');
          return;
        }

        log(`üìä ${jogosPendentes.length} jogos com dividendos pendentes`, 'info');

        // Processar cada jogo
        for (const jogo of jogosPendentes) {
          // Calcular valor arrecadado (simplificado: soma de cr√©ditos usados)
          // Em produ√ß√£o, isso viria de um campo espec√≠fico do jogo
          const valorArrecadado = (jogo.creditosUsados || 0) || 100; // Default para teste
          const valorDistribuido = valorArrecadado * (PERCENTUAL_DIVIDENDOS / 100);
          const valorPorTime = valorDistribuido / 2;

          // Distribuir para cada time
          for (const timeId of [jogo.timeCasaId, jogo.timeForaId]) {
            if (!timeId) continue;

            // Buscar donos de cotas deste time
            const cotasSnap = await db.collection('bolsa_cotas')
              .where('timeId', '==', timeId)
              .get();

            let totalCotas = 0;
            const donos = [];
            cotasSnap.forEach(doc => {
              const cota = doc.data();
              totalCotas += cota.quantidade;
              donos.push(cota);
            });

            if (totalCotas === 0) continue;

            const valorPorCota = valorPorTime / totalCotas;
            const pagamentos = [];

            // Pagar cada dono
            const batch = db.batch();
            for (const dono of donos) {
              const valorPagar = dono.quantidade * valorPorCota;
              
              batch.update(db.collection('usuarios').doc(dono.userId), {
                creditos: firebase.firestore.FieldValue.increment(valorPagar)
              });

              pagamentos.push({
                userId: dono.userId,
                cotas: dono.quantidade,
                valor: valorPagar
              });
            }

            // Registrar dividendo
            batch.set(db.collection('bolsa_dividendos').doc(), {
              timeId,
              timeNome: jogo.timeCasaId === timeId ? jogo.timeCasaNome : jogo.timeForaNome,
              jogoId: jogo.id,
              valorArrecadado,
              percentualDistribuido: PERCENTUAL_DIVIDENDOS,
              valorDistribuido: valorPorTime,
              cotasTotais: totalCotas,
              valorPorCota,
              dataPagamento: firebase.firestore.FieldValue.serverTimestamp(),
              pagamentos
            });

            await batch.commit();
            log(`‚úÖ Dividendos pagos: ${jogo.id} - ${timeId}`, 'success');
          }
        }

        log('üéâ Dividendos distribu√≠dos!', 'success');

      } catch (error) {
        console.error(error);
        log('‚ùå Erro: ' + error.message, 'error');
      }
    }

    // ==================== UTILS ====================
    function showProgress() {
      document.getElementById('progressCard').style.display = 'block';
    }

    function updateProgress(pct) {
      const bar = document.getElementById('progressBar');
      bar.style.width = pct + '%';
      bar.textContent = pct + '%';
    }

    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }
  </script>
</body>
</html>
