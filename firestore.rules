rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FUNÇÕES AUXILIARES ====================
    
    // Verifica se o usuário está autenticado
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Verifica se é o próprio usuário
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Verifica se é admin
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Verifica se o recurso existe
    function resourceExists() {
      return resource != null;
    }
    
    // Valida campos obrigatórios em usuarios
    function validUserData() {
      let data = request.resource.data;
      return data.keys().hasAll(['nome', 'email', 'usuario', 'usuarioUnico']) &&
             data.nome is string && data.nome.size() > 0 &&
             data.email is string && data.email.matches('.*@.*\\..*') &&
             data.usuario is string && data.usuario.size() >= 3 &&
             data.usuarioUnico is string && data.usuarioUnico.size() >= 3;
    }
    
    // Valida créditos (não pode ser negativo, máximo 100000)
    function validCredits() {
      return request.resource.data.creditos >= 0 && 
             request.resource.data.creditos <= 100000;
    }
    
    // Verifica se o jogo existe e está ativo
    function jogoAtivo(jogoId) {
      let jogo = get(/databases/$(database)/documents/jogos/$(jogoId)).data;
      return jogo.status in ['ativo', 'live', 'agendado'];
    }
    
    // Valida resposta de pergunta
    function validResposta() {
      let data = request.resource.data;
      return data.keys().hasAll(['userId', 'jogoId', 'perguntaId', 'alternativaSelecionada', 'timestamp']) &&
             data.userId == request.auth.uid &&
             data.alternativaSelecionada is string &&
             data.timestamp == request.time;
    }
    
    // ==================== COLEÇÃO: USUARIOS ====================
    
    match /usuarios/{userId} {
      // Leitura: próprio usuário ou admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Criação: apenas na autenticação inicial com dados válidos
      allow create: if isOwner(userId) && validUserData();
      
      // Atualização: próprio usuário, mas com restrições
      allow update: if isOwner(userId) && 
                      // Não pode alterar campos críticos
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'usuarioUnico'])) &&
                      // Valida créditos se estiver sendo alterado
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['creditos']) || validCredits());
      
      // Deleção: apenas admin
      allow delete: if isAdmin();
      
      // ========== SUBCOLEÇÕES DO USUÁRIO ==========
      
      // Notificações do usuário
      match /notificacoes/{notifId} {
        allow read: if isOwner(userId);
        allow write: if isAdmin();
      }
      
      // Histórico de jogadas
      match /historico/{itemId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Histórico é imutável
      }
    }
    
    // ==================== COLEÇÃO: JOGOS ====================
    
    match /jogos/{jogoId} {
      // Leitura: todos (jogos são públicos)
      allow read: if true;
      
      // Escrita: apenas admin
      allow write: if isAdmin();
      
      // ========== SUBCOLEÇÕES DO JOGO ==========
      
      // Perguntas do jogo
      match /perguntas/{perguntaId} {
        allow read: if isSignedIn() && jogoAtivo(jogoId);
        allow write: if isAdmin();
      }
      
      // Torcidas/votos do jogo
      match /torcidas/{torcidaId} {
        allow read: if isSignedIn();
        
        // Criar voto: usuário autenticado, apenas 1 voto por jogo
        allow create: if isSignedIn() && 
                        request.resource.data.userId == request.auth.uid &&
                        request.resource.data.jogoId == jogoId &&
                        request.resource.data.timeId is string;
        
        // Atualizar: apenas se for do próprio usuário
        allow update: if isSignedIn() && 
                        resource.data.userId == request.auth.uid;
        
        allow delete: if false; // Votos não podem ser deletados
      }
      
      // Chat do jogo
      match /chat/{messageId} {
        allow read: if isSignedIn();
        
        // Criar mensagem
        allow create: if isSignedIn() && 
                        request.resource.data.userId == request.auth.uid &&
                        request.resource.data.texto is string &&
                        request.resource.data.texto.size() > 0 &&
                        request.resource.data.texto.size() <= 500 && // Máximo 500 caracteres
                        request.resource.data.timestamp == request.time;
        
        // Não pode editar ou deletar mensagens
        allow update, delete: if isAdmin();
      }
    }
    
    // ==================== COLEÇÃO: PERGUNTAS (RAIZ) ====================
    
    match /perguntas/{perguntaId} {
      // Leitura: usuários autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: TIMES ====================
    
    match /times/{timeId} {
      // Leitura: todos (times são públicos)
      allow read: if true;
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: PONTUACOES ====================
    
    match /pontuacoes/{pontuacaoId} {
      // Leitura: todos autenticados (para rankings)
      allow read: if isSignedIn();
      
      // Criação: usuário autenticado para si mesmo
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.pontos >= 0 &&
                      request.resource.data.pontos <= 1000; // Máximo por pergunta
      
      // Atualização: apenas pelo próprio usuário, incrementando pontos
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.pontos >= resource.data.pontos; // Só pode aumentar
      
      // Deleção: apenas admin
      allow delete: if isAdmin();
    }
    
    // ==================== COLEÇÃO: RESPOSTAS ====================
    
    match /respostas/{respostaId} {
      // Leitura: próprio usuário ou admin
      allow read: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // Criação: usuário autenticado, dados válidos
      allow create: if isSignedIn() && validResposta();
      
      // Não pode atualizar ou deletar respostas (são imutáveis)
      allow update, delete: if false;
    }
    
    // ==================== COLEÇÃO: TORCIDAS (RAIZ) ====================
    
    match /torcidas/{torcidaId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Criação: usuário autenticado
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.jogoId is string &&
                      request.resource.data.timeId is string;
      
      // Atualização: apenas se for do próprio usuário
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid;
      
      // Deleção: não permitida
      allow delete: if false;
    }
    
    // ==================== COLEÇÃO: CHAT (RAIZ) ====================
    
    match /chat/{messageId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Criação: usuário autenticado com rate limit
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.texto is string &&
                      request.resource.data.texto.size() > 0 &&
                      request.resource.data.texto.size() <= 500 &&
                      request.resource.data.timestamp == request.time;
      
      // Admin pode deletar mensagens ofensivas
      allow update, delete: if isAdmin();
    }
    
    // ==================== COLEÇÃO: TRANSACOES ====================
    
    match /transacoes/{transacaoId} {
      // Leitura: próprio usuário ou admin
      allow read: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || isAdmin());
      
      // Escrita: apenas admin ou Cloud Functions
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: INDICACOES ====================
    
    match /indicacoes/{indicacaoId} {
      // Leitura: indicador ou indicado ou admin
      allow read: if isSignedIn() && 
                    (resource.data.indicadorId == request.auth.uid || 
                     resource.data.indicadoId == request.auth.uid ||
                     isAdmin());
      
      // Criação: usuário autenticado criando sua indicação
      allow create: if isSignedIn() && 
                      request.resource.data.indicadoId == request.auth.uid &&
                      request.resource.data.status == 'pendente';
      
      // Atualização: apenas admin (para confirmar indicação)
      allow update: if isAdmin();
      
      allow delete: if false;
    }
    
    // ==================== COLEÇÃO: PREMIACAO ====================
    
    match /premiacao/{premiacaoId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: BRINDES ====================
    
    match /brindes/{brindeId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: APOSTAS ====================
    
    match /apostas/{apostaId} {
      // Leitura: próprio usuário ou admin
      allow read: if isSignedIn() && 
                    (resource.data.usuarioId == request.auth.uid || isAdmin());
      
      // Criação: usuário autenticado com créditos suficientes
      allow create: if isSignedIn() && 
                      request.resource.data.usuarioId == request.auth.uid &&
                      request.resource.data.creditos > 0 &&
                      request.resource.data.creditos <= 100; // Máximo por aposta
      
      // Atualização: apenas admin (para processar resultado)
      allow update: if isAdmin();
      
      allow delete: if false;
    }
    
    // ==================== COLEÇÃO: DESAFIOS ====================
    
    match /desafios/{desafioId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: CONQUISTAS ====================
    
    match /conquistas/{conquistaId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin ou Cloud Functions
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: BADGES ====================
    
    match /badges/{badgeId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: AMIGOS ====================
    
    match /amigos/{amizadeId} {
      // Leitura: se for um dos envolvidos
      allow read: if isSignedIn() && 
                    (resource.data.userId == request.auth.uid || 
                     resource.data.amigoId == request.auth.uid);
      
      // Criação: usuário enviando solicitação
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'pendente';
      
      // Atualização: amigo aceitando/rejeitando
      allow update: if isSignedIn() && 
                      resource.data.amigoId == request.auth.uid &&
                      request.resource.data.status in ['aceito', 'rejeitado'];
      
      // Deleção: qualquer um dos dois pode desfazer amizade
      allow delete: if isSignedIn() && 
                      (resource.data.userId == request.auth.uid || 
                       resource.data.amigoId == request.auth.uid);
    }
    
    // ==================== COLEÇÃO: GRUPOS ====================
    
    match /grupos/{grupoId} {
      // Leitura: membros do grupo
      allow read: if isSignedIn() && 
                    request.auth.uid in resource.data.membros;
      
      // Criação: usuário autenticado
      allow create: if isSignedIn() && 
                      request.resource.data.criador == request.auth.uid &&
                      request.auth.uid in request.resource.data.membros;
      
      // Atualização: apenas criador
      allow update: if isSignedIn() && 
                      resource.data.criador == request.auth.uid;
      
      // Deleção: apenas criador
      allow delete: if isSignedIn() && 
                      resource.data.criador == request.auth.uid;
    }
    
    // ==================== COLEÇÃO: NOTIFICACOES (RAIZ) ====================
    
    match /notificacoes/{notifId} {
      // Leitura: destinatário
      allow read: if isSignedIn() && 
                    resource.data.para == request.auth.uid;
      
      // Criação: remetente ou admin
      allow create: if isSignedIn() && 
                      (request.resource.data.de == request.auth.uid || isAdmin());
      
      // Atualização: destinatário marcando como lida
      allow update: if isSignedIn() && 
                      resource.data.para == request.auth.uid;
      
      // Deleção: destinatário ou admin
      allow delete: if isSignedIn() && 
                      (resource.data.para == request.auth.uid || isAdmin());
    }
    
    // ==================== COLEÇÃO: RANKING ====================
    
    match /ranking/{rankingId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas Cloud Functions
      allow write: if false;
    }
    
    // ==================== COLEÇÃO: TEMPORADAS ====================
    
    match /temporadas/{temporadaId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: PATROCINADORES ====================
    
    match /patrocinadores/{patrocinadorId} {
      // Leitura: todos (público)
      allow read: if true;
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== COLEÇÃO: RADIOS ====================
    
    match /radios/{radioId} {
      // Leitura: todos autenticados
      allow read: if isSignedIn();
      
      // Escrita: apenas admin
      allow write: if isAdmin();
    }
    
    // ==================== REGRA PADRÃO ====================
    // Bloqueia acesso a qualquer coleção não especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
